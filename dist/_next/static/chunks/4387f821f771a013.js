(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,79626,25191,e=>{"use strict";var t,i,s,a,r,n,o,l,h,d,c,u,p,m,g,f,y,b,S,_,w,k,B,T,N,x,P,v,F,C,D,E,M,L,I,A,R,O,H,V,W,G,z,U,X,J,Y,q,$,j,K,Q,Z,ee,et,ei,es,ea,er,en,eo,el,eh,ed,ec,eu,ep,em,eg,ef,ey,eb,eS,e_,ew,ek,eB,eT,eN,ex,eP,ev,eF,eC,eD,eE,eM,eL,eI,eA,eR,eO,eH,eV,eW,eG,ez,eU,eX,eJ,eY,eq,e$,ej,eK,eQ,eZ,e0,e1,e2,e5,e3,e4,e6,e8,e7,e9,te,tt,ti,ts,ta,tr,tn,to,tl,th,td,tc,tu,tp,tm,tg,tf,ty,tb,tS,t_,tw,tk,tB,tT,tN,tx,tP,tv,tF,tC,tD,tE,tM,tL,tI,tA,tR,tO,tH,tV,tW,tG,tz,tU,tX,tJ,tY,tq,t$,tj,tK,tQ,tZ,t0,t1,t2,t5,t3,t4,t6,t8,t7,t9,ie,it,ii,is,ia,ir,io,il,ih,id,ic,iu,ip,im,ig,iy=e.i(47167);let ib={get url(){return`file://${e.P("node_modules/@coderline/alphatab/dist/alphaTab.core.mjs")}`}};void 0===Symbol.dispose&&(Symbol.dispose=Symbol("Symbol.dispose")),"undefined"!=typeof window&&("ResizeObserver"in globalThis||(globalThis.ResizeObserver=class e{constructor(e){this._targets=new Set,this._callback=e,window.addEventListener("resize",this.onWindowResize.bind(this),!1)}observe(e){this._targets.add(e)}unobserve(e){this._targets.delete(e)}disconnect(){this._targets.clear()}onWindowResize(){let e=[];for(let t of this._targets)e.push({target:t,contentRect:void 0,borderBoxSize:void 0,contentBoxSize:[],devicePixelContentBoxSize:[]});this._callback(e,this)}}),"IntersectionObserver"in globalThis||(globalThis.IntersectionObserver=class e{constructor(e){this._elements=[];let t=null;const i=this.check.bind(this);this.check=()=>{t||(t=setTimeout(()=>{i(),t=null},100))},this._callback=e,window.addEventListener("resize",this.check,!0),document.addEventListener("scroll",this.check,!0)}observe(e){this._elements.indexOf(e)>=0||(this._elements.push(e),this.check())}unobserve(e){this._elements=this._elements.filter(t=>t!==e)}check(){let e=[];for(let t of this._elements){let i=t.getBoundingClientRect();i.top+i.height>=0&&i.top<=window.innerHeight&&i.left+i.width>=0&&i.left<=window.innerWidth&&e.push({target:t,isIntersecting:!0})}e.length&&this._callback(e,this)}}),"replaceChildren"in Element.prototype||(Element.prototype.replaceChildren=function(...e){this.innerHTML="",this.append(...e)},Document.prototype.replaceChildren=Element.prototype.replaceChildren,DocumentFragment.prototype.replaceChildren=Element.prototype.replaceChildren)),"replaceAll"in String.prototype||(String.prototype.replaceAll=function(e,t){return this.replace(RegExp(e,"g"),t)}),(t=eX||(eX={}))[t.Page=0]="Page",t[t.Horizontal=1]="Horizontal",(i=eJ||(eJ={}))[i.Default=0]="Default",i[i.ScoreTab=1]="ScoreTab",i[i.Score=2]="Score",i[i.Tab=3]="Tab",i[i.TabMixed=4]="TabMixed";class iS{static getValue(e){return iS._values||(iS._values=new Map),e=e.toLowerCase().replaceAll(" ",""),iS._values.has(e)?iS._values.get(e):0}static isPiano(e){return e<=7||e>=16&&e<=23}static isGuitar(e){return e>=24&&e<=39||105===e||43===e}}iS._values=new Map([["acousticgrandpiano",0],["brightacousticpiano",1],["electricgrandpiano",2],["honkytonkpiano",3],["electricpiano1",4],["electricpiano2",5],["harpsichord",6],["clavinet",7],["celesta",8],["glockenspiel",9],["musicbox",10],["vibraphone",11],["marimba",12],["xylophone",13],["tubularbells",14],["dulcimer",15],["drawbarorgan",16],["percussiveorgan",17],["rockorgan",18],["churchorgan",19],["reedorgan",20],["accordion",21],["harmonica",22],["tangoaccordion",23],["acousticguitarnylon",24],["acousticguitarsteel",25],["electricguitarjazz",26],["electricguitarclean",27],["electricguitarmuted",28],["overdrivenguitar",29],["distortionguitar",30],["guitarharmonics",31],["acousticbass",32],["electricbassfinger",33],["electricbasspick",34],["fretlessbass",35],["slapbass1",36],["slapbass2",37],["synthbass1",38],["synthbass2",39],["violin",40],["viola",41],["cello",42],["contrabass",43],["tremolostrings",44],["pizzicatostrings",45],["orchestralharp",46],["timpani",47],["stringensemble1",48],["stringensemble2",49],["synthstrings1",50],["synthstrings2",51],["choiraahs",52],["voiceoohs",53],["synthvoice",54],["orchestrahit",55],["trumpet",56],["trombone",57],["tuba",58],["mutedtrumpet",59],["frenchhorn",60],["brasssection",61],["synthbrass1",62],["synthbrass2",63],["sopranosax",64],["altosax",65],["tenorsax",66],["baritonesax",67],["oboe",68],["englishhorn",69],["bassoon",70],["clarinet",71],["piccolo",72],["flute",73],["recorder",74],["panflute",75],["blownbottle",76],["shakuhachi",77],["whistle",78],["ocarina",79],["lead1square",80],["lead2sawtooth",81],["lead3calliope",82],["lead4chiff",83],["lead5charang",84],["lead6voice",85],["lead7fifths",86],["lead8bassandlead",87],["pad1newage",88],["pad2warm",89],["pad3polysynth",90],["pad4choir",91],["pad5bowed",92],["pad6metallic",93],["pad7halo",94],["pad8sweep",95],["fx1rain",96],["fx2soundtrack",97],["fx3crystal",98],["fx4atmosphere",99],["fx5brightness",100],["fx6goblins",101],["fx7echoes",102],["fx8scifi",103],["sitar",104],["banjo",105],["shamisen",106],["koto",107],["kalimba",108],["bagpipe",109],["fiddle",110],["shanai",111],["tinklebell",112],["agogo",113],["steeldrums",114],["woodblock",115],["taikodrum",116],["melodictom",117],["synthdrum",118],["reversecymbal",119],["guitarfretnoise",120],["breathnoise",121],["seashore",122],["birdtweet",123],["telephonering",124],["helicopter",125],["applause",126],["gunshot",127]]),(s=eY||(eY={}))[s.NoBrackets=0]="NoBrackets",s[s.GroupStaves=1]="GroupStaves",s[s.GroupSimilarInstruments=2]="GroupSimilarInstruments",(a=eq||(eq={}))[a.Hidden=0]="Hidden",a[a.FirstSystem=1]="FirstSystem",a[a.AllSystems=2]="AllSystems",(r=e$||(e$={}))[r.FullName=0]="FullName",r[r.ShortName=1]="ShortName",(n=ej||(ej={}))[n.Horizontal=0]="Horizontal",n[n.Vertical=1]="Vertical";class i_{constructor(){this.hideDynamics=!1,this.bracketExtendMode=eY.GroupStaves,this.useSystemSignSeparator=!1,this.globalDisplayTuning=!0,this.perTrackDisplayTuning=null,this.globalDisplayChordDiagramsOnTop=!0,this.perTrackChordDiagramsOnTop=null,this.singleTrackTrackNamePolicy=eq.FirstSystem,this.multiTrackTrackNamePolicy=eq.FirstSystem,this.firstSystemTrackNameMode=e$.ShortName,this.otherSystemsTrackNameMode=e$.ShortName,this.firstSystemTrackNameOrientation=ej.Vertical,this.otherSystemsTrackNameOrientation=ej.Vertical,this.multiTrackMultiBarRest=!1,this.perTrackMultiBarRest=null}}class iw{constructor(){this.masterBars=[],this.opening=null,this.closings=[],this.isClosed=!1}get openings(){let e=this.opening;return e?[e]:[]}get isOpened(){return this.opening?.isRepeatStart===!0}addMasterBar(e){null===this.opening&&(this.opening=e),this.masterBars.push(e),e.repeatGroup=this,e.isRepeatEnd&&(this.closings.push(e),this.isClosed=!0)}}class ik{constructor(){this.colors=new Map}}(o=eK||(eK={}))[o.Neutral=0]="Neutral",o[o.C3=1]="C3",o[o.C4=2]="C4",o[o.F4=3]="F4",o[o.G2=4]="G2",(l=eQ||(eQ={}))[l._15ma=0]="_15ma",l[l._8va=1]="_8va",l[l.Regular=2]="Regular",l[l._8vb=3]="_8vb",l[l._15mb=4]="_15mb",(h=eZ||(eZ={}))[h.None=0]="None",h[h.Simple=1]="Simple",h[h.FirstOfDouble=2]="FirstOfDouble",h[h.SecondOfDouble=3]="SecondOfDouble",(d=e0||(e0={}))[d.Cb=-7]="Cb",d[d.Gb=-6]="Gb",d[d.Db=-5]="Db",d[d.Ab=-4]="Ab",d[d.Eb=-3]="Eb",d[d.Bb=-2]="Bb",d[d.F=-1]="F",d[d.C=0]="C",d[d.G=1]="G",d[d.D=2]="D",d[d.A=3]="A",d[d.E=4]="E",d[d.B=5]="B",d[d.FSharp=6]="FSharp",d[d.CSharp=7]="CSharp",(c=e1||(e1={}))[c.Major=0]="Major",c[c.Minor=1]="Minor",(u=e2||(e2={}))[u.Down=0]="Down",u[u.Hold=1]="Hold",u[u.Up=2]="Up";class iB{constructor(){this.ratioPosition=0,this.pedalType=e2.Down,this.nextPedalMarker=null,this.previousPedalMarker=null}}(p=e5||(e5={}))[p.StandardNotationRepeats=0]="StandardNotationRepeats",p[p.GuitarTabsRepeats=1]="GuitarTabsRepeats",p[p.SlashRepeats=2]="SlashRepeats",p[p.NumberedRepeats=3]="NumberedRepeats",p[p.StandardNotationBarNumber=4]="StandardNotationBarNumber",p[p.GuitarTabsBarNumber=5]="GuitarTabsBarNumber",p[p.SlashBarNumber=6]="SlashBarNumber",p[p.NumberedBarNumber=7]="NumberedBarNumber",p[p.StandardNotationBarLines=8]="StandardNotationBarLines",p[p.GuitarTabsBarLines=9]="GuitarTabsBarLines",p[p.SlashBarLines=10]="SlashBarLines",p[p.NumberedBarLines=11]="NumberedBarLines",p[p.StandardNotationClef=12]="StandardNotationClef",p[p.GuitarTabsClef=13]="GuitarTabsClef",p[p.StandardNotationKeySignature=14]="StandardNotationKeySignature",p[p.NumberedKeySignature=15]="NumberedKeySignature",p[p.StandardNotationTimeSignature=16]="StandardNotationTimeSignature",p[p.GuitarTabsTimeSignature=17]="GuitarTabsTimeSignature",p[p.SlashTimeSignature=18]="SlashTimeSignature",p[p.NumberedTimeSignature=19]="NumberedTimeSignature",p[p.StandardNotationStaffLine=20]="StandardNotationStaffLine",p[p.GuitarTabsStaffLine=21]="GuitarTabsStaffLine",p[p.SlashStaffLine=22]="SlashStaffLine",p[p.NumberedStaffLine=23]="NumberedStaffLine";class iT extends ik{}(m=e3||(e3={}))[m.Automatic=0]="Automatic",m[m.Dashed=1]="Dashed",m[m.Dotted=2]="Dotted",m[m.Heavy=3]="Heavy",m[m.HeavyHeavy=4]="HeavyHeavy",m[m.HeavyLight=5]="HeavyLight",m[m.LightHeavy=6]="LightHeavy",m[m.LightLight=7]="LightLight",m[m.None=8]="None",m[m.Regular=9]="Regular",m[m.Short=10]="Short",m[m.Tick=11]="Tick";class iN{constructor(){this.id=iN._globalBarId++,this.index=0,this.nextBar=null,this.previousBar=null,this.clef=eK.G2,this.clefOttava=eQ.Regular,this.voices=[],this.simileMark=eZ.None,this.isMultiVoice=!1,this.displayScale=1,this.displayWidth=-1,this.sustainPedals=[],this._isEmpty=!0,this._isRestOnly=!0,this.barLineLeft=e3.Automatic,this.barLineRight=e3.Automatic,this.keySignature=e0.C,this.keySignatureType=e1.Major}static resetIds(){iN._globalBarId=0}get masterBar(){return this.staff.track.score.masterBars[this.index]}get isEmpty(){return this._isEmpty}get hasChanges(){return 0===this.index||this.keySignature!==this.previousBar.keySignature||this.keySignatureType!==this.previousBar.keySignatureType||this.clef!==this.previousBar.clef||this.clefOttava!==this.previousBar.clefOttava||this.simileMark!==eZ.None||this.sustainPedals.length>0||this.barLineLeft!==e3.Automatic||this.barLineRight!==e3.Automatic}get isRestOnly(){return this._isRestOnly}getActualBarLineLeft(e){return iN.actualBarLine(this,!1,e)}getActualBarLineRight(){return iN.actualBarLine(this,!0,!1)}static automaticToActualType(e,t,i){return t?e.isRepeatEnd?e3.LightHeavy:e.nextMasterBar?e.isFreeTime?e3.Dashed:e.isDoubleBar?e3.LightLight:e3.Regular:e3.LightHeavy:e.isRepeatStart?e3.HeavyLight:i?e3.Regular:e3.None}static actualBarLine(e,t,i){let s=e.masterBar,a=t?e.barLineRight:e.barLineLeft;return a===e3.Automatic?iN.automaticToActualType(s,t,i):a}addVoice(e){e.bar=this,e.index=this.voices.length,this.voices.push(e)}finish(e,t=null){this.isMultiVoice=!1,this._isEmpty=!0,this._isRestOnly=!0;for(let i=0,s=this.voices.length;i<s;i++){let s=this.voices[i];s.finish(e,t),i>0&&!s.isEmpty&&(this.isMultiVoice=!0),s.isEmpty||(this._isEmpty=!1),s.isRestOnly||(this._isRestOnly=!1)}let i=this.sustainPedals;if(i.length>0){let e=null;this.sustainPedals=[],this.previousBar&&this.previousBar.sustainPedals.length>0&&(e=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1]);let t=null!==e&&e.pedalType!==e2.Up;for(let s of i){if(e&&e.pedalType!==e2.Up){if(e.bar===this&&s.ratioPosition<=e.ratioPosition)continue;e.nextPedalMarker=s,s.previousPedalMarker=e}t&&s.pedalType===e2.Down&&(s.pedalType=e2.Hold),s.bar=this,this.sustainPedals.push(s),e=s}}else if(this.previousBar&&this.previousBar.sustainPedals.length>0){let e=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1];if(e.pedalType!==e2.Up){let t=new iB;t.ratioPosition=0,t.bar=this,t.pedalType=e2.Hold,this.sustainPedals.push(t),e.nextPedalMarker=t,t.previousPedalMarker=e}}}calculateDuration(){let e=0;for(let t of this.voices){let i=t.calculateDuration();i>e&&(e=i)}return e}}iN._globalBarId=0,(g=e4||(e4={}))[g.PPP=0]="PPP",g[g.PP=1]="PP",g[g.P=2]="P",g[g.MP=3]="MP",g[g.MF=4]="MF",g[g.F=5]="F",g[g.FF=6]="FF",g[g.FFF=7]="FFF",g[g.PPPP=8]="PPPP",g[g.PPPPP=9]="PPPPP",g[g.PPPPPP=10]="PPPPPP",g[g.FFFF=11]="FFFF",g[g.FFFFF=12]="FFFFF",g[g.FFFFFF=13]="FFFFFF",g[g.SF=14]="SF",g[g.SFP=15]="SFP",g[g.SFPP=16]="SFPP",g[g.FP=17]="FP",g[g.RF=18]="RF",g[g.RFZ=19]="RFZ",g[g.SFZ=20]="SFZ",g[g.SFFZ=21]="SFFZ",g[g.FZ=22]="FZ",g[g.N=23]="N",g[g.PF=24]="PF",g[g.SFZP=25]="SFZP";class ix{static ticksToMillis(e,t){return e*(6e4/(t*ix.QuarterTime))|0}static millisToTicks(e,t){return e/(6e4/(t*ix.QuarterTime))|0}static toTicks(e){return ix.valueToTicks(e)}static valueToTicks(e){let t=e;return t<0&&(t=-(1/t)),ix.QuarterTime*(4/t)|0}static applyDot(e,t){return t?e+(e/4|0)*3:e+(e/2|0)}static applyTuplet(e,t,i){return e*i/t|0}static removeTuplet(e,t,i){return e*t/i|0}static dynamicToVelocity(e,t=0){let i=1;switch(e){case e4.PPP:i=ix.MinVelocity+0*ix.VelocityIncrement;break;case e4.PP:i=ix.MinVelocity+ +ix.VelocityIncrement;break;case e4.P:i=ix.MinVelocity+2*ix.VelocityIncrement;break;case e4.MP:i=ix.MinVelocity+3*ix.VelocityIncrement;break;case e4.MF:i=ix.MinVelocity+4*ix.VelocityIncrement;break;case e4.F:i=ix.MinVelocity+5*ix.VelocityIncrement;break;case e4.FF:i=ix.MinVelocity+6*ix.VelocityIncrement;break;case e4.FFF:i=ix.MinVelocity+7*ix.VelocityIncrement;break;case e4.PPPP:i=10;break;case e4.PPPPP:i=5;break;case e4.PPPPPP:i=3;break;case e4.FFFF:i=ix.MinVelocity+8*ix.VelocityIncrement;break;case e4.FFFFF:i=ix.MinVelocity+9*ix.VelocityIncrement;break;case e4.FFFFFF:i=ix.MinVelocity+10*ix.VelocityIncrement;break;case e4.SF:case e4.SFP:case e4.SFZP:case e4.SFPP:case e4.SFZ:case e4.FZ:i=ix.MinVelocity+6*ix.VelocityIncrement;break;case e4.FP:case e4.RF:case e4.RFZ:case e4.SFFZ:i=ix.MinVelocity+5*ix.VelocityIncrement;break;case e4.N:i=1;break;case e4.PF:i=ix.MinVelocity+(4.5*ix.VelocityIncrement|0)}return Math.min(Math.max(i+=t*ix.VelocityIncrement,1),127)}}ix.QuarterTime=960,ix.MinVelocity=15,ix.VelocityIncrement=16,(f=e6||(e6={}))[f.Tempo=0]="Tempo",f[f.Volume=1]="Volume",f[f.Instrument=2]="Instrument",f[f.Balance=3]="Balance",f[f.SyncPoint=4]="SyncPoint";class iP{constructor(){this.barOccurence=0,this.millisecondOffset=0}}class iv{constructor(){this.isLinear=!1,this.type=e6.Tempo,this.value=0,this.ratioPosition=0,this.text=""}static buildTempoAutomation(e,t,i,s){(s<1||s>5)&&(s=2);let a=new Float32Array([1,.5,1,1.5,2,3]),r=new iv;return r.type=e6.Tempo,r.isLinear=e,r.ratioPosition=t,r.value=i*a[s],r}static buildInstrumentAutomation(e,t,i){let s=new iv;return s.type=e6.Instrument,s.isLinear=e,s.ratioPosition=t,s.value=i,s}}class iF{constructor(e=0,t=0){this.offset=e,this.value=t}}iF.MaxPosition=60,iF.MaxValue=12,(y=e8||(e8={}))[y.Default=0]="Default",y[y.Gradual=1]="Gradual",y[y.Fast=2]="Fast",(b=e7||(e7={}))[b.None=0]="None",b[b.Custom=1]="Custom",b[b.Bend=2]="Bend",b[b.Release=3]="Release",b[b.BendRelease=4]="BendRelease",b[b.Hold=5]="Hold",b[b.Prebend=6]="Prebend",b[b.PrebendBend=7]="PrebendBend",b[b.PrebendRelease=8]="PrebendRelease",(S=e9||(e9={}))[S.None=0]="None",S[S.BrushUp=1]="BrushUp",S[S.BrushDown=2]="BrushDown",S[S.ArpeggioUp=3]="ArpeggioUp",S[S.ArpeggioDown=4]="ArpeggioDown",(_=te||(te={}))[_.None=0]="None",_[_.Crescendo=1]="Crescendo",_[_.Decrescendo=2]="Decrescendo",(w=tt||(tt={}))[w.QuadrupleWhole=-4]="QuadrupleWhole",w[w.DoubleWhole=-2]="DoubleWhole",w[w.Whole=1]="Whole",w[w.Half=2]="Half",w[w.Quarter=4]="Quarter",w[w.Eighth=8]="Eighth",w[w.Sixteenth=16]="Sixteenth",w[w.ThirtySecond=32]="ThirtySecond",w[w.SixtyFourth=64]="SixtyFourth",w[w.OneHundredTwentyEighth=128]="OneHundredTwentyEighth",w[w.TwoHundredFiftySixth=256]="TwoHundredFiftySixth",(k=ti||(ti={}))[k.None=0]="None",k[k.OnBeat=1]="OnBeat",k[k.BeforeBeat=2]="BeforeBeat",k[k.BendGrace=3]="BendGrace",(B=ts||(ts={}))[B.None=0]="None",B[B.Normal=1]="Normal",B[B.Heavy=2]="Heavy",B[B.Tenuto=3]="Tenuto",(T=ta||(ta={}))[T.Unknown=-2]="Unknown",T[T.NoOrDead=-1]="NoOrDead",T[T.Thumb=0]="Thumb",T[T.IndexFinger=1]="IndexFinger",T[T.MiddleFinger=2]="MiddleFinger",T[T.AnnularFinger=3]="AnnularFinger",T[T.LittleFinger=4]="LittleFinger",(N=tr||(tr={}))[N.None=0]="None",N[N.Natural=1]="Natural",N[N.Artificial=2]="Artificial",N[N.Pinch=3]="Pinch",N[N.Tap=4]="Tap",N[N.Semi=5]="Semi",N[N.Feedback=6]="Feedback",(x=tn||(tn={}))[x.Default=0]="Default",x[x.ForceNone=1]="ForceNone",x[x.ForceNatural=2]="ForceNatural",x[x.ForceSharp=3]="ForceSharp",x[x.ForceDoubleSharp=4]="ForceDoubleSharp",x[x.ForceFlat=5]="ForceFlat",x[x.ForceDoubleFlat=6]="ForceDoubleFlat",(P=to||(to={}))[P.None=0]="None",P[P.IntoFromBelow=1]="IntoFromBelow",P[P.IntoFromAbove=2]="IntoFromAbove",(v=tl||(tl={}))[v.None=0]="None",v[v.Shift=1]="Shift",v[v.Legato=2]="Legato",v[v.OutUp=3]="OutUp",v[v.OutDown=4]="OutDown",v[v.PickSlideDown=5]="PickSlideDown",v[v.PickSlideUp=6]="PickSlideUp",(F=th||(th={}))[F.None=0]="None",F[F.Slight=1]="Slight",F[F.Wide=2]="Wide",(C=td||(td={}))[C.Hidden=0]="Hidden",C[C.ShowWithBeams=1]="ShowWithBeams",C[C.ShowWithBars=2]="ShowWithBars",C[C.Automatic=3]="Automatic",(D=tc||(tc={}))[D.ScoreDefault=0]="ScoreDefault",D[D.ScoreForcePiano=1]="ScoreForcePiano",D[D.SingleNoteEffectBand=2]="SingleNoteEffectBand",D[D.SingleNoteEffectBandForcePiano=3]="SingleNoteEffectBandForcePiano",(E=tu||(tu={}))[E.GuitarPro=0]="GuitarPro",E[E.SongBook=1]="SongBook",(M=tp||(tp={}))[M.ScoreTitle=0]="ScoreTitle",M[M.ScoreSubTitle=1]="ScoreSubTitle",M[M.ScoreArtist=2]="ScoreArtist",M[M.ScoreAlbum=3]="ScoreAlbum",M[M.ScoreWords=4]="ScoreWords",M[M.ScoreMusic=5]="ScoreMusic",M[M.ScoreWordsAndMusic=6]="ScoreWordsAndMusic",M[M.ScoreCopyright=7]="ScoreCopyright",M[M.GuitarTuning=8]="GuitarTuning",M[M.TrackNames=9]="TrackNames",M[M.ChordDiagrams=10]="ChordDiagrams",M[M.ParenthesisOnTiedBends=11]="ParenthesisOnTiedBends",M[M.TabNotesOnTiedBends=12]="TabNotesOnTiedBends",M[M.ZerosOnDiveWhammys=13]="ZerosOnDiveWhammys",M[M.EffectAlternateEndings=14]="EffectAlternateEndings",M[M.EffectCapo=15]="EffectCapo",M[M.EffectChordNames=16]="EffectChordNames",M[M.EffectCrescendo=17]="EffectCrescendo",M[M.EffectDynamics=18]="EffectDynamics",M[M.EffectFadeIn=19]="EffectFadeIn",M[M.EffectFermata=20]="EffectFermata",M[M.EffectFingering=21]="EffectFingering",M[M.EffectHarmonics=22]="EffectHarmonics",M[M.EffectLetRing=23]="EffectLetRing",M[M.EffectLyrics=24]="EffectLyrics",M[M.EffectMarker=25]="EffectMarker",M[M.EffectOttavia=26]="EffectOttavia",M[M.EffectPalmMute=27]="EffectPalmMute",M[M.EffectPickSlide=28]="EffectPickSlide",M[M.EffectPickStroke=29]="EffectPickStroke",M[M.EffectSlightBeatVibrato=30]="EffectSlightBeatVibrato",M[M.EffectSlightNoteVibrato=31]="EffectSlightNoteVibrato",M[M.EffectTap=32]="EffectTap",M[M.EffectTempo=33]="EffectTempo",M[M.EffectText=34]="EffectText",M[M.EffectTrill=35]="EffectTrill",M[M.EffectTripletFeel=36]="EffectTripletFeel",M[M.EffectWhammyBar=37]="EffectWhammyBar",M[M.EffectWideBeatVibrato=38]="EffectWideBeatVibrato",M[M.EffectWideNoteVibrato=39]="EffectWideNoteVibrato",M[M.EffectLeftHandTap=40]="EffectLeftHandTap",M[M.EffectFreeTime=41]="EffectFreeTime",M[M.EffectSustainPedal=42]="EffectSustainPedal",M[M.EffectGolpe=43]="EffectGolpe",M[M.EffectWahPedal=44]="EffectWahPedal",M[M.EffectBeatBarre=45]="EffectBeatBarre",M[M.EffectNoteOrnament=46]="EffectNoteOrnament",M[M.EffectRasgueado=47]="EffectRasgueado",M[M.EffectDirections=48]="EffectDirections",M[M.EffectBeatTimer=49]="EffectBeatTimer";class iC{constructor(){this.notationMode=tu.GuitarPro,this.fingeringMode=tc.ScoreDefault,this.elements=new Map,this.rhythmMode=td.Automatic,this.rhythmHeight=15,this.transpositionPitches=[],this.displayTranspositionPitches=[],this.smallGraceTabNotes=!0,this.extendBendArrowsOnTiedNotes=!0,this.extendLineEffectsToBeatEnd=!1,this.slurHeight=5}isNotationElementVisible(e){return this.elements.has(e)?this.elements.get(e):!iC.defaultElements.has(e)||iC.defaultElements.get(e)}}iC.defaultElements=new Map([[tp.ZerosOnDiveWhammys,!1]]);class iD{constructor(e){this._value=void 0,this._factory=e}get value(){return void 0===this._value&&(this._value=this._factory()),this._value}}(L=tm||(tm={}))[L.None=0]="None",L[L.Debug=1]="Debug",L[L.Info=2]="Info",L[L.Warning=3]="Warning",L[L.Error=4]="Error";class iE{static format(e,t){return`[AlphaTab][${e}] ${t}`}debug(e,t,...i){console.debug(iE.format(e,t),...i)}warning(e,t,...i){console.warn(iE.format(e,t),...i)}info(e,t,...i){console.info(iE.format(e,t),...i)}error(e,t,...i){console.error(iE.format(e,t),...i)}}iE.logLevel=tm.Info;class iM{static shouldLog(e){return iM.logLevel!==tm.None&&e>=iM.logLevel}static debug(e,t,...i){iM.shouldLog(tm.Debug)&&iM.log.debug(e,t,...i)}static warning(e,t,...i){iM.shouldLog(tm.Warning)&&iM.log.warning(e,t,...i)}static info(e,t,...i){iM.shouldLog(tm.Info)&&iM.log.info(e,t,...i)}static error(e,t,...i){iM.shouldLog(tm.Error)&&iM.log.error(e,t,...i)}}iM.logLevel=tm.Info,iM.log=new iE,(I=tg||(tg={}))[I.NoTripletFeel=0]="NoTripletFeel",I[I.Triplet16th=1]="Triplet16th",I[I.Triplet8th=2]="Triplet8th",I[I.Dotted16th=3]="Dotted16th",I[I.Dotted8th=4]="Dotted8th",I[I.Scottish16th=5]="Scottish16th",I[I.Scottish8th=6]="Scottish8th";class iL{constructor(){this.alternateEndings=0,this.nextMasterBar=null,this.previousMasterBar=null,this.index=0,this.isDoubleBar=!1,this.isRepeatStart=!1,this.repeatCount=0,this.timeSignatureNumerator=4,this.timeSignatureDenominator=4,this.timeSignatureCommon=!1,this.isFreeTime=!1,this.tripletFeel=tg.NoTripletFeel,this.section=null,this.tempoAutomations=[],this.fermata=null,this.start=0,this.isAnacrusis=!1,this.displayScale=1,this.displayWidth=-1,this.directions=null}get hasChanges(){return 0!==this.index&&(this.timeSignatureCommon!==this.previousMasterBar.timeSignatureCommon||this.timeSignatureNumerator!==this.previousMasterBar.timeSignatureNumerator||this.timeSignatureDenominator!==this.previousMasterBar.timeSignatureDenominator||this.tripletFeel!==this.previousMasterBar.tripletFeel||0!==this.alternateEndings||this.isRepeatStart||this.isRepeatEnd||this.isFreeTime||this.isSectionStart||this.tempoAutomations.length>0||this.syncPoints&&this.syncPoints.length>0||null!==this.fermata&&this.fermata.size>0||null!==this.directions&&this.directions.size>0||this.isAnacrusis)}get keySignature(){return this.score.tracks[0].staves[0].bars[this.index].keySignature}set keySignature(e){this.score.tracks[0].staves[0].bars[this.index].keySignature=e}get keySignatureType(){return this.score.tracks[0].staves[0].bars[this.index].keySignatureType}set keySignatureType(e){this.score.tracks[0].staves[0].bars[this.index].keySignatureType=e}get isRepeatEnd(){return this.repeatCount>0}get isSectionStart(){return!!this.section}get tempoAutomation(){return this.tempoAutomations.length>0?this.tempoAutomations[0]:null}calculateDuration(e=!0){if(this.isAnacrusis&&e){let e=0;for(let t of this.score.tracks)for(let i of t.staves){let t=this.index<i.bars.length?i.bars[this.index].calculateDuration():0;t>e&&(e=t)}return e}return this.timeSignatureNumerator*ix.valueToTicks(this.timeSignatureDenominator)}addFermata(e,t){let i=this.fermata;null===i&&(i=new Map,this.fermata=i),i.set(e,t)}addDirection(e){null==this.directions&&(this.directions=new Set),this.directions.add(e)}getFermata(e){let t=this.fermata;return null===t?null:t.has(e.playbackStart)?t.get(e.playbackStart):null}addSyncPoint(e){this.syncPoints||(this.syncPoints=[]),this.syncPoints.push(e)}}iL.MaxAlternateEndings=8;class iI{}iI.DefaultChannelCount=17,iI.MetronomeChannel=iI.DefaultChannelCount-1,iI.MetronomeKey=33,iI.AudioChannels=2,iI.MinVolume=0,iI.MinProgram=0,iI.MaxProgram=127,iI.MinPlaybackSpeed=.125,iI.MaxPlaybackSpeed=8,iI.PercussionChannel=9,iI.PercussionBank=128,iI.MaxPitchWheel=16384,iI.MaxPitchWheel20=0x100000000,iI.DefaultPitchWheel=iI.MaxPitchWheel/2,iI.MicroBufferCount=32,iI.MicroBufferSize=64;class iA{constructor(){this.beats=[],this.id="empty",this.isComplete=!1}addBeat(e){e.graceIndex=this.beats.length,e.graceGroup=this,this.beats.push(e)}finish(){this.beats.length>0&&(this.id=`${this.beats[0].absoluteDisplayStart}_${this.beats[0].voice.index}`)}}(A=tf||(tf={}))[A.Glyphs=0]="Glyphs";class iR extends ik{}let iO=class e{constructor(){this._isEmpty=!0,this._isRestOnly=!0,this.id=e._globalVoiceId++,this.index=0,this.beats=[]}static resetIds(){e._globalVoiceId=0}get isEmpty(){return this._isEmpty}forceNonEmpty(){this._isEmpty=!1}get isRestOnly(){return this._isRestOnly}insertBeat(e,t){t.nextBeat=e.nextBeat,t.nextBeat&&(t.nextBeat.previousBeat=t),t.previousBeat=e,t.voice=this,e.nextBeat=t,this.beats.splice(e.index+1,0,t)}addBeat(e){e.voice=this,e.index=this.beats.length,this.beats.push(e),e.isEmpty||(this._isEmpty=!1),e.isRest||(this._isRestOnly=!1)}chain(e,t=null){if(this.bar){if(e.index<this.beats.length-1)e.nextBeat=this.beats[e.index+1],e.nextBeat.previousBeat=e;else if(e.isLastOfVoice&&e.voice.bar.nextBar){let t=this.bar.nextBar.voices[this.index];t.beats.length>0&&(e.nextBeat=t.beats[0]),e.nextBeat.previousBeat=e}e.chain(t)}}addGraceBeat(e){if(0===this.beats.length)return void this.addBeat(e);let t=this.beats[this.beats.length-1];this.beats.splice(this.beats.length-1,1),this.addBeat(e),this.addBeat(t),this._isEmpty=!1,this._isRestOnly=!1}getBeatAtPlaybackStart(e){return this._beatLookup.has(e)?this._beatLookup.get(e):null}finish(e,t=null){this._isEmpty=!0,this._isRestOnly=!0,this._beatLookup=new Map;let i=null;for(let e=0;e<this.beats.length;e++){let s=this.beats[e];s.index=e,this.chain(s,t),s.graceType===ti.None?(s.graceGroup=i,i&&(i.isComplete=!0),i=null):(i||(i=new iA),i.addBeat(s)),s.isEmpty||(this._isEmpty=!1),s.isRest||(this._isRestOnly=!1)}let s=0,a=0;for(let i=0;i<this.beats.length;i++){let r=this.beats[i];if(r.index=i,r.finish(e,t),r.graceType===ti.None){if(r.graceGroup){let e=r.graceGroup.beats[0],t=r.graceGroup.beats[r.graceGroup.beats.length-1];if(e.graceType!==ti.BendGrace){let i=t.playbackStart+t.playbackDuration-e.playbackStart;switch(e.graceType){case ti.BeforeBeat:for(let t of(e.previousBeat?(e.previousBeat.playbackDuration-=i,a=e.previousBeat.voice===this?e.previousBeat.playbackStart+e.previousBeat.playbackDuration:-i):a=-i,r.graceGroup.beats))this._beatLookup.delete(t.playbackStart),t.playbackStart=a,this._beatLookup.set(t.playbackStart,r),a+=t.playbackDuration;break;case ti.OnBeat:r.playbackDuration-=i,a=t.voice===this?t.playbackStart+t.playbackDuration:-i}}}r.displayStart=s,r.playbackStart=a,r.fermata?this.bar.masterBar.addFermata(r.playbackStart,r.fermata):r.fermata=this.bar.masterBar.getFermata(r),this._beatLookup.set(r.playbackStart,r)}else r.displayStart=s,r.playbackStart=a;r.finishTuplet(),r.graceGroup&&r.graceGroup.finish(),s+=r.displayDuration,a+=r.playbackDuration}}calculateDuration(){if(this.isEmpty||0===this.beats.length)return 0;let e=this.beats[this.beats.length-1],t=this.beats[0];return e.playbackStart+e.playbackDuration-t.playbackStart}};iO._globalVoiceId=0;class iH{constructor(){this.note=null,this.tone=new iV,this.octave=0}get realValue(){return 12*this.octave+this.tone.noteValue}}class iV{constructor(e=0,t=tn.Default){this.noteValue=e,this.accidentalMode=t}}class iW{static getIndex(e){return e<0?0:0|Math.log2(e)}static keySignatureIsFlat(e){return e<0}static keySignatureIsNatural(e){return 0===e}static keySignatureIsSharp(e){return e>0}static applyPitchOffsets(e,t){for(let i=0;i<t.tracks.length;i++){if(i<e.notation.displayTranspositionPitches.length)for(let s of t.tracks[i].staves)s.displayTranspositionPitch=-e.notation.displayTranspositionPitches[i];if(i<e.notation.transpositionPitches.length)for(let s of t.tracks[i].staves)s.transpositionPitch=-e.notation.transpositionPitches[i]}}static fingerToString(e,t,i,s){if(e.notation.fingeringMode===tc.ScoreForcePiano||e.notation.fingeringMode===tc.SingleNoteEffectBandForcePiano||iS.isPiano(t.voice.bar.staff.track.playbackInfo.program))switch(i){case ta.Unknown:case ta.NoOrDead:return null;case ta.Thumb:return"1";case ta.IndexFinger:return"2";case ta.MiddleFinger:return"3";case ta.AnnularFinger:return"4";case ta.LittleFinger:return"5";default:return null}if(s)switch(i){case ta.Unknown:return null;case ta.NoOrDead:return"0";case ta.Thumb:return"t";case ta.IndexFinger:return"1";case ta.MiddleFinger:return"2";case ta.AnnularFinger:return"3";case ta.LittleFinger:return"4";default:return null}switch(i){case ta.Unknown:case ta.NoOrDead:return null;case ta.Thumb:return"p";case ta.IndexFinger:return"i";case ta.MiddleFinger:return"m";case ta.AnnularFinger:return"a";case ta.LittleFinger:return"c";default:return null}}static isTuning(e){return!!iW.parseTuning(e)}static parseTuning(e){let t="",i="";for(let s=0;s<e.length;s++){let a=e.charCodeAt(s);if(a>=48&&a<=57){if(!t)return null;i+=String.fromCharCode(a)}else{if(!iW.TuningLetters.has(a))return null;t+=String.fromCharCode(a)}}if(!i||!t)return null;let s=new iH;return s.octave=Number.parseInt(i)+1,s.note=t.toLowerCase(),s.tone=iW.getToneForText(s.note),s.tone.noteValue<0&&(s.octave--,s.tone.noteValue+=12),s}static getTuningForText(e){let t=iW.parseTuning(e);return t?t.realValue:-1}static getToneForText(e){let t,i,s=e.substring(0,1),a=e.substring(1);switch(s.toLowerCase()){case"c":default:t=0;break;case"d":t=2;break;case"e":t=4;break;case"f":t=5;break;case"g":t=7;break;case"a":t=9;break;case"b":t=11}switch(i=iW.parseAccidentalMode(a)){case tn.Default:case tn.ForceNone:case tn.ForceNatural:break;case tn.ForceSharp:t++;break;case tn.ForceDoubleSharp:t+=2;break;case tn.ForceFlat:t--;break;case tn.ForceDoubleFlat:t-=2}return new iV(t,i)}static parseAccidentalMode(e){let t=e.toLowerCase();return iW.accidentalModeMapping.has(t)?iW.accidentalModeMapping.get(t):tn.Default}static newGuid(){return`${Math.floor((1+Math.random())*65536).toString(16).substring(1)+Math.floor((1+Math.random())*65536).toString(16).substring(1)}-${Math.floor((1+Math.random())*65536).toString(16).substring(1)}-${Math.floor((1+Math.random())*65536).toString(16).substring(1)}-${Math.floor((1+Math.random())*65536).toString(16).substring(1)}-${Math.floor((1+Math.random())*65536).toString(16).substring(1)}${Math.floor((1+Math.random())*65536).toString(16).substring(1)}${Math.floor((1+Math.random())*65536).toString(16).substring(1)}`}static isAlmostEqualTo(e,t){return 1e-5>Math.abs(e-t)}static toHexString(e,t=0){let i="";do i=String.fromCharCode("0123456789ABCDEF".charCodeAt(15&e))+i,e>>=4;while(e>0)for(;i.length<t;)i=`0${i}`;return i}static getAlternateEndingsList(e){let t=[];for(let i=0;i<iL.MaxAlternateEndings;i++)(e&1<<i)!=0&&t.push(i);return t}static deltaFretToHarmonicValue(e){switch(e){case 2:return 2.4;case 3:return 3.2;case 4:case 5:case 7:case 9:case 12:case 16:case 17:case 19:case 24:return e;case 8:return 8.2;case 10:return 9.6;case 14:case 15:return 14.7;case 21:case 22:return 21.7;default:return 12}}static clamp(e,t,i){return e<=t?t:e>=i?i:e}static buildMultiBarRestInfo(e,t,i){if(!e)return null;let s=e[0].score.stylesheet;if(!(e.length>1?s.multiTrackMultiBarRest:s.perTrackMultiBarRest?.has(e[0].index)===!0))return null;let a=new Map,r=e[0].score,n=t,o=r.tempo;for(;n<=i;){let s=n,l=null;for(;n<=i;){let i=r.masterBars[n],a=!1;for(let e of i.tempoAutomations)e.value!==o&&(a=!0),o=e.value;if(i.alternateEndings||i.isRepeatStart&&i.index!==s||i.isFreeTime||i.isAnacrusis||null!==i.section||i.index!==s&&a||null!==i.fermata&&i.fermata.size>0||null!==i.directions&&i.directions.size>0||s>t&&i.previousMasterBar&&(i.timeSignatureCommon!==i.previousMasterBar.timeSignatureCommon||i.timeSignatureNumerator!==i.previousMasterBar.timeSignatureNumerator||i.timeSignatureDenominator!==i.previousMasterBar.timeSignatureDenominator||i.tripletFeel!==i.previousMasterBar.tripletFeel))break;let h=!0;for(let t of e){for(let e of t.staves){let t=e.bars[i.index];if(!t.isRestOnly||t.index>0&&(t.keySignature!==t.previousBar.keySignature||t.keySignatureType!==t.previousBar.keySignatureType)){h=!1;break}}if(!h)break}if(!h||(n++,i.index>s&&(null===l?l=[i.index]:l.push(i.index)),i.isRepeatEnd))break}l?a.set(s,l):n++}return a}static computeFirstDisplayedBarIndex(e,t){let i=t.display.startBar;return i--,i=Math.min(e.masterBars.length-1,Math.max(0,i))}static computeLastDisplayedBarIndex(e,t,i){let s=t.display.barCount;return s<0&&(s=e.masterBars.length),s=i+s-1,s=Math.min(e.masterBars.length-1,Math.max(0,s))}static getOrCreateHeaderFooterStyle(e,t){let i,s=e.style;if(e.style||(e.style=s=new i5),s.headerAndFooter.has(t))i=s.headerAndFooter.get(t);else{if(i=new i2,i5.defaultHeaderAndFooter.has(t)){let e=i5.defaultHeaderAndFooter.get(t);i.template=e.template,i.textAlign=e.textAlign}s.headerAndFooter.set(t,i)}return i}static consolidate(e){if(0===e.masterBars.length){let t=new iL;e.addMasterBar(t);let i=new iv;i.isLinear=!1,i.type=e6.Tempo,i.value=e.tempo,t.tempoAutomations.push(i);let s=new iN;e.tracks[0].staves[0].addBar(s);let a=new iO;s.addVoice(a);let r=new i1;r.isEmpty=!0,a.addBeat(r);return}let t=new Set([iI.PercussionChannel]);for(let i of e.tracks){if(1===i.staves.length&&i.staves[0].isPercussion)i.playbackInfo.primaryChannel=iI.PercussionChannel,i.playbackInfo.secondaryChannel=iI.PercussionChannel;else{if(i.playbackInfo.primaryChannel!==iI.PercussionChannel)for(;t.has(i.playbackInfo.primaryChannel);)i.playbackInfo.primaryChannel++;if(t.add(i.playbackInfo.primaryChannel),i.playbackInfo.secondaryChannel!==iI.PercussionChannel)for(;t.has(i.playbackInfo.secondaryChannel);)i.playbackInfo.secondaryChannel++;t.add(i.playbackInfo.secondaryChannel)}for(let t of i.staves){for(let e of t.bars)for(let t of e.voices)if(t.isEmpty&&0===t.beats.length){let e=new i1;e.isEmpty=!0,t.addBeat(e)}let i=0===t.bars.length?1:t.bars[0].voices.length;for(;t.bars.length<e.masterBars.length;){let e=new iN;t.addBar(e);let s=e.previousBar;s&&(e.clef=s.clef,e.clefOttava=s.clefOttava,e.keySignature=e.previousBar.keySignature,e.keySignatureType=e.previousBar.keySignatureType);for(let t=0;t<i;t++){let t=new iO;e.addVoice(t);let i=new i1;i.isEmpty=!0,t.addBeat(i)}}}}}static trimEmptyBarsAtEnd(e){for(;e.masterBars.length>1;){let t=e.masterBars.length-1,i=e.masterBars[t];if(i.hasChanges)return;for(let i of e.tracks)for(let e of i.staves)if(t<e.bars.length){let i=e.bars[t];if(!i.isEmpty||i.hasChanges)return}for(let i of e.tracks)for(let e of i.staves)if(t<e.bars.length){let i=e.bars[t];e.bars.pop(),i.previousBar.nextBar=null}e.masterBars.pop(),i.previousMasterBar.nextMasterBar=null}}}iW.TuningLetters=new Set([67,68,69,70,71,65,66,99,100,101,102,103,97,98,35]),iW.accidentalModeMapping=new Map([["default",tn.Default],["d",tn.Default],["forcenone",tn.ForceNone],["-",tn.ForceNone],["forcenatural",tn.ForceNatural],["n",tn.ForceNatural],["forcesharp",tn.ForceSharp],["#",tn.ForceSharp],["forcedoublesharp",tn.ForceDoubleSharp],["##",tn.ForceDoubleSharp],["x",tn.ForceDoubleSharp],["forceflat",tn.ForceFlat],["b",tn.ForceFlat],["forcedoubleflat",tn.ForceDoubleFlat],["bb",tn.ForceDoubleFlat]]),(R=ty||(ty={}))[R.None=0]="None",R[R.Up=1]="Up",R[R.Down=2]="Down",(O=tb||(tb={}))[O.None=-1]="None",O[O.Space=32]="Space",O[O.Brace=57344]="Brace",O[O.BracketTop=57347]="BracketTop",O[O.BracketBottom=57348]="BracketBottom",O[O.SystemDivider=57351]="SystemDivider",O[O.GClef=57424]="GClef",O[O.CClef=57436]="CClef",O[O.FClef=57442]="FClef",O[O.UnpitchedPercussionClef1=57449]="UnpitchedPercussionClef1",O[O.SixStringTabClef=57453]="SixStringTabClef",O[O.FourStringTabClef=57454]="FourStringTabClef",O[O.TimeSig0=57472]="TimeSig0",O[O.TimeSig1=57473]="TimeSig1",O[O.TimeSig2=57474]="TimeSig2",O[O.TimeSig3=57475]="TimeSig3",O[O.TimeSig4=57476]="TimeSig4",O[O.TimeSig5=57477]="TimeSig5",O[O.TimeSig6=57478]="TimeSig6",O[O.TimeSig7=57479]="TimeSig7",O[O.TimeSig8=57480]="TimeSig8",O[O.TimeSig9=57481]="TimeSig9",O[O.TimeSigCommon=57482]="TimeSigCommon",O[O.TimeSigCutCommon=57483]="TimeSigCutCommon",O[O.NoteheadDoubleWholeSquare=57505]="NoteheadDoubleWholeSquare",O[O.NoteheadDoubleWhole=57504]="NoteheadDoubleWhole",O[O.NoteheadWhole=57506]="NoteheadWhole",O[O.NoteheadHalf=57507]="NoteheadHalf",O[O.NoteheadBlack=57508]="NoteheadBlack",O[O.NoteheadNull=57509]="NoteheadNull",O[O.NoteheadXOrnate=57514]="NoteheadXOrnate",O[O.NoteheadPlusDoubleWhole=57516]="NoteheadPlusDoubleWhole",O[O.NoteheadPlusWhole=57517]="NoteheadPlusWhole",O[O.NoteheadPlusHalf=57518]="NoteheadPlusHalf",O[O.NoteheadPlusBlack=57519]="NoteheadPlusBlack",O[O.NoteheadSquareWhite=57528]="NoteheadSquareWhite",O[O.NoteheadSquareBlack=57529]="NoteheadSquareBlack",O[O.NoteheadTriangleUpDoubleWhole=57530]="NoteheadTriangleUpDoubleWhole",O[O.NoteheadTriangleUpWhole=57531]="NoteheadTriangleUpWhole",O[O.NoteheadTriangleUpHalf=57532]="NoteheadTriangleUpHalf",O[O.NoteheadTriangleUpBlack=57534]="NoteheadTriangleUpBlack",O[O.NoteheadTriangleRightWhite=57537]="NoteheadTriangleRightWhite",O[O.NoteheadTriangleRightBlack=57538]="NoteheadTriangleRightBlack",O[O.NoteheadTriangleDownDoubleWhole=57548]="NoteheadTriangleDownDoubleWhole",O[O.NoteheadTriangleDownWhole=57540]="NoteheadTriangleDownWhole",O[O.NoteheadTriangleDownHalf=57541]="NoteheadTriangleDownHalf",O[O.NoteheadTriangleDownBlack=57543]="NoteheadTriangleDownBlack",O[O.NoteheadDiamondDoubleWhole=57559]="NoteheadDiamondDoubleWhole",O[O.NoteheadDiamondWhole=57560]="NoteheadDiamondWhole",O[O.NoteheadDiamondHalf=57561]="NoteheadDiamondHalf",O[O.NoteheadDiamondBlack=57563]="NoteheadDiamondBlack",O[O.NoteheadDiamondBlackWide=57564]="NoteheadDiamondBlackWide",O[O.NoteheadDiamondWhite=57565]="NoteheadDiamondWhite",O[O.NoteheadDiamondWhiteWide=57566]="NoteheadDiamondWhiteWide",O[O.NoteheadCircleXDoubleWhole=57520]="NoteheadCircleXDoubleWhole",O[O.NoteheadCircleXWhole=57521]="NoteheadCircleXWhole",O[O.NoteheadCircleXHalf=57522]="NoteheadCircleXHalf",O[O.NoteheadCircleX=57523]="NoteheadCircleX",O[O.NoteheadXDoubleWhole=57510]="NoteheadXDoubleWhole",O[O.NoteheadXWhole=57511]="NoteheadXWhole",O[O.NoteheadXHalf=57512]="NoteheadXHalf",O[O.NoteheadXBlack=57513]="NoteheadXBlack",O[O.NoteheadParenthesis=57550]="NoteheadParenthesis",O[O.NoteheadSlashedBlack1=57551]="NoteheadSlashedBlack1",O[O.NoteheadSlashedBlack2=57552]="NoteheadSlashedBlack2",O[O.NoteheadSlashedHalf1=57553]="NoteheadSlashedHalf1",O[O.NoteheadSlashedHalf2=57554]="NoteheadSlashedHalf2",O[O.NoteheadSlashedWhole1=57555]="NoteheadSlashedWhole1",O[O.NoteheadSlashedWhole2=57556]="NoteheadSlashedWhole2",O[O.NoteheadSlashedDoubleWhole1=57557]="NoteheadSlashedDoubleWhole1",O[O.NoteheadSlashedDoubleWhole2=57558]="NoteheadSlashedDoubleWhole2",O[O.NoteheadCircledBlack=57572]="NoteheadCircledBlack",O[O.NoteheadCircledHalf=57573]="NoteheadCircledHalf",O[O.NoteheadCircledWhole=57574]="NoteheadCircledWhole",O[O.NoteheadCircledDoubleWhole=57575]="NoteheadCircledDoubleWhole",O[O.NoteheadCircleSlash=57591]="NoteheadCircleSlash",O[O.NoteheadHeavyX=57592]="NoteheadHeavyX",O[O.NoteheadHeavyXHat=57593]="NoteheadHeavyXHat",O[O.NoteheadSlashVerticalEnds=57600]="NoteheadSlashVerticalEnds",O[O.NoteheadSlashWhiteWhole=57602]="NoteheadSlashWhiteWhole",O[O.NoteheadSlashWhiteHalf=57603]="NoteheadSlashWhiteHalf",O[O.NoteheadRoundWhiteWithDot=57621]="NoteheadRoundWhiteWithDot",O[O.NoteheadSquareBlackLarge=57626]="NoteheadSquareBlackLarge",O[O.NoteheadSquareBlackWhite=57627]="NoteheadSquareBlackWhite",O[O.NoteheadClusterDoubleWhole3rd=57640]="NoteheadClusterDoubleWhole3rd",O[O.NoteheadClusterWhole3rd=57641]="NoteheadClusterWhole3rd",O[O.NoteheadClusterHalf3rd=57642]="NoteheadClusterHalf3rd",O[O.NoteheadClusterQuarter3rd=57643]="NoteheadClusterQuarter3rd",O[O.NoteShapeRoundWhite=57776]="NoteShapeRoundWhite",O[O.NoteShapeRoundBlack=57777]="NoteShapeRoundBlack",O[O.NoteShapeSquareWhite=57778]="NoteShapeSquareWhite",O[O.NoteShapeSquareBlack=57779]="NoteShapeSquareBlack",O[O.NoteShapeTriangleRightWhite=57780]="NoteShapeTriangleRightWhite",O[O.NoteShapeTriangleRightBlack=57781]="NoteShapeTriangleRightBlack",O[O.NoteShapeTriangleLeftWhite=57782]="NoteShapeTriangleLeftWhite",O[O.NoteShapeTriangleLeftBlack=57783]="NoteShapeTriangleLeftBlack",O[O.NoteShapeDiamondWhite=57784]="NoteShapeDiamondWhite",O[O.NoteShapeDiamondBlack=57785]="NoteShapeDiamondBlack",O[O.NoteShapeTriangleUpWhite=57786]="NoteShapeTriangleUpWhite",O[O.NoteShapeTriangleUpBlack=57787]="NoteShapeTriangleUpBlack",O[O.NoteShapeMoonWhite=57788]="NoteShapeMoonWhite",O[O.NoteShapeMoonBlack=57789]="NoteShapeMoonBlack",O[O.NoteShapeTriangleRoundWhite=57790]="NoteShapeTriangleRoundWhite",O[O.NoteShapeTriangleRoundBlack=57791]="NoteShapeTriangleRoundBlack",O[O.NoteQuarterUp=57813]="NoteQuarterUp",O[O.NoteEighthUp=57815]="NoteEighthUp",O[O.TextBlackNoteLongStem=57841]="TextBlackNoteLongStem",O[O.TextBlackNoteFrac8thLongStem=57843]="TextBlackNoteFrac8thLongStem",O[O.TextBlackNoteFrac16thLongStem=57845]="TextBlackNoteFrac16thLongStem",O[O.TextBlackNoteFrac32ndLongStem=57846]="TextBlackNoteFrac32ndLongStem",O[O.TextCont8thBeamLongStem=57848]="TextCont8thBeamLongStem",O[O.TextCont16thBeamLongStem=57850]="TextCont16thBeamLongStem",O[O.TextCont32ndBeamLongStem=57851]="TextCont32ndBeamLongStem",O[O.TextAugmentationDot=57852]="TextAugmentationDot",O[O.TextTupletBracketStartLongStem=57857]="TextTupletBracketStartLongStem",O[O.TextTuplet3LongStem=57858]="TextTuplet3LongStem",O[O.TextTupletBracketEndLongStem=57859]="TextTupletBracketEndLongStem",O[O.Tremolo3=57890]="Tremolo3",O[O.Tremolo2=57889]="Tremolo2",O[O.Tremolo1=57888]="Tremolo1",O[O.FlagEighthUp=57920]="FlagEighthUp",O[O.FlagEighthDown=57921]="FlagEighthDown",O[O.FlagSixteenthUp=57922]="FlagSixteenthUp",O[O.FlagSixteenthDown=57923]="FlagSixteenthDown",O[O.FlagThirtySecondUp=57924]="FlagThirtySecondUp",O[O.FlagThirtySecondDown=57925]="FlagThirtySecondDown",O[O.FlagSixtyFourthUp=57926]="FlagSixtyFourthUp",O[O.FlagSixtyFourthDown=57927]="FlagSixtyFourthDown",O[O.FlagOneHundredTwentyEighthUp=57928]="FlagOneHundredTwentyEighthUp",O[O.FlagOneHundredTwentyEighthDown=57929]="FlagOneHundredTwentyEighthDown",O[O.FlagTwoHundredFiftySixthUp=57930]="FlagTwoHundredFiftySixthUp",O[O.FlagTwoHundredFiftySixthDown=57931]="FlagTwoHundredFiftySixthDown",O[O.AccidentalFlat=57952]="AccidentalFlat",O[O.AccidentalNatural=57953]="AccidentalNatural",O[O.AccidentalSharp=57954]="AccidentalSharp",O[O.AccidentalDoubleSharp=57955]="AccidentalDoubleSharp",O[O.AccidentalDoubleFlat=57956]="AccidentalDoubleFlat",O[O.AccidentalQuarterToneFlatArrowUp=57968]="AccidentalQuarterToneFlatArrowUp",O[O.AccidentalQuarterToneSharpArrowUp=57972]="AccidentalQuarterToneSharpArrowUp",O[O.AccidentalQuarterToneNaturalArrowUp=57970]="AccidentalQuarterToneNaturalArrowUp",O[O.Segno=57415]="Segno",O[O.Coda=57416]="Coda",O[O.ArticAccentAbove=58528]="ArticAccentAbove",O[O.ArticAccentBelow=58529]="ArticAccentBelow",O[O.ArticStaccatoAbove=58530]="ArticStaccatoAbove",O[O.ArticStaccatoBelow=58531]="ArticStaccatoBelow",O[O.ArticTenutoAbove=58532]="ArticTenutoAbove",O[O.ArticTenutoBelow=58533]="ArticTenutoBelow",O[O.ArticMarcatoAbove=58540]="ArticMarcatoAbove",O[O.ArticMarcatoBelow=58541]="ArticMarcatoBelow",O[O.FermataAbove=58560]="FermataAbove",O[O.FermataShortAbove=58564]="FermataShortAbove",O[O.FermataLongAbove=58566]="FermataLongAbove",O[O.RestLonga=58593]="RestLonga",O[O.RestDoubleWhole=58594]="RestDoubleWhole",O[O.RestWhole=58595]="RestWhole",O[O.RestHalf=58596]="RestHalf",O[O.RestQuarter=58597]="RestQuarter",O[O.RestEighth=58598]="RestEighth",O[O.RestSixteenth=58599]="RestSixteenth",O[O.RestThirtySecond=58600]="RestThirtySecond",O[O.RestSixtyFourth=58601]="RestSixtyFourth",O[O.RestOneHundredTwentyEighth=58602]="RestOneHundredTwentyEighth",O[O.RestTwoHundredFiftySixth=58603]="RestTwoHundredFiftySixth",O[O.RestHBarLeft=58607]="RestHBarLeft",O[O.RestHBarMiddle=58608]="RestHBarMiddle",O[O.RestHBarRight=58609]="RestHBarRight",O[O.Repeat1Bar=58624]="Repeat1Bar",O[O.Repeat2Bars=58625]="Repeat2Bars",O[O.Ottava=58640]="Ottava",O[O.OttavaAlta=58641]="OttavaAlta",O[O.OttavaBassaVb=58652]="OttavaBassaVb",O[O.Quindicesima=58644]="Quindicesima",O[O.QuindicesimaAlta=58645]="QuindicesimaAlta",O[O.DynamicPPPPPP=58663]="DynamicPPPPPP",O[O.DynamicPPPPP=58664]="DynamicPPPPP",O[O.DynamicPPPP=58665]="DynamicPPPP",O[O.DynamicPPP=58666]="DynamicPPP",O[O.DynamicPP=58667]="DynamicPP",O[O.DynamicPiano=58656]="DynamicPiano",O[O.DynamicMP=58668]="DynamicMP",O[O.DynamicMF=58669]="DynamicMF",O[O.DynamicPF=58670]="DynamicPF",O[O.DynamicForte=58658]="DynamicForte",O[O.DynamicFF=58671]="DynamicFF",O[O.DynamicFFF=58672]="DynamicFFF",O[O.DynamicFFFF=58673]="DynamicFFFF",O[O.DynamicFFFFF=58674]="DynamicFFFFF",O[O.DynamicFFFFFF=58675]="DynamicFFFFFF",O[O.DynamicFortePiano=58676]="DynamicFortePiano",O[O.DynamicNiente=58662]="DynamicNiente",O[O.DynamicSforzando1=58678]="DynamicSforzando1",O[O.DynamicSforzandoPiano=58679]="DynamicSforzandoPiano",O[O.DynamicSforzandoPianissimo=58680]="DynamicSforzandoPianissimo",O[O.DynamicSforzato=58681]="DynamicSforzato",O[O.DynamicSforzatoPiano=58682]="DynamicSforzatoPiano",O[O.DynamicSforzatoFF=58683]="DynamicSforzatoFF",O[O.DynamicRinforzando1=58684]="DynamicRinforzando1",O[O.DynamicRinforzando2=58685]="DynamicRinforzando2",O[O.DynamicForzando=58677]="DynamicForzando",O[O.OrnamentTrill=58726]="OrnamentTrill",O[O.OrnamentTurn=58727]="OrnamentTurn",O[O.OrnamentTurnInverted=58728]="OrnamentTurnInverted",O[O.OrnamentShortTrill=58732]="OrnamentShortTrill",O[O.OrnamentMordent=58733]="OrnamentMordent",O[O.StringsDownBow=58896]="StringsDownBow",O[O.StringsUpBow=58898]="StringsUpBow",O[O.KeyboardPedalPed=58960]="KeyboardPedalPed",O[O.KeyboardPedalUp=58965]="KeyboardPedalUp",O[O.PictEdgeOfCymbal=59177]="PictEdgeOfCymbal",O[O.GuitarString0=59443]="GuitarString0",O[O.GuitarString1=59444]="GuitarString1",O[O.GuitarString2=59445]="GuitarString2",O[O.GuitarString3=59446]="GuitarString3",O[O.GuitarString4=59447]="GuitarString4",O[O.GuitarString5=59448]="GuitarString5",O[O.GuitarString6=59449]="GuitarString6",O[O.GuitarString7=59450]="GuitarString7",O[O.GuitarString8=59451]="GuitarString8",O[O.GuitarString9=59452]="GuitarString9",O[O.GuitarOpenPedal=59453]="GuitarOpenPedal",O[O.GuitarClosePedal=59455]="GuitarClosePedal",O[O.GuitarGolpe=59458]="GuitarGolpe",O[O.GuitarFadeIn=59459]="GuitarFadeIn",O[O.GuitarFadeOut=59460]="GuitarFadeOut",O[O.GuitarVolumeSwell=59461]="GuitarVolumeSwell",O[O.FretboardX=59481]="FretboardX",O[O.FretboardO=59482]="FretboardO",O[O.WiggleTrill=60068]="WiggleTrill",O[O.WiggleVibratoMediumFast=60126]="WiggleVibratoMediumFast",O[O.OctaveBaselineM=60565]="OctaveBaselineM",O[O.OctaveBaselineB=60563]="OctaveBaselineB",(H=tS||(tS={}))[H.Left=0]="Left",H[H.Center=1]="Center",H[H.Right=2]="Right",(V=t_||(t_={}))[V.Top=0]="Top",V[V.Middle=1]="Middle",V[V.Bottom=2]="Bottom";class iG{constructor(e,t){this.width=e,this.height=t}}class iz{constructor(e="",t=0,i=0,s=tb.None,a=tb.None,r=tb.None,n=tb.None,o=t_.Middle){this.elementType=e,this.outputMidiNumber=i,this.staffLine=t,this.noteHeadDefault=s,this.noteHeadHalf=a!==tb.None?a:s,this.noteHeadWhole=r!==tb.None?r:s,this.techniqueSymbol=n,this.techniqueSymbolPlacement=o}getSymbol(e){switch(e){case tt.Whole:return this.noteHeadWhole;case tt.Half:return this.noteHeadHalf;default:return this.noteHeadDefault}}}class iU{static articulationFromElementVariation(e,t){return e<iU.gp6ElementAndVariationToArticulation.length?(t>=iU.gp6ElementAndVariationToArticulation.length&&(t=0),iU.gp6ElementAndVariationToArticulation[e][t]):38}static getArticulation(e){let t=e.percussionArticulation;if(t<0)return null;let i=e.beat.voice.bar.staff.track.percussionArticulations;return t<i.length?i[t]:iU.getArticulationByInputMidiNumber(t)}static getElementAndVariation(e){let t=iU.getArticulation(e);if(!t)return[-1,-1];for(let e=0;e<iU.gp6ElementAndVariationToArticulation.length;e++){let i=iU.gp6ElementAndVariationToArticulation[e];for(let s=0;s<i.length;s++){let a=iU.getArticulationByInputMidiNumber(i[s]);if(a?.outputMidiNumber===t.outputMidiNumber)return[e,s]}}return[-1,-1]}static getArticulationByInputMidiNumber(e){return iU.instrumentArticulations.has(e)?iU.instrumentArticulations.get(e):null}}iU.gp6ElementAndVariationToArticulation=[[35,35,35],[38,91,37],[99,100,99],[56,100,56],[102,103,102],[43,43,43],[45,45,45],[47,47,47],[48,48,48],[50,50,50],[42,92,46],[44,44,44],[57,98,57],[49,97,49],[55,95,55],[51,93,127],[52,96,52]],iU.instrumentArticulations=new Map([[38,new iz("snare",3,38,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[37,new iz("snare",3,37,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack)],[91,new iz("snare",3,38,tb.NoteheadDiamondWhite,tb.NoteheadDiamondWhite,tb.NoteheadDiamondWhite)],[42,new iz("hiHat",-1,42,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack)],[92,new iz("hiHat",-1,46,tb.NoteheadCircleSlash,tb.NoteheadCircleSlash,tb.NoteheadCircleSlash)],[46,new iz("hiHat",-1,46,tb.NoteheadCircleX,tb.NoteheadCircleX,tb.NoteheadCircleX)],[44,new iz("hiHat",9,44,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack)],[35,new iz("kickDrum",8,35,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[36,new iz("kickDrum",7,36,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[50,new iz("tom",1,50,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[48,new iz("tom",2,48,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[47,new iz("tom",4,47,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[45,new iz("tom",5,45,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[43,new iz("tom",6,43,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[93,new iz("ride",0,51,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.PictEdgeOfCymbal,t_.Bottom)],[51,new iz("ride",0,51,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack)],[53,new iz("ride",0,53,tb.NoteheadDiamondWhite,tb.NoteheadDiamondWhite,tb.NoteheadDiamondWhite)],[94,new iz("ride",0,51,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.ArticStaccatoAbove,t_.Top)],[55,new iz("splash",-2,55,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack)],[95,new iz("splash",-2,55,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.ArticStaccatoAbove,t_.Bottom)],[52,new iz("china",-3,52,tb.NoteheadHeavyXHat,tb.NoteheadHeavyXHat,tb.NoteheadHeavyXHat)],[96,new iz("china",-3,52,tb.NoteheadHeavyXHat,tb.NoteheadHeavyXHat,tb.NoteheadHeavyXHat)],[49,new iz("crash",-2,49,tb.NoteheadHeavyX,tb.NoteheadHeavyX,tb.NoteheadHeavyX)],[97,new iz("crash",-2,49,tb.NoteheadHeavyX,tb.NoteheadHeavyX,tb.NoteheadHeavyX,tb.ArticStaccatoAbove,t_.Bottom)],[57,new iz("crash",-1,57,tb.NoteheadHeavyX,tb.NoteheadHeavyX,tb.NoteheadHeavyX)],[98,new iz("crash",-1,57,tb.NoteheadHeavyX,tb.NoteheadHeavyX,tb.NoteheadHeavyX,tb.ArticStaccatoAbove,t_.Bottom)],[99,new iz("cowbell",1,56,tb.NoteheadTriangleUpBlack,tb.NoteheadTriangleUpHalf,tb.NoteheadTriangleUpWhole)],[100,new iz("cowbell",1,56,tb.NoteheadXBlack,tb.NoteheadXHalf,tb.NoteheadXWhole)],[56,new iz("cowbell",0,56,tb.NoteheadTriangleUpBlack,tb.NoteheadTriangleUpHalf,tb.NoteheadTriangleUpWhole)],[101,new iz("cowbell",0,56,tb.NoteheadXBlack,tb.NoteheadXHalf,tb.NoteheadXWhole)],[102,new iz("cowbell",-1,56,tb.NoteheadTriangleUpBlack,tb.NoteheadTriangleUpHalf,tb.NoteheadTriangleUpWhole)],[103,new iz("cowbell",-1,56,tb.NoteheadXBlack,tb.NoteheadXHalf,tb.NoteheadXWhole)],[77,new iz("woodblock",-9,77,tb.NoteheadTriangleUpBlack,tb.NoteheadTriangleUpBlack,tb.NoteheadTriangleUpBlack)],[76,new iz("woodblock",-10,76,tb.NoteheadTriangleUpBlack,tb.NoteheadTriangleUpBlack,tb.NoteheadTriangleUpBlack)],[60,new iz("bongo",-4,60,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[104,new iz("bongo",-5,60,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole,tb.NoteheadParenthesis,t_.Middle)],[105,new iz("bongo",-6,60,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack)],[61,new iz("bongo",-7,61,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[106,new iz("bongo",-8,61,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole,tb.NoteheadParenthesis,t_.Middle)],[107,new iz("bongo",-16,61,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack)],[66,new iz("timbale",10,66,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[65,new iz("timbale",9,65,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[68,new iz("agogo",12,68,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[67,new iz("agogo",11,67,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[64,new iz("conga",17,64,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[108,new iz("conga",16,64,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack)],[109,new iz("conga",15,64,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole,tb.NoteheadParenthesis,t_.Middle)],[63,new iz("conga",14,63,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[110,new iz("conga",13,63,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack)],[62,new iz("conga",19,62,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole,tb.NoteheadParenthesis,t_.Middle)],[72,new iz("whistle",-11,72,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[71,new iz("whistle",-17,71,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[73,new iz("guiro",38,73,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[74,new iz("guiro",37,74,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[86,new iz("surdo",36,86,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[87,new iz("surdo",35,87,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadParenthesis,t_.Middle)],[54,new iz("tambourine",3,54,tb.NoteheadTriangleUpBlack,tb.NoteheadTriangleUpBlack,tb.NoteheadTriangleUpBlack)],[111,new iz("tambourine",2,54,tb.NoteheadTriangleUpBlack,tb.NoteheadTriangleUpBlack,tb.NoteheadTriangleUpBlack,tb.StringsUpBow,t_.Bottom)],[112,new iz("tambourine",1,54,tb.NoteheadTriangleUpBlack,tb.NoteheadTriangleUpBlack,tb.NoteheadTriangleUpBlack,tb.StringsDownBow,t_.Bottom)],[113,new iz("tambourine",-7,54,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack)],[79,new iz("cuica",30,79,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[78,new iz("cuica",29,78,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack)],[58,new iz("vibraslap",28,58,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[81,new iz("triangle",27,81,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[80,new iz("triangle",26,80,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadParenthesis,t_.Middle)],[114,new iz("grancassa",25,43,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[115,new iz("piatti",18,49,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[116,new iz("piatti",24,49,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack)],[69,new iz("cabasa",23,69,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[117,new iz("cabasa",22,69,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole,tb.StringsUpBow,t_.Bottom)],[85,new iz("castanets",21,85,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[75,new iz("claves",20,75,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[70,new iz("maraca",-12,70,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[118,new iz("maraca",-13,70,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole,tb.StringsUpBow,t_.Bottom)],[119,new iz("maraca",-14,70,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[120,new iz("maraca",-15,70,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole,tb.StringsUpBow,t_.Bottom)],[82,new iz("shaker",-23,54,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[122,new iz("shaker",-24,54,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole,tb.StringsUpBow,t_.Bottom)],[84,new iz("bellTree",-18,53,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[123,new iz("bellTree",-19,53,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole,tb.StringsUpBow,t_.Bottom)],[83,new iz("jingleBell",-20,53,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[124,new iz("unpitched",-21,62,tb.NoteheadNull,tb.NoteheadNull,tb.NoteheadNull,tb.GuitarGolpe,t_.Top)],[125,new iz("unpitched",-22,62,tb.NoteheadNull,tb.NoteheadNull,tb.NoteheadNull,tb.GuitarGolpe,t_.Bottom)],[39,new iz("handClap",3,39,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[40,new iz("snare",3,40,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[31,new iz("snare",3,40,tb.NoteheadSlashedBlack2,tb.NoteheadSlashedBlack2,tb.NoteheadSlashedBlack2)],[41,new iz("tom",5,41,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole)],[59,new iz("ride",2,59,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.PictEdgeOfCymbal,t_.Bottom)],[126,new iz("ride",2,59,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack)],[127,new iz("ride",2,59,tb.NoteheadDiamondWhite,tb.NoteheadDiamondWhite,tb.NoteheadDiamondWhite)],[29,new iz("ride",2,59,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.ArticStaccatoAbove,t_.Top)],[30,new iz("crash",-3,49,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack)],[33,new iz("snare",3,37,tb.NoteheadXBlack,tb.NoteheadXBlack,tb.NoteheadXBlack)],[34,new iz("snare",3,38,tb.NoteheadBlack,tb.NoteheadBlack,tb.NoteheadBlack)]]),iU.instrumentArticulationNames=new Map([["Ride (choke)",29],["Cymbal (hit)",30],["Snare (side stick)",31],["Snare (side stick) 2",33],["Snare (hit)",34],["Kick (hit)",35],["Kick (hit) 2",36],["Snare (side stick) 3",37],["Snare (hit) 2",38],["Hand Clap (hit)",39],["Snare (hit) 3",40],["Low Floor Tom (hit)",41],["Hi-Hat (closed)",42],["Very Low Tom (hit)",43],["Pedal Hi-Hat (hit)",44],["Low Tom (hit)",45],["Hi-Hat (open)",46],["Mid Tom (hit)",47],["High Tom (hit)",48],["Crash high (hit)",49],["High Floor Tom (hit)",50],["Ride (middle)",51],["China (hit)",52],["Ride (bell)",53],["Tambourine (hit)",54],["Splash (hit)",55],["Cowbell medium (hit)",56],["Crash medium (hit)",57],["Vibraslap (hit)",58],["Ride (edge)",59],["Hand (hit)",60],["Hand (hit)",61],["Conga high (mute)",62],["Conga high (hit)",63],["Conga low (hit)",64],["Timbale high (hit)",65],["Timbale low (hit)",66],["Agogo high (hit)",67],["Agogo tow (hit)",68],["Cabasa (hit)",69],["Left Maraca (hit)",70],["Whistle high (hit)",71],["Whistle low (hit)",72],["Guiro (hit)",73],["Guiro (scrap-return)",74],["Claves (hit)",75],["Woodblock high (hit)",76],["Woodblock low (hit)",77],["Cuica (mute)",78],["Cuica (open)",79],["Triangle (rnute)",80],["Triangle (hit)",81],["Shaker (hit)",82],["Tinkle Bell (hat)",83],["Jingle Bell (hit)",83],["Bell Tree (hit)",84],["Castanets (hit)",85],["Surdo (hit)",86],["Surdo (mute)",87],["Snare (rim shot)",91],["Hi-Hat (half)",92],["Ride (edge) 2",93],["Ride (choke) 2",94],["Splash (choke)",95],["China (choke)",96],["Crash high (choke)",97],["Crash medium (choke)",98],["Cowbell low (hit)",99],["Cowbell low (tip)",100],["Cowbell medium (tip)",101],["Cowbell high (hit)",102],["Cowbell high (tip)",103],["Hand (mute)",104],["Hand (slap)",105],["Hand (mute) 2",106],["Hand (slap) 2",107],["Conga low (slap)",108],["Conga low (mute)",109],["Conga high (slap)",110],["Tambourine (return)",111],["Tambourine (roll)",112],["Tambourine (hand)",113],["Grancassa (hit)",114],["Piatti (hat)",115],["Piatti (hand)",116],["Cabasa (return)",117],["Left Maraca (return)",118],["Right Maraca (hit)",119],["Right Maraca (return)",120],["Shaker (return)",122],["Bell Tee (return)",123],["Golpe (thumb)",124],["Golpe (finger)",125],["Ride (middle) 2",126],["Ride (bell) 2",127]]),(W=tw||(tw={}))[W.None=0]="None",W[W.InvertedTurn=1]="InvertedTurn",W[W.Turn=2]="Turn",W[W.UpperMordent=3]="UpperMordent",W[W.LowerMordent=4]="LowerMordent";class iX{constructor(){this.tieDestinationNoteId=-1,this.tieOriginNoteId=-1,this.slurDestinationNoteId=-1,this.slurOriginNoteId=-1,this.hammerPullDestinationNoteId=-1,this.hammerPullOriginNoteId=-1,this.slideTargetNoteId=-1,this.slideOriginNoteId=-1}}(G=tk||(tk={}))[G.Effects=0]="Effects",G[G.StandardNotationNoteHead=1]="StandardNotationNoteHead",G[G.StandardNotationAccidentals=2]="StandardNotationAccidentals",G[G.StandardNotationEffects=3]="StandardNotationEffects",G[G.GuitarTabFretNumber=4]="GuitarTabFretNumber",G[G.GuitarTabEffects=5]="GuitarTabEffects",G[G.SlashNoteHead=6]="SlashNoteHead",G[G.SlashEffects=7]="SlashEffects",G[G.NumberedNumber=8]="NumberedNumber",G[G.NumberedAccidentals=9]="NumberedAccidentals",G[G.NumberedEffects=10]="NumberedEffects";class iJ extends ik{}class iY{constructor(){this.id=iY.GlobalNoteId++,this.index=0,this.accentuated=ts.None,this.bendType=e7.None,this.bendStyle=e8.Default,this.bendOrigin=null,this.isContinuedBend=!1,this.bendPoints=null,this.maxBendPoint=null,this.fret=-1,this.string=-1,this.showStringNumber=!1,this.octave=-1,this.tone=-1,this.percussionArticulation=-1,this.isVisible=!0,this.isLeftHandTapped=!1,this.isHammerPullOrigin=!1,this.hammerPullOrigin=null,this.hammerPullDestination=null,this.isSlurDestination=!1,this.slurOrigin=null,this.slurDestination=null,this.harmonicType=tr.None,this.harmonicValue=0,this.isGhost=!1,this.isLetRing=!1,this.letRingDestination=null,this.isPalmMute=!1,this.palmMuteDestination=null,this.isDead=!1,this.isStaccato=!1,this.slideInType=to.None,this.slideOutType=tl.None,this.slideTarget=null,this.slideOrigin=null,this.vibrato=th.None,this.tieOrigin=null,this.tieDestination=null,this.isTieDestination=!1,this.leftHandFinger=ta.Unknown,this.rightHandFinger=ta.Unknown,this.trillValue=-1,this.trillSpeed=tt.ThirtySecond,this.durationPercent=1,this.accidentalMode=tn.Default,this.dynamics=e4.F,this.isEffectSlurOrigin=!1,this.hasEffectSlur=!1,this.effectSlurOrigin=null,this.effectSlurDestination=null,this.ornament=tw.None,this._noteIdBag=null}static resetIds(){iY.GlobalNoteId=0}get hasBend(){return null!==this.bendPoints&&this.bendType!==e7.None}get isStringed(){return this.string>=0}get isPiano(){return!this.isStringed&&this.octave>=0&&this.tone>=0}get isPercussion(){return!this.isStringed&&this.percussionArticulation>=0}get element(){return this.isPercussion?iU.getElementAndVariation(this)[0]:-1}get variation(){return this.isPercussion?iU.getElementAndVariation(this)[1]:-1}get isHammerPullDestination(){return!!this.hammerPullOrigin}get isSlurOrigin(){return!!this.slurDestination}get isHarmonic(){return this.harmonicType!==tr.None}get isTieOrigin(){return null!==this.tieDestination}get isFingering(){return this.leftHandFinger!==ta.Unknown||this.rightHandFinger!==ta.Unknown}get trillFret(){return this.trillValue-this.stringTuning}get isTrill(){return this.trillValue>=0}get isEffectSlurDestination(){return!!this.effectSlurOrigin}get stringTuning(){return this.beat.voice.bar.staff.capo+iY.getStringTuning(this.beat.voice.bar.staff,this.string)}static getStringTuning(e,t){return e.tuning.length>0?e.tuning[e.tuning.length-(t-1)-1]:0}get realValue(){return this.calculateRealValue(!0,!0)}get realValueWithoutHarmonic(){return this.calculateRealValue(!0,!1)}calculateRealValue(e,t){let i=e?this.beat.voice.bar.staff.transpositionPitch:0;if(t){let t=this.calculateRealValue(e,!1);return this.isStringed&&(this.harmonicType===tr.Natural?t=this.harmonicPitch+this.stringTuning-i:t+=this.harmonicPitch),t}return this.isPercussion?this.percussionArticulation:this.isStringed?this.fret+this.stringTuning-i:this.isPiano?12*this.octave+this.tone-i:0}get harmonicPitch(){if(this.harmonicType===tr.None||!this.isStringed)return 0;let e=this.harmonicValue;return iW.isAlmostEqualTo(e,2.4)?36:iW.isAlmostEqualTo(e,2.7)?34:e<3?0:e<=3.5?31:e<=4?28:e<=5?24:e<=6?34:e<=7?19:e<=8.5?36:e<=9?28:e<=10?34:e<=11?0:e<=12?12:e<14?0:e<=15?34:e<=16?28:e<=17?36:e<=18?0:e<=19?19:e<=21?0:e<=22?36:24*(e<=24)}get initialBendValue(){return this.hasBend?Math.floor(this.bendPoints[0].value/2):this.bendOrigin?Math.floor(this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value/2):this.isTieDestination&&this.tieOrigin.bendOrigin?Math.floor(this.tieOrigin.bendOrigin.bendPoints[this.tieOrigin.bendOrigin.bendPoints.length-1].value/2):this.beat.hasWhammyBar?Math.floor(this.beat.whammyBarPoints[0].value/2):this.beat.isContinuedWhammy?Math.floor(this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value/2):0}get displayValue(){return this.displayValueWithoutBend+this.initialBendValue}get displayValueWithoutBend(){let e=this.realValue;switch(this.harmonicType!==tr.Natural&&this.harmonicType!==tr.None&&(e-=this.harmonicPitch),this.beat.ottava){case eQ._15ma:e-=24;break;case eQ._8va:e-=12;break;case eQ.Regular:break;case eQ._8vb:e+=12;break;case eQ._15mb:e+=24}switch(this.beat.voice.bar.clefOttava){case eQ._15ma:e-=24;break;case eQ._8va:e-=12;break;case eQ.Regular:break;case eQ._8vb:e+=12;break;case eQ._15mb:e+=24}return e-this.beat.voice.bar.staff.displayTranspositionPitch}get hasQuarterToneOffset(){return this.hasBend?this.bendPoints[0].value%2!=0:this.bendOrigin?this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value%2!=0:this.beat.hasWhammyBar?this.beat.whammyBarPoints[0].value%2!=0:!!this.beat.isContinuedWhammy&&this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value%2!=0}addBendPoint(e){let t=this.bendPoints;null===t&&(t=[],this.bendPoints=t),t.push(e),(!this.maxBendPoint||e.value>this.maxBendPoint.value)&&(this.maxBendPoint=e),this.bendType===e7.None&&(this.bendType=e7.Custom)}finish(e,t=null){let i=new iD(()=>iY.nextNoteOnSameLine(this)),s=e&&e.notation.notationMode===tu.SongBook;if(this.isTieDestination&&(this.chain(t),s&&this.tieOrigin&&this.tieOrigin.isLetRing&&(this.isLetRing=!0)),this.isLetRing&&(i.value&&i.value.isLetRing?this.letRingDestination=i.value:this.letRingDestination=this,s&&this.isTieDestination&&!this.tieOrigin.hasBend&&(this.isVisible=!1)),this.isPalmMute&&(i.value&&i.value.isPalmMute?this.palmMuteDestination=i.value:this.palmMuteDestination=this),this.isHammerPullOrigin){let e=iY.findHammerPullDestination(this);e?(this.hammerPullDestination=e,e.hammerPullOrigin=this):this.isHammerPullOrigin=!1}switch(this.slideOutType){case tl.Shift:case tl.Legato:this.slideTarget||(this.slideTarget=i.value),this.slideTarget?this.slideTarget.slideOrigin=this:this.slideOutType=tl.None}let a=null;this.isHammerPullOrigin&&this.hammerPullDestination?a=this.hammerPullDestination:this.slideOutType===tl.Legato&&this.slideTarget&&(a=this.slideTarget),a&&(this.hasEffectSlur=!0,this.effectSlurOrigin&&this.beat.pickStroke===ty.None?(this.effectSlurOrigin.effectSlurDestination=a,this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin,this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=a,this.effectSlurDestination.effectSlurOrigin=this));let r=this.bendPoints,n=null!=r&&r.length>0;if(n){let e=this.isTieDestination&&this.tieOrigin.hasBend;this.isContinuedBend=e}else this.bendType=e7.None;if(n&&this.bendType===e7.Custom){if(4===r.length){let e=r[0],t=r[1],i=r[2],s=r[3];t.value===i.value?s.value>e.value?t.value>s.value?this.bendType=e7.BendRelease:(!this.isContinuedBend&&e.value>0?this.bendType=e7.PrebendBend:this.bendType=e7.Bend,r.splice(2,1),r.splice(1,1)):s.value<e.value?(this.isContinuedBend?this.bendType=e7.Release:this.bendType=e7.PrebendRelease,r.splice(2,1),r.splice(1,1)):t.value>e.value?this.bendType=e7.BendRelease:(e.value>0&&!this.isContinuedBend?this.bendType=e7.Prebend:this.bendType=e7.Hold,r.splice(2,1),r.splice(1,1)):iM.warning("Model","Unsupported bend type detected, fallback to custom",null)}else if(2===r.length){let e=r[0],t=r[1];t.value>e.value?!this.isContinuedBend&&e.value>0?this.bendType=e7.PrebendBend:this.bendType=e7.Bend:t.value<e.value?this.isContinuedBend?this.bendType=e7.Release:this.bendType=e7.PrebendRelease:e.value>0&&!this.isContinuedBend?this.bendType=e7.Prebend:this.bendType=e7.Hold}}this.initialBendValue>0&&(this.accidentalMode=tn.Default)}static nextNoteOnSameLine(e){let t=e.beat.nextBeat;for(;t&&t.voice.bar.index<=e.beat.voice.bar.index+iY.MaxOffsetForSameLineSearch;){let i=t.getNoteOnString(e.string);if(i)return i;t=t.nextBeat}return null}static findHammerPullDestination(e){let t=e.beat.nextBeat;for(;t&&t.voice.bar.index<=e.beat.voice.bar.index+iY.MaxOffsetForSameLineSearch;){let i=t.getNoteOnString(e.string);if(i)return i;for(let s=e.string;s>0;s--)if(i=t.getNoteOnString(s)){if(i.isLeftHandTapped)return i;break}for(let s=e.string;s<=e.beat.voice.bar.staff.tuning.length;s++)if(i=t.getNoteOnString(s)){if(i.isLeftHandTapped)return i;break}t=t.nextBeat}return null}static findTieOrigin(e){let t=e.beat.previousBeat;for(;t&&t.voice.bar.index>=e.beat.voice.bar.index-iY.MaxOffsetForSameLineSearch;){if(e.isStringed){let i=t.getNoteOnString(e.string);if(i)return i}else if(-1===e.octave&&-1===e.tone){if(e.index<t.notes.length)return t.notes[e.index]}else{let i=t.getNoteWithRealValue(e.realValue);if(i)return i}t=t.previousBeat}return null}chain(e=null){if(null!==e)if(null!==this._noteIdBag){let t;e.has(iY.NoteIdLookupKey)?t=e.get(iY.NoteIdLookupKey):(t=new Map,e.set(iY.NoteIdLookupKey,t)),(-1!==this._noteIdBag.hammerPullDestinationNoteId||-1!==this._noteIdBag.tieDestinationNoteId||-1!==this._noteIdBag.slurDestinationNoteId||-1!==this._noteIdBag.slideTargetNoteId)&&t.set(this.id,this),-1!==this._noteIdBag.hammerPullOriginNoteId&&(this.hammerPullOrigin=t.get(this._noteIdBag.hammerPullOriginNoteId),this.hammerPullOrigin.hammerPullDestination=this),-1!==this._noteIdBag.tieOriginNoteId&&(this.tieOrigin=t.get(this._noteIdBag.tieOriginNoteId),this.tieOrigin.tieDestination=this),-1!==this._noteIdBag.slurOriginNoteId&&(this.slurOrigin=t.get(this._noteIdBag.slurOriginNoteId),this.slurOrigin.slurDestination=this),-1!==this._noteIdBag.slideOriginNoteId&&(this.slideOrigin=t.get(this._noteIdBag.slideOriginNoteId),this.slideOrigin.slideTarget=this),this._noteIdBag=null}else{if(!this.isTieDestination&&null===this.tieOrigin)return;let e=this.tieOrigin??iY.findTieOrigin(this);e?(e.tieDestination=this,this.tieOrigin=e,this.fret=e.fret,this.octave=e.octave,this.tone=e.tone,e.hasBend&&(this.bendOrigin=this.tieOrigin)):this.isTieDestination=!1}}toJson(e){null!==this.tieDestination&&e.set("tiedestinationnoteid",this.tieDestination.id),null!==this.tieOrigin&&e.set("tieoriginnoteid",this.tieOrigin.id),null!==this.slurDestination&&e.set("slurdestinationnoteid",this.slurDestination.id),null!==this.slurOrigin&&e.set("sluroriginnoteid",this.slurOrigin.id),null!==this.hammerPullOrigin&&e.set("hammerpulloriginnoteid",this.hammerPullOrigin.id),null!==this.hammerPullDestination&&e.set("hammerpulldestinationnoteid",this.hammerPullDestination.id),null!==this.slideTarget&&e.set("slidetargetnoteid",this.slideTarget.id),null!==this.slideOrigin&&e.set("slideoriginnoteid",this.slideOrigin.id)}setProperty(e,t){switch(e){case"tiedestinationnoteid":return null==this._noteIdBag&&(this._noteIdBag=new iX),this._noteIdBag.tieDestinationNoteId=t,!0;case"tieoriginnoteid":return null==this._noteIdBag&&(this._noteIdBag=new iX),this._noteIdBag.tieOriginNoteId=t,!0;case"slurdestinationnoteid":return null==this._noteIdBag&&(this._noteIdBag=new iX),this._noteIdBag.slurDestinationNoteId=t,!0;case"sluroriginnoteid":return null==this._noteIdBag&&(this._noteIdBag=new iX),this._noteIdBag.slurOriginNoteId=t,!0;case"hammerpulloriginnoteid":return null==this._noteIdBag&&(this._noteIdBag=new iX),this._noteIdBag.hammerPullOriginNoteId=t,!0;case"hammerpulldestinationnoteid":return null==this._noteIdBag&&(this._noteIdBag=new iX),this._noteIdBag.hammerPullDestinationNoteId=t,!0;case"slidetargetnoteid":return null==this._noteIdBag&&(this._noteIdBag=new iX),this._noteIdBag.slideTargetNoteId=t,!0;case"slideoriginnoteid":return null==this._noteIdBag&&(this._noteIdBag=new iX),this._noteIdBag.slideOriginNoteId=t,!0}return!1}}iY.GlobalNoteId=0,iY.MaxOffsetForSameLineSearch=3,iY.NoteIdLookupKey="NoteIdLookup";class iq{constructor(e){this._isEqualLengthTuplet=!0,this.totalDuration=0,this.beats=[],this.isFull=!1,this.voice=e}check(e){if(0===this.beats.length)return this.beats.push(e),this.totalDuration+=e.playbackDuration,!0;if(e.graceType!==ti.None)return!0;if(e.voice!==this.voice||this.isFull||e.tupletNumerator!==this.beats[0].tupletNumerator||e.tupletDenominator!==this.beats[0].tupletDenominator)return!1;if(e.playbackDuration!==this.beats[0].playbackDuration&&(this._isEqualLengthTuplet=!1),this.beats.push(e),this.totalDuration+=e.playbackDuration,this._isEqualLengthTuplet)this.beats.length===this.beats[0].tupletNumerator&&(this.isFull=!0);else{let e=this.beats[0].tupletNumerator/this.beats[0].tupletDenominator|0;for(let t of iq.AllTicks)if(this.totalDuration===t*e){this.isFull=!0;break}}return!0}}iq.HalfTicks=1920,iq.QuarterTicks=960,iq.EighthTicks=480,iq.SixteenthTicks=240,iq.ThirtySecondTicks=120,iq.SixtyFourthTicks=60,iq.OneHundredTwentyEighthTicks=30,iq.TwoHundredFiftySixthTicks=15,iq.AllTicks=[iq.HalfTicks,iq.QuarterTicks,iq.EighthTicks,iq.SixteenthTicks,iq.ThirtySecondTicks,iq.SixtyFourthTicks,iq.OneHundredTwentyEighthTicks,iq.TwoHundredFiftySixthTicks],(z=tB||(tB={}))[z.None=0]="None",z[z.Custom=1]="Custom",z[z.Dive=2]="Dive",z[z.Dip=3]="Dip",z[z.Hold=4]="Hold",z[z.Predive=5]="Predive",z[z.PrediveDive=6]="PrediveDive";class i${static clone(e){let t=new iF;return t.offset=e.offset,t.value=e.value,t}}class ij{static clone(e){let t=new iY;if(t.index=e.index,t.accentuated=e.accentuated,t.bendType=e.bendType,t.bendStyle=e.bendStyle,t.isContinuedBend=e.isContinuedBend,e.bendPoints)for(let i of(t.bendPoints=[],e.bendPoints))t.addBendPoint(i$.clone(i));return t.fret=e.fret,t.string=e.string,t.showStringNumber=e.showStringNumber,t.octave=e.octave,t.tone=e.tone,t.percussionArticulation=e.percussionArticulation,t.isVisible=e.isVisible,t.isLeftHandTapped=e.isLeftHandTapped,t.isHammerPullOrigin=e.isHammerPullOrigin,t.isSlurDestination=e.isSlurDestination,t.harmonicType=e.harmonicType,t.harmonicValue=e.harmonicValue,t.isGhost=e.isGhost,t.isLetRing=e.isLetRing,t.isPalmMute=e.isPalmMute,t.isDead=e.isDead,t.isStaccato=e.isStaccato,t.slideInType=e.slideInType,t.slideOutType=e.slideOutType,t.vibrato=e.vibrato,t.isTieDestination=e.isTieDestination,t.leftHandFinger=e.leftHandFinger,t.rightHandFinger=e.rightHandFinger,t.trillValue=e.trillValue,t.trillSpeed=e.trillSpeed,t.durationPercent=e.durationPercent,t.accidentalMode=e.accidentalMode,t.dynamics=e.dynamics,t.ornament=e.ornament,t}}class iK{static clone(e){let t=new iP;return t.barOccurence=e.barOccurence,t.millisecondOffset=e.millisecondOffset,t}}class iQ{static clone(e){let t=new iv;return t.isLinear=e.isLinear,t.type=e.type,t.value=e.value,t.syncPointValue=e.syncPointValue?iK.clone(e.syncPointValue):void 0,t.ratioPosition=e.ratioPosition,t.text=e.text,t}}class iZ{static clone(e){let t=new i1;for(let i of(t.index=e.index,t.notes=[],e.notes))t.addNote(ij.clone(i));for(let i of(t.isEmpty=e.isEmpty,t.whammyStyle=e.whammyStyle,t.ottava=e.ottava,t.isLegatoOrigin=e.isLegatoOrigin,t.duration=e.duration,t.isLetRing=e.isLetRing,t.isPalmMute=e.isPalmMute,t.automations=[],e.automations))t.automations.push(iQ.clone(i));if(t.dots=e.dots,t.fade=e.fade,t.lyrics=e.lyrics?e.lyrics.slice():null,t.pop=e.pop,t.slap=e.slap,t.tap=e.tap,t.text=e.text,t.slashed=e.slashed,t.deadSlapped=e.deadSlapped,t.brushType=e.brushType,t.brushDuration=e.brushDuration,t.tupletDenominator=e.tupletDenominator,t.tupletNumerator=e.tupletNumerator,t.isContinuedWhammy=e.isContinuedWhammy,t.whammyBarType=e.whammyBarType,e.whammyBarPoints)for(let i of(t.whammyBarPoints=[],e.whammyBarPoints))t.addWhammyBarPoint(i$.clone(i));return t.vibrato=e.vibrato,t.chordId=e.chordId,t.graceType=e.graceType,t.pickStroke=e.pickStroke,t.tremoloSpeed=e.tremoloSpeed,t.crescendo=e.crescendo,t.displayStart=e.displayStart,t.playbackStart=e.playbackStart,t.displayDuration=e.displayDuration,t.playbackDuration=e.playbackDuration,t.overrideDisplayDuration=e.overrideDisplayDuration,t.golpe=e.golpe,t.dynamics=e.dynamics,t.invertBeamDirection=e.invertBeamDirection,t.preferredBeamDirection=e.preferredBeamDirection,t.isEffectSlurOrigin=e.isEffectSlurOrigin,t.beamingMode=e.beamingMode,t.wahPedal=e.wahPedal,t.barreFret=e.barreFret,t.barreShape=e.barreShape,t.rasgueado=e.rasgueado,t.showTimer=e.showTimer,t.timer=e.timer,t}}(U=tT||(tT={}))[U.None=0]="None",U[U.Thumb=1]="Thumb",U[U.Finger=2]="Finger",(X=tN||(tN={}))[X.None=0]="None",X[X.FadeIn=1]="FadeIn",X[X.FadeOut=2]="FadeOut",X[X.VolumeSwell=3]="VolumeSwell",(J=tx||(tx={}))[J.None=0]="None",J[J.Open=1]="Open",J[J.Closed=2]="Closed",(Y=tP||(tP={}))[Y.None=0]="None",Y[Y.Full=1]="Full",Y[Y.Half=2]="Half",(q=tv||(tv={}))[q.None=0]="None",q[q.Ii=1]="Ii",q[q.Mi=2]="Mi",q[q.MiiTriplet=3]="MiiTriplet",q[q.MiiAnapaest=4]="MiiAnapaest",q[q.PmpTriplet=5]="PmpTriplet",q[q.PmpAnapaest=6]="PmpAnapaest",q[q.PeiTriplet=7]="PeiTriplet",q[q.PeiAnapaest=8]="PeiAnapaest",q[q.PaiTriplet=9]="PaiTriplet",q[q.PaiAnapaest=10]="PaiAnapaest",q[q.AmiTriplet=11]="AmiTriplet",q[q.AmiAnapaest=12]="AmiAnapaest",q[q.Ppp=13]="Ppp",q[q.Amii=14]="Amii",q[q.Amip=15]="Amip",q[q.Eami=16]="Eami",q[q.Eamii=17]="Eamii",q[q.Peami=18]="Peami",($=tF||(tF={}))[$.Auto=0]="Auto",$[$.ForceSplitToNext=1]="ForceSplitToNext",$[$.ForceMergeWithNext=2]="ForceMergeWithNext",$[$.ForceSplitOnSecondaryToNext=3]="ForceSplitOnSecondaryToNext",(j=tC||(tC={}))[j.Effects=0]="Effects",j[j.StandardNotationStem=1]="StandardNotationStem",j[j.StandardNotationFlags=2]="StandardNotationFlags",j[j.StandardNotationBeams=3]="StandardNotationBeams",j[j.StandardNotationTuplet=4]="StandardNotationTuplet",j[j.StandardNotationEffects=5]="StandardNotationEffects",j[j.StandardNotationRests=6]="StandardNotationRests",j[j.GuitarTabStem=7]="GuitarTabStem",j[j.GuitarTabFlags=8]="GuitarTabFlags",j[j.GuitarTabBeams=9]="GuitarTabBeams",j[j.GuitarTabTuplet=10]="GuitarTabTuplet",j[j.GuitarTabEffects=11]="GuitarTabEffects",j[j.GuitarTabRests=12]="GuitarTabRests",j[j.SlashStem=13]="SlashStem",j[j.SlashFlags=14]="SlashFlags",j[j.SlashBeams=15]="SlashBeams",j[j.SlashTuplet=16]="SlashTuplet",j[j.SlashRests=17]="SlashRests",j[j.SlashEffects=18]="SlashEffects",j[j.NumberedDuration=19]="NumberedDuration",j[j.NumberedEffects=20]="NumberedEffects",j[j.NumberedRests=21]="NumberedRests",j[j.NumberedTuplet=22]="NumberedTuplet";class i0 extends ik{}class i1{constructor(){this.id=i1._globalBeatId++,this.index=0,this.previousBeat=null,this.nextBeat=null,this.notes=[],this.noteStringLookup=new Map,this.noteValueLookup=new Map,this.isEmpty=!1,this.whammyStyle=e8.Default,this.ottava=eQ.Regular,this.fermata=null,this.isLegatoOrigin=!1,this.minNote=null,this.maxNote=null,this.maxStringNote=null,this.minStringNote=null,this.duration=tt.Quarter,this.isLetRing=!1,this.isPalmMute=!1,this.automations=[],this.dots=0,this.fade=tN.None,this.lyrics=null,this.pop=!1,this.slap=!1,this.tap=!1,this.text=null,this.slashed=!1,this.deadSlapped=!1,this.brushType=e9.None,this.brushDuration=0,this.tupletDenominator=-1,this.tupletNumerator=-1,this.tupletGroup=null,this.isContinuedWhammy=!1,this.whammyBarType=tB.None,this.whammyBarPoints=null,this.maxWhammyPoint=null,this.minWhammyPoint=null,this.vibrato=th.None,this.chordId=null,this.graceType=ti.None,this.graceGroup=null,this.graceIndex=-1,this.pickStroke=ty.None,this.tremoloSpeed=null,this.crescendo=te.None,this.displayStart=0,this.playbackStart=0,this.displayDuration=0,this.playbackDuration=0,this.golpe=tT.None,this.dynamics=e4.F,this.invertBeamDirection=!1,this.preferredBeamDirection=null,this.isEffectSlurOrigin=!1,this.effectSlurOrigin=null,this.effectSlurDestination=null,this.beamingMode=tF.Auto,this.wahPedal=tx.None,this.barreFret=-1,this.barreShape=tP.None,this.rasgueado=tv.None,this.showTimer=!1,this.timer=null}static resetIds(){i1._globalBeatId=0}get isLastOfVoice(){return this.index===this.voice.beats.length-1}get isLegatoDestination(){return!!this.previousBeat&&this.previousBeat.isLegatoOrigin}get isRest(){return this.isEmpty||!this.deadSlapped&&0===this.notes.length}get isFullBarRest(){return this.isRest&&1===this.voice.beats.length&&this.duration===tt.Whole}get fadeIn(){return this.fade===tN.FadeIn}set fadeIn(e){this.fade=e?tN.FadeIn:tN.None}get hasRasgueado(){return this.rasgueado!==tv.None}get hasTuplet(){return(-1!==this.tupletDenominator||-1!==this.tupletNumerator)&&(1!==this.tupletDenominator||1!==this.tupletNumerator)}get hasWhammyBar(){return null!==this.whammyBarPoints&&this.whammyBarType!==tB.None}get hasChord(){return!!this.chordId}get chord(){return this.chordId?this.voice.bar.staff.getChord(this.chordId):null}get isTremolo(){return!!this.tremoloSpeed}get displayEnd(){return this.displayStart+this.displayDuration}get absoluteDisplayStart(){return this.voice.bar.masterBar.start+this.displayStart}get absolutePlaybackStart(){return this.voice.bar.masterBar.start+this.playbackStart}get isEffectSlurDestination(){return!!this.effectSlurOrigin}get isBarre(){return this.barreShape!==tP.None&&this.barreFret>=0}addWhammyBarPoint(e){let t=this.whammyBarPoints;null===t&&(t=[],this.whammyBarPoints=t),t.push(e),(!this.maxWhammyPoint||e.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=e),(!this.minWhammyPoint||e.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=e),this.whammyBarType===tB.None&&(this.whammyBarType=tB.Custom)}removeWhammyBarPoint(e){let t=this.whammyBarPoints;if(null===t||e<0||e>=t.length)return;t.splice(e,1);let i=t[e];if(i===this.maxWhammyPoint)for(let e of(this.maxWhammyPoint=null,t))(!this.maxWhammyPoint||e.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=e);if(i===this.minWhammyPoint)for(let e of(this.minWhammyPoint=null,t))(!this.minWhammyPoint||e.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=e)}addNote(e){e.beat=this,e.index=this.notes.length,this.notes.push(e),e.isStringed&&this.noteStringLookup.set(e.string,e)}removeNote(e){let t=this.notes.indexOf(e);t>=0&&(this.notes.splice(t,1),e.isStringed&&this.noteStringLookup.delete(e.string))}getAutomation(e){for(let t=0,i=this.automations.length;t<i;t++){let i=this.automations[t];if(i.type===e)return i}return null}getNoteOnString(e){return this.noteStringLookup.has(e)?this.noteStringLookup.get(e):null}calculateDuration(){if(void 0!==this.overrideDisplayDuration)return this.overrideDisplayDuration;if(this.isFullBarRest)return this.voice.bar.masterBar.calculateDuration();let e=ix.toTicks(this.duration);return 2===this.dots?e=ix.applyDot(e,!0):1===this.dots&&(e=ix.applyDot(e,!1)),this.tupletDenominator>0&&this.tupletNumerator>=0&&(e=ix.applyTuplet(e,this.tupletNumerator,this.tupletDenominator)),e}updateDurations(){let e=this.calculateDuration();switch(this.playbackDuration=e,this.graceType){case ti.BeforeBeat:case ti.OnBeat:switch(this.duration){case tt.Sixteenth:this.playbackDuration=ix.toTicks(tt.SixtyFourth);break;case tt.ThirtySecond:this.playbackDuration=ix.toTicks(tt.OneHundredTwentyEighth);break;default:this.playbackDuration=ix.toTicks(tt.ThirtySecond)}this.displayDuration=0;break;case ti.BendGrace:this.playbackDuration/=2,this.displayDuration=0;break;default:this.displayDuration=e;let t=this.previousBeat;t&&t.graceType===ti.BendGrace&&(this.playbackDuration=t.playbackDuration)}}finishTuplet(){let e=this.previousBeat,t=e?e.tupletGroup:null;if((this.hasTuplet||this.graceType!==ti.None&&t)&&(e&&t&&t.check(this)||(t=new iq(this.voice)).check(this),this.tupletGroup=t),this.index>0){let e=this.voice.bar.masterBar.calculateDuration(),t=[];for(let i of this.automations)0===i.ratioPosition&&(i.ratioPosition=this.playbackStart/e),i.type!==e6.Volume&&t.push(i);this.automations=t}}finish(e,t=null){switch(null===this.getAutomation(e6.Instrument)&&0===this.index&&0===this.voice.index&&0===this.voice.bar.index&&0===this.voice.bar.staff.index&&this.automations.push(iv.buildInstrumentAutomation(!1,0,this.voice.bar.staff.track.playbackInfo.program)),this.graceType){case ti.OnBeat:case ti.BeforeBeat:let i=this.graceGroup.beats.length;1===i?this.duration=tt.Eighth:2===i?this.duration=tt.Sixteenth:this.duration=tt.ThirtySecond}let s=e?e.notation.notationMode:tu.GuitarPro,a="grad"===this.text||"grad."===this.text;a&&s===tu.SongBook&&(this.text="");let r=!1;this.minNote=null,this.maxNote=null,this.minStringNote=null,this.maxStringNote=null;let n=0,o=!1;for(let i=0,l=this.notes.length;i<l;i++){let l=this.notes[i];if(l.dynamics=this.dynamics,l.finish(e,t),l.isLetRing&&(this.isLetRing=!0),l.isPalmMute&&(this.isPalmMute=!0),s===tu.SongBook&&l.hasBend&&this.graceType!==ti.BendGrace){if(!l.isTieOrigin)switch(l.bendType){case e7.Bend:case e7.PrebendRelease:case e7.PrebendBend:r=!0}a||l.bendStyle===e8.Gradual?(a=!0,l.bendStyle=e8.Gradual,r=!1):l.bendStyle=e8.Fast}l.isVisible&&(n++,(!this.minNote||l.realValue<this.minNote.realValue)&&(this.minNote=l),(!this.maxNote||l.realValue>this.maxNote.realValue)&&(this.maxNote=l),(!this.minStringNote||l.string<this.minStringNote.string)&&(this.minStringNote=l),(!this.maxStringNote||l.string>this.maxStringNote.string)&&(this.maxStringNote=l),l.hasEffectSlur&&(o=!0))}if(o&&(this.effectSlurOrigin?(this.effectSlurOrigin.effectSlurDestination=this.nextBeat,this.effectSlurOrigin.effectSlurDestination&&(this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin),this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=this.nextBeat,this.effectSlurDestination&&(this.effectSlurDestination.effectSlurOrigin=this))),this.notes.length>0&&0===n&&(this.isEmpty=!0),this.isRest||this.isLetRing&&this.isPalmMute)this.isRest&&this.previousBeat&&e&&e.notation.notationMode===tu.GuitarPro&&(this.previousBeat.isLetRing&&(this.isLetRing=!0),this.previousBeat.isPalmMute&&(this.isPalmMute=!0));else{let e=this.previousBeat;for(;e&&e.isRest;)this.isLetRing||(e.isLetRing=!1),this.isPalmMute||(e.isPalmMute=!1),e=e.previousBeat}let l=this.whammyBarPoints,h=null!==l&&l.length>0;if(h){let e=!!this.previousBeat&&this.previousBeat.hasWhammyBar;this.isContinuedWhammy=e}else this.whammyBarType=tB.None;if(h&&this.whammyBarType===tB.Custom&&(s===tu.SongBook&&(this.whammyStyle=a?e8.Gradual:e8.Fast),4===l.length)){let e=l[0],t=l[1],i=l[2],a=l[3];t.value===i.value&&(e.value<t.value&&t.value<a.value||e.value>t.value&&t.value>a.value?(0===e.value||this.isContinuedWhammy?this.whammyBarType=tB.Dive:this.whammyBarType=tB.PrediveDive,l.splice(2,1),l.splice(1,1)):e.value>t.value&&t.value<a.value||e.value<t.value&&t.value>a.value?(this.whammyBarType=tB.Dip,(t.offset===i.offset||s===tu.SongBook)&&l.splice(2,1)):e.value===t.value&&t.value===a.value&&(0===e.value||this.isContinuedWhammy?this.whammyBarType=tB.Hold:this.whammyBarType=tB.Predive,l.splice(2,1),l.splice(1,1)))}if(this.updateDurations(),r){let e=iZ.clone(this);e.id=i1._globalBeatId++,e.pickStroke=ty.None;for(let t=0,i=e.notes.length;t<i;t++){let i=e.notes[t],s=this.notes[t];if(i.bendType=e7.None,i.maxBendPoint=null,i.bendPoints=null,i.bendStyle=e8.Default,i.id=iY.GlobalNoteId++,s.isTieOrigin&&(i.tieDestination=s.tieDestination,s.tieDestination.tieOrigin=i),s.isTieDestination&&(i.tieOrigin=s.tieOrigin?s.tieOrigin:null,s.tieOrigin.tieDestination=i),s.hasBend&&s.isTieOrigin){let e=iY.findTieOrigin(s);if(e&&e.hasBend){i.bendType=e7.Hold;let e=s.bendPoints[s.bendPoints.length-1];i.addBendPoint(new iF(0,e.value)),i.addBendPoint(new iF(iF.MaxPosition,e.value))}}i.isTieDestination=!0}this.graceType=ti.BendGrace,this.graceGroup=new iA,this.graceGroup.addBeat(this),this.graceGroup.isComplete=!0,this.graceGroup.finish(),this.updateDurations(),this.voice.insertBeat(this,e),e.graceGroup=new iA,e.graceGroup.addBeat(this),e.graceGroup.isComplete=!0,e.graceGroup.finish()}}isBefore(e){return this.voice.bar.index<e.voice.bar.index||e.voice.bar.index===this.voice.bar.index&&this.index<e.index}isAfter(e){return this.voice.bar.index>e.voice.bar.index||e.voice.bar.index===this.voice.bar.index&&this.index>e.index}hasNoteOnString(e){return this.noteStringLookup.has(e)}getNoteWithRealValue(e){return this.noteValueLookup.has(e)?this.noteValueLookup.get(e):null}chain(e=null){for(let t of this.notes)this.noteValueLookup.set(t.realValue,t),t.chain(e)}}i1._globalBeatId=0,(K=tD||(tD={}))[K.Title=0]="Title",K[K.SubTitle=1]="SubTitle",K[K.Artist=2]="Artist",K[K.Album=3]="Album",K[K.Words=4]="Words",K[K.Music=5]="Music",K[K.WordsAndMusic=6]="WordsAndMusic",K[K.Transcriber=7]="Transcriber",K[K.Copyright=8]="Copyright",K[K.CopyrightSecondLine=9]="CopyrightSecondLine",K[K.ChordDiagramList=10]="ChordDiagramList";class i2{constructor(e="",t,i=tS.Left){this.template=e,this.isVisible=t,this.textAlign=i}buildText(e){let t=!1,i=!1,s=this.template.replace(i2.PlaceholderPattern,(s,a)=>{i=!0;let r="";switch(a){case"TITLE":r=e.title;break;case"SUBTITLE":r=e.subTitle;break;case"ARTIST":r=e.artist;break;case"ALBUM":r=e.album;break;case"WORDS":case"WORDSMUSIC":r=e.words;break;case"MUSIC":r=e.music;break;case"TABBER":r=e.tab;break;case"COPYRIGHT":r=e.copyright;break;default:r=""}return r&&(t=!0),r});return i&&!t?"":s}}i2.PlaceholderPattern=/%([^%]+)%/g;class i5 extends ik{constructor(){super(...arguments),this.headerAndFooter=new Map}}i5.defaultHeaderAndFooter=new Map([[tD.Title,new i2("%TITLE%",void 0,tS.Center)],[tD.SubTitle,new i2("%SUBTITLE%",void 0,tS.Center)],[tD.Artist,new i2("%ARTIST%",void 0,tS.Center)],[tD.Album,new i2("%ALBUM%",void 0,tS.Center)],[tD.Words,new i2("Words by %WORDS%",void 0,tS.Left)],[tD.Music,new i2("Music by %MUSIC%",void 0,tS.Right)],[tD.WordsAndMusic,new i2("Words & Music by %MUSIC%",void 0,tS.Right)],[tD.Transcriber,new i2("Tabbed by %TABBER%",!1,tS.Right)],[tD.Copyright,new i2("%COPYRIGHT%",void 0,tS.Center)],[tD.CopyrightSecondLine,new i2("All Rights Reserved - International Copyright Secured",!0,tS.Center)]]);class i3{constructor(){this._currentRepeatGroup=null,this._openedRepeatGroups=[],this._properlyOpenedRepeatGroups=0,this.album="",this.artist="",this.copyright="",this.instructions="",this.music="",this.notices="",this.subTitle="",this.title="",this.words="",this.tab="",this.tempo=120,this.tempoLabel="",this.masterBars=[],this.tracks=[],this.defaultSystemsLayout=3,this.systemsLayout=[],this.stylesheet=new i_}static resetIds(){iN.resetIds(),i1.resetIds(),iO.resetIds(),iY.resetIds()}rebuildRepeatGroups(){for(let e of(this._currentRepeatGroup=null,this._openedRepeatGroups=[],this._properlyOpenedRepeatGroups=0,this.masterBars))this.addMasterBarToRepeatGroups(e)}addMasterBar(e){e.score=this,e.index=this.masterBars.length,0!==this.masterBars.length&&(e.previousMasterBar=this.masterBars[this.masterBars.length-1],e.previousMasterBar.nextMasterBar=e,e.start=e.previousMasterBar.start+(e.previousMasterBar.isAnacrusis?0:e.previousMasterBar.calculateDuration())),this.addMasterBarToRepeatGroups(e),this.masterBars.push(e)}addMasterBarToRepeatGroups(e){e.isRepeatStart?(this._currentRepeatGroup?.isClosed&&(this._openedRepeatGroups.pop(),this._properlyOpenedRepeatGroups--),this._currentRepeatGroup=new iw,this._openedRepeatGroups.push(this._currentRepeatGroup),this._properlyOpenedRepeatGroups++):this._currentRepeatGroup||(this._currentRepeatGroup=new iw,this._openedRepeatGroups.push(this._currentRepeatGroup)),this._currentRepeatGroup.addMasterBar(e),e.isRepeatEnd&&this._properlyOpenedRepeatGroups>1&&(this._openedRepeatGroups.pop(),this._properlyOpenedRepeatGroups--,this._currentRepeatGroup=this._openedRepeatGroups.length>0?this._openedRepeatGroups[this._openedRepeatGroups.length-1]:null)}addTrack(e){e.score=this,e.index=this.tracks.length,this.tracks.push(e)}finish(e){let t=new Map;for(let i=0,s=this.tracks.length;i<s;i++)this.tracks[i].finish(e,t)}applyFlatSyncPoints(e){for(let e of this.masterBars)e.syncPoints=void 0;for(let t of e){let e=new iv;e.ratioPosition=Math.min(1,Math.max(0,t.barPosition)),e.type=e6.SyncPoint,e.syncPointValue=new iP,e.syncPointValue.millisecondOffset=t.millisecondOffset,e.syncPointValue.barOccurence=t.barOccurence,t.barIndex<this.masterBars.length&&this.masterBars[t.barIndex].addSyncPoint(e)}for(let e of this.masterBars)e.syncPoints&&e.syncPoints.sort((e,t)=>{let i=e.syncPointValue.barOccurence-t.syncPointValue.barOccurence;return 0!==i?i:e.ratioPosition-t.ratioPosition})}exportFlatSyncPoints(){let e=[];for(let t of this.masterBars){let i=t.syncPoints;if(i)for(let s of i)e.push({barIndex:t.index,barOccurence:s.syncPointValue.barOccurence,barPosition:s.ratioPosition,millisecondOffset:s.syncPointValue.millisecondOffset})}return e}}class i4{init(e,t){this.data=e,this.settings=t,i3.resetIds()}}(Q=tE||(tE={}))[Q.General=0]="General",Q[Q.Format=1]="Format",Q[Q.AlphaTex=2]="AlphaTex";class i6 extends Error{constructor(e,t="",i){super(t??"",{cause:i}),this.type=e,Object.setPrototypeOf(this,i6.prototype)}}class i8 extends i6{constructor(e=null,t){super(tE.Format,e??"Unsupported format",t),Object.setPrototypeOf(this,i8.prototype)}}class i7{constructor(){this.name="",this.firstFret=1,this.strings=[],this.barreFrets=[],this.showName=!0,this.showDiagram=!0,this.showFingering=!0}get uniqueId(){return[this.name,this.firstFret.toString(),this.strings.join(","),this.barreFrets.join(","),this.showDiagram.toString(),this.showFingering.toString(),this.showName.toString()].join("|")}}(Z=tM||(tM={}))[Z.IgnoreSpaces=0]="IgnoreSpaces",Z[Z.Begin=1]="Begin",Z[Z.Text=2]="Text",Z[Z.Comment=3]="Comment",Z[Z.Dash=4]="Dash";class i9{constructor(){this.startBar=0,this.text=""}finish(e=!1){this.chunks=[],this.parse(this.text,0,this.chunks,e)}parse(e,t,i,s){if(!e)return;let a=tM.Begin,r=tM.Begin,n=!1,o=0;for(;t<e.length;){let i=e.charCodeAt(t);switch(a){case tM.IgnoreSpaces:switch(i){case i9.CharCodeLF:case i9.CharCodeCR:case i9.CharCodeTab:break;case i9.CharCodeSpace:if(!n){a=r;continue}break;default:n=!1,a=r;continue}break;case tM.Begin:if(i===i9.CharCodeBrackedOpen)a=tM.Comment;else{o=t,a=tM.Text;continue}break;case tM.Comment:i===i9.CharCodeBrackedClose&&(a=tM.Begin);break;case tM.Text:switch(i){case i9.CharCodeDash:a=tM.Dash;break;case i9.CharCodeCR:case i9.CharCodeLF:case i9.CharCodeSpace:let l=e.substr(o,t-o);this.addChunk(l,s),a=tM.IgnoreSpaces,r=tM.Begin}break;case tM.Dash:if(i===i9.CharCodeDash);else{let i=e.substr(o,t-o);this.addChunk(i,s),n=!0,a=tM.IgnoreSpaces,r=tM.Begin;continue}}t+=1}a===tM.Text&&t!==o&&this.addChunk(e.substr(o,t-o),s)}addChunk(e,t){e=this.prepareChunk(e),(!t||e.length>0&&"-"!==e)&&this.chunks.push(e)}prepareChunk(e){let t=e.split("+").join(" "),i=t.length;for(;i>0&&"_"===t.charAt(i-1);)i--;return i!==t.length?t.substr(0,i):t}}i9.CharCodeLF=10,i9.CharCodeTab=9,i9.CharCodeCR=13,i9.CharCodeSpace=32,i9.CharCodeBrackedClose=93,i9.CharCodeBrackedOpen=91,i9.CharCodeDash=45;class se{constructor(){this.marker="",this.text=""}}class st extends i6{constructor(e){super(tE.Format,e),Object.setPrototypeOf(this,st.prototype)}}class si{constructor(e,t,i,s=255){this.raw=0,this.raw=(255&s)<<24|(255&e)<<16|(255&t)<<8|255&i,this.updateRgba()}updateRgba(){255===this.a?this.rgba=`#${iW.toHexString(this.r,2)}${iW.toHexString(this.g,2)}${iW.toHexString(this.b,2)}`:this.rgba=`rgba(${this.r},${this.g},${this.b},${this.a/255})`}get a(){return this.raw>>24&255}get r(){return this.raw>>16&255}get g(){return this.raw>>8&255}get b(){return 255&this.raw}static random(e=100){return new si(255*Math.random()|0,255*Math.random()|0,255*Math.random()|0,e)}static fromJson(e){if(e instanceof si)return e;switch(typeof e){case"number":{let t=new si(0,0,0,0);return t.raw=e,t.updateRgba(),t}case"string":if(e.startsWith("#")){if(4===e.length)return new si(17*Number.parseInt(e[1],16),17*Number.parseInt(e[2],16),17*Number.parseInt(e[3],16));if(5===e.length)return new si(17*Number.parseInt(e[1],16),17*Number.parseInt(e[2],16),17*Number.parseInt(e[3],16),17*Number.parseInt(e[4],16));if(7===e.length)return new si(Number.parseInt(e.substring(1,3),16),Number.parseInt(e.substring(3,5),16),Number.parseInt(e.substring(5,7),16));if(9===e.length)return new si(Number.parseInt(e.substring(1,3),16),Number.parseInt(e.substring(3,5),16),Number.parseInt(e.substring(5,7),16),Number.parseInt(e.substring(7,9),16))}else if(e.startsWith("rgba")||e.startsWith("rgb")){let t=e.indexOf("("),i=e.lastIndexOf(")");if(-1===t||-1===i)throw new st("No values specified for rgb/rgba function");let s=e.substring(t+1,i).split(",");if(3===s.length)return new si(Number.parseInt(s[0]),Number.parseInt(s[1]),Number.parseInt(s[2]));if(4===s.length)return new si(Number.parseInt(s[0]),Number.parseInt(s[1]),Number.parseInt(s[2]),255*Number.parseFloat(s[3]))}return null}throw new st("Unsupported format for color")}static toJson(e){return null===e?null:e.raw}}si.BlackRgb="#000000";class ss{constructor(){this.volume=15,this.balance=8,this.port=1,this.program=0,this.primaryChannel=0,this.secondaryChannel=0,this.isMute=!1,this.isSolo=!1}}class sa{static getTextForTuning(e,t){let i=sa.getTextPartsForTuning(e);return t?i.join(""):i[0]}static getTextPartsForTuning(e,t=-1){return[["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"][e%12],((e/12|0)+t).toString()]}static getDefaultTuningFor(e){return sa._defaultTunings.has(e)?sa._defaultTunings.get(e):null}static getPresetsFor(e){switch(e){case 7:return sa._sevenStrings;case 6:return sa._sixStrings;case 5:return sa._fiveStrings;case 4:return sa._fourStrings}return[]}static initialize(){sa._defaultTunings.set(7,new sa("Guitar 7 strings",[64,59,55,50,45,40,35],!0)),sa._sevenStrings.push(sa._defaultTunings.get(7)),sa._defaultTunings.set(6,new sa("Guitar Standard Tuning",[64,59,55,50,45,40],!0)),sa._sixStrings.push(sa._defaultTunings.get(6)),sa._sixStrings.push(new sa("Guitar Tune down  step",[63,58,54,49,44,39],!1)),sa._sixStrings.push(new sa("Guitar Tune down 1 step",[62,57,53,48,43,38],!1)),sa._sixStrings.push(new sa("Guitar Tune down 2 step",[60,55,51,46,41,36],!1)),sa._sixStrings.push(new sa("Guitar Dropped D Tuning",[64,59,55,50,45,38],!1)),sa._sixStrings.push(new sa("Guitar Dropped D Tuning variant",[64,57,55,50,45,38],!1)),sa._sixStrings.push(new sa("Guitar Double Dropped D Tuning",[62,59,55,50,45,38],!1)),sa._sixStrings.push(new sa("Guitar Dropped E Tuning",[66,61,57,52,47,40],!1)),sa._sixStrings.push(new sa("Guitar Dropped C Tuning",[62,57,53,48,43,36],!1)),sa._sixStrings.push(new sa("Guitar Open C Tuning",[64,60,55,48,43,36],!1)),sa._sixStrings.push(new sa("Guitar Open Cm Tuning",[63,60,55,48,43,36],!1)),sa._sixStrings.push(new sa("Guitar Open C6 Tuning",[64,57,55,48,43,36],!1)),sa._sixStrings.push(new sa("Guitar Open Cmaj7 Tuning",[64,59,55,52,43,36],!1)),sa._sixStrings.push(new sa("Guitar Open D Tuning",[62,57,54,50,45,38],!1)),sa._sixStrings.push(new sa("Guitar Open Dm Tuning",[62,57,53,50,45,38],!1)),sa._sixStrings.push(new sa("Guitar Open D5 Tuning",[62,57,50,50,45,38],!1)),sa._sixStrings.push(new sa("Guitar Open D6 Tuning",[62,59,54,50,45,38],!1)),sa._sixStrings.push(new sa("Guitar Open Dsus4 Tuning",[62,57,55,50,45,38],!1)),sa._sixStrings.push(new sa("Guitar Open E Tuning",[64,59,56,52,47,40],!1)),sa._sixStrings.push(new sa("Guitar Open Em Tuning",[64,59,55,52,47,40],!1)),sa._sixStrings.push(new sa("Guitar Open Esus11 Tuning",[64,59,55,52,45,40],!1)),sa._sixStrings.push(new sa("Guitar Open F Tuning",[65,60,53,48,45,41],!1)),sa._sixStrings.push(new sa("Guitar Open G Tuning",[62,59,55,50,43,38],!1)),sa._sixStrings.push(new sa("Guitar Open Gm Tuning",[62,58,55,50,43,38],!1)),sa._sixStrings.push(new sa("Guitar Open G6 Tuning",[64,59,55,50,43,38],!1)),sa._sixStrings.push(new sa("Guitar Open Gsus4 Tuning",[62,60,55,50,43,38],!1)),sa._sixStrings.push(new sa("Guitar Open A Tuning",[64,61,57,52,45,40],!1)),sa._sixStrings.push(new sa("Guitar Open Am Tuning",[64,60,57,52,45,40],!1)),sa._sixStrings.push(new sa("Guitar Nashville Tuning",[64,59,67,62,57,52],!1)),sa._sixStrings.push(new sa("Bass 6 Strings Tuning",[48,43,38,33,28,23],!1)),sa._sixStrings.push(new sa("Lute or Vihuela Tuning",[64,59,54,50,45,40],!1)),sa._defaultTunings.set(5,new sa("Bass 5 Strings Tuning",[43,38,33,28,23],!0)),sa._fiveStrings.push(sa._defaultTunings.get(5)),sa._fiveStrings.push(new sa("Banjo Dropped C Tuning",[62,59,55,48,67],!1)),sa._fiveStrings.push(new sa("Banjo Open D Tuning",[62,57,54,50,69],!1)),sa._fiveStrings.push(new sa("Banjo Open G Tuning",[62,59,55,50,67],!1)),sa._fiveStrings.push(new sa("Banjo G Minor Tuning",[62,58,55,50,67],!1)),sa._fiveStrings.push(new sa("Banjo G Modal Tuning",[62,57,55,50,67],!1)),sa._defaultTunings.set(4,new sa("Bass Standard Tuning",[43,38,33,28],!0)),sa._fourStrings.push(sa._defaultTunings.get(4)),sa._fourStrings.push(new sa("Bass Tune down  step",[42,37,32,27],!1)),sa._fourStrings.push(new sa("Bass Tune down 1 step",[41,36,31,26],!1)),sa._fourStrings.push(new sa("Bass Tune down 2 step",[39,34,29,24],!1)),sa._fourStrings.push(new sa("Bass Dropped D Tuning",[43,38,33,26],!1)),sa._fourStrings.push(new sa("Ukulele C Tuning",[45,40,36,43],!1)),sa._fourStrings.push(new sa("Ukulele G Tuning",[52,47,43,38],!1)),sa._fourStrings.push(new sa("Mandolin Standard Tuning",[64,57,50,43],!1)),sa._fourStrings.push(new sa("Mandolin or Violin Tuning",[76,69,62,55],!1)),sa._fourStrings.push(new sa("Viola Tuning",[69,62,55,48],!1)),sa._fourStrings.push(new sa("Cello Tuning",[57,50,43,36],!1))}static findTuning(e){let t=sa.getPresetsFor(e.length);for(let i=0,s=t.length;i<s;i++){let s=t[i],a=!0;for(let t=0,i=e.length;t<i;t++)if(e[t]!==s.tunings[t]){a=!1;break}if(a)return s}return null}constructor(e="",t=null,i=!1){this.isStandard=i,this.name=e,this.tunings=t??[]}finish(){let e=sa.findTuning(this.tunings);e&&(this.name=e.name,this.isStandard=e.isStandard),this.name=this.name.trim()}}sa._sevenStrings=[],sa._sixStrings=[],sa._fiveStrings=[],sa._fourStrings=[],sa._defaultTunings=new Map,sa.defaultAccidentals=["","#","","#","","","#","","#","","#",""],sa.defaultSteps=["C","C","D","D","E","F","F","G","G","A","A","B"],sa.initialize();class sr{constructor(){this.index=0,this.bars=[],this.chords=null,this.capo=0,this.transpositionPitch=0,this.displayTranspositionPitch=0,this.stringTuning=new sa("",[],!1),this.showSlash=!1,this.showNumbered=!1,this.showTablature=!0,this.showStandardNotation=!0,this.isPercussion=!1,this.standardNotationLineCount=sr.DefaultStandardNotationLineCount}get tuning(){return this.stringTuning.tunings}get tuningName(){return this.stringTuning.name}get isStringed(){return this.stringTuning.tunings.length>0}finish(e,t=null){this.stringTuning.finish();for(let i=0,s=this.bars.length;i<s;i++)this.bars[i].finish(e,t)}addChord(e,t){t.staff=this;let i=this.chords;null===i&&(i=new Map,this.chords=i),i.set(e,t)}hasChord(e){return this.chords?.has(e)??!1}getChord(e){return this.chords?.get(e)??null}addBar(e){let t=this.bars;e.staff=this,e.index=t.length,t.length>0&&(e.previousBar=t[t.length-1],e.previousBar.nextBar=e),t.push(e)}}sr.DefaultStandardNotationLineCount=5,(ee=tL||(tL={}))[ee.TrackName=0]="TrackName",ee[ee.BracesAndBrackets=1]="BracesAndBrackets",ee[ee.SystemSeparator=2]="SystemSeparator",ee[ee.StringTuning=3]="StringTuning";class sn extends ik{}class so{constructor(){this.index=0,this.staves=[],this.playbackInfo=new ss,this.color=new si(200,0,0,255),this.name="",this.isVisibleOnMultiTrack=!0,this.shortName="",this.defaultSystemsLayout=3,this.systemsLayout=[],this.percussionArticulations=[]}addLineBreaks(e){this.lineBreaks||(this.lineBreaks=new Set),this.lineBreaks.add(e)}ensureStaveCount(e){for(;this.staves.length<e;)this.addStaff(new sr)}addStaff(e){e.index=this.staves.length,e.track=this,this.staves.push(e)}finish(e,t=null){!this.shortName&&(this.shortName=this.name,this.shortName.length>so.ShortNameMaxLength&&(this.shortName=this.shortName.substr(0,so.ShortNameMaxLength)));for(let i=0,s=this.staves.length;i<s;i++)this.staves[i].finish(e,t)}applyLyrics(e){for(let t of e)t.finish();let t=this.staves[0];for(let i=0;i<e.length;i++){let s=e[i];if(s.startBar>=0&&s.startBar<t.bars.length){let a=t.bars[s.startBar].voices[0].beats[0];for(let t=0;t<s.chunks.length&&a;t++){for(;a&&(a.isEmpty||a.isRest);)a=a.nextBeat;a&&(a.lyrics||(a.lyrics=Array(e.length),a.lyrics.fill("")),a.lyrics[i]=s.chunks[t],a=a.nextBeat)}}}}}so.ShortNameMaxLength=10;class sl{static float64ToBytes(e){return sl._dataView.setFloat64(0,e,!0),sl._conversionByteArray}static bytesToInt64LE(e){sl._conversionByteArray.set(e,0);let t=sl._dataView.getBigInt64(0,!0);return t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER?Number(t):Number.MAX_SAFE_INTEGER}static bytesToFloat64LE(e){return sl._conversionByteArray.set(e,0),sl._dataView.getFloat64(0,!0)}static bytesToFloat32LE(e){return sl._conversionByteArray.set(e,0),sl._dataView.getFloat32(0,!0)}static float32BEToBytes(e){return sl._dataView.setFloat32(0,e,!1),sl._conversionByteArray.slice(0,4)}static uint16ToInt16(e){return sl._dataView.setUint16(0,e,!0),sl._dataView.getInt16(0,!0)}static int16ToUint32(e){return sl._dataView.setInt16(0,e,!0),sl._dataView.getUint32(0,!0)}static int32ToUint16(e){return sl._dataView.setInt32(0,e,!0),sl._dataView.getUint16(0,!0)}static int32ToInt16(e){return sl._dataView.setInt32(0,e,!0),sl._dataView.getInt16(0,!0)}static int32ToUint32(e){return sl._dataView.setInt32(0,e,!0),sl._dataView.getUint32(0,!0)}static uint8ToInt8(e){return sl._dataView.setUint8(0,e),sl._dataView.getInt8(0)}}sl._conversionBuffer=new ArrayBuffer(8),sl._conversionByteArray=new Uint8Array(sl._conversionBuffer),sl._dataView=new DataView(sl._conversionBuffer);class sh{static readInt32BE(e){return e.readByte()<<24|e.readByte()<<16|e.readByte()<<8|e.readByte()}static readFloat32BE(e){let t=new Uint8Array(4);return e.read(t,0,t.length),t.reverse(),sl.bytesToFloat32LE(t)}static readFloat64BE(e){let t=new Uint8Array(8);return e.read(t,0,t.length),t.reverse(),sl.bytesToFloat64LE(t)}static readInt32LE(e){let t=e.readByte(),i=e.readByte(),s=e.readByte();return e.readByte()<<24|s<<16|i<<8|t}static readInt64LE(e){let t=new Uint8Array(8);return e.read(t,0,t.length),sl.bytesToInt64LE(t)}static readUInt32LE(e){let t=e.readByte(),i=e.readByte(),s=e.readByte();return e.readByte()<<24|s<<16|i<<8|t}static decodeUInt32LE(e,t){let i=e[t],s=e[t+1],a=e[t+2];return e[t+3]<<24|a<<16|s<<8|i}static readUInt16LE(e){let t=e.readByte(),i=e.readByte();return sl.int32ToUint16(i<<8|t)}static readInt16LE(e){let t=e.readByte(),i=e.readByte();return sl.int32ToInt16(i<<8|t)}static readUInt32BE(e){let t=e.readByte(),i=e.readByte(),s=e.readByte(),a=e.readByte();return sl.int32ToUint32(t<<24|i<<16|s<<8|a)}static readUInt16BE(e){let t=e.readByte(),i=e.readByte();return sl.int32ToInt16(t<<8|i)}static readInt16BE(e){let t=e.readByte(),i=e.readByte();return sl.int32ToInt16(t<<8|i)}static readByteArray(e,t){let i=new Uint8Array(t);return e.read(i,0,t),i}static read8BitChars(e,t){let i=new Uint8Array(t);return e.read(i,0,i.length),sh.toString(i,"utf-8")}static read8BitString(e){let t="",i=e.readByte();for(;0!==i;)t+=String.fromCharCode(i),i=e.readByte();return t}static read8BitStringLength(e,t){let i="",s=-1;for(let a=0;a<t;a++){let t=e.readByte();0===t&&-1===s&&(s=a),i+=String.fromCharCode(t)}let a=i;return s>=0?a.substr(0,s):a}static readSInt8(e){let t=e.readByte();return-(((255&t)>>7)*256)+(255&t)}static readInt24(e,t){let i=e[t]|e[t+1]<<8|e[t+2]<<16;return(8388608&i)==8388608&&(i|=-0x1000000),i}static readInt16(e,t){return sl.int32ToInt16(e[t]|e[t+1]<<8)}static toString(e,t){let i=sh.detectEncoding(e);return i&&(t=i),t||(t="utf-8"),new TextDecoder(t).decode(e.buffer)}static detectEncoding(e){return e.length>2&&254===e[0]&&255===e[1]?"utf-16be":e.length>2&&255===e[0]&&254===e[1]?"utf-16le":e.length>4&&0===e[0]&&0===e[1]&&254===e[2]&&255===e[3]?"utf-32be":e.length>4&&255===e[0]&&254===e[1]&&0===e[2]&&0===e[3]?"utf-32le":null}static stringToBytes(e){return new TextEncoder().encode(e)}static writeInt32BE(e,t){e.writeByte(t>>24&255),e.writeByte(t>>16&255),e.writeByte(t>>8&255),e.writeByte(255&t)}static writeInt32LE(e,t){e.writeByte(255&t),e.writeByte(t>>8&255),e.writeByte(t>>16&255),e.writeByte(t>>24&255)}static writeUInt16LE(e,t){e.writeByte(255&t),e.writeByte(t>>8&255)}static writeInt16LE(e,t){e.writeByte(255&t),e.writeByte(t>>8&255)}static writeInt16BE(e,t){e.writeByte(t>>8&255),e.writeByte(255&t)}static writeFloat32BE(e,t){let i=sl.float32BEToBytes(t);e.write(i,0,i.length)}}class sd{constructor(){this.length=0,this.position=0}get bytesWritten(){return this.position}getBuffer(){return this._buffer}static empty(){return sd.withCapacity(0)}static withCapacity(e){let t=new sd;return t._buffer=new Uint8Array(e),t}static fromBuffer(e){let t=new sd;return t._buffer=e,t.length=e.length,t}static fromString(e){let t=sh.stringToBytes(e);return sd.fromBuffer(t)}reset(){this.position=0}skip(e){this.position+=e}readByte(){return this.length-this.position<=0?-1:this._buffer[this.position++]}read(e,t,i){let s=this.length-this.position;return(s>i&&(s=i),s<=0)?0:(e.set(this._buffer.subarray(this.position,this.position+s),t),this.position+=s,s)}writeByte(e){let t=this.position+1;this.ensureCapacity(t),this._buffer[this.position]=255&e,t>this.length&&(this.length=t),this.position=t}write(e,t,i){let s=this.position+i;this.ensureCapacity(s);let a=Math.min(i,e.length-t);this._buffer.set(e.subarray(t,t+a),this.position),s>this.length&&(this.length=s),this.position=s}ensureCapacity(e){if(e>this._buffer.length){let t=e;t<256&&(t=256),t<2*this._buffer.length&&(t=2*this._buffer.length);let i=new Uint8Array(t);this.length>0&&i.set(this._buffer.subarray(0,0+this.length),0),this._buffer=i}}readAll(){return this.toArray()}toArray(){let e=new Uint8Array(this.length);return e.set(this._buffer.subarray(0,0+this.length),0),e}copyTo(e){e.write(this._buffer,0,this.length)}}(et=tI||(tI={}))[et.TargetFine=0]="TargetFine",et[et.TargetSegno=1]="TargetSegno",et[et.TargetSegnoSegno=2]="TargetSegnoSegno",et[et.TargetCoda=3]="TargetCoda",et[et.TargetDoubleCoda=4]="TargetDoubleCoda",et[et.JumpDaCapo=5]="JumpDaCapo",et[et.JumpDaCapoAlCoda=6]="JumpDaCapoAlCoda",et[et.JumpDaCapoAlDoubleCoda=7]="JumpDaCapoAlDoubleCoda",et[et.JumpDaCapoAlFine=8]="JumpDaCapoAlFine",et[et.JumpDalSegno=9]="JumpDalSegno",et[et.JumpDalSegnoAlCoda=10]="JumpDalSegnoAlCoda",et[et.JumpDalSegnoAlDoubleCoda=11]="JumpDalSegnoAlDoubleCoda",et[et.JumpDalSegnoAlFine=12]="JumpDalSegnoAlFine",et[et.JumpDalSegnoSegno=13]="JumpDalSegnoSegno",et[et.JumpDalSegnoSegnoAlCoda=14]="JumpDalSegnoSegnoAlCoda",et[et.JumpDalSegnoSegnoAlDoubleCoda=15]="JumpDalSegnoSegnoAlDoubleCoda",et[et.JumpDalSegnoSegnoAlFine=16]="JumpDalSegnoSegnoAlFine",et[et.JumpDaCoda=17]="JumpDaCoda",et[et.JumpDaDoubleCoda=18]="JumpDaDoubleCoda",(ei=tA||(tA={}))[ei.Short=0]="Short",ei[ei.Medium=1]="Medium",ei[ei.Long=2]="Long";class sc{constructor(){this.type=tA.Short,this.length=0}}(es=tR||(tR={}))[es.Up=0]="Up",es[es.Down=1]="Down",(ea=tO||(tO={}))[ea.No=0]="No",ea[ea.Eof=1]="Eof",ea[ea.Number=2]="Number",ea[ea.DoubleDot=3]="DoubleDot",ea[ea.Dot=4]="Dot",ea[ea.String=5]="String",ea[ea.Tuning=6]="Tuning",ea[ea.LParensis=7]="LParensis",ea[ea.RParensis=8]="RParensis",ea[ea.LBrace=9]="LBrace",ea[ea.RBrace=10]="RBrace",ea[ea.Pipe=11]="Pipe",ea[ea.MetaCommand=12]="MetaCommand",ea[ea.Multiply=13]="Multiply",ea[ea.LowerThan=14]="LowerThan",(er=tH||(tH={}))[er.KnownStaffMeta=0]="KnownStaffMeta",er[er.UnknownStaffMeta=1]="UnknownStaffMeta",er[er.EndOfMetaDetected=2]="EndOfMetaDetected";class su extends i6{constructor(e,t,i,s,a,r,n,o=null){super(tE.AlphaTex,e),this.position=t,this.line=i,this.col=s,this.nonTerm=a??"",this.expected=r??tO.No,this.symbol=n??tO.No,this.symbolData=o,Object.setPrototypeOf(this,su.prototype)}static symbolError(e,t,i,s,a,r,n=null){let o=`MalFormed AlphaTex: @${e} (line ${t}, col ${i}): Error on block ${s}`;return a!==r?(o+=`, expected a ${tO[a]} found a ${tO[r]}`,null!==n&&(o+=`: '${n}'`)):o+=`, invalid value: '${n}'`,new su(o,e,t,i,s,a,r,n)}static errorMessage(e,t,i,s){return new su(e=`MalFormed AlphaTex: @${t} (line ${i}, col ${s}): ${e}`,t,i,s,null,null,null,null)}}(en=tV||(tV={}))[en.Auto=0]="Auto",en[en.Explicit=1]="Explicit";class sp extends i4{constructor(){super(...arguments),this._trackChannel=0,this._barIndex=0,this._voiceIndex=0,this._input="",this._ch=sp.Eof,this._curChPos=0,this._line=1,this._col=0,this._lastValidSpot=[0,1,0],this._sy=tO.No,this._syData="",this._allowNegatives=!1,this._allowFloat=!1,this._allowTuning=!1,this._currentDuration=tt.QuadrupleWhole,this._currentDynamics=e4.PPP,this._currentTuplet=0,this._staffHasExplicitDisplayTransposition=!1,this._staffHasExplicitTuning=!1,this._staffTuningApplied=!1,this._percussionArticulationNames=new Map,this._sustainPedalToBeat=new Map,this._slurs=new Map,this._articulationValueToIndex=new Map,this._accidentalMode=tV.Explicit,this._syncPoints=[],this.logErrors=!1}get name(){return"AlphaTex"}initFromString(e,t){this.data=sd.empty(),this._input=e,this.settings=t,i3.resetIds()}readScore(){try{if(this.data.length>0&&(this._input=sh.toString(this.data.readAll(),this.settings.importer.encoding)),this._allowTuning=!0,this._lyrics=new Map,this._sustainPedalToBeat=new Map,this.createDefaultScore(),this._curChPos=0,this._line=1,this._col=0,this.saveValidSpot(),this._currentDuration=tt.Quarter,this._currentDynamics=e4.F,this._currentTuplet=1,this._ch=this.nextChar(),this._sy=this.newSy(),this._sy===tO.LowerThan)throw new i8("Unknown start sign '<' (meant to import as XML?)");if(this._sy!==tO.Eof){let e=this.metaData(),t=this.bars();if(!e&&!t)throw new i8("No alphaTex data found");this._sy===tO.Dot&&(this._sy=this.newSy(),this.syncPoints())}for(let[e,t]of(iW.consolidate(this._score),this._score.finish(this.settings),iW.trimEmptyBarsAtEnd(this._score),this._score.rebuildRepeatGroups(),this._score.applyFlatSyncPoints(this._syncPoints),this._lyrics))this._score.tracks[e].applyLyrics(t);for(let[e,t]of this._sustainPedalToBeat){let i=t.voice.bar.masterBar.calculateDuration();e.ratioPosition=t.playbackStart/i}return this._score}catch(e){if(e instanceof su)throw new i8(e.message,e);throw e}}syncPoints(){for(;this._sy!==tO.Eof;)this.syncPoint()}syncPoint(){(this._sy!==tO.MetaCommand||"sync"!==this._syData)&&this.error("syncPoint",tO.MetaCommand,!0),this._sy=this.newSy(),this._sy!==tO.Number&&this.error("syncPointBarIndex",tO.Number,!0);let e=this._syData;this._sy=this.newSy(),this._sy!==tO.Number&&this.error("syncPointBarOccurence",tO.Number,!0);let t=this._syData;this._sy=this.newSy(),this._sy!==tO.Number&&this.error("syncPointBarMillis",tO.Number,!0);let i=this._syData;this._allowFloat=!0,this._sy=this.newSy(),this._allowFloat=!1;let s=0;this._sy===tO.Number&&(s=this._syData,this._sy=this.newSy()),this._syncPoints.push({barIndex:e,barOccurence:t,barPosition:s,millisecondOffset:i})}error(e,t,i=!0){let s,a=!1;i?((s=this._sy)===tO.String||s===tO.Number||s===tO.MetaCommand)&&(a=!0):s=t;let r=su.symbolError(this._lastValidSpot[0],this._lastValidSpot[1],this._lastValidSpot[2],e,t,s,a?this._syData:null);throw this.logErrors&&iM.error(this.name,r.message),r}errorMessage(e){let t=su.errorMessage(e,this._lastValidSpot[0],this._lastValidSpot[1],this._lastValidSpot[2]);throw this.logErrors&&iM.error(this.name,t.message),t}createDefaultScore(){this._score=new i3,this._score.tempo=120,this._score.tempoLabel="",this.newTrack()}newTrack(){this._currentTrack=new so,this._currentTrack.ensureStaveCount(1),this._currentTrack.playbackInfo.program=25,this._currentTrack.playbackInfo.primaryChannel=this._trackChannel++,this._currentTrack.playbackInfo.secondaryChannel=this._trackChannel++;let e=this._currentTrack.staves[0];e.displayTranspositionPitch=0,e.stringTuning.tunings=sa.getDefaultTuningFor(6).tunings,this._articulationValueToIndex.clear(),this.beginStaff(e),this._score.addTrack(this._currentTrack),this._lyrics.set(this._currentTrack.index,[]),this._currentDynamics=e4.F}parseClefFromString(e){switch(e.toLowerCase()){case"g2":case"treble":default:return eK.G2;case"f4":case"bass":return eK.F4;case"c3":case"tenor":return eK.C3;case"c4":case"alto":return eK.C4;case"n":case"neutral":return eK.Neutral}}parseClefFromInt(e){switch(e){case 43:default:return eK.G2;case 65:return eK.F4;case 48:return eK.C3;case 60:return eK.C4}}parseTripletFeelFromString(e){switch(e.toLowerCase()){case"no":case"none":default:return tg.NoTripletFeel;case"t16":case"triplet-16th":return tg.Triplet16th;case"t8":case"triplet-8th":return tg.Triplet8th;case"d16":case"dotted-16th":return tg.Dotted16th;case"d8":case"dotted-8th":return tg.Dotted8th;case"s16":case"scottish-16th":return tg.Scottish16th;case"s8":case"scottish-8th":return tg.Scottish8th}}parseTripletFeelFromInt(e){switch(e){case 0:default:return tg.NoTripletFeel;case 1:return tg.Triplet16th;case 2:return tg.Triplet8th;case 3:return tg.Dotted16th;case 4:return tg.Dotted8th;case 5:return tg.Scottish16th;case 6:return tg.Scottish8th}}parseKeySignature(e){switch(e.toLowerCase()){case"cb":case"cbmajor":case"abminor":return e0.Cb;case"gb":case"gbmajor":case"ebminor":return e0.Gb;case"db":case"dbmajor":case"bbminor":return e0.Db;case"ab":case"abmajor":case"fminor":return e0.Ab;case"eb":case"ebmajor":case"cminor":return e0.Eb;case"bb":case"bbmajor":case"gminor":return e0.Bb;case"f":case"fmajor":case"dminor":return e0.F;case"c":case"cmajor":case"aminor":default:return e0.C;case"g":case"gmajor":case"eminor":return e0.G;case"d":case"dmajor":case"bminor":return e0.D;case"a":case"amajor":case"f#minor":return e0.A;case"e":case"emajor":case"c#minor":return e0.E;case"b":case"bmajor":case"g#minor":return e0.B;case"f#":case"f#major":case"d#minor":return e0.FSharp;case"c#":case"c#major":case"a#minor":return e0.CSharp}}parseKeySignatureType(e){return e.toLowerCase().endsWith("minor")?e1.Minor:e1.Major}nextChar(){return this._curChPos<this._input.length?(this._ch=this._input.charCodeAt(this._curChPos++),10===this._ch?(this._line++,this._col=0):this._col++):this._ch=sp.Eof,this._ch}saveValidSpot(){this._lastValidSpot=[this._curChPos,this._line,this._col]}newSy(){for(this.saveValidSpot(),this._sy=tO.No;this._sy===tO.No;)if(this._ch===sp.Eof)this._sy=tO.Eof;else if(sp.isWhiteSpace(this._ch))this._ch=this.nextChar(),this.saveValidSpot();else if(47===this._ch){if(this._ch=this.nextChar(),47===this._ch)for(;13!==this._ch&&10!==this._ch&&this._ch!==sp.Eof;)this._ch=this.nextChar();else if(42===this._ch)for(;this._ch!==sp.Eof;)if(42===this._ch){if(this._ch=this.nextChar(),47===this._ch){this._ch=this.nextChar();break}}else this._ch=this.nextChar();else this.error("comment",tO.String,!1);this.saveValidSpot()}else if(34===this._ch||39===this._ch){let e=this._ch;this._ch=this.nextChar();let t="";for(this._sy=tO.String;this._ch!==e&&this._ch!==sp.Eof;)92===this._ch?(this._ch=this.nextChar(),92===this._ch?t+="\\":this._ch===e?t+=String.fromCharCode(this._ch):82===this._ch||114===this._ch?t+="\r":78===this._ch||110===this._ch?t+="\n":84===this._ch||116===this._ch?t+="	":this.errorMessage("Unsupported escape sequence")):t+=String.fromCharCode(this._ch),this._ch=this.nextChar();this._ch===sp.Eof&&this.errorMessage("String opened but never closed"),this._syData=t,this._ch=this.nextChar()}else if(45===this._ch)this._allowNegatives?this.readNumberOrName():(this._sy=tO.String,this._syData=this.readName());else if(46===this._ch)this._sy=tO.Dot,this._ch=this.nextChar();else if(58===this._ch)this._sy=tO.DoubleDot,this._ch=this.nextChar();else if(40===this._ch)this._sy=tO.LParensis,this._ch=this.nextChar();else if(92===this._ch)this._ch=this.nextChar(),this._sy=tO.MetaCommand,92===this._ch&&(this._ch=this.nextChar()),this._syData=this.readName();else if(41===this._ch)this._sy=tO.RParensis,this._ch=this.nextChar();else if(123===this._ch)this._sy=tO.LBrace,this._ch=this.nextChar();else if(125===this._ch)this._sy=tO.RBrace,this._ch=this.nextChar();else if(124===this._ch)this._sy=tO.Pipe,this._ch=this.nextChar();else if(42===this._ch)this._sy=tO.Multiply,this._ch=this.nextChar();else if(60===this._ch)this._sy=tO.LowerThan,this._ch=this.nextChar();else if(this.isDigit(this._ch))this.readNumberOrName();else if(sp.isNameLetter(this._ch)){let e=this.readName(),t=this._allowTuning?iW.parseTuning(e):null;t?(this._sy=tO.Tuning,this._syData=t):(this._sy=tO.String,this._syData=e)}else this.error("symbol",tO.String,!1);return this._sy}readNumberOrName(){let e="",t=!0;do e+=String.fromCharCode(this._ch),this.isDigit(this._ch)||(t=!1),this._ch=this.nextChar();while(this.isDigit(this._ch)||sp.isNameLetter(this._ch))t?(this._sy=tO.Number,this._syData=this._allowFloat?Number.parseFloat(e):Number.parseInt(e)):(this._sy=tO.String,this._syData=e)}static isNameLetter(e){return!sp.isTerminal(e)&&(33<=e&&e<=47||58<=e&&e<=126||128<=e)}static isTerminal(e){return 46===e||123===e||125===e||91===e||93===e||40===e||41===e||124===e||39===e||34===e||42===e||92===e}static isWhiteSpace(e){return 9===e||10===e||11===e||13===e||32===e}isDigit(e){return e>=48&&e<=57||this._allowNegatives&&45===e||this._allowFloat&&46===e}readName(){let e="";do e+=String.fromCharCode(this._ch),this._ch=this.nextChar();while(sp.isNameLetter(this._ch)||this.isDigit(this._ch))return e}metaData(){let e=!1,t=!1,i=!0;for(;this._sy===tO.MetaCommand&&i;){let s=this._syData.toLowerCase();switch(s){case"title":case"subtitle":case"artist":case"album":case"words":case"music":case"copyright":case"instructions":case"notices":case"tab":this._sy=this.newSy(),this._sy!==tO.String&&this.error(s,tO.String,!0);let a=this._syData;this._sy=this.newSy(),e=!0;let r=tD.ChordDiagramList;switch(s){case"title":this._score.title=a,r=tD.Title;break;case"subtitle":this._score.subTitle=a,r=tD.SubTitle;break;case"artist":this._score.artist=a,r=tD.Artist;break;case"album":this._score.album=a,r=tD.Album;break;case"words":this._score.words=a,r=tD.Words;break;case"music":this._score.music=a,r=tD.Music;break;case"copyright":this._score.copyright=a,r=tD.Copyright;break;case"instructions":this._score.instructions=a;break;case"notices":this._score.notices=a;break;case"tab":this._score.tab=a,r=tD.Transcriber}r!==tD.ChordDiagramList&&this.headerFooterStyle(r);break;case"copyright2":this._sy=this.newSy(),this._sy!==tO.String&&this.error(s,tO.String,!0),this.headerFooterStyle(tD.CopyrightSecondLine),e=!0;break;case"wordsandmusic":this._sy=this.newSy(),this._sy!==tO.String&&this.error(s,tO.String,!0),this.headerFooterStyle(tD.WordsAndMusic),e=!0;break;case"tempo":this._allowFloat=!0,this._sy=this.newSy(),this._allowFloat=!1,this._sy===tO.Number?this._score.tempo=this._syData:this.error("tempo",tO.Number,!0),this._sy=this.newSy(),this._sy===tO.String&&(this._score.tempoLabel=this._syData,this._sy=this.newSy()),e=!0;break;case"defaultsystemslayout":this._sy=this.newSy(),this._sy===tO.Number?(this._score.defaultSystemsLayout=this._syData,this._sy=this.newSy(),e=!0):this.error("default-systems-layout",tO.Number,!0);break;case"systemslayout":for(this._sy=this.newSy(),e=!0;this._sy===tO.Number;)this._score.systemsLayout.push(this._syData),this._sy=this.newSy();break;case"hidedynamics":this._score.stylesheet.hideDynamics=!0,this._sy=this.newSy(),e=!0;break;case"showdynamics":this._score.stylesheet.hideDynamics=!1,this._sy=this.newSy(),e=!0;break;case"bracketextendmode":this._sy=this.newSy(),this._sy!==tO.String&&this.error("bracketExtendMode",tO.String,!0),this._score.stylesheet.bracketExtendMode=this.parseBracketExtendMode(this._syData),this._sy=this.newSy(),e=!0;break;case"usesystemsignseparator":this._score.stylesheet.useSystemSignSeparator=!0,this._sy=this.newSy(),e=!0;break;case"multibarrest":this._score.stylesheet.multiTrackMultiBarRest=!0,this._sy=this.newSy(),e=!0;break;case"singletracktracknamepolicy":this._sy=this.newSy(),this._sy!==tO.String&&this.error("singleTrackTrackNamePolicy",tO.String,!0),this._score.stylesheet.singleTrackTrackNamePolicy=this.parseTrackNamePolicy(this._syData),this._sy=this.newSy(),e=!0;break;case"multitracktracknamepolicy":this._sy=this.newSy(),this._sy!==tO.String&&this.error("multiTrackTrackNamePolicy",tO.String,!0),this._score.stylesheet.multiTrackTrackNamePolicy=this.parseTrackNamePolicy(this._syData),this._sy=this.newSy(),e=!0;break;case"firstsystemtracknamemode":this._sy=this.newSy(),this._sy!==tO.String&&this.error("firstSystemTrackNameMode",tO.String,!0),this._score.stylesheet.firstSystemTrackNameMode=this.parseTrackNameMode(this._syData),this._sy=this.newSy(),e=!0;break;case"othersystemstracknamemode":this._sy=this.newSy(),this._sy!==tO.String&&this.error("otherSystemsTrackNameMode",tO.String,!0),this._score.stylesheet.otherSystemsTrackNameMode=this.parseTrackNameMode(this._syData),this._sy=this.newSy(),e=!0;break;case"firstsystemtracknameorientation":this._sy=this.newSy(),this._sy!==tO.String&&this.error("firstSystemTrackNameOrientation",tO.String,!0),this._score.stylesheet.firstSystemTrackNameOrientation=this.parseTrackNameOrientation(this._syData),this._sy=this.newSy(),e=!0;break;case"othersystemstracknameorientation":this._sy=this.newSy(),this._sy!==tO.String&&this.error("otherSystemsTrackNameOrientation",tO.String,!0),this._score.stylesheet.otherSystemsTrackNameOrientation=this.parseTrackNameOrientation(this._syData),this._sy=this.newSy(),e=!0;break;default:switch(this.handleStaffMeta()){case tH.KnownStaffMeta:t=!0;break;case tH.UnknownStaffMeta:e||t?this.error("metaDataTags",tO.String,!1):i=!1;break;case tH.EndOfMetaDetected:i=!1}}}return e?(this._sy!==tO.Dot&&this.error("song",tO.Dot,!0),this._sy=this.newSy()):this._sy===tO.Dot&&(this._sy=this.newSy(),e=!0),e||t}headerFooterStyle(e){let t=iW.getOrCreateHeaderFooterStyle(this._score,e);if(void 0===t.isVisible&&(t.isVisible=!0),this._sy===tO.String){let e=this._syData;e?t.template=e:t.isVisible=!1,this._sy=this.newSy()}if(this._sy===tO.String){switch(this._syData.toLowerCase()){case"left":t.textAlign=tS.Left;break;case"center":t.textAlign=tS.Center;break;case"right":t.textAlign=tS.Right}this._sy=this.newSy()}}parseTrackNamePolicy(e){switch(e.toLowerCase()){case"hidden":return eq.Hidden;case"allsystems":return eq.AllSystems;default:return eq.FirstSystem}}parseTrackNameMode(e){return"fullname"===e.toLowerCase()?e$.FullName:e$.ShortName}parseTrackNameOrientation(e){return"horizontal"===e.toLowerCase()?ej.Horizontal:ej.Vertical}handleStaffMeta(){switch(this._syData.toLowerCase()){case"capo":return this._sy=this.newSy(),this._sy===tO.Number?this._currentStaff.capo=this._syData:this.error("capo",tO.Number,!0),this._sy=this.newSy(),tH.KnownStaffMeta;case"tuning":this._sy=this.newSy();let e=this._currentStaff.tuning.length;switch(this._staffHasExplicitTuning=!0,this._staffTuningApplied=!1,this._sy){case tO.String:let t=this._syData.toLowerCase();"piano"===t||"none"===t||"voice"===t?this.makeCurrentStaffPitched():this.error("tuning",tO.Tuning,!0),this._sy=this.newSy();break;case tO.Tuning:let i=[];do{let e=this._syData;i.push(e.realValue),this._sy=this.newSy()}while(this._sy===tO.Tuning)this._currentStaff.stringTuning.tunings=i;break;default:this.error("tuning",tO.Tuning,!0)}return this._sy===tO.String&&"hide"===this._syData.toLowerCase()&&(this._score.stylesheet.perTrackDisplayTuning||(this._score.stylesheet.perTrackDisplayTuning=new Map),this._score.stylesheet.perTrackDisplayTuning.set(this._currentTrack.index,!1),this._sy=this.newSy()),e!==this._currentStaff.tuning.length&&(this._currentStaff.chords?.size??0)>0&&this.errorMessage("Tuning must be defined before any chord"),tH.KnownStaffMeta;case"instrument":if(this._sy=this.newSy(),this._staffTuningApplied=!1,this._sy===tO.Number){let e=this._syData;e>=0&&e<=127?this._currentTrack.playbackInfo.program=this._syData:this.error("instrument",tO.Number,!1)}else if(this._sy===tO.String){let e=this._syData.toLowerCase();if("percussion"===e){for(let e of this._currentTrack.staves)this.applyPercussionStaff(e);this._currentTrack.playbackInfo.primaryChannel=iI.PercussionChannel,this._currentTrack.playbackInfo.secondaryChannel=iI.PercussionChannel}else this._currentTrack.playbackInfo.program=iS.getValue(e)}else this.error("instrument",tO.Number,!0);return this._sy=this.newSy(),tH.KnownStaffMeta;case"lyrics":this._sy=this.newSy();let s=new i9;return s.startBar=0,s.text="",this._sy===tO.Number&&(s.startBar=this._syData,this._sy=this.newSy()),this._sy===tO.String?(s.text=this._syData,this._sy=this.newSy()):this.error("lyrics",tO.String,!0),this._lyrics.get(this._currentTrack.index).push(s),tH.KnownStaffMeta;case"chord":this._sy=this.newSy();let a=new i7;this.chordProperties(a),this._sy===tO.String?(a.name=this._syData,this._sy=this.newSy()):this.error("chord-name",tO.String,!0);for(let e=0;e<this._currentStaff.tuning.length;e++)this._sy===tO.Number?a.strings.push(this._syData):this._sy===tO.String&&"x"===this._syData.toLowerCase()&&a.strings.push(-1),this._sy=this.newSy();return this._currentStaff.addChord(this.getChordId(this._currentStaff,a.name),a),tH.KnownStaffMeta;case"articulation":this._sy=this.newSy();let r="";if(this._sy===tO.String?(r=this._syData,this._sy=this.newSy()):this.error("articulation-name",tO.String,!0),"defaults"===r){for(let[e,t]of iU.instrumentArticulationNames)this._percussionArticulationNames.set(e.toLowerCase(),t),this._percussionArticulationNames.set(sp.toArticulationId(e),t);return tH.KnownStaffMeta}let n=0;return this._sy===tO.Number?(n=this._syData,this._sy=this.newSy()):this.error("articulation-number",tO.Number,!0),iU.instrumentArticulations.has(n)||this.errorMessage(`Unknown articulation ${n}. Refer to https://www.alphatab.net/docs/alphatex/percussion for available ids`),this._percussionArticulationNames.set(r.toLowerCase(),n),tH.KnownStaffMeta;case"accidentals":return this.handleAccidentalMode(),tH.KnownStaffMeta;case"displaytranspose":return this._allowNegatives=!0,this._sy=this.newSy(),this._sy===tO.Number?(this._currentStaff.displayTranspositionPitch=-1*this._syData,this._staffHasExplicitDisplayTransposition=!0):this.error("displaytranspose",tO.Number,!0),this._allowNegatives=!1,this._sy=this.newSy(),tH.KnownStaffMeta;case"transpose":return this._allowNegatives=!0,this._sy=this.newSy(),this._sy===tO.Number?this._currentStaff.transpositionPitch=-1*this._syData:this.error("transpose",tO.Number,!0),this._allowNegatives=!1,this._sy=this.newSy(),tH.KnownStaffMeta;case"track":case"staff":return tH.EndOfMetaDetected;case"voice":if(this._sy=this.newSy(),this.handleNewVoice())return tH.EndOfMetaDetected;return tH.KnownStaffMeta;default:return tH.UnknownStaffMeta}}handleAccidentalMode(){switch(this._sy=this.newSy(),this._sy!==tO.String&&this.error("accidental-mode",tO.String,!0),this._syData){case"auto":this._accidentalMode=tV.Auto;break;case"explicit":this._accidentalMode=tV.Explicit}this._sy=this.newSy()}makeCurrentStaffPitched(){this._currentStaff.stringTuning.tunings=[],this._staffHasExplicitDisplayTransposition||(this._currentStaff.displayTranspositionPitch=0)}static toArticulationId(e){return e.replace(/[^a-zA-Z0-9]/g,"").toLowerCase()}applyPercussionStaff(e){e.isPercussion=!0,e.showTablature=!1}chordProperties(e){if(this._sy===tO.LBrace){for(this._sy=this.newSy();this._sy===tO.String;)switch(this._syData.toLowerCase()){case"firstfret":this._sy=this.newSy(),this._sy===tO.Number?e.firstFret=this._syData:this.error("chord-firstfret",tO.Number,!0),this._sy=this.newSy();break;case"showdiagram":switch(this._sy=this.newSy(),this._sy){case tO.String:e.showDiagram="false"!==this._syData.toLowerCase();break;case tO.Number:e.showDiagram=0!==this._syData;break;default:this.error("chord-showdiagram",tO.String,!0)}this._sy=this.newSy();break;case"showfingering":switch(this._sy=this.newSy(),this._sy){case tO.String:e.showDiagram="false"!==this._syData.toLowerCase();break;case tO.Number:e.showFingering=0!==this._syData;break;default:this.error("chord-showfingering",tO.String,!0)}this._sy=this.newSy();break;case"showname":switch(this._sy=this.newSy(),this._sy){case tO.String:e.showName="false"!==this._syData.toLowerCase();break;case tO.Number:e.showName=0!==this._syData;break;default:this.error("chord-showname",tO.String,!0)}this._sy=this.newSy();break;case"barre":for(this._sy=this.newSy();this._sy===tO.Number;)e.barreFrets.push(this._syData),this._sy=this.newSy();break;default:this.error("chord-properties",tO.String,!1)}this._sy!==tO.RBrace&&this.error("chord-properties",tO.RBrace,!0),this._sy=this.newSy()}}bars(){let e=this.bar();for(;this._sy!==tO.Eof;)if(this._sy===tO.Pipe)this._sy=this.newSy(),this.bar();else if(this._sy===tO.MetaCommand)this.bar();else break;return e}trackStaffMeta(){if(this._sy!==tO.MetaCommand)return!1;if("track"===this._syData.toLowerCase()&&(this._staffHasExplicitDisplayTransposition=!1,this._staffHasExplicitTuning=!1,this._staffTuningApplied=!1,this._sy=this.newSy(),this._score.masterBars.length>0&&this.newTrack(),this._sy===tO.String&&(this._currentTrack.name=this._syData,this._sy=this.newSy()),this._sy===tO.String&&(this._currentTrack.shortName=this._syData,this._sy=this.newSy()),this.trackProperties()),this._sy===tO.MetaCommand&&"staff"===this._syData.toLowerCase()){if(this._staffHasExplicitDisplayTransposition=!1,this._staffHasExplicitTuning=!1,this._staffTuningApplied=!1,this._sy=this.newSy(),this._currentTrack.staves[0].bars.length>0){let e=this._currentStaff.isPercussion;this._currentTrack.ensureStaveCount(this._currentTrack.staves.length+1),this.beginStaff(this._currentTrack.staves[this._currentTrack.staves.length-1]),e&&this.applyPercussionStaff(this._currentStaff),this._currentDynamics=e4.F}this.staffProperties()}return this._sy===tO.MetaCommand&&"voice"===this._syData.toLowerCase()&&(this._sy=this.newSy(),this.handleNewVoice()),!0}handleNewVoice(){if(0===this._voiceIndex&&(0===this._currentStaff.bars.length||1===this._currentStaff.bars.length&&this._currentStaff.bars[0].isEmpty))return!1;for(let e of this._currentStaff.bars){let t=new iO;e.addVoice(t)}return this._voiceIndex++,this._barIndex=0,!0}beginStaff(e){this._currentStaff=e,this._slurs.clear(),this._barIndex=0,this._voiceIndex=0}trackProperties(){if(this._sy===tO.LBrace){for(this._sy=this.newSy();this._sy===tO.String;)switch(this._syData.toLowerCase()){case"color":this._sy=this.newSy(),this._sy!==tO.String&&this.error("track-color",tO.String,!0),this._currentTrack.color=si.fromJson(this._syData),this._sy=this.newSy();break;case"defaultsystemslayout":this._sy=this.newSy(),this._sy===tO.Number?(this._currentTrack.defaultSystemsLayout=this._syData,this._sy=this.newSy()):this.error("default-systems-layout",tO.Number,!0);break;case"systemslayout":for(this._sy=this.newSy();this._sy===tO.Number;)this._currentTrack.systemsLayout.push(this._syData),this._sy=this.newSy();break;case"volume":this._sy=this.newSy(),this._sy!==tO.Number&&this.error("track-volume",tO.Number,!0),this._currentTrack.playbackInfo.volume=iW.clamp(this._syData,0,16),this._sy=this.newSy();break;case"balance":this._sy=this.newSy(),this._sy!==tO.Number&&this.error("track-balance",tO.Number,!0),this._currentTrack.playbackInfo.balance=iW.clamp(this._syData,0,16),this._sy=this.newSy();break;case"mute":this._sy=this.newSy(),this._currentTrack.playbackInfo.isMute=!0;break;case"solo":this._sy=this.newSy(),this._currentTrack.playbackInfo.isSolo=!0;break;case"multibarrest":this._sy=this.newSy(),this._score.stylesheet.perTrackMultiBarRest||(this._score.stylesheet.perTrackMultiBarRest=new Set),this._score.stylesheet.perTrackMultiBarRest.add(this._currentTrack.index);break;default:this.error("track-properties",tO.String,!1)}this._sy!==tO.RBrace&&this.error("track-properties",tO.RBrace,!0),this._sy=this.newSy()}}staffProperties(){if(this._sy!==tO.LBrace)return;this._sy=this.newSy();let e=!1,t=!1,i=!1,s=!1;for(;this._sy===tO.String;)switch(this._syData.toLowerCase()){case"score":e=!0,this._sy=this.newSy(),this._sy===tO.Number&&(this._currentStaff.standardNotationLineCount=this._syData,this._sy=this.newSy());break;case"tabs":t=!0,this._sy=this.newSy();break;case"slash":i=!0,this._sy=this.newSy();break;case"numbered":s=!0,this._sy=this.newSy();break;default:this.error("staff-properties",tO.String,!1)}(e||t||i||s)&&(this._currentStaff.showStandardNotation=e,this._currentStaff.showTablature=t,this._currentStaff.showSlash=i,this._currentStaff.showNumbered=s),this._sy!==tO.RBrace&&this.error("staff-properties",tO.RBrace,!0),this._sy=this.newSy()}bar(){let e=this.trackStaffMeta(),t=this.newBar(this._currentStaff);if(this._currentStaff.bars.length>this._score.masterBars.length){let e=new iL;this._score.addMasterBar(e),e.index>0&&(e.timeSignatureDenominator=e.previousMasterBar.timeSignatureDenominator,e.timeSignatureNumerator=e.previousMasterBar.timeSignatureNumerator,e.tripletFeel=e.previousMasterBar.tripletFeel)}let i=this.barMeta(t),s=this._currentTrack.playbackInfo.program;this._staffTuningApplied||this._staffHasExplicitTuning||(this._currentStaff.stringTuning.tunings=[],15===s||s>=24&&s<=31?this._currentStaff.stringTuning.tunings=sa.getDefaultTuningFor(6).tunings:s>=32&&s<=39?this._currentStaff.stringTuning.tunings=[43,38,33,28]:40===s||44===s||45===s||48===s||49===s||50===s||51===s?this._currentStaff.stringTuning.tunings=[52,57,50,43]:41===s?this._currentStaff.stringTuning.tunings=[57,50,43,36]:42===s?this._currentStaff.stringTuning.tunings=[45,38,31,24]:43===s?this._currentStaff.stringTuning.tunings=[43,38,33,28]:105===s?this._currentStaff.stringTuning.tunings=[50,47,43,38,55]:106===s?this._currentStaff.stringTuning.tunings=[57,52,45]:107===s?this._currentStaff.stringTuning.tunings=[52,45,38,31]:110===s&&(this._currentStaff.stringTuning.tunings=[64,57,50,43]),this._staffTuningApplied=!0),this._staffHasExplicitDisplayTransposition||(s>=24&&s<=31||s>=32&&s<=39||43===s?this._currentStaff.displayTranspositionPitch=-12:this._currentStaff.displayTranspositionPitch=0);let a=!1,r=t.voices[this._voiceIndex];if(this._sy!==tO.MetaCommand||"track"!==this._syData.toLowerCase()&&"staff"!==this._syData.toLowerCase())for(;this._sy!==tO.Pipe&&this._sy!==tO.Eof&&this.beat(r);)a=!0;if(0===r.beats.length){let e=new i1;e.isEmpty=!0,r.addBeat(e)}return e||i||a}newBar(e){if(this._barIndex<e.bars.length){let t=e.bars[this._barIndex];return this._barIndex++,t}let t=0===e.bars.length?1:e.bars[0].voices.length,i=new iN;e.addBar(i),i.previousBar&&(i.clef=i.previousBar.clef,i.clefOttava=i.previousBar.clefOttava,i.keySignature=i.previousBar.keySignature,i.keySignatureType=i.previousBar.keySignatureType),this._barIndex++;for(let e=0;e<t;e++){let e=new iO;i.addVoice(e)}return i}beat(e){this.beatDuration();let t=new i1;if(e.addBeat(t),this._allowTuning=!this._currentStaff.isPercussion,this._sy===tO.LParensis){for(this._sy=this.newSy(),this.note(t);this._sy!==tO.RParensis&&this._sy!==tO.Eof&&(this._allowTuning=!this._currentStaff.isPercussion,this.note(t)););this._sy!==tO.RParensis&&this.error("note-list",tO.RParensis,!0),this._sy=this.newSy()}else if(this._sy===tO.String&&"r"===this._syData.toLowerCase())this._sy=this.newSy();else if(!this.note(t))return e.beats.splice(e.beats.length-1,1),!1;this._sy===tO.Dot&&(this._allowNegatives=!0,this._sy=this.newSy(),this._allowNegatives=!1,this._sy!==tO.Number&&this.error("duration",tO.Number,!0),this._currentDuration=this.parseDuration(this._syData),this._sy=this.newSy()),t.duration=this._currentDuration,t.dynamics=this._currentDynamics,1===this._currentTuplet||t.hasTuplet||sp.applyTuplet(t,this._currentTuplet);let i=1;this._sy===tO.Multiply&&(this._sy=this.newSy(),this._sy!==tO.Number?this.error("multiplier",tO.Number,!0):i=this._syData,this._sy=this.newSy()),this.beatEffects(t);for(let s=0;s<i-1;s++)e.addBeat(iZ.clone(t));return!0}beatDuration(){if(this._sy===tO.DoubleDot&&(this._allowNegatives=!0,this._sy=this.newSy(),this._allowNegatives=!1,this._sy!==tO.Number&&this.error("duration",tO.Number,!0),this._currentDuration=this.parseDuration(this._syData),this._currentTuplet=1,this._sy=this.newSy(),this._sy===tO.LBrace)){for(this._sy=this.newSy();this._sy===tO.String;)"tu"===this._syData.toLowerCase()?(this._sy=this.newSy(),this._sy!==tO.Number&&this.error("duration-tuplet",tO.Number,!0),this._currentTuplet=this._syData,this._sy=this.newSy()):this.error("beat-duration",tO.String,!1);this._sy!==tO.RBrace&&this.error("beat-duration",tO.RBrace,!0),this._sy=this.newSy()}}beatEffects(e){if(this._sy===tO.LBrace){for(this._sy=this.newSy();this._sy===tO.String;)this.applyBeatEffect(e)||this.error("beat-effects",tO.String,!1);this._sy!==tO.RBrace&&this.error("beat-effects",tO.RBrace,!0),this._sy=this.newSy()}}applyBeatEffect(e){let t=this._syData.toLowerCase();if("f"===t)e.fade=tN.FadeIn;else if("fo"===t)e.fade=tN.FadeOut;else if("vs"===t)e.fade=tN.VolumeSwell;else if("v"===t)e.vibrato=th.Slight;else if("vw"===t)e.vibrato=th.Wide;else if("s"===t)e.slap=!0;else if("p"===t)e.pop=!0;else if("tt"===t)e.tap=!0;else if("txt"===t){if(this._sy=this.newSy(),this._sy!==tO.String)return this.error("beat-text",tO.String,!0),!1;e.text=this._syData}else if("dd"===t)e.dots=2;else if("d"===t)e.dots=1;else if("su"===t)e.pickStroke=ty.Up;else if("sd"===t)e.pickStroke=ty.Down;else if("tu"===t){if(this._sy=this.newSy(),this._sy!==tO.Number)return this.error("tuplet",tO.Number,!0),!1;let t=this._syData;if(this._sy=this.newSy(),this._sy===tO.Number){let i=this._syData;this._sy=this.newSy(),e.tupletNumerator=t,e.tupletDenominator=i}else sp.applyTuplet(e,t);return!0}else if("tb"===t||"tbe"===t){this._sy=this.newSy();let i="tbe"===t;for(this._sy===tO.String&&(e.whammyBarType=this.parseWhammyType(this._syData),this._sy=this.newSy()),this._sy===tO.String&&(e.whammyStyle=this.parseBendStyle(this._syData),this._sy=this.newSy()),this._sy!==tO.LParensis&&this.error("tremolobar-effect",tO.LParensis,!0),this._allowNegatives=!0,this._allowFloat=!0,this._sy=this.newSy();this._sy!==tO.RParensis&&this._sy!==tO.Eof;){let t=0,s=0;i?(this._sy!==tO.Number&&this.error("tremolobar-effect",tO.Number,!0),t=this._syData,this._sy=this.newSy(),this._sy!==tO.Number&&this.error("tremolobar-effect",tO.Number,!0)):(this._sy!==tO.Number&&this.error("tremolobar-effect",tO.Number,!0),t=0),s=this._syData,e.addWhammyBarPoint(new iF(t,s)),this._sy=this.newSy()}if(null!=e.whammyBarPoints){for(;e.whammyBarPoints.length>60;)e.removeWhammyBarPoint(e.whammyBarPoints.length-1);if(i)e.whammyBarPoints.sort((e,t)=>e.offset-t.offset);else{let t=e.whammyBarPoints.length,i=60/t|0,s=0;for(;s<t;)e.whammyBarPoints[s].offset=Math.min(60,s*i),s++}}this._allowNegatives=!1,this._allowFloat=!1,this._sy!==tO.RParensis&&this.error("tremolobar-effect",tO.RParensis,!0)}else if("bu"===t||"bd"===t||"au"===t||"ad"===t){switch(t){case"bu":e.brushType=e9.BrushUp;break;case"bd":e.brushType=e9.BrushDown;break;case"au":e.brushType=e9.ArpeggioUp;break;case"ad":e.brushType=e9.ArpeggioDown}return(this._sy=this.newSy(),this._sy===tO.Number)?(e.brushDuration=this._syData,this._sy=this.newSy()):(e.updateDurations(),"bu"===t||"bd"===t?e.brushDuration=e.playbackDuration/4/e.notes.length:("au"===t||"ad"===t)&&(e.brushDuration=e.playbackDuration/e.notes.length)),!0}else if("ch"===t){this._sy=this.newSy();let t=this._syData,i=this.getChordId(this._currentStaff,t);if(!this._currentStaff.hasChord(i)){let e=new i7;e.showDiagram=!1,e.name=t,this._currentStaff.addChord(i,e)}e.chordId=i}else if("gr"===t)return this._sy=this.newSy(),"ob"===this._syData.toLowerCase()?(e.graceType=ti.OnBeat,this._sy=this.newSy()):"b"===this._syData.toLowerCase()?(e.graceType=ti.BendGrace,this._sy=this.newSy()):e.graceType=ti.BeforeBeat,!0;else if("dy"===t){this._sy=this.newSy();let t=this._syData.toUpperCase();switch(t){case"PPP":case"PP":case"P":case"MP":case"MF":case"F":case"FF":case"FFF":case"PPPP":case"PPPPP":case"PPPPPP":case"FFFF":case"FFFFF":case"FFFFFF":case"SF":case"SFP":case"SFPP":case"FP":case"RF":case"RFZ":case"SFZ":case"SFFZ":case"FZ":case"N":case"PF":case"SFZP":e.dynamics=e4[t]}this._currentDynamics=e.dynamics}else if("cre"===t)e.crescendo=te.Crescendo;else if("dec"===t)e.crescendo=te.Decrescendo;else if("tempo"===t){let t=this.readTempoAutomation();return e.automations.push(t),e.voice.bar.masterBar.tempoAutomations.push(t),!0}else if("tp"===t){if(this._sy=this.newSy(),e.tremoloSpeed=tt.Eighth,this._sy===tO.Number){switch(this._syData){case 8:default:e.tremoloSpeed=tt.Eighth;break;case 16:e.tremoloSpeed=tt.Sixteenth;break;case 32:e.tremoloSpeed=tt.ThirtySecond}this._sy=this.newSy()}return!0}else if("spd"===t){let t=new iB;return t.pedalType=e2.Down,t.ratioPosition=e.voice.bar.sustainPedals.length,this._sustainPedalToBeat.set(t,e),e.voice.bar.sustainPedals.push(t),this._sy=this.newSy(),!0}else if("spu"===t){let t=new iB;return t.pedalType=e2.Up,t.ratioPosition=e.voice.bar.sustainPedals.length,this._sustainPedalToBeat.set(t,e),e.voice.bar.sustainPedals.push(t),this._sy=this.newSy(),!0}else if("spe"===t){let t=new iB;return t.pedalType=e2.Up,t.ratioPosition=1,e.voice.bar.sustainPedals.push(t),this._sy=this.newSy(),!0}else if("slashed"===t)return e.slashed=!0,this._sy=this.newSy(),!0;else if("ds"===t)return e.deadSlapped=!0,this._sy=this.newSy(),!0;else if("glpf"===t)return this._sy=this.newSy(),e.golpe=tT.Finger,!0;else if("glpt"===t)return this._sy=this.newSy(),e.golpe=tT.Thumb,!0;else if("waho"===t)return this._sy=this.newSy(),e.wahPedal=tx.Open,!0;else if("wahc"===t)return this._sy=this.newSy(),e.wahPedal=tx.Closed,!0;else if("barre"===t){if(this._sy=this.newSy(),this._sy!==tO.Number&&this.error("beat-barre",tO.Number,!0),e.barreFret=this._syData,e.barreShape=tP.Full,this._sy=this.newSy(),this._sy===tO.String)switch(this._syData.toLowerCase()){case"full":e.barreShape=tP.Full,this._sy=this.newSy();break;case"half":e.barreShape=tP.Half,this._sy=this.newSy()}return!0}else if("rasg"===t)switch(this._sy=this.newSy(),this._sy!==tO.String&&this.error("rasgueado",tO.String,!0),this._syData.toLowerCase()){case"ii":e.rasgueado=tv.Ii;break;case"mi":e.rasgueado=tv.Mi;break;case"miitriplet":e.rasgueado=tv.MiiTriplet;break;case"miianapaest":e.rasgueado=tv.MiiAnapaest;break;case"pmptriplet":e.rasgueado=tv.PmpTriplet;break;case"pmpanapaest":e.rasgueado=tv.PmpAnapaest;break;case"peitriplet":e.rasgueado=tv.PeiTriplet;break;case"peianapaest":e.rasgueado=tv.PeiAnapaest;break;case"paitriplet":e.rasgueado=tv.PaiTriplet;break;case"paianapaest":e.rasgueado=tv.PaiAnapaest;break;case"amitriplet":e.rasgueado=tv.AmiTriplet;break;case"amianapaest":e.rasgueado=tv.AmiAnapaest;break;case"ppp":e.rasgueado=tv.Ppp;break;case"amii":e.rasgueado=tv.Amii;break;case"amip":e.rasgueado=tv.Amip;break;case"eami":e.rasgueado=tv.Eami;break;case"eamii":e.rasgueado=tv.Eamii;break;case"peami":e.rasgueado=tv.Peami}else if("ot"===t)this._sy=this.newSy(),this._sy!==tO.String&&this.error("beat-ottava",tO.String,!0),e.ottava=this.parseClefOttavaFromString(this._syData);else if("legatoorigin"===t)e.isLegatoOrigin=!0;else if("instrument"===t){this._sy=this.newSy();let t=0;this._sy===tO.Number?t=this._syData:this._sy===tO.String?t=iS.getValue(this._syData):this.error("instrument-change",tO.Number,!0);let i=new iv;i.isLinear=!1,i.type=e6.Instrument,i.value=t,e.automations.push(i)}else if("fermata"===t){this._sy=this.newSy(),this._sy!==tO.String&&this.error("fermata",tO.Number,!0);let t=new sc;return t.type=this.parseFermataFromString(this._syData),this._allowFloat=!0,this._sy=this.newSy(),this._sy===tO.Number&&(t.length=this._syData,this._sy=this.newSy()),this._allowFloat=!1,e.fermata=t,!0}else if("beam"===t)switch(this._sy=this.newSy(),this._sy!==tO.String&&this.error("beam",tO.Number,!0),this._syData.toLowerCase()){case"invert":e.invertBeamDirection=!0;break;case"up":e.preferredBeamDirection=tR.Up;break;case"down":e.preferredBeamDirection=tR.Down;break;case"auto":e.beamingMode=tF.Auto;break;case"split":e.beamingMode=tF.ForceSplitToNext;break;case"merge":e.beamingMode=tF.ForceMergeWithNext;break;case"splitsecondary":e.beamingMode=tF.ForceSplitOnSecondaryToNext}else if("timer"===t)return e.showTimer=!0,this._sy=this.newSy(),!0;else return!1;return this._sy=this.newSy(),!0}parseBracketExtendMode(e){switch(e.toLowerCase()){case"nobrackets":return eY.NoBrackets;case"groupstaves":default:return eY.GroupStaves;case"groupsimilarinstruments":return eY.GroupSimilarInstruments}}parseFermataFromString(e){switch(e.toLowerCase()){case"short":return tA.Short;case"medium":default:return tA.Medium;case"long":return tA.Long}}parseClefOttavaFromString(e){switch(e.toLowerCase()){case"15ma":return eQ._15ma;case"8va":return eQ._8va;case"regular":default:return eQ.Regular;case"8vb":return eQ._8vb;case"15mb":return eQ._15mb}}getChordId(e,t){return t.toLowerCase()+e.index+e.track.index}static applyTuplet(e,t){switch(t){case 3:e.tupletNumerator=3,e.tupletDenominator=2;break;case 5:e.tupletNumerator=5,e.tupletDenominator=4;break;case 6:e.tupletNumerator=6,e.tupletDenominator=4;break;case 7:e.tupletNumerator=7,e.tupletDenominator=4;break;case 9:e.tupletNumerator=9,e.tupletDenominator=8;break;case 10:e.tupletNumerator=10,e.tupletDenominator=8;break;case 11:e.tupletNumerator=11,e.tupletDenominator=8;break;case 12:e.tupletNumerator=12,e.tupletDenominator=8;break;default:e.tupletNumerator=1,e.tupletDenominator=1}}isNoteText(e){return"x"===e||"-"===e||"r"===e}note(e){let t=!1,i=!1,s=-1,a=-1,r=-1,n=tn.Default;switch(this._sy){case tO.Number:s=this._syData,this._currentStaff.isPercussion&&!iU.instrumentArticulations.has(s)&&this.errorMessage(`Unknown percussion articulation ${s}`);break;case tO.String:if(this._currentStaff.isPercussion){let e=this._syData.toLowerCase();this._percussionArticulationNames.has(e)?s=this._percussionArticulationNames.get(e):this.errorMessage(`Unknown percussion articulation '${this._syData}'`)}else t="x"===this._syData,(i="-"===this._syData)||t?s=0:this.error("note-fret",tO.Number,!0);break;case tO.Tuning:0===e.index&&0===e.voice.index&&0===e.voice.bar.index&&this.makeCurrentStaffPitched();let o=this._syData;a=o.octave,r=o.tone.noteValue,this._accidentalMode===tV.Explicit&&(n=o.tone.accidentalMode);break;default:return!1}this._sy=this.newSy();let l=-1===a&&this._currentStaff.tuning.length>0&&!this._currentStaff.isPercussion,h=-1;l&&(this._sy!==tO.Dot&&this.error("note",tO.Dot,!0),this._sy=this.newSy(),this._sy!==tO.Number&&this.error("note-string",tO.Number,!0),((h=this._syData)<1||h>this._currentStaff.tuning.length)&&this.error("note-string",tO.Number,!1),this._sy=this.newSy());let d=new iY;if(l)d.string=this._currentStaff.tuning.length-(h-1),d.isDead=t,d.isTieDestination=i,i||(d.fret=s);else if(this._currentStaff.isPercussion){let e=s,t=0;if(this._articulationValueToIndex.has(e))t=this._articulationValueToIndex.get(e);else{t=this._currentTrack.percussionArticulations.length;let i=iU.getArticulationByInputMidiNumber(e);null===i&&this.errorMessage(`Unknown articulation value ${e}`),this._currentTrack.percussionArticulations.push(i),this._articulationValueToIndex.set(e,t)}d.percussionArticulation=t}else d.octave=a,d.tone=r,d.accidentalMode=n,d.isTieDestination=i;return e.addNote(d),this.noteEffects(d),!0}noteEffects(e){if(this._sy===tO.LBrace){for(this._sy=this.newSy();this._sy===tO.String;){let t=this._syData.toLowerCase();if("b"===t||"be"===t){this._sy=this.newSy();let i="be"===t;for(this._sy===tO.String&&(e.bendType=this.parseBendType(this._syData),this._sy=this.newSy()),this._sy===tO.String&&(e.bendStyle=this.parseBendStyle(this._syData),this._sy=this.newSy()),this._sy!==tO.LParensis&&this.error("bend-effect",tO.LParensis,!0),this._sy=this.newSy();this._sy!==tO.RParensis&&this._sy!==tO.Eof;){let t=0,s=0;i&&(this._sy!==tO.Number&&this.error("bend-effect-value",tO.Number,!0),t=this._syData,this._sy=this.newSy()),this._sy!==tO.Number&&this.error("bend-effect-value",tO.Number,!0),s=this._syData,e.addBendPoint(new iF(t,s)),this._sy=this.newSy()}let s=e.bendPoints;if(null!=s){for(;s.length>60;)s.splice(s.length-1,1);if(i)s.sort((e,t)=>e.offset-t.offset);else{let e=s.length,t=60/(e-1)|0,i=0;for(;i<e;)s[i].offset=Math.min(60,i*t),i++}}this._sy!==tO.RParensis&&this.error("bend-effect",tO.RParensis,!0),this._sy=this.newSy()}else if("nh"===t)e.harmonicType=tr.Natural,e.harmonicValue=iW.deltaFretToHarmonicValue(e.fret),this._sy=this.newSy();else if("ah"===t)e.harmonicType=tr.Artificial,e.harmonicValue=this.harmonicValue(e.harmonicValue);else if("th"===t)e.harmonicType=tr.Tap,e.harmonicValue=this.harmonicValue(e.harmonicValue);else if("ph"===t)e.harmonicType=tr.Pinch,e.harmonicValue=this.harmonicValue(e.harmonicValue);else if("sh"===t)e.harmonicType=tr.Semi,e.harmonicValue=this.harmonicValue(e.harmonicValue);else if("fh"===t)e.harmonicType=tr.Feedback,e.harmonicValue=this.harmonicValue(e.harmonicValue);else if("tr"===t){this._sy=this.newSy(),this._sy!==tO.Number&&this.error("trill-effect",tO.Number,!0);let t=this._syData;this._sy=this.newSy();let i=tt.Sixteenth;if(this._sy===tO.Number){switch(this._syData){case 16:default:i=tt.Sixteenth;break;case 32:i=tt.ThirtySecond;break;case 64:i=tt.SixtyFourth}this._sy=this.newSy()}e.trillValue=t+e.stringTuning,e.trillSpeed=i}else if("v"===t)this._sy=this.newSy(),e.vibrato=th.Slight;else if("sl"===t)this._sy=this.newSy(),e.slideOutType=tl.Legato;else if("ss"===t)this._sy=this.newSy(),e.slideOutType=tl.Shift;else if("sib"===t)this._sy=this.newSy(),e.slideInType=to.IntoFromBelow;else if("sia"===t)this._sy=this.newSy(),e.slideInType=to.IntoFromAbove;else if("sou"===t)this._sy=this.newSy(),e.slideOutType=tl.OutUp;else if("sod"===t)this._sy=this.newSy(),e.slideOutType=tl.OutDown;else if("psd"===t)this._sy=this.newSy(),e.slideOutType=tl.PickSlideDown;else if("psu"===t)this._sy=this.newSy(),e.slideOutType=tl.PickSlideUp;else if("h"===t)this._sy=this.newSy(),e.isHammerPullOrigin=!0;else if("lht"===t)this._sy=this.newSy(),e.isLeftHandTapped=!0;else if("g"===t)this._sy=this.newSy(),e.isGhost=!0;else if("ac"===t)this._sy=this.newSy(),e.accentuated=ts.Normal;else if("hac"===t)this._sy=this.newSy(),e.accentuated=ts.Heavy;else if("ten"===t)this._sy=this.newSy(),e.accentuated=ts.Tenuto;else if("pm"===t)this._sy=this.newSy(),e.isPalmMute=!0;else if("st"===t)this._sy=this.newSy(),e.isStaccato=!0;else if("lr"===t)this._sy=this.newSy(),e.isLetRing=!0;else if("x"===t)this._sy=this.newSy(),e.fret=0,e.isDead=!0;else if("-"===t||"t"===t)this._sy=this.newSy(),e.isTieDestination=!0;else if("lf"===t){this._sy=this.newSy();let t=ta.Thumb;this._sy===tO.Number&&(t=this.toFinger(this._syData),this._sy=this.newSy()),e.leftHandFinger=t}else if("rf"===t){this._sy=this.newSy();let t=ta.Thumb;this._sy===tO.Number&&(t=this.toFinger(this._syData),this._sy=this.newSy()),e.rightHandFinger=t}else if("acc"===t)this._sy=this.newSy(),this._sy!==tO.String&&this.error("note-accidental",tO.String,!0),e.accidentalMode=iW.parseAccidentalMode(this._syData),this._sy=this.newSy();else if("turn"===t)this._sy=this.newSy(),e.ornament=tw.Turn;else if("iturn"===t)this._sy=this.newSy(),e.ornament=tw.InvertedTurn;else if("umordent"===t)this._sy=this.newSy(),e.ornament=tw.UpperMordent;else if("lmordent"===t)this._sy=this.newSy(),e.ornament=tw.LowerMordent;else if("string"===t)this._sy=this.newSy(),e.showStringNumber=!0;else if("hide"===t)this._sy=this.newSy(),e.isVisible=!1;else if("slur"===t){this._sy=this.newSy(),this._sy!==tO.String&&this.error("slur",tO.String,!0);let t=this._syData;if(this._slurs.has(t)){let i=this._slurs.get(t);i.slurDestination=e,e.slurOrigin=i,e.isSlurDestination=!0}else this._slurs.set(t,e);this._sy=this.newSy()}else this.applyBeatEffect(e.beat)||this.error(t,tO.String,!1)}this._sy!==tO.RBrace&&this.error("note-effect",tO.RBrace,!1),this._sy=this.newSy()}}harmonicValue(e){return this._allowNegatives=!0,this._allowFloat=!0,this._sy=this.newSy(),this._sy===tO.Number&&(e=this._syData,this._sy=this.newSy()),this._allowNegatives=!1,this._allowFloat=!1,e}toFinger(e){switch(e){case 1:break;case 2:return ta.IndexFinger;case 3:return ta.MiddleFinger;case 4:return ta.AnnularFinger;case 5:return ta.LittleFinger}return ta.Thumb}parseDuration(e){switch(e){case -4:return tt.QuadrupleWhole;case -2:return tt.DoubleWhole;case 1:return tt.Whole;case 2:return tt.Half;case 4:default:return tt.Quarter;case 8:return tt.Eighth;case 16:return tt.Sixteenth;case 32:return tt.ThirtySecond;case 64:return tt.SixtyFourth;case 128:return tt.OneHundredTwentyEighth;case 256:return tt.TwoHundredFiftySixth}}parseBendStyle(e){switch(e.toLowerCase()){case"gradual":return e8.Gradual;case"fast":return e8.Fast;default:return e8.Default}}parseBendType(e){switch(e.toLowerCase()){case"none":return e7.None;case"custom":default:return e7.Custom;case"bend":return e7.Bend;case"release":return e7.Release;case"bendrelease":return e7.BendRelease;case"hold":return e7.Hold;case"prebend":return e7.Prebend;case"prebendbend":return e7.PrebendBend;case"prebendrelease":return e7.PrebendRelease}}barMeta(e){let t=!1,i=e.masterBar,s=!1;for(;!s&&this._sy===tO.MetaCommand;){t=!0;let a=this._syData.toLowerCase();if("ts"===a)this._sy=this.newSy(),this._sy===tO.String?"common"===this._syData.toLowerCase()?(i.timeSignatureCommon=!0,i.timeSignatureNumerator=4,i.timeSignatureDenominator=4,this._sy=this.newSy()):this.error("timesignature-numerator",tO.String,!0):(this._sy!==tO.Number&&this.error("timesignature-numerator",tO.Number,!0),i.timeSignatureNumerator=this._syData,this._sy=this.newSy(),this._sy!==tO.Number&&this.error("timesignature-denominator",tO.Number,!0),i.timeSignatureDenominator=this._syData,this._sy=this.newSy());else if("ft"===a)i.isFreeTime=!0,this._sy=this.newSy();else if("ro"===a)i.isRepeatStart=!0,this._sy=this.newSy();else if("rc"===a)this._sy=this.newSy(),this._sy!==tO.Number&&this.error("repeatclose",tO.Number,!0),this._syData>2048&&this.error("repeatclose",tO.Number,!1),i.repeatCount=this._syData,this._sy=this.newSy();else if("ae"===a)if(this._sy=this.newSy(),this._sy===tO.LParensis){for(this._sy=this.newSy(),this._sy!==tO.Number&&this.error("alternateending",tO.Number,!0),this.applyAlternateEnding(i);this._sy===tO.Number;)this.applyAlternateEnding(i);this._sy!==tO.RParensis&&this.error("alternateending-list",tO.RParensis,!0),this._sy=this.newSy()}else this._sy!==tO.Number&&this.error("alternateending",tO.Number,!0),this.applyAlternateEnding(i);else if("ks"===a)this._sy=this.newSy(),this._sy!==tO.String&&this.error("keysignature",tO.String,!0),e.keySignature=this.parseKeySignature(this._syData),e.keySignatureType=this.parseKeySignatureType(this._syData),this._sy=this.newSy();else if("clef"===a){switch(this._sy=this.newSy(),this._sy){case tO.String:e.clef=this.parseClefFromString(this._syData);break;case tO.Number:e.clef=this.parseClefFromInt(this._syData);break;case tO.Tuning:let t=this._syData;e.clef=this.parseClefFromInt(t.realValue);break;default:this.error("clef",tO.String,!0)}this._sy=this.newSy()}else if("tempo"===a){let e=this.readTempoAutomation();i.tempoAutomations.push(e)}else if("section"===a){this._sy=this.newSy(),this._sy!==tO.String&&this.error("section",tO.String,!0);let e=this._syData;this._sy=this.newSy();let t="";this._sy!==tO.String||this.isNoteText(this._syData.toLowerCase())||(t=e,e=this._syData,this._sy=this.newSy());let s=new se;s.marker=t,s.text=e,i.section=s}else if("tf"===a){switch(this._allowTuning=!1,this._sy=this.newSy(),this._allowTuning=!0,this._sy){case tO.String:i.tripletFeel=this.parseTripletFeelFromString(this._syData);break;case tO.Number:i.tripletFeel=this.parseTripletFeelFromInt(this._syData);break;default:this.error("triplet-feel",tO.String,!0)}this._sy=this.newSy()}else if("ac"===a)i.isAnacrusis=!0,this._sy=this.newSy();else if("db"===a)i.isDoubleBar=!0,e.barLineRight=e3.LightLight,this._sy=this.newSy();else if("barlineleft"===a)this._sy=this.newSy(),this._sy!==tO.String&&this.error("barlineleft",tO.String,!0),e.barLineLeft=this.parseBarLineStyle(this._syData),this._sy=this.newSy();else if("barlineright"===a)this._sy=this.newSy(),this._sy!==tO.String&&this.error("barlineright",tO.String,!0),e.barLineRight=this.parseBarLineStyle(this._syData),this._sy=this.newSy();else if("accidentals"===a)this.handleAccidentalMode();else if("jump"===a)this.handleDirections(i);else if("ottava"===a)this._sy=this.newSy(),this._sy!==tO.String&&this.error("ottava",tO.String,!0),e.clefOttava=this.parseClefOttavaFromString(this._syData),this._sy=this.newSy();else if("simile"===a)this._sy=this.newSy(),this._sy!==tO.String&&this.error("simile",tO.String,!0),e.simileMark=this.parseSimileMarkFromString(this._syData),this._sy=this.newSy();else if("scale"===a)this._allowFloat=!0,this._sy=this.newSy(),this._allowFloat=!1,this._sy!==tO.Number&&this.error("scale",tO.Number,!0),i.displayScale=this._syData,e.displayScale=this._syData,this._sy=this.newSy();else if("width"===a)this._sy=this.newSy(),this._sy!==tO.Number&&this.error("width",tO.Number,!0),i.displayWidth=this._syData,e.displayWidth=this._syData,this._sy=this.newSy();else if(0===e.index)switch(this.handleStaffMeta()){case tH.KnownStaffMeta:break;case tH.UnknownStaffMeta:this.error("measure-effects",tO.String,!1);break;case tH.EndOfMetaDetected:s=!0}else this.handleStaffMeta()===tH.EndOfMetaDetected?s=!0:this.error("measure-effects",tO.String,!1)}if(0===i.index&&0===i.tempoAutomations.length){let e=new iv;e.isLinear=!1,e.type=e6.Tempo,e.value=this._score.tempo,e.text=this._score.tempoLabel,i.tempoAutomations.push(e)}return t}parseBarLineStyle(e){switch(e.toLowerCase()){case"automatic":break;case"dashed":return e3.Dashed;case"dotted":return e3.Dotted;case"heavy":return e3.Heavy;case"heavyheavy":return e3.HeavyHeavy;case"heavylight":return e3.HeavyLight;case"lightheavy":return e3.LightHeavy;case"lightlight":return e3.LightLight;case"none":return e3.None;case"regular":return e3.Regular;case"short":return e3.Short;case"tick":return e3.Tick}return e3.Automatic}parseSimileMarkFromString(e){switch(e.toLowerCase()){case"none":default:return eZ.None;case"simple":return eZ.Simple;case"firstofdouble":return eZ.FirstOfDouble;case"secondofdouble":return eZ.SecondOfDouble}}handleDirections(e){switch(this._sy=this.newSy(),this._sy!==tO.String&&this.error("direction",tO.String,!0),this._syData.toLowerCase()){case"fine":e.addDirection(tI.TargetFine);break;case"segno":e.addDirection(tI.TargetSegno);break;case"segnosegno":e.addDirection(tI.TargetSegnoSegno);break;case"coda":e.addDirection(tI.TargetCoda);break;case"doublecoda":e.addDirection(tI.TargetDoubleCoda);break;case"dacapo":e.addDirection(tI.JumpDaCapo);break;case"dacapoalcoda":e.addDirection(tI.JumpDaCapoAlCoda);break;case"dacapoaldoublecoda":e.addDirection(tI.JumpDaCapoAlDoubleCoda);break;case"dacapoalfine":e.addDirection(tI.JumpDaCapoAlFine);break;case"dalsegno":e.addDirection(tI.JumpDalSegno);break;case"dalsegnoalcoda":e.addDirection(tI.JumpDalSegnoAlCoda);break;case"dalsegnoaldoublecoda":e.addDirection(tI.JumpDalSegnoAlDoubleCoda);break;case"dalsegnoalfine":e.addDirection(tI.JumpDalSegnoAlFine);break;case"dalsegnosegno":e.addDirection(tI.JumpDalSegnoSegno);break;case"dalsegnosegnoalcoda":e.addDirection(tI.JumpDalSegnoSegnoAlCoda);break;case"dalsegnosegnoaldoublecoda":e.addDirection(tI.JumpDalSegnoSegnoAlDoubleCoda);break;case"dalsegnosegnoalfine":e.addDirection(tI.JumpDalSegnoSegnoAlFine);break;case"dacoda":e.addDirection(tI.JumpDaCoda);break;case"dadoublecoda":e.addDirection(tI.JumpDaDoubleCoda);break;default:this.errorMessage(`Unexpected direction value: '${this._syData}'`);return}this._sy=this.newSy()}readTempoAutomation(){this._allowFloat=!0,this._sy=this.newSy(),this._allowFloat=!1,this._sy!==tO.Number&&this.error("tempo",tO.Number,!0);let e=new iv;return e.isLinear=!1,e.type=e6.Tempo,e.value=this._syData,this._sy=this.newSy(),this._sy===tO.String&&(e.text=this._syData,this._sy=this.newSy()),e}applyAlternateEnding(e){let t=this._syData;t<1&&this.error("alternateending",tO.Number,!0),e.alternateEndings|=1<<t-1,this._sy=this.newSy()}parseWhammyType(e){switch(e.toLowerCase()){case"none":return tB.None;case"custom":default:return tB.Custom;case"dive":return tB.Dive;case"dip":return tB.Dip;case"hold":return tB.Hold;case"predive":return tB.Predive;case"predivedive":return tB.PrediveDive}}}sp.Eof=0;class sm extends i4{constructor(){super(...arguments),this._versionNumber=0,this._globalTripletFeel=tg.NoTripletFeel,this._lyricsTrack=0,this._lyrics=[],this._barCount=0,this._trackCount=0,this._playbackInfos=[],this._doubleBars=new Set,this._keySignatures=new Map,this._beatTextChunksByTrack=new Map,this._directionLookup=new Map}get name(){return"Guitar Pro 3-5"}readScore(){if(this._directionLookup.clear(),this.readVersion(),this._score=new i3,this.readScoreInformation(),this._versionNumber<500&&(this._globalTripletFeel=sg.gpReadBool(this.data)?tg.Triplet8th:tg.NoTripletFeel),this._versionNumber>=400&&this.readLyrics(),this._versionNumber>=510&&this.data.skip(19),this._versionNumber>=500&&(this.readPageSetup(),this._score.tempoLabel=sg.gpReadStringIntByte(this.data,this.settings.importer.encoding)),this._score.tempo=sh.readInt32LE(this.data),this._versionNumber>=510&&sg.gpReadBool(this.data),sh.readInt32LE(this.data),this._versionNumber>=400&&this.data.readByte(),this.readPlaybackInfos(),this._versionNumber>=500&&(this.readDirection(tI.TargetCoda),this.readDirection(tI.TargetDoubleCoda),this.readDirection(tI.TargetSegno),this.readDirection(tI.TargetSegnoSegno),this.readDirection(tI.TargetFine),this.readDirection(tI.JumpDaCapo),this.readDirection(tI.JumpDaCapoAlCoda),this.readDirection(tI.JumpDaCapoAlDoubleCoda),this.readDirection(tI.JumpDaCapoAlFine),this.readDirection(tI.JumpDalSegno),this.readDirection(tI.JumpDalSegnoAlCoda),this.readDirection(tI.JumpDalSegnoAlDoubleCoda),this.readDirection(tI.JumpDalSegnoAlFine),this.readDirection(tI.JumpDalSegnoSegno),this.readDirection(tI.JumpDalSegnoSegnoAlCoda),this.readDirection(tI.JumpDalSegnoSegnoAlDoubleCoda),this.readDirection(tI.JumpDalSegnoSegnoAlFine),this.readDirection(tI.JumpDaCoda),this.readDirection(tI.JumpDaDoubleCoda),this.data.skip(4)),this._barCount=sh.readInt32LE(this.data),this._trackCount=sh.readInt32LE(this.data),this.readMasterBars(),this.readTracks(),this.readBars(),this._score.masterBars.length>0){let e=iv.buildTempoAutomation(!1,0,this._score.tempo,2);e.text=this._score.tempoLabel,this._score.masterBars[0].tempoAutomations.push(e)}return iW.consolidate(this._score),this._score.finish(this.settings),this._lyrics&&this._lyricsTrack>=0&&this._score.tracks[this._lyricsTrack].applyLyrics(this._lyrics),this._score}readDirection(e){let t,i=sh.readInt16LE(this.data);-1!==i&&(i--,this._directionLookup.has(i)?t=this._directionLookup.get(i):(t=[],this._directionLookup.set(i,t)),t.push(e))}readVersion(){let e=sg.gpReadStringByteLength(this.data,30,this.settings.importer.encoding);if(!e.startsWith(sm.VersionString))throw new i8("Unsupported format");let t=(e=e.substr(sm.VersionString.length+1)).indexOf(".");this._versionNumber=100*Number.parseInt(e.substr(0,t))+Number.parseInt(e.substr(t+1)),iM.debug(this.name,`Guitar Pro version ${e} detected`)}readScoreInformation(){this._score.title=sg.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.subTitle=sg.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.artist=sg.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.album=sg.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.words=sg.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.music=this._versionNumber>=500?sg.gpReadStringIntUnused(this.data,this.settings.importer.encoding):this._score.words,this._score.copyright=sg.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.tab=sg.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.instructions=sg.gpReadStringIntUnused(this.data,this.settings.importer.encoding);let e=sh.readInt32LE(this.data),t="";for(let i=0;i<e;i++)i>0&&(t+="\r\n"),t+=sg.gpReadStringIntUnused(this.data,this.settings.importer.encoding)?.toString();this._score.notices=t}readLyrics(){this._lyrics=[],this._lyricsTrack=sh.readInt32LE(this.data)-1;for(let e=0;e<5;e++){let e=new i9;e.startBar=sh.readInt32LE(this.data)-1,e.text=sg.gpReadStringInt(this.data,this.settings.importer.encoding),this._lyrics.push(e)}}readPageSetup(){this.data.skip(28);let e=sh.readInt16LE(this.data);iW.getOrCreateHeaderFooterStyle(this._score,tD.Title).isVisible=(1&e)!=0,iW.getOrCreateHeaderFooterStyle(this._score,tD.Title).template=sg.gpReadStringIntByte(this.data,this.settings.importer.encoding),iW.getOrCreateHeaderFooterStyle(this._score,tD.SubTitle).isVisible=(2&e)!=0,iW.getOrCreateHeaderFooterStyle(this._score,tD.SubTitle).template=sg.gpReadStringIntByte(this.data,this.settings.importer.encoding),iW.getOrCreateHeaderFooterStyle(this._score,tD.Artist).isVisible=(4&e)!=0,iW.getOrCreateHeaderFooterStyle(this._score,tD.Artist).template=sg.gpReadStringIntByte(this.data,this.settings.importer.encoding),iW.getOrCreateHeaderFooterStyle(this._score,tD.Album).isVisible=(8&e)!=0,iW.getOrCreateHeaderFooterStyle(this._score,tD.Album).template=sg.gpReadStringIntByte(this.data,this.settings.importer.encoding),iW.getOrCreateHeaderFooterStyle(this._score,tD.Words).isVisible=(16&e)!=0,iW.getOrCreateHeaderFooterStyle(this._score,tD.Words).template=sg.gpReadStringIntByte(this.data,this.settings.importer.encoding),iW.getOrCreateHeaderFooterStyle(this._score,tD.Music).isVisible=(32&e)!=0,iW.getOrCreateHeaderFooterStyle(this._score,tD.Music).template=sg.gpReadStringIntByte(this.data,this.settings.importer.encoding),iW.getOrCreateHeaderFooterStyle(this._score,tD.WordsAndMusic).isVisible=(64&e)!=0,iW.getOrCreateHeaderFooterStyle(this._score,tD.WordsAndMusic).template=sg.gpReadStringIntByte(this.data,this.settings.importer.encoding),iW.getOrCreateHeaderFooterStyle(this._score,tD.Copyright).isVisible=(128&e)!=0,iW.getOrCreateHeaderFooterStyle(this._score,tD.Copyright).template=sg.gpReadStringIntByte(this.data,this.settings.importer.encoding),iW.getOrCreateHeaderFooterStyle(this._score,tD.CopyrightSecondLine).isVisible=(128&e)!=0,iW.getOrCreateHeaderFooterStyle(this._score,tD.CopyrightSecondLine).template=sg.gpReadStringIntByte(this.data,this.settings.importer.encoding),sg.gpReadStringIntByte(this.data,this.settings.importer.encoding)}readPlaybackInfos(){this._playbackInfos=[];let e=0;for(let t=0;t<64;t++){let t=new ss;t.primaryChannel=e++,t.secondaryChannel=e++,t.program=sh.readInt32LE(this.data),t.volume=this.data.readByte(),t.balance=this.data.readByte(),this.data.skip(6),this._playbackInfos.push(t)}}readMasterBars(){for(let e=0;e<this._barCount;e++)this.readMasterBar()}readMasterBar(){let e=null;this._score.masterBars.length>0&&(e=this._score.masterBars[this._score.masterBars.length-1]);let t=new iL,i=this.data.readByte();if((1&i)!=0?t.timeSignatureNumerator=this.data.readByte():e&&(t.timeSignatureNumerator=e.timeSignatureNumerator),(2&i)!=0?t.timeSignatureDenominator=this.data.readByte():e&&(t.timeSignatureDenominator=e.timeSignatureDenominator),t.isRepeatStart=(4&i)!=0,(8&i)!=0&&(t.repeatCount=this.data.readByte()+(this._versionNumber>=500?0:1)),(16&i)!=0&&this._versionNumber<500){let i=e,s=0;for(;i&&(!i.isRepeatEnd||i===e)&&!i.isRepeatStart;)s|=i.alternateEndings,i=i.previousMasterBar;let a=0,r=this.data.readByte();for(let e=0;e<8;e++){let t=1<<e;r>e&&(s&t)==0&&(a|=t)}t.alternateEndings=a}if((32&i)!=0){let e=new se;e.text=sg.gpReadStringIntByte(this.data,this.settings.importer.encoding),e.marker="",sg.gpReadColor(this.data,!1),t.section=e}if((64&i)!=0&&this._keySignatures.set(this._score.masterBars.length,[sh.readSInt8(this.data),this.data.readByte()]),this._versionNumber>=500&&(3&i)!=0&&this.data.skip(4),this._versionNumber>=500&&(t.alternateEndings=this.data.readByte()),this._versionNumber>=500){switch(this.data.readByte()){case 1:t.tripletFeel=tg.Triplet8th;break;case 2:t.tripletFeel=tg.Triplet16th}this.data.readByte()}else t.tripletFeel=this._globalTripletFeel;let s=(128&i)!=0;t.isDoubleBar=s;let a=this._score.masterBars.length;if(this._directionLookup.has(a))for(let e of this._directionLookup.get(a))t.addDirection(e);this._score.addMasterBar(t),s&&this._doubleBars.add(t.index)}readTracks(){for(let e=0;e<this._trackCount;e++)this.readTrack()}readTrack(){let e=new so;e.ensureStaveCount(1),this._score.addTrack(e);let t=e.staves[0],i=this.data.readByte();e.name=sg.gpReadStringByteLength(this.data,40,this.settings.importer.encoding),(1&i)!=0&&(t.isPercussion=!0),this._versionNumber>=500&&(e.isVisibleOnMultiTrack=(8&i)!=0),null===this._score.stylesheet.perTrackDisplayTuning&&(this._score.stylesheet.perTrackDisplayTuning=new Map),this._score.stylesheet.perTrackDisplayTuning.set(e.index,(128&i)!=0);let s=sh.readInt32LE(this.data),a=[];for(let e=0;e<7;e++){let t=sh.readInt32LE(this.data);s>e&&a.push(t)}t.stringTuning.tunings=a;let r=sh.readInt32LE(this.data),n=sh.readInt32LE(this.data)-1,o=sh.readInt32LE(this.data)-1;if(this.data.skip(4),n>=0&&n<this._playbackInfos.length){let s=this._playbackInfos[n];s.port=r,s.isSolo=(16&i)!=0,s.isMute=(32&i)!=0,s.secondaryChannel=o,iS.isGuitar(s.program)&&(t.displayTranspositionPitch=-12),e.playbackInfo=s}if(t.capo=sh.readInt32LE(this.data),e.color=sg.gpReadColor(this.data,!1),this._versionNumber>=500){let i=this.data.readByte();t.showTablature=(1&i)!=0,t.showStandardNotation=(2&i)!=0,null===this._score.stylesheet.perTrackChordDiagramsOnTop&&(this._score.stylesheet.perTrackChordDiagramsOnTop=new Map),this._score.stylesheet.perTrackChordDiagramsOnTop.set(e.index,(100&i)!=0),this.data.readByte(),this.data.skip(43)}this._versionNumber>=510&&(this.data.skip(4),sg.gpReadStringIntByte(this.data,this.settings.importer.encoding),sg.gpReadStringIntByte(this.data,this.settings.importer.encoding))}readBars(){for(let e=0;e<this._barCount;e++)for(let e=0;e<this._trackCount;e++)this.readBar(this._score.tracks[e])}readBar(e){let t=new iN,i=e.staves[0];if(i.isPercussion&&(t.clef=eK.Neutral),i.addBar(t),this._keySignatures.has(t.index)){let e=this._keySignatures.get(t.index);t.keySignature=e[0],t.keySignatureType=e[1]}else t.index>0&&(t.keySignature=t.previousBar.keySignature,t.keySignatureType=t.previousBar.keySignatureType);this._doubleBars.has(t.index)&&(t.barLineRight=e3.LightLight);let s=1;this._versionNumber>=500&&(this.data.readByte(),s=2);for(let i=0;i<s;i++)this.readVoice(e,t)}readVoice(e,t){let i=sh.readInt32LE(this.data);if(0===i)return;let s=new iO;t.addVoice(s);for(let a=0;a<i;a++)this.readBeat(e,t,s)}readBeat(e,t,i){let s=new i1,a=this.data.readByte();switch((1&a)!=0&&(s.dots=1),(64&a)!=0&&(s.isEmpty=(2&this.data.readByte())==0),i.addBeat(s),sh.readSInt8(this.data)){case -2:s.duration=tt.Whole;break;case -1:s.duration=tt.Half;break;case 0:default:s.duration=tt.Quarter;break;case 1:s.duration=tt.Eighth;break;case 2:s.duration=tt.Sixteenth;break;case 3:s.duration=tt.ThirtySecond;break;case 4:s.duration=tt.SixtyFourth}if((32&a)!=0)switch(s.tupletNumerator=sh.readInt32LE(this.data),s.tupletNumerator){case 1:s.tupletDenominator=1;break;case 3:s.tupletDenominator=2;break;case 5:case 6:case 7:s.tupletDenominator=4;break;case 9:case 10:case 11:case 12:case 13:s.tupletDenominator=8;break;case 2:case 4:case 8:break;default:s.tupletNumerator=1,s.tupletDenominator=1}(2&a)!=0&&this.readChord(s);let r=this.settings.importer.beatTextAsLyrics&&e.index!==this._lyricsTrack;if((4&a)!=0){let t=sg.gpReadStringIntUnused(this.data,this.settings.importer.encoding);if(r){let i=new i9;i.text=t.trim(),i.finish(!0);let s=[];for(let e=i.chunks.length-1;e>=0;e--)s.push(i.chunks[e]);this._beatTextChunksByTrack.set(e.index,s)}else s.text=t}let n=tr.None;(8&a)!=0&&(n=this.readBeatEffects(s)),(16&a)!=0&&this.readMixTableChange(s);let o=this.data.readByte();for(let a=6;a>=0;a--)if((o&1<<a)!=0&&6-a<t.staff.tuning.length){let r=this.readNote(e,t,i,s,6-a);n!==tr.None&&(r.harmonicType=n,r.harmonicType===tr.Natural&&(r.harmonicValue=iW.deltaFretToHarmonicValue(r.fret)))}if(this._versionNumber>=500){let e=sh.readInt16LE(this.data);if((1&e)!=0&&s.index>0&&(i.beats[s.index-1].beamingMode=tF.ForceSplitToNext),(2&e)!=0&&(s.preferredBeamDirection=tR.Down),(4&e)!=0&&s.index>0&&(i.beats[s.index-1].beamingMode=tF.ForceMergeWithNext),(8&e)!=0&&(s.preferredBeamDirection=tR.Up),(16&e)!=0&&(s.ottava=eQ._8va),(32&e)!=0&&(s.ottava=eQ._8vb),(64&e)!=0&&(s.ottava=eQ._15ma),(256&e)!=0&&(s.ottava=eQ._15mb),(2048&e)!=0){let e=0!==this.data.readByte();s.index>0&&e&&(i.beats[s.index-1].beamingMode=tF.ForceSplitOnSecondaryToNext)}}r&&!s.isRest&&this._beatTextChunksByTrack.has(e.index)&&this._beatTextChunksByTrack.get(e.index).length>0&&(s.lyrics=[this._beatTextChunksByTrack.get(e.index).pop()])}readChord(e){let t=new i7,i=iW.newGuid();if(this._versionNumber>=500){this.data.skip(17),t.name=sg.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),t.firstFret=sh.readInt32LE(this.data);for(let i=0;i<7;i++){let s=sh.readInt32LE(this.data);i<e.voice.bar.staff.tuning.length&&t.strings.push(s)}let i=this.data.readByte(),s=new Uint8Array(5);this.data.read(s,0,s.length);for(let e=0;e<i;e++)t.barreFrets.push(s[e]);this.data.skip(26)}else if(0!==this.data.readByte())if(this._versionNumber>=400){this.data.skip(16),t.name=sg.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),t.firstFret=sh.readInt32LE(this.data);for(let i=0;i<7;i++){let s=sh.readInt32LE(this.data);i<e.voice.bar.staff.tuning.length&&t.strings.push(s)}let i=this.data.readByte(),s=new Uint8Array(5);this.data.read(s,0,s.length);for(let e=0;e<i;e++)t.barreFrets.push(s[e]);this.data.skip(26)}else{this.data.skip(25),t.name=sg.gpReadStringByteLength(this.data,34,this.settings.importer.encoding),t.firstFret=sh.readInt32LE(this.data);for(let i=0;i<6;i++){let s=sh.readInt32LE(this.data);i<e.voice.bar.staff.tuning.length&&t.strings.push(s)}this.data.skip(36)}else{let i=this._versionNumber>=406?7:6;if(t.name=sg.gpReadStringIntByte(this.data,this.settings.importer.encoding),t.firstFret=sh.readInt32LE(this.data),t.firstFret>0)for(let s=0;s<i;s++){let i=sh.readInt32LE(this.data);s<e.voice.bar.staff.tuning.length&&t.strings.push(i)}}t.name&&(e.chordId=i,e.voice.bar.staff.addChord(e.chordId,t))}readBeatEffects(e){let t=this.data.readByte(),i=0;if(this._versionNumber>=400&&(i=this.data.readByte()),(16&t)!=0&&(e.fade=tN.FadeIn),(this._versionNumber<400&&(1&t)!=0||(2&t)!=0)&&(e.vibrato=th.Slight),(1&i)!=0&&(e.rasgueado=tv.Ii),(32&t)!=0&&this._versionNumber>=400)switch(sh.readSInt8(this.data)){case 1:e.tap=!0;break;case 2:e.slap=!0;break;case 3:e.pop=!0}else if((32&t)!=0){switch(sh.readSInt8(this.data)){case 1:e.tap=!0;break;case 2:e.slap=!0;break;case 3:e.pop=!0}this.data.skip(4)}if((4&i)!=0&&this.readTremoloBarEffect(e),(64&t)!=0){let t=0,i=0;this._versionNumber<500?(i=this.data.readByte(),t=this.data.readByte()):(t=this.data.readByte(),i=this.data.readByte()),t>0?(e.brushType=e9.BrushUp,e.brushDuration=sm.toStrokeValue(t)):i>0&&(e.brushType=e9.BrushDown,e.brushDuration=sm.toStrokeValue(i))}if((2&i)!=0)switch(sh.readSInt8(this.data)){case 0:e.pickStroke=ty.None;break;case 1:e.pickStroke=ty.Up;break;case 2:e.pickStroke=ty.Down}if(this._versionNumber<400){if((4&t)!=0)return tr.Natural;if((8&t)!=0)return tr.Artificial}return tr.None}readTremoloBarEffect(e){this.data.readByte(),sh.readInt32LE(this.data);let t=sh.readInt32LE(this.data);if(t>0)for(let i=0;i<t;i++){let t=new iF(0,0);t.offset=sh.readInt32LE(this.data),t.value=sh.readInt32LE(this.data)/sm.BendStep|0,sg.gpReadBool(this.data),e.addWhammyBarPoint(t)}}static toStrokeValue(e){switch(e){case 1:case 2:return 30;case 3:return 60;case 4:return 120;case 5:return 240;case 6:return 480;default:return 0}}readMixTableChange(e){let t=new sf;t.instrument=sh.readSInt8(this.data),this._versionNumber>=500&&this.data.skip(16),t.volume=sh.readSInt8(this.data),t.balance=sh.readSInt8(this.data);let i=sh.readSInt8(this.data),s=sh.readSInt8(this.data),a=sh.readSInt8(this.data),r=sh.readSInt8(this.data);if(this._versionNumber>=500&&(t.tempoName=sg.gpReadStringIntByte(this.data,this.settings.importer.encoding)),t.tempo=sh.readInt32LE(this.data),t.volume>=0&&this.data.readByte(),t.balance>=0&&this.data.readByte(),i>=0&&this.data.readByte(),s>=0&&this.data.readByte(),a>=0&&this.data.readByte(),r>=0&&this.data.readByte(),t.tempo>=0&&(t.duration=sh.readSInt8(this.data),this._versionNumber>=510&&this.data.readByte()),this._versionNumber>=400&&this.data.readByte(),this._versionNumber>=500){let t=sh.readSInt8(this.data);t>=100?e.wahPedal=tx.Closed:t>=0&&(e.wahPedal=tx.Open)}if(this._versionNumber>=510&&(sg.gpReadStringIntByte(this.data,this.settings.importer.encoding),sg.gpReadStringIntByte(this.data,this.settings.importer.encoding)),t.volume>=0){let i=new iv;i.isLinear=!0,i.type=e6.Volume,i.value=t.volume,e.automations.push(i)}if(t.balance>=0){let i=new iv;i.isLinear=!0,i.type=e6.Balance,i.value=t.balance,e.automations.push(i)}if(t.instrument>=0){let i=new iv;i.isLinear=!0,i.type=e6.Instrument,i.value=t.instrument,e.automations.push(i)}if(t.tempo>=0){let i=new iv;i.isLinear=!0,i.type=e6.Tempo,i.value=t.tempo,e.automations.push(i),e.voice.bar.masterBar.tempoAutomations.push(i)}}readNote(e,t,i,s,a){let r=new iY;r.string=t.staff.tuning.length-a;let n=this.data.readByte();if((2&n)!=0?r.accentuated=ts.Heavy:(64&n)!=0&&(r.accentuated=ts.Normal),r.isGhost=(4&n)!=0,(32&n)!=0){let e=this.data.readByte();3===e?r.isDead=!0:2===e&&(r.isTieDestination=!0)}if((1&n)!=0&&this._versionNumber<500&&(this.data.readByte(),this.data.readByte()),(16&n)!=0){let e=sh.readSInt8(this.data);r.dynamics=this.toDynamicValue(e),s.dynamics=r.dynamics}(32&n)!=0&&(r.fret=sh.readSInt8(this.data)),(128&n)!=0&&(r.leftHandFinger=sh.readSInt8(this.data),r.rightHandFinger=sh.readSInt8(this.data));let o=!1;if(this._versionNumber>=500&&((1&n)!=0&&(r.durationPercent=sh.readFloat64BE(this.data)),o=(2&this.data.readByte())!=0),s.addNote(r),(8&n)!=0&&this.readNoteEffects(e,i,s,r),t.staff.isPercussion&&(r.percussionArticulation=r.fret,r.string=-1,r.fret=-1),o){let e=sa.defaultAccidentals[r.realValueWithoutHarmonic%12];"#"===e?r.accidentalMode=tn.ForceFlat:"b"===e&&(r.accidentalMode=tn.ForceSharp)}return r}toDynamicValue(e){switch(e){case 1:return e4.PPP;case 2:return e4.PP;case 3:return e4.P;case 4:return e4.MP;case 5:return e4.MF;case 6:default:return e4.F;case 7:return e4.FF;case 8:return e4.FFF}}readNoteEffects(e,t,i,s){let a=this.data.readByte(),r=0;this._versionNumber>=400&&(r=this.data.readByte()),(1&a)!=0&&this.readBend(s),(16&a)!=0&&this.readGrace(t,s),(4&r)!=0&&this.readTremoloPicking(i),(8&r)!=0?this.readSlide(s):this._versionNumber<400&&(4&a)!=0&&(s.slideOutType=tl.Shift),(16&r)!=0&&this.readArtificialHarmonic(s),(32&r)!=0&&this.readTrill(s),s.isLetRing=(8&a)!=0,s.isHammerPullOrigin=(2&a)!=0,(64&r)!=0&&(s.vibrato=th.Slight),s.isPalmMute=(2&r)!=0,s.isStaccato=(1&r)!=0}readBend(e){this.data.readByte(),sh.readInt32LE(this.data);let t=sh.readInt32LE(this.data);if(t>0)for(let i=0;i<t;i++){let t=new iF(0,0);t.offset=sh.readInt32LE(this.data),t.value=sh.readInt32LE(this.data)/sm.BendStep|0,sg.gpReadBool(this.data),e.addBendPoint(t)}}readGrace(e,t){let i=new i1,s=new iY;switch(s.string=t.string,s.fret=sh.readSInt8(this.data),i.duration=tt.ThirtySecond,i.dynamics=this.toDynamicValue(sh.readSInt8(this.data)),sh.readSInt8(this.data)){case 0:case 2:break;case 1:s.slideOutType=tl.Legato,s.slideTarget=t;break;case 3:s.isHammerPullOrigin=!0}if(s.dynamics=i.dynamics,this.data.skip(1),this._versionNumber<500)i.graceType=ti.BeforeBeat;else{let e=this.data.readByte();s.isDead=(1&e)!=0,i.graceType=(2&e)!=0?ti.OnBeat:ti.BeforeBeat}e.addGraceBeat(i),i.addNote(s)}readTremoloPicking(e){switch(this.data.readByte()){case 1:e.tremoloSpeed=tt.Eighth;break;case 2:e.tremoloSpeed=tt.Sixteenth;break;case 3:e.tremoloSpeed=tt.ThirtySecond}}readSlide(e){if(this._versionNumber>=500){let t=sh.readSInt8(this.data);(1&t)!=0?e.slideOutType=tl.Shift:(2&t)!=0?e.slideOutType=tl.Legato:(4&t)!=0?e.slideOutType=tl.OutDown:(8&t)!=0&&(e.slideOutType=tl.OutUp),(16&t)!=0?e.slideInType=to.IntoFromBelow:(32&t)!=0&&(e.slideInType=to.IntoFromAbove)}else switch(sh.readSInt8(this.data)){case 1:e.slideOutType=tl.Shift;break;case 2:e.slideOutType=tl.Legato;break;case 3:e.slideOutType=tl.OutDown;break;case 4:e.slideOutType=tl.OutUp;break;case -1:e.slideInType=to.IntoFromBelow;break;case -2:e.slideInType=to.IntoFromAbove}}readArtificialHarmonic(e){let t=this.data.readByte();if(this._versionNumber>=500)switch(t){case 1:e.harmonicType=tr.Natural,e.harmonicValue=iW.deltaFretToHarmonicValue(e.fret);break;case 2:this.data.readByte(),this.data.readByte(),this.data.readByte(),e.harmonicType=tr.Artificial;break;case 3:e.harmonicType=tr.Tap,e.harmonicValue=iW.deltaFretToHarmonicValue(this.data.readByte());break;case 4:e.harmonicType=tr.Pinch,e.harmonicValue=12;break;case 5:e.harmonicType=tr.Semi,e.harmonicValue=12}else if(this._versionNumber>=400)switch(t){case 1:e.harmonicType=tr.Natural;break;case 3:e.harmonicType=tr.Tap;break;case 4:e.harmonicType=tr.Pinch;break;case 5:e.harmonicType=tr.Semi;break;case 15:case 17:case 22:e.harmonicType=tr.Artificial}}readTrill(e){switch(e.trillValue=this.data.readByte()+e.stringTuning,this.data.readByte()){case 1:e.trillSpeed=tt.Sixteenth;break;case 2:e.trillSpeed=tt.ThirtySecond;break;case 3:e.trillSpeed=tt.SixtyFourth}}}sm.VersionString="FICHIER GUITAR PRO ",sm.BendStep=25;class sg{static gpReadColor(e,t=!1){let i=e.readByte(),s=e.readByte(),a=e.readByte(),r=255;return t?r=e.readByte():e.skip(1),new si(i,s,a,r)}static gpReadBool(e){return 0!==e.readByte()}static gpReadStringIntUnused(e,t){return e.skip(4),sg.gpReadString(e,e.readByte(),t)}static gpReadStringInt(e,t){return sg.gpReadString(e,sh.readInt32LE(e),t)}static gpReadStringIntByte(e,t){let i=sh.readInt32LE(e)-1;return e.readByte(),sg.gpReadString(e,i,t)}static gpReadString(e,t,i){let s=new Uint8Array(t);return e.read(s,0,s.length),sh.toString(s,i)}static gpWriteString(e,t){let i=sh.stringToBytes(t);e.writeByte(t.length),e.write(i,0,i.length)}static gpReadStringByteLength(e,t,i){let s=e.readByte(),a=sg.gpReadString(e,s,i);return s<t&&e.skip(t-s),a}}class sf{constructor(){this.volume=-1,this.balance=-1,this.instrument=-1,this.tempoName="",this.tempo=-1,this.duration=-1}}class sy{constructor(){this.x=0,this.y=0,this.w=0,this.h=0}scaleWith(e){this.x*=e,this.y*=e,this.w*=e,this.h*=e}}(eo=tW||(tW={}))[eo.Boolean=0]="Boolean",eo[eo.Integer=1]="Integer",eo[eo.Float=2]="Float",eo[eo.String=3]="String",eo[eo.Point=4]="Point",eo[eo.Size=5]="Size",eo[eo.Rectangle=6]="Rectangle",eo[eo.Color=7]="Color";class sb{constructor(e){this._types=new Map,this.raw=new Map,e&&this.read(e)}read(e){let t=sd.fromBuffer(e),i=sh.readInt32BE(t);for(let e=0;e<i;e++){let e=sg.gpReadString(t,t.readByte(),"utf-8"),i=t.readByte();switch(this._types.set(e,i),i){case tW.Boolean:let s=1===t.readByte();this.addValue(e,s);break;case tW.Integer:let a=sh.readInt32BE(t);this.addValue(e,a);break;case tW.Float:let r=sh.readFloat32BE(t);this.addValue(e,r);break;case tW.String:let n=sg.gpReadString(t,sh.readInt16BE(t),"utf-8");this.addValue(e,n);break;case tW.Point:let o=sh.readInt32BE(t),l=sh.readInt32BE(t);this.addValue(e,new iF(o,l));break;case tW.Size:let h=sh.readInt32BE(t),d=sh.readInt32BE(t);this.addValue(e,new iF(h,d));break;case tW.Rectangle:let c=new sy;c.x=sh.readInt32BE(t),c.y=sh.readInt32BE(t),c.w=sh.readInt32BE(t),c.h=sh.readInt32BE(t),this.addValue(e,c);break;case tW.Color:let u=sg.gpReadColor(t,!0);this.addValue(e,u)}}}apply(e){for(let[t,i]of this.raw)switch(t){case"StandardNotation/hideDynamics":e.stylesheet.hideDynamics=i;break;case"System/bracketExtendMode":e.stylesheet.bracketExtendMode=i;break;case"Global/useSystemSignSeparator":e.stylesheet.useSystemSignSeparator=i;break;case"Global/DisplayTuning":e.stylesheet.globalDisplayTuning=i;break;case"Global/DrawChords":e.stylesheet.globalDisplayChordDiagramsOnTop=i;break;case"System/showTrackNameSingle":i||(e.stylesheet.singleTrackTrackNamePolicy=eq.Hidden);break;case"System/showTrackNameMulti":i||(e.stylesheet.multiTrackTrackNamePolicy=eq.Hidden);break;case"System/trackNameModeSingle":if(e.stylesheet.singleTrackTrackNamePolicy!==eq.Hidden)switch(i){case 0:case 1:e.stylesheet.singleTrackTrackNamePolicy=eq.FirstSystem;break;case 2:e.stylesheet.singleTrackTrackNamePolicy=eq.AllSystems}break;case"System/trackNameModeMulti":if(e.stylesheet.multiTrackTrackNamePolicy!==eq.Hidden)switch(i){case 0:case 1:e.stylesheet.multiTrackTrackNamePolicy=eq.FirstSystem;break;case 2:e.stylesheet.multiTrackTrackNamePolicy=eq.AllSystems}break;case"System/shortTrackNameOnFirstSystem":i?e.stylesheet.firstSystemTrackNameMode=e$.ShortName:e.stylesheet.firstSystemTrackNameMode=e$.FullName;break;case"System/shortTrackNameOnOtherSystems":i?e.stylesheet.otherSystemsTrackNameMode=e$.ShortName:e.stylesheet.otherSystemsTrackNameMode=e$.FullName;break;case"System/horizontalTrackNameOnFirstSystem":i?e.stylesheet.firstSystemTrackNameOrientation=ej.Horizontal:e.stylesheet.firstSystemTrackNameOrientation=ej.Vertical;break;case"System/horizontalTrackNameOnOtherSystems":i?e.stylesheet.otherSystemsTrackNameOrientation=ej.Horizontal:e.stylesheet.otherSystemsTrackNameOrientation=ej.Vertical;break;case"Header/Title":iW.getOrCreateHeaderFooterStyle(e,tD.Title).template=i;break;case"Header/TitleAlignment":iW.getOrCreateHeaderFooterStyle(e,tD.Title).textAlign=this.toTextAlign(i);break;case"Header/drawTitle":iW.getOrCreateHeaderFooterStyle(e,tD.Title).isVisible=i;break;case"Header/Subtitle":iW.getOrCreateHeaderFooterStyle(e,tD.SubTitle).template=i;break;case"Header/SubtitleAlignment":iW.getOrCreateHeaderFooterStyle(e,tD.SubTitle).textAlign=this.toTextAlign(i);break;case"Header/drawSubtitle":iW.getOrCreateHeaderFooterStyle(e,tD.SubTitle).isVisible=i;break;case"Header/Artist":iW.getOrCreateHeaderFooterStyle(e,tD.Artist).template=i;break;case"Header/ArtistAlignment":iW.getOrCreateHeaderFooterStyle(e,tD.Artist).textAlign=this.toTextAlign(i);break;case"Header/drawArtist":iW.getOrCreateHeaderFooterStyle(e,tD.Artist).isVisible=i;break;case"Header/Album":iW.getOrCreateHeaderFooterStyle(e,tD.Album).template=i;break;case"Header/AlbumAlignment":iW.getOrCreateHeaderFooterStyle(e,tD.Album).textAlign=this.toTextAlign(i);break;case"Header/drawAlbum":iW.getOrCreateHeaderFooterStyle(e,tD.Album).isVisible=i;break;case"Header/Words":iW.getOrCreateHeaderFooterStyle(e,tD.Words).template=i;break;case"Header/WordsAlignment":iW.getOrCreateHeaderFooterStyle(e,tD.Words).textAlign=this.toTextAlign(i);break;case"Header/drawWords":iW.getOrCreateHeaderFooterStyle(e,tD.Words).isVisible=i;break;case"Header/Music":iW.getOrCreateHeaderFooterStyle(e,tD.Music).template=i;break;case"Header/MusicAlignment":iW.getOrCreateHeaderFooterStyle(e,tD.Music).textAlign=this.toTextAlign(i);break;case"Header/drawMusic":iW.getOrCreateHeaderFooterStyle(e,tD.Music).isVisible=i;break;case"Header/WordsAndMusic":iW.getOrCreateHeaderFooterStyle(e,tD.WordsAndMusic).template=i;break;case"Header/WordsAndMusicAlignment":iW.getOrCreateHeaderFooterStyle(e,tD.WordsAndMusic).textAlign=this.toTextAlign(i);break;case"Header/drawWordsAndMusic":iW.getOrCreateHeaderFooterStyle(e,tD.WordsAndMusic).isVisible=i;break;case"Header/Tabber":iW.getOrCreateHeaderFooterStyle(e,tD.Transcriber).template=i;break;case"Header/TabberAlignment":iW.getOrCreateHeaderFooterStyle(e,tD.Transcriber).textAlign=this.toTextAlign(i);break;case"Header/drawTabber":iW.getOrCreateHeaderFooterStyle(e,tD.Transcriber).isVisible=i;break;case"Footer/Copyright":iW.getOrCreateHeaderFooterStyle(e,tD.Copyright).template=i;break;case"Footer/CopyrightAlignment":iW.getOrCreateHeaderFooterStyle(e,tD.Copyright).textAlign=this.toTextAlign(i);break;case"Footer/drawCopyright":iW.getOrCreateHeaderFooterStyle(e,tD.Copyright).isVisible=i;break;case"Footer/Copyright2":iW.getOrCreateHeaderFooterStyle(e,tD.CopyrightSecondLine).template=i;break;case"Footer/Copyright2Alignment":iW.getOrCreateHeaderFooterStyle(e,tD.CopyrightSecondLine).textAlign=this.toTextAlign(i);break;case"Footer/drawCopyright2":iW.getOrCreateHeaderFooterStyle(e,tD.CopyrightSecondLine).isVisible=i}}toTextAlign(e){switch(e){case 0:break;case 1:return tS.Center;case 2:return tS.Right}return tS.Left}addValue(e,t,i){this.raw.set(e,t),void 0!==i&&this._types.set(e,i)}writeTo(e){for(let[t,i]of(sh.writeInt32BE(e,this.raw.size),this.raw)){let s=this.getDataType(t,i);switch(sg.gpWriteString(e,t),e.writeByte(s),s){case tW.Boolean:e.writeByte(+!!i);break;case tW.Integer:sh.writeInt32BE(e,i);break;case tW.Float:sh.writeFloat32BE(e,i);break;case tW.String:let a=sh.stringToBytes(i);sh.writeInt16BE(e,a.length),e.write(a,0,a.length);break;case tW.Point:case tW.Size:sh.writeInt32BE(e,i.offset),sh.writeInt32BE(e,i.value);break;case tW.Rectangle:sh.writeInt32BE(e,i.x),sh.writeInt32BE(e,i.y),sh.writeInt32BE(e,i.w),sh.writeInt32BE(e,i.h);break;case tW.Color:e.writeByte(i.r),e.writeByte(i.g),e.writeByte(i.b),e.writeByte(i.a)}}}getDataType(e,t){if(this._types.has(e))return this._types.get(e);switch(typeof t){case"string":return tW.String;case"number":return t===(0|t)?tW.Integer:tW.Float;case"object":if(t instanceof iF)return tW.Point;if(t instanceof sy)return tW.Rectangle;if(t instanceof si)return tW.Color}throw new i6(tE.General,`Unknown value type in BinaryStylesheet: ${typeof t}`)}static writeForScore(e){let t=new sb;switch(t.addValue("StandardNotation/hideDynamics",e.stylesheet.hideDynamics,tW.Boolean),t.addValue("System/bracketExtendMode",e.stylesheet.bracketExtendMode,tW.Integer),t.addValue("Global/useSystemSignSeparator",e.stylesheet.useSystemSignSeparator,tW.Boolean),t.addValue("Global/DisplayTuning",e.stylesheet.globalDisplayTuning,tW.Boolean),t.addValue("Global/DrawChords",e.stylesheet.globalDisplayChordDiagramsOnTop,tW.Boolean),e.stylesheet.singleTrackTrackNamePolicy){case eq.Hidden:t.addValue("System/showTrackNameSingle",!1,tW.Boolean);break;case eq.FirstSystem:t.addValue("System/trackNameModeSingle",0,tW.Integer);break;case eq.AllSystems:t.addValue("System/trackNameModeSingle",2,tW.Integer)}switch(e.stylesheet.multiTrackTrackNamePolicy){case eq.Hidden:t.addValue("System/showTrackNameMulti",!1,tW.Boolean);break;case eq.FirstSystem:t.addValue("System/trackNameModeMulti",0,tW.Integer);break;case eq.AllSystems:t.addValue("System/trackNameModeMulti",2,tW.Integer)}switch(e.stylesheet.firstSystemTrackNameMode){case e$.FullName:t.addValue("System/shortTrackNameOnFirstSystem",!1,tW.Boolean);break;case e$.ShortName:t.addValue("System/shortTrackNameOnFirstSystem",!0,tW.Boolean)}switch(e.stylesheet.otherSystemsTrackNameMode){case e$.FullName:t.addValue("System/shortTrackNameOnOtherSystems",!1,tW.Boolean);break;case e$.ShortName:t.addValue("System/shortTrackNameOnOtherSystems",!0,tW.Boolean)}switch(e.stylesheet.firstSystemTrackNameOrientation){case ej.Horizontal:t.addValue("System/horizontalTrackNameOnFirstSystem",!0,tW.Boolean);break;case ej.Vertical:t.addValue("System/horizontalTrackNameOnFirstSystem",!1,tW.Boolean)}switch(e.stylesheet.otherSystemsTrackNameOrientation){case ej.Horizontal:t.addValue("System/horizontalTrackNameOnOtherSystems",!0,tW.Boolean);break;case ej.Vertical:t.addValue("System/horizontalTrackNameOnOtherSystems",!1,tW.Boolean)}let i=e.style;if(i)for(let[e,s]of i.headerAndFooter)switch(e){case tD.Title:sb.addHeaderAndFooter(t,s,"Header/","Title");break;case tD.SubTitle:sb.addHeaderAndFooter(t,s,"Header/","Subtitle");break;case tD.Artist:sb.addHeaderAndFooter(t,s,"Header/","Artist");break;case tD.Album:sb.addHeaderAndFooter(t,s,"Header/","Album");break;case tD.Words:sb.addHeaderAndFooter(t,s,"Header/","Words");break;case tD.Music:sb.addHeaderAndFooter(t,s,"Header/","Music");break;case tD.WordsAndMusic:sb.addHeaderAndFooter(t,s,"Header/","WordsAndMusic");break;case tD.Transcriber:sb.addHeaderAndFooter(t,s,"Header/","Tabber");break;case tD.Copyright:sb.addHeaderAndFooter(t,s,"Footer/","Copyright");break;case tD.CopyrightSecondLine:sb.addHeaderAndFooter(t,s,"Footer/","Copyright2")}let s=sd.withCapacity(128);return t.writeTo(s),s.toArray()}static addHeaderAndFooter(e,t,i,s){e.addValue(`${i}${s}`,t.template,tW.String),e.addValue(`${i}${s}Alignment`,t.textAlign,tW.Integer),void 0!==t.isVisible&&e.addValue(`${i}draw${s}`,t.isVisible,tW.Boolean)}}(el=tG||(tG={}))[el.None=0]="None",el[el.Element=1]="Element",el[el.Text=2]="Text",el[el.CDATA=3]="CDATA",el[el.Document=4]="Document",el[el.DocumentType=5]="DocumentType",el[el.Comment=6]="Comment";class sS{constructor(){this.nodeType=tG.None,this.localName=null,this.value=null,this.childNodes=[],this.attributes=new Map,this.firstChild=null,this.firstElement=null}*childElements(){for(let e of this.childNodes)e.nodeType===tG.Element&&(yield e)}addChild(e){this.childNodes.push(e),this.firstChild=e,(e.nodeType===tG.Element||e.nodeType===tG.CDATA)&&(this.firstElement=e)}getAttribute(e,t=""){return this.attributes.has(e)?this.attributes.get(e):t}getElementsByTagName(e,t=!1){let i=[];return this.searchElementsByTagName(this.childNodes,i,e,t),i}searchElementsByTagName(e,t,i,s=!1){for(let a of e)a&&a.nodeType===tG.Element&&a.localName===i&&t.push(a),s&&this.searchElementsByTagName(a.childNodes,t,i,!0)}findChildElement(e){for(let t of this.childNodes)if(t&&t.nodeType===tG.Element&&t.localName===e)return t;return null}addElement(e){let t=new sS;return t.nodeType=tG.Element,t.localName=e,this.addChild(t),t}get innerText(){if(this.nodeType===tG.Element||this.nodeType===tG.Document){if(this.firstElement&&this.firstElement.nodeType===tG.CDATA)return this.firstElement.innerText;let e="";for(let t of this.childNodes)e+=t.innerText?.toString();return e.trim()}return this.value??""}set innerText(e){let t=new sS;t.nodeType=tG.Text,t.value=e,this.childNodes=[t]}setCData(e){let t=new sS;t.nodeType=tG.CDATA,t.value=e,this.childNodes=[t]}}class s_ extends i6{constructor(e,t,i){super(tE.Format,e),this.pos=0,this.xml=t,this.pos=i,Object.setPrototypeOf(this,s_.prototype)}}(eh=tz||(tz={}))[eh.IgnoreSpaces=0]="IgnoreSpaces",eh[eh.Begin=1]="Begin",eh[eh.BeginNode=2]="BeginNode",eh[eh.TagName=3]="TagName",eh[eh.Body=4]="Body",eh[eh.AttribName=5]="AttribName",eh[eh.Equals=6]="Equals",eh[eh.AttvalBegin=7]="AttvalBegin",eh[eh.AttribVal=8]="AttribVal",eh[eh.Childs=9]="Childs",eh[eh.Close=10]="Close",eh[eh.WaitEnd=11]="WaitEnd",eh[eh.WaitEndRet=12]="WaitEndRet",eh[eh.Pcdata=13]="Pcdata",eh[eh.Header=14]="Header",eh[eh.Comment=15]="Comment",eh[eh.Doctype=16]="Doctype",eh[eh.Cdata=17]="Cdata",eh[eh.Escape=18]="Escape";class sw{static parse(e,t,i){let s=e.charCodeAt(t),a=tz.Begin,r=tz.Begin,n=0,o="",l=tz.Begin,h=null,d=null,c=0,u=0;for(;t<e.length;){switch(s=e.charCodeAt(t),a){case tz.IgnoreSpaces:switch(s){case sw.CharCodeLF:case sw.CharCodeCR:case sw.CharCodeTab:case sw.CharCodeSpace:break;default:a=r;continue}break;case tz.Begin:if(s===sw.CharCodeLowerThan)a=tz.IgnoreSpaces,r=tz.BeginNode;else{n=t,a=tz.Pcdata;continue}break;case tz.Pcdata:if(s===sw.CharCodeLowerThan){o+=e.substr(n,t-n);let s=new sS;s.nodeType=tG.Text,s.value=o,o="",i.addChild(s),a=tz.IgnoreSpaces,r=tz.BeginNode}else s===sw.CharCodeAmp&&(o+=e.substr(n,t-n),a=tz.Escape,l=tz.Pcdata,n=t+1);break;case tz.Cdata:if(s===sw.CharCodeBrackedClose&&e.charCodeAt(t+1)===sw.CharCodeBrackedClose&&e.charCodeAt(t+2)===sw.CharCodeGreaterThan){let s=new sS;s.nodeType=tG.CDATA,s.value=e.substr(n,t-n),i.addChild(s),t+=2,a=tz.Begin}break;case tz.BeginNode:switch(s){case sw.CharCodeExclamation:if(e.charCodeAt(t+1)===sw.CharCodeBrackedOpen){if(t+=2,"CDATA["!==e.substr(t,6).toUpperCase())throw new s_("Expected <![CDATA[",e,t);t+=5,a=tz.Cdata,n=t+1}else if(e.charCodeAt(t+1)===sw.CharCodeUpperD||e.charCodeAt(t+1)===sw.CharCodeLowerD){if("OCTYPE"!==e.substr(t+2,6).toUpperCase())throw new s_("Expected <!DOCTYPE",e,t);t+=8,a=tz.Doctype,n=t+1}else if(e.charCodeAt(t+1)!==sw.CharCodeMinus||e.charCodeAt(t+2)!==sw.CharCodeMinus)throw new s_("Expected <!--",e,t);else t+=2,a=tz.Comment,n=t+1;break;case sw.CharCodeQuestion:a=tz.Header,n=t;break;case sw.CharCodeSlash:if(!i)throw new s_("Expected node name",e,t);n=t+1,a=tz.IgnoreSpaces,r=tz.Close;break;default:a=tz.TagName,n=t;continue}break;case tz.TagName:if(!sw.isValidChar(s)){if(t===n)throw new s_("Expected node name",e,t);(h=new sS).nodeType=tG.Element,h.localName=e.substr(n,t-n),i.addChild(h),a=tz.IgnoreSpaces,r=tz.Body;continue}break;case tz.Body:switch(s){case sw.CharCodeSlash:a=tz.WaitEnd;break;case sw.CharCodeGreaterThan:a=tz.Childs;break;default:a=tz.AttribName,n=t;continue}break;case tz.AttribName:if(!sw.isValidChar(s)){if(n===t)throw new s_("Expected attribute name",e,t);if(d=e.substr(n,t-n),h.attributes.has(d))throw new s_(`Duplicate attribute [${d}]`,e,t);a=tz.IgnoreSpaces,r=tz.Equals;continue}break;case tz.Equals:if(s===sw.CharCodeEquals)a=tz.IgnoreSpaces,r=tz.AttvalBegin;else throw new s_("Expected =",e,t);break;case tz.AttvalBegin:switch(s){case sw.CharCodeDoubleQuote:case sw.CharCodeSingleQuote:o="",a=tz.AttribVal,n=t+1,u=s}break;case tz.AttribVal:if(s===sw.CharCodeAmp)o+=e.substr(n,t-n),a=tz.Escape,l=tz.AttribVal,n=t+1;else if(s===u){let i=o+=e.substr(n,t-n);o="",h.attributes.set(d,i),a=tz.IgnoreSpaces,r=tz.Body}break;case tz.Childs:n=t=sw.parse(e,t,h),a=tz.Begin;break;case tz.WaitEnd:if(s===sw.CharCodeGreaterThan)a=tz.Begin;else throw new s_("Expected >",e,t);break;case tz.WaitEndRet:if(s===sw.CharCodeGreaterThan)return t;throw new s_("Expected >",e,t);case tz.Close:if(!sw.isValidChar(s)){if(n===t)throw new s_("Expected node name",e,t);if(e.substr(n,t-n)!==i.localName)throw new s_(`Expected </${i.localName}>`,e,t);a=tz.IgnoreSpaces,r=tz.WaitEndRet;continue}break;case tz.Comment:s===sw.CharCodeMinus&&e.charCodeAt(t+1)===sw.CharCodeMinus&&e.charCodeAt(t+2)===sw.CharCodeGreaterThan&&(t+=2,a=tz.Begin);break;case tz.Doctype:if(s===sw.CharCodeBrackedOpen)c++;else if(s===sw.CharCodeBrackedClose)c--;else if(s===sw.CharCodeGreaterThan&&0===c){let s=new sS;s.nodeType=tG.DocumentType,s.value=e.substr(n,t-n),i.addChild(s),a=tz.Begin}break;case tz.Header:s===sw.CharCodeQuestion&&e.charCodeAt(t+1)===sw.CharCodeGreaterThan&&(t++,a=tz.Begin);break;case tz.Escape:if(s===sw.CharCodeSemi){let i=e.substr(n,t-n);i.charCodeAt(0)===sw.CharCodeSharp?o+=String.fromCharCode(i.charCodeAt(1)===sw.CharCodeLowerX?Number.parseInt(`0${i.substr(1,i.length-1)}`):Number.parseInt(i.substr(1,i.length-1))):sw.Escapes.has(i)?o+=sw.Escapes.get(i):o+=`&${i};`?.toString(),n=t+1,a=l}else sw.isValidChar(s)||s===sw.CharCodeSharp||(o+="&",o+=e.substr(n,t-n),n=--t+1,a=l)}t++}if(a===tz.Begin&&(n=t,a=tz.Pcdata),a===tz.Pcdata){if(t!==n){o+=e.substr(n,t-n);let s=new sS;s.nodeType=tG.Text,s.value=o,i.addChild(s)}return t}if(a===tz.Escape&&l===tz.Pcdata){o+="&",o+=e.substr(n,t-n);let s=new sS;return s.nodeType=tG.Text,s.value=o,i.addChild(s),t}throw new s_("Unexpected end",e,t)}static isValidChar(e){return e>=sw.CharCodeLowerA&&e<=sw.CharCodeLowerZ||e>=sw.CharCodeUpperA&&e<=sw.CharCodeUpperZ||e>=sw.CharCode0&&e<=sw.CharCode9||e===sw.CharCodeColon||e===sw.CharCodeDot||e===sw.CharCodeUnderscore||e===sw.CharCodeMinus}}sw.CharCodeLF=10,sw.CharCodeTab=9,sw.CharCodeCR=13,sw.CharCodeSpace=32,sw.CharCodeLowerThan=60,sw.CharCodeAmp=38,sw.CharCodeBrackedClose=93,sw.CharCodeBrackedOpen=91,sw.CharCodeGreaterThan=62,sw.CharCodeExclamation=33,sw.CharCodeUpperD=68,sw.CharCodeLowerD=100,sw.CharCodeMinus=45,sw.CharCodeQuestion=63,sw.CharCodeSlash=47,sw.CharCodeEquals=61,sw.CharCodeDoubleQuote=34,sw.CharCodeSingleQuote=39,sw.CharCodeSharp=35,sw.CharCodeLowerX=120,sw.CharCodeLowerA=97,sw.CharCodeLowerZ=122,sw.CharCodeUpperA=65,sw.CharCodeUpperZ=90,sw.CharCode0=48,sw.CharCode9=57,sw.CharCodeColon=58,sw.CharCodeDot=46,sw.CharCodeUnderscore=95,sw.CharCodeSemi=59,sw.Escapes=new Map([["lt","<"],["gt",">"],["amp","&"],["quot",'"'],["apos","'"]]);class sk{static write(e,t,i){let s=new sk(t,i);return s.writeNode(e),s.toString()}constructor(e,t){this._result=[],this._indention=e,this._xmlHeader=t,this._currentIndention="",this._isStartOfLine=!0}writeNode(e){switch(e.nodeType){case tG.None:break;case tG.Element:for(let[t,i]of(this._result.length>0&&this.writeLine(),this.write(`<${e.localName}`),e.attributes))this.write(` ${t}="`),this.writeAttributeValue(i),this.write('"');if(0===e.childNodes.length)this.write("/>");else{if(this.write(">"),1!==e.childNodes.length||e.firstElement){for(let t of(this.indent(),e.childNodes))(t.nodeType===tG.Element||t.nodeType===tG.Comment)&&this.writeNode(t);this.unindend(),this.writeLine()}else this.writeNode(e.childNodes[0]);this.write(`</${e.localName}>`)}break;case tG.Text:e.value&&this.write(e.value);break;case tG.CDATA:null!==e.value&&this.write(`<![CDATA[${e.value}]]>`);break;case tG.Document:for(let t of(this._xmlHeader&&this.write('<?xml version="1.0" encoding="utf-8"?>'),e.childNodes))this.writeNode(t);break;case tG.DocumentType:this.write(`<!DOCTYPE ${e.value}>`);break;case tG.Comment:this.write(`<!-- ${e.value} -->`)}}unindend(){this._currentIndention=this._currentIndention.substr(0,this._currentIndention.length-this._indention.length)}indent(){this._currentIndention+=this._indention}writeAttributeValue(e){for(let t=0;t<e.length;t++){let i=e.charAt(t);switch(i){case"<":this._result.push("&lt;");break;case">":this._result.push("&gt;");break;case"&":this._result.push("&amp;");break;case"'":this._result.push("&apos;");break;case'"':this._result.push("&quot;");break;default:this._result.push(i)}}}write(e){this._isStartOfLine&&this._result.push(this._currentIndention),this._result.push(e),this._isStartOfLine=!1}writeLine(e=null){e&&this.write(e),this._indention.length>0&&!this._isStartOfLine&&(this._result.push("\n"),this._isStartOfLine=!0)}toString(){return this._result.join("").trimRight()}}class sB extends sS{constructor(){super(),this.nodeType=tG.Document}parse(e){sw.parse(e,0,this)}toString(){return this.toFormattedString()}toFormattedString(e="",t=!1){return sk.write(this,e,t)}}class sT{}class sN{constructor(){this.id="",this.dots=0,this.tupletDenominator=-1,this.tupletNumerator=-1,this.value=tt.Quarter}}class sx{constructor(){this.name="",this.path="",this.role="",this.program=0}get uniqueId(){return`${this.path};${this.name};${this.role}`}}class sP{constructor(){this._hasAnacrusis=!1,this._skipApplyLyrics=!1,this._backingTrackPadding=0,this._doubleBars=new Set,this._keySignatures=new Map}parseXml(e,t){this._masterTrackAutomations=new Map,this._automationsPerTrackIdAndBarIndex=new Map,this._sustainPedalsPerTrackIdAndBarIndex=new Map,this._tracksMapping=[],this._tracksById=new Map,this._masterBars=[],this._barsOfMasterBar=[],this._voicesOfBar=new Map,this._barsById=new Map,this._voiceById=new Map,this._beatsOfVoice=new Map,this._beatById=new Map,this._rhythmOfBeat=new Map,this._rhythmById=new Map,this._notesOfBeat=new Map,this._noteById=new Map,this._tappedNotes=new Map,this._lyricsByTrack=new Map,this._soundsByTrack=new Map,this._skipApplyLyrics=!1;let i=new sB;try{i.parse(e)}catch(e){throw new i8("Could not parse XML",e)}if(this.parseDom(i),this.buildModel(),iW.consolidate(this.score),this.score.finish(t),!this._skipApplyLyrics&&this._lyricsByTrack.size>0)for(let[e,t]of this._lyricsByTrack)this._tracksById.get(e).applyLyrics(t)}parseDom(e){let t=e.firstElement;if(t)if("GPIF"===t.localName)for(let e of(this.score=new i3,t.childElements()))switch(e.localName){case"Score":this.parseScoreNode(e);break;case"MasterTrack":this.parseMasterTrackNode(e);break;case"BackingTrack":this.parseBackingTrackNode(e);break;case"Tracks":this.parseTracksNode(e);break;case"MasterBars":this.parseMasterBarsNode(e);break;case"Bars":this.parseBars(e);break;case"Voices":this.parseVoices(e);break;case"Beats":this.parseBeats(e);break;case"Notes":this.parseNotes(e);break;case"Rhythms":this.parseRhythms(e);break;case"Assets":this.parseAssets(e)}else throw new i8("Root node of XML was not GPIF")}parseAssets(e){for(let t of e.childElements())"Asset"===t.localName&&t.getAttribute("id")===this._backingTrackAssetId&&this.parseBackingTrackAsset(t)}parseBackingTrackAsset(e){let t="";for(let i of e.childElements())"EmbeddedFilePath"===i.localName&&(t=i.innerText);let i=this.loadAsset;if(i){let e=i(t);e?this.score.backingTrack.rawAudioFile=e:this.score.backingTrack=void 0}}parseScoreNode(e){for(let t of e.childElements())switch(t.localName){case"Title":this.score.title=t.innerText;break;case"SubTitle":this.score.subTitle=t.innerText;break;case"Artist":this.score.artist=t.innerText;break;case"Album":this.score.album=t.innerText;break;case"Words":this.score.words=t.innerText;break;case"Music":this.score.music=t.innerText;break;case"WordsAndMusic":let e=t.innerText;""!==e&&(e&&!this.score.words&&(this.score.words=e),e&&!this.score.music&&(this.score.music=e));break;case"Copyright":this.score.copyright=t.innerText;break;case"Tabber":this.score.tab=t.innerText;break;case"Instructions":this.score.instructions=t.innerText;break;case"Notices":this.score.notices=t.innerText;break;case"ScoreSystemsDefaultLayout":this.score.defaultSystemsLayout=sP.parseIntSafe(t.innerText,4);break;case"ScoreSystemsLayout":this.score.systemsLayout=sP.splitSafe(t.innerText).map(e=>sP.parseIntSafe(e,4))}}static parseIntSafe(e,t){if(!e)return t;let i=Number.parseInt(e);return Number.isNaN(i)?t:i}static parseFloatSafe(e,t){if(!e)return t;let i=Number.parseFloat(e);return Number.isNaN(i)?t:i}static splitSafe(e,t=" "){return e?e.split(t).map(e=>e.trim()).filter(e=>e.length>0):[]}parseBackingTrackNode(e){let t=new sT,i=!1,s="",a="";for(let t of e.childElements())switch(t.localName){case"Enabled":i="true"===t.innerText;break;case"Source":s=t.innerText;break;case"AssetId":a=t.innerText;break;case"FramePadding":this._backingTrackPadding=sP.parseIntSafe(t.innerText,0)/sP.SampleRate*1e3}i&&"Local"===s&&(this.score.backingTrack=t,this._backingTrackAssetId=a)}parseMasterTrackNode(e){for(let t of e.childElements())switch(t.localName){case"Automations":this.parseAutomations(t,this._masterTrackAutomations,null,null);break;case"Tracks":this._tracksMapping=sP.splitSafe(t.innerText);break;case"Anacrusis":this._hasAnacrusis=!0}}parseAutomations(e,t,i,s){for(let a of e.childElements())"Automation"===a.localName&&this.parseAutomation(a,t,i,s)}parseAutomation(e,t,i,s){let a,r=null,n=!1,o=-1,l=0,h=0,d=null,c=0,u=null;for(let t of e.childElements())switch(t.localName){case"Type":r=t.innerText;break;case"Linear":n="true"===t.innerText.toLowerCase();break;case"Bar":o=sP.parseIntSafe(t.innerText,0);break;case"Position":l=sP.parseFloatSafe(t.innerText,0);break;case"Value":if(t.firstElement&&t.firstElement.nodeType===tG.CDATA)d=t.innerText;else if(t.firstElement&&t.firstElement.nodeType===tG.Element&&"SyncPoint"===r)for(let e of(a=new iP,t.childElements()))switch(e.localName){case"BarIndex":o=sP.parseIntSafe(e.innerText,0);break;case"BarOccurrence":a.barOccurence=sP.parseIntSafe(e.innerText,0);break;case"FrameOffset":let t=sP.parseFloatSafe(e.innerText,0);a.millisecondOffset=t/sP.SampleRate*1e3}else{let e=sP.splitSafe(t.innerText);1===e.length?(h=sP.parseFloatSafe(e[0],0),c=1):(h=sP.parseFloatSafe(e[0],0),c=sP.parseIntSafe(e[1],0))}break;case"Text":u=t.innerText}if(!r)return;let p=null;switch(r){case"Tempo":p=iv.buildTempoAutomation(n,l,h,c);break;case"SyncPoint":(p=new iv).type=e6.SyncPoint,p.isLinear=n,p.ratioPosition=l,p.syncPointValue=a;break;case"Sound":d&&i&&i.has(d)&&(p=iv.buildInstrumentAutomation(n,l,i.get(d).program));break;case"SustainPedal":if(s){let e;s.has(o)?e=s.get(o):(e=[],s.set(o,e));let t=new iB;switch(t.ratioPosition=l,c){case 1:t.pedalType=e2.Down;break;case 3:t.pedalType=e2.Up}e.push(t)}}p&&(u&&(p.text=u),o>=0&&(t.has(o)||t.set(o,[]),t.get(o).push(p)))}parseTracksNode(e){for(let t of e.childElements())"Track"===t.localName&&this.parseTrack(t)}parseTrack(e){this._articulationByName=new Map;let t=new so;t.ensureStaveCount(1),t.staves[0].showStandardNotation=!0;let i=e.getAttribute("id");for(let s of e.childElements())switch(s.localName){case"Name":t.name=s.innerText;break;case"Color":let e=sP.splitSafe(s.innerText);e.length>=3&&(t.color=new si(sP.parseIntSafe(e[0],0),sP.parseIntSafe(e[1],0),sP.parseIntSafe(e[2],0),255));break;case"Instrument":let a=s.getAttribute("ref");(a.endsWith("-gs")||a.endsWith("GrandStaff"))&&(t.ensureStaveCount(2),t.staves[1].showStandardNotation=!0);break;case"InstrumentSet":this.parseInstrumentSet(t,s);break;case"NotationPatch":this.parseNotationPatch(t,s);break;case"ShortName":t.shortName=s.innerText;break;case"SystemsDefautLayout":t.defaultSystemsLayout=sP.parseIntSafe(s.innerText,4);break;case"SystemsLayout":t.systemsLayout=sP.splitSafe(s.innerText).map(e=>sP.parseIntSafe(e,4));break;case"Lyrics":this.parseLyrics(i,s);break;case"Properties":this.parseTrackProperties(t,s);break;case"GeneralMidi":case"MidiConnection":case"MIDISettings":this.parseGeneralMidi(t,s);break;case"Sounds":this.parseSounds(i,t,s);break;case"PlaybackState":let r=s.innerText;t.playbackInfo.isSolo="Solo"===r,t.playbackInfo.isMute="Mute"===r;break;case"PartSounding":this.parsePartSounding(t,s);break;case"Staves":this.parseStaves(t,s);break;case"Transpose":this.parseTranspose(t,s);break;case"RSE":this.parseRSE(t,s);break;case"Automations":this.parseTrackAutomations(i,s)}this._tracksById.set(i,t)}parseTrackAutomations(e,t){let i=new Map;this._automationsPerTrackIdAndBarIndex.set(e,i);let s=new Map;this._sustainPedalsPerTrackIdAndBarIndex.set(e,s),this.parseAutomations(t,i,this._soundsByTrack.get(e),s)}parseNotationPatch(e,t){for(let i of t.childElements())switch(i.localName){case"LineCount":let t=sP.parseIntSafe(i.innerText,5);for(let i of e.staves)i.standardNotationLineCount=t;break;case"Elements":this.parseElements(e,i)}}parseInstrumentSet(e,t){for(let i of t.childElements())switch(i.localName){case"Type":if("drumKit"===i.innerText)for(let t of e.staves)t.isPercussion=!0;break;case"Elements":this.parseElements(e,i);break;case"LineCount":let t=sP.parseIntSafe(i.innerText,5);for(let i of e.staves)i.standardNotationLineCount=t}}parseElements(e,t){for(let i of t.childElements())"Element"===i.localName&&this.parseElement(e,i)}parseElement(e,t){let i=t.findChildElement("Type")?.innerText??"";for(let s of t.childElements())switch(s.localName){case"Name":case"Articulations":this.parseArticulations(e,s,i)}}parseArticulations(e,t,i){for(let s of t.childElements())"Articulation"===s.localName&&this.parseArticulation(e,s,i)}parseArticulation(e,t,i){let s=new iz;s.outputMidiNumber=-1,s.elementType=i;let a="";for(let e of t.childElements()){let t=e.innerText;switch(e.localName){case"Name":a=e.innerText;break;case"OutputMidiNumber":s.outputMidiNumber=sP.parseIntSafe(t,0);break;case"TechniqueSymbol":s.techniqueSymbol=this.parseTechniqueSymbol(t);break;case"TechniquePlacement":switch(t){case"outside":case"above":s.techniqueSymbolPlacement=t_.Bottom;break;case"inside":s.techniqueSymbolPlacement=t_.Middle;break;case"below":s.techniqueSymbolPlacement=t_.Top}break;case"Noteheads":let i=sP.splitSafe(t);i.length>=1&&(s.noteHeadDefault=this.parseNoteHead(i[0])),i.length>=2&&(s.noteHeadHalf=this.parseNoteHead(i[1])),i.length>=3&&(s.noteHeadWhole=this.parseNoteHead(i[2])),s.noteHeadHalf===tb.None&&(s.noteHeadHalf=s.noteHeadDefault),s.noteHeadWhole===tb.None&&(s.noteHeadWhole=s.noteHeadDefault);break;case"StaffLine":s.staffLine=sP.parseIntSafe(t,0)}}-1!==s.outputMidiNumber?(e.percussionArticulations.push(s),a.length>0&&this._articulationByName.set(a,s)):a.length>0&&this._articulationByName.has(a)&&(this._articulationByName.get(a).staffLine=s.staffLine)}parseTechniqueSymbol(e){switch(e){case"pictEdgeOfCymbal":return tb.PictEdgeOfCymbal;case"articStaccatoAbove":return tb.ArticStaccatoAbove;case"noteheadParenthesis":return tb.NoteheadParenthesis;case"stringsUpBow":return tb.StringsUpBow;case"stringsDownBow":return tb.StringsDownBow;case"guitarGolpe":return tb.GuitarGolpe;default:return tb.None}}parseNoteHead(e){switch(e){case"noteheadDoubleWholeSquare":return tb.NoteheadDoubleWholeSquare;case"noteheadDoubleWhole":return tb.NoteheadDoubleWhole;case"noteheadWhole":return tb.NoteheadWhole;case"noteheadHalf":return tb.NoteheadHalf;case"noteheadBlack":return tb.NoteheadBlack;case"noteheadNull":return tb.NoteheadNull;case"noteheadXOrnate":return tb.NoteheadXOrnate;case"noteheadTriangleUpWhole":return tb.NoteheadTriangleUpWhole;case"noteheadTriangleUpHalf":return tb.NoteheadTriangleUpHalf;case"noteheadTriangleUpBlack":return tb.NoteheadTriangleUpBlack;case"noteheadDiamondBlackWide":return tb.NoteheadDiamondBlackWide;case"noteheadDiamondWhite":return tb.NoteheadDiamondWhite;case"noteheadDiamondWhiteWide":return tb.NoteheadDiamondWhiteWide;case"noteheadCircleX":return tb.NoteheadCircleX;case"noteheadXWhole":return tb.NoteheadXWhole;case"noteheadXHalf":return tb.NoteheadXHalf;case"noteheadXBlack":return tb.NoteheadXBlack;case"noteheadParenthesis":return tb.NoteheadParenthesis;case"noteheadSlashedBlack2":return tb.NoteheadSlashedBlack2;case"noteheadCircleSlash":return tb.NoteheadCircleSlash;case"noteheadHeavyX":return tb.NoteheadHeavyX;case"noteheadHeavyXHat":return tb.NoteheadHeavyXHat;default:return iM.warning("GPIF","Unknown notehead symbol",e),tb.None}}parseStaves(e,t){let i=0;for(let s of t.childElements())if("Staff"===s.localName){e.ensureStaveCount(i+1);let t=e.staves[i];this.parseStaff(t,s),i++}}parseStaff(e,t){for(let i of t.childElements())"Properties"===i.localName&&this.parseStaffProperties(e,i)}parseStaffProperties(e,t){for(let i of t.childElements())"Property"===i.localName&&this.parseStaffProperty(e,i)}parseStaffProperty(e,t){switch(t.getAttribute("name")){case"Tuning":for(let i of t.childElements())switch(i.localName){case"Pitches":let s=sP.splitSafe(t.findChildElement("Pitches")?.innerText),a=Array(s.length);for(let e=0;e<a.length;e++)a[a.length-1-e]=sP.parseIntSafe(s[e],0);e.stringTuning.tunings=a;break;case"Label":e.stringTuning.name=i.innerText}e.isPercussion||(e.showTablature=!0);break;case"DiagramCollection":case"ChordCollection":this.parseDiagramCollectionForStaff(e,t);break;case"CapoFret":e.capo=sP.parseIntSafe(t.findChildElement("Fret")?.innerText,0)}}parseLyrics(e,t){let i=[];for(let e of t.childElements())"Line"===e.localName&&i.push(this.parseLyricsLine(e));this._lyricsByTrack.set(e,i)}parseLyricsLine(e){let t=new i9;for(let i of e.childElements())switch(i.localName){case"Offset":t.startBar=sP.parseIntSafe(i.innerText,0);break;case"Text":t.text=i.innerText}return t}parseDiagramCollectionForTrack(e,t){let i=t.findChildElement("Items");if(i)for(let t of i.childElements())"Item"===t.localName&&this.parseDiagramItemForTrack(e,t)}parseDiagramCollectionForStaff(e,t){let i=t.findChildElement("Items");if(i)for(let t of i.childElements())"Item"===t.localName&&this.parseDiagramItemForStaff(e,t)}parseDiagramItemForTrack(e,t){let i=new i7,s=t.getAttribute("id");for(let t of e.staves)t.addChord(s,i);this.parseDiagramItemForChord(i,t)}parseDiagramItemForStaff(e,t){let i=new i7,s=t.getAttribute("id");e.addChord(s,i),this.parseDiagramItemForChord(i,t)}parseDiagramItemForChord(e,t){e.name=t.getAttribute("name");let i=t.findChildElement("Diagram");if(!i){e.showDiagram=!1,e.showFingering=!1;return}let s=sP.parseIntSafe(i.getAttribute("stringCount"),6),a=sP.parseIntSafe(i.getAttribute("baseFret"),0);e.firstFret=a+1;for(let t=0;t<s;t++)e.strings.push(-1);for(let t of i.childElements())switch(t.localName){case"Fret":let i=sP.parseIntSafe(t.getAttribute("string"),0);e.strings[s-i-1]=a+sP.parseIntSafe(t.getAttribute("fret"),0);break;case"Fingering":let r=new Map;for(let i of t.childElements())if("Position"===i.localName){let t=ta.Unknown,s=a+sP.parseIntSafe(i.getAttribute("fret"),0);switch(i.getAttribute("finger")){case"Index":t=ta.IndexFinger;break;case"Middle":t=ta.MiddleFinger;break;case"Rank":t=ta.AnnularFinger;break;case"Pinky":t=ta.LittleFinger;break;case"Thumb":t=ta.Thumb}t!==ta.Unknown&&(r.has(t)?e.barreFrets.push(s):r.set(t,!0))}break;case"Property":switch(t.getAttribute("name")){case"ShowName":e.showName="true"===t.getAttribute("value");break;case"ShowDiagram":e.showDiagram="true"===t.getAttribute("value");break;case"ShowFingering":e.showFingering="true"===t.getAttribute("value")}}}parseTrackProperties(e,t){for(let i of t.childElements())"Property"===i.localName&&this.parseTrackProperty(e,i)}parseTrackProperty(e,t){switch(t.getAttribute("name")){case"Tuning":let i=sP.splitSafe(t.findChildElement("Pitches")?.innerText),s=Array(i.length);for(let e=0;e<s.length;e++)s[s.length-1-e]=sP.parseIntSafe(i[e],0);for(let t of e.staves)t.stringTuning.tunings=s,t.showStandardNotation=!0,t.showTablature=!0;break;case"DiagramCollection":case"ChordCollection":this.parseDiagramCollectionForTrack(e,t);break;case"CapoFret":let a=sP.parseIntSafe(t.findChildElement("Fret")?.innerText,0);for(let t of e.staves)t.capo=a}}parseGeneralMidi(e,t){for(let i of t.childElements())switch(i.localName){case"Program":e.playbackInfo.program=sP.parseIntSafe(i.innerText,0);break;case"Port":e.playbackInfo.port=sP.parseIntSafe(i.innerText,0);break;case"PrimaryChannel":e.playbackInfo.primaryChannel=sP.parseIntSafe(i.innerText,0);break;case"SecondaryChannel":e.playbackInfo.secondaryChannel=sP.parseIntSafe(i.innerText,0)}if("Percussion"===t.getAttribute("table"))for(let t of e.staves)t.isPercussion=!0}parseSounds(e,t,i){for(let s of i.childElements())"Sound"===s.localName&&this.parseSound(e,t,s)}parseSound(e,t,i){let s=new sx;for(let e of i.childElements())switch(e.localName){case"Name":s.name=e.innerText;break;case"Path":s.path=e.innerText;break;case"Role":s.role=e.innerText;break;case"MIDI":this.parseSoundMidi(s,e)}("Factory"===s.role||0===t.playbackInfo.program)&&(t.playbackInfo.program=s.program),this._soundsByTrack.has(e)||this._soundsByTrack.set(e,new Map),this._soundsByTrack.get(e).set(s.uniqueId,s)}parseSoundMidi(e,t){for(let i of t.childElements())"Program"===i.localName&&(e.program=sP.parseIntSafe(i.innerText,0))}parsePartSounding(e,t){for(let i of t.childElements())if("TranspositionPitch"===i.localName)for(let t of e.staves)t.displayTranspositionPitch=sP.parseIntSafe(i.innerText,0)}parseTranspose(e,t){let i=0,s=0;for(let e of t.childElements())switch(e.localName){case"Chromatic":s=sP.parseIntSafe(e.innerText,0);break;case"Octave":i=sP.parseIntSafe(e.innerText,0)}for(let t of e.staves)t.displayTranspositionPitch=12*i+s}parseRSE(e,t){for(let i of t.childElements())"ChannelStrip"===i.localName&&this.parseChannelStrip(e,i)}parseChannelStrip(e,t){for(let i of t.childElements())"Parameters"===i.localName&&this.parseChannelStripParameters(e,i)}parseChannelStripParameters(e,t){if(t.firstChild&&t.firstChild.value){let i=sP.splitSafe(t.firstChild.value);i.length>=12&&(e.playbackInfo.balance=Math.floor(16*sP.parseFloatSafe(i[11],.5)),e.playbackInfo.volume=Math.floor(16*sP.parseFloatSafe(i[12],.9)))}}parseMasterBarsNode(e){for(let t of e.childElements())"MasterBar"===t.localName&&this.parseMasterBar(t)}parseMasterBar(e){let t=new iL;for(let i of(0===this._masterBars.length&&this._hasAnacrusis&&(t.isAnacrusis=!0),e.childElements()))switch(i.localName){case"Time":let e=i.innerText.split("/");t.timeSignatureNumerator=sP.parseIntSafe(e[0],4),t.timeSignatureDenominator=sP.parseIntSafe(e[1],4);break;case"FreeTime":t.isFreeTime=!0;break;case"DoubleBar":t.isDoubleBar=!0,this._doubleBars.add(t);break;case"Section":t.section=new se,t.section.marker=i.findChildElement("Letter")?.innerText??"",t.section.text=i.findChildElement("Text")?.innerText??"";break;case"Repeat":"true"===i.getAttribute("start").toLowerCase()&&(t.isRepeatStart=!0),"true"===i.getAttribute("end").toLowerCase()&&i.getAttribute("count")&&(t.repeatCount=sP.parseIntSafe(i.getAttribute("count"),1));break;case"AlternateEndings":let s=sP.splitSafe(i.innerText),a=0;for(let e=0;e<s.length;e++)a|=1<<-1+sP.parseIntSafe(s[e],0);t.alternateEndings=a;break;case"Bars":this._barsOfMasterBar.push(sP.splitSafe(i.innerText));break;case"TripletFeel":switch(i.innerText){case"NoTripletFeel":t.tripletFeel=tg.NoTripletFeel;break;case"Triplet8th":t.tripletFeel=tg.Triplet8th;break;case"Triplet16th":t.tripletFeel=tg.Triplet16th;break;case"Dotted8th":t.tripletFeel=tg.Dotted8th;break;case"Dotted16th":t.tripletFeel=tg.Dotted16th;break;case"Scottish8th":t.tripletFeel=tg.Scottish8th;break;case"Scottish16th":t.tripletFeel=tg.Scottish16th}break;case"Key":let r=sP.parseIntSafe(i.findChildElement("AccidentalCount")?.innerText,0),n=i.findChildElement("Mode"),o=e1.Major;if(n)switch(n.innerText.toLowerCase()){case"major":o=e1.Major;break;case"minor":o=e1.Minor}this._keySignatures.set(this._masterBars.length,[r,o]);break;case"Fermatas":this.parseFermatas(t,i);break;case"XProperties":this.parseMasterBarXProperties(t,i);break;case"Directions":this.parseDirections(t,i)}this._masterBars.push(t)}parseDirections(e,t){for(let i of t.childElements())switch(i.localName){case"Target":switch(i.innerText){case"Coda":e.addDirection(tI.TargetCoda);break;case"DoubleCoda":e.addDirection(tI.TargetDoubleCoda);break;case"Segno":e.addDirection(tI.TargetSegno);break;case"SegnoSegno":e.addDirection(tI.TargetSegnoSegno);break;case"Fine":e.addDirection(tI.TargetFine)}break;case"Jump":switch(i.innerText){case"DaCapo":e.addDirection(tI.JumpDaCapo);break;case"DaCapoAlCoda":e.addDirection(tI.JumpDaCapoAlCoda);break;case"DaCapoAlDoubleCoda":e.addDirection(tI.JumpDaCapoAlDoubleCoda);break;case"DaCapoAlFine":e.addDirection(tI.JumpDaCapoAlFine);break;case"DaSegno":e.addDirection(tI.JumpDalSegno);break;case"DaSegnoAlCoda":e.addDirection(tI.JumpDalSegnoAlCoda);break;case"DaSegnoAlDoubleCoda":e.addDirection(tI.JumpDalSegnoAlDoubleCoda);break;case"DaSegnoAlFine":e.addDirection(tI.JumpDalSegnoAlFine);break;case"DaSegnoSegno":e.addDirection(tI.JumpDalSegnoSegno);break;case"DaSegnoSegnoAlCoda":e.addDirection(tI.JumpDalSegnoSegnoAlCoda);break;case"DaSegnoSegnoAlDoubleCoda":e.addDirection(tI.JumpDalSegnoSegnoAlDoubleCoda);break;case"DaSegnoSegnoAlFine":e.addDirection(tI.JumpDalSegnoSegnoAlFine);break;case"DaCoda":e.addDirection(tI.JumpDaCoda);break;case"DaDoubleCoda":e.addDirection(tI.JumpDaDoubleCoda)}}}parseFermatas(e,t){for(let i of t.childElements())"Fermata"===i.localName&&this.parseFermata(e,i)}parseFermata(e,t){let i=0,s=new sc;for(let e of t.childElements())switch(e.localName){case"Type":switch(e.innerText){case"Short":s.type=tA.Short;break;case"Medium":s.type=tA.Medium;break;case"Long":s.type=tA.Long}break;case"Length":s.length=sP.parseFloatSafe(e.innerText,0);break;case"Offset":let t=e.innerText.split("/");2===t.length&&(i=sP.parseIntSafe(t[0],4)/sP.parseIntSafe(t[1],4)*ix.QuarterTime|0)}e.addFermata(i,s)}parseBars(e){for(let t of e.childElements())"Bar"===t.localName&&this.parseBar(t)}parseBar(e){let t=new iN,i=e.getAttribute("id");for(let s of e.childElements())switch(s.localName){case"Voices":this._voicesOfBar.set(i,sP.splitSafe(s.innerText));break;case"Clef":switch(s.innerText){case"Neutral":t.clef=eK.Neutral;break;case"G2":t.clef=eK.G2;break;case"F4":t.clef=eK.F4;break;case"C4":t.clef=eK.C4;break;case"C3":t.clef=eK.C3}break;case"Ottavia":switch(s.innerText){case"8va":t.clefOttava=eQ._8va;break;case"15ma":t.clefOttava=eQ._15ma;break;case"8vb":t.clefOttava=eQ._8vb;break;case"15mb":t.clefOttava=eQ._15mb}break;case"SimileMark":switch(s.innerText){case"Simple":t.simileMark=eZ.Simple;break;case"FirstOfDouble":t.simileMark=eZ.FirstOfDouble;break;case"SecondOfDouble":t.simileMark=eZ.SecondOfDouble}break;case"XProperties":this.parseBarXProperties(s,t)}this._barsById.set(i,t)}parseVoices(e){for(let t of e.childElements())"Voice"===t.localName&&this.parseVoice(t)}parseVoice(e){let t=new iO,i=e.getAttribute("id");for(let t of e.childElements())"Beats"===t.localName&&this._beatsOfVoice.set(i,sP.splitSafe(t.innerText));this._voiceById.set(i,t)}parseBeats(e){for(let t of e.childElements())"Beat"===t.localName&&this.parseBeat(t)}parseBeat(e){let t=new i1,i=e.getAttribute("id");for(let s of e.childElements())switch(s.localName){case"Notes":this._notesOfBeat.set(i,sP.splitSafe(s.innerText));break;case"Rhythm":this._rhythmOfBeat.set(i,s.getAttribute("ref"));break;case"Fadding":switch(s.innerText){case"FadeIn":t.fade=tN.FadeIn;break;case"FadeOut":t.fade=tN.FadeOut;break;case"VolumeSwell":t.fade=tN.VolumeSwell}break;case"Tremolo":switch(s.innerText){case"1/2":t.tremoloSpeed=tt.Eighth;break;case"1/4":t.tremoloSpeed=tt.Sixteenth;break;case"1/8":t.tremoloSpeed=tt.ThirtySecond}break;case"Chord":t.chordId=s.innerText;break;case"Hairpin":switch(s.innerText){case"Crescendo":t.crescendo=te.Crescendo;break;case"Decrescendo":t.crescendo=te.Decrescendo}break;case"Arpeggio":"Up"===s.innerText?t.brushType=e9.ArpeggioUp:t.brushType=e9.ArpeggioDown;break;case"Properties":this.parseBeatProperties(s,t);break;case"XProperties":this.parseBeatXProperties(s,t);break;case"FreeText":t.text=s.innerText;break;case"TransposedPitchStemOrientation":switch(s.innerText){case"Upward":t.preferredBeamDirection=tR.Up;break;case"Downward":t.preferredBeamDirection=tR.Down}break;case"Dynamic":switch(s.innerText){case"PPP":t.dynamics=e4.PPP;break;case"PP":t.dynamics=e4.PP;break;case"P":t.dynamics=e4.P;break;case"MP":t.dynamics=e4.MP;break;case"MF":t.dynamics=e4.MF;break;case"F":t.dynamics=e4.F;break;case"FF":t.dynamics=e4.FF;break;case"FFF":t.dynamics=e4.FFF}break;case"GraceNotes":switch(s.innerText){case"OnBeat":t.graceType=ti.OnBeat;break;case"BeforeBeat":t.graceType=ti.BeforeBeat}break;case"Legato":"true"===s.getAttribute("origin")&&(t.isLegatoOrigin=!0);break;case"Whammy":let e=new iF(0,0);e.value=this.toBendValue(sP.parseFloatSafe(s.getAttribute("originValue"),0)),e.offset=this.toBendOffset(sP.parseFloatSafe(s.getAttribute("originOffset"),0)),t.addWhammyBarPoint(e);let a=new iF(0,0);a.value=this.toBendValue(sP.parseFloatSafe(s.getAttribute("middleValue"),0)),a.offset=this.toBendOffset(sP.parseFloatSafe(s.getAttribute("middleOffset1"),0)),t.addWhammyBarPoint(a);let r=new iF(0,0);r.value=this.toBendValue(sP.parseFloatSafe(s.getAttribute("middleValue"),0)),r.offset=this.toBendOffset(sP.parseFloatSafe(s.getAttribute("middleOffset2"),0)),t.addWhammyBarPoint(r);let n=new iF(0,0);n.value=this.toBendValue(sP.parseFloatSafe(s.getAttribute("destinationValue"),0)),n.offset=this.toBendOffset(sP.parseFloatSafe(s.getAttribute("destinationOffset"),0)),t.addWhammyBarPoint(n);break;case"Ottavia":switch(s.innerText){case"8va":t.ottava=eQ._8va;break;case"8vb":t.ottava=eQ._8vb;break;case"15ma":t.ottava=eQ._15ma;break;case"15mb":t.ottava=eQ._15mb}break;case"Lyrics":t.lyrics=this.parseBeatLyrics(s),this._skipApplyLyrics=!0;break;case"Slashed":t.slashed=!0;break;case"DeadSlapped":t.deadSlapped=!0;break;case"Golpe":switch(s.innerText){case"Finger":t.golpe=tT.Finger;break;case"Thumb":t.golpe=tT.Thumb}break;case"Wah":switch(s.innerText){case"Open":t.wahPedal=tx.Open;break;case"Closed":t.wahPedal=tx.Closed}break;case"UserTransposedPitchStemOrientation":switch(s.innerText){case"Downward":t.preferredBeamDirection=tR.Down;break;case"Upward":t.preferredBeamDirection=tR.Up}break;case"Timer":t.showTimer=!0,t.timer=sP.parseIntSafe(s.innerText,-1),t.timer<0&&(t.timer=null)}this._beatById.set(i,t)}parseBeatLyrics(e){let t=[];for(let i of e.childElements())"Line"===i.localName&&t.push(i.innerText);return t}parseBeatXProperties(e,t){for(let i of e.childElements())if("XProperty"===i.localName){let e=i.getAttribute("id");switch(e){case"1124204546":switch(sP.parseIntSafe(i.findChildElement("Int")?.innerText,0)){case 1:t.beamingMode=tF.ForceMergeWithNext;break;case 2:t.beamingMode=tF.ForceSplitToNext}break;case"1124204552":1===sP.parseIntSafe(i.findChildElement("Int")?.innerText,0)&&t.beamingMode!==tF.ForceSplitToNext&&(t.beamingMode=tF.ForceSplitOnSecondaryToNext);break;case"1124204545":t.invertBeamDirection=1===sP.parseIntSafe(i.findChildElement("Int")?.innerText,0);break;case"687935489":t.brushDuration=sP.parseIntSafe(i.findChildElement("Int")?.innerText,0)}}}parseBarXProperties(e,t){for(let i of e.childElements())if("XProperty"===i.localName&&"1124139520"===i.getAttribute("id")){let e=i.findChildElement("Double")??i.findChildElement("Float");t.displayScale=sP.parseFloatSafe(e?.innerText,1)}}parseMasterBarXProperties(e,t){for(let i of t.childElements())"XProperty"===i.localName&&"1124073984"===i.getAttribute("id")&&(e.displayScale=sP.parseFloatSafe(i.findChildElement("Double")?.innerText,1))}parseBeatProperties(e,t){let i=!1,s=null,a=null,r=null,n=null,o=null;for(let l of e.childElements())if("Property"===l.localName)switch(l.getAttribute("name")){case"Brush":l.findChildElement("Direction")?.innerText==="Up"?t.brushType=e9.BrushUp:t.brushType=e9.BrushDown;break;case"PickStroke":l.findChildElement("Direction")?.innerText==="Up"?t.pickStroke=ty.Up:t.pickStroke=ty.Down;break;case"Slapped":l.findChildElement("Enable")&&(t.slap=!0);break;case"Popped":l.findChildElement("Enable")&&(t.pop=!0);break;case"VibratoWTremBar":switch(l.findChildElement("Strength")?.innerText){case"Wide":t.vibrato=th.Wide;break;case"Slight":t.vibrato=th.Slight}break;case"WhammyBar":i=!0;break;case"WhammyBarExtend":break;case"WhammyBarOriginValue":s||(s=new iF(0,0)),s.value=this.toBendValue(sP.parseFloatSafe(l.findChildElement("Float")?.innerText,0));break;case"WhammyBarOriginOffset":s||(s=new iF(0,0)),s.offset=this.toBendOffset(sP.parseFloatSafe(l.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleValue":a=this.toBendValue(sP.parseFloatSafe(l.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleOffset1":r=this.toBendOffset(sP.parseFloatSafe(l.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleOffset2":n=this.toBendOffset(sP.parseFloatSafe(l.findChildElement("Float")?.innerText,0));break;case"WhammyBarDestinationValue":o||(o=new iF(iF.MaxPosition,0)),o.value=this.toBendValue(sP.parseFloatSafe(l.findChildElement("Float")?.innerText,0));break;case"WhammyBarDestinationOffset":o||(o=new iF(0,0)),o.offset=this.toBendOffset(sP.parseFloatSafe(l.findChildElement("Float")?.innerText,0));break;case"BarreFret":t.barreFret=sP.parseIntSafe(l.findChildElement("Fret")?.innerText,0);break;case"BarreString":switch(l.findChildElement("String")?.innerText){case"0":t.barreShape=tP.Full;break;case"1":t.barreShape=tP.Half}break;case"Rasgueado":switch(l.findChildElement("Rasgueado")?.innerText){case"ii_1":t.rasgueado=tv.Ii;break;case"mi_1":t.rasgueado=tv.Mi;break;case"mii_1":t.rasgueado=tv.MiiTriplet;break;case"mii_2":t.rasgueado=tv.MiiAnapaest;break;case"pmp_1":t.rasgueado=tv.PmpTriplet;break;case"pmp_2":t.rasgueado=tv.PmpAnapaest;break;case"pei_1":t.rasgueado=tv.PeiTriplet;break;case"pei_2":t.rasgueado=tv.PeiAnapaest;break;case"pai_1":t.rasgueado=tv.PaiTriplet;break;case"pai_2":t.rasgueado=tv.PaiAnapaest;break;case"ami_1":t.rasgueado=tv.AmiTriplet;break;case"ami_2":t.rasgueado=tv.AmiAnapaest;break;case"ppp_1":t.rasgueado=tv.Ppp;break;case"amii_1":t.rasgueado=tv.Amii;break;case"amip_1":t.rasgueado=tv.Amip;break;case"eami_1":t.rasgueado=tv.Eami;break;case"eamii_1":t.rasgueado=tv.Eamii;break;case"peami_1":t.rasgueado=tv.Peami}}i&&(s||(s=new iF(0,0)),o||(o=new iF(iF.MaxPosition,0)),t.addWhammyBarPoint(s),r&&a&&t.addWhammyBarPoint(new iF(r,a)),n&&a&&t.addWhammyBarPoint(new iF(n,a)),r||n||!a||t.addWhammyBarPoint(new iF(iF.MaxPosition/2|0,a)),t.addWhammyBarPoint(o))}parseNotes(e){for(let t of e.childElements())"Note"===t.localName&&this.parseNote(t)}parseNote(e){let t=new iY,i=e.getAttribute("id");for(let s of e.childElements())switch(s.localName){case"Properties":this.parseNoteProperties(s,t,i);break;case"AntiAccent":"normal"===s.innerText.toLowerCase()&&(t.isGhost=!0);break;case"LetRing":t.isLetRing=!0;break;case"Trill":t.trillValue=sP.parseIntSafe(s.innerText,-1),t.trillSpeed=tt.Sixteenth;break;case"Accent":let e=sP.parseIntSafe(s.innerText,0);(1&e)!=0&&(t.isStaccato=!0),(4&e)!=0&&(t.accentuated=ts.Heavy),(8&e)!=0&&(t.accentuated=ts.Normal),(16&e)!=0&&(t.accentuated=ts.Tenuto);break;case"Tie":"true"===s.getAttribute("destination").toLowerCase()&&(t.isTieDestination=!0);break;case"Vibrato":switch(s.innerText){case"Slight":t.vibrato=th.Slight;break;case"Wide":t.vibrato=th.Wide}break;case"LeftFingering":switch(s.innerText){case"P":t.leftHandFinger=ta.Thumb;break;case"I":t.leftHandFinger=ta.IndexFinger;break;case"M":t.leftHandFinger=ta.MiddleFinger;break;case"A":t.leftHandFinger=ta.AnnularFinger;break;case"C":t.leftHandFinger=ta.LittleFinger}break;case"RightFingering":switch(s.innerText){case"P":t.rightHandFinger=ta.Thumb;break;case"I":t.rightHandFinger=ta.IndexFinger;break;case"M":t.rightHandFinger=ta.MiddleFinger;break;case"A":t.rightHandFinger=ta.AnnularFinger;break;case"C":t.rightHandFinger=ta.LittleFinger}break;case"InstrumentArticulation":t.percussionArticulation=sP.parseIntSafe(s.innerText,0);break;case"Ornament":switch(s.innerText){case"Turn":t.ornament=tw.Turn;break;case"InvertedTurn":t.ornament=tw.InvertedTurn;break;case"UpperMordent":t.ornament=tw.UpperMordent;break;case"LowerMordent":t.ornament=tw.LowerMordent}}this._noteById.set(i,t)}parseNoteProperties(e,t,i){let s=!1,a=null,r=null,n=null,o=null,l=null,h=-1,d=-1;for(let c of e.childElements())if("Property"===c.localName)switch(c.getAttribute("name")){case"ShowStringNumber":c.findChildElement("Enable")&&(t.showStringNumber=!0);break;case"String":t.string=sP.parseIntSafe(c.findChildElement("String")?.innerText,0)+1;break;case"Fret":t.fret=sP.parseIntSafe(c.findChildElement("Fret")?.innerText,0);break;case"Element":h=sP.parseIntSafe(c.findChildElement("Element")?.innerText,0);break;case"Variation":d=sP.parseIntSafe(c.findChildElement("Variation")?.innerText,0);break;case"Tapped":this._tappedNotes.set(i,!0);break;case"HarmonicType":let e=c.findChildElement("HType");if(e)switch(e.innerText){case"NoHarmonic":t.harmonicType=tr.None;break;case"Natural":t.harmonicType=tr.Natural;break;case"Artificial":t.harmonicType=tr.Artificial;break;case"Pinch":t.harmonicType=tr.Pinch;break;case"Tap":t.harmonicType=tr.Tap;break;case"Semi":t.harmonicType=tr.Semi;break;case"Feedback":t.harmonicType=tr.Feedback}break;case"HarmonicFret":let u=c.findChildElement("HFret");u&&(t.harmonicValue=sP.parseFloatSafe(u.innerText,0));break;case"Muted":c.findChildElement("Enable")&&(t.isDead=!0);break;case"PalmMuted":c.findChildElement("Enable")&&(t.isPalmMute=!0);break;case"Octave":t.octave=sP.parseIntSafe(c.findChildElement("Number")?.innerText,0),-1===t.tone&&(t.tone=0);break;case"Tone":t.tone=sP.parseIntSafe(c.findChildElement("Step")?.innerText,0);break;case"ConcertPitch":this.parseConcertPitch(c,t);break;case"Bended":s=!0;break;case"BendOriginValue":a||(a=new iF(0,0)),a.value=this.toBendValue(sP.parseFloatSafe(c.findChildElement("Float")?.innerText,0));break;case"BendOriginOffset":a||(a=new iF(0,0)),a.offset=this.toBendOffset(sP.parseFloatSafe(c.findChildElement("Float")?.innerText,0));break;case"BendMiddleValue":r=this.toBendValue(sP.parseFloatSafe(c.findChildElement("Float")?.innerText,0));break;case"BendMiddleOffset1":n=this.toBendOffset(sP.parseFloatSafe(c.findChildElement("Float")?.innerText,0));break;case"BendMiddleOffset2":o=this.toBendOffset(sP.parseFloatSafe(c.findChildElement("Float")?.innerText,0));break;case"BendDestinationValue":l||(l=new iF(iF.MaxPosition,0)),l.value=this.toBendValue(sP.parseFloatSafe(c.findChildElement("Float")?.innerText,0));break;case"BendDestinationOffset":l||(l=new iF(0,0)),l.offset=this.toBendOffset(sP.parseFloatSafe(c.findChildElement("Float")?.innerText,0));break;case"HopoOrigin":c.findChildElement("Enable")&&(t.isHammerPullOrigin=!0);break;case"HopoDestination":break;case"LeftHandTapped":t.isLeftHandTapped=!0;break;case"Slide":let p=sP.parseIntSafe(c.findChildElement("Flags")?.innerText,0);(1&p)!=0?t.slideOutType=tl.Shift:(2&p)!=0?t.slideOutType=tl.Legato:(4&p)!=0?t.slideOutType=tl.OutDown:(8&p)!=0&&(t.slideOutType=tl.OutUp),(16&p)!=0?t.slideInType=to.IntoFromBelow:(32&p)!=0&&(t.slideInType=to.IntoFromAbove),(64&p)!=0?t.slideOutType=tl.PickSlideDown:(128&p)!=0&&(t.slideOutType=tl.PickSlideUp)}s&&(a||(a=new iF(0,0)),l||(l=new iF(iF.MaxPosition,0)),t.addBendPoint(a),n&&r&&t.addBendPoint(new iF(n,r)),o&&r&&t.addBendPoint(new iF(o,r)),n||o||!r||t.addBendPoint(new iF(iF.MaxPosition/2|0,r)),t.addBendPoint(l)),-1!==h&&-1!==d&&(t.percussionArticulation=iU.articulationFromElementVariation(h,d))}parseConcertPitch(e,t){let i=e.findChildElement("Pitch");if(i){for(let e of i.childElements())if("Accidental"===e.localName)switch(e.innerText){case"x":t.accidentalMode=tn.ForceDoubleSharp;break;case"#":t.accidentalMode=tn.ForceSharp;break;case"b":t.accidentalMode=tn.ForceFlat;break;case"bb":t.accidentalMode=tn.ForceDoubleFlat}}}toBendValue(e){return e*sP.BendPointValueFactor|0}toBendOffset(e){return e*sP.BendPointPositionFactor}parseRhythms(e){for(let t of e.childElements())"Rhythm"===t.localName&&this.parseRhythm(t)}parseRhythm(e){let t=new sN,i=e.getAttribute("id");for(let s of(t.id=i,e.childElements()))switch(s.localName){case"NoteValue":switch(s.innerText){case"Long":t.value=tt.QuadrupleWhole;break;case"DoubleWhole":t.value=tt.DoubleWhole;break;case"Whole":t.value=tt.Whole;break;case"Half":t.value=tt.Half;break;case"Quarter":t.value=tt.Quarter;break;case"Eighth":t.value=tt.Eighth;break;case"16th":t.value=tt.Sixteenth;break;case"32nd":t.value=tt.ThirtySecond;break;case"64th":t.value=tt.SixtyFourth;break;case"128th":t.value=tt.OneHundredTwentyEighth;break;case"256th":t.value=tt.TwoHundredFiftySixth}break;case"PrimaryTuplet":t.tupletNumerator=sP.parseIntSafe(s.getAttribute("num"),-1),t.tupletDenominator=sP.parseIntSafe(s.getAttribute("den"),-1);break;case"AugmentationDot":t.dots=sP.parseIntSafe(s.getAttribute("count"),0)}this._rhythmById.set(i,t)}buildModel(){let e;for(let e=0,t=this._masterBars.length;e<t;e++){let t=this._masterBars[e];this.score.addMasterBar(t)}let t=this._masterBars[this._masterBars.length-1];for(let e of(this._doubleBars.has(t)&&(this._doubleBars.delete(t),t.isDoubleBar=!1),this._tracksMapping)){if(!e)continue;let t=this._tracksById.get(e);this.score.addTrack(t)}for(let t of this._barsOfMasterBar){let i=0;e=[e0.C,e1.Major];for(let s=0,a=0;s<t.length&&a<this.score.tracks.length;s++){let r=t[s];if(r!==sP.InvalidId){let t=this._barsById.get(r),s=this.score.tracks[a],n=s.staves[i];n.addBar(t);let o=n.bars.length-1;if(this._keySignatures.has(o)&&(e=this._keySignatures.get(o)),t.keySignature=e[0],t.keySignatureType=e[1],this._doubleBars.has(t.masterBar)&&(t.barLineRight=e3.LightLight),this._voicesOfBar.has(r))for(let e of this._voicesOfBar.get(r))if(e!==sP.InvalidId){let i=this._voiceById.get(e);if(t.addVoice(i),this._beatsOfVoice.has(e)){for(let t of this._beatsOfVoice.get(e))if(t!==sP.InvalidId){let e=iZ.clone(this._beatById.get(t));i.addBeat(e);let s=this._rhythmOfBeat.get(t),a=this._rhythmById.get(s);if(e.duration=a.value,e.dots=a.dots,e.tupletNumerator=a.tupletNumerator,e.tupletDenominator=a.tupletDenominator,this._notesOfBeat.has(t)){for(let i of this._notesOfBeat.get(t))if(i!==sP.InvalidId){let t=ij.clone(this._noteById.get(i));n.isPercussion?(t.fret=-1,t.string=-1):t.percussionArticulation=-1,e.addNote(t),this._tappedNotes.has(i)&&(e.tap=!0)}}}}}else{let e=new iO;t.addVoice(e);let i=new i1;i.isEmpty=!0,i.duration=tt.Quarter,e.addBeat(i)}i===s.staves.length-1?(a++,i=0):i++,e=[e0.C,e1.Major]}else a++}}for(let e of this._tracksMapping){if(!e)continue;let t=this._tracksById.get(e),i=!1;for(let e of t.staves)if(e.isPercussion){i=!0;break}if(i||(t.percussionArticulations=[]),this._automationsPerTrackIdAndBarIndex.has(e)){for(let[i,s]of this._automationsPerTrackIdAndBarIndex.get(e))if(t.staves.length>0&&i<t.staves[0].bars.length){let e=t.staves[0].bars[i];if(e.voices.length>0&&e.voices[0].beats.length>0){let t=e.voices[0].beats[0];for(let e of s)t.automations.push(e)}}}if(this._sustainPedalsPerTrackIdAndBarIndex.has(e))for(let[i,s]of this._sustainPedalsPerTrackIdAndBarIndex.get(e))t.staves.length>0&&i<t.staves[0].bars.length&&(t.staves[0].bars[i].sustainPedals=s)}for(let[e,t]of this._masterTrackAutomations){let i=this.score.masterBars[e];for(let s=0,a=t.length;s<a;s++){let a=t[s];switch(a.type){case e6.Tempo:0===e&&(this.score.tempo=0|a.value,a.text&&(this.score.tempoLabel=a.text)),i.tempoAutomations.push(a);break;case e6.SyncPoint:a.syncPointValue.millisecondOffset-=this._backingTrackPadding,i.addSyncPoint(a)}}}}}sP.InvalidId="-1",sP.BendPointPositionFactor=iF.MaxPosition/100,sP.BendPointValueFactor=.04,sP.SampleRate=44100;class sv{constructor(){this.isMultiRest=!1,this.trackViewGroups=[]}}class sF{constructor(){this.showNumbered=!1,this.showSlash=!1,this.showStandardNotation=!1,this.showTablature=!1}}class sC{apply(e){if(this.scoreViews.length>0){let t=0;for(let i of(e.stylesheet.multiTrackMultiBarRest=this.scoreViews[0].isMultiRest,this.scoreViews[0].trackViewGroups)){if(t<e.tracks.length)for(let s of e.tracks[t].staves)s.showTablature=i.showTablature,s.showStandardNotation=i.showStandardNotation,s.showSlash=i.showSlash,s.showNumbered=i.showNumbered;t++}for(let i=1;i<this.scoreViews.length;i++)this.scoreViews[i].isMultiRest&&(e.stylesheet.perTrackMultiBarRest||(e.stylesheet.perTrackMultiBarRest=new Set),t=i-1,e.stylesheet.perTrackMultiBarRest.add(t))}}constructor(e){this.scoreViews=[];const t=sd.fromBuffer(e),i=sh.readInt32BE(t);for(let e=0;e<i;e++){const e=new sv;this.scoreViews.push(e),e.isMultiRest=sg.gpReadBool(t);const i=sh.readInt32BE(t);for(let s=0;s<i;s++){let i=t.readByte();0===i&&(i=1);const s=new sF;s.showStandardNotation=(1&i)!=0,s.showTablature=(2&i)!=0,s.showSlash=(4&i)!=0,s.showNumbered=(8&i)!=0,e.trackViewGroups.push(s)}}}static writeForScore(e){let t=sd.withCapacity(128),i=[new sv];for(let t of(i[0].isMultiRest=e.stylesheet.multiTrackMultiBarRest,e.tracks)){let s=new sF;s.showStandardNotation=t.staves[0].showStandardNotation,s.showTablature=t.staves[0].showTablature,s.showSlash=t.staves[0].showSlash,s.showNumbered=t.staves[0].showNumbered,i[0].trackViewGroups.push(s);let a=new sv;a.isMultiRest=e.stylesheet.perTrackMultiBarRest?.has(t.index)===!0,a.trackViewGroups.push(s),i.push(a)}for(let e of(sh.writeInt32BE(t,i.length),i))for(let i of(t.writeByte(+!!e.isMultiRest),sh.writeInt32BE(t,e.trackViewGroups.length),e.trackViewGroups)){let e=0;i.showStandardNotation&&(e|=1),i.showTablature&&(e|=2),i.showSlash&&(e|=4),i.showNumbered&&(e|=8),t.writeByte(e)}return sh.writeInt32BE(t,1),t.toArray()}}let sD=class{};class sE extends sD{constructor(e){super(),this.n=e}}class sM extends sD{constructor(e,t){super(),this.left=e,this.right=t}}class sL extends sD{constructor(e,t){super(),this.n=e,this.table=t}}class sI{static make(e,t,i,s){let a=[],r=[];if(s>32)throw new st("Invalid huffman");for(let e=0;e<s;e++)a.push(0),r.push(0);for(let r=0;r<i;r++){let i=e[r+t];if(i>=s)throw new st("Invalid huffman");a[i]++}let n=0;for(let e=1;e<s-1;e++)n=n+a[e]<<1,r[e]=n;let o=new Map;for(let s=0;s<i;s++){let i=e[s+t];if(0!==i){let e=r[i-1];r[i-1]=e+1,o.set(e<<5|i,s)}}return sI.treeCompress(new sM(sI.treeMake(o,s,0,1),sI.treeMake(o,s,1,1)))}static treeMake(e,t,i,s){if(s>t)throw new st("Invalid huffman");let a=i<<5|s;return e.has(a)?new sE(e.get(a)):(i<<=1,s+=1,new sM(sI.treeMake(e,t,i,s),sI.treeMake(e,t,1|i,s)))}static treeCompress(e){let t=sI.treeDepth(e);if(0===t)return e;if(1===t){if(e instanceof sM)return new sM(sI.treeCompress(e.left),sI.treeCompress(e.right));throw new st("assert")}let i=1<<t,s=[];for(let e=0;e<i;e++)s.push(new sE(-1));return sI.treeWalk(s,0,0,t,e),new sL(t,s)}static treeWalk(e,t,i,s,a){a instanceof sM&&s>0?(sI.treeWalk(e,t,i+1,s-1,a.left),sI.treeWalk(e,t|1<<i,i+1,s-1,a.right)):e[t]=sI.treeCompress(a)}static treeDepth(e){if(e instanceof sE)return 0;if(e instanceof sL)throw new st("assert");if(e instanceof sM){let t=sI.treeDepth(e.left),i=sI.treeDepth(e.right);return 1+(t<i?t:i)}return 0}}(ed=tU||(tU={}))[ed.Head=0]="Head",ed[ed.Block=1]="Block",ed[ed.CData=2]="CData",ed[ed.Flat=3]="Flat",ed[ed.Crc=4]="Crc",ed[ed.Dist=5]="Dist",ed[ed.DistOne=6]="DistOne",ed[ed.Done=7]="Done";class sA{constructor(){this.buffer=new Uint8Array(sA.BufferSize),this.pos=0}slide(){let e=new Uint8Array(sA.BufferSize);this.pos-=sA.Size,e.set(this.buffer.subarray(sA.Size,sA.Size+this.pos),0),this.buffer=e}addBytes(e,t,i){this.pos+i>sA.BufferSize&&this.slide(),this.buffer.set(e.subarray(t,t+i),this.pos),this.pos+=i}addByte(e){this.pos===sA.BufferSize&&this.slide(),this.buffer[this.pos]=e,this.pos++}getLastChar(){return this.buffer[this.pos-1]}available(){return this.pos}}sA.Size=32768,sA.BufferSize=65536;class sR{static buildFixedHuffman(){let e=[];for(let t=0;t<288;t++)e.push(t<=143?8:t<=255?9:t<=279?7:8);return sI.make(e,0,288,10)}constructor(e){this._nbits=0,this._bits=0,this._state=tU.Block,this._isFinal=!1,this._huffman=sR._fixedHuffman,this._huffdist=null,this._len=0,this._dist=0,this._needed=0,this._output=null,this._outpos=0,this._lengths=[],this._window=new sA,this._input=e;for(let e=0;e<19;e++)this._lengths.push(-1)}readBytes(e,t,i){if(this._needed=i,this._outpos=t,this._output=e,i>0)for(;this.inflateLoop(););return i-this._needed}inflateLoop(){switch(this._state){case tU.Head:let e=this._input.readByte();if(8!=(15&e))throw new st("Invalid data");let t=this._input.readByte();if(((e<<8)+t)%31!=0)throw new st("Invalid data");if((32&t)!=0)throw new st("Unsupported dictionary");return this._state=tU.Block,!0;case tU.Crc:return this._state=tU.Done,!0;case tU.Done:break;case tU.Block:switch(this._isFinal=this.getBit(),this.getBits(2)){case 0:if(this._len=sh.readUInt16LE(this._input),sh.readUInt16LE(this._input)!==65535-this._len)throw new st("Invalid data");this._state=tU.Flat;let i=this.inflateLoop();return this.resetBits(),i;case 1:return this._huffman=sR._fixedHuffman,this._huffdist=null,this._state=tU.CData,!0;case 2:let s=this.getBits(5)+257,a=this.getBits(5)+1,r=this.getBits(4)+4;for(let e=0;e<r;e++)this._lengths[sR.CodeLengthsPos[e]]=this.getBits(3);for(let e=r;e<19;e++)this._lengths[sR.CodeLengthsPos[e]]=0;this._huffman=sI.make(this._lengths,0,19,8);let n=[];for(let e=0;e<s+a;e++)n.push(0);return this.inflateLengths(n,s+a),this._huffdist=sI.make(n,s,a,16),this._huffman=sI.make(n,0,s,16),this._state=tU.CData,!0;default:throw new st("Invalid data")}case tU.Flat:{let e=this._len<this._needed?this._len:this._needed,t=sh.readByteArray(this._input,e);return this._len-=e,this.addBytes(t,0,e),0===this._len&&(this._state=this._isFinal?tU.Crc:tU.Block),this._needed>0}case tU.DistOne:{let e=this._len<this._needed?this._len:this._needed;return this.addDistOne(e),this._len-=e,0===this._len&&(this._state=tU.CData),this._needed>0}case tU.Dist:for(;this._len>0&&this._needed>0;){let e=this._len<this._dist?this._len:this._dist,t=this._needed<e?this._needed:e;this.addDist(this._dist,t),this._len-=t}return 0===this._len&&(this._state=tU.CData),this._needed>0;case tU.CData:let o=this.applyHuffman(this._huffman);if(o<256)return this.addByte(o),this._needed>0;if(256===o)return this._state=this._isFinal?tU.Crc:tU.Block,!0;o=o-257&255;let l=sR.LenExtraBitsTbl[o];if(-1===l)throw new st("Invalid data");this._len=sR.LenBaseValTbl[o]+this.getBits(l);let h=this._huffdist,d=h?this.applyHuffman(h):this.getRevBits(5);if(-1===(l=sR.DistExtraBitsTbl[d])||(this._dist=sR.DistBaseValTbl[d]+this.getBits(l),this._dist>this._window.available()))throw new st("Invalid data");return this._state=1===this._dist?tU.DistOne:tU.Dist,!0}return!1}addDistOne(e){let t=this._window.getLastChar();for(let i=0;i<e;i++)this.addByte(t)}addByte(e){this._window.addByte(e),this._output[this._outpos]=e,this._needed--,this._outpos++}addDist(e,t){this.addBytes(this._window.buffer,this._window.pos-e,t)}getBit(){0===this._nbits&&(this._nbits=8,this._bits=this._input.readByte());let e=(1&this._bits)==1;return this._nbits--,this._bits=this._bits>>1,e}getBits(e){for(;this._nbits<e;)this._bits=this._bits|this._input.readByte()<<this._nbits,this._nbits+=8;let t=this._bits&(1<<e)-1;return this._nbits-=e,this._bits=this._bits>>e,t}getRevBits(e){return 0===e?0:this.getBit()?1<<e-1|this.getRevBits(e-1):this.getRevBits(e-1)}resetBits(){this._bits=0,this._nbits=0}addBytes(e,t,i){this._window.addBytes(e,t,i),this._output.set(e.subarray(t,t+i),this._outpos),this._needed-=i,this._outpos+=i}inflateLengths(e,t){let i=0,s=0;for(;i<t;){let a=this.applyHuffman(this._huffman);switch(a){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:s=a,e[i]=a,i++;break;case 16:let r=i+3+this.getBits(2);if(r>t)throw new st("Invalid data");for(;i<r;)e[i]=s,i++;break;case 17:if((i+=3+this.getBits(3))>t)throw new st("Invalid data");break;case 18:if((i+=11+this.getBits(7))>t)throw new st("Invalid data");break;default:throw new st("Invalid data")}}}applyHuffman(e){if(e instanceof sE)return e.n;if(e instanceof sM)return this.applyHuffman(this.getBit()?e.right:e.left);if(e instanceof sL)return this.applyHuffman(e.table[this.getBits(e.n)]);throw new st("Invalid data")}}sR.LenExtraBitsTbl=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,-1,-1],sR.LenBaseValTbl=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258],sR.DistExtraBitsTbl=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,-1,-1],sR.DistBaseValTbl=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],sR.CodeLengthsPos=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],sR._fixedHuffman=sR.buildFixedHuffman();class sO{constructor(e,t){this.fullName=e;const i=e.lastIndexOf("/");this.fileName=-1===i||i===e.length-1?this.fullName:e.substr(i+1),this.data=t}}sO.OptionalDataDescriptorSignature=0x8074b50,sO.CompressionMethodDeflate=8,sO.LocalFileHeaderSignature=0x4034b50,sO.CentralFileHeaderSignature=0x2014b50,sO.EndOfCentralDirSignature=0x6054b50;class sH{constructor(e){this._readable=e}read(){let e=[];for(;;){let t=this.readEntry();if(!t)break;e.push(t)}return e}readEntry(){let e,t=this._readable;if(sh.readInt32LE(t)!==sO.LocalFileHeaderSignature)return null;sh.readUInt16LE(t);let i=sh.readUInt16LE(t),s=sh.readUInt16LE(t),a=0!==s;if(a&&s!==sO.CompressionMethodDeflate)return null;sh.readInt16LE(this._readable),sh.readInt16LE(this._readable),sh.readInt32LE(t),sh.readInt32LE(t);let r=sh.readInt32LE(t),n=sh.readInt16LE(t),o=sh.readInt16LE(t),l=sh.toString(sh.readByteArray(t,n),"utf-8");if(t.skip(o),a){let t=sd.empty(),i=new sR(this._readable),s=new Uint8Array(65536);for(;;){let e=i.readBytes(s,0,s.length);if(t.write(s,0,e),e<s.length)break}e=t.toArray()}else e=sh.readByteArray(this._readable,r);return(8&i)!=0&&(sh.readInt32LE(this._readable)===sO.OptionalDataDescriptorSignature&&sh.readInt32LE(this._readable),sh.readInt32LE(this._readable),sh.readInt32LE(this._readable)),new sO(l,e)}}class sV{constructor(){this.trackViewGroups=[]}}class sW{constructor(){this.isVisible=!1}}(ec=tX||(tX={}))[ec.PageVertical=0]="PageVertical",ec[ec.PageGrid=1]="PageGrid",ec[ec.PageParchment=2]="PageParchment",ec[ec.ScreenVertical=3]="ScreenVertical",ec[ec.ScreenHorizontal=4]="ScreenHorizontal",ec[ec.PageHorizontal=5]="PageHorizontal";class sG{constructor(e,t){this.zoomLevel=4,this.view=tX.PageVertical,this.muiltiVoiceCursor=!1,this.scoreViews=[];const i=sd.fromBuffer(t);this.zoomLevel=sh.readInt32BE(i),this.view=i.readByte(),this.muiltiVoiceCursor=0!==i.readByte();const s=e.scoreViews.length;for(let t=0;t<s;t++){const s=new sV;this.scoreViews.push(s);const a=e.scoreViews[t];for(let e=0;e<a.trackViewGroups.length;e++){const e=new sW;e.isVisible=0!==i.readByte(),s.trackViewGroups.push(e)}}}apply(e){if(this.scoreViews.length>0){let t=0;for(let i of this.scoreViews[0].trackViewGroups)t<e.tracks.length&&(e.tracks[t].isVisibleOnMultiTrack=i.isVisible),t++}}static writeForScore(e){let t=sd.withCapacity(128);sh.writeInt32BE(t,4),t.writeByte(0);let i=e.tracks.length>0&&e.tracks[0].staves[0].bars[0].isMultiVoice;for(let s of(t.writeByte(255*!!i),e.tracks))t.writeByte(255*!!s.isVisibleOnMultiTrack);for(let i of e.tracks)t.writeByte(255);return t.toArray()}}class sz extends i4{get name(){return"Guitar Pro 7-8"}readScore(){let e;iM.debug(this.name,"Loading ZIP entries");let t=new sH(this.data);try{e=t.read()}catch(e){throw new i8("No Zip archive",e)}iM.debug(this.name,"Zip entries loaded");let i=null,s=null,a=null,r=null,n=new Map;for(let t of e)switch(n.set(t.fullName,t),t.fileName){case"score.gpif":i=sh.toString(t.data,this.settings.importer.encoding);break;case"BinaryStylesheet":s=t.data;break;case"PartConfiguration":a=t.data;break;case"LayoutConfiguration":r=t.data}if(!i)throw new i8("No score.gpif found in zip archive");iM.debug(this.name,"Start Parsing score.gpif");let o=new sP;o.loadAsset=e=>{if(n.has(e))return n.get(e).data},o.parseXml(i,this.settings),iM.debug(this.name,"score.gpif parsed");let l=o.score;s&&(iM.debug(this.name,"Start Parsing BinaryStylesheet"),new sb(s).apply(l),iM.debug(this.name,"BinaryStylesheet parsed"));let h=null;return a&&(iM.debug(this.name,"Start Parsing Part Configuration"),(h=new sC(a)).apply(l),iM.debug(this.name,"Part Configuration parsed")),r&&null!=h&&(iM.debug(this.name,"Start Parsing Layout Configuration"),new sG(h,r).apply(l),iM.debug(this.name,"Layout Configuration parsed")),l}}class sU extends i6{constructor(){super(tE.Format,"Unexpected end of data within reader"),Object.setPrototypeOf(this,sU.prototype)}}class sX{constructor(e){this._currentByte=0,this._position=sX.ByteSize,this._source=e}readByte(){return this.readBits(8)}readBytes(e){let t=new Uint8Array(e);for(let i=0;i<e;i++)t[i]=255&this.readByte();return t}readBits(e){let t=0,i=e-1;for(;i>=0;)t|=this.readBit()<<i,i--;return t}readBitsReversed(e){let t=0;for(let i=0;i<e;i++)t|=this.readBit()<<i;return t}readBit(){if(this._position>=8){if(this._currentByte=this._source.readByte(),-1===this._currentByte)throw new sU;this._position=0}let e=this._currentByte>>sX.ByteSize-this._position-1&1;return this._position++,e}readAll(){let e=sd.empty();try{for(;;)e.writeByte(255&this.readByte())}catch(e){if(!(e instanceof sU))throw e}return e.toArray()}}sX.ByteSize=8;class sJ{constructor(){this.fileName="",this.fileSize=0,this.data=null}}class sY{constructor(){this.files=[],this.files=[],this.fileFilter=e=>!0}load(e){let t=new sX(e);this.readBlock(t)}readHeader(e){return this.getString(e.readBytes(4),0,4)}decompress(e,t=!1){let i,s=sd.empty(),a=this.getInteger(e.readBytes(4),0);try{for(;s.length<a;){let t=e.readBits(1);if(1===t){let t=e.readBits(4),a=e.readBitsReversed(t),r=e.readBitsReversed(t),n=s.length-a,o=Math.min(a,r);i=s.getBuffer(),s.write(i,n,o)}else{let t=e.readBitsReversed(2);for(let i=0;i<t;i++)s.writeByte(e.readByte())}}}catch(e){if(!(e instanceof sU))throw e}i=s.getBuffer();let r=4*!!t,n=s.length-r,o=new Uint8Array(n);return o.set(i.subarray(r,r+n),0),o}readBlock(e){let t=this.readHeader(e);if("BCFZ"===t)this.readUncompressedBlock(this.decompress(e,!0));else if("BCFS"===t)this.readUncompressedBlock(e.readAll());else throw new i8("Unsupported format")}readUncompressedBlock(e){let t=4096;for(;t+3<e.length;){if(2===this.getInteger(e,t)){let i=new sJ;i.fileName=this.getString(e,t+4,127),i.fileSize=this.getInteger(e,t+140);let s=!this.fileFilter||this.fileFilter(i.fileName);s&&this.files.push(i);let a=t+148,r=0,n=0,o=s?sd.withCapacity(i.fileSize):null;for(;;)if(0!==(r=this.getInteger(e,a+4*n++)))t=4096*r,s&&o.write(e,t,4096);else break;if(s){i.data=new Uint8Array(Math.min(i.fileSize,o.length));let e=o.toArray();i.data.set(e.subarray(0,0+i.data.length),0)}}t+=4096}}getString(e,t,i){let s="";for(let a=0;a<i;a++){let i=255&e[t+a];if(0===i)break;s+=String.fromCharCode(i)}return s}getInteger(e,t){return e[t+3]<<24|e[t+2]<<16|e[t+1]<<8|e[t]}}sY.HeaderBcFs="BCFS",sY.HeaderBcFz="BCFZ";class sq extends i4{get name(){return"Guitar Pro 6"}readScore(){iM.debug(this.name,"Loading GPX filesystem");let e=new sY;e.fileFilter=e=>e.endsWith("score.gpif")||e.endsWith("BinaryStylesheet")||e.endsWith("PartConfiguration")||e.endsWith("LayoutConfiguration"),e.load(this.data),iM.debug(this.name,"GPX filesystem loaded");let t=null,i=null,s=null,a=null;for(let r of e.files)switch(r.fileName){case"score.gpif":t=sh.toString(r.data,this.settings.importer.encoding);break;case"BinaryStylesheet":i=r.data;break;case"PartConfiguration":s=r.data;break;case"LayoutConfiguration":a=r.data}if(!t)throw new i8("No score.gpif found in GPX");iM.debug(this.name,"Start Parsing score.gpif");let r=new sP;r.parseXml(t,this.settings),iM.debug(this.name,"score.gpif parsed");let n=r.score;i&&(iM.debug(this.name,"Start Parsing BinaryStylesheet"),new sb(i).apply(n),iM.debug(this.name,"BinaryStylesheet parsed"));let o=null;return s&&(iM.debug(this.name,"Start Parsing Part Configuration"),(o=new sC(s)).apply(n),iM.debug(this.name,"Part Configuration parsed")),a&&null!=o&&(iM.debug(this.name,"Start Parsing Layout Configuration"),new sG(o,a).apply(n),iM.debug(this.name,"Layout Configuration parsed")),n}}(eu=tJ||(tJ={}))[eu.None=0]="None",eu[eu.Natural=1]="Natural",eu[eu.Sharp=2]="Sharp",eu[eu.Flat=3]="Flat",eu[eu.NaturalQuarterNoteUp=4]="NaturalQuarterNoteUp",eu[eu.SharpQuarterNoteUp=5]="SharpQuarterNoteUp",eu[eu.FlatQuarterNoteUp=6]="FlatQuarterNoteUp",eu[eu.DoubleSharp=7]="DoubleSharp",eu[eu.DoubleFlat=8]="DoubleFlat";class s${constructor(){this.maxLine=-1e3,this.minLine=-1e3}}class sj{constructor(e){this._registeredAccidentals=new Map,this._appliedScoreLines=new Map,this._appliedScoreLinesByValue=new Map,this._notesByValue=new Map,this._beatLines=new Map,this.maxLineBeat=null,this.minLineBeat=null,this.maxLine=-1e3,this.minLine=-1e3,this._barRenderer=e,this._bar=e.bar}static getPercussionLine(e,t){return t<e.staff.track.percussionArticulations.length?e.staff.track.percussionArticulations[t].staffLine:iU.getArticulationByInputMidiNumber(t)?.staffLine??0}static getNoteValue(e){if(e.isPercussion)return e.percussionArticulation;let t=e.displayValue;switch(e.accidentalMode){case tn.ForceDoubleFlat:t+=2;break;case tn.ForceDoubleSharp:t-=2;break;case tn.ForceFlat:t+=1;break;case tn.ForceSharp:t-=1}return t}applyAccidental(e){let t=sj.getNoteValue(e),i=e.hasQuarterToneOffset;return this.getAccidental(t,i,e.beat,!1,e)}applyAccidentalForValue(e,t,i,s){return this.getAccidental(t,i,e,s,null)}static computeLineWithoutAccidentals(e,t){let i=sj.getNoteValue(t);return t.isPercussion?sj.getPercussionLine(e,i):sj.calculateNoteSteps(e.keySignature,e.clef,i)}static computeAccidental(e,t,i,s,a=null){let r=e+7,n=i%12,o=r<7?tJ.Flat:tJ.Sharp,l=sj.KeySignatureLookup[r][n],h=sj.AccidentalNotes[n],d=tJ.None;if(s)switch(d=h?o:tJ.Natural){case tJ.Natural:d=tJ.NaturalQuarterNoteUp;break;case tJ.Sharp:d=tJ.SharpQuarterNoteUp;break;case tJ.Flat:d=tJ.FlatQuarterNoteUp}else{switch(t){case tn.ForceSharp:d=tJ.Sharp;break;case tn.ForceDoubleSharp:d=tJ.DoubleSharp;break;case tn.ForceFlat:d=tJ.Flat;break;case tn.ForceDoubleFlat:d=tJ.DoubleFlat;break;default:h?d=o:l&&(d=tJ.Natural)}d!==tJ.None?null!=a?a===d&&(d=tJ.None):l&&d===o&&(d=tJ.None):null!==a&&(d=a===tJ.Natural?tJ.None:tJ.Natural)}return d}getAccidental(e,t,i,s,a=null){let r=0,n=tJ.None;if(null!=a?a.isPercussion:this._bar.staff.isPercussion)r=sj.getPercussionLine(this._bar,e);else{let i=a?a.accidentalMode:tn.Default;r=sj.calculateNoteSteps(this._bar.keySignature,this._bar.clef,e);let s=this._registeredAccidentals.has(r)?this._registeredAccidentals.get(r):null;n=sj.computeAccidental(this._bar.keySignature,i,e,t,s);let o=!1;switch(n){case tJ.NaturalQuarterNoteUp:case tJ.SharpQuarterNoteUp:case tJ.FlatQuarterNoteUp:break;default:if(a&&a.isTieDestination&&0===a.beat.index){let e=this._barRenderer.scoreRenderer.layout?.getRendererForBar(this._barRenderer.staff.staffId,a.tieOrigin.beat.voice.bar);e&&e.staff===this._barRenderer.staff&&e.accidentalHelper.getNoteLine(a.tieOrigin)===r&&(o=!0)}o?n=tJ.None:n!==tJ.None&&this._registeredAccidentals.set(r,n)}}return a?(this._appliedScoreLines.set(a.id,r),this._notesByValue.set(e,a)):this._appliedScoreLinesByValue.set(e,r),(-1e3===this.minLine||this.minLine<r)&&(this.minLine=r,this.minLineBeat=i),(-1e3===this.maxLine||this.maxLine>r)&&(this.maxLine=r,this.maxLineBeat=i),s||this.registerLine(i,r),n}registerLine(e,t){let i;this._beatLines.has(e.id)?i=this._beatLines.get(e.id):(i=new s$,this._beatLines.set(e.id,i)),(-1e3===i.minLine||t<i.minLine)&&(i.minLine=t),(-1e3===i.minLine||t>i.maxLine)&&(i.maxLine=t)}getMaxLine(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).maxLine:0}getMinLine(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).minLine:0}static calculateNoteSteps(e,t,i){let s=sj.OctaveSteps[t];return s-=((i/12|0)-1)*sj.StepsPerOctave,s-=(iW.keySignatureIsSharp(e)||iW.keySignatureIsNatural(e)?sj.SharpNoteSteps:sj.FlatNoteSteps)[i%12]}getNoteLine(e){return this._appliedScoreLines.get(e.id)}getNoteLineForValue(e,t=!1){return this._appliedScoreLinesByValue.has(e)?this._appliedScoreLinesByValue.get(e):t&&this._notesByValue.has(e)?this.getNoteLine(this._notesByValue.get(e)):0}}sj.KeySignatureLookup=[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],[!1,!1,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]],sj.AccidentalNotes=[!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!0,!1],sj.StepsPerOctave=7,sj.OctaveSteps=[38,32,30,26,38],sj.SharpNoteSteps=[0,0,1,1,2,3,3,4,4,5,5,6],sj.FlatNoteSteps=[0,1,1,2,2,3,4,4,5,5,6,6];class sK{constructor(){this.currentDynamics=e4.F,this.slideOrigins=new Map,this.transpose=0,this.isExplicitlyBeamed=!1,this.tieStarts=new Set,this.tieStartIds=new Map,this.slideOrigins=new Map,this.slurStarts=new Map}}class sQ extends iz{constructor(){super(...arguments),this.outputMidiChannel=-1,this.outputMidiProgram=-1,this.outputVolume=-1,this.outputBalance=-1}}class sZ{constructor(e){this.instruments=new Map,this._instrumentIdToArticulationIndex=new Map,this._lyricsLine=0,this._lyricsLines=new Map,this.track=e}getLyricLine(e){if(this._lyricsLines.has(e))return this._lyricsLines.get(e);let t=this._lyricsLine;return this._lyricsLines.set(e,t),this._lyricsLine++,t}getOrCreateArticulation(e,t){let i,s,a=12*t.octave+t.tone,r=`${e}_${a}`;if(this._instrumentIdToArticulationIndex.has(r))return this._instrumentIdToArticulationIndex.get(r);i=this.instruments.has(e)?this.instruments.get(e):sZ.defaultNoteArticulation;let n=this.track.percussionArticulations.length,o=t.beat.voice.bar;s=0===a?4:sj.calculateNoteSteps(o.keySignature,o.clef,a);let l=2*t.beat.voice.bar.staff.standardNotationLineCount-1,h=new iz(i.elementType,s-(9-l),i.outputMidiNumber,i.noteHeadDefault,i.noteHeadHalf,i.noteHeadWhole,i.techniqueSymbol,i.techniqueSymbolPlacement);return this._instrumentIdToArticulationIndex.set(r,n),this.track.percussionArticulations.push(h),n}}sZ.defaultNoteArticulation=new iz("Default",0,0,tb.NoteheadBlack,tb.NoteheadHalf,tb.NoteheadWhole);class s0 extends i4{constructor(){super(...arguments),this._idToTrackInfo=new Map,this._indexToTrackInfo=new Map,this._staffToContext=new Map,this._divisionsPerQuarterNote=1,this._currentDynamics=e4.F,this._musicalPosition=0,this._lastBeat=null,this._nextMasterBarRepeatEnding=0,this._nextBeatAutomations=null,this._nextBeatChord=null,this._nextBeatCrescendo=null,this._nextBeatLetRing=!1,this._nextBeatPalmMute=!1,this._nextBeatOttavia=null,this._nextBeatText=null,this._simileMarkAllStaves=null,this._simileMarkPerStaff=null,this._isBeatSlash=!1,this._keyAllStaves=null,this._currentTrillStep=-1}get name(){return"MusicXML"}readScore(){let e=this.extractMusicXml(),t=new sB;try{t.parse(e)}catch(e){throw new i8("Unsupported format",e)}return this._score=new i3,this._score.tempo=120,this._score.stylesheet.hideDynamics=!0,this.parseDom(t),iW.consolidate(this._score),this._score.finish(this.settings),this._score.rebuildRepeatGroups(),this._score}extractMusicXml(){let e,t=new sH(this.data);try{e=t.read()}catch(t){e=[]}if(0===e.length)return this.data.reset(),sh.toString(this.data.readAll(),this.settings.importer.encoding);let i=e.find(e=>"META-INF/container.xml"===e.fullName);if(!i)throw new i8("No compressed MusicXML");let s=new sB;try{s.parse(sh.toString(i.data,this.settings.importer.encoding))}catch(e){throw new i8("Malformed container.xml, could not parse as XML",e)}let a=s.firstElement;if(!a||"container"!==a.localName)throw new i8("Malformed container.xml, root element not 'container'");let r=a.findChildElement("rootfiles");if(!r)throw new i8("Malformed container.xml, 'container/rootfiles' not found");let n="";for(let e of r.childElements())if("rootfile"===e.localName){n=e.getAttribute("full-path");break}if(!n)throw new i8("Unsupported compressed MusicXML, missing rootfile");let o=e.find(e=>e.fullName===n);if(!o)throw new i8(`Malformed container.xml, '${n}' not contained in zip`);return sh.toString(o.data,this.settings.importer.encoding)}parseDom(e){let t=e.firstElement;if(!t)throw new i8("Unsupported format");switch(t.localName){case"score-partwise":this.parsePartwise(t);break;case"score-timewise":this.parseTimewise(t);break;default:throw new i8("Unsupported format")}}parsePartwise(e){for(let t of e.childElements())switch(t.localName){case"credit":this.parseCredit(t);break;case"identification":this.parseIdentification(t);break;case"movement-title":this.parseMovementTitle(t);break;case"part":this.parsePartwisePart(t);break;case"part-list":this.parsePartList(t);break;case"work":this.parseWork(t)}}parseTimewise(e){let t=0;for(let i of e.childElements())switch(i.localName){case"credit":this.parseCredit(i);break;case"identification":this.parseIdentification(i);break;case"movement-title":this.parseMovementTitle(i);break;case"part-list":this.parsePartList(i);break;case"work":this.parseWork(i);break;case"measure":this.parseTimewiseMeasure(i,t),t++}}parseCredit(e){if("1"!==e.getAttribute("page","1"))return;let t=[],i=null,s="";for(let a of e.childElements())switch(a.localName){case"credit-type":t.push(a.innerText);break;case"credit-words":null===i&&(i=a),s+=a.innerText}if(t.length>0)for(let e of t)switch(e){case"title":this._score.title=s0.sanitizeDisplay(s);break;case"subtitle":this._score.subTitle=s0.sanitizeDisplay(s);break;case"composer":case"arranger":this._score.artist=s0.sanitizeDisplay(s);break;case"lyricist":this._score.words=s0.sanitizeDisplay(s);break;case"rights":this._score.copyright=s0.sanitizeDisplay(s)}else if(i){let e=i.getAttribute("font-size","0"),t=i.getAttribute("font-size","top"),a=i.getAttribute("halign","left");if("top"===t){if(s.includes("copyright")||s.includes("Copyright")||s.includes("")||s.includes("(c)")||s.includes("(C)")){this._score.copyright=s0.sanitizeDisplay(s);return}if("center"===a||"center"===e){if(0===this._score.title.length){this._score.title=s0.sanitizeDisplay(s);return}if(0===this._score.subTitle.length){this._score.subTitle=s0.sanitizeDisplay(s);return}if(0===this._score.album.length){this._score.album=s0.sanitizeDisplay(s);return}}else if(("right"===a||"right"===e)&&0===this._score.music.length){this._score.music=s0.sanitizeDisplay(s);return}if(0===this._score.artist.length){this._score.artist=s0.sanitizeDisplay(s);return}if(0===this._score.words.length){this._score.words=s0.sanitizeDisplay(s);return}}}}static sanitizeDisplay(e){return e.replaceAll("\r","").replaceAll("\n"," ").replaceAll("	","").replaceAll(" ","")}parseIdentification(e){for(let t of e.childElements())switch(t.localName){case"creator":if(t.attributes.has("type"))switch(t.attributes.get("type")){case"composer":this._score.artist=s0.sanitizeDisplay(t.innerText);break;case"lyricist":this._score.words=s0.sanitizeDisplay(t.innerText);break;case"arranger":this._score.music=s0.sanitizeDisplay(t.innerText)}else this._score.artist=s0.sanitizeDisplay(t.innerText);break;case"rights":this._score.copyright.length>0&&(this._score.copyright+=", "),this._score.copyright+=t.innerText,t.attributes.has("type")&&(this._score.copyright+=` (${t.attributes.get("type")})`);break;case"encoding":this.parseEncoding(t)}}parseEncoding(e){for(let t of e.childElements())switch(t.localName){case"encoder":this._score.tab.length>0&&(this._score.tab+=", "),this._score.tab+=t.innerText,t.attributes.has("type")&&(this._score.tab+=` (${t.attributes.get("type")})`);break;case"encoding-description":this._score.notices+=s0.sanitizeDisplay(t.innerText)}}parseMovementTitle(e){0===this._score.title.length?this._score.title=s0.sanitizeDisplay(e.innerText):this._score.subTitle=s0.sanitizeDisplay(e.innerText)}parsePartList(e){for(let t of e.childElements())"score-part"===t.localName&&this.parseScorePart(t)}parseScorePart(e){let t=new so;t.ensureStaveCount(1),this._score.addTrack(t);let i=e.attributes.get("id"),s=new sZ(t);for(let a of(this._idToTrackInfo.set(i,s),this._indexToTrackInfo.set(t.index,s),e.childElements()))switch(a.localName){case"part-name":t.name=s0.sanitizeDisplay(a.innerText);break;case"part-name-display":t.name=this.parsePartDisplayAsText(a);break;case"part-abbreviation":t.shortName=s0.sanitizeDisplay(a.innerText);break;case"part-abbreviation-display":t.shortName=this.parsePartDisplayAsText(a);break;case"score-instrument":this.parseScoreInstrument(a,s);break;case"midi-device":a.attributes.has("port")&&(t.playbackInfo.port=Number.parseInt(a.attributes.get("port"),10));break;case"midi-instrument":this.parseScorePartMidiInstrument(a,s)}s.firstArticulation&&(s.firstArticulation.outputMidiProgram>=0&&(t.playbackInfo.program=s.firstArticulation.outputMidiProgram),s.firstArticulation.outputBalance>=0&&(t.playbackInfo.balance=s.firstArticulation.outputBalance),s.firstArticulation.outputVolume>=0&&(t.playbackInfo.volume=s.firstArticulation.outputVolume),s.firstArticulation.outputMidiChannel>=0&&(t.playbackInfo.primaryChannel=s.firstArticulation.outputMidiChannel,t.playbackInfo.secondaryChannel=s.firstArticulation.outputMidiChannel))}parseScoreInstrument(e,t){let i=new sQ;t.firstArticulation||(t.firstArticulation=i),t.instruments.set(e.getAttribute("id",""),i)}parseScorePartMidiInstrument(e,t){let i=e.getAttribute("id","");if(!t.instruments.has(i))return;let s=t.instruments.get(i);for(let t of e.childElements())switch(t.localName){case"midi-channel":s.outputMidiChannel=Number.parseInt(t.innerText)-1;break;case"midi-program":s.outputMidiProgram=Number.parseInt(t.innerText)-1;break;case"midi-unpitched":s.outputMidiNumber=Number.parseInt(t.innerText)-1;break;case"volume":s.outputVolume=s0.interpolatePercent(Number.parseFloat(t.innerText));break;case"pan":s.outputBalance=s0.interpolatePan(Number.parseFloat(t.innerText))}}static interpolatePercent(e){return 0|s0.interpolate(0,100,0,16,e)}static interpolatePan(e){return 0|s0.interpolate(-90,90,0,16,e)}static interpolate(e,t,i,s,a){return i+(a-e)/(t-e)*(s-i)}parsePartDisplayAsText(e){let t="";for(let i of e.childElements())switch(i.localName){case"display-text":t+=i.innerText;break;case"accidental-text":switch(i.innerText){case"sharp":t+="";break;case"natural":t+="";break;case"flat":t+="";break;case"double-sharp":t+="";break;case"sharp-sharp":t+="";break;case"flat-flat":t+="";break;case"natural-sharp":t+="";break;case"natural-flat":t+="";break;case"sharp-down":t+="";break;case"sharp-up":t+="";break;case"natural-down":t+="";break;case"natural-up":t+="";break;case"flat-down":t+="";break;case"flat-up":t+="";break;case"arrow-down":t+="";break;case"arrow-up":t+="";break;case"triple-sharp":t+="";break;case"triple-flat":t+="";break;case"sharp-1":t+="";break;case"sharp-2":t+="";break;case"sharp-3":t+="";break;case"sharp-4":t+="";break;case"sharp-5":t+="";break;case"flat-1":t+="";break;case"flat-2":t+="";break;case"flat-3":t+="";break;case"flat-4":t+="";break;case"flat-5":t+=""}}return s0.sanitizeDisplay(t)}parseWork(e){for(let t of e.childElements())"work-title"===t.localName&&(this._score.title=s0.sanitizeDisplay(t.innerText))}parsePartwisePart(e){let t=e.attributes.get("id");if(!t||!this._idToTrackInfo.has(t))return;let i=this._idToTrackInfo.get(t).track,s=0;for(let t of e.childElements())"measure"===t.localName&&(this.parsePartwiseMeasure(t,i,s),s++)}parsePartwiseMeasure(e,t,i){let s=this.getOrCreateMasterBar(e,i);this.parsePartMeasure(e,s,t)}parseTimewiseMeasure(e,t){let i=this.getOrCreateMasterBar(e,t);for(let t of e.childElements())"part"===t.localName&&this.parseTimewisePart(t,i)}getOrCreateMasterBar(e,t){let i="yes"===e.attributes.get("implicit");for(;this._score.masterBars.length<=t;){let e=new iL;i&&(e.isAnacrusis=!0),this._score.addMasterBar(e),e.index>0&&(e.timeSignatureDenominator=e.previousMasterBar.timeSignatureDenominator,e.timeSignatureNumerator=e.previousMasterBar.timeSignatureNumerator,e.tripletFeel=e.previousMasterBar.tripletFeel)}return this._score.masterBars[t]}parseTimewisePart(e,t){let i=e.attributes.get("id");if(!i||!this._idToTrackInfo.has(i))return;let s=this._idToTrackInfo.get(i).track;this.parsePartMeasure(e,t,s)}parsePartMeasure(e,t,i){this._musicalPosition=0,this._lastBeat=null,t.alternateEndings=this._nextMasterBarRepeatEnding;let s=[];for(let a of e.childElements())switch(a.localName){case"note":this.parseNote(a,t,i);break;case"backup":this.parseBackup(a);break;case"forward":this.parseForward(a);break;case"direction":this.parseDirection(a,t,i);break;case"attributes":this.parseAttributes(a,t,i);break;case"harmony":this.parseHarmony(a,i);break;case"print":this.parsePrint(a,t,i);break;case"sound":this.parseSound(a,t,i);break;case"barline":s.push(a)}for(let e of s)this.parseBarLine(e,t,i);this.applySimileMarks(t,i);let a=this.getOrCreateStaff(i,0);this.getOrCreateBar(a,t),this._keyAllStaves=null}parsePrint(e,t,i){"yes"===e.getAttribute("new-system","no")?i.addLineBreaks(t.index):"yes"===e.getAttribute("new-page","no")&&i.addLineBreaks(t.index)}applySimileMarks(e,t){if(null!==this._simileMarkAllStaves){for(let i of t.staves){let t=this.getOrCreateBar(i,e);t.simileMark=this._simileMarkAllStaves,t.simileMark!==eZ.None&&this.clearBar(t)}this._simileMarkAllStaves===eZ.FirstOfDouble?this._simileMarkAllStaves=eZ.SecondOfDouble:this._simileMarkAllStaves=null}if(null!==this._simileMarkPerStaff){for(let i of Array.from(this._simileMarkPerStaff.keys())){let s=this.getOrCreateStaff(t,i),a=this.getOrCreateBar(s,e);a.simileMark=this._simileMarkPerStaff.get(i),a.simileMark!==eZ.None&&this.clearBar(a),a.simileMark===eZ.FirstOfDouble?this._simileMarkPerStaff.set(i,eZ.SecondOfDouble):this._simileMarkPerStaff.delete(i)}0===this._simileMarkPerStaff.size&&(this._simileMarkPerStaff=null)}}clearBar(e){for(let t of e.voices){let e=new i1;e.isEmpty=!0,t.addBeat(e)}}parseBarLine(e,t,i){for(let s of e.childElements())switch(s.localName){case"bar-style":this.parseBarStyle(s,t,i,e.getAttribute("location","right"));break;case"ending":this.parseEnding(s,t);break;case"repeat":this.parseRepeat(s,t)}}parseRepeat(e,t){let i=e.getAttribute("direction"),s=Number.parseInt(e.getAttribute("times"));(s<0||Number.isNaN(s))&&(s=2),"backward"===i?t.repeatCount=s:"forward"===i&&(t.isRepeatStart=!0)}parseEnding(e,t){let i=e.getAttribute("number").split(",").map(e=>Number.parseInt(e)),s=0;for(let e of i)s|=1<<e-1&255;switch(t.alternateEndings=s,e.getAttribute("type","")){case"start":this._nextMasterBarRepeatEnding=this._nextMasterBarRepeatEnding|s;break;case"stop":case"discontinue":this._nextMasterBarRepeatEnding=this._nextMasterBarRepeatEnding&~s}}parseBarStyle(e,t,i,s){let a=e3.Automatic;switch(e.innerText){case"dashed":a=e3.Dashed;break;case"dotted":a=e3.Dotted;break;case"heavy":a=e3.Heavy;break;case"heavy-heavy":a=e3.HeavyHeavy;break;case"heavy-light":a=e3.HeavyLight;break;case"light-heavy":a=e3.LightHeavy;break;case"light-light":a=e3.LightLight;break;case"none":a=e3.None;break;case"regular":a=e3.Regular;break;case"short":a=e3.Short;break;case"tick":a=e3.Tick}for(let e of i.staves){let i=this.getOrCreateBar(e,t);switch(s){case"left":i.barLineLeft=a;break;case"right":i.barLineRight=a}}}parseSound(e,t,i){for(let i of e.childElements())switch(i.localName){case"midi-instrument":this.parseSoundMidiInstrument(i,t);break;case"swing":this.parseSwing(i,t)}if(e.attributes.has("coda")&&t.addDirection(tI.TargetCoda),e.attributes.has("tocoda")&&t.addDirection(tI.JumpDaCoda),e.attributes.has("dacapo")&&t.addDirection(tI.JumpDaCapo),e.attributes.has("dalsegno")&&t.addDirection(tI.JumpDalSegno),e.attributes.has("fine")&&t.addDirection(tI.TargetFine),e.attributes.has("segno")&&t.addDirection(tI.TargetSegno),e.attributes.has("pan")){this._nextBeatAutomations||(this._nextBeatAutomations=[]);let t=new iv;t.type=e6.Balance,t.value=s0.interpolatePan(Number.parseFloat(e.attributes.get("pan"))),this._nextBeatAutomations.push(t)}if(e.attributes.has("tempo")){this._nextBeatAutomations||(this._nextBeatAutomations=[]);let t=new iv;t.type=e6.Tempo,t.value=s0.interpolatePercent(Number.parseFloat(e.attributes.get("tempo"))),this._nextBeatAutomations.push(t)}}parseSwing(e,t){let i=0,s=0,a=null;for(let r of e.childElements())switch(r.localName){case"straight":t.tripletFeel=tg.NoTripletFeel;return;case"first":i=Number.parseInt(r.innerText);break;case"second":s=Number.parseInt(r.innerText);break;case"swing-type":a=this.parseBeatDuration(r)}a||(a=tt.Eighth),a===tt.Eighth?2===i&&1===s?t.tripletFeel=tg.Triplet8th:3===i&&1===s?t.tripletFeel=tg.Dotted8th:1===i&&3===s&&(t.tripletFeel=tg.Scottish8th):a===tt.Sixteenth&&(2===i&&1===s?t.tripletFeel=tg.Triplet16th:3===i&&1===s?t.tripletFeel=tg.Dotted16th:1===i&&3===s&&(t.tripletFeel=tg.Scottish16th))}parseSoundMidiInstrument(e,t){let i;for(let t of e.childElements())switch(t.localName){case"midi-program":this._nextBeatAutomations||(this._nextBeatAutomations=[]),(i=new iv).type=e6.Instrument,i.value=Number.parseInt(t.innerText)-1,this._nextBeatAutomations.push(i);break;case"volume":this._nextBeatAutomations||(this._nextBeatAutomations=[]),(i=new iv).type=e6.Volume,i.value=s0.interpolatePercent(Number.parseFloat(t.innerText)),this._nextBeatAutomations.push(i);break;case"pan":this._nextBeatAutomations||(this._nextBeatAutomations=[]),(i=new iv).type=e6.Balance,i.value=s0.interpolatePan(Number.parseFloat(t.innerText)),this._nextBeatAutomations.push(i)}}parseHarmony(e,t){let i=new i7,s=!1,a="";for(let t of e.childElements())switch(t.localName){case"root":i.name=this.parseHarmonyRoot(t);break;case"kind":i.name=i.name+this.parseHarmonyKind(t),"yes"===t.getAttribute("parentheses-degrees","no")&&(s=!0);break;case"frame":this.parseHarmonyFrame(t,i);break;case"degree":a+=this.parseDegree(t)}a&&(i.name+=s?`(${a})`:a),null===this._nextBeatChord&&(this._nextBeatChord=i)}parseDegree(e){let t="",i="",s="";for(let a of e.childElements())switch(a.localName){case"degree-value":t=a.innerText;break;case"degree-alter":switch(a.innerText){case"-1":i="";break;case"1":i=""}break;case"degree-type":s+=a.getAttribute("text","")}return`${s}${i}${t}`}parseHarmonyRoot(e){let t="",i="";for(let s of e.childElements())switch(s.localName){case"root-step":t=s.innerText;break;case"root-alter":switch(Number.parseFloat(s.innerText)){case -2:i="bb";break;case -1:i="b";break;case 0:i="";break;case 1:i="#";break;case 2:i="##"}}return t+i}parseHarmonyKind(e){let t=e.getAttribute("text"),i="";if(t)i=t;else{let t=e.innerText;switch(t){case"major":i="";break;case"minor":i="m";break;case"augmented":i="+";break;case"diminished":i="";break;case"dominant":i="7";break;case"major-seventh":i="7M";break;case"minor-seventh":i="m7";break;case"diminished-seventh":i="7";break;case"augmented-seventh":i="+7";break;case"half-diminished":i="";break;case"major-minor":i="mMaj";break;case"major-sixth":i="maj6";break;case"minor-sixth":i="m6";break;case"dominant-ninth":i="9";break;case"major-ninth":i="maj9";break;case"minor-ninth":i="m9";break;case"dominant-11th":i="11";break;case"major-11th":i="maj11";break;case"minor-11th":i="m11";break;case"dominant-13th":i="13";break;case"major-13th":i="maj13";break;case"minor-13th":i="m13";break;case"suspended-second":i="sus2";break;case"suspended-fourth":i="sus4";break;case"Neapolitan":i="II";break;case"Italian":i="It";break;case"French":case"German":i="Fr";break;default:i=t}}return i}parseHarmonyFrame(e,t){for(let i of e.childElements())switch(i.localName){case"frame-strings":let e=Number.parseInt(i.innerText);t.strings=Array(e);for(let i=0;i<e;i++)t.strings[i]=-1;break;case"first-fret":t.firstFret=Number.parseInt(i.innerText);break;case"frame-note":let s=null,a=null;for(let e of i.childElements())switch(e.localName){case"string":s=Number.parseInt(e.innerText);break;case"fret":a=Number.parseInt(e.innerText),s&&a>=0&&(t.strings[s-1]=a);break;case"barre":s&&a&&"start"===e.getAttribute("type")&&t.barreFrets.push(a)}}}parseAttributes(e,t,i){let s,a,r;if(null==this._lastBeat)for(let n of e.childElements())switch(n.localName){case"divisions":this._divisionsPerQuarterNote=Number.parseFloat(n.innerText);break;case"key":this.parseKey(n,t,i);break;case"time":this.parseTime(n,t);break;case"staves":i.ensureStaveCount(Number.parseInt(n.innerText));break;case"clef":s=Number.parseInt(n.getAttribute("number","1"))-1,a=this.getOrCreateStaff(i,s),r=this.getOrCreateBar(a,t),this.parseClef(n,r);break;case"staff-details":s=Number.parseInt(n.getAttribute("number","1"))-1,a=this.getOrCreateStaff(i,s),this.parseStaffDetails(n,a);break;case"transpose":this.parseTranspose(n,i);break;case"measure-style":this.parseMeasureStyle(n,i,!1)}else for(let t of e.childElements())switch(t.localName){case"divisions":this._divisionsPerQuarterNote=Number.parseFloat(t.innerText);break;case"measure-style":this.parseMeasureStyle(t,i,!0)}}parseMeasureStyle(e,t,i){for(let t of e.childElements())switch(t.localName){case"measure-repeat":if(!i){let i=null;switch(t.getAttribute("type")){case"start":switch(Number.parseInt(t.getAttribute("slashes","1"))){case 1:i=eZ.Simple;break;case 2:i=eZ.FirstOfDouble}break;case"stop":i=null}if(e.attributes.has("number")){this._simileMarkPerStaff=this._simileMarkPerStaff??new Map;let t=Number.parseInt(e.attributes.get("number"))-1;null==i?this._simileMarkPerStaff.delete(t):this._simileMarkPerStaff.set(t,i)}else this._simileMarkAllStaves=i}break;case"slash":switch(t.getAttribute("type")){case"start":this._isBeatSlash=!0;break;case"stop":this._isBeatSlash=!1}}}parseTranspose(e,t){let i=0;for(let t of e.childElements())switch(t.localName){case"chromatic":i+=Number.parseFloat(t.innerText);break;case"octave-change":i+=12*Number.parseFloat(t.innerText)}if(e.attributes.has("number")){let s=this.getOrCreateStaff(t,Number.parseInt(e.attributes.get("number"))-1);this.getStaffContext(s).transpose=i,s.displayTranspositionPitch=i}else for(let e of t.staves)this.getStaffContext(e).transpose=i,e.displayTranspositionPitch=i}parseStaffDetails(e,t){for(let i of e.childElements())switch(i.localName){case"staff-lines":t.standardNotationLineCount=Number.parseInt(i.innerText);break;case"staff-tuning":this.parseStaffTuning(i,t);break;case"capo":t.capo=Number.parseInt(i.innerText)}}parseStaffTuning(e,t){0===t.stringTuning.tunings.length&&(t.showTablature=!0,t.showStandardNotation=!1,t.stringTuning.tunings=Array(t.standardNotationLineCount).fill(0));let i=Number.parseInt(e.getAttribute("line")),s="C",a="",r=0;for(let t of e.childElements())switch(t.localName){case"tuning-step":s=t.innerText;break;case"tuning-alter":r=Number.parseFloat(t.innerText);break;case"tuning-octave":a=t.innerText}let n=iW.getTuningForText(s+a)+r;t.tuning[t.tuning.length-i]=n}parseClef(e,t){let i="s",s=0;for(let a of e.childElements())switch(a.localName){case"sign":i=a.innerText.toLowerCase();break;case"line":s=Number.parseInt(a.innerText);break;case"clef-octave-change":switch(Number.parseInt(a.innerText)){case -2:case 2:t.clefOttava=eQ._15mb;break;case -1:t.clefOttava=eQ._8vb;break;case 1:t.clefOttava=eQ._8va}}switch(i){case"g":default:t.clef=eK.G2;break;case"f":t.clef=eK.F4;break;case"c":3===s?t.clef=eK.C3:t.clef=eK.C4;break;case"percussion":t.clef=eK.Neutral,t.staff.isPercussion=!0;break;case"tab":t.clef=eK.G2,t.staff.showTablature=!0}}parseTime(e,t){let i=!1,s=!1;for(let a of e.childElements()){let e=a.innerText;switch(a.localName){case"beats":i||(-1===e.indexOf("+")?t.timeSignatureNumerator=Number.parseInt(e):t.timeSignatureNumerator=e.split("+").map(e=>Number.parseInt(e)).reduce((e,t)=>t+e,0),i=!0);break;case"beat-type":s||(-1===e.indexOf("+")?t.timeSignatureDenominator=Number.parseInt(e):t.timeSignatureDenominator=e.split("+").map(e=>Number.parseInt(e)).reduce((e,t)=>t+e,0),s=!0)}}switch(e.getAttribute("symbol","")){case"common":case"cut":t.timeSignatureCommon=!0}}parseKey(e,t,i){let s,a,r=-e0.C,n="";for(let t of e.childElements())switch(t.localName){case"fifths":r=Number.parseInt(t.innerText);break;case"mode":n=t.innerText}if(s=-7<=r&&r<=7?r:e0.C,a="minor"===n?e1.Minor:e1.Major,e.attributes.has("number")){let r=this.getOrCreateStaff(i,Number.parseInt(e.attributes.get("number"))-1),n=this.getOrCreateBar(r,t);n.keySignature=s,n.keySignatureType=a}else for(let e of(this._keyAllStaves=[s,a],i.staves))e.bars.length>t.index&&(e.bars[t.index].keySignature=s,e.bars[t.index].keySignatureType=a)}parseDirection(e,t,i){let s=[],a=null,r=-1,n=-1;for(let t of e.childElements())switch(t.localName){case"direction-type":let e=t.firstElement;e&&s.push(e);break;case"offset":a=Number.parseFloat(t.innerText);break;case"voice":break;case"staff":r=Number.parseInt(t.innerText)-1;break;case"sound":t.attributes.has("tempo")&&(n=Number.parseFloat(t.attributes.get("tempo")))}let o=null,l=(o=r>=0?this.getOrCreateStaff(i,r):null!==this._lastBeat?this._lastBeat.voice.bar.staff:this.getOrCreateStaff(i,0))?this.getOrCreateBar(o,t):null,h=()=>{let e=this._musicalPosition;return null!==a&&(e+=a),e/t.calculateDuration(!1)};if(n>0){let e=new iv;e.type=e6.Tempo,e.value=n,e.ratioPosition=h(),this.hasSameTempo(t,e)||(t.tempoAutomations.push(e),0===t.index&&(t.score.tempo=e.value))}let d="";for(let e of s)switch(e.localName){case"rehearsal":t.section=new se,t.section.marker=e.innerText;break;case"segno":t.addDirection(tI.TargetSegno);break;case"coda":t.addDirection(tI.TargetCoda);break;case"words":d=e.innerText;break;case"wedge":switch(e.getAttribute("type")){case"crescendo":this._nextBeatCrescendo=te.Crescendo;break;case"diminuendo":this._nextBeatCrescendo=te.Decrescendo;break;case"stop":this._nextBeatCrescendo=null}break;case"dynamics":let i=this.parseDynamics(e);null!==i&&(this._currentDynamics=i,this._score.stylesheet.hideDynamics=!1);break;case"dashes":let s=e.getAttribute("type","start");switch(d){case"LetRing":this._nextBeatLetRing="start"===s||"continue"===s;break;case"P.M.":this._nextBeatPalmMute="start"===s||"continue"===s}d="";break;case"pedal":let a=this.parsePedal(e);if(a&&l){a.ratioPosition=h();let e=l.sustainPedals.length>0&&l.sustainPedals[l.sustainPedals.length-1].pedalType!==e2.Up;(a.pedalType!==e2.Up||e)&&l.sustainPedals.push(a)}break;case"metronome":this.parseMetronome(e,t,h());break;case"octave-shift":this._nextBeatOttavia=this.parseOctaveShift(e)}d&&(this._nextBeatText=d)}parseOctaveShift(e){let t=e.getAttribute("type");switch(Number.parseInt(e.getAttribute("size","8"))){case 15:switch(t){case"up":return eQ._15mb;case"down":return eQ._15ma;case"stop":return eQ.Regular;case"continue":return this._nextBeatOttavia}break;case 8:switch(t){case"up":return eQ._8vb;case"down":return eQ._8va;case"stop":return eQ.Regular;case"continue":return this._nextBeatOttavia}}return null}parseMetronome(e,t,i){let s=null,a=-1;for(let t of e.childElements())switch(t.localName){case"beat-unit":s=this.parseBeatDuration(t);break;case"per-minute":a=Number.parseFloat(t.innerText)}if(null!==s&&a>0){let e=new iv;e.type=e6.Tempo,e.value=s/4*a|0,e.ratioPosition=i,this.hasSameTempo(t,e)||(t.tempoAutomations.push(e),0===t.index&&(t.score.tempo=e.value))}}hasSameTempo(e,t){for(let i of e.tempoAutomations)if(t.ratioPosition===i.ratioPosition&&t.value===i.value)return!0;return!1}parsePedal(e){let t=new iB;switch(e.getAttribute("type")){case"start":t.pedalType=e2.Down;break;case"stop":t.pedalType=e2.Up;break;case"continue":t.pedalType=e2.Hold;break;default:return null}return t}parseDynamics(e){for(let t of e.childElements()){let e=t.localName.toUpperCase();switch(e){case"PPP":case"PP":case"P":case"MP":case"MF":case"F":case"FF":case"FFF":case"PPPP":case"PPPPP":case"PPPPPP":case"FFFF":case"FFFFF":case"FFFFFF":case"SF":case"SFP":case"SFPP":case"FP":case"RF":case"RFZ":case"SFZ":case"SFFZ":case"FZ":case"N":case"PF":case"SFZP":return e4[e]}}return null}parseForward(e){for(let t of e.childElements())"duration"===t.localName&&(this._musicalPosition+=this.musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(t.innerText)))}parseBackup(e){for(let t of e.childElements())if("duration"===t.localName&&this._lastBeat){let e=this._musicalPosition;(e-=this.musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(t.innerText)))<0&&(e=0),this._musicalPosition=e}}getOrCreateStaff(e,t){for(;e.staves.length<=t;){let t=new sr;e.addStaff(t),this._score.masterBars.length>0&&this.getOrCreateBar(t,this._score.masterBars[this._score.masterBars.length-1])}return e.staves[t]}getOrCreateBar(e,t){let i=0===e.bars.length?1:e.bars[0].voices.length;for(;e.bars.length<=t.index;){let t=new iN;e.addBar(t),t.previousBar&&(t.clef=t.previousBar.clef,t.clefOttava=t.previousBar.clefOttava,t.keySignature=t.previousBar.keySignature,t.keySignatureType=t.previousBar.keySignatureType),null!=this._keyAllStaves&&(t.keySignature=this._keyAllStaves[0],t.keySignatureType=this._keyAllStaves[1]);for(let e=0;e<i;e++){let e=new iO;t.addVoice(e)}}return e.bars[t.index]}getOrCreateVoice(e,t){let i=!1;for(;e.voices.length<=t;)e.addVoice(new iO),i=!0;if(i)for(let i of e.staff.bars)for(;i.voices.length<=t;)i.addVoice(new iO);return e.voices[t]}parseNote(e,t,i){let s=null,a=ti.None,r=0,n=null,o=!1,l=0,h=0,d=-1,c=null,u=0,p=-1,m=-1,g=null,f=null,y=!1,b=null,S="no"!==e.getAttribute("print-object","yes"),_=()=>{if(null!==s)return;o&&!this._lastBeat&&(iM.warning("MusicXML","Malformed MusicXML, <chord /> cannot be set on the first note of a measure"),o=!1),o&&!f&&(iM.warning("MusicXML","Cannot mix <chord /> and <rest />"),o=!1);let e=this.getOrCreateStaff(i,l);if(o)return void(s=this._lastBeat).addNote(f);let _=this.getOrCreateBar(e,t),w=this.getOrCreateVoice(_,h),k=0===w.beats.length?0:w.beats[w.beats.length-1].displayEnd,B=this._musicalPosition-k;if(B>0){if(this._lastBeat&&this._lastBeat.beamingMode===tF.ForceMergeWithNext&&this._lastBeat.voice.bar.staff.index!==l&&w.beats.length>0&&w.beats[w.beats.length-1].beamingMode===tF.ForceMergeWithNext){let e=w.beats[w.beats.length-1].duration;for(;B>0;){let t=this.createRestForGap(B,e);if(null!==t)this.insertBeatToVoice(t,w),B-=t.playbackDuration;else break}}if(B>0){let e=new i1;e.dynamics=this._currentDynamics,e.isEmpty=!0,e.duration=tt.TwoHundredFiftySixth,e.overrideDisplayDuration=B,e.updateDurations(),this.insertBeatToVoice(e,w)}}else B<0&&iM.error("MusicXML","Unsupported forward/backup detected. Cannot fill new beats into already filled area of voice");d<0&&null!==c&&(d=ix.toTicks(c),u>0&&(d=ix.applyDot(d,2===u)));let T=new i1;s=T,null===n?T.beamingMode=this.getStaffContext(e).isExplicitlyBeamed?tF.ForceSplitToNext:tF.Auto:(T.beamingMode=n,this.getStaffContext(e).isExplicitlyBeamed=!0),T.isEmpty=!1,T.dynamics=this._currentDynamics,this._isBeatSlash&&(T.slashed=!0);let N=this._nextBeatAutomations;if(this._nextBeatAutomations=null,null!==N)for(let e of N)T.automations.push(e);let x=this._nextBeatChord;this._nextBeatChord=null,null!==x&&(T.chordId=x.uniqueId,w.bar.staff.hasChord(x.uniqueId)||w.bar.staff.addChord(T.chordId,x));let P=this._nextBeatCrescendo;null!==P&&(T.crescendo=P);let v=this._nextBeatOttavia;if(null!==v&&(T.ottava=v),T.isLetRing=this._nextBeatLetRing,T.isPalmMute=this._nextBeatPalmMute,this._nextBeatText&&(T.text=this._nextBeatText,this._nextBeatText=null),null!==f&&T.addNote(f),this.insertBeatToVoice(T,w),null!==f){f.isVisible=S;let e=this._indexToTrackInfo.get(i.index);null!==b?f.percussionArticulation=e.getOrCreateArticulation(b,f):y||(f.percussionArticulation=e.getOrCreateArticulation("",f))}a!==ti.None?(T.graceType=a,this.applyBeatDurationFromTicks(T,r,null,!1)):(T.tupletNumerator=p,T.tupletDenominator=m,T.dots=u,T.preferredBeamDirection=g,this.applyBeatDurationFromTicks(T,d,c,!0)),this._musicalPosition=T.displayEnd,this._lastBeat=T};for(let t of e.childElements())switch(t.localName){case"grace":let e=Number.parseFloat(t.getAttribute("make-time","-1"));e>=0?(r=this.musicXmlDivisionsToAlphaTabTicks(e),a=ti.BeforeBeat):a=ti.OnBeat,"yes"===t.getAttribute("slash")&&(a=ti.BeforeBeat);break;case"chord":o=!0;break;case"cue":return;case"pitch":f=this.parsePitch(t),y=!0;break;case"unpitched":f=this.parseUnpitched(t,i);break;case"rest":f=null,null===c&&(c=tt.Whole);break;case"duration":d=this.parseDuration(t);break;case"instrument":b=t.getAttribute("id","");break;case"voice":Number.isNaN(h=Number.parseInt(t.innerText))?(iM.warning("MusicXML","Voices need to be specified as numbers"),h=0):h-=1;break;case"type":c=this.parseBeatDuration(t);break;case"dot":u++;break;case"accidental":null===f?iM.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this.parseAccidental(t,f);break;case"time-modification":for(let e of t.childElements())switch(e.localName){case"actual-notes":p=Number.parseInt(e.innerText);break;case"normal-notes":m=Number.parseInt(e.innerText)}break;case"stem":g=this.parseStem(t);break;case"notehead":null===f?iM.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this.parseNoteHead(t,f,c??tt.Quarter,g??this.estimateBeamDirection(f));break;case"staff":l=Number.parseInt(t.innerText)-1;break;case"beam":if("1"===t.getAttribute("number","1"))switch(t.innerText){case"begin":case"continue":n=tF.ForceMergeWithNext;break;case"end":n=tF.ForceSplitToNext}break;case"notations":_(),this.parseNotations(t,f,s);break;case"lyric":_(),this.parseLyric(t,s,i);break;case"play":this.parsePlay(t,f)}if(y){let e=this.getOrCreateStaff(i,l),t=this.getStaffContext(e).transpose;if(0!==t){let e=12*f.octave+f.tone+t;f.octave=e/12|0,f.tone=e-12*f.octave}}_()}parsePlay(e,t){for(let i of e.childElements())"mute"===i.localName&&t&&"palm"===i.innerText&&(t.isPalmMute=!0)}estimateBeamDirection(e){return e.calculateRealValue(!1,!1)<s0.B4Value?tR.Down:tR.Up}parseNoteHead(e,t,i,s){let a;"yes"===e.getAttribute("parentheses","no")&&(t.isGhost=!0);let r=e.getAttribute("filled","");switch("yes"===r?a=!0:"no"===r&&(a=!1),t.style=new iJ,e.innerText){case"arrow down":t.style.noteHeadCenterOnStem=!0,this.applyNoteHead(t,i,a,tb.NoteheadTriangleDownDoubleWhole,tb.NoteheadTriangleDownWhole,tb.NoteheadTriangleDownHalf,tb.NoteheadTriangleDownBlack);break;case"arrow up":t.style.noteHeadCenterOnStem=!0,this.applyNoteHead(t,i,a,tb.NoteheadTriangleUpDoubleWhole,tb.NoteheadTriangleUpWhole,tb.NoteheadTriangleUpHalf,tb.NoteheadTriangleUpBlack);break;case"back slashed":this.applyNoteHead(t,i,a,tb.NoteheadSlashedDoubleWhole2,tb.NoteheadSlashedWhole2,tb.NoteheadSlashedHalf2,tb.NoteheadSlashedBlack2);break;case"circle dot":t.style.noteHead=tb.NoteheadRoundWhiteWithDot;break;case"circle-x":this.applyNoteHead(t,i,a,tb.NoteheadCircleXDoubleWhole,tb.NoteheadCircleXWhole,tb.NoteheadCircleXHalf,tb.NoteheadCircleX);break;case"circled":this.applyNoteHead(t,i,a,tb.NoteheadCircledDoubleWhole,tb.NoteheadCircledWhole,tb.NoteheadCircledHalf,tb.NoteheadCircledBlack);break;case"cluster":this.applyNoteHead(t,i,a,tb.NoteheadClusterDoubleWhole3rd,tb.NoteheadClusterWhole3rd,tb.NoteheadClusterHalf3rd,tb.NoteheadClusterQuarter3rd);break;case"cross":this.applyNoteHead(t,i,a,tb.NoteheadPlusDoubleWhole,tb.NoteheadPlusWhole,tb.NoteheadPlusHalf,tb.NoteheadPlusBlack);break;case"diamond":this.applyNoteHead(t,i,a,tb.NoteheadDiamondDoubleWhole,tb.NoteheadDiamondWhole,tb.NoteheadDiamondHalf,tb.NoteheadDiamondBlack);break;case"do":this.applyNoteHead(t,i,a,tb.NoteShapeTriangleUpWhite,tb.NoteShapeTriangleUpWhite,tb.NoteShapeTriangleUpWhite,tb.NoteShapeTriangleUpBlack);break;case"fa":s===tR.Up?this.applyNoteHead(t,i,a,tb.NoteShapeTriangleRightWhite,tb.NoteShapeTriangleRightWhite,tb.NoteShapeTriangleRightWhite,tb.NoteShapeTriangleRightBlack):this.applyNoteHead(t,i,a,tb.NoteShapeTriangleLeftWhite,tb.NoteShapeTriangleLeftWhite,tb.NoteShapeTriangleLeftWhite,tb.NoteShapeTriangleLeftBlack);break;case"fa up":this.applyNoteHead(t,i,a,tb.NoteShapeTriangleLeftWhite,tb.NoteShapeTriangleLeftWhite,tb.NoteShapeTriangleLeftWhite,tb.NoteShapeTriangleLeftBlack);break;case"inverted triangle":this.applyNoteHead(t,i,a,tb.NoteheadTriangleDownDoubleWhole,tb.NoteheadTriangleDownWhole,tb.NoteheadTriangleDownHalf,tb.NoteheadTriangleDownBlack);break;case"la":case"square":this.applyNoteHead(t,i,a,tb.NoteShapeSquareWhite,tb.NoteShapeSquareWhite,tb.NoteShapeSquareWhite,tb.NoteShapeSquareBlack);break;case"left triangle":this.applyNoteHead(t,i,a,tb.NoteheadTriangleRightWhite,tb.NoteheadTriangleRightWhite,tb.NoteheadTriangleRightWhite,tb.NoteheadTriangleRightBlack);break;case"mi":this.applyNoteHead(t,i,a,tb.NoteShapeDiamondWhite,tb.NoteShapeDiamondWhite,tb.NoteShapeDiamondWhite,tb.NoteShapeDiamondBlack);break;case"none":t.style.noteHead=tb.NoteheadNull;break;case"normal":this.applyNoteHead(t,i,a,tb.NoteheadDoubleWhole,tb.NoteheadWhole,tb.NoteheadHalf,tb.NoteheadBlack);break;case"re":this.applyNoteHead(t,i,a,tb.NoteShapeMoonWhite,tb.NoteShapeMoonWhite,tb.NoteShapeMoonWhite,tb.NoteShapeMoonBlack);break;case"rectangle":this.applyNoteHead(t,i,a,tb.NoteheadSquareWhite,tb.NoteheadSquareWhite,tb.NoteheadSquareWhite,tb.NoteheadSquareBlack);break;case"slash":this.applyNoteHead(t,i,a,tb.NoteheadSlashWhiteWhole,tb.NoteheadSlashWhiteWhole,tb.NoteheadSlashWhiteHalf,tb.NoteheadSlashVerticalEnds);break;case"slashed":this.applyNoteHead(t,i,a,tb.NoteheadSlashedDoubleWhole1,tb.NoteheadSlashedWhole1,tb.NoteheadSlashedHalf1,tb.NoteheadSlashedBlack1);break;case"so":this.applyNoteHead(t,i,a,tb.NoteShapeRoundWhite,tb.NoteShapeRoundWhite,tb.NoteShapeRoundWhite,tb.NoteShapeRoundBlack);break;case"ti":this.applyNoteHead(t,i,a,tb.NoteShapeTriangleRoundWhite,tb.NoteShapeTriangleRoundWhite,tb.NoteShapeTriangleRoundWhite,tb.NoteShapeTriangleRoundBlack);break;case"triangle":this.applyNoteHead(t,i,a,tb.NoteheadTriangleUpDoubleWhole,tb.NoteheadTriangleUpWhole,tb.NoteheadTriangleUpHalf,tb.NoteheadTriangleUpBlack);break;case"x":this.applyNoteHead(t,i,a,tb.NoteheadXDoubleWhole,tb.NoteheadXWhole,tb.NoteheadXHalf,tb.NoteheadXBlack)}}createRestForGap(e,t){let i=ix.toTicks(t);for(;i>e;){if(t===tt.TwoHundredFiftySixth)return null;t*=2,i=ix.toTicks(t)}let s=new i1;return s.dynamics=this._currentDynamics,s.isEmpty=!1,s.duration=t,s.overrideDisplayDuration=i,s.updateDurations(),s}insertBeatToVoice(e,t){if(t.beats.length>0){let i=t.beats[t.beats.length-1];i.nextBeat=e,e.previousBeat=i;let s=i;for(;null!==s&&s.graceType!==ti.None;)s=s.index>0?s.previousBeat:null;null!==s&&(e.displayStart=s.displayEnd)}t.addBeat(e)}musicXmlDivisionsToAlphaTabTicks(e){return e*ix.QuarterTime/this._divisionsPerQuarterNote}parseBeatDuration(e){switch(e.innerText){case"1024th":case"512th":case"256th":return tt.TwoHundredFiftySixth;case"128th":return tt.OneHundredTwentyEighth;case"64th":return tt.SixtyFourth;case"32nd":return tt.ThirtySecond;case"16th":return tt.Sixteenth;case"eighth":return tt.Eighth;case"quarter":return tt.Quarter;case"half":return tt.Half;case"whole":return tt.Whole;case"breve":return tt.DoubleWhole;case"long":return tt.QuadrupleWhole}return null}applyBeatDurationFromTicks(e,t,i,s){if(!i)for(let e=0;e<s0.allDurations.length;e++)if(t>=s0.allDurationTicks[e])i=s0.allDurations[e];else break;e.duration=i??tt.Sixteenth,s&&(e.overrideDisplayDuration=t),e.updateDurations()}parseLyric(e,t,i){let s=this._indexToTrackInfo.get(i.index).getLyricLine(e.getAttribute("number",""));for(null===t.lyrics&&(t.lyrics=[]);t.lyrics.length<=s;)t.lyrics.push("");for(let i of e.childElements())switch(i.localName){case"text":t.lyrics[s]?t.lyrics[s]+=` ${i.innerText}`:t.lyrics[s]=i.innerText;break;case"elision":t.lyrics[s]+=i.innerText}}parseNotations(e,t,i){for(let s of e.childElements())switch(s.localName){case"tied":t&&this.parseTied(s,t,i.voice.bar.staff);break;case"slur":t&&this.parseSlur(s,t);break;case"glissando":t&&this.parseGlissando(s,t);break;case"slide":t&&this.parseSlide(s,t);break;case"ornaments":t&&this.parseOrnaments(s,t);break;case"technical":this.parseTechnical(s,t,i);break;case"articulations":t&&this.parseArticulations(s,t);break;case"dynamics":let e=this.parseDynamics(s);null!==e&&(i.dynamics=e,this._currentDynamics=e);break;case"fermata":this.parseFermata(s,i);break;case"arpeggiate":this.parseArpeggiate(s,i)}}getStaffContext(e){if(!this._staffToContext.has(e)){let t=new sK;return this._staffToContext.set(e,t),t}return this._staffToContext.get(e)}parseGlissando(e,t){let i=e.getAttribute("type"),s=e.getAttribute("number","1"),a=this.getStaffContext(t.beat.voice.bar.staff);switch(i){case"start":a.slideOrigins.set(s,t);break;case"stop":if(a.slideOrigins.has(s)){let e=a.slideOrigins.get(s);e.slideTarget=t,t.slideOrigin=e,e.slideOutType=tl.Shift}}}parseSlur(e,t){let i=e.getAttribute("number","1"),s=this.getStaffContext(t.beat.voice.bar.staff);switch(e.getAttribute("type")){case"start":s.slurStarts.set(i,t);break;case"stop":if(s.slurStarts.has(i)){t.isSlurDestination=!0;let e=s.slurStarts.get(i);e.slurDestination=t,t.slurOrigin=e,s.slurStarts.delete(i)}}}parseArpeggiate(e,t){switch(e.getAttribute("direction","down")){case"down":t.brushType=e9.ArpeggioDown;break;case"up":t.brushType=e9.ArpeggioUp}}parseFermata(e,t){let i;switch(e.innerText){case"normal":default:i=tA.Medium;break;case"angled":i=tA.Short;break;case"square":i=tA.Long}t.fermata=new sc,t.fermata.type=i}parseArticulations(e,t){for(let i of e.childElements())switch(i.localName){case"accent":t.accentuated=ts.Normal;break;case"strong-accent":t.accentuated=ts.Heavy;break;case"staccato":t.isStaccato=!0;break;case"tenuto":t.accentuated=ts.Tenuto}}parseTechnical(e,t,i){let s=[];for(let a of e.childElements())switch(a.localName){case"up-bow":i.pickStroke=ty.Up;break;case"down-bow":i.pickStroke=ty.Down;break;case"harmonic":break;case"fingering":t&&(t.leftHandFinger=this.parseFingering(a));break;case"pluck":t&&(t.rightHandFinger=this.parseFingering(a));break;case"fret":t&&(t.fret=Number.parseInt(a.innerText));break;case"string":t&&(t.string=i.voice.bar.staff.tuning.length-Number.parseInt(a.innerText)+1);break;case"hammer-on":case"pull-off":t&&(t.isHammerPullOrigin=!0);break;case"bend":s.push(a);break;case"tap":i.tap=!0;break;case"smear":t&&(t.vibrato=th.Slight);break;case"golpe":switch(a.getAttribute("placement","above")){case"above":i.golpe=tT.Finger;break;case"below":i.golpe=tT.Thumb}}t&&s.length>0&&this.parseBends(s,t)}parseBends(e,t){let i=iF.MaxPosition/e.length,s=0,a=0,r=!0;for(let n of e){let e=n.findChildElement("bend-alter");if(e){let o=Math.round(2*Math.abs(Number.parseFloat(e.innerText)));n.findChildElement("pre-bend")?r?(s+=o,t.addBendPoint(new iF(a,s)),a+=i,t.addBendPoint(new iF(a,s)),r=!1):a+=i:(n.findChildElement("release")?(r&&(s+=o),t.addBendPoint(new iF(a,s)),a+=i,s-=o):(t.addBendPoint(new iF(a,s)),s+=o,a+=i),t.addBendPoint(new iF(a,s)),r=!1)}}}parseFingering(e){switch(e.innerText){case"0":return ta.NoOrDead;case"1":case"p":case"t":return ta.Thumb;case"2":case"i":return ta.IndexFinger;case"3":case"m":return ta.MiddleFinger;case"4":case"a":return ta.AnnularFinger;case"5":case"c":return ta.LittleFinger}return ta.Unknown}parseOrnaments(e,t){let i=-1;for(let s of e.childElements())switch(s.localName){case"trill-mark":i=Number.parseInt(s.getAttribute("trill-step","2")),t.isStringed?t.trillValue=t.stringTuning+i:t.isPercussion||(t.trillValue=t.calculateRealValue(!1,!1)+i);break;case"turn":t.ornament=tw.Turn;break;case"inverted-turn":t.ornament=tw.InvertedTurn;break;case"wavy-line":i>0?"start"===s.getAttribute("type")&&(this._currentTrillStep=i):this._currentTrillStep>0?"stop"===s.getAttribute("type")?this._currentTrillStep=-1:t.isStringed?t.trillValue=t.stringTuning+this._currentTrillStep:t.isPercussion||(t.trillValue=t.calculateRealValue(!1,!1)+this._currentTrillStep):t.vibrato=th.Slight;break;case"mordent":t.ornament=tw.LowerMordent;break;case"inverted-mordent":t.ornament=tw.UpperMordent;break;case"tremolo":switch(s.innerText){case"1":t.beat.tremoloSpeed=tt.Eighth;break;case"2":t.beat.tremoloSpeed=tt.Sixteenth;break;case"3":t.beat.tremoloSpeed=tt.ThirtySecond}}}parseSlide(e,t){let i=e.getAttribute("type"),s=e.getAttribute("number","1"),a=this.getStaffContext(t.beat.voice.bar.staff);switch(i){case"start":a.slideOrigins.set(s,t);break;case"stop":if(a.slideOrigins.has(s)){let e=a.slideOrigins.get(s);e.slideTarget=t,t.slideOrigin=e,e.slideOutType=tl.Shift}}}parseTied(e,t,i){let s=e.getAttribute("type"),a=e.getAttribute("number",""),r=this.getStaffContext(i);if("start"===s){if(a){if(r.tieStartIds.has(a)){let e=r.tieStartIds.get(a);r.tieStarts.delete(e)}r.tieStartIds.set(a,t)}r.tieStarts.add(t)}else if("stop"===s&&!t.isTieDestination){let e=null;if(a){if(!r.tieStartIds.has(a))return;e=r.tieStartIds.get(a),r.tieStartIds.delete(a),r.tieStarts.delete(t)}else{let i=this.calculatePitchedNoteValue(t);for(let t of r.tieStarts)if(this.calculatePitchedNoteValue(t)===i){e=t,r.tieStarts.delete(e);break}}if(!e)return;t.isTieDestination=!0,t.tieOrigin=e}}parseStem(e){switch(e.innerText){case"down":return tR.Down;case"up":return tR.Up;default:return null}}parseAccidental(e,t){switch(e.innerText){case"sharp":t.accidentalMode=tn.ForceSharp;break;case"natural":t.accidentalMode=tn.ForceNatural;break;case"flat":t.accidentalMode=tn.ForceFlat;break;case"double-sharp":t.accidentalMode=tn.ForceDoubleSharp;break;case"flat-flat":t.accidentalMode=tn.ForceDoubleFlat}}calculatePitchedNoteValue(e){return 12*e.octave+e.tone}parseDuration(e){return this.musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(e.innerText))}parseUnpitched(e,t){let i="",s=0;for(let t of e.childElements())switch(t.localName){case"display-step":i=t.innerText;break;case"display-octave":s=Number.parseInt(t.innerText)+1}let a=new iY;if(""===i)a.octave=0,a.tone=0;else{let e=12*s+iW.getToneForText(i).noteValue;a.octave=e/12|0,a.tone=e-12*a.octave}return a}parsePitch(e){let t="",i=0,s=0;for(let a of e.childElements())switch(a.localName){case"step":t=a.innerText;break;case"alter":Number.isNaN(i=Number.parseFloat(a.innerText))&&(i=0);break;case"octave":s=Number.parseInt(a.innerText)+1}i|=0;let a=12*s+iW.getToneForText(t).noteValue+i,r=new iY;return r.octave=a/12|0,r.tone=a-12*r.octave,r}applyNoteHead(e,t,i,s,a,r,n){if(void 0===i)switch(t){case tt.QuadrupleWhole:case tt.DoubleWhole:e.style.noteHead=s;break;case tt.Whole:e.style.noteHead=a;break;case tt.Half:e.style.noteHead=r;break;default:e.style.noteHead=n}else if(!0===i)e.style.noteHead=n;else switch(t){case tt.QuadrupleWhole:case tt.DoubleWhole:e.style.noteHead=s;break;case tt.Whole:e.style.noteHead=a;break;case tt.Half:default:e.style.noteHead=r}}}s0.B4Value=71,s0.allDurations=[tt.TwoHundredFiftySixth,tt.OneHundredTwentyEighth,tt.SixtyFourth,tt.ThirtySecond,tt.Sixteenth,tt.Eighth,tt.Quarter,tt.Half,tt.Whole,tt.DoubleWhole,tt.QuadrupleWhole],s0.allDurationTicks=s0.allDurations.map(e=>ix.toTicks(e)),(ep=tY||(tY={}))[ep.SingleTrackMultiChannel=0]="SingleTrackMultiChannel",ep[ep.MultiTrack=1]="MultiTrack";class s1{constructor(){this.events=[]}addEvent(e){if(0===this.events.length||e.tick>=this.events[this.events.length-1].tick)this.events.push(e);else{let t=this.events.length;for(;t>0;)if(this.events[t-1].tick>e.tick)t--;else break;this.events.splice(t,0,e)}}writeTo(e){let t=sd.empty(),i=0;for(let e of this.events){let s=e.tick-i;s2.writeVariableInt(t,s),e.writeTo(t),i=e.tick}let s=new Uint8Array([77,84,114,107]);e.write(s,0,s.length);let a=t.toArray();sh.writeInt32BE(e,a.length),e.write(a,0,a.length)}}class s2{constructor(){this.format=tY.SingleTrackMultiChannel,this.division=ix.QuarterTime,this.tracks=[]}get events(){if(1===this.tracks.length)return this.tracks[0].events;let e=[];for(let e of this.tracks)this.events.push(...e.events);return e.sort((e,t)=>e.tick-t.tick),e}ensureTracks(e){for(;this.tracks.length<e;)this.tracks.push(new s1)}addEvent(e){this.format===tY.SingleTrackMultiChannel?(this.ensureTracks(1),this.tracks[0].addEvent(e)):(this.ensureTracks(e.track+1),this.tracks[e.track].addEvent(e))}toBinary(){let e=sd.empty();return this.writeTo(e),e.toArray()}writeTo(e){let t=new Uint8Array([77,84,104,100]);for(let i of(e.write(t,0,t.length),sh.writeInt32BE(e,6),sh.writeInt16BE(e,this.format),sh.writeInt16BE(e,this.tracks.length),sh.writeInt16BE(e,this.division),this.tracks))i.writeTo(e)}static writeVariableInt(e,t){let i=new Uint8Array(4),s=0;do i[s++]=127&t,t>>=7;while(t>0)for(;s>0;)--s>0?e.writeByte(128|i[s]):e.writeByte(i[s])}}(em=tq||(tq={}))[em.TimeSignature=88]="TimeSignature",em[em.NoteOn=128]="NoteOn",em[em.NoteOff=144]="NoteOff",em[em.ControlChange=176]="ControlChange",em[em.ProgramChange=192]="ProgramChange",em[em.TempoChange=81]="TempoChange",em[em.PitchBend=224]="PitchBend",em[em.PerNotePitchBend=96]="PerNotePitchBend",em[em.EndOfTrack=47]="EndOfTrack",em[em.AlphaTabRest=241]="AlphaTabRest",em[em.AlphaTabMetronome=242]="AlphaTabMetronome",em[em.SystemExclusive=240]="SystemExclusive",em[em.SystemExclusive2=247]="SystemExclusive2",em[em.Meta=255]="Meta";class s5{constructor(e,t,i){this.track=e,this.tick=t,this.type=i}get command(){return this.type}get message(){return 0}get data1(){return 0}get data2(){return 0}}class s3 extends s5{constructor(e,t,i,s,a,r){super(e,t,tq.TimeSignature),this.track=e,this.tick=t,this.numerator=i,this.denominatorIndex=s,this.midiClocksPerMetronomeClick=a,this.thirtySecondNodesInQuarter=r}writeTo(e){e.writeByte(255),e.writeByte(88),s2.writeVariableInt(e,4),e.writeByte(255&this.numerator),e.writeByte(255&this.denominatorIndex),e.writeByte(255&this.midiClocksPerMetronomeClick),e.writeByte(255&this.thirtySecondNodesInQuarter)}}class s4 extends s5{writeTo(e){e.writeByte(240);let t=sd.withCapacity(16);t.writeByte(s4.AlphaTabManufacturerId),this.writeEventData(t),t.writeByte(247),s2.writeVariableInt(e,t.length),t.copyTo(e)}}s4.AlphaTabManufacturerId=125,s4.MetronomeEventId=0,s4.RestEventId=1;class s6 extends s4{constructor(e,t,i,s,a){super(e,t,tq.AlphaTabMetronome),this.isMetronome=!0,this.metronomeNumerator=i,this.metronomeDurationInMilliseconds=a,this.metronomeDurationInTicks=s}writeEventData(e){e.writeByte(s4.MetronomeEventId),e.writeByte(this.metronomeNumerator),sh.writeInt32LE(e,this.metronomeDurationInTicks),sh.writeInt32LE(e,this.metronomeDurationInMilliseconds)}}class s8 extends s4{constructor(e,t,i){super(e,t,tq.AlphaTabRest),this.channel=i}writeEventData(e){e.writeByte(s4.RestEventId),e.writeByte(this.channel)}}class s7 extends s5{constructor(e,t,i,s,a,r){super(e,t,i),this.channel=s,this.noteKey=a,this.noteVelocity=r}get data1(){return this.noteKey}get data2(){return this.noteVelocity}}class s9 extends s7{constructor(e,t,i,s,a){super(e,t,tq.NoteOn,i,s,a)}writeTo(e){e.writeByte(15&this.channel|144),e.writeByte(255&this.noteKey),e.writeByte(255&this.noteVelocity)}}class ae extends s7{constructor(e,t,i,s,a){super(e,t,tq.NoteOff,i,s,a)}writeTo(e){e.writeByte(15&this.channel|128),e.writeByte(255&this.noteKey),e.writeByte(255&this.noteVelocity)}}class at extends s5{constructor(e,t,i,s,a){super(e,t,tq.ControlChange),this.channel=i,this.controller=s,this.value=a}writeTo(e){e.writeByte(15&this.channel|176),e.writeByte(255&this.controller),e.writeByte(255&this.value)}get data1(){return this.controller}get data2(){return this.value}}class ai extends s5{constructor(e,t,i,s){super(e,t,tq.ProgramChange),this.channel=i,this.program=s}writeTo(e){e.writeByte(15&this.channel|192),e.writeByte(255&this.program)}get data1(){return this.program}}class as extends s5{get microSecondsPerQuarterNote(){return 6e7/this.beatsPerMinute}set microSecondsPerQuarterNote(e){this.beatsPerMinute=6e7/e}constructor(e,t){super(0,e,tq.TempoChange),this.beatsPerMinute=0,this.microSecondsPerQuarterNote=t}writeTo(e){e.writeByte(255),e.writeByte(81),e.writeByte(3),e.writeByte(this.microSecondsPerQuarterNote>>16&255),e.writeByte(this.microSecondsPerQuarterNote>>8&255),e.writeByte(255&this.microSecondsPerQuarterNote)}}class aa extends s5{constructor(e,t,i,s){super(e,t,tq.PitchBend),this.channel=i,this.value=s}writeTo(e){e.writeByte(15&this.channel|224),e.writeByte(127&this.value),e.writeByte(this.value>>7&127)}get data1(){return 127&this.value}get data2(){return this.value>>7&127}}class ar extends s5{constructor(e,t,i,s,a){super(e,t,tq.PerNotePitchBend),this.channel=i,this.noteKey=s,this.value=a}writeTo(e){throw new i6(tE.General,"Note Bend (Midi2.0) events cannot be exported to SMF1.0")}}class an extends s5{constructor(e,t){super(e,t,tq.EndOfTrack)}writeTo(e){e.writeByte(255),e.writeByte(47),e.writeByte(0)}}class ao{constructor(e,t){this.time=0,this.eventIndex=e,this.event=t,this.isMetronome=this.event.type===tq.AlphaTabMetronome}static newMetronomeEvent(e,t,i,s,a){return new ao(e,new s6(0,t,i,s,a))}}class al{constructor(){this.masterBarIndex=0,this.masterBarOccurence=0,this.synthBpm=0,this.synthTime=0,this.synthTick=0,this.syncTime=0,this.syncBpm=0}updateSyncBpm(e,t){let i=(e-this.synthTime)/(t-this.syncTime)*this.synthBpm;this.syncBpm=i}}class ah{constructor(e,t,i){this.bpm=e,this.ticks=t,this.time=i}}class ad{constructor(){this.tempoChanges=[],this.tempoChangeIndex=0,this.syncPoints=[],this.firstProgramEventPerChannel=new Map,this.firstTimeSignatureNumerator=0,this.firstTimeSignatureDenominator=0,this.synthData=[],this.division=ix.QuarterTime,this.eventIndex=0,this.currentTime=0,this.syncPointIndex=0,this.playbackRange=null,this.playbackRangeStartTime=0,this.playbackRangeEndTime=0,this.endTick=0,this.endTime=0,this.currentTempo=0,this.syncPointTempo=0}}class ac{get isPlayingMain(){return this._currentState===this._mainState}get isPlayingOneTimeMidi(){return this._currentState===this._oneTimeState}get isPlayingCountIn(){return this._currentState===this._countInState}constructor(e){this._oneTimeState=null,this._countInState=null,this.isLooping=!1,this.playbackSpeed=1,this.instrumentPrograms=new Set,this.percussionKeys=new Set,this._synthesizer=e,this._mainState=new ad,this._currentState=this._mainState}get mainPlaybackRange(){return this._mainState.playbackRange}set mainPlaybackRange(e){this._mainState.playbackRange=e,e&&(this._mainState.playbackRangeStartTime=this.tickPositionToTimePositionWithSpeed(this._mainState,e.startTick,1),this._mainState.playbackRangeEndTime=this.tickPositionToTimePositionWithSpeed(this._mainState,e.endTick,1))}get currentTime(){return this._currentState.currentTime/this.playbackSpeed}get currentEndTick(){return this._currentState.endTick}get currentEndTime(){return this._currentState.endTime/this.playbackSpeed}get currentTempo(){return this._currentState.currentTempo}get modifiedTempo(){return this._currentState.syncPointTempo*this.playbackSpeed}get syncPointTempo(){return this._currentState.syncPointTempo}get currentSyncPoints(){return this._currentState.syncPoints}mainSeek(e){if(e*=this.playbackSpeed,this.mainPlaybackRange&&(e<this._mainState.playbackRangeStartTime?e=this._mainState.playbackRangeStartTime:e>this._mainState.playbackRangeEndTime&&(e=this._mainState.playbackRangeEndTime)),e>this._mainState.currentTime)this.mainSilentProcess(e-this._mainState.currentTime);else if(e<this._mainState.currentTime){if(this._mainState.currentTime=0,this._mainState.eventIndex=0,this._mainState.syncPointIndex=0,this._mainState.tempoChangeIndex=0,this._mainState.currentTempo=this._mainState.tempoChanges[0].bpm,this._mainState.syncPointTempo=this._mainState.syncPoints.length>0?this._mainState.syncPoints[0].syncBpm:this._mainState.currentTempo,this.isPlayingMain){let e=this._synthesizer.metronomeVolume;this._synthesizer.noteOffAll(!0),this._synthesizer.resetSoft(),this._synthesizer.setupMetronomeChannel(e)}this.mainSilentProcess(e)}}mainSilentProcess(e){if(e<=0)return;let t=Date.now(),i=this._mainState.currentTime+e;if(this.isPlayingMain)for(;this._mainState.currentTime<i;)this.fillMidiEventQueueLimited(i-this._mainState.currentTime)&&this._synthesizer.synthesizeSilent(iI.MicroBufferSize);this._mainState.currentTime=i;let s=Date.now()-t;iM.debug("Sequencer",`Silent seek finished in ${s}ms (main)`)}loadOneTimeMidi(e){this._oneTimeState=this.createStateFromFile(e),this._currentState=this._oneTimeState}loadMidi(e){this.instrumentPrograms.clear(),this.percussionKeys.clear(),this._mainState=this.createStateFromFile(e),this._currentState=this._mainState}createStateFromFile(e){let t=new ad;this.percussionKeys.add(iI.MetronomeKey),t.tempoChanges=[],t.division=e.division,t.eventIndex=0,t.currentTime=0,t.synthData=[];let i=120,s=0,a=0,r=0,n=0,o=0,l=0,h=0,d=0;for(let c of e.events){let u=new ao(t.synthData.length,c);t.synthData.push(u);let p=c.tick-d;if(s+=p,u.time=a+=p*(6e4/(i*e.division)),d=c.tick,n>0)for(;l<s;){let e=ao.newMetronomeEvent(t.synthData.length,l,Math.floor(l/n)%r,n,o);t.synthData.push(e),e.time=h,l+=n,h+=o}if(c.type===tq.TempoChange)i=c.beatsPerMinute,t.tempoChanges.push(new ah(i,s,a)),o=n*(6e4/(i*e.division));else if(c.type===tq.TimeSignature){let s=Math.pow(2,c.denominatorIndex);r=c.numerator,o=(n=t.division*(4/s)|0)*(6e4/(i*e.division)),0===t.firstTimeSignatureDenominator&&(t.firstTimeSignatureNumerator=c.numerator,t.firstTimeSignatureDenominator=s)}else if(c.type===tq.ProgramChange){let e=c.channel;t.firstProgramEventPerChannel.has(e)||t.firstProgramEventPerChannel.set(e,u),e!==iI.PercussionChannel&&this.instrumentPrograms.add(c.program)}else c.type===tq.NoteOn&&c.channel===iI.PercussionChannel&&this.percussionKeys.add(c.noteKey)}return t.currentTempo=t.tempoChanges.length>0?t.tempoChanges[0].bpm:i,t.syncPointTempo=t.currentTempo,t.synthData.sort((e,t)=>e.time>t.time?1:e.time<t.time?-1:e.eventIndex-t.eventIndex),t.endTime=a,t.endTick=s,t}fillMidiEventQueue(){return this.fillMidiEventQueueLimited(-1)}fillMidiEventQueueToEndTime(e){for(;this._mainState.currentTime<e;)this.fillMidiEventQueueLimited(e-this._mainState.currentTime)&&this._synthesizer.synthesizeSilent(iI.MicroBufferSize);let t=!1;for(this._currentState.currentTime=e;this._currentState.eventIndex<this._currentState.synthData.length&&this._currentState.synthData[this._currentState.eventIndex].time<this._currentState.currentTime;){let e=this._currentState.synthData[this._currentState.eventIndex];this._synthesizer.dispatchEvent(e),this._currentState.eventIndex++,t=!0}return t}fillMidiEventQueueLimited(e){let t=iI.MicroBufferSize/this._synthesizer.outSampleRate*1e3*this.playbackSpeed,i=this.internalEndTime;e>0&&(e<t&&(t=e),i=Math.min(this.internalEndTime,this._currentState.currentTime+e));let s=!1;for(this._currentState.currentTime+=t;this._currentState.eventIndex<this._currentState.synthData.length&&this._currentState.synthData[this._currentState.eventIndex].time<this._currentState.currentTime&&this._currentState.currentTime<i;)this._synthesizer.dispatchEvent(this._currentState.synthData[this._currentState.eventIndex]),this._currentState.eventIndex++,s=!0;return s}mainTickPositionToTimePosition(e){return this.tickPositionToTimePositionWithSpeed(this._mainState,e,this.playbackSpeed)}mainUpdateSyncPoints(e){let t=this._mainState;if(e.sort((e,t)=>e.synthTick-t.synthTick),t.syncPoints=[],e.length>=0){let i=120,s=0,a=0,r=0;for(let n=0;n<e.length;n++){let o,l,h,d=e[n],c=0;if(0===n)o=i,l=0,h=0;else{let t=e[n-1];o=t.syncBpm,l=t.syncTime,h=t.synthTick}for(;r<t.tempoChanges.length&&t.tempoChanges[r].ticks<=d.synthTick;){if((c=t.tempoChanges[r].ticks-s)>0){s+=c,a+=c*(6e4/(i*t.division));let e=(d.syncTime-l)/(d.synthTick-h),r=(s-h)*e+l,n=new al;n.synthTick=s,n.synthBpm=i,n.synthTime=a,n.syncTime=r,n.syncBpm=o}i=t.tempoChanges[r].bpm,r++}c=d.synthTick-s,s+=c,a+=c*(6e4/(i*t.division)),t.syncPoints.push(d)}}t.syncPointIndex=0,t.syncPointTempo=t.syncPoints.length>0?t.syncPoints[0].syncBpm:t.currentTempo}currentTimePositionToTickPosition(e){let t=this._currentState;if(0===t.tempoChanges.length)return 0;e*=this.playbackSpeed,this.updateCurrentTempo(t,e);let i=t.tempoChanges[t.tempoChangeIndex],s=(e-i.time)/(6e4/(i.bpm*t.division))|0;return i.ticks+s+1}currentUpdateCurrentTempo(e){this.updateCurrentTempo(this._mainState,e*this.playbackSpeed)}updateCurrentTempo(e,t){let i=e.tempoChangeIndex;for(t<e.tempoChanges[i].time&&(i=0);i+1<e.tempoChanges.length&&e.tempoChanges[i+1].time<=t;)i++;i!==e.tempoChangeIndex&&(e.tempoChangeIndex=i,e.currentTempo=e.tempoChanges[e.tempoChangeIndex].bpm,0===e.syncPoints.length&&(e.syncPointTempo=e.currentTempo))}currentUpdateSyncPoints(e){this.updateSyncPoints(this._mainState,e)}updateSyncPoints(e,t){let i=e.syncPoints;if(i.length>0){let s=Math.min(e.syncPointIndex,i.length-1);for(t<i[s].syncTime&&(s=0);s+1<i.length&&i[s+1].syncTime<=t;)s++;s!==e.syncPointIndex&&(e.syncPointIndex=s,e.syncPointTempo=i[s].syncBpm)}else e.syncPointTempo=e.currentTempo}mainTimePositionFromBackingTrack(e,t){let i,s=this._mainState,a=s.syncPoints;if(e<0||0===a.length)return e;this.updateSyncPoints(this._mainState,e);let r=Math.min(s.syncPointIndex,a.length-1),n=a[r],o=e-n.syncTime;if(r+1<a.length){let e=a[r+1],t=o/(e.syncTime-n.syncTime);i=(e.synthTime-n.synthTime)*t}else{let e=o/(t-n.syncTime);i=(s.endTime-n.synthTime)*e}return(n.synthTime+i)/this.playbackSpeed}mainTimePositionToBackingTrack(e,t){let i,s=this._mainState,a=s.syncPoints;if(e<0||0===a.length)return e;e*=this.playbackSpeed;let r=Math.min(s.syncPointIndex,a.length-1);for(e<a[r].synthTime&&(r=0);r+1<a.length&&a[r+1].synthTime<=e;)r++;let n=a[r],o=e-n.synthTime;if(r+1<a.length){let e=a[r+1],t=o/(e.synthTime-n.synthTime),s=e.syncTime-n.syncTime;i=n.syncTime+s*t}else{let e=o/(s.endTime-n.synthTime),a=t-n.syncTime;i=n.syncTime+a*e}return i}tickPositionToTimePositionWithSpeed(e,t,i){let s=0,a=120,r=0;for(let i of e.tempoChanges){if(t<i.ticks)break;s=i.time,a=i.bpm,r=i.ticks}return t-=r,(s+=t*(6e4/(a*e.division)))/i}get internalEndTime(){return this.isPlayingMain&&this.mainPlaybackRange?this._currentState.playbackRangeEndTime:this._currentState.endTime}get isFinished(){return this._currentState.currentTime>=this.internalEndTime}stop(){this.isPlayingMain&&this.mainPlaybackRange?this._currentState.currentTime=this.mainPlaybackRange.startTick:this._currentState.currentTime=0,this._currentState.eventIndex=0}resetOneTimeMidi(){this._oneTimeState=null,this._currentState=this._mainState}resetCountIn(){this._countInState=null,this._currentState=this._mainState}startCountIn(){this.generateCountInMidi(),this._currentState=this._countInState,this.stop(),this._synthesizer.noteOffAll(!0)}generateCountInMidi(){let e=new ad;e.division=this._mainState.division;let t=120,i=4,s=4;0===this._mainState.eventIndex?(t=this._mainState.tempoChanges[0].bpm,i=this._mainState.firstTimeSignatureNumerator,s=this._mainState.firstTimeSignatureDenominator):(t=this._synthesizer.currentTempo,i=this._synthesizer.timeSignatureNumerator,s=this._synthesizer.timeSignatureDenominator),e.tempoChanges.push(new ah(t,0,0));let a=e.division*(4/s)|0,r=a*(6e4/(t*this._mainState.division)),n=0,o=0;for(let t=0;t<i;t++){let i=ao.newMetronomeEvent(e.synthData.length,n,t,a,r);e.synthData.push(i),i.time=o,n+=a,o+=r}e.synthData.sort((e,t)=>e.time>t.time?1:e.time<t.time?-1:e.eventIndex-t.eventIndex),e.endTime=o,e.endTick=n,e.currentTempo=t,e.syncPointTempo=t,this._countInState=e}}(eg=t$||(t$={}))[eg.Paused=0]="Paused",eg[eg.Playing=1]="Playing";class au{constructor(e,t){this.state=e,this.stopped=t}}class ap{constructor(e,t,i,s,a,r,n){this.originalTempo=0,this.modifiedTempo=0,this.currentTime=e,this.endTime=t,this.currentTick=i,this.endTick=s,this.isSeek=a,this.originalTempo=r,this.modifiedTempo=n}}class am{constructor(){this.id="",this.size=0}static load(e,t,i){if(e&&am.HeaderSize>e.size||i.position+am.HeaderSize>=i.length||(t.id=sh.read8BitStringLength(i,4),32>=t.id.charCodeAt(0)||t.id.charCodeAt(0)>=122)||(t.size=sh.readUInt32LE(i),e&&am.HeaderSize+t.size>e.size))return!1;e&&(e.size-=am.HeaderSize+t.size);let s="RIFF"===t.id,a="LIST"===t.id;return(!s||!e)&&(!s&&!a||(t.id=sh.read8BitStringLength(i,4),!(32>=t.id.charCodeAt(0)||t.id.charCodeAt(0)>=122)&&(t.size-=4,!0)))}}am.HeaderSize=8;class ag{constructor(e,t,i,s){this.packetData=e,this.isBeginningOfStream=t,this.isEndOfStream=i,this.granulePosition=i?s:null}addData(e){let t=this.packetData,i=new Uint8Array(t.length+e.length);i.set(t,0),i.set(e,t.length)}}(ef=tj||(tj={}))[ef.ContinuesPacket=1]="ContinuesPacket",ef[ef.BeginningOfStream=2]="BeginningOfStream",ef[ef.EndOfStream=4]="EndOfStream";class af{constructor(e){this._readable=e}read(){let e=[];for(;this.findAndReadPage(e););return e}findAndReadPage(e){return!!this.seekPageHeader()&&this.readPage(e)}seekPageHeader(){for(let e=0;e<65536;e++){if(0x5367674f===sh.readInt32LE(this._readable))return!0;this._readable.position-=3}return!1}readPage(e){let t=this._readable.readByte();if(-1===t||0!==t)return!1;let i=this._readable.readByte(),s=sh.readInt64LE(this._readable);this._readable.skip(4),this._readable.skip(4),this._readable.skip(4);let a=this._readable.readByte();if(-1===a)return!1;let r=[],n=0;for(let e=0;e<a;e++){let e=this._readable.readByte();n===r.length&&r.push(0),r[n]+=e,e<255&&n++}for(let t=0;t<r.length;t++){let a=new Uint8Array(r[t]);if(this._readable.read(a,0,a.length)!==a.length)return!1;if((i&tj.ContinuesPacket)!=0){if(0===e.length)throw new i6(tE.Format,"OGG: Continuation page without any previous packets");e[e.length-1].addData(a)}else{let n=new ag(a,(i&tj.BeginningOfStream)!=0&&0===t,(i&tj.EndOfStream)!=0&&t===r.length-1,s);e.push(n)}}return!0}}class ay{constructor(){this.audioChannels=0,this.audioSampleRate=0,this.samples=new Float32Array(0),this.bitrateMaximum=0,this.bitrateNominal=0,this.bitrateMinimum=0,this.blocksize0=0,this.blocksize1=0}}class ab{constructor(){this.value=0,this.bitsRead=0}}class aS{constructor(e){this._bitBucket=0n,this._bitCount=0n,this._overflowBits=0n,this._source=e}readByte(){return this.readBits(aS.ByteSize)}readBit(){return 1===this.readBits(1)}readBytes(e){let t=new Uint8Array(e);for(let i=0;i<e;i++)t[i]=255&this.readByte();return t}readBits(e){if(0===e)return 0;let t=this.tryPeekBits(e);return this.skipBits(e),t.value}tryPeekBits(e){if(e<0||e>32)throw new i6(tE.General,"IO: Cannot read more than 32 bits in one go");if(0===e)return new ab;let t=new ab;for(;this._bitCount<e;){let e=BigInt(this._source.readByte());if(e===-1n)return t.bitsRead=Number(this._bitCount),t.value=Number(this._bitBucket),this._bitBucket=0n,this._bitCount=0n,t;this._bitBucket=(255n&e)<<this._bitCount|this._bitBucket,this._bitCount+=8n,this._bitCount>32&&(this._overflowBits=e>>40n-this._bitCount&255n)}let i=this._bitBucket;return e<64&&(i&=(1n<<BigInt(e))-1n),t.value=Number(i),t.bitsRead=e,t}skipBits(e){let t=BigInt(e);if(0===e);else if(this._bitCount>t){if(e>31?this._bitBucket=0n:this._bitBucket=this._bitBucket>>t,this._bitCount>32){let i=this._bitCount-32n;this._bitBucket=this._bitBucket|this._overflowBits<<this._bitCount-t-i,i>e&&(this._overflowBits=this._overflowBits>>t&255n)}this._bitCount-=t}else if(this._bitCount===t)this._bitBucket=0n,this._bitCount=0n;else{for(t-=this._bitCount,this._bitCount=0n,this._bitBucket=0n;t>8;){if(-1===this._source.readByte()){t=0n;break}t-=8n}if(t>0){let e=BigInt(this._source.readByte());e===-1n||(this._bitBucket=e>>t,this._bitCount=8n-t)}}}}aS.ByteSize=8;class a_{constructor(){this.codebooks=[],this.timeDomainTransforms=[],this.floors=[],this.residues=[],this.mappings=[],this.modes=[]}}class aw{static ilog(e){let t=0;for(;e>0;)++t,e>>=1;return t}static bitReverse(e,t=32){let i=BigInt(e);return Number(BigInt.asUintN(32,i=((i=((i=((i=((i=(i&BigInt(0xaaaaaaaa))>>1n|(i&BigInt(0x55555555))<<1n)&BigInt(0xcccccccc))>>2n|(i&BigInt(0x33333333))<<2n)&BigInt(0xf0f0f0f0))>>4n|(i&BigInt(0xf0f0f0f))<<4n)&BigInt(0xff00ff00))>>8n|(i&BigInt(0xff00ff))<<8n)>>16n|i<<16n)>>32n-BigInt(t)))}static convertFromVorbisFloat32(e){let t=BigInt(e),i=t&BigInt(2097151),s=t&BigInt(0x80000000),a=(t&BigInt(0x7fe00000))>>21n;return 0n!==s&&(i=-i),Number(i)*Math.pow(2,Number(a)-788)}}class ak{constructor(e){this._data=e}get(e){return this._data[e]}}class aB{get(e){return e}}aB.instance=new aB;class aT{constructor(e,t){if(this._maxBits=0,this._overflowList=null,this._prefixList=null,this._prefixBitLength=0,this.dimensions=0,this.entries=0,this.mapType=0,5653314!==e.readBits(24))throw new i6(tE.Format,"Vorbis: Book header had invalid signature!");this.dimensions=e.readBits(16),this.entries=e.readBits(24),this._lengths=new Int32Array(this.entries),this.initTree(e,t),this.initLookupTable(e)}get(e,t){return this._lookupTable[e*this.dimensions+t]}decodeScalar(e){let t=e.tryPeekBits(this._prefixBitLength);if(0===t.bitsRead)return -1;let i=this._prefixList[t.value];if(null!=i)return e.skipBits(i.length),i.value;if(t=e.tryPeekBits(this._maxBits),null!==this._overflowList)for(let s=0;s<this._overflowList.length;s++){i=this._overflowList[s];let a=t.value&i.mask;if(i.bits===a)return e.skipBits(i.length),i.value}return -1}initTree(e,t){let i,s,a=0;if(e.readBit()){let t=e.readBits(5)+1;for(let i=0;i<this.entries;){let s=e.readBits(aw.ilog(this.entries-i));for(;--s>=0;)this._lengths[i++]=t;++t}a=0,i=!1,s=t}else{s=-1,i=e.readBit();for(let t=0;t<this.entries;t++)!i||e.readBit()?(this._lengths[t]=e.readBits(5)+1,++a):this._lengths[t]=-1,this._lengths[t]>s&&(s=this._lengths[t])}if(this._maxBits=s,s>-1){let e,s=null;i&&a>=this.entries>>2&&((s=new Int32Array(this.entries)).set(this._lengths.subarray(0,this.entries),0),i=!1),e=i?a:0;let r=null,n=null;if(i?0!==e&&(s=new Int32Array(e),n=new Int32Array(e),r=new Int32Array(e)):n=new Int32Array(this.entries),!this.computeCodewords(i,n,s,this._lengths,this.entries,r))throw new i6(tE.Format,"Vorbis: Failed to compute codewords");let o=null==r?aB.instance:new ak(r);t.generateTable(o,s??this._lengths,n),this._prefixList=t.prefixTree,this._prefixBitLength=t.tableBits,this._overflowList=t.overflowList}}computeCodewords(e,t,i,s,a,r){let n=new Uint32Array(32),o=0,l=0;for(o=0;o<a&&!(s[o]>0);++o);if(o===a)return!0;this.addEntry(e,t,i,0,o,l++,s[o],r);for(let e=1;e<=s[o];++e)n[e]=1<<32-e;for(let h=o+1;h<a;++h){let a=s[h];if(a<=0)continue;for(;a>0&&0===n[a];)--a;if(0===a)return!1;let o=n[a];if(n[a]=0,this.addEntry(e,t,i,aw.bitReverse(o),h,l++,s[h],r),a!==s[h])for(let e=s[h];e>a;--e)n[e]=o+(1<<32-e)}return!0}addEntry(e,t,i,s,a,r,n,o){e?(t[r]=s,i[r]=n,o[r]=a):t[a]=s}initLookupTable(e){if(this.mapType=e.readBits(4),0===this.mapType)return;let t=aw.convertFromVorbisFloat32(e.readBits(32)),i=aw.convertFromVorbisFloat32(e.readBits(32)),s=e.readBits(4)+1,a=e.readBit(),r=this.entries*this.dimensions,n=new Float32Array(r);1===this.mapType&&(r=this.lookup1Values());let o=new Uint32Array(r);for(let t=0;t<r;t++)o[t]=e.readBits(s);if(1===this.mapType)for(let e=0;e<this.entries;e++){let s=0,l=1;for(let h=0;h<this.dimensions;h++){let d=o[e/l%r|0]*i+t+s;n[e*this.dimensions+h]=d,a&&(s=d),l*=r}}else for(let e=0;e<this.entries;e++){let s=0,r=e*this.dimensions;for(let l=0;l<this.dimensions;l++){let h=o[r]*i+t+s;n[e*this.dimensions+l]=h,a&&(s=h),++r}}this._lookupTable=n}lookup1Values(){let e=Math.floor(Math.exp(Math.log(this.entries)/this.dimensions));return Math.floor(Math.pow(e+1,this.dimensions))<=this.entries&&++e,e}}class aN{constructor(){this.value=0,this.length=0,this.bits=0,this.mask=0}}class ax{constructor(){this.tableBits=0,this.prefixTree=[],this.overflowList=null}generateTable(e,t,i){let s=Array(t.length),a=0;for(let r=0;r<s.length;r++){let n=new aN;n.value=e.get(r),n.length=t[r]<=0?99999:t[r],n.bits=i[r],n.mask=(1<<t[r])-1,s[r]=n,t[r]>0&&a<t[r]&&(a=t[r])}s.sort((e,t)=>{let i=e.length-t.length;return 0===i?e.bits-t.bits:i});let r=a>ax.MAX_TABLE_BITS?ax.MAX_TABLE_BITS:a,n=[],o=null;for(let e=0;e<s.length&&s[e].length<99999;e++){let t=s[e].length;if(t>r)for(o=[];e<s.length&&s[e].length<99999;e++)o.push(s[e]);else{let i=1<<r-t,a=s[e];for(let e=0;e<i;e++){let i=e<<t|a.bits;for(;n.length<=i;)n.push(null);n[i]=a}}}for(;n.length<1<<r;)n.push(null);this.tableBits=r,this.prefixTree=n,this.overflowList=o}}ax.MAX_TABLE_BITS=10;class aP{constructor(e){e.readBits(16)}}class av{get executeChannel(){return(this.forceEnergy||this.amp>0)&&!this.forceNoEnergy}constructor(e){this.amp=0,this.forceEnergy=!1,this.forceNoEnergy=!1,this.coeff=e}}class aF{constructor(e,t,i,s){if(this._order=e.readBits(8),this._rate=e.readBits(16),this._bark_map_size=e.readBits(16),this._ampBits=e.readBits(6),this._ampOfs=e.readBits(8),this._books=Array(e.readBits(4)+1),this._order<1||this._rate<1||this._bark_map_size<1||0===this._books.length)throw new i6(tE.Format,"Vorbis: Invalid Floor0 Data");this._ampDiv=(1<<this._ampBits)-1;for(let t=0;t<this._books.length;t++){const i=e.readBits(8);if(i<0||i>=s.length)throw new i6(tE.Format,"Vorbis: Invalid Floor0 Data");const a=s[i];if(0===a.mapType||a.dimensions<1)throw new i6(tE.Format,"Vorbis: Invalid Floor0 Data");this._books[t]=a}this._bookBits=aw.ilog(this._books.length),this._barkMaps=new Map([[t,this.synthesizeBarkCurve(t/2)],[i,this.synthesizeBarkCurve(i/2)]]),this._wMap=new Map([[t,this.synthesizeWDelMap(t/2)],[i,this.synthesizeWDelMap(i/2)]])}synthesizeBarkCurve(e){let t=this._bark_map_size/aF.toBARK(this._rate/2),i=new Int32Array(e+1);for(let s=0;s<e-1;s++)i[s]=Math.min(this._bark_map_size-1,Math.floor(aF.toBARK(this._rate/2/e*s)*t));return i[e]=-1,i}static toBARK(e){return 13.1*Math.atan(74e-5*e)+2.24*Math.atan(185e-10*e*e)+1e-4*e}synthesizeWDelMap(e){let t=Math.PI/this._bark_map_size,i=new Float32Array(e);for(let s=0;s<e;s++)i[s]=2*Math.cos(t*s);return i}unpack(e,t,i){let s=new av(new Float32Array(this._order+1));if(s.amp=e.readBits(this._ampBits),s.amp>0){s.amp=s.amp/this._ampDiv*this._ampOfs;let t=e.readBits(this._bookBits);if(t>=this._books.length)return s.amp=0,s;let i=this._books[t];for(let t=0;t<this._order;){let a=i.decodeScalar(e);if(-1===a)return s.amp=0,s;for(let e=0;t<this._order&&e<i.dimensions;e++,t++)s.coeff[t]=i.get(a,e)}let a=0;for(let e=0;e<this._order;){for(let t=0;e<this._order&&t<i.dimensions;e++,t++)s.coeff[e]+=a;a=s.coeff[e-1]}}return s}apply(e,t,i){let s=t/2;if(e.amp>0){let a=this._barkMaps.get(t),r=this._wMap.get(t),n=0;for(n=0;n<this._order;n++)e.coeff[n]=2*Math.cos(e.coeff[n]);for(n=0;n<s;){let t=0,s=a[n],o=.5,l=.5,h=r[s];for(t=1;t<this._order;t+=2)l*=h-e.coeff[t-1],o*=h-e.coeff[t];for(t===this._order?(l*=h-e.coeff[t-1],o*=o*(4-h*h),l*=l):(o*=o*(2-h),l*=l*(2+h)),l=Math.exp(.11512925*(l=e.amp/Math.sqrt(o+l)-this._ampOfs)),i[n]*=l;a[++n]===s;)i[n]*=l}}else i.fill(0,0,s)}}class aC{constructor(){this.posts=new Int32Array(64),this.postCount=0,this.forceEnergy=!1,this.forceNoEnergy=!1}get executeChannel(){return(this.forceEnergy||this.postCount>0)&&!this.forceNoEnergy}}class aD{constructor(e,t){let i=-1;this._partitionClass=new Int32Array(e.readBits(5));for(let t=0;t<this._partitionClass.length;t++)this._partitionClass[t]=e.readBits(4),this._partitionClass[t]>i&&(i=this._partitionClass[t]);++i,this._classDimensions=new Int32Array(i),this._classSubclasses=new Int32Array(i),this._classMasterbooks=Array(i),this._classMasterBookIndex=new Int32Array(i),this._subclassBooks=Array(i),this._subclassBookIndex=Array(i);for(let s=0;s<i;s++){this._classDimensions[s]=e.readBits(3)+1,this._classSubclasses[s]=e.readBits(2),this._classSubclasses[s]>0&&(this._classMasterBookIndex[s]=e.readBits(8),this._classMasterbooks[s]=t[this._classMasterBookIndex[s]]),this._subclassBooks[s]=Array(1<<this._classSubclasses[s]),this._subclassBookIndex[s]=new Int32Array(this._subclassBooks[s].length);for(let i=0;i<this._subclassBooks[s].length;i++){const a=e.readBits(8)-1;a>=0&&(this._subclassBooks[s][i]=t[a]),this._subclassBookIndex[s][i]=a}}this._multiplier=e.readBits(2),this._range=aD._rangeLookup[this._multiplier],this._yBits=aD._yBitsLookup[this._multiplier],++this._multiplier;const s=e.readBits(4),a=[];a.push(0),a.push(1<<s);for(let t=0;t<this._partitionClass.length;t++){const i=this._partitionClass[t];for(let t=0;t<this._classDimensions[i];t++)a.push(e.readBits(s))}this._xList=new Int32Array(a),this._lNeigh=new Int32Array(a.length),this._hNeigh=new Int32Array(a.length),this._sortIdx=new Int32Array(a.length),this._sortIdx[0]=0,this._sortIdx[1]=1;for(let e=2;e<this._lNeigh.length;e++){this._lNeigh[e]=0,this._hNeigh[e]=1,this._sortIdx[e]=e;for(let t=2;t<e;t++){const i=this._xList[t];i<this._xList[e]?i>this._xList[this._lNeigh[e]]&&(this._lNeigh[e]=t):i<this._xList[this._hNeigh[e]]&&(this._hNeigh[e]=t)}}for(let e=0;e<this._sortIdx.length-1;e++)for(let t=e+1;t<this._sortIdx.length;t++){if(this._xList[e]===this._xList[t])throw new i6(tE.Format,"Vorbis: Invalid Floor1 Data");if(this._xList[this._sortIdx[e]]>this._xList[this._sortIdx[t]]){const i=this._sortIdx[e];this._sortIdx[e]=this._sortIdx[t],this._sortIdx[t]=i}}}unpack(e,t,i){let s=new aC;if(e.readBit()){let t=2;s.posts[0]=e.readBits(this._yBits),s.posts[1]=e.readBits(this._yBits);for(let i=0;i<this._partitionClass.length;i++){let a=this._partitionClass[i],r=this._classDimensions[a],n=this._classSubclasses[a],o=(1<<n)-1,l=0;if(n>0&&-1===(l=this._classMasterbooks[a].decodeScalar(e))){t=0;break}for(let h=0;h<r;h++){let r=this._subclassBooks[a][l&o];if(l>>=n,null!=r&&(s.posts[t]=r.decodeScalar(e),-1===s.posts[t])){t=0,i=this._partitionClass.length;break}++t}}s.postCount=t}return s}apply(e,t,i){let s=t/2;if(e.postCount>0){let t=this.unwrapPosts(e),a=0,r=e.posts[0]*this._multiplier;for(let n=1;n<e.postCount;n++){let o=this._sortIdx[n];if(t[o]){let t=this._xList[o],n=e.posts[o]*this._multiplier;a<s&&this.renderLineMulti(a,r,Math.min(t,s),n,i),a=t,r=n}if(a>=s)break}a<s&&this.renderLineMulti(a,r,s,r,i)}else i.fill(0,0,s)}unwrapPosts(e){let t=Array(64);t.fill(!1),t[0]=!0,t[1]=!0;let i=new Int32Array(64);i[0]=e.posts[0],i[1]=e.posts[1];for(let s=2;s<e.postCount;s++){let a,r=this._lNeigh[s],n=this._hNeigh[s],o=this.renderPoint(this._xList[r],i[r],this._xList[n],i[n],this._xList[s]),l=e.posts[s],h=this._range-o;a=h<o?2*h:2*o,0!==l?(t[r]=!0,t[n]=!0,t[s]=!0,l>=a?h>o?i[s]=l-o+o:i[s]=o-l+h-1:l%2==1?i[s]=o-(l+1)/2:i[s]=o+l/2):(t[s]=!1,i[s]=o)}for(let t=0;t<e.postCount;t++)e.posts[t]=i[t];return t}renderPoint(e,t,i,s,a){let r=s-t,n=Math.abs(r)*(a-e)/(i-e)|0;return r<0?t-n:t+n}renderLineMulti(e,t,i,s,a){let r=s-t,n=i-e,o=Math.abs(r),l=1-(r>>31&1)*2,h=r/n|0,d=e,c=t,u=-n;for(a[e]*=aD.inverse_dB_table[t],o-=Math.abs(h)*n;++d<i;)c+=h,(u+=o)>=0&&(u-=n,c+=l),a[d]*=aD.inverse_dB_table[c]}}aD._rangeLookup=[256,128,86,64],aD._yBitsLookup=[8,7,7,6],aD.inverse_dB_table=new Float32Array([10649863e-14,11341951e-14,12079015e-14,12863978e-14,13699951e-14,14590251e-14,15538408e-14,16548181e-14,17623575e-14,18768855e-14,19988561e-14,2128753e-13,22670913e-14,24144197e-14,25713223e-14,27384213e-14,29163793e-14,31059021e-14,33077411e-14,35226968e-14,37516214e-14,39954229e-14,4255068e-13,45315863e-14,48260743e-14,51396998e-14,54737065e-14,58294187e-14,62082472e-14,66116941e-14,70413592e-14,74989464e-14,79862701e-14,8505263e-13,90579828e-14,96466216e-14,10273513e-13,10941144e-13,11652161e-13,12409384e-13,13215816e-13,14074654e-13,14989305e-13,15963394e-13,17000785e-13,18105592e-13,19282195e-13,20535261e-13,21869758e-13,23290978e-13,24804557e-13,26416497e-13,2813319e-12,29961443e-13,31908506e-13,33982101e-13,36190449e-13,38542308e-13,41047004e-13,4371447e-12,46555282e-13,49580707e-13,5280274e-12,5623416e-12,59888572e-13,63780469e-13,67925283e-13,72339451e-13,77040476e-13,82047e-10,87378876e-13,93057248e-13,99104632e-13,10554501e-12,11240392e-12,11970856e-12,12748789e-12,13577278e-12,14459606e-12,15399272e-12,16400004e-12,17465768e-12,18600792e-12,19809576e-12,21096914e-12,22467911e-12,23928002e-12,25482978e-12,27139006e-12,28902651e-12,30780908e-12,32781225e-12,34911534e-12,37180282e-12,39596466e-12,42169667e-12,4491009e-11,47828601e-12,50936773e-12,54246931e-12,57772202e-12,61526565e-12,65524908e-12,69783085e-12,74317983e-12,79147585e-12,8429104e-11,89768747e-12,95602426e-12,10181521e-11,10843174e-11,11547824e-11,12298267e-11,13097477e-11,13948625e-11,14855085e-11,15820453e-11,16848555e-11,17943469e-11,19109536e-11,20351382e-11,21673929e-11,23082423e-11,24582449e-11,26179955e-11,27881276e-11,29693158e-11,31622787e-11,33677814e-11,35866388e-11,38197188e-11,40679456e-11,43323036e-11,46138411e-11,49136745e-11,52329927e-11,55730621e-11,59352311e-11,63209358e-11,67317058e-11,716917e-9,7635063e-10,81312324e-11,86596457e-11,92223983e-11,98217216e-11,.0010459992,.0011139742,.0011863665,.0012634633,.0013455702,.0014330129,.0015261382,.0016253153,.0017309374,.0018434235,.0019632195,.0020908006,.0022266726,.0023713743,.0025254795,.0026895994,.0028643847,.0030505286,.0032487691,.0034598925,.0036847358,.0039241906,.0041792066,.004450795,.0047400328,.0050480668,.0053761186,.0057254891,.0060975636,.0064938176,.0069158225,.0073652516,.0078438871,.0083536271,.0088964928,.009474637,.010090352,.01074608,.011444421,.012188144,.012980198,.013823725,.014722068,.015678791,.016697687,.017782797,.018938423,.020169149,.021479854,.022875735,.02436233,.025945531,.027631618,.029427276,.031339626,.033376252,.035545228,.037855157,.040315199,.042935108,.045725273,.048696758,.051861348,.055231591,.05882085,.062643361,.066714279,.071049749,.075666962,.080584227,.085821044,.091398179,.097337747,.1036633,.11039993,.11757434,.12521498,.13335215,.14201813,.15124727,.16107617,.1715438,.18269168,.19456402,.20720788,.22067342,.23501402,.25028656,.26655159,.28387361,.30232132,.32196786,.34289114,.36517414,.38890521,.41417847,.44109412,.4697589,.50028648,.53279791,.56742212,.6042964,.64356699,.68538959,.72993007,.77736504,.8278826,.88168307,.9389798,1]);class aE{constructor(e,t,i,s){const a=e.readBits(16);switch(a){case 0:this.floor=new aF(e,t,i,s);break;case 1:this.floor=new aD(e,s);break;default:throw new i6(tE.Format,`Vorbis: Invalid Floor type: ${a}`)}}apply(e,t,i){this.floor.apply(e,t,i)}unpack(e,t,i){return this.floor.unpack(e,t,i)}}class aM{constructor(e,t,i){let s;this._begin=e.readBits(24),this._end=e.readBits(24),this._partitionSize=e.readBits(24)+1,this._classifications=e.readBits(6)+1,this._classBook=i[e.readBits(8)],this._cascade=new Int32Array(this._classifications);let a=0;for(let t=0;t<this._classifications;t++){const i=e.readBits(3);e.readBit()?this._cascade[t]=e.readBits(5)<<3|i:this._cascade[t]=i,a+=aM.icount(this._cascade[t])}const r=new Int32Array(a);for(let t=0;t<a;t++)if(r[t]=e.readBits(8),0===i[r[t]].mapType)throw new i6(tE.Format,"Vorbis: Invalid Residue 0");const n=this._classBook.entries;let o=this._classBook.dimensions,l=1;for(;o>0;){if((l*=this._classifications)>n)throw new i6(tE.Format,"Vorbis: Invalid Residue 0");--o}this._books=Array(this._classifications),a=0;let h=0;for(let e=0;e<this._classifications;e++)if(s=aw.ilog(this._cascade[e]),this._books[e]=Array(s),s>0){h=Math.max(h,s);for(let t=0;t<s;t++)(this._cascade[e]&1<<t)>0&&(this._books[e][t]=i[r[a++]])}this._maxStages=h,this._decodeMap=Array(l);for(let e=0;e<l;e++){let t=e,i=l/this._classifications|0;this._decodeMap[e]=new Int32Array(this._classBook.dimensions);for(let s=0;s<this._classBook.dimensions;s++){const a=t/i|0;t-=a*i,i=i/this._classifications|0,this._decodeMap[e][s]=a}}this._channels=t}static icount(e){let t=0;for(;0!==e;)t+=1&e,e>>=1;return t}decode(e,t,i,s){let a=(this._end<i/2?this._end:i/2)-this._begin;if(a>0&&-1!==t.indexOf(!1)){let t=a/this._partitionSize,i=(t+this._classBook.dimensions-1)/this._classBook.dimensions|0,r=[];for(let e=0;e<this._channels;e++)r.push(Array(i));for(let i=0;i<this._maxStages;i++)for(let a=0,n=0;a<t;n++){if(0===i)for(let s=0;s<this._channels;s++){let o=this._classBook.decodeScalar(e);if(o>=0&&o<this._decodeMap.length)r[s][n]=this._decodeMap[o];else{a=t,i=this._maxStages;break}}for(let o=0;a<t&&o<this._classBook.dimensions;o++,a++){let l=this._begin+a*this._partitionSize;for(let h=0;h<this._channels;h++){let d=r[h][n][o];if((this._cascade[d]&1<<i)!=0){let r=this._books[d][i];if(r&&this.writeVectors(r,e,s,h,l,this._partitionSize)){a=t,i=this._maxStages;break}}}}}}}writeVectors(e,t,i,s,a,r){let n=i[s],o=r/e.dimensions,l=new Int32Array(o);for(let i=0;i<o;i++)if(l[i]=e.decodeScalar(t),-1===l[i])return!0;for(let t=0;t<e.dimensions;t++)for(let i=0;i<o;i++,a++)n[a]+=e.get(l[i],t);return!1}}class aL extends aM{writeVectors(e,t,i,s,a,r){let n=i[s];for(let i=0;i<r;){let s=e.decodeScalar(t);if(-1===s)return!0;for(let t=0;t<e.dimensions;i++,t++)n[a+i]+=e.get(s,t)}return!1}}class aI extends aM{constructor(e,t,i){super(e,1,i),this._realChannels=t}decode(e,t,i,s){super.decode(e,t,i*this._realChannels,s)}writeVectors(e,t,i,s,a,r){let n=0;a/=this._realChannels;for(let s=0;s<r;){let r=e.decodeScalar(t);if(-1===r)return!0;for(let t=0;t<e.dimensions;t++,s++)i[n][a]+=e.get(r,t),++n===this._realChannels&&(n=0,a++)}return!1}}class aA{constructor(e,t,i){const s=e.readBits(16);switch(s){case 0:this.residue=new aM(e,t,i);break;case 1:this.residue=new aL(e,t,i);break;case 2:this.residue=new aI(e,t,i);break;default:throw new i6(tE.Format,`Vorbis: Invalid Residue type: ${s}`)}}decode(e,t,i,s){this.residue.decode(e,t,i,s)}}class aR{constructor(e,t,i,s,a){if(0!==e.readBits(16))throw new i6(tE.Format,"Vorbis: Invalid mapping type!");let r=1;e.readBit()&&(r+=e.readBits(4));let n=0;e.readBit()&&(n=e.readBits(8)+1);const o=aw.ilog(t-1);this._couplingAngle=new Int32Array(n),this._couplingMangitude=new Int32Array(n);for(let i=0;i<n;i++){const s=e.readBits(o),a=e.readBits(o);if(s===a||s>t-1||a>t-1)throw new i6(tE.Format,"Vorbis: Invalid magnitude or angle in mapping header!");this._couplingAngle[i]=a,this._couplingMangitude[i]=s}if(0!==e.readBits(2))throw new i6(tE.Format,"Vorbis: Reserved bits not 0 in mapping header.");const l=new Int32Array(t);if(r>1){for(let i=0;i<t;i++)if(l[i]=e.readBits(4),l[i]>r)throw new i6(tE.Format,"Vorbis: Invalid channel mux submap index in mapping header!")}this._submapFloor=Array(r),this._submapResidue=Array(r);for(let t=0;t<r;t++){e.skipBits(8);const a=e.readBits(8);if(a>=i.length)throw new i6(tE.Format,"Vorbis: Invalid floor number in mapping header!");const r=e.readBits(8);if(r>=s.length)throw new i6(tE.Format,"Vorbis: Invalid residue number in mapping header!");this._submapFloor[t]=i[a],this._submapResidue[t]=s[r]}this._channelFloor=Array(t),this._channelResidue=Array(t);for(let e=0;e<t;e++)this._channelFloor[e]=this._submapFloor[l[e]],this._channelResidue[e]=this._submapResidue[l[e]];this._mdct=a}decodePacket(e,t,i){let s=t>>1,a=Array(this._channelFloor.length),r=Array(this._channelFloor.length);r.fill(!1);for(let n=0;n<this._channelFloor.length;n++)a[n]=this._channelFloor[n].unpack(e,t,n),r[n]=!a[n].executeChannel,i[n].fill(0,0,s);for(let e=0;e<this._couplingAngle.length;e++)(a[this._couplingAngle[e]].executeChannel||a[this._couplingMangitude[e]].executeChannel)&&(a[this._couplingAngle[e]].forceEnergy=!0,a[this._couplingMangitude[e]].forceEnergy=!0);for(let s=0;s<this._submapFloor.length;s++){for(let e=0;e<this._channelFloor.length;e++)(this._submapFloor[s]!==this._channelFloor[e]||this._submapResidue[s]!==this._channelResidue[e])&&(a[e].forceNoEnergy=!0);this._submapResidue[s].decode(e,r,t,i)}for(let e=this._couplingAngle.length-1;e>=0;e--)if(a[this._couplingAngle[e]].executeChannel||a[this._couplingMangitude[e]].executeChannel){let t=i[this._couplingMangitude[e]],a=i[this._couplingAngle[e]];for(let e=0;e<s;e++){let i,s,r=t[e],n=a[e];r>0?n>0?(i=r,s=r-n):(s=r,i=r+n):n>0?(i=r,s=r+n):(s=r,i=r-n),t[e]=i,a[e]=s}}for(let e=0;e<this._channelFloor.length;e++)a[e].executeChannel?(this._channelFloor[e].apply(a[e],t,i[e]),this._mdct.reverse(i[e],t)):i[e].fill(0,s,2*s)}}class aO{constructor(){this.packetStartIndex=0,this.packetTotalLength=0,this.packetValidLength=0}}class aH{constructor(){this.overlapInfo=new aO,this.windowIndex=0}}class aV{constructor(e=null){this.samplePosition=null,this.samplePosition=e}}class aW{constructor(e,t,i,s,a){if(this._overlapInfo=null,this._channels=t,this._blockFlag=e.readBit(),0!==e.readBits(32))throw new i6(tE.Format,"Vorbis: Mode header had invalid window or transform type!");const r=e.readBits(8);if(r>=a.length)throw new i6(tE.Format,"Vorbis: Mode header had invalid mapping index!");this._mapping=a[r],this._blockFlag?(this._blockSize=s,this._windows=[aW.calcWindow(i,s,i),aW.calcWindow(s,s,i),aW.calcWindow(i,s,s),aW.calcWindow(s,s,s)],this._overlapInfo=[aW.calcOverlap(i,s,i),aW.calcOverlap(s,s,i),aW.calcOverlap(i,s,s),aW.calcOverlap(s,s,s)]):(this._blockSize=i,this._windows=[aW.calcWindow(i,i,i)])}decode(e,t){let i=this.getPacketInfo(e);this._mapping.decodePacket(e,this._blockSize,t);let s=this._windows[i.windowIndex];for(let e=0;e<this._blockSize;e++)for(let i=0;i<this._channels;i++)t[i][e]*=s[e];return i.overlapInfo}getPacketInfo(e){let t=new aH;if(this._blockFlag){t.windowIndex=+!!e.readBit()+2*!!e.readBit();let i=this._overlapInfo[t.windowIndex];t.overlapInfo.packetStartIndex=i.packetStartIndex,t.overlapInfo.packetValidLength=i.packetValidLength,t.overlapInfo.packetTotalLength=i.packetTotalLength}else t.windowIndex=0,t.overlapInfo.packetStartIndex=0,t.overlapInfo.packetValidLength=this._blockSize/2,t.overlapInfo.packetTotalLength=this._blockSize;return t}static calcWindow(e,t,i){let s=new Float32Array(t),a=e/2,r=i/2,n=t/4-a/2,o=t-t/4-r/2;for(let e=0;e<a;e++){let t=Math.sin((e+.5)/a*aW.M_PI2);t*=t,s[n+e]=Math.sin(t*aW.M_PI2)}for(let e=n+a;e<o;e++)s[e]=1;for(let e=0;e<r;e++){let t=Math.sin((r-e-.5)/r*aW.M_PI2);t*=t,s[o+e]=Math.sin(t*aW.M_PI2)}return s}static calcOverlap(e,t,i){let s=i/4,a=t/4*3+s,r=new aO;return r.packetStartIndex=t/4-e/4,r.packetValidLength=a-2*s,r.packetTotalLength=a,r}}aW.M_PI2=1.57079632695;class aG{constructor(e){this._n=e,this._n2=e>>1,this._n4=this._n2>>1,this._n8=this._n4>>1,this._ld=aw.ilog(e)-1,this._a=new Float32Array(this._n2),this._b=new Float32Array(this._n2),this._c=new Float32Array(this._n4);let t=0,i=0;for(;t<this._n4;++t,i+=2)this._a[i]=Math.cos(4*t*aG.M_PI/e),this._a[i+1]=-Math.sin(4*t*aG.M_PI/e),this._b[i]=.5*Math.cos((i+1)*aG.M_PI/e/2),this._b[i+1]=.5*Math.sin((i+1)*aG.M_PI/e/2);for(t=0,i=0;t<this._n8;++t,i+=2)this._c[i]=Math.cos(2*(i+1)*aG.M_PI/e),this._c[i+1]=-Math.sin(2*(i+1)*aG.M_PI/e);this._bitrev=new Uint16Array(this._n8);for(let e=0;e<this._n8;++e)this._bitrev[e]=sl.int32ToUint16(aw.bitReverse(e,this._ld-3)<<2)}calcReverse(e){let t=new Float32Array(this._n2);{let i=this._n2-2,s=0,a=0,r=this._n2;for(;a!==r;)t[i+1]=e[a]*this._a[s]-e[a+2]*this._a[s+1],t[i]=e[a]*this._a[s+1]+e[a+2]*this._a[s],i-=2,s+=2,a+=4;for(a=this._n2-3;i>=0;)t[i+1]=-e[a+2]*this._a[s]- -e[a]*this._a[s+1],t[i]=-e[a+2]*this._a[s+1]+-e[a]*this._a[s],i-=2,s+=2,a-=4}{let i=this._n2-8,s=this._n4,a=0,r=this._n4,n=0;for(;i>=0;){let o,l;l=t[s+1]-t[a+1],o=t[s]-t[a],e[r+1]=t[s+1]+t[a+1],e[r]=t[s]+t[a],e[n+1]=l*this._a[i+4]-o*this._a[i+5],e[n]=o*this._a[i+4]+l*this._a[i+5],l=t[s+3]-t[a+3],o=t[s+2]-t[a+2],e[r+3]=t[s+3]+t[a+3],e[r+2]=t[s+2]+t[a+2],e[n+3]=l*this._a[i]-o*this._a[i+1],e[n+2]=o*this._a[i]+l*this._a[i+1],i-=8,r+=4,n+=4,s+=4,a+=4}}this.step3_iter0_loop(this._n>>4,e,this._n2-1-0*this._n4,-this._n8),this.step3_iter0_loop(this._n>>4,e,this._n2-1-this._n4,-this._n8),this.step3_inner_r_loop(this._n>>5,e,this._n2-1-0*this._n8,-(this._n>>4),16),this.step3_inner_r_loop(this._n>>5,e,this._n2-1-this._n8,-(this._n>>4),16),this.step3_inner_r_loop(this._n>>5,e,this._n2-1-2*this._n8,-(this._n>>4),16),this.step3_inner_r_loop(this._n>>5,e,this._n2-1-3*this._n8,-(this._n>>4),16);let i=2;for(;i<this._ld-3>>1;++i){let t=this._n>>i+2,s=t>>1,a=1<<i+1;for(let r=0;r<a;++r)this.step3_inner_r_loop(this._n>>i+4,e,this._n2-1-t*r,-s,1<<i+3)}for(;i<this._ld-6;++i){let t=this._n>>i+2,s=1<<i+3,a=t>>1,r=this._n>>i+6,n=1<<i+1,o=this._n2-1,l=0;for(let i=r;i>0;--i)this.step3_inner_s_loop(n,e,o,-a,l,s,t),l+=4*s,o-=8}this.step3_inner_s_loop_ld654(this._n>>5,e,this._n2-1,this._n);{let i=0,s=this._n4-4,a=this._n2-4;for(;s>=0;){let r;r=this._bitrev[i],t[a+3]=e[r],t[a+2]=e[r+1],t[s+3]=e[r+2],t[s+2]=e[r+3],r=this._bitrev[i+1],t[a+1]=e[r],t[a]=e[r+1],t[s+1]=e[r+2],t[s]=e[r+3],s-=4,a-=4,i+=2}}{let e=0,i=0,s=this._n2-4;for(;i<s;){let a,r,n,o,l,h;a=t[i]-t[s+2],r=t[i+1]+t[s+3],n=this._c[e+1]*a+this._c[e]*r,o=this._c[e+1]*r-this._c[e]*a,l=t[i]+t[s+2],h=t[i+1]-t[s+3],t[i]=l+n,t[i+1]=h+o,t[s+2]=l-n,t[s+3]=o-h,a=t[i+2]-t[s],r=t[i+3]+t[s+1],n=this._c[e+3]*a+this._c[e+2]*r,o=this._c[e+3]*r-this._c[e+2]*a,l=t[i+2]+t[s],h=t[i+3]-t[s+1],t[i+2]=l+n,t[i+3]=h+o,t[s]=l-n,t[s+1]=o-h,e+=4,i+=4,s-=4}}{let i=this._n2-8,s=this._n2-8,a=0,r=this._n2-4,n=this._n2,o=this._n-4;for(;s>=0;){let l,h,d,c;c=t[s+6]*this._b[i+7]-t[s+7]*this._b[i+6],d=-t[s+6]*this._b[i+6]-t[s+7]*this._b[i+7],e[a]=c,e[r+3]=-c,e[n]=d,e[o+3]=d,h=t[s+4]*this._b[i+5]-t[s+5]*this._b[i+4],l=-t[s+4]*this._b[i+4]-t[s+5]*this._b[i+5],e[a+1]=h,e[r+2]=-h,e[n+1]=l,e[o+2]=l,c=t[s+2]*this._b[i+3]-t[s+3]*this._b[i+2],d=-t[s+2]*this._b[i+2]-t[s+3]*this._b[i+3],e[a+2]=c,e[r+1]=-c,e[n+2]=d,e[o+1]=d,h=t[s]*this._b[i+1]-t[s+1]*this._b[i],l=-t[s]*this._b[i]-t[s+1]*this._b[i+1],e[a+3]=h,e[r]=-h,e[n+3]=l,e[o]=l,i-=8,s-=8,a+=4,n+=4,r-=4,o-=4}}}step3_inner_r_loop(e,t,i,s,a){let r,n,o=i,l=o+s,h=0;for(let i=e>>2;i>0;--i)r=t[o]-t[l],n=t[o-1]-t[l-1],t[o]+=t[l],t[o-1]+=t[l-1],t[l]=r*this._a[h]-n*this._a[h+1],t[l-1]=n*this._a[h]+r*this._a[h+1],h+=a,r=t[o-2]-t[l-2],n=t[o-3]-t[l-3],t[o-2]+=t[l-2],t[o-3]+=t[l-3],t[l-2]=r*this._a[h]-n*this._a[h+1],t[l-3]=n*this._a[h]+r*this._a[h+1],h+=a,r=t[o-4]-t[l-4],n=t[o-5]-t[l-5],t[o-4]+=t[l-4],t[o-5]+=t[l-5],t[l-4]=r*this._a[h]-n*this._a[h+1],t[l-5]=n*this._a[h]+r*this._a[h+1],h+=a,r=t[o-6]-t[l-6],n=t[o-7]-t[l-7],t[o-6]+=t[l-6],t[o-7]+=t[l-7],t[l-6]=r*this._a[h]-n*this._a[h+1],t[l-7]=n*this._a[h]+r*this._a[h+1],h+=a,o-=8,l-=8}step3_iter0_loop(e,t,i,s){let a=i,r=a+s,n=0;for(let i=e>>2;i>0;--i){let e,i;e=t[a]-t[r],i=t[a-1]-t[r-1],t[a]+=t[r],t[a-1]+=t[r-1],t[r]=e*this._a[n]-i*this._a[n+1],t[r-1]=i*this._a[n]+e*this._a[n+1],n+=8,e=t[a-2]-t[r-2],i=t[a-3]-t[r-3],t[a-2]+=t[r-2],t[a-3]+=t[r-3],t[r-2]=e*this._a[n]-i*this._a[n+1],t[r-3]=i*this._a[n]+e*this._a[n+1],n+=8,e=t[a-4]-t[r-4],i=t[a-5]-t[r-5],t[a-4]+=t[r-4],t[a-5]+=t[r-5],t[r-4]=e*this._a[n]-i*this._a[n+1],t[r-5]=i*this._a[n]+e*this._a[n+1],n+=8,e=t[a-6]-t[r-6],i=t[a-7]-t[r-7],t[a-6]+=t[r-6],t[a-7]+=t[r-7],t[r-6]=e*this._a[n]-i*this._a[n+1],t[r-7]=i*this._a[n]+e*this._a[n+1],n+=8,a-=8,r-=8}}step3_inner_s_loop(e,t,i,s,a,r,n){let o,l,h=this._a[a],d=this._a[a+1],c=this._a[a+r],u=this._a[a+r+1],p=this._a[a+2*r],m=this._a[a+2*r+1],g=this._a[a+3*r],f=this._a[a+3*r+1],y=i,b=y+s;for(let i=e;i>0;--i)o=t[y]-t[b],l=t[y-1]-t[b-1],t[y]+=t[b],t[y-1]+=t[b-1],t[b]=o*h-l*d,t[b-1]=l*h+o*d,o=t[y-2]-t[b-2],l=t[y-3]-t[b-3],t[y-2]+=t[b-2],t[y-3]+=t[b-3],t[b-2]=o*c-l*u,t[b-3]=l*c+o*u,o=t[y-4]-t[b-4],l=t[y-5]-t[b-5],t[y-4]+=t[b-4],t[y-5]+=t[b-5],t[b-4]=o*p-l*m,t[b-5]=l*p+o*m,o=t[y-6]-t[b-6],l=t[y-7]-t[b-7],t[y-6]+=t[b-6],t[y-7]+=t[b-7],t[b-6]=o*g-l*f,t[b-7]=l*g+o*f,y-=n,b-=n}step3_inner_s_loop_ld654(e,t,i,s){let a=this._a[s>>3],r=i,n=r-16*e;for(;r>n;){let e,i;e=t[r]-t[r-8],i=t[r-1]-t[r-9],t[r]+=t[r-8],t[r-1]+=t[r-9],t[r-8]=e,t[r-9]=i,e=t[r-2]-t[r-10],i=t[r-3]-t[r-11],t[r-2]+=t[r-10],t[r-3]+=t[r-11],t[r-10]=(e+i)*a,t[r-11]=(i-e)*a,e=t[r-12]-t[r-4],i=t[r-5]-t[r-13],t[r-4]+=t[r-12],t[r-5]+=t[r-13],t[r-12]=i,t[r-13]=e,e=t[r-14]-t[r-6],i=t[r-7]-t[r-15],t[r-6]+=t[r-14],t[r-7]+=t[r-15],t[r-14]=(e+i)*a,t[r-15]=(e-i)*a,this.iter_54(t,r),this.iter_54(t,r-8),r-=16}}iter_54(e,t){let i=e[t]-e[t-4],s=e[t]+e[t-4],a=e[t-2]+e[t-6],r=e[t-2]-e[t-6];e[t]=s+a,e[t-2]=s-a;let n=e[t-3]-e[t-7];e[t-4]=i+n,e[t-6]=i-n;let o=e[t-1]-e[t-5],l=e[t-1]+e[t-5],h=e[t-3]+e[t-7];e[t-1]=l+h,e[t-3]=l-h,e[t-5]=o-r,e[t-7]=o+r}}aG.M_PI=3.141592653589793;class az{constructor(){this._setupCache=new Map}reverse(e,t){let i;this._setupCache.has(t)?i=this._setupCache.get(t):(i=new aG(t),this._setupCache.set(t,i)),i.calcReverse(e)}}class aU{constructor(e,t,i){this._packetIndex=0,this._stream=e,this._setup=t,this._packets=i,this._currentPosition=0,this._prevPacketBuf=null,this._prevPacketStart=0,this._prevPacketEnd=0,this._prevPacketStop=0,this._nextPacketBuf=null,this._eosFound=!1,this._hasPosition=!1,this._modeFieldBits=aw.ilog(t.modes.length-1)}decode(){let e=new Float32Array(this._packets[this._packets.length-1].granulePosition*this._stream.audioChannels),t=new Float32Array(.2*this._stream.audioSampleRate*this._stream.audioChannels),i=0,s=0;for(;0!==(i=this.read(t,0,t.length));){if(s+i>=e.length){let i=new Float32Array(e.length+t.length);i.set(e,0),e=i}e.set(t.subarray(0,i),s),s+=i}return e.subarray(0,s)}read(e,t,i){if(0===i)return 0;let s=t,a=t+i;for(;s<a;){if(this._prevPacketStart===this._prevPacketEnd){if(this._eosFound){this._nextPacketBuf=null,this._prevPacketBuf=null;break}let e=this.readNextPacket((s-t)/this._stream.audioChannels);null===e&&(this._prevPacketEnd=this._prevPacketStop),null===e||null===e.samplePosition||this._hasPosition||(this._hasPosition=!0,this._currentPosition=e.samplePosition-(this._prevPacketEnd-this._prevPacketStart)-(s-t)/this._stream.audioChannels)}let i=Math.min((a-s)/this._stream.audioChannels,this._prevPacketEnd-this._prevPacketStart);i>0&&(s+=this.copyBuffer(e,s,i))}return i=s-t,this._currentPosition+=i/this._stream.audioChannels,i}copyBuffer(e,t,i){let s=t;for(;i>0;this._prevPacketStart++,i--)for(let t=0;t<this._stream.audioChannels;t++)e[s++]=this._prevPacketBuf[t][this._prevPacketStart];return s-t}readNextPacket(e){let t=this.decodeNextPacket();if(this._eosFound=this._eosFound||t.isEndOfStream,null==t.curPacket)return null;if(null!==t.samplePosition&&t.isEndOfStream){let i=this._currentPosition+e+t.validLen-t.startIndex,s=t.samplePosition-i;s<0&&(t.validLen+=s,t.validLen<0&&(t.validLen=0))}return this._prevPacketEnd>0?(aU.overlapBuffers(this._prevPacketBuf,t.curPacket,this._prevPacketStart,this._prevPacketStop,t.startIndex,this._stream.audioChannels),this._prevPacketStart=t.startIndex):null==this._prevPacketBuf&&(this._prevPacketStart=t.validLen),this._nextPacketBuf=this._prevPacketBuf,this._prevPacketEnd=t.validLen,this._prevPacketStop=t.totalLen,this._prevPacketBuf=t.curPacket,new aV(t.samplePosition)}static overlapBuffers(e,t,i,s,a,r){for(;i<s;i++,a++)for(let s=0;s<r;s++)t[s][a]+=e[s][i]}decodeNextPacket(){let e=new aX,t=null;if(this._packetIndex>=this._packets.length)e.isEndOfStream=!0;else{t=this._packets[this._packetIndex++];let i=new aS(sd.fromBuffer(t.packetData));if(e.isEndOfStream=t.isEndOfStream,!i.readBit()){let s=this._setup.modes[i.readBits(this._modeFieldBits)];if(null==this._nextPacketBuf){this._nextPacketBuf=Array(this._stream.audioChannels);for(let e=0;e<this._stream.audioChannels;e++)this._nextPacketBuf[e]=new Float32Array(this._stream.blocksize1)}let a=s.decode(i,this._nextPacketBuf);e.startIndex=a.packetStartIndex,e.validLen=a.packetValidLength,e.totalLen=a.packetTotalLength,e.samplePosition=t.granulePosition,e.curPacket=this._nextPacketBuf}}return e}}class aX{constructor(){this.curPacket=null,this.startIndex=0,this.validLen=0,this.totalLen=0,this.isEndOfStream=!1,this.samplePosition=null}}(ey=tK||(tK={}))[ey.IdentificationHeader=1]="IdentificationHeader",ey[ey.Comment=3]="Comment",ey[ey.SetupHeader=5]="SetupHeader";class aJ{constructor(e){this._packetIndex=-1,this._packets=e}read(){let e;for(;;){if(null==(e=this.nextPacket()))return null;if(e.isBeginningOfStream){let t=this.readStream(e);if(null!=t)return t}}}nextPacket(){return this._packetIndex++,this._packetIndex<this._packets.length?this._packets[this._packetIndex]:null}readStream(e){let t,i=new ay;if(!this.readIdentificationHeader(i,e)||!this.readComments(this.nextPacket()))return null;let s=new a_;if(!this.readSetupHeader(i,s,this.nextPacket()))return null;let a=[];for(;null!=(t=this.nextPacket())&&(a.push(t),!t.isEndOfStream););let r=new aU(i,s,a);return i.samples=r.decode(),i}comonHeaderDecode(e,t){let i=new Uint8Array(7);if(t.read(i,0,i.length),i[0]!==e)return!1;for(let e=0;e<aJ.VorbisHeaderMarker.length;e++)if(i[1+e]!==aJ.VorbisHeaderMarker[e])return!1;return!0}comonHeaderDecodeBit(e,t){let i=t.readBytes(7);if(i[0]!==e)return!1;for(let e=0;e<aJ.VorbisHeaderMarker.length;e++)if(i[1+e]!==aJ.VorbisHeaderMarker[e])return!1;return!0}readIdentificationHeader(e,t){let i=sd.fromBuffer(t.packetData);if(!this.comonHeaderDecode(tK.IdentificationHeader,i)||0!==sh.readUInt32LE(i)||(e.audioChannels=i.readByte(),e.audioSampleRate=sh.readUInt32LE(i),e.audioChannels<=0||e.audioSampleRate<=0))return!1;e.bitrateMaximum=sh.readInt32LE(i),e.bitrateNominal=sh.readInt32LE(i),e.bitrateMinimum=sh.readInt32LE(i);let s=i.readByte();return e.blocksize0=1<<(15&s),e.blocksize1=1<<(s>>4),!(e.blocksize0>e.blocksize1)&&!!aJ.isAllowedBlockSize(e.blocksize0)&&!!aJ.isAllowedBlockSize(e.blocksize0)&&0!==i.readByte()}static isAllowedBlockSize(e){switch(e){case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:return!0;default:return!1}}readComments(e){if(null==e)return!1;let t=sd.fromBuffer(e.packetData);if(!this.comonHeaderDecode(tK.Comment,t))return!1;let i=sh.readUInt32LE(t);t.skip(i);let s=sh.readUInt32LE(t);for(let e=0;e<s;e++){let e=sh.readUInt32LE(t);t.skip(e)}return 0!==t.readByte()}readSetupHeader(e,t,i){if(null==i)return!1;let s=new aS(sd.fromBuffer(i.packetData)),a=new az,r=new ax;if(!this.comonHeaderDecodeBit(tK.SetupHeader,s))return!1;let n=s.readByte()+1;for(let e=0;e<n;e++)t.codebooks.push(new aT(s,r));n=s.readBits(6)+1;for(let e=0;e<n;e++)t.timeDomainTransforms.push(new aP(s));n=s.readBits(6)+1;for(let i=0;i<n;i++)t.floors.push(new aE(s,e.blocksize0,e.blocksize1,t.codebooks));n=s.readBits(6)+1;for(let i=0;i<n;i++)t.residues.push(new aA(s,e.audioChannels,t.codebooks));n=s.readBits(6)+1;for(let i=0;i<n;i++)t.mappings.push(new aR(s,e.audioChannels,t.floors,t.residues,a));n=s.readBits(6)+1;for(let i=0;i<n;i++)t.modes.push(new aW(s,e.audioChannels,e.blocksize0,e.blocksize1,t.mappings));return!!s.readBit()}}aJ.VorbisHeaderMarker=new Uint8Array([118,111,114,98,105,115]);class aY{constructor(e){this.streams=[];const t=new aJ(new af(e).read());for(;;){const e=t.read();if(null==e)break;this.streams.push(e)}}}class aq{constructor(){this.phdrs=[],this.pbags=[],this.pmods=[],this.pgens=[],this.insts=[],this.ibags=[],this.imods=[],this.igens=[],this.sHdrs=[],this.sampleData=new Uint8Array(0),this._sampleCache=new Map}decodeSamples(e,t,i){let s=`${e}_${t}_${i}`;if(!this._sampleCache.has(s)){let a,r=this.sampleData.slice(e,t);if(i)a=new aY(sd.fromBuffer(r)).streams[0].samples;else{let e=new DataView(r.buffer,r.byteOffset,r.length);a=new Float32Array(r.length/2);for(let t=0;t<a.length;t++)a[t]=e.getInt16(2*t,!0)/32767}return this._sampleCache.set(s,a),a}return this._sampleCache.get(s)}load(e){let t=new am,i=new am;if(!am.load(null,t,e)||"sfbk"!==t.id)throw new st("Soundfont is not a valid Soundfont2 file");for(;am.load(t,i,e);){let t=new am;if("pdta"===i.id)for(;am.load(i,t,e);)switch(t.id){case"phdr":for(let i=0,s=t.size/a1.SizeInFile|0;i<s;i++)this.phdrs.push(new a1(e));break;case"pbag":for(let i=0,s=t.size/aZ.SizeInFile|0;i<s;i++)this.pbags.push(new aZ(e));break;case"pmod":for(let i=0,s=t.size/a2.SizeInFile|0;i<s;i++)this.pmods.push(new a2(e));break;case"pgen":for(let i=0,s=t.size/a0.SizeInFile|0;i<s;i++)this.pgens.push(new a0(e));break;case"inst":for(let i=0,s=t.size/aQ.SizeInFile|0;i<s;i++)this.insts.push(new aQ(e));break;case"ibag":for(let i=0,s=t.size/a$.SizeInFile|0;i<s;i++)this.ibags.push(new a$(e));break;case"imod":for(let i=0,s=t.size/aj.SizeInFile|0;i<s;i++)this.imods.push(new aj(e));break;case"igen":for(let i=0,s=t.size/aK.SizeInFile|0;i<s;i++)this.igens.push(new aK(e));break;case"shdr":for(let i=0,s=t.size/a5.SizeInFile|0;i<s;i++)this.sHdrs.push(new a5(e));break;default:e.position+=t.size}else if("sdta"===i.id)for(;am.load(i,t,e);)"smpl"===t.id?(this.sampleData=new Uint8Array(t.size),e.read(this.sampleData,0,t.size)):e.position+=t.size;else e.position+=i.size}}}class a${constructor(e){this.instGenNdx=sh.readUInt16LE(e),this.instModNdx=sh.readUInt16LE(e)}}a$.SizeInFile=4;class aj{constructor(e){this.modSrcOper=sh.readUInt16LE(e),this.modDestOper=sh.readUInt16LE(e),this.modAmount=sh.readInt16LE(e),this.modAmtSrcOper=sh.readUInt16LE(e),this.modTransOper=sh.readUInt16LE(e)}}aj.SizeInFile=10;class aK{constructor(e){this.genOper=sh.readUInt16LE(e),this.genAmount=new a3(e)}}aK.SizeInFile=4;class aQ{constructor(e){this.instName=sh.read8BitStringLength(e,20),this.instBagNdx=sh.readUInt16LE(e)}}aQ.SizeInFile=22;class aZ{constructor(e){this.genNdx=sh.readUInt16LE(e),this.modNdx=sh.readUInt16LE(e)}}aZ.SizeInFile=4;class a0{constructor(e){this.genOper=sh.readUInt16LE(e),this.genAmount=new a3(e)}}a0.SizeInFile=4,a0.GenInstrument=41,a0.GenKeyRange=43,a0.GenVelRange=44,a0.GenSampleId=53;class a1{constructor(e){this.presetName=sh.read8BitStringLength(e,20),this.preset=sh.readUInt16LE(e),this.bank=sh.readUInt16LE(e),this.presetBagNdx=sh.readUInt16LE(e),this.library=sh.readUInt32LE(e),this.genre=sh.readUInt32LE(e),this.morphology=sh.readUInt32LE(e)}}a1.SizeInFile=38;class a2{constructor(e){this.modSrcOper=sh.readUInt16LE(e),this.modDestOper=sh.readUInt16LE(e),this.modAmount=sh.readUInt16LE(e),this.modAmtSrcOper=sh.readUInt16LE(e),this.modTransOper=sh.readUInt16LE(e)}}a2.SizeInFile=10;class a5{constructor(e){this.sampleName=sh.read8BitStringLength(e,20),this.start=sh.readUInt32LE(e),this.end=sh.readUInt32LE(e),this.startLoop=sh.readUInt32LE(e),this.endLoop=sh.readUInt32LE(e),this.sampleRate=sh.readUInt32LE(e),this.originalPitch=e.readByte(),this.pitchCorrection=sh.readSInt8(e),this.sampleLink=sh.readUInt16LE(e),this.sampleType=sh.readUInt16LE(e)}}a5.SizeInFile=46;class a3{get shortAmount(){return sl.uint16ToInt16(this.wordAmount)}get lowByteAmount(){return 255&this.wordAmount}get highByteAmount(){return(65280&this.wordAmount)>>8&255}constructor(e){this.wordAmount=sh.readUInt16LE(e)}}class a4{constructor(){this.presetIndex=0,this.bank=0,this.pitchWheel=0,this.perNotePitchWheel=new Map,this.midiPan=0,this.midiVolume=0,this.midiExpression=0,this.midiRpn=0,this.midiData=0,this.panOffset=0,this.gainDb=0,this.pitchRange=0,this.tuning=0,this.mixVolume=0,this.mute=!1,this.solo=!1}}class a6{constructor(){this.activeChannel=0,this.channelList=[]}setupVoice(e,t){let i=this.channelList[this.activeChannel],s=t.region.pan+i.panOffset;t.playingChannel=this.activeChannel,t.mixVolume=i.mixVolume,t.noteGainDb+=i.gainDb,t.updatePitchRatio(i,e.outSampleRate),s<=-.5?(t.panFactorLeft=1,t.panFactorRight=0):s>=.5?(t.panFactorLeft=0,t.panFactorRight=1):(t.panFactorLeft=Math.sqrt(.5-s),t.panFactorRight=Math.sqrt(.5+s))}}(eb=tQ||(tQ={}))[eb.None=0]="None",eb[eb.Continuous=1]="Continuous",eb[eb.Sustain=2]="Sustain",(eS=tZ||(tZ={}))[eS.StereoInterleaved=0]="StereoInterleaved",eS[eS.StereoUnweaved=1]="StereoUnweaved",eS[eS.Mono=2]="Mono";class a8{constructor(){this.name="",this.presetNumber=0,this.bank=0,this.regions=null}}class a7{static timecents2Secs(e){return Math.pow(2,e/1200)}static decibelsToGain(e){return e>-100?Math.pow(10,.05*e):0}static gainToDecibels(e){return e<=1e-5?-100:20*Math.log10(e)}static cents2Hertz(e){return 8.176*Math.pow(2,e/1200)}}class a9{constructor(e){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0,e&&(this.delay=e.delay,this.attack=e.attack,this.hold=e.hold,this.decay=e.decay,this.sustain=e.sustain,this.release=e.release,this.keynumToHold=e.keynumToHold,this.keynumToDecay=e.keynumToDecay)}clear(){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0}envToSecs(e){this.delay=this.delay<-11950?0:a7.timecents2Secs(this.delay),this.attack=this.attack<-11950?0:a7.timecents2Secs(this.attack),this.release=this.release<-11950?0:a7.timecents2Secs(this.release),0===this.keynumToHold&&(this.hold=this.hold<-11950?0:a7.timecents2Secs(this.hold)),0===this.keynumToDecay&&(this.decay=this.decay<-11950?0:a7.timecents2Secs(this.decay)),this.sustain<0?this.sustain=0:e?this.sustain=a7.decibelsToGain(-this.sustain/10):this.sustain=1-this.sustain/1e3}}(e_=t0||(t0={}))[e_.StartAddrsOffset=0]="StartAddrsOffset",e_[e_.EndAddrsOffset=1]="EndAddrsOffset",e_[e_.StartloopAddrsOffset=2]="StartloopAddrsOffset",e_[e_.EndloopAddrsOffset=3]="EndloopAddrsOffset",e_[e_.StartAddrsCoarseOffset=4]="StartAddrsCoarseOffset",e_[e_.ModLfoToPitch=5]="ModLfoToPitch",e_[e_.VibLfoToPitch=6]="VibLfoToPitch",e_[e_.ModEnvToPitch=7]="ModEnvToPitch",e_[e_.InitialFilterFc=8]="InitialFilterFc",e_[e_.InitialFilterQ=9]="InitialFilterQ",e_[e_.ModLfoToFilterFc=10]="ModLfoToFilterFc",e_[e_.ModEnvToFilterFc=11]="ModEnvToFilterFc",e_[e_.EndAddrsCoarseOffset=12]="EndAddrsCoarseOffset",e_[e_.ModLfoToVolume=13]="ModLfoToVolume",e_[e_.Unused1=14]="Unused1",e_[e_.ChorusEffectsSend=15]="ChorusEffectsSend",e_[e_.ReverbEffectsSend=16]="ReverbEffectsSend",e_[e_.Pan=17]="Pan",e_[e_.Unused2=18]="Unused2",e_[e_.Unused3=19]="Unused3",e_[e_.Unused4=20]="Unused4",e_[e_.DelayModLFO=21]="DelayModLFO",e_[e_.FreqModLFO=22]="FreqModLFO",e_[e_.DelayVibLFO=23]="DelayVibLFO",e_[e_.FreqVibLFO=24]="FreqVibLFO",e_[e_.DelayModEnv=25]="DelayModEnv",e_[e_.AttackModEnv=26]="AttackModEnv",e_[e_.HoldModEnv=27]="HoldModEnv",e_[e_.DecayModEnv=28]="DecayModEnv",e_[e_.SustainModEnv=29]="SustainModEnv",e_[e_.ReleaseModEnv=30]="ReleaseModEnv",e_[e_.KeynumToModEnvHold=31]="KeynumToModEnvHold",e_[e_.KeynumToModEnvDecay=32]="KeynumToModEnvDecay",e_[e_.DelayVolEnv=33]="DelayVolEnv",e_[e_.AttackVolEnv=34]="AttackVolEnv",e_[e_.HoldVolEnv=35]="HoldVolEnv",e_[e_.DecayVolEnv=36]="DecayVolEnv",e_[e_.SustainVolEnv=37]="SustainVolEnv",e_[e_.ReleaseVolEnv=38]="ReleaseVolEnv",e_[e_.KeynumToVolEnvHold=39]="KeynumToVolEnvHold",e_[e_.KeynumToVolEnvDecay=40]="KeynumToVolEnvDecay",e_[e_.Instrument=41]="Instrument",e_[e_.Reserved1=42]="Reserved1",e_[e_.KeyRange=43]="KeyRange",e_[e_.VelRange=44]="VelRange",e_[e_.StartloopAddrsCoarseOffset=45]="StartloopAddrsCoarseOffset",e_[e_.Keynum=46]="Keynum",e_[e_.Velocity=47]="Velocity",e_[e_.InitialAttenuation=48]="InitialAttenuation",e_[e_.Reserved2=49]="Reserved2",e_[e_.EndloopAddrsCoarseOffset=50]="EndloopAddrsCoarseOffset",e_[e_.CoarseTune=51]="CoarseTune",e_[e_.FineTune=52]="FineTune",e_[e_.SampleID=53]="SampleID",e_[e_.SampleModes=54]="SampleModes",e_[e_.Reserved3=55]="Reserved3",e_[e_.ScaleTuning=56]="ScaleTuning",e_[e_.ExclusiveClass=57]="ExclusiveClass",e_[e_.OverridingRootKey=58]="OverridingRootKey",e_[e_.Unused5=59]="Unused5",e_[e_.EndOper=60]="EndOper";class re{constructor(e){this.loopMode=tQ.None,this.samples=re.NoSamples,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv=new a9,this.modEnv=new a9,this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,e&&(this.loopMode=e.loopMode,this.samples=e.samples,this.sampleRate=e.sampleRate,this.loKey=e.loKey,this.hiKey=e.hiKey,this.loVel=e.loVel,this.hiVel=e.hiVel,this.group=e.group,this.offset=e.offset,this.end=e.end,this.loopStart=e.loopStart,this.loopEnd=e.loopEnd,this.transpose=e.transpose,this.tune=e.tune,this.pitchKeyCenter=e.pitchKeyCenter,this.pitchKeyTrack=e.pitchKeyTrack,this.attenuation=e.attenuation,this.pan=e.pan,this.ampEnv=new a9(e.ampEnv),this.modEnv=new a9(e.modEnv),this.initialFilterQ=e.initialFilterQ,this.initialFilterFc=e.initialFilterFc,this.modEnvToPitch=e.modEnvToPitch,this.modEnvToFilterFc=e.modEnvToFilterFc,this.modLfoToFilterFc=e.modLfoToFilterFc,this.modLfoToVolume=e.modLfoToVolume,this.delayModLFO=e.delayModLFO,this.freqModLFO=e.freqModLFO,this.modLfoToPitch=e.modLfoToPitch,this.delayVibLFO=e.delayVibLFO,this.freqVibLFO=e.freqVibLFO,this.vibLfoToPitch=e.vibLfoToPitch)}clear(e){this.loopMode=tQ.None,this.samples=re.NoSamples,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv.clear(),this.modEnv.clear(),this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,this.hiKey=127,this.hiVel=127,this.pitchKeyCenter=60,e||(this.pitchKeyTrack=100,this.pitchKeyCenter=-1,this.ampEnv.delay=-12e3,this.ampEnv.attack=-12e3,this.ampEnv.hold=-12e3,this.ampEnv.decay=-12e3,this.ampEnv.release=-12e3,this.modEnv.delay=-12e3,this.modEnv.attack=-12e3,this.modEnv.hold=-12e3,this.modEnv.decay=-12e3,this.modEnv.release=-12e3,this.initialFilterFc=13500,this.delayModLFO=-12e3,this.delayVibLFO=-12e3)}operator(e,t){switch(e){case t0.StartAddrsOffset:this.offset+=sl.int16ToUint32(t.shortAmount);break;case t0.EndAddrsOffset:this.end+=sl.int16ToUint32(t.shortAmount);break;case t0.StartloopAddrsOffset:this.loopStart+=sl.int16ToUint32(t.shortAmount);break;case t0.EndloopAddrsOffset:this.loopEnd+=sl.int16ToUint32(t.shortAmount);break;case t0.StartAddrsCoarseOffset:this.offset+=32768*sl.int16ToUint32(t.shortAmount);break;case t0.ModLfoToPitch:this.modLfoToPitch=t.shortAmount;break;case t0.VibLfoToPitch:this.vibLfoToPitch=t.shortAmount;break;case t0.ModEnvToPitch:this.modEnvToPitch=t.shortAmount;break;case t0.InitialFilterFc:this.initialFilterFc=t.shortAmount;break;case t0.InitialFilterQ:this.initialFilterQ=t.shortAmount;break;case t0.ModLfoToFilterFc:this.modLfoToFilterFc=t.shortAmount;break;case t0.ModEnvToFilterFc:this.modEnvToFilterFc=t.shortAmount;break;case t0.EndAddrsCoarseOffset:this.end+=32768*sl.int16ToUint32(t.shortAmount);break;case t0.ModLfoToVolume:this.modLfoToVolume=t.shortAmount;break;case t0.Pan:this.pan=t.shortAmount/1e3;break;case t0.DelayModLFO:this.delayModLFO=t.shortAmount;break;case t0.FreqModLFO:this.freqModLFO=t.shortAmount;break;case t0.DelayVibLFO:this.delayVibLFO=t.shortAmount;break;case t0.FreqVibLFO:this.freqVibLFO=t.shortAmount;break;case t0.DelayModEnv:this.modEnv.delay=t.shortAmount;break;case t0.AttackModEnv:this.modEnv.attack=t.shortAmount;break;case t0.HoldModEnv:this.modEnv.hold=t.shortAmount;break;case t0.DecayModEnv:this.modEnv.decay=t.shortAmount;break;case t0.SustainModEnv:this.modEnv.sustain=t.shortAmount;break;case t0.ReleaseModEnv:this.modEnv.release=t.shortAmount;break;case t0.KeynumToModEnvHold:this.modEnv.keynumToHold=t.shortAmount;break;case t0.KeynumToModEnvDecay:this.modEnv.keynumToDecay=t.shortAmount;break;case t0.DelayVolEnv:this.ampEnv.delay=t.shortAmount;break;case t0.AttackVolEnv:this.ampEnv.attack=t.shortAmount;break;case t0.HoldVolEnv:this.ampEnv.hold=t.shortAmount;break;case t0.DecayVolEnv:this.ampEnv.decay=t.shortAmount;break;case t0.SustainVolEnv:this.ampEnv.sustain=t.shortAmount;break;case t0.ReleaseVolEnv:this.ampEnv.release=t.shortAmount;break;case t0.KeynumToVolEnvHold:this.ampEnv.keynumToHold=t.shortAmount;break;case t0.KeynumToVolEnvDecay:this.ampEnv.keynumToDecay=t.shortAmount;break;case t0.KeyRange:this.loKey=t.lowByteAmount,this.hiKey=t.highByteAmount;break;case t0.VelRange:this.loVel=t.lowByteAmount,this.hiVel=t.highByteAmount;break;case t0.StartloopAddrsCoarseOffset:this.loopStart+=32768*sl.int16ToUint32(t.shortAmount);break;case t0.InitialAttenuation:this.attenuation+=.1*t.shortAmount;break;case t0.EndloopAddrsCoarseOffset:this.loopEnd+=32768*sl.int16ToUint32(t.shortAmount);break;case t0.CoarseTune:this.transpose+=t.shortAmount;break;case t0.FineTune:this.tune+=t.shortAmount;break;case t0.SampleModes:this.loopMode=(3&t.wordAmount)==3?tQ.Sustain:(3&t.wordAmount)==1?tQ.Continuous:tQ.None;break;case t0.ScaleTuning:this.pitchKeyTrack=t.shortAmount;break;case t0.ExclusiveClass:this.group=t.wordAmount;break;case t0.OverridingRootKey:this.pitchKeyCenter=t.shortAmount}}}re.NoSamples=new Float32Array(0),(ew=t1||(t1={}))[ew.None=0]="None",ew[ew.Delay=1]="Delay",ew[ew.Attack=2]="Attack",ew[ew.Hold=3]="Hold",ew[ew.Decay=4]="Decay",ew[ew.Sustain=5]="Sustain",ew[ew.Release=6]="Release",ew[ew.Done=7]="Done";class rt{constructor(){this.level=0,this.slope=0,this.samplesUntilNextSegment=0,this.segment=t1.None,this.midiVelocity=0,this.parameters=null,this.segmentIsExponential=!1,this.isAmpEnv=!1}nextSegment(e,t){if(this.parameters)for(;;)switch(e){case t1.None:if(this.samplesUntilNextSegment=this.parameters.delay*t|0,this.samplesUntilNextSegment>0){this.segment=t1.Delay,this.segmentIsExponential=!1,this.level=0,this.slope=0;return}e=t1.Delay;break;case t1.Delay:if(this.samplesUntilNextSegment=this.parameters.attack*t|0,this.samplesUntilNextSegment>0){this.isAmpEnv||(this.samplesUntilNextSegment=this.parameters.attack*((145-this.midiVelocity)/144)*t|0),this.segment=t1.Attack,this.segmentIsExponential=!1,this.level=0,this.slope=1/this.samplesUntilNextSegment;return}e=t1.Attack;break;case t1.Attack:if(this.samplesUntilNextSegment=this.parameters.hold*t|0,this.samplesUntilNextSegment>0){this.segment=t1.Hold,this.segmentIsExponential=!1,this.level=1,this.slope=0;return}e=t1.Hold;break;case t1.Hold:if(this.samplesUntilNextSegment=this.parameters.decay*t|0,this.samplesUntilNextSegment>0){if(this.segment=t1.Decay,this.level=1,this.isAmpEnv){let e=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(e),this.segmentIsExponential=!0,this.parameters.sustain>0&&(this.samplesUntilNextSegment=Math.log(this.parameters.sustain)/e|0)}else this.slope=-1/this.samplesUntilNextSegment,this.samplesUntilNextSegment=this.parameters.decay*(1-this.parameters.sustain)*t|0,this.segmentIsExponential=!1;return}e=t1.Decay;break;case t1.Decay:this.segment=t1.Sustain,this.level=this.parameters.sustain,this.slope=0,this.samplesUntilNextSegment=0x7fffffff,this.segmentIsExponential=!1;return;case t1.Sustain:if(this.segment=t1.Release,this.samplesUntilNextSegment=(this.parameters.release<=0?rt.FastReleaseTime:this.parameters.release)*t|0,this.isAmpEnv){let e=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(e),this.segmentIsExponential=!0}else this.slope=-this.level/this.samplesUntilNextSegment,this.segmentIsExponential=!1;return;default:this.segment=t1.Done,this.segmentIsExponential=!1,this.level=0,this.slope=0,this.samplesUntilNextSegment=0x7ffffff;return}}setup(e,t,i,s,a){this.parameters=new a9(e),this.parameters.keynumToHold>0&&(this.parameters.hold+=this.parameters.keynumToHold*(60-t),this.parameters.hold=this.parameters.hold<-1e4?0:a7.timecents2Secs(this.parameters.hold)),this.parameters.keynumToDecay>0&&(this.parameters.decay+=this.parameters.keynumToDecay*(60-t),this.parameters.decay=this.parameters.decay<-1e4?0:a7.timecents2Secs(this.parameters.decay)),this.midiVelocity=0|i,this.isAmpEnv=s,this.nextSegment(t1.None,a)}process(e,t){this.slope>0&&(this.segmentIsExponential?this.level*=Math.pow(this.slope,e):this.level+=this.slope*e),this.samplesUntilNextSegment-=e,this.samplesUntilNextSegment<=0&&this.nextSegment(this.segment,t)}}rt.FastReleaseTime=.01;class ri{constructor(){this.samplesUntil=0,this.level=0,this.delta=0}setup(e,t,i){this.samplesUntil=e*i|0,this.delta=4*a7.cents2Hertz(t)/i,this.level=0}process(e){if(this.samplesUntil>e){this.samplesUntil-=e;return}this.level+=this.delta*e,this.level>1?(this.delta=-this.delta,this.level=2-this.level):this.level<-1&&(this.delta=-this.delta,this.level=-2-this.level)}}class rs{constructor(e){this.qInv=0,this.a0=0,this.a1=0,this.b1=0,this.b2=0,this.z1=0,this.z2=0,this.active=!1,e&&(this.qInv=e.qInv,this.a0=e.a0,this.a1=e.a1,this.b1=e.b1,this.b2=e.b2,this.z1=e.z1,this.z2=e.z2,this.active=e.active)}setup(e){let t=Math.tan(Math.PI*e),i=t*t,s=1/(1+t*this.qInv+i);this.a0=i*s,this.a1=2*this.a0,this.b1=2*(i-1)*s,this.b2=(1-t*this.qInv+i)*s}process(e){let t=e*this.a0+this.z1;return this.z1=e*this.a1+this.z2-this.b1*t,this.z2=e*this.a0-this.b2*t,t}}class ra{constructor(){this.playingPreset=0,this.playingKey=0,this.playingChannel=0,this.region=null,this.pitchInputTimecents=0,this.pitchOutputFactor=0,this.sourceSamplePosition=0,this.noteGainDb=0,this.panFactorLeft=0,this.panFactorRight=0,this.playIndex=0,this.loopStart=0,this.loopEnd=0,this.ampEnv=new rt,this.modEnv=new rt,this.lowPass=new rs,this.modLfo=new ri,this.vibLfo=new ri,this.mixVolume=0,this.mute=!1}updatePitchRatio(e,t){let i=e.pitchWheel;e.perNotePitchWheel.has(this.playingKey)&&(i+=e.perNotePitchWheel.get(this.playingKey)-8192);let s=8192===i?e.tuning:i/16383*e.pitchRange*2-e.pitchRange+e.tuning;this.calcPitchRatio(s,t)}calcPitchRatio(e,t){if(!this.region)return;let i=this.playingKey+this.region.transpose+this.region.tune/100,s=this.region.pitchKeyCenter+(i-this.region.pitchKeyCenter)*(this.region.pitchKeyTrack/100);0!==e&&(s+=e),this.pitchInputTimecents=100*s,this.pitchOutputFactor=this.region.sampleRate/(a7.timecents2Secs(100*this.region.pitchKeyCenter)*t)}end(e){this.region&&(this.ampEnv.nextSegment(t1.Sustain,e),this.modEnv.nextSegment(t1.Sustain,e),this.region.loopMode===tQ.Sustain&&(this.loopEnd=this.loopStart))}endQuick(e){this.ampEnv.parameters.release=0,this.ampEnv.nextSegment(t1.Sustain,e),this.modEnv.parameters.release=0,this.modEnv.nextSegment(t1.Sustain,e)}render(e,t,i,s,a){if(!this.region)return;let r=this.region,n=r.samples,o=0,l=e.outputMode===tZ.StereoUnweaved?s:-1,h=0!==r.modEnvToPitch||0!==r.modEnvToFilterFc,d=this.modLfo.delta>0&&(0!==r.modLfoToPitch||0!==r.modLfoToFilterFc||0!==r.modLfoToVolume),c=this.vibLfo.delta>0&&0!==r.vibLfoToPitch,u=this.loopStart<this.loopEnd,p=this.loopStart,m=this.loopEnd,g=r.end,f=m+1,y=this.sourceSamplePosition,b=new rs(this.lowPass),S=0!==r.modLfoToFilterFc||0!==r.modEnvToFilterFc,_=0,w=0,k=0,B=0,T=0!==r.modLfoToPitch||0!==r.modEnvToPitch||0!==r.vibLfoToPitch,N=0,x=0,P=0,v=0,F=0!==r.modLfoToVolume,C=0,D=0;for(S?(_=e.outSampleRate,w=r.initialFilterFc,k=r.modLfoToFilterFc,B=r.modEnvToFilterFc):(_=0,w=0,k=0,B=0),T?(N=0,x=r.modLfoToPitch,P=r.vibLfoToPitch,v=r.modEnvToPitch):(N=a7.timecents2Secs(this.pitchInputTimecents)*this.pitchOutputFactor,x=0,P=0,v=0),F?D=.1*r.modLfoToVolume:(C=a7.decibelsToGain(this.noteGainDb),D=0);s>0;){let r,E,M=0,L=s>ra.RenderEffectSampleBlock?ra.RenderEffectSampleBlock:s;if(s-=L,S){let e=w+this.modLfo.level*k+this.modEnv.level*B;b.active=e<=13500,b.active&&b.setup(a7.cents2Hertz(e)/_)}switch(T&&(N=a7.timecents2Secs(this.pitchInputTimecents+(this.modLfo.level*x+this.vibLfo.level*P+this.modEnv.level*v))*this.pitchOutputFactor),F&&(C=a7.decibelsToGain(this.noteGainDb+this.modLfo.level*D)),r=C*this.ampEnv.level,a?r=0:r*=this.mixVolume,this.ampEnv.process(L,e.outSampleRate),h&&this.modEnv.process(L,e.outSampleRate),d&&this.modLfo.process(L),c&&this.vibLfo.process(L),e.outputMode){case tZ.StereoInterleaved:for(E=r*this.panFactorLeft,M=r*this.panFactorRight;L-- >0&&y<g;){let e=0|y,s=e>=m&&u?p:e+1,a=y-e,r=n[e]*(1-a)+n[s]*a;b.active&&(r=b.process(r)),t[i+o]+=r*E,o++,t[i+o]+=r*M,o++,(y+=N)>=f&&u&&(y-=m-p+1)}break;case tZ.StereoUnweaved:for(E=r*this.panFactorLeft,M=r*this.panFactorRight;L-- >0&&y<g;){let e=0|y,s=e>=m&&u?p:e+1,a=y-e,r=n[e]*(1-a)+n[s]*a;b.active&&(r=b.process(r)),t[i+o]+=r*E,o++,t[i+l]+=r*M,l++,(y+=N)>=f&&u&&(y-=m-p+1)}break;case tZ.Mono:for(;L-- >0&&y<g;){let e=0|y,s=e>=m&&u?p:e+1,a=y-e,l=n[e]*(1-a)+n[s]*a;b.active&&(l=b.process(l)),t[i+o]=l*r,o++,(y+=N)>=f&&u&&(y-=m-p+1)}}if(y>=g||this.ampEnv.segment===t1.Done)return void this.kill()}this.sourceSamplePosition=y,(b.active||S)&&(this.lowPass=b)}kill(){this.playingPreset=-1}}ra.RenderEffectSampleBlock=iI.MicroBufferSize;class rr{constructor(e){this.value=e}}class rn{get isEmpty(){return void 0===this._head}clear(){this._head=void 0,this._tail=void 0}enqueue(e){let t=new rr(e);this._tail?this._tail.next=t:this._head=t,this._tail=t}peek(){let e=this._head;if(e)return e.value}dequeue(){let e=this._head;if(!e)return;let t=e.next;return this._head=t,t||(this._tail=void 0),e.value}}(ek=t2||(t2={}))[ek.BankSelectCoarse=0]="BankSelectCoarse",ek[ek.ModulationCoarse=1]="ModulationCoarse",ek[ek.DataEntryCoarse=6]="DataEntryCoarse",ek[ek.VolumeCoarse=7]="VolumeCoarse",ek[ek.PanCoarse=10]="PanCoarse",ek[ek.ExpressionControllerCoarse=11]="ExpressionControllerCoarse",ek[ek.BankSelectFine=32]="BankSelectFine",ek[ek.ModulationFine=33]="ModulationFine",ek[ek.DataEntryFine=38]="DataEntryFine",ek[ek.VolumeFine=39]="VolumeFine",ek[ek.PanFine=42]="PanFine",ek[ek.ExpressionControllerFine=43]="ExpressionControllerFine",ek[ek.HoldPedal=64]="HoldPedal",ek[ek.LegatoPedal=68]="LegatoPedal",ek[ek.NonRegisteredParameterFine=98]="NonRegisteredParameterFine",ek[ek.NonRegisteredParameterCourse=99]="NonRegisteredParameterCourse",ek[ek.RegisteredParameterFine=100]="RegisteredParameterFine",ek[ek.RegisteredParameterCourse=101]="RegisteredParameterCourse",ek[ek.AllSoundOff=120]="AllSoundOff",ek[ek.ResetControllers=121]="ResetControllers",ek[ek.AllNotesOff=123]="AllNotesOff";class ro{constructor(e){this._midiEventQueue=new rn,this._mutedChannels=new Map,this._soloChannels=new Map,this._isAnySolo=!1,this._transpositionPitches=new Map,this._liveTranspositionPitches=new Map,this.currentTempo=0,this.timeSignatureNumerator=0,this.timeSignatureDenominator=0,this.presets=null,this._voices=[],this._channels=null,this._voicePlayIndex=0,this.outputMode=tZ.StereoInterleaved,this.outSampleRate=0,this.globalGainDb=0,this.outSampleRate=e}synthesize(e,t,i){return this.fillWorkingBuffer(e,t,i)}synthesizeSilent(e){this.fillWorkingBuffer(null,0,e)}channelGetMixVolume(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].mixVolume:1}channelSetMixVolume(e,t){let i=this.channelInit(e);for(let i of this._voices)i.playingChannel===e&&-1!==i.playingPreset&&(i.mixVolume=t);i.mixVolume=t}channelSetMute(e,t){t?this._mutedChannels.set(e,!0):this._mutedChannels.delete(e)}channelSetSolo(e,t){t?this._soloChannels.set(e,!0):this._soloChannels.delete(e),this._isAnySolo=this._soloChannels.size>0}resetChannelStates(){this._mutedChannels=new Map,this._soloChannels=new Map,this._liveTranspositionPitches=new Map,this.applyTranspositionPitches(new Map),this._isAnySolo=!1}setChannelTranspositionPitch(e,t){let i=0;for(let s of(this._liveTranspositionPitches.has(e)&&(i=this._liveTranspositionPitches.get(e)),0===t?this._liveTranspositionPitches.delete(e):this._liveTranspositionPitches.set(e,t),this._voices))if(s.playingChannel===e&&9!==s.playingChannel){let e;e=0-i+t,s.playingKey+=e,this._channels&&s.updatePitchRatio(this._channels.channelList[s.playingChannel],this.outSampleRate)}}applyTranspositionPitches(e){let t=this._transpositionPitches;for(let i of this._voices)if(i.playingChannel>=0&&9!==i.playingChannel){let s=0;t.has(i.playingChannel)&&(s-=t.get(i.playingChannel)),e.has(i.playingChannel)&&(s+=e.get(i.playingChannel)),i.playingKey+=s,this._channels&&i.updatePitchRatio(this._channels.channelList[i.playingChannel],this.outSampleRate)}this._transpositionPitches=e}dispatchEvent(e){this._midiEventQueue.enqueue(e)}fillWorkingBuffer(e,t,i){let s=this._isAnySolo,a=[];for(;!this._midiEventQueue.isEmpty;){let e=this._midiEventQueue.dequeue();e.isMetronome&&this.metronomeVolume>0?(this.channelNoteOff(iI.MetronomeChannel,iI.MetronomeKey),this.channelNoteOn(iI.MetronomeChannel,iI.MetronomeKey,95/127)):e.event&&this.processMidiMessage(e.event),a.push(e)}for(let a of this._voices)if(-1!==a.playingPreset){let r=a.playingChannel,n=this._mutedChannels.has(r)||s&&r!==iI.MetronomeChannel&&!this._soloChannels.has(r);e?a.render(this,e,t,i,n):a.kill()}return a}processMidiMessage(e){switch(e.type){case tq.TimeSignature:this.timeSignatureNumerator=e.numerator,this.timeSignatureDenominator=Math.pow(2,e.denominatorIndex);break;case tq.NoteOn:this.channelNoteOn(e.channel,e.noteKey,e.noteVelocity/127);break;case tq.NoteOff:this.channelNoteOff(e.channel,e.noteKey);break;case tq.ControlChange:this.channelMidiControl(e.channel,e.controller,e.value);break;case tq.ProgramChange:this.channelSetPresetNumber(e.channel,e.program,9===e.channel);break;case tq.TempoChange:this.currentTempo=e.beatsPerMinute;break;case tq.PitchBend:this.channelSetPitchWheel(e.channel,e.value);break;case tq.PerNotePitchBend:let t=e.value;t=t*iI.MaxPitchWheel/iI.MaxPitchWheel20,this.channelSetPerNotePitchWheel(e.channel,e.noteKey,t)}}get metronomeVolume(){return this.channelGetMixVolume(iI.MetronomeChannel)}set metronomeVolume(e){this.setupMetronomeChannel(e)}setupMetronomeChannel(e){this.channelSetMixVolume(iI.MetronomeChannel,e),e>0&&(this.channelSetVolume(iI.MetronomeChannel,1),this.channelSetPresetNumber(iI.MetronomeChannel,0,!0))}get masterVolume(){return a7.decibelsToGain(this.globalGainDb)}set masterVolume(e){let t=a7.gainToDecibels(e),i=t-this.globalGainDb;if(0!==i){for(let e of this._voices)-1!==e.playingPreset&&(e.noteGainDb+=i);this.globalGainDb=t}}resetSoft(){for(let e of this._voices)-1!==e.playingPreset&&(e.ampEnv.segment<t1.Release||0!==e.ampEnv.parameters.release)&&e.endQuick(this.outSampleRate);if(this._channels)for(let e of this._channels.channelList)e.presetIndex=0,e.bank=0,e.pitchWheel=8192,e.midiPan=8192,e.perNotePitchWheel.clear(),e.midiVolume=16383,e.midiExpression=16383,e.midiRpn=65535,e.midiData=0,e.panOffset=0,e.gainDb=0,e.pitchRange=2,e.tuning=0}get presetCount(){return this.presets?.length??0}reset(){for(let e of this._voices)-1!==e.playingPreset&&(e.ampEnv.segment<t1.Release||0!==e.ampEnv.parameters.release)&&e.endQuick(this.outSampleRate);this._channels=null}setOutput(e,t,i){this.outputMode=e,this.outSampleRate=t>=1?t:44100,this.globalGainDb=i}noteOn(e,t,i){if(!this.presets)return;let s=127*i|0;if(e<0||e>=this.presets.length)return;if(i<=0)return void this.noteOff(e,t);let a=this._voicePlayIndex++;for(let r of this.presets[e].regions){if(t<r.loKey||t>r.hiKey||s<r.loVel||s>r.hiVel)continue;let n=null;if(0!==r.group)for(let t of this._voices)t.playingPreset===e&&t.region.group===r.group?t.endQuick(this.outSampleRate):-1!==t.playingPreset||n||(n=t);else for(let e of this._voices)-1===e.playingPreset&&(n=e);if(!n){for(let e=0;e<4;e++){let e=new ra;e.playingPreset=-1,this._voices.push(e)}n=this._voices[this._voices.length-4]}n.region=r,n.playingPreset=e,n.playingKey=t,n.playIndex=a,n.noteGainDb=this.globalGainDb-r.attenuation-a7.gainToDecibels(1/i),this._channels?this._channels.setupVoice(this,n):(n.calcPitchRatio(0,this.outSampleRate),n.panFactorLeft=Math.sqrt(.5-r.pan),n.panFactorRight=Math.sqrt(.5+r.pan)),n.sourceSamplePosition=r.offset;let o=r.loopMode!==tQ.None&&r.loopStart<r.loopEnd;n.loopStart=o?r.loopStart:0,n.loopEnd=o?r.loopEnd:0,n.ampEnv.setup(r.ampEnv,t,s,!0,this.outSampleRate),n.modEnv.setup(r.modEnv,t,s,!1,this.outSampleRate);let l=r.initialFilterQ/10;n.lowPass.qInv=1/Math.pow(10,l/20),n.lowPass.z1=0,n.lowPass.z2=0,n.lowPass.active=r.initialFilterFc<=13500,n.lowPass.active&&n.lowPass.setup(a7.cents2Hertz(r.initialFilterFc)/this.outSampleRate),n.modLfo.setup(r.delayModLFO,r.freqModLFO,this.outSampleRate),n.vibLfo.setup(r.delayVibLFO,r.freqVibLFO,this.outSampleRate)}}bankNoteOn(e,t,i,s){let a=this.getPresetIndex(e,t);return -1!==a&&(this.noteOn(a,i,s),!0)}noteOff(e,t){let i=null,s=null,a=[];for(let r of this._voices)r.playingPreset!==e||r.playingKey!==t||r.ampEnv.segment>=t1.Release||(!i||r.playIndex<i.playIndex?(i=r,s=r,a.push(r)):r.playIndex===i.playIndex&&(s=r,a.push(r)));if(i)for(let r of a)r!==i&&r!==s&&(r.playIndex!==i.playIndex||r.playingPreset!==e||r.playingKey!==t||r.ampEnv.segment>=t1.Release)||r.end(this.outSampleRate)}bankNoteOff(e,t,i){let s=this.getPresetIndex(e,t);return -1!==s&&(this.noteOff(s,i),!0)}noteOffAll(e){for(let t of this._voices)-1!==t.playingPreset&&(e?t.endQuick(this.outSampleRate):t.ampEnv.segment<t1.Release&&t.end(this.outSampleRate))}get activeVoiceCount(){let e=0;for(let t of this._voices)-1!==t.playingPreset&&e++;return e}channelInit(e){if(this._channels&&e<this._channels.channelList.length)return this._channels.channelList[e];this._channels||(this._channels=new a6);for(let t=this._channels.channelList.length;t<=e;t++){let e=new a4;e.presetIndex=0,e.bank=0,e.pitchWheel=8192,e.midiPan=8192,e.midiVolume=16383,e.midiExpression=16383,e.midiRpn=65535,e.midiData=0,e.panOffset=0,e.gainDb=0,e.pitchRange=2,e.tuning=0,e.mixVolume=1,this._channels.channelList.push(e)}return this._channels.channelList[e]}getPresetIndex(e,t){if(!this.presets)return -1;for(let i=this.presets.length-1;i>=0;i--){let s=this.presets[i];if(s.presetNumber===t&&s.bank===e)return i}return -1}getPresetName(e){return this.presets?e<0||e>=this.presets.length?null:this.presets[e].name:null}bankGetPresetName(e,t){return this.getPresetName(this.getPresetIndex(e,t))}channelNoteOn(e,t,i){this._channels&&!(e>this._channels.channelList.length)&&(this._transpositionPitches.has(e)&&(t+=this._transpositionPitches.get(e)),this._liveTranspositionPitches.has(e)&&(t+=this._liveTranspositionPitches.get(e)),this._channels.activeChannel=e,this.noteOn(this._channels.channelList[e].presetIndex,t,i))}channelNoteOff(e,t){this._transpositionPitches.has(e)&&(t+=this._transpositionPitches.get(e)),this._liveTranspositionPitches.has(e)&&(t+=this._liveTranspositionPitches.get(e));let i=[],s=null,a=null;for(let r of this._voices)-1===r.playingPreset||r.playingChannel!==e||r.playingKey!==t||r.ampEnv.segment>=t1.Release||(!s||r.playIndex<s.playIndex?(s=r,a=r,i.push(r)):r.playIndex===s.playIndex&&(a=r,i.push(r)));if(this.channelInit(e).perNotePitchWheel.delete(t),s)for(let r of i)r!==s&&r!==a&&(r.playIndex!==s.playIndex||-1===r.playingPreset||r.playingChannel!==e||r.playingKey!==t||r.ampEnv.segment>=t1.Release)||r.end(this.outSampleRate)}channelNoteOffAll(e){for(let t of(this.channelInit(e).perNotePitchWheel.clear(),this._voices))-1!==t.playingPreset&&t.playingChannel===e&&t.ampEnv.segment<t1.Release&&t.end(this.outSampleRate)}channelSoundsOffAll(e){for(let t of(this.channelInit(e).perNotePitchWheel.clear(),this._voices))-1!==t.playingPreset&&t.playingChannel===e&&(t.ampEnv.segment<t1.Release||0===t.ampEnv.parameters.release)&&t.endQuick(this.outSampleRate)}channelSetPresetIndex(e,t){this.channelInit(e).presetIndex=sl.int32ToUint16(t)}channelSetPresetNumber(e,t,i=!1){let s=this.channelInit(e),a=0;return i?(-1===(a=this.getPresetIndex(128|32767&s.bank,t))&&(a=this.getPresetIndex(128,t)),-1===a&&(a=this.getPresetIndex(128,0)),-1===a&&(a=this.getPresetIndex(2047&s.bank,t))):a=this.getPresetIndex(2047&s.bank,t),s.presetIndex=a,-1!==a}channelSetBank(e,t){this.channelInit(e).bank=sl.int32ToUint16(t)}channelSetBankPreset(e,t,i){let s=this.channelInit(e),a=this.getPresetIndex(t,i);return -1!==a&&(s.presetIndex=sl.int32ToUint16(a),s.bank=sl.int32ToUint16(t),!0)}channelSetPan(e,t){for(let i of this._voices)if(i.playingChannel===e&&-1!==i.playingPreset){let e=i.region.pan+t-.5;e<=-.5?(i.panFactorLeft=1,i.panFactorRight=0):e>=.5?(i.panFactorLeft=0,i.panFactorRight=1):(i.panFactorLeft=Math.sqrt(.5-e),i.panFactorRight=Math.sqrt(.5+e))}this.channelInit(e).panOffset=t-.5}channelSetVolume(e,t){let i=this.channelInit(e),s=a7.gainToDecibels(t),a=s-i.gainDb;if(0!==a){for(let t of this._voices)t.playingChannel===e&&-1!==t.playingPreset&&(t.noteGainDb+=a);i.gainDb=s}}channelSetPitchWheel(e,t){let i=this.channelInit(e);i.pitchWheel!==t&&(i.pitchWheel=sl.int32ToUint16(t),this.channelApplyPitch(e,i))}channelSetPerNotePitchWheel(e,t,i){this._transpositionPitches.has(e)&&(t+=this._transpositionPitches.get(e)),this._liveTranspositionPitches.has(e)&&(t+=this._liveTranspositionPitches.get(e));let s=this.channelInit(e);s.perNotePitchWheel.has(t)&&s.perNotePitchWheel.get(t)===i||(s.perNotePitchWheel.set(t,i),this.channelApplyPitch(e,s,t))}channelApplyPitch(e,t,i=-1){for(let s of this._voices)s.playingChannel===e&&-1!==s.playingPreset&&(-1===i||s.playingKey===i)&&s.updatePitchRatio(t,this.outSampleRate)}channelSetPitchRange(e,t){let i=this.channelInit(e);i.pitchRange!==t&&(i.pitchRange=t,8192!==i.pitchWheel&&this.channelApplyPitch(e,i))}channelSetTuning(e,t){let i=this.channelInit(e);i.tuning!==t&&(i.tuning=t,this.channelApplyPitch(e,i))}channelMidiControl(e,t,i){let s=this.channelInit(e);switch(t){case t2.DataEntryFine:s.midiData=sl.int32ToUint16(16256&s.midiData|i),0===s.midiRpn?this.channelSetPitchRange(e,(s.midiData>>7)+.01*(127&s.midiData)):1===s.midiRpn?this.channelSetTuning(e,(0|s.tuning)+(s.midiData-8192)/8192):2===s.midiRpn&&this.channelSetTuning(e,i-64+(s.tuning-(0|s.tuning)));return;case t2.VolumeCoarse:s.midiVolume=sl.int32ToUint16(127&s.midiVolume|i<<7),this.channelSetVolume(e,Math.pow(s.midiVolume/16383*(s.midiExpression/16383),3));return;case t2.VolumeFine:s.midiVolume=sl.int32ToUint16(16256&s.midiVolume|i),this.channelSetVolume(e,Math.pow(s.midiVolume/16383*(s.midiExpression/16383),3));return;case t2.ExpressionControllerCoarse:s.midiExpression=sl.int32ToUint16(127&s.midiExpression|i<<7),this.channelSetVolume(e,Math.pow(s.midiVolume/16383*(s.midiExpression/16383),3));return;case t2.ExpressionControllerFine:s.midiExpression=sl.int32ToUint16(16256&s.midiExpression|i),this.channelSetVolume(e,Math.pow(s.midiVolume/16383*(s.midiExpression/16383),3));return;case t2.PanCoarse:s.midiPan=sl.int32ToUint16(127&s.midiPan|i<<7),this.channelSetPan(e,s.midiPan/16383);return;case t2.PanFine:s.midiPan=sl.int32ToUint16(16256&s.midiPan|i),this.channelSetPan(e,s.midiPan/16383);return;case t2.DataEntryCoarse:s.midiData=sl.int32ToUint16(127&s.midiData|i<<7),0===s.midiRpn?this.channelSetPitchRange(e,(s.midiData>>7)+.01*(127&s.midiData)):1===s.midiRpn?this.channelSetTuning(e,(0|s.tuning)+(s.midiData-8192)/8192):2===s.midiRpn&&t===t2.DataEntryCoarse&&this.channelSetTuning(e,i-64+(s.tuning-(0|s.tuning)));return;case t2.BankSelectCoarse:s.bank=sl.int32ToUint16(32768|i);return;case t2.BankSelectFine:s.bank=sl.int32ToUint16(((32768&s.bank)!=0?(127&s.bank)<<7:0)|i);return;case t2.RegisteredParameterCourse:s.midiRpn=sl.int32ToUint16((65535===s.midiRpn?0:s.midiRpn)&127|i<<7);return;case t2.RegisteredParameterFine:s.midiRpn=sl.int32ToUint16((65535===s.midiRpn?0:s.midiRpn)&16256|i);return;case t2.NonRegisteredParameterFine:case t2.NonRegisteredParameterCourse:s.midiRpn=65535;return;case t2.AllSoundOff:this.channelSoundsOffAll(e);return;case t2.AllNotesOff:this.channelNoteOffAll(e);return;case t2.ResetControllers:s.midiVolume=16383,s.midiExpression=16383,s.midiPan=8192,s.bank=0,this.channelSetVolume(e,1),this.channelSetPan(e,.5),this.channelSetPitchRange(e,2);return}}channelGetPresetIndex(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].presetIndex:0}channelGetPresetBank(e){return this._channels&&e<this._channels.channelList.length?32767&this._channels.channelList[e].bank:0}channelGetPan(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].panOffset-.5:.5}channelGetVolume(e){return this._channels&&e<this._channels.channelList.length?a7.decibelsToGain(this._channels.channelList[e].gainDb):1}channelGetPitchWheel(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].pitchWheel:8192}channelGetPitchRange(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].pitchRange:2}channelGetTuning(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].tuning:0}resetPresets(){this.presets=[]}loadPresets(e,t,i,s){let a=[];for(let s=0;s<e.phdrs.length-1;s++){let r=e.phdrs[s],n=0,o=new a8;a.push(o),o.name=r.presetName,o.bank=r.bank,o.presetNumber=r.preset;let l=0;for(let t=r.presetBagNdx;t<e.phdrs[s+1].presetBagNdx;t++){let i=e.pbags[t],s=0,a=127,r=0,n=127;for(let o=i.genNdx;o<e.pbags[t+1].genNdx;o++){let t=e.pgens[o];if(t.genOper===a0.GenKeyRange){s=t.genAmount.lowByteAmount,a=t.genAmount.highByteAmount;continue}if(t.genOper===a0.GenVelRange){r=t.genAmount.lowByteAmount,n=t.genAmount.highByteAmount;continue}if(t.genOper!==a0.GenInstrument||t.genAmount.wordAmount>=e.insts.length)continue;let i=e.insts[t.genAmount.wordAmount];for(let o=i.instBagNdx;o<e.insts[t.genAmount.wordAmount+1].instBagNdx;o++){let t=e.ibags[o],i=0,h=127,d=0,c=127;for(let u=t.instGenNdx;u<e.ibags[o+1].instGenNdx;u++){let t=e.igens[u];if(t.genOper===a0.GenKeyRange){i=t.genAmount.lowByteAmount,h=t.genAmount.highByteAmount;continue}if(t.genOper===a0.GenVelRange){d=t.genAmount.lowByteAmount,c=t.genAmount.highByteAmount;continue}53===t.genOper&&h>=s&&i<=a&&c>=r&&d<=n&&l++}}}}o.regions=Array(l);let h=new re;h.clear(!0);for(let a=r.presetBagNdx;a<e.phdrs[s+1].presetBagNdx;a++){let s=e.pbags[a],l=new re(h),d=!1;for(let h=s.genNdx;h<e.pbags[a+1].genNdx;h++){let s=e.pgens[h];if(s.genOper===a0.GenInstrument){let a=s.genAmount.wordAmount;if(a>=e.insts.length)continue;let h=new re;h.clear(!1);let c=e.insts[a];for(let s=c.instBagNdx;s<e.insts[a+1].instBagNdx;s++){let a=e.ibags[s],d=new re(h),u=!1;for(let h=a.instGenNdx;h<e.ibags[s+1].instGenNdx;h++){let s=e.igens[h];if(s.genOper===a0.GenSampleId){if(d.hiKey<l.loKey||d.loKey>l.hiKey||d.hiVel<l.loVel||d.loVel>l.hiVel)continue;l.loKey>d.loKey&&(d.loKey=l.loKey),l.hiKey<d.hiKey&&(d.hiKey=l.hiKey),l.loVel>d.loVel&&(d.loVel=l.loVel),l.hiVel<d.hiVel&&(d.hiVel=l.hiVel),d.offset+=l.offset,d.end+=l.end,d.loopStart+=l.loopStart,d.loopEnd+=l.loopEnd,d.transpose+=l.transpose,d.tune+=l.tune,d.pitchKeyTrack+=l.pitchKeyTrack,d.attenuation+=l.attenuation,d.pan+=l.pan,d.ampEnv.delay+=l.ampEnv.delay,d.ampEnv.attack+=l.ampEnv.attack,d.ampEnv.hold+=l.ampEnv.hold,d.ampEnv.decay+=l.ampEnv.decay,d.ampEnv.sustain+=l.ampEnv.sustain,d.ampEnv.release+=l.ampEnv.release,d.modEnv.delay+=l.modEnv.delay,d.modEnv.attack+=l.modEnv.attack,d.modEnv.hold+=l.modEnv.hold,d.modEnv.decay+=l.modEnv.decay,d.modEnv.sustain+=l.modEnv.sustain,d.modEnv.release+=l.modEnv.release,d.initialFilterQ+=l.initialFilterQ,d.initialFilterFc+=l.initialFilterFc,d.modEnvToPitch+=l.modEnvToPitch,d.modEnvToFilterFc+=l.modEnvToFilterFc,d.delayModLFO+=l.delayModLFO,d.freqModLFO+=l.freqModLFO,d.modLfoToPitch+=l.modLfoToPitch,d.modLfoToFilterFc+=l.modLfoToFilterFc,d.modLfoToVolume+=l.modLfoToVolume,d.delayVibLFO+=l.delayVibLFO,d.freqVibLFO+=l.freqVibLFO,d.vibLfoToPitch+=l.vibLfoToPitch,d.ampEnv.envToSecs(!0),d.modEnv.envToSecs(!1),d.delayModLFO=d.delayModLFO<-11950?0:a7.timecents2Secs(d.delayModLFO),d.delayVibLFO=d.delayVibLFO<-11950?0:a7.timecents2Secs(d.delayVibLFO),d.pan<-.5?d.pan=-.5:d.pan>.5&&(d.pan=.5),(d.initialFilterQ<1500||d.initialFilterQ>13500)&&(d.initialFilterQ=0);let a=e.sHdrs[s.genAmount.wordAmount];d.offset+=a.start,d.end+=a.end,d.loopStart+=a.startLoop,d.loopEnd+=a.endLoop,a.endLoop>0&&(d.loopEnd-=1),-1===d.pitchKeyCenter&&(d.pitchKeyCenter=a.originalPitch),d.tune+=a.pitchCorrection,d.sampleRate=a.sampleRate;let h=r.bank===iI.PercussionBank;h&&ro.setContainsRange(i,d.loKey,d.hiKey)||!h&&t.has(r.preset)?(1&a.sampleType)!=0?(iM.debug("AlphaSynth",`Loading of used sample ${a.sampleName} for preset ${r.presetName} (bank ${o.bank} program ${o.presetNumber})`),(16&a.sampleType)!=0?d.samples=e.decodeSamples(a.start,a.end,!0):(d.samples=e.decodeSamples(2*d.offset,2*d.end,!1),d.loopStart>0&&(d.loopStart-=d.offset),d.loopEnd>0&&(d.loopEnd-=d.offset)),d.offset=0,d.end=d.samples.length-1):(iM.warning("AlphaSynth",`Skipping load of unsupported sample ${a.sampleName} for preset ${r.presetName}, sample type ${a.sampleType} is not supported (bank ${o.bank} program ${o.presetNumber})`),d.samples=new Float32Array(0)):(iM.debug("AlphaSynth",`Skipping load of unused sample ${a.sampleName} for preset ${r.presetName} (bank ${o.bank} program ${o.presetNumber})`),d.samples=new Float32Array(0)),o.regions[n]=new re(d),n++,u=!0}else d.operator(s.genOper,s.genAmount)}a!==e.ibags[c.instBagNdx]||u||(h=new re(d))}d=!0}else l.operator(s.genOper,s.genAmount)}s!==e.pbags[r.presetBagNdx]||d||(h=l)}}if(s&&this.presets)for(let e of a)this.presets.push(e);else this.presets=a}static setContainsRange(e,t,i){for(let s=t;s<=i;s++)if(e.has(s))return!0;return!1}hasSamplesForProgram(e){let t=this.presets;if(!t)return!1;for(let i of t)if(i.presetNumber===e){for(let e of i.regions)if(e.samples.length>0)return!0}return!1}hasSamplesForPercussion(e){let t=this.presets;if(!t)return!1;for(let i of t)if(i.bank===iI.PercussionBank){for(let t of i.regions)if(t.loKey>=e&&t.hiKey<=e&&t.samples.length>0)return!0}return!1}}class rl{constructor(e){this._listeners=[],this._fireOnRegister=e}on(e){return this._listeners.push(e),this._fireOnRegister?.()&&e(),()=>{this.off(e)}}off(e){this._listeners=this._listeners.filter(t=>t!==e)}trigger(){for(let e of this._listeners)e()}}class rh{constructor(e){this._listeners=[],this._fireOnRegister=e}on(e){if(this._listeners.push(e),this._fireOnRegister){let t=this._fireOnRegister();null!==t&&e(t)}return()=>{this.off(e)}}off(e){this._listeners=this._listeners.filter(t=>t!==e)}trigger(e){for(let t of this._listeners)t(e)}}class rd{constructor(e){this.events=e}}class rc{constructor(e){this.playbackRange=e}}class ru{constructor(){this.sampleRate=44100,this.useSyncPoints=!1,this.masterVolume=1,this.metronomeVolume=0,this.trackVolume=new Map,this.trackTranspositionPitches=new Map}}class rp{constructor(){this.currentTime=0,this.endTime=0,this.currentTick=0,this.endTick=0}}class rm{get output(){return this._output}get isReadyForPlayback(){return this.isReady&&this.isSoundFontLoaded&&this._isMidiLoaded}get logLevel(){return iM.logLevel}set logLevel(e){iM.logLevel=e}get masterVolume(){return this.synthesizer.masterVolume}set masterVolume(e){e=Math.max(e,iI.MinVolume),this.updateMasterVolume(e)}updateMasterVolume(e){this.synthesizer.masterVolume=e}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Math.max(e,iI.MinVolume),this._metronomeVolume=e,this.synthesizer.metronomeVolume=e}get countInVolume(){return this._countInVolume}set countInVolume(e){e=Math.max(e,iI.MinVolume),this._countInVolume=e}get midiEventsPlayedFilter(){return Array.from(this._midiEventsPlayedFilter)}set midiEventsPlayedFilter(e){this._midiEventsPlayedFilter=new Set(e)}get playbackSpeed(){return this.sequencer.playbackSpeed}set playbackSpeed(e){e=iW.clamp(e,iI.MinPlaybackSpeed,iI.MaxPlaybackSpeed),this.updatePlaybackSpeed(e)}updatePlaybackSpeed(e){let t=this.sequencer.playbackSpeed;this.sequencer.playbackSpeed=e,this.timePosition=this.timePosition*(t/e)}get loadedMidiInfo(){return this._loadedMidiInfo}get currentPosition(){return this._currentPosition}get tickPosition(){return this._tickPosition}set tickPosition(e){this.timePosition=this.sequencer.mainTickPositionToTimePosition(e)}get timePosition(){return this._timePosition}set timePosition(e){iM.debug("AlphaSynth",`Seeking to position ${e}ms (main)`),this.sequencer.mainSeek(e),this.updateTimePosition(e,!0),this.sequencer.isPlayingMain&&(this._notPlayedSamples=0,this.output.resetSamples())}get playbackRange(){return this.sequencer.mainPlaybackRange}set playbackRange(e){this.sequencer.mainPlaybackRange=e,e&&(this.tickPosition=e.startTick),this.playbackRangeChanged.trigger(new rc(e))}get isLooping(){return this.sequencer.isLooping}set isLooping(e){this.sequencer.isLooping=e}destroy(){iM.debug("AlphaSynth","Destroying player"),this.stop(),this.output.destroy()}constructor(e,t,i){this.isSoundFontLoaded=!1,this._isMidiLoaded=!1,this._tickPosition=0,this._timePosition=0,this._metronomeVolume=0,this._countInVolume=0,this._playedEventsQueue=new rn,this._midiEventsPlayedFilter=new Set,this._notPlayedSamples=0,this._synthStopping=!1,this._currentPosition=new ap(0,0,0,0,!1,120,120),this.isReady=!1,this.state=t$.Paused,this._loadedSoundFonts=[],this.readyForPlayback=new rl,this.finished=new rl,this.soundFontLoaded=new rl,this.soundFontLoadFailed=new rh,this.midiLoadFailed=new rh,this.midiEventsPlayed=new rh,iM.debug("AlphaSynth","Initializing player"),this.state=t$.Paused,this.ready=new rl(()=>this.isReady),this.readyForPlayback=new rl(()=>this.isReadyForPlayback),this.midiLoaded=new rh(()=>this._loadedMidiInfo?this._loadedMidiInfo:null),this.stateChanged=new rh(()=>new au(this.state,!1)),this.positionChanged=new rh(()=>this._currentPosition),this.playbackRangeChanged=new rh(()=>this.playbackRange?new rc(this.playbackRange):null),iM.debug("AlphaSynth","Creating output"),this._output=e,iM.debug("AlphaSynth","Creating synthesizer"),this.synthesizer=t,this.sequencer=new ac(this.synthesizer),iM.debug("AlphaSynth","Opening output"),this.output.ready.on(()=>{this.isReady=!0,this.ready.trigger(),this.checkReadyForPlayback()}),this.output.sampleRequest.on(()=>{this.onSampleRequest()}),this.output.samplesPlayed.on(this.onSamplesPlayed.bind(this)),this.output.open(i)}onSampleRequest(){if(this.state===t$.Playing&&(!this.sequencer.isFinished||this.synthesizer.activeVoiceCount>0)){let e=new Float32Array(iI.MicroBufferSize*iI.MicroBufferCount*iI.AudioChannels),t=0;for(let i=0;i<iI.MicroBufferCount;i++){this.sequencer.fillMidiEventQueue();let i=this.synthesizer.synthesize(e,t,iI.MicroBufferSize);for(let e of(t+=iI.MicroBufferSize*iI.AudioChannels,i))this._midiEventsPlayedFilter.has(e.event.type)&&this._playedEventsQueue.enqueue(e);if(this.sequencer.isFinished)break}t<e.length&&(e=e.subarray(0,t)),this._notPlayedSamples+=e.length,this.output.addSamples(e)}else{let e=new Float32Array(0);this.output.addSamples(e)}}play(){return this.state===t$.Paused&&!!this._isMidiLoaded&&(this.output.activate(),this.playInternal(),this._countInVolume>0&&(iM.debug("AlphaSynth","Starting countin"),this.sequencer.startCountIn(),this.synthesizer.setupMetronomeChannel(this._countInVolume),this.updateTimePosition(0,!0)),this.output.play(),!0)}playInternal(){this.sequencer.isPlayingOneTimeMidi&&(iM.debug("AlphaSynth","Cancelling one time midi"),this.stopOneTimeMidi()),iM.debug("AlphaSynth","Starting playback"),this.synthesizer.setupMetronomeChannel(this.metronomeVolume),this._synthStopping=!1,this.state=t$.Playing,this.stateChanged.trigger(new au(this.state,!1))}pause(){this.state!==t$.Paused&&this._isMidiLoaded&&(iM.debug("AlphaSynth","Pausing playback"),this.state=t$.Paused,this.stateChanged.trigger(new au(this.state,!1)),this.output.pause(),this.synthesizer.noteOffAll(!1))}playPause(){this.state===t$.Paused&&this._isMidiLoaded?this.play():this.pause()}stop(){this._isMidiLoaded&&(iM.debug("AlphaSynth","Stopping playback"),this.state=t$.Paused,this.output.pause(),this._notPlayedSamples=0,this.sequencer.stop(),this.synthesizer.noteOffAll(!0),this.tickPosition=this.sequencer.mainPlaybackRange?this.sequencer.mainPlaybackRange.startTick:0,this.stateChanged.trigger(new au(this.state,!0)))}playOneTimeMidiFile(e){this.sequencer.isPlayingOneTimeMidi?this.stopOneTimeMidi():this.pause(),this.sequencer.loadOneTimeMidi(e),this.synthesizer.noteOffAll(!0),this.updateTimePosition(0,!0),this._notPlayedSamples=0,this.output.resetSamples(),this.output.play()}resetSoundFonts(){this.stop(),this.synthesizer.resetPresets(),this._loadedSoundFonts=[],this.isSoundFontLoaded=!1,this.soundFontLoaded.trigger()}loadSoundFont(e,t){this.pause();let i=sd.fromBuffer(e);try{iM.debug("AlphaSynth","Loading soundfont from bytes");let e=new aq;e.load(i),t||(this._loadedSoundFonts=[]),this._loadedSoundFonts.push(e),this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger(),iM.debug("AlphaSynth","soundFont successfully loaded"),this.checkReadyForPlayback()}catch(e){iM.error("AlphaSynth",`Could not load soundfont from bytes ${e}`),this.soundFontLoadFailed.trigger(e)}}checkReadyForPlayback(){if(this.isReadyForPlayback){this.synthesizer.setupMetronomeChannel(this.metronomeVolume);let e=this.sequencer.instrumentPrograms,t=this.sequencer.percussionKeys,i=!1;for(let s of this._loadedSoundFonts)this.synthesizer.loadPresets(s,e,t,i),i=!0;this.readyForPlayback.trigger()}}loadMidiFile(e){this.stop();try{iM.debug("AlphaSynth","Loading midi from model"),this.sequencer.loadMidi(e),this._isMidiLoaded=!0,this._loadedMidiInfo=new ap(0,this.sequencer.currentEndTime,0,this.sequencer.currentEndTick,!1,this.sequencer.currentTempo,this.sequencer.modifiedTempo),this.midiLoaded.trigger(this._loadedMidiInfo),iM.debug("AlphaSynth","Midi successfully loaded"),this.checkReadyForPlayback(),this.tickPosition=0}catch(e){iM.error("AlphaSynth",`Could not load midi from model ${e}`),this.midiLoadFailed.trigger(e)}}applyTranspositionPitches(e){this.synthesizer.applyTranspositionPitches(e)}setChannelTranspositionPitch(e,t){this.synthesizer.setChannelTranspositionPitch(e,t)}setChannelMute(e,t){this.synthesizer.channelSetMute(e,t)}resetChannelStates(){this.synthesizer.resetChannelStates()}setChannelSolo(e,t){this.synthesizer.channelSetSolo(e,t)}setChannelVolume(e,t){t=Math.max(t,iI.MinVolume),this.synthesizer.channelSetMixVolume(e,t)}onSamplesPlayed(e){if(0===e)return;let t=e/this.synthesizer.outSampleRate*1e3;this._notPlayedSamples-=e*iI.AudioChannels,this.updateTimePosition(this._timePosition+t,!1),this.checkForFinish()}checkForFinish(){let e=0,t=0;this.playbackRange&&this.sequencer.isPlayingMain?(e=this.playbackRange.startTick,t=this.playbackRange.endTick):t=this.sequencer.currentEndTick,this._tickPosition>=t&&(this._notPlayedSamples<=0?(this._notPlayedSamples=0,this.sequencer.isPlayingCountIn?(iM.debug("AlphaSynth","Finished playback (count-in)"),this.sequencer.resetCountIn(),this.timePosition=this.sequencer.currentTime,this.playInternal(),this.output.resetSamples()):this.sequencer.isPlayingOneTimeMidi?(iM.debug("AlphaSynth","Finished playback (one time)"),this.output.resetSamples(),this.state=t$.Paused,this.stopOneTimeMidi()):this.isLooping?(iM.debug("AlphaSynth","Finished playback (main looping)"),this.finished.trigger(),this.tickPosition=e,this._synthStopping=!1):this.synthesizer.activeVoiceCount>0?this._synthStopping||(iM.debug("AlphaSynth","Signaling synth to stop all voices (all samples played)"),this.synthesizer.noteOffAll(!0),this._synthStopping=!0):(this._synthStopping=!1,iM.debug("AlphaSynth","Finished playback (main)"),this.finished.trigger(),this.stop())):this._synthStopping||(iM.debug("AlphaSynth","Signaling synth to stop all voices (not all samples played)"),this.synthesizer.noteOffAll(!0),this._synthStopping=!0))}stopOneTimeMidi(){this.output.pause(),this.synthesizer.noteOffAll(!0),this.sequencer.resetOneTimeMidi(),this.timePosition=this.sequencer.currentTime}createPositionChangedEventArgs(e){let t=this._timePosition,i=this.sequencer.currentTimePositionToTickPosition(t),s=this.sequencer.currentEndTime,a=this.sequencer.currentEndTick;return t>s&&(t=s,i=a),new ap(t,s,i,a,e,this.sequencer.currentTempo,this.sequencer.modifiedTempo)}updateTimePosition(e,t){this._timePosition=e;let i=this.createPositionChangedEventArgs(t);this._tickPosition=i.currentTick;let s=this.sequencer.isPlayingMain?"main":this.sequencer.isPlayingCountIn?"count-in":"one-time";if(iM.debug("AlphaSynth",`Position changed: (time: ${i.currentTime}/${i.endTime}, tick: ${i.currentTick}/${i.endTick}, Active Voices: ${this.synthesizer.activeVoiceCount} (${s}), Tempo original: ${this.sequencer.currentTempo}, Tempo modified: ${this.sequencer.modifiedTempo})`),this.sequencer.isPlayingMain&&(this._currentPosition=i,this.positionChanged.trigger(i)),t)this._playedEventsQueue.clear();else{let e=[];for(;!this._playedEventsQueue.isEmpty&&this._playedEventsQueue.peek().time<i.currentTime;){let t=this._playedEventsQueue.dequeue();e.push(t.event)}e.length>0&&(e.reverse(),this.midiEventsPlayed.trigger(new rd(e)))}}hasSamplesForProgram(e){return this.synthesizer.hasSamplesForProgram(e)}hasSamplesForPercussion(e){return this.synthesizer.hasSamplesForPercussion(e)}loadBackingTrack(e){}updateSyncPoints(e){}}class rg extends rm{constructor(e,t){super(e,new ro(e.sampleRate),t)}exportAudio(e,t,i,s){let a=new rf(e);for(let[r,n]of(a.loadMidiFile(t),e.useSyncPoints&&a.updateSyncPoints(i),a.applyTranspositionPitches(s),e.trackTranspositionPitches))a.setChannelTranspositionPitch(r,n);for(let[t,i]of e.trackVolume)a.channelSetMixVolume(t,i);if(e.soundFonts)for(let t of e.soundFonts)a.loadSoundFont(t);else a.loadPresets(this.synthesizer.presets);return e.playbackRange&&a.limitExport(e.playbackRange),a.setup(),a}}class rf{constructor(e){this._generatedAudioCurrentTime=0,this._generatedAudioEndTime=0,this._synth=new ro(e.sampleRate),this._sequencer=new ac(this._synth),this._synth.masterVolume=Math.max(e.masterVolume,iI.MinVolume),this._synth.metronomeVolume=Math.max(e.metronomeVolume,iI.MinVolume)}loadSoundFont(e){let t=sd.fromBuffer(e),i=new aq;i.load(t);let s=this._sequencer.instrumentPrograms,a=this._sequencer.percussionKeys;this._synth.loadPresets(i,s,a,!0)}loadPresets(e){this._synth.presets=e}limitExport(e){this._sequencer.mainPlaybackRange=e,this._sequencer.mainSeek(this._sequencer.mainTickPositionToTimePosition(e.startTick))}setChannelTranspositionPitch(e,t){this._synth.setChannelTranspositionPitch(e,t)}applyTranspositionPitches(e){this._synth.applyTranspositionPitches(e)}loadMidiFile(e){this._sequencer.loadMidi(e)}updateSyncPoints(e){this._sequencer.mainUpdateSyncPoints(e)}channelSetMixVolume(e,t){t=Math.max(t,iI.MinVolume),this._synth.channelSetMixVolume(e,t)}setup(){this._synth.setupMetronomeChannel(this._synth.metronomeVolume);let e=this._sequencer.currentSyncPoints,t=this._sequencer.currentEndTime;if(0===e.length)this._generatedAudioEndTime=t;else{let t=e[e.length-1],i=t.syncTime,s=this._sequencer.currentEndTick-t.synthTick;s>0&&(i+=ix.ticksToMillis(s,t.syncBpm)),this._generatedAudioEndTime=i}}render(e){if(this._sequencer.isFinished)return;let t=1e3*iI.MicroBufferSize/this._synth.outSampleRate,i=Math.ceil(e/t),s=new Float32Array(iI.MicroBufferSize*i*iI.AudioChannels),a=this._sequencer.currentSyncPoints,r=0,n=this._generatedAudioCurrentTime;for(let e=0;e<i;e++){if(a.length>0){this._sequencer.currentUpdateSyncPoints(n),this._sequencer.currentUpdateCurrentTempo(this._sequencer.currentTime);let e=this._sequencer.syncPointTempo/this._sequencer.currentTempo;this._sequencer.playbackSpeed!==e&&(this._sequencer.playbackSpeed=e)}if(this._sequencer.fillMidiEventQueue(),this._synth.synthesize(s,r,iI.MicroBufferSize),r+=iI.MicroBufferSize*iI.AudioChannels,n+=t,this._sequencer.playbackSpeed,this._sequencer.isFinished)break}r<s.length&&(s=s.subarray(0,r));let o=new rp;return o.currentTime=this._generatedAudioCurrentTime,o.endTime=this._generatedAudioEndTime,o.currentTick=this._sequencer.currentTimePositionToTickPosition(this._sequencer.currentTime),o.endTick=this._sequencer.currentEndTick,this._generatedAudioCurrentTime+=e,o.samples=s,this._sequencer.isFinished&&this._synth.noteOffAll(!0),o}}class ry{static parseEnum(e,t){switch(typeof e){case"string":let i=Number.parseInt(e);return Number.isNaN(i)?t[Object.keys(t).find(t=>t.toLowerCase()===e.toLowerCase())]:i;case"number":return e;case"undefined":case"object":return}throw new i6(tE.Format,`Could not parse enum value '${e}'`)}static forEach(e,t){if(e instanceof Map)e.forEach(t);else if("object"==typeof e)for(let i in e)t(e[i],i)}static getValue(e,t){return e instanceof Map?e.get(t):"object"==typeof e?e[t]:null}}class rb{constructor(e,t,i){this.text=e,this.startPos=t,this.endPos=i}}class rS{constructor(e){this.style="normal",this.variant="normal",this.weight="normal",this.stretch="normal",this.lineHeight="normal",this.size="1rem",this.families=[],this.parseOnlyFamilies=!1,this._currentTokenIndex=-1,this._input="",this._currentToken=null,this._input=e,this._tokens=this.splitToTokens(e)}splitToTokens(e){let t=[],i=0;for(;i<e.length;){let s=i;for(;s<e.length&&" "!==e.charAt(s);)s++;s>i&&t.push(new rb(e.substring(i,s),i,s)),i=s+1}return t}parse(){if(this.reset(),1===this._tokens.length)switch(this._currentToken?.text){case"caption":case"icon":case"menu":case"message-box":case"small-caption":case"status-bar":case"inherit":return}this.parseOnlyFamilies||(this.fontStyleVariantWeight(),this.fontSizeLineHeight()),this.fontFamily()}static parseFamilies(e){let t=new rS(e);return t.parseOnlyFamilies=!0,t.parse(),t.families}fontFamily(){if(!this._currentToken){if(this.parseOnlyFamilies)return;throw Error("Missing font list")}let e=this._input.substr(this._currentToken.startPos).trim(),t=0;for(;t<e.length;){let i=e.charAt(t);if(" "===i||","===i)t++;else if('"'===i||"'"===i){let s=this.findEndOfQuote(e,t+1,i);this.families.push(e.substring(t+1,s).split(`\\${i}`).join(i)),t=s+1}else{let i=this.findEndOfQuote(e,t+1,",");this.families.push(e.substring(t,i).trim()),t=i+1}}}findEndOfQuote(e,t,i){let s=!1;for(;t<e.length;){let a=e.charAt(t);if(!s&&a===i)return t;s=!s&&"\\"===a,t+=1}return e.length}fontSizeLineHeight(){if(!this._currentToken)throw Error("Missing font size");let e=this._currentToken.text.split("/");if(e.length>=3)throw Error(`Invalid font size '${this._currentToken}' specified`);if(this.nextToken(),e.length>=2)if("/"===e[1]){if(!this._currentToken)throw Error("Missing line-height after font size");this.lineHeight=this._currentToken.text,this.nextToken()}else this.size=e[0],this.lineHeight=e[1];else if(e.length>=1){if(this.size=e[0],this._currentToken&&0===this._currentToken.text.indexOf("/"))if("/"===this._currentToken.text){if(this.nextToken(),!this._currentToken)throw Error("Missing line-height after font size");this.lineHeight=this._currentToken.text,this.nextToken()}else this.lineHeight=this._currentToken.text.substr(1),this.nextToken()}else throw Error("Missing font size")}nextToken(){this._currentTokenIndex++,this._currentTokenIndex<this._tokens.length?this._currentToken=this._tokens[this._currentTokenIndex]:this._currentToken=null}fontStyleVariantWeight(){let e=!1,t=!1,i=!1,s=3,a=[];for(;;){if(!this._currentToken)return;let r=this._currentToken.text;switch(r){case"normal":case"inherit":a.push(r),s--,this.nextToken();break;case"italic":case"oblique":this.style=r,e=!0,s--,this.nextToken();break;case"small-caps":this.variant=r,t=!0,s--,this.nextToken();break;case"bold":case"bolder":case"lighter":case"100":case"200":case"300":case"400":case"500":case"600":case"700":case"800":case"900":this.weight=r,i=!0,s--,this.nextToken();break;default:return}if(0===s)break}for(;a.length>0;){let s=a.pop();i?t?e||(this.style=s):this.variant=s:this.weight=s}}reset(){this._currentTokenIndex=-1,this.nextToken()}static quoteFont(e){if(-1===e.indexOf(" "))return e;let t=e.replaceAll('"','\\"');return`"${t}"`}}(eB=t5||(t5={}))[eB.Plain=0]="Plain",eB[eB.Italic=1]="Italic",(eT=t3||(t3={}))[eT.Regular=0]="Regular",eT[eT.Bold=1]="Bold";class r_{reset(){this._cssScale=0,this._css=this.toCssString()}get family(){return this._families[0]}set family(e){this.families=rS.parseFamilies(e)}get families(){return this._families}set families(e){this._families=e,this.reset()}get size(){return this._size}set size(e){this._size=e,this.reset()}get style(){return this._style}set style(e){this._style=e,this.reset()}get weight(){return this._weight}set weight(e){this._weight=e,this.reset()}get isBold(){return this.weight===t3.Bold}get isItalic(){return this.style===t5.Italic}constructor(e,t,i=t5.Plain,s=t3.Regular){this._cssScale=0,this._families=rS.parseFamilies(e),this._size=t,this._style=i,this._weight=s,this._css=this.toCssString()}withSize(e){return r_.withFamilyList(this._families,e,this._style,this._weight)}static withFamilyList(e,t,i=t5.Plain,s=t3.Regular){let a=new r_("",t,i,s);return a.families=e,a}toCssString(e=1){if(!this._css||!(.01>Math.abs(e-this._cssScale))){let t="";this.isBold&&(t+="bold "),this.isItalic&&(t+="italic "),t+=this.size*e,t+="px ",t+=this.families.map(e=>rS.quoteFont(e)).join(", "),this._css=t,this._cssScale=e}return this._css}static fromJson(e){if(e instanceof r_)return e;switch(typeof e){case"undefined":default:return;case"object":{let t=e.get("families"),i=e.get("size"),s=ry.parseEnum(e.get("style"),t5),a=ry.parseEnum(e.get("weight"),t3);return r_.withFamilyList(t,i,s,a)}case"string":{let t=new rS(e);t.parse();let i=t.families,s=t.size.toLowerCase(),a=0;switch(s){case"xx-small":a=7;break;case"x-small":a=10;break;case"small":case"smaller":a=13;break;case"medium":a=16;break;case"large":case"larger":a=18;break;case"x-large":a=24;break;case"xx-large":a=32;break;default:try{a=s.endsWith("em")?16*Number.parseFloat(s.substr(0,s.length-2)):s.endsWith("pt")?16*Number.parseFloat(s.substr(0,s.length-2))/12:s.endsWith("px")?Number.parseFloat(s.substr(0,s.length-2)):12}catch(e){a=12}}let r=t5.Plain;"italic"===t.style&&(r=t5.Italic);let n=t3.Regular;switch(t.weight.toLowerCase()){case"normal":case"lighter":break;default:n=t3.Bold}return r_.withFamilyList(i,a,r,n)}}}static toJson(e){if(!e)return;let t=new Map;return t.set("families",e.families),t.set("size",e.size),t.set("style",e.style),t.set("weight",e.weight),t}}class rw{constructor(){this.copyrightFont=new r_(rw.sansFont,12,t5.Plain,t3.Bold),this.titleFont=new r_(rw.serifFont,32,t5.Plain),this.subTitleFont=new r_(rw.serifFont,20,t5.Plain),this.wordsFont=new r_(rw.serifFont,15,t5.Plain),this.effectFont=new r_(rw.serifFont,12,t5.Italic),this.timerFont=new r_(rw.serifFont,12,t5.Plain),this.directionsFont=new r_(rw.serifFont,14,t5.Plain),this.fretboardNumberFont=new r_(rw.sansFont,11,t5.Plain),this.numberedNotationFont=new r_(rw.sansFont,16,t5.Plain),this.numberedNotationGraceFont=new r_(rw.sansFont,14,t5.Plain),this.tablatureFont=new r_(rw.sansFont,13,t5.Plain),this.graceFont=new r_(rw.sansFont,11,t5.Plain),this.staffLineColor=new si(165,165,165,255),this.barSeparatorColor=new si(34,34,17,255),this.barNumberFont=new r_(rw.sansFont,11,t5.Plain),this.barNumberColor=new si(200,0,0,255),this.fingeringFont=new r_(rw.serifFont,14,t5.Plain),this.inlineFingeringFont=new r_(rw.serifFont,12,t5.Plain),this.markerFont=new r_(rw.serifFont,14,t5.Plain,t3.Bold),this.mainGlyphColor=new si(0,0,0,255),this.secondaryGlyphColor=new si(0,0,0,100),this.scoreInfoColor=new si(0,0,0,255)}getFontForElement(e){switch(e){case tD.Title:return this.titleFont;case tD.SubTitle:case tD.Artist:case tD.Album:return this.subTitleFont;case tD.Words:case tD.Music:case tD.WordsAndMusic:case tD.Transcriber:break;case tD.Copyright:case tD.CopyrightSecondLine:return this.copyrightFont}return this.wordsFont}}rw.sansFont="Arial, sans-serif",rw.serifFont="Georgia, serif",(eN=t4||(t4={}))[eN.Automatic=0]="Automatic",eN[eN.UseModelLayout=1]="UseModelLayout";class rk{constructor(){this.scale=1,this.stretchForce=1,this.layoutMode=eX.Page,this.staveProfile=eJ.Default,this.barsPerRow=-1,this.startBar=1,this.barCount=-1,this.barCountPerPartial=10,this.justifyLastSystem=!1,this.resources=new rw,this.padding=[35,35],this.firstSystemPaddingTop=5,this.systemPaddingTop=10,this.systemPaddingBottom=20,this.lastSystemPaddingBottom=0,this.systemLabelPaddingLeft=0,this.systemLabelPaddingRight=3,this.accoladeBarPaddingRight=3,this.notationStaffPaddingTop=5,this.notationStaffPaddingBottom=5,this.effectStaffPaddingTop=0,this.effectStaffPaddingBottom=0,this.firstStaffPaddingLeft=6,this.staffPaddingLeft=2,this.systemsLayoutMode=t4.Automatic}}class rB{constructor(){this.encoding="utf-8",this.mergePartGroupsInMusicXml=!1,this.beatTextAsLyrics=!1}}(ex=t6||(t6={}))[ex.Off=0]="Off",ex[ex.Continuous=1]="Continuous",ex[ex.OffScreen=2]="OffScreen";class rT{constructor(){this.noteWideLength=240,this.noteWideAmplitude=1,this.noteSlightLength=360,this.noteSlightAmplitude=.5,this.beatWideLength=480,this.beatWideAmplitude=2,this.beatSlightLength=480,this.beatSlightAmplitude=2}}class rN{constructor(){this.simpleSlidePitchOffset=6,this.simpleSlideDurationRatio=.25,this.shiftSlideDurationRatio=.5}}(eP=t8||(t8={}))[eP.WebAudioAudioWorklets=0]="WebAudioAudioWorklets",eP[eP.WebAudioScriptProcessor=1]="WebAudioScriptProcessor",(ev=t7||(t7={}))[ev.Disabled=0]="Disabled",ev[ev.EnabledAutomatic=1]="EnabledAutomatic",ev[ev.EnabledSynthesizer=2]="EnabledSynthesizer",ev[ev.EnabledBackingTrack=3]="EnabledBackingTrack",ev[ev.EnabledExternalMedia=4]="EnabledExternalMedia";class rx{constructor(){this.soundFont=null,this.scrollElement="html,body",this.outputMode=t8.WebAudioAudioWorklets,this.enablePlayer=!1,this.playerMode=t7.Disabled,this.enableCursor=!0,this.enableAnimatedBeatCursor=!0,this.enableElementHighlighting=!0,this.enableUserInteraction=!0,this.scrollOffsetX=0,this.scrollOffsetY=0,this.scrollMode=t6.Continuous,this.scrollSpeed=300,this.nativeBrowserSmoothScroll=!0,this.songBookBendDuration=75,this.songBookDipDuration=150,this.vibrato=new rT,this.slide=new rN,this.playTripletFeel=!0,this.bufferTimeInMilliseconds=500}}class rP{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rP.setProperty(e,i.toLowerCase(),t))}static toJson(e){if(!e)return null;let t=new Map;if(t.set("scriptfile",e.scriptFile),t.set("fontdirectory",e.fontDirectory),null!==e.smuflFontSources){let i=new Map;for(let[s,a]of(t.set("smuflfontsources",i),e.smuflFontSources))i.set(s.toString(),a)}return t.set("file",e.file),t.set("tex",e.tex),t.set("tracks",e.tracks),t.set("enablelazyloading",e.enableLazyLoading),t.set("engine",e.engine),t.set("loglevel",e.logLevel),t.set("useworkers",e.useWorkers),t.set("includenotebounds",e.includeNoteBounds),t}static setProperty(e,t,i){switch(t){case"scriptfile":return e.scriptFile=i,!0;case"fontdirectory":return e.fontDirectory=i,!0;case"smuflfontsources":return e.smuflFontSources=new Map,ry.forEach(i,(t,i)=>{e.smuflFontSources.set(ry.parseEnum(i,ic),t)}),!0;case"file":return e.file=i,!0;case"tex":return e.tex=i,!0;case"tracks":return e.tracks=i,!0;case"enablelazyloading":return e.enableLazyLoading=i,!0;case"engine":return e.engine=i,!0;case"loglevel":return e.logLevel=ry.parseEnum(i,tm),!0;case"useworkers":return e.useWorkers=i,!0;case"includenotebounds":return e.includeNoteBounds=i,!0}return!1}}class rv{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rv.setProperty(e,i.toLowerCase(),t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("smuflfont",r_.toJson(e.smuflFont)),t.set("copyrightfont",r_.toJson(e.copyrightFont)),t.set("titlefont",r_.toJson(e.titleFont)),t.set("subtitlefont",r_.toJson(e.subTitleFont)),t.set("wordsfont",r_.toJson(e.wordsFont)),t.set("effectfont",r_.toJson(e.effectFont)),t.set("timerfont",r_.toJson(e.timerFont)),t.set("directionsfont",r_.toJson(e.directionsFont)),t.set("fretboardnumberfont",r_.toJson(e.fretboardNumberFont)),t.set("numberednotationfont",r_.toJson(e.numberedNotationFont)),t.set("numberednotationgracefont",r_.toJson(e.numberedNotationGraceFont)),t.set("tablaturefont",r_.toJson(e.tablatureFont)),t.set("gracefont",r_.toJson(e.graceFont)),t.set("stafflinecolor",si.toJson(e.staffLineColor)),t.set("barseparatorcolor",si.toJson(e.barSeparatorColor)),t.set("barnumberfont",r_.toJson(e.barNumberFont)),t.set("barnumbercolor",si.toJson(e.barNumberColor)),t.set("fingeringfont",r_.toJson(e.fingeringFont)),t.set("inlinefingeringfont",r_.toJson(e.inlineFingeringFont)),t.set("markerfont",r_.toJson(e.markerFont)),t.set("mainglyphcolor",si.toJson(e.mainGlyphColor)),t.set("secondaryglyphcolor",si.toJson(e.secondaryGlyphColor)),t.set("scoreinfocolor",si.toJson(e.scoreInfoColor)),t}static setProperty(e,t,i){switch(t){case"smuflfont":return e.smuflFont=r_.fromJson(i),!0;case"copyrightfont":return e.copyrightFont=r_.fromJson(i),!0;case"titlefont":return e.titleFont=r_.fromJson(i),!0;case"subtitlefont":return e.subTitleFont=r_.fromJson(i),!0;case"wordsfont":return e.wordsFont=r_.fromJson(i),!0;case"effectfont":return e.effectFont=r_.fromJson(i),!0;case"timerfont":return e.timerFont=r_.fromJson(i),!0;case"directionsfont":return e.directionsFont=r_.fromJson(i),!0;case"fretboardnumberfont":return e.fretboardNumberFont=r_.fromJson(i),!0;case"numberednotationfont":return e.numberedNotationFont=r_.fromJson(i),!0;case"numberednotationgracefont":return e.numberedNotationGraceFont=r_.fromJson(i),!0;case"tablaturefont":return e.tablatureFont=r_.fromJson(i),!0;case"gracefont":return e.graceFont=r_.fromJson(i),!0;case"stafflinecolor":return e.staffLineColor=si.fromJson(i),!0;case"barseparatorcolor":return e.barSeparatorColor=si.fromJson(i),!0;case"barnumberfont":return e.barNumberFont=r_.fromJson(i),!0;case"barnumbercolor":return e.barNumberColor=si.fromJson(i),!0;case"fingeringfont":return e.fingeringFont=r_.fromJson(i),!0;case"inlinefingeringfont":return e.inlineFingeringFont=r_.fromJson(i),!0;case"markerfont":return e.markerFont=r_.fromJson(i),!0;case"mainglyphcolor":return e.mainGlyphColor=si.fromJson(i),!0;case"secondaryglyphcolor":return e.secondaryGlyphColor=si.fromJson(i),!0;case"scoreinfocolor":return e.scoreInfoColor=si.fromJson(i),!0}return!1}}class rF{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rF.setProperty(e,i.toLowerCase(),t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("scale",e.scale),t.set("stretchforce",e.stretchForce),t.set("layoutmode",e.layoutMode),t.set("staveprofile",e.staveProfile),t.set("barsperrow",e.barsPerRow),t.set("startbar",e.startBar),t.set("barcount",e.barCount),t.set("barcountperpartial",e.barCountPerPartial),t.set("justifylastsystem",e.justifyLastSystem),t.set("resources",rv.toJson(e.resources)),t.set("padding",e.padding),t.set("firstsystempaddingtop",e.firstSystemPaddingTop),t.set("systempaddingtop",e.systemPaddingTop),t.set("systempaddingbottom",e.systemPaddingBottom),t.set("lastsystempaddingbottom",e.lastSystemPaddingBottom),t.set("systemlabelpaddingleft",e.systemLabelPaddingLeft),t.set("systemlabelpaddingright",e.systemLabelPaddingRight),t.set("accoladebarpaddingright",e.accoladeBarPaddingRight),t.set("notationstaffpaddingtop",e.notationStaffPaddingTop),t.set("notationstaffpaddingbottom",e.notationStaffPaddingBottom),t.set("effectstaffpaddingtop",e.effectStaffPaddingTop),t.set("effectstaffpaddingbottom",e.effectStaffPaddingBottom),t.set("firststaffpaddingleft",e.firstStaffPaddingLeft),t.set("staffpaddingleft",e.staffPaddingLeft),t.set("systemslayoutmode",e.systemsLayoutMode),t}static setProperty(e,t,i){switch(t){case"scale":return e.scale=i,!0;case"stretchforce":return e.stretchForce=i,!0;case"layoutmode":return e.layoutMode=ry.parseEnum(i,eX),!0;case"staveprofile":return e.staveProfile=ry.parseEnum(i,eJ),!0;case"barsperrow":return e.barsPerRow=i,!0;case"startbar":return e.startBar=i,!0;case"barcount":return e.barCount=i,!0;case"barcountperpartial":return e.barCountPerPartial=i,!0;case"justifylastsystem":return e.justifyLastSystem=i,!0;case"padding":return e.padding=i,!0;case"firstsystempaddingtop":return e.firstSystemPaddingTop=i,!0;case"systempaddingtop":return e.systemPaddingTop=i,!0;case"systempaddingbottom":return e.systemPaddingBottom=i,!0;case"lastsystempaddingbottom":return e.lastSystemPaddingBottom=i,!0;case"systemlabelpaddingleft":return e.systemLabelPaddingLeft=i,!0;case"systemlabelpaddingright":return e.systemLabelPaddingRight=i,!0;case"accoladebarpaddingright":return e.accoladeBarPaddingRight=i,!0;case"notationstaffpaddingtop":return e.notationStaffPaddingTop=i,!0;case"notationstaffpaddingbottom":return e.notationStaffPaddingBottom=i,!0;case"effectstaffpaddingtop":return e.effectStaffPaddingTop=i,!0;case"effectstaffpaddingbottom":return e.effectStaffPaddingBottom=i,!0;case"firststaffpaddingleft":return e.firstStaffPaddingLeft=i,!0;case"staffpaddingleft":return e.staffPaddingLeft=i,!0;case"systemslayoutmode":return e.systemsLayoutMode=ry.parseEnum(i,t4),!0}if(["resources"].indexOf(t)>=0)return rv.fromJson(e.resources,i),!0;for(let s of["resources"])if(0===t.indexOf(s)&&rv.setProperty(e.resources,t.substring(s.length),i))return!0;return!1}}class rC{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rC.setProperty(e,i.toLowerCase(),t))}static toJson(e){if(!e)return null;let t=new Map;t.set("notationmode",e.notationMode),t.set("fingeringmode",e.fingeringMode);{let i=new Map;for(let[s,a]of(t.set("elements",i),e.elements))i.set(s.toString(),a)}return t.set("rhythmmode",e.rhythmMode),t.set("rhythmheight",e.rhythmHeight),t.set("transpositionpitches",e.transpositionPitches),t.set("displaytranspositionpitches",e.displayTranspositionPitches),t.set("smallgracetabnotes",e.smallGraceTabNotes),t.set("extendbendarrowsontiednotes",e.extendBendArrowsOnTiedNotes),t.set("extendlineeffectstobeatend",e.extendLineEffectsToBeatEnd),t.set("slurheight",e.slurHeight),t}static setProperty(e,t,i){switch(t){case"notationmode":return e.notationMode=ry.parseEnum(i,tu),!0;case"fingeringmode":return e.fingeringMode=ry.parseEnum(i,tc),!0;case"elements":return e.elements=new Map,ry.forEach(i,(t,i)=>{e.elements.set(ry.parseEnum(i,tp),t)}),!0;case"rhythmmode":return e.rhythmMode=ry.parseEnum(i,td),!0;case"rhythmheight":return e.rhythmHeight=i,!0;case"transpositionpitches":return e.transpositionPitches=i,!0;case"displaytranspositionpitches":return e.displayTranspositionPitches=i,!0;case"smallgracetabnotes":return e.smallGraceTabNotes=i,!0;case"extendbendarrowsontiednotes":return e.extendBendArrowsOnTiedNotes=i,!0;case"extendlineeffectstobeatend":return e.extendLineEffectsToBeatEnd=i,!0;case"slurheight":return e.slurHeight=i,!0}return!1}}class rD{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rD.setProperty(e,i.toLowerCase(),t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("encoding",e.encoding),t.set("mergepartgroupsinmusicxml",e.mergePartGroupsInMusicXml),t.set("beattextaslyrics",e.beatTextAsLyrics),t}static setProperty(e,t,i){switch(t){case"encoding":return e.encoding=i,!0;case"mergepartgroupsinmusicxml":return e.mergePartGroupsInMusicXml=i,!0;case"beattextaslyrics":return e.beatTextAsLyrics=i,!0}return!1}}class rE{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rE.setProperty(e,i.toLowerCase(),t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("notewidelength",e.noteWideLength),t.set("notewideamplitude",e.noteWideAmplitude),t.set("noteslightlength",e.noteSlightLength),t.set("noteslightamplitude",e.noteSlightAmplitude),t.set("beatwidelength",e.beatWideLength),t.set("beatwideamplitude",e.beatWideAmplitude),t.set("beatslightlength",e.beatSlightLength),t.set("beatslightamplitude",e.beatSlightAmplitude),t}static setProperty(e,t,i){switch(t){case"notewidelength":return e.noteWideLength=i,!0;case"notewideamplitude":return e.noteWideAmplitude=i,!0;case"noteslightlength":return e.noteSlightLength=i,!0;case"noteslightamplitude":return e.noteSlightAmplitude=i,!0;case"beatwidelength":return e.beatWideLength=i,!0;case"beatwideamplitude":return e.beatWideAmplitude=i,!0;case"beatslightlength":return e.beatSlightLength=i,!0;case"beatslightamplitude":return e.beatSlightAmplitude=i,!0}return!1}}class rM{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rM.setProperty(e,i.toLowerCase(),t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("simpleslidepitchoffset",e.simpleSlidePitchOffset),t.set("simpleslidedurationratio",e.simpleSlideDurationRatio),t.set("shiftslidedurationratio",e.shiftSlideDurationRatio),t}static setProperty(e,t,i){switch(t){case"simpleslidepitchoffset":return e.simpleSlidePitchOffset=i,!0;case"simpleslidedurationratio":return e.simpleSlideDurationRatio=i,!0;case"shiftslidedurationratio":return e.shiftSlideDurationRatio=i,!0}return!1}}class rL{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rL.setProperty(e,i.toLowerCase(),t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("soundfont",e.soundFont),t.set("outputmode",e.outputMode),t.set("enableplayer",e.enablePlayer),t.set("playermode",e.playerMode),t.set("enablecursor",e.enableCursor),t.set("enableanimatedbeatcursor",e.enableAnimatedBeatCursor),t.set("enableelementhighlighting",e.enableElementHighlighting),t.set("enableuserinteraction",e.enableUserInteraction),t.set("scrolloffsetx",e.scrollOffsetX),t.set("scrolloffsety",e.scrollOffsetY),t.set("scrollmode",e.scrollMode),t.set("scrollspeed",e.scrollSpeed),t.set("nativebrowsersmoothscroll",e.nativeBrowserSmoothScroll),t.set("songbookbendduration",e.songBookBendDuration),t.set("songbookdipduration",e.songBookDipDuration),t.set("vibrato",rE.toJson(e.vibrato)),t.set("slide",rM.toJson(e.slide)),t.set("playtripletfeel",e.playTripletFeel),t.set("buffertimeinmilliseconds",e.bufferTimeInMilliseconds),t}static setProperty(e,t,i){switch(t){case"soundfont":return e.soundFont=i,!0;case"scrollelement":return e.scrollElement=i,!0;case"outputmode":return e.outputMode=ry.parseEnum(i,t8),!0;case"enableplayer":return e.enablePlayer=i,!0;case"playermode":return e.playerMode=ry.parseEnum(i,t7),!0;case"enablecursor":return e.enableCursor=i,!0;case"enableanimatedbeatcursor":return e.enableAnimatedBeatCursor=i,!0;case"enableelementhighlighting":return e.enableElementHighlighting=i,!0;case"enableuserinteraction":return e.enableUserInteraction=i,!0;case"scrolloffsetx":return e.scrollOffsetX=i,!0;case"scrolloffsety":return e.scrollOffsetY=i,!0;case"scrollmode":return e.scrollMode=ry.parseEnum(i,t6),!0;case"scrollspeed":return e.scrollSpeed=i,!0;case"nativebrowsersmoothscroll":return e.nativeBrowserSmoothScroll=i,!0;case"songbookbendduration":return e.songBookBendDuration=i,!0;case"songbookdipduration":return e.songBookDipDuration=i,!0;case"playtripletfeel":return e.playTripletFeel=i,!0;case"buffertimeinmilliseconds":return e.bufferTimeInMilliseconds=i,!0}if(["vibrato"].indexOf(t)>=0)return rE.fromJson(e.vibrato,i),!0;for(let s of["vibrato"])if(0===t.indexOf(s)&&rE.setProperty(e.vibrato,t.substring(s.length),i))return!0;if(["slide"].indexOf(t)>=0)return rM.fromJson(e.slide,i),!0;for(let s of["slide"])if(0===t.indexOf(s)&&rM.setProperty(e.slide,t.substring(s.length),i))return!0;return!1}}class rI{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rI.setProperty(e,i.toLowerCase(),t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("core",rP.toJson(e.core)),t.set("display",rF.toJson(e.display)),t.set("notation",rC.toJson(e.notation)),t.set("importer",rD.toJson(e.importer)),t.set("player",rL.toJson(e.player)),t}static setProperty(e,t,i){if(["core",""].indexOf(t)>=0)return rP.fromJson(e.core,i),!0;for(let s of["core",""])if(0===t.indexOf(s)&&rP.setProperty(e.core,t.substring(s.length),i))return!0;if(["display",""].indexOf(t)>=0)return rF.fromJson(e.display,i),!0;for(let s of["display",""])if(0===t.indexOf(s)&&rF.setProperty(e.display,t.substring(s.length),i))return!0;if(["notation"].indexOf(t)>=0)return rC.fromJson(e.notation,i),!0;for(let s of["notation"])if(0===t.indexOf(s)&&rC.setProperty(e.notation,t.substring(s.length),i))return!0;if(["importer"].indexOf(t)>=0)return rD.fromJson(e.importer,i),!0;for(let s of["importer"])if(0===t.indexOf(s)&&rD.setProperty(e.importer,t.substring(s.length),i))return!0;if(["player"].indexOf(t)>=0)return rL.fromJson(e.player,i),!0;for(let s of["player"])if(0===t.indexOf(s)&&rL.setProperty(e.player,t.substring(s.length),i))return!0;return!1}}class rA{constructor(){this.core=new dM,this.display=new rk,this.notation=new iC,this.importer=new rB,this.player=new rx}setSongBookModeSettings(){this.notation.notationMode=tu.SongBook,this.notation.smallGraceTabNotes=!1,this.notation.fingeringMode=tc.SingleNoteEffectBand,this.notation.extendBendArrowsOnTiedNotes=!1,this.notation.elements.set(tp.ParenthesisOnTiedBends,!1),this.notation.elements.set(tp.TabNotesOnTiedBends,!1),this.notation.elements.set(tp.ZerosOnDiveWhammys,!0)}static get songBook(){let e=new rA;return e.setSongBookModeSettings(),e}fillFromJson(e){rI.fromJson(this,e)}handleBackwardsCompatibility(){this.player.playerMode===t7.Disabled&&this.player.enablePlayer&&(this.player.playerMode=t7.EnabledAutomatic)}}class rR{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rR.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("marker",e.marker),t.set("text",e.text),t}static setProperty(e,t,i){switch(t){case"marker":return e.marker=i,!0;case"text":return e.text=i,!0}return!1}}class rO{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rO.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("baroccurence",e.barOccurence),t.set("millisecondoffset",e.millisecondOffset),t}static setProperty(e,t,i){switch(t){case"baroccurence":return e.barOccurence=i,!0;case"millisecondoffset":return e.millisecondOffset=i,!0}return!1}}class rH{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rH.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("islinear",e.isLinear),t.set("type",e.type),t.set("value",e.value),e.syncPointValue&&t.set("syncpointvalue",rO.toJson(e.syncPointValue)),t.set("ratioposition",e.ratioPosition),t.set("text",e.text),t}static setProperty(e,t,i){switch(t){case"islinear":return e.isLinear=i,!0;case"type":return e.type=ry.parseEnum(i,e6),!0;case"value":return e.value=i,!0;case"syncpointvalue":return i?(e.syncPointValue=new iP,rO.fromJson(e.syncPointValue,i)):e.syncPointValue=void 0,!0;case"ratioposition":return e.ratioPosition=i,!0;case"text":return e.text=i,!0}return!1}}class rV{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rV.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("type",e.type),t.set("length",e.length),t}static setProperty(e,t,i){switch(t){case"type":return e.type=ry.parseEnum(i,tA),!0;case"length":return e.length=i,!0}return!1}}class rW{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rW.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;if(t.set("alternateendings",e.alternateEndings),t.set("isdoublebar",e.isDoubleBar),t.set("isrepeatstart",e.isRepeatStart),t.set("repeatcount",e.repeatCount),t.set("timesignaturenumerator",e.timeSignatureNumerator),t.set("timesignaturedenominator",e.timeSignatureDenominator),t.set("timesignaturecommon",e.timeSignatureCommon),t.set("isfreetime",e.isFreeTime),t.set("tripletfeel",e.tripletFeel),e.section&&t.set("section",rR.toJson(e.section)),t.set("tempoautomations",e.tempoAutomations.map(e=>rH.toJson(e))),void 0!==e.syncPoints&&t.set("syncpoints",e.syncPoints?.map(e=>rH.toJson(e))),null!==e.fermata){let i=new Map;for(let[s,a]of(t.set("fermata",i),e.fermata))i.set(s.toString(),rV.toJson(a))}if(t.set("start",e.start),t.set("isanacrusis",e.isAnacrusis),t.set("displayscale",e.displayScale),t.set("displaywidth",e.displayWidth),null!==e.directions){let i=[];for(let s of(t.set("directions",i),e.directions))i.push(s)}return t}static setProperty(e,t,i){switch(t){case"alternateendings":return e.alternateEndings=i,!0;case"isdoublebar":return e.isDoubleBar=i,!0;case"isrepeatstart":return e.isRepeatStart=i,!0;case"repeatcount":return e.repeatCount=i,!0;case"timesignaturenumerator":return e.timeSignatureNumerator=i,!0;case"timesignaturedenominator":return e.timeSignatureDenominator=i,!0;case"timesignaturecommon":return e.timeSignatureCommon=i,!0;case"isfreetime":return e.isFreeTime=i,!0;case"tripletfeel":return e.tripletFeel=ry.parseEnum(i,tg),!0;case"section":return i?(e.section=new se,rR.fromJson(e.section,i)):e.section=null,!0;case"tempoautomations":for(let t of(e.tempoAutomations=[],i)){let i=new iv;rH.fromJson(i,t),e.tempoAutomations.push(i)}return!0;case"syncpoints":if(i)for(let t of(e.syncPoints=[],i)){let i=new iv;rH.fromJson(i,t),e.addSyncPoint(i)}return!0;case"fermata":return e.fermata=new Map,ry.forEach(i,(t,i)=>{let s=new sc;rV.fromJson(s,t),e.addFermata(Number.parseInt(i),s)}),!0;case"start":return e.start=i,!0;case"isanacrusis":return e.isAnacrusis=i,!0;case"displayscale":return e.displayScale=i,!0;case"displaywidth":return e.displayWidth=i,!0;case"directions":for(let t of i)e.addDirection(ry.parseEnum(t,tI));return!0}return!1}}class rG{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rG.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("offset",e.offset),t.set("value",e.value),t}static setProperty(e,t,i){switch(t){case"offset":return e.offset=i,!0;case"value":return e.value=i,!0}return!1}}class rz{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rz.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;t.set("notehead",e.noteHead),t.set("noteheadcenteronstem",e.noteHeadCenterOnStem);{let i=new Map;for(let[s,a]of(t.set("colors",i),e.colors))i.set(s.toString(),si.toJson(a))}return t}static setProperty(e,t,i){switch(t){case"notehead":return e.noteHead=ry.parseEnum(i,tb),!0;case"noteheadcenteronstem":return e.noteHeadCenterOnStem=i,!0;case"colors":return e.colors=new Map,ry.forEach(i,(t,i)=>{e.colors.set(ry.parseEnum(i,tk),si.fromJson(t))}),!0}return!1}}class rU{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rU.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("id",e.id),t.set("accentuated",e.accentuated),t.set("bendtype",e.bendType),t.set("bendstyle",e.bendStyle),t.set("iscontinuedbend",e.isContinuedBend),null!==e.bendPoints&&t.set("bendpoints",e.bendPoints?.map(e=>rG.toJson(e))),t.set("fret",e.fret),t.set("string",e.string),t.set("showstringnumber",e.showStringNumber),t.set("octave",e.octave),t.set("tone",e.tone),t.set("percussionarticulation",e.percussionArticulation),t.set("isvisible",e.isVisible),t.set("islefthandtapped",e.isLeftHandTapped),t.set("ishammerpullorigin",e.isHammerPullOrigin),t.set("isslurdestination",e.isSlurDestination),t.set("harmonictype",e.harmonicType),t.set("harmonicvalue",e.harmonicValue),t.set("isghost",e.isGhost),t.set("isletring",e.isLetRing),t.set("ispalmmute",e.isPalmMute),t.set("isdead",e.isDead),t.set("isstaccato",e.isStaccato),t.set("slideintype",e.slideInType),t.set("slideouttype",e.slideOutType),t.set("vibrato",e.vibrato),t.set("istiedestination",e.isTieDestination),t.set("lefthandfinger",e.leftHandFinger),t.set("righthandfinger",e.rightHandFinger),t.set("trillvalue",e.trillValue),t.set("trillspeed",e.trillSpeed),t.set("durationpercent",e.durationPercent),t.set("accidentalmode",e.accidentalMode),t.set("dynamics",e.dynamics),t.set("ornament",e.ornament),e.style&&t.set("style",rz.toJson(e.style)),e.toJson(t),t}static setProperty(e,t,i){switch(t){case"id":return e.id=i,!0;case"accentuated":return e.accentuated=ry.parseEnum(i,ts),!0;case"bendtype":return e.bendType=ry.parseEnum(i,e7),!0;case"bendstyle":return e.bendStyle=ry.parseEnum(i,e8),!0;case"iscontinuedbend":return e.isContinuedBend=i,!0;case"bendpoints":if(i)for(let t of(e.bendPoints=[],i)){let i=new iF;rG.fromJson(i,t),e.addBendPoint(i)}return!0;case"fret":return e.fret=i,!0;case"string":return e.string=i,!0;case"showstringnumber":return e.showStringNumber=i,!0;case"octave":return e.octave=i,!0;case"tone":return e.tone=i,!0;case"percussionarticulation":return e.percussionArticulation=i,!0;case"isvisible":return e.isVisible=i,!0;case"islefthandtapped":return e.isLeftHandTapped=i,!0;case"ishammerpullorigin":return e.isHammerPullOrigin=i,!0;case"isslurdestination":return e.isSlurDestination=i,!0;case"harmonictype":return e.harmonicType=ry.parseEnum(i,tr),!0;case"harmonicvalue":return e.harmonicValue=i,!0;case"isghost":return e.isGhost=i,!0;case"isletring":return e.isLetRing=i,!0;case"ispalmmute":return e.isPalmMute=i,!0;case"isdead":return e.isDead=i,!0;case"isstaccato":return e.isStaccato=i,!0;case"slideintype":return e.slideInType=ry.parseEnum(i,to),!0;case"slideouttype":return e.slideOutType=ry.parseEnum(i,tl),!0;case"vibrato":return e.vibrato=ry.parseEnum(i,th),!0;case"istiedestination":return e.isTieDestination=i,!0;case"lefthandfinger":return e.leftHandFinger=ry.parseEnum(i,ta),!0;case"righthandfinger":return e.rightHandFinger=ry.parseEnum(i,ta),!0;case"trillvalue":return e.trillValue=i,!0;case"trillspeed":return e.trillSpeed=ry.parseEnum(i,tt),!0;case"durationpercent":return e.durationPercent=i,!0;case"accidentalmode":return e.accidentalMode=ry.parseEnum(i,tn),!0;case"dynamics":return e.dynamics=ry.parseEnum(i,e4),!0;case"ornament":return e.ornament=ry.parseEnum(i,tw),!0;case"style":return i?(e.style=new iJ,rz.fromJson(e.style,i)):e.style=void 0,!0}return e.setProperty(t,i)}}class rX{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rX.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;{let i=new Map;for(let[s,a]of(t.set("colors",i),e.colors))i.set(s.toString(),si.toJson(a))}return t}static setProperty(e,t,i){return"colors"===t&&(e.colors=new Map,ry.forEach(i,(t,i)=>{e.colors.set(ry.parseEnum(i,tC),si.fromJson(t))}),!0)}}class rJ{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rJ.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("id",e.id),t.set("notes",e.notes.map(e=>rU.toJson(e))),t.set("isempty",e.isEmpty),t.set("whammystyle",e.whammyStyle),t.set("ottava",e.ottava),t.set("islegatoorigin",e.isLegatoOrigin),t.set("duration",e.duration),t.set("automations",e.automations.map(e=>rH.toJson(e))),t.set("dots",e.dots),t.set("fade",e.fade),t.set("lyrics",e.lyrics),t.set("pop",e.pop),t.set("slap",e.slap),t.set("tap",e.tap),t.set("text",e.text),t.set("slashed",e.slashed),t.set("deadslapped",e.deadSlapped),t.set("brushtype",e.brushType),t.set("brushduration",e.brushDuration),t.set("tupletdenominator",e.tupletDenominator),t.set("tupletnumerator",e.tupletNumerator),t.set("iscontinuedwhammy",e.isContinuedWhammy),t.set("whammybartype",e.whammyBarType),null!==e.whammyBarPoints&&t.set("whammybarpoints",e.whammyBarPoints?.map(e=>rG.toJson(e))),t.set("vibrato",e.vibrato),t.set("chordid",e.chordId),t.set("gracetype",e.graceType),t.set("pickstroke",e.pickStroke),t.set("tremolospeed",e.tremoloSpeed),t.set("crescendo",e.crescendo),t.set("displaystart",e.displayStart),t.set("playbackstart",e.playbackStart),t.set("displayduration",e.displayDuration),t.set("playbackduration",e.playbackDuration),t.set("overridedisplayduration",e.overrideDisplayDuration),t.set("golpe",e.golpe),t.set("dynamics",e.dynamics),t.set("invertbeamdirection",e.invertBeamDirection),t.set("preferredbeamdirection",e.preferredBeamDirection),t.set("beamingmode",e.beamingMode),t.set("wahpedal",e.wahPedal),t.set("barrefret",e.barreFret),t.set("barreshape",e.barreShape),t.set("rasgueado",e.rasgueado),t.set("showtimer",e.showTimer),t.set("timer",e.timer),e.style&&t.set("style",rX.toJson(e.style)),t}static setProperty(e,t,i){switch(t){case"id":return e.id=i,!0;case"notes":for(let t of(e.notes=[],i)){let i=new iY;rU.fromJson(i,t),e.addNote(i)}return!0;case"isempty":return e.isEmpty=i,!0;case"whammystyle":return e.whammyStyle=ry.parseEnum(i,e8),!0;case"ottava":return e.ottava=ry.parseEnum(i,eQ),!0;case"islegatoorigin":return e.isLegatoOrigin=i,!0;case"duration":return e.duration=ry.parseEnum(i,tt),!0;case"automations":for(let t of(e.automations=[],i)){let i=new iv;rH.fromJson(i,t),e.automations.push(i)}return!0;case"dots":return e.dots=i,!0;case"fade":return e.fade=ry.parseEnum(i,tN),!0;case"lyrics":return e.lyrics=i,!0;case"pop":return e.pop=i,!0;case"slap":return e.slap=i,!0;case"tap":return e.tap=i,!0;case"text":return e.text=i,!0;case"slashed":return e.slashed=i,!0;case"deadslapped":return e.deadSlapped=i,!0;case"brushtype":return e.brushType=ry.parseEnum(i,e9),!0;case"brushduration":return e.brushDuration=i,!0;case"tupletdenominator":return e.tupletDenominator=i,!0;case"tupletnumerator":return e.tupletNumerator=i,!0;case"iscontinuedwhammy":return e.isContinuedWhammy=i,!0;case"whammybartype":return e.whammyBarType=ry.parseEnum(i,tB),!0;case"whammybarpoints":if(i)for(let t of(e.whammyBarPoints=[],i)){let i=new iF;rG.fromJson(i,t),e.addWhammyBarPoint(i)}return!0;case"vibrato":return e.vibrato=ry.parseEnum(i,th),!0;case"chordid":return e.chordId=i,!0;case"gracetype":return e.graceType=ry.parseEnum(i,ti),!0;case"pickstroke":return e.pickStroke=ry.parseEnum(i,ty),!0;case"tremolospeed":return e.tremoloSpeed=ry.parseEnum(i,tt)??null,!0;case"crescendo":return e.crescendo=ry.parseEnum(i,te),!0;case"displaystart":return e.displayStart=i,!0;case"playbackstart":return e.playbackStart=i,!0;case"displayduration":return e.displayDuration=i,!0;case"playbackduration":return e.playbackDuration=i,!0;case"overridedisplayduration":return e.overrideDisplayDuration=i,!0;case"golpe":return e.golpe=ry.parseEnum(i,tT),!0;case"dynamics":return e.dynamics=ry.parseEnum(i,e4),!0;case"invertbeamdirection":return e.invertBeamDirection=i,!0;case"preferredbeamdirection":return e.preferredBeamDirection=ry.parseEnum(i,tR)??null,!0;case"beamingmode":return e.beamingMode=ry.parseEnum(i,tF),!0;case"wahpedal":return e.wahPedal=ry.parseEnum(i,tx),!0;case"barrefret":return e.barreFret=i,!0;case"barreshape":return e.barreShape=ry.parseEnum(i,tP),!0;case"rasgueado":return e.rasgueado=ry.parseEnum(i,tv),!0;case"showtimer":return e.showTimer=i,!0;case"timer":return e.timer=i,!0;case"style":return i?(e.style=new i0,rX.fromJson(e.style,i)):e.style=void 0,!0}return!1}}class rY{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rY.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;{let i=new Map;for(let[s,a]of(t.set("colors",i),e.colors))i.set(s.toString(),si.toJson(a))}return t}static setProperty(e,t,i){return"colors"===t&&(e.colors=new Map,ry.forEach(i,(t,i)=>{e.colors.set(ry.parseEnum(i,tf),si.fromJson(t))}),!0)}}class rq{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rq.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("id",e.id),t.set("beats",e.beats.map(e=>rJ.toJson(e))),e.style&&t.set("style",rY.toJson(e.style)),t}static setProperty(e,t,i){switch(t){case"id":return e.id=i,!0;case"beats":for(let t of(e.beats=[],i)){let i=new i1;rJ.fromJson(i,t),e.addBeat(i)}return!0;case"style":return i?(e.style=new iR,rY.fromJson(e.style,i)):e.style=void 0,!0}return!1}}class r${static fromJson(e,t){t&&ry.forEach(t,(t,i)=>r$.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("ratioposition",e.ratioPosition),t.set("pedaltype",e.pedalType),t}static setProperty(e,t,i){switch(t){case"ratioposition":return e.ratioPosition=i,!0;case"pedaltype":return e.pedalType=ry.parseEnum(i,e2),!0}return!1}}class rj{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rj.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;{let i=new Map;for(let[s,a]of(t.set("colors",i),e.colors))i.set(s.toString(),si.toJson(a))}return t}static setProperty(e,t,i){return"colors"===t&&(e.colors=new Map,ry.forEach(i,(t,i)=>{e.colors.set(ry.parseEnum(i,e5),si.fromJson(t))}),!0)}}class rK{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rK.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("id",e.id),t.set("clef",e.clef),t.set("clefottava",e.clefOttava),t.set("voices",e.voices.map(e=>rq.toJson(e))),t.set("similemark",e.simileMark),t.set("displayscale",e.displayScale),t.set("displaywidth",e.displayWidth),t.set("sustainpedals",e.sustainPedals.map(e=>r$.toJson(e))),t.set("barlineleft",e.barLineLeft),t.set("barlineright",e.barLineRight),t.set("keysignature",e.keySignature),t.set("keysignaturetype",e.keySignatureType),e.style&&t.set("style",rj.toJson(e.style)),t}static setProperty(e,t,i){switch(t){case"id":return e.id=i,!0;case"clef":return e.clef=ry.parseEnum(i,eK),!0;case"clefottava":return e.clefOttava=ry.parseEnum(i,eQ),!0;case"voices":for(let t of(e.voices=[],i)){let i=new iO;rq.fromJson(i,t),e.addVoice(i)}return!0;case"similemark":return e.simileMark=ry.parseEnum(i,eZ),!0;case"displayscale":return e.displayScale=i,!0;case"displaywidth":return e.displayWidth=i,!0;case"sustainpedals":for(let t of(e.sustainPedals=[],i)){let i=new iB;r$.fromJson(i,t),e.sustainPedals.push(i)}return!0;case"barlineleft":return e.barLineLeft=ry.parseEnum(i,e3),!0;case"barlineright":return e.barLineRight=ry.parseEnum(i,e3),!0;case"keysignature":return e.keySignature=ry.parseEnum(i,e0),!0;case"keysignaturetype":return e.keySignatureType=ry.parseEnum(i,e1),!0;case"style":return i?(e.style=new iT,rj.fromJson(e.style,i)):e.style=void 0,!0}return!1}}class rQ{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rQ.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("name",e.name),t.set("firstfret",e.firstFret),t.set("strings",e.strings),t.set("barrefrets",e.barreFrets),t.set("showname",e.showName),t.set("showdiagram",e.showDiagram),t.set("showfingering",e.showFingering),t}static setProperty(e,t,i){switch(t){case"name":return e.name=i,!0;case"firstfret":return e.firstFret=i,!0;case"strings":return e.strings=i,!0;case"barrefrets":return e.barreFrets=i,!0;case"showname":return e.showName=i,!0;case"showdiagram":return e.showDiagram=i,!0;case"showfingering":return e.showFingering=i,!0}return!1}}class rZ{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>rZ.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("isstandard",e.isStandard),t.set("name",e.name),t.set("tunings",e.tunings),t}static setProperty(e,t,i){switch(t){case"isstandard":return e.isStandard=i,!0;case"name":return e.name=i,!0;case"tunings":return e.tunings=i,!0}return!1}}class r0{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>r0.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;if(t.set("bars",e.bars.map(e=>rK.toJson(e))),null!==e.chords){let i=new Map;for(let[s,a]of(t.set("chords",i),e.chords))i.set(s.toString(),rQ.toJson(a))}return t.set("capo",e.capo),t.set("transpositionpitch",e.transpositionPitch),t.set("displaytranspositionpitch",e.displayTranspositionPitch),t.set("stringtuning",rZ.toJson(e.stringTuning)),t.set("showslash",e.showSlash),t.set("shownumbered",e.showNumbered),t.set("showtablature",e.showTablature),t.set("showstandardnotation",e.showStandardNotation),t.set("ispercussion",e.isPercussion),t.set("standardnotationlinecount",e.standardNotationLineCount),t}static setProperty(e,t,i){switch(t){case"bars":for(let t of(e.bars=[],i)){let i=new iN;rK.fromJson(i,t),e.addBar(i)}return!0;case"chords":return e.chords=new Map,ry.forEach(i,(t,i)=>{let s=new i7;rQ.fromJson(s,t),e.addChord(i,s)}),!0;case"capo":return e.capo=i,!0;case"transpositionpitch":return e.transpositionPitch=i,!0;case"displaytranspositionpitch":return e.displayTranspositionPitch=i,!0;case"stringtuning":return rZ.fromJson(e.stringTuning,i),!0;case"showslash":return e.showSlash=i,!0;case"shownumbered":return e.showNumbered=i,!0;case"showtablature":return e.showTablature=i,!0;case"showstandardnotation":return e.showStandardNotation=i,!0;case"ispercussion":return e.isPercussion=i,!0;case"standardnotationlinecount":return e.standardNotationLineCount=i,!0}return!1}}class r1{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>r1.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("volume",e.volume),t.set("balance",e.balance),t.set("port",e.port),t.set("program",e.program),t.set("primarychannel",e.primaryChannel),t.set("secondarychannel",e.secondaryChannel),t.set("ismute",e.isMute),t.set("issolo",e.isSolo),t}static setProperty(e,t,i){switch(t){case"volume":return e.volume=i,!0;case"balance":return e.balance=i,!0;case"port":return e.port=i,!0;case"program":return e.program=i,!0;case"primarychannel":return e.primaryChannel=i,!0;case"secondarychannel":return e.secondaryChannel=i,!0;case"ismute":return e.isMute=i,!0;case"issolo":return e.isSolo=i,!0}return!1}}class r2{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>r2.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("elementtype",e.elementType),t.set("staffline",e.staffLine),t.set("noteheaddefault",e.noteHeadDefault),t.set("noteheadhalf",e.noteHeadHalf),t.set("noteheadwhole",e.noteHeadWhole),t.set("techniquesymbol",e.techniqueSymbol),t.set("techniquesymbolplacement",e.techniqueSymbolPlacement),t.set("outputmidinumber",e.outputMidiNumber),t}static setProperty(e,t,i){switch(t){case"elementtype":return e.elementType=i,!0;case"staffline":return e.staffLine=i,!0;case"noteheaddefault":return e.noteHeadDefault=ry.parseEnum(i,tb),!0;case"noteheadhalf":return e.noteHeadHalf=ry.parseEnum(i,tb),!0;case"noteheadwhole":return e.noteHeadWhole=ry.parseEnum(i,tb),!0;case"techniquesymbol":return e.techniqueSymbol=ry.parseEnum(i,tb),!0;case"techniquesymbolplacement":return e.techniqueSymbolPlacement=ry.parseEnum(i,t_),!0;case"outputmidinumber":return e.outputMidiNumber=i,!0}return!1}}class r5{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>r5.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;{let i=new Map;for(let[s,a]of(t.set("colors",i),e.colors))i.set(s.toString(),si.toJson(a))}return t}static setProperty(e,t,i){return"colors"===t&&(e.colors=new Map,ry.forEach(i,(t,i)=>{e.colors.set(ry.parseEnum(i,tL),si.fromJson(t))}),!0)}}class r3{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>r3.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;if(t.set("staves",e.staves.map(e=>r0.toJson(e))),t.set("playbackinfo",r1.toJson(e.playbackInfo)),t.set("color",si.toJson(e.color)),t.set("name",e.name),t.set("isvisibleonmultitrack",e.isVisibleOnMultiTrack),t.set("shortname",e.shortName),t.set("defaultsystemslayout",e.defaultSystemsLayout),t.set("systemslayout",e.systemsLayout),void 0!==e.lineBreaks){let i=[];for(let s of(t.set("linebreaks",i),e.lineBreaks))i.push(s)}return t.set("percussionarticulations",e.percussionArticulations.map(e=>r2.toJson(e))),e.style&&t.set("style",r5.toJson(e.style)),t}static setProperty(e,t,i){switch(t){case"staves":for(let t of(e.staves=[],i)){let i=new sr;r0.fromJson(i,t),e.addStaff(i)}return!0;case"playbackinfo":return r1.fromJson(e.playbackInfo,i),!0;case"color":return e.color=si.fromJson(i),!0;case"name":return e.name=i,!0;case"isvisibleonmultitrack":return e.isVisibleOnMultiTrack=i,!0;case"shortname":return e.shortName=i,!0;case"defaultsystemslayout":return e.defaultSystemsLayout=i,!0;case"systemslayout":return e.systemsLayout=i,!0;case"linebreaks":for(let t of i)e.addLineBreaks(t);return!0;case"percussionarticulations":for(let t of(e.percussionArticulations=[],i)){let i=new iz;r2.fromJson(i,t),e.percussionArticulations.push(i)}return!0;case"style":return i?(e.style=new sn,r5.fromJson(e.style,i)):e.style=void 0,!0}return!1}}class r4{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>r4.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;if(t.set("hidedynamics",e.hideDynamics),t.set("bracketextendmode",e.bracketExtendMode),t.set("usesystemsignseparator",e.useSystemSignSeparator),t.set("globaldisplaytuning",e.globalDisplayTuning),null!==e.perTrackDisplayTuning){let i=new Map;for(let[s,a]of(t.set("pertrackdisplaytuning",i),e.perTrackDisplayTuning))i.set(s.toString(),a)}if(t.set("globaldisplaychorddiagramsontop",e.globalDisplayChordDiagramsOnTop),null!==e.perTrackChordDiagramsOnTop){let i=new Map;for(let[s,a]of(t.set("pertrackchorddiagramsontop",i),e.perTrackChordDiagramsOnTop))i.set(s.toString(),a)}if(t.set("singletracktracknamepolicy",e.singleTrackTrackNamePolicy),t.set("multitracktracknamepolicy",e.multiTrackTrackNamePolicy),t.set("firstsystemtracknamemode",e.firstSystemTrackNameMode),t.set("othersystemstracknamemode",e.otherSystemsTrackNameMode),t.set("firstsystemtracknameorientation",e.firstSystemTrackNameOrientation),t.set("othersystemstracknameorientation",e.otherSystemsTrackNameOrientation),t.set("multitrackmultibarrest",e.multiTrackMultiBarRest),null!==e.perTrackMultiBarRest){let i=[];for(let s of(t.set("pertrackmultibarrest",i),e.perTrackMultiBarRest))i.push(s)}return t}static setProperty(e,t,i){switch(t){case"hidedynamics":return e.hideDynamics=i,!0;case"bracketextendmode":return e.bracketExtendMode=ry.parseEnum(i,eY),!0;case"usesystemsignseparator":return e.useSystemSignSeparator=i,!0;case"globaldisplaytuning":return e.globalDisplayTuning=i,!0;case"pertrackdisplaytuning":return e.perTrackDisplayTuning=new Map,ry.forEach(i,(t,i)=>{e.perTrackDisplayTuning.set(Number.parseInt(i),t)}),!0;case"globaldisplaychorddiagramsontop":return e.globalDisplayChordDiagramsOnTop=i,!0;case"pertrackchorddiagramsontop":return e.perTrackChordDiagramsOnTop=new Map,ry.forEach(i,(t,i)=>{e.perTrackChordDiagramsOnTop.set(Number.parseInt(i),t)}),!0;case"singletracktracknamepolicy":return e.singleTrackTrackNamePolicy=ry.parseEnum(i,eq),!0;case"multitracktracknamepolicy":return e.multiTrackTrackNamePolicy=ry.parseEnum(i,eq),!0;case"firstsystemtracknamemode":return e.firstSystemTrackNameMode=ry.parseEnum(i,e$),!0;case"othersystemstracknamemode":return e.otherSystemsTrackNameMode=ry.parseEnum(i,e$),!0;case"firstsystemtracknameorientation":return e.firstSystemTrackNameOrientation=ry.parseEnum(i,ej),!0;case"othersystemstracknameorientation":return e.otherSystemsTrackNameOrientation=ry.parseEnum(i,ej),!0;case"multitrackmultibarrest":return e.multiTrackMultiBarRest=i,!0;case"pertrackmultibarrest":return e.perTrackMultiBarRest=new Set(i),!0}return!1}}class r6{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>r6.setProperty(e,i,t))}static toJson(e){return e?new Map:null}static setProperty(e,t,i){return!1}}class r8{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>r8.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("template",e.template),t.set("isvisible",e.isVisible),t.set("textalign",e.textAlign),t}static setProperty(e,t,i){switch(t){case"template":return e.template=i,!0;case"isvisible":return e.isVisible=i,!0;case"textalign":return e.textAlign=ry.parseEnum(i,tS),!0}return!1}}class r7{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>r7.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;{let i=new Map;for(let[s,a]of(t.set("headerandfooter",i),e.headerAndFooter))i.set(s.toString(),r8.toJson(a))}{let i=new Map;for(let[s,a]of(t.set("colors",i),e.colors))i.set(s.toString(),si.toJson(a))}return t}static setProperty(e,t,i){switch(t){case"headerandfooter":return e.headerAndFooter=new Map,ry.forEach(i,(t,i)=>{let s=new i2;r8.fromJson(s,t),e.headerAndFooter.set(ry.parseEnum(i,tD),s)}),!0;case"colors":return e.colors=new Map,ry.forEach(i,(t,i)=>{e.colors.set(ry.parseEnum(i,tD),si.fromJson(t))}),!0}return!1}}class r9{static fromJson(e,t){t&&ry.forEach(t,(t,i)=>r9.setProperty(e,i,t))}static toJson(e){if(!e)return null;let t=new Map;return t.set("album",e.album),t.set("artist",e.artist),t.set("copyright",e.copyright),t.set("instructions",e.instructions),t.set("music",e.music),t.set("notices",e.notices),t.set("subtitle",e.subTitle),t.set("title",e.title),t.set("words",e.words),t.set("tab",e.tab),t.set("tempo",e.tempo),t.set("tempolabel",e.tempoLabel),t.set("masterbars",e.masterBars.map(e=>rW.toJson(e))),t.set("tracks",e.tracks.map(e=>r3.toJson(e))),t.set("defaultsystemslayout",e.defaultSystemsLayout),t.set("systemslayout",e.systemsLayout),t.set("stylesheet",r4.toJson(e.stylesheet)),e.backingTrack&&t.set("backingtrack",r6.toJson(e.backingTrack)),e.style&&t.set("style",r7.toJson(e.style)),t}static setProperty(e,t,i){switch(t){case"album":return e.album=i,!0;case"artist":return e.artist=i,!0;case"copyright":return e.copyright=i,!0;case"instructions":return e.instructions=i,!0;case"music":return e.music=i,!0;case"notices":return e.notices=i,!0;case"subtitle":return e.subTitle=i,!0;case"title":return e.title=i,!0;case"words":return e.words=i,!0;case"tab":return e.tab=i,!0;case"tempo":return e.tempo=i,!0;case"tempolabel":return e.tempoLabel=i,!0;case"masterbars":for(let t of(e.masterBars=[],i)){let i=new iL;rW.fromJson(i,t),e.addMasterBar(i)}return!0;case"tracks":for(let t of(e.tracks=[],i)){let i=new so;r3.fromJson(i,t),e.addTrack(i)}return!0;case"defaultsystemslayout":return e.defaultSystemsLayout=i,!0;case"systemslayout":return e.systemsLayout=i,!0;case"stylesheet":return r4.fromJson(e.stylesheet,i),!0;case"backingtrack":return i?(e.backingTrack=new sT,r6.fromJson(e.backingTrack,i)):e.backingTrack=void 0,!0;case"style":return i?(e.style=new i5,r7.fromJson(e.style,i)):e.style=void 0,!0}return!1}}class ne{static jsonReplacer(e,t){if(t instanceof Map){if("fromEntries"in Object)return Object.fromEntries(t);let e={};for(let[i,s]of t)e[i]=s;return e}return ArrayBuffer.isView(t)?Array.apply([],[t]):t}static scoreToJson(e){return JSON.stringify(ne.scoreToJsObject(e),ne.jsonReplacer)}static jsonToScore(e,t){return ne.jsObjectToScore(JSON.parse(e),t)}static scoreToJsObject(e){return r9.toJson(e)}static jsObjectToScore(e,t){let i=new i3;return r9.fromJson(i,e),i.finish(t??new rA),i}static settingsToJson(e){return JSON.stringify(ne.settingsToJsObject(e),ne.jsonReplacer)}static jsonToSettings(e){return ne.jsObjectToSettings(JSON.parse(e))}static settingsToJsObject(e){return rI.toJson(e)}static jsObjectToSettings(e){let t=new rA;return rI.fromJson(t,e),t}static jsObjectToMidiFile(e){let t=new s2;return ry.forEach(e,(e,i)=>{switch(i){case"division":t.division=e;break;case"tracks":for(let i of e){let e=ne.jsObjectToMidiTrack(i);t.tracks.push(e)}}}),t}static jsObjectToMidiTrack(e){let t=new s1;return ry.forEach(e,(e,i)=>{if("events"===i)for(let i of e){let e=ne.jsObjectToMidiEvent(i);t.events.push(e)}}),t}static jsObjectToMidiEvent(e){let t=ry.getValue(e,"track"),i=ry.getValue(e,"tick"),s=ry.getValue(e,"type");switch(s){case tq.TimeSignature:return new s3(t,i,ry.getValue(e,"numerator"),ry.getValue(e,"denominatorIndex"),ry.getValue(e,"midiClocksPerMetronomeClick"),ry.getValue(e,"thirdySecondNodesInQuarter"));case tq.AlphaTabRest:return new s8(t,i,ry.getValue(e,"channel"));case tq.AlphaTabMetronome:return new s6(t,i,ry.getValue(e,"metronomeNumerator"),ry.getValue(e,"metronomeDurationInTicks"),ry.getValue(e,"metronomeDurationInMilliseconds"));case tq.NoteOn:return new s9(t,i,ry.getValue(e,"channel"),ry.getValue(e,"noteKey"),ry.getValue(e,"noteVelocity"));case tq.NoteOff:return new ae(t,i,ry.getValue(e,"channel"),ry.getValue(e,"noteKey"),ry.getValue(e,"noteVelocity"));case tq.ControlChange:return new at(t,i,ry.getValue(e,"channel"),ry.getValue(e,"controller"),ry.getValue(e,"value"));case tq.ProgramChange:return new ai(t,i,ry.getValue(e,"channel"),ry.getValue(e,"program"));case tq.TempoChange:let a=new as(i,0);return a.beatsPerMinute=ry.getValue(e,"beatsPerMinute"),a;case tq.PitchBend:return new aa(t,i,ry.getValue(e,"channel"),ry.getValue(e,"value"));case tq.PerNotePitchBend:return new ar(t,i,ry.getValue(e,"channel"),ry.getValue(e,"noteKey"),ry.getValue(e,"value"));case tq.EndOfTrack:return new an(t,i)}throw new i6(tE.Format,`Unknown Midi Event type: ${s}`)}static midiFileToJsObject(e){let t=new Map;t.set("division",e.division);let i=[];for(let t of e.tracks)i.push(ne.midiTrackToJsObject(t));return t.set("tracks",i),t}static midiTrackToJsObject(e){let t=new Map,i=[];for(let t of e.events)i.push(ne.midiEventToJsObject(t));return t.set("events",i),t}static midiEventToJsObject(e){let t=new Map;switch(t.set("track",e.track),t.set("tick",e.tick),t.set("type",e.type),e.type){case tq.TimeSignature:t.set("numerator",e.numerator),t.set("denominatorIndex",e.denominatorIndex),t.set("midiClocksPerMetronomeClick",e.midiClocksPerMetronomeClick),t.set("thirdySecondNodesInQuarter",e.thirtySecondNodesInQuarter);break;case tq.AlphaTabRest:t.set("channel",e.channel);break;case tq.AlphaTabMetronome:t.set("metronomeNumerator",e.metronomeNumerator),t.set("metronomeDurationInMilliseconds",e.metronomeDurationInMilliseconds),t.set("metronomeDurationInTicks",e.metronomeDurationInTicks);break;case tq.NoteOn:case tq.NoteOff:t.set("channel",e.channel),t.set("noteKey",e.noteKey),t.set("noteVelocity",e.noteVelocity);break;case tq.ControlChange:t.set("channel",e.channel),t.set("controller",e.controller),t.set("value",e.value);break;case tq.ProgramChange:t.set("channel",e.channel),t.set("program",e.program);break;case tq.TempoChange:t.set("beatsPerMinute",e.beatsPerMinute);break;case tq.PitchBend:t.set("channel",e.channel),t.set("value",e.value);break;case tq.PerNotePitchBend:t.set("channel",e.channel),t.set("noteKey",e.noteKey),t.set("value",e.value);case tq.EndOfTrack:}return t}}class nt{constructor(){this.ready=new rl,this.samplesPlayed=new rh,this.sampleRequest=new rl}get sampleRate(){return nt.preferredSampleRate}open(){iM.debug("AlphaSynth","Initializing synth worker"),this._worker=dE.globalThis,this._worker.addEventListener("message",this.handleMessage.bind(this)),this.ready.trigger()}destroy(){this._worker.postMessage({cmd:"alphaSynth.output.destroy"})}handleMessage(e){let t=e.data;switch(t.cmd){case nt.CmdOutputSampleRequest:this.sampleRequest.trigger();break;case nt.CmdOutputSamplesPlayed:this.samplesPlayed.trigger(t.samples)}}addSamples(e){this._worker.postMessage({cmd:"alphaSynth.output.addSamples",samples:dE.prepareForPostMessage(e)})}play(){this._worker.postMessage({cmd:"alphaSynth.output.play"})}pause(){this._worker.postMessage({cmd:"alphaSynth.output.pause"})}resetSamples(){this._worker.postMessage({cmd:"alphaSynth.output.resetSamples"})}activate(){}async enumerateOutputDevices(){return[]}async setOutputDevice(e){}async getOutputDevice(){return null}}nt.CmdOutputPrefix="alphaSynth.output.",nt.CmdOutputAddSamples=`${nt.CmdOutputPrefix}addSamples`,nt.CmdOutputPlay=`${nt.CmdOutputPrefix}play`,nt.CmdOutputPause=`${nt.CmdOutputPrefix}pause`,nt.CmdOutputResetSamples=`${nt.CmdOutputPrefix}resetSamples`,nt.CmdOutputStop=`${nt.CmdOutputPrefix}stop`,nt.CmdOutputSampleRequest=`${nt.CmdOutputPrefix}sampleRequest`,nt.CmdOutputSamplesPlayed=`${nt.CmdOutputPrefix}samplesPlayed`,nt.preferredSampleRate=0;class ni{constructor(e,t){this._exporter=new Map,this._main=e,this._main.addEventListener("message",this.handleMessage.bind(this)),this._player=new rg(new nt,t),this._player.positionChanged.on(this.onPositionChanged.bind(this)),this._player.stateChanged.on(this.onPlayerStateChanged.bind(this)),this._player.finished.on(this.onFinished.bind(this)),this._player.soundFontLoaded.on(this.onSoundFontLoaded.bind(this)),this._player.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this._player.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this._player.midiLoaded.on(this.onMidiLoaded.bind(this)),this._player.midiLoadFailed.on(this.onMidiLoadFailed.bind(this)),this._player.readyForPlayback.on(this.onReadyForPlayback.bind(this)),this._player.midiEventsPlayed.on(this.onMidiEventsPlayed.bind(this)),this._player.playbackRangeChanged.on(this.onPlaybackRangeChanged.bind(this)),this._main.postMessage({cmd:"alphaSynth.ready"})}static init(){let e=dE.globalThis;e.addEventListener("message",t=>{let i=t.data;"alphaSynth.initialize"===i.cmd&&(nt.preferredSampleRate=i.sampleRate,iM.logLevel=i.logLevel,dE.globalThis.alphaSynthWebWorker=new ni(e,i.bufferTimeInMilliseconds))})}handleMessage(e){let t=e.data,i=t.cmd;switch(i){case"alphaSynth.setLogLevel":iM.logLevel=t.value;break;case"alphaSynth.setMasterVolume":this._player.masterVolume=t.value;break;case"alphaSynth.setMetronomeVolume":this._player.metronomeVolume=t.value;break;case"alphaSynth.setPlaybackSpeed":this._player.playbackSpeed=t.value;break;case"alphaSynth.setTickPosition":this._player.tickPosition=t.value;break;case"alphaSynth.setTimePosition":this._player.timePosition=t.value;break;case"alphaSynth.setPlaybackRange":this._player.playbackRange=t.value;break;case"alphaSynth.setIsLooping":this._player.isLooping=t.value;break;case"alphaSynth.setCountInVolume":this._player.countInVolume=t.value;break;case"alphaSynth.setMidiEventsPlayedFilter":this._player.midiEventsPlayedFilter=t.value;break;case"alphaSynth.play":this._player.play();break;case"alphaSynth.pause":this._player.pause();break;case"alphaSynth.playPause":this._player.playPause();break;case"alphaSynth.stop":this._player.stop();break;case"alphaSynth.playOneTimeMidiFile":this._player.playOneTimeMidiFile(ne.jsObjectToMidiFile(t.midi));break;case"alphaSynth.loadSoundFontBytes":this._player.loadSoundFont(t.data,t.append);break;case"alphaSynth.resetSoundFonts":this._player.resetSoundFonts();break;case"alphaSynth.loadMidi":this._player.loadMidiFile(ne.jsObjectToMidiFile(t.midi));break;case"alphaSynth.setChannelMute":this._player.setChannelMute(t.channel,t.mute);break;case"alphaSynth.setChannelTranspositionPitch":this._player.setChannelTranspositionPitch(t.channel,t.semitones);break;case"alphaSynth.setChannelSolo":this._player.setChannelSolo(t.channel,t.solo);break;case"alphaSynth.setChannelVolume":this._player.setChannelVolume(t.channel,t.volume);break;case"alphaSynth.resetChannelStates":this._player.resetChannelStates();break;case"alphaSynth.destroy":this._player.destroy(),this._main.postMessage({cmd:"alphaSynth.destroyed"});break;case"alphaSynth.applyTranspositionPitches":this._player.applyTranspositionPitches(new Map(JSON.parse(t.transpositionPitches)))}i.startsWith("alphaSynth.exporter")&&this.handleExporterMessage(e)}handleExporterMessage(e){let t=e.data,i=t.cmd;try{switch(i){case"alphaSynth.exporter.initialize":let e=this._player.exportAudio(t.options,ne.jsObjectToMidiFile(t.midi),t.syncPoints,t.transpositionPitches);this._exporter.set(t.exporterId,e),this._main.postMessage({cmd:"alphaSynth.exporter.initialized",exporterId:t.exporterId});break;case"alphaSynth.exporter.render":if(this._exporter.has(t.exporterId)){let e=this._exporter.get(t.exporterId).render(t.milliseconds);this._main.postMessage({cmd:"alphaSynth.exporter.rendered",exporterId:t.exporterId,chunk:e})}else this._main.postMessage({cmd:"alphaSynth.exporter.error",exporterId:t.exporterId,error:Error("Unknown exporter ID")});break;case"alphaSynth.exporter.destroy":this._exporter.delete(t.exporterId)}}catch(e){this._main.postMessage({cmd:"alphaSynth.exporter.error",exporterId:t.exporterId,error:e})}}onPositionChanged(e){this._main.postMessage({cmd:"alphaSynth.positionChanged",currentTime:e.currentTime,endTime:e.endTime,currentTick:e.currentTick,endTick:e.endTick,isSeek:e.isSeek,originalTempo:e.originalTempo,modifiedTempo:e.modifiedTempo})}onPlayerStateChanged(e){this._main.postMessage({cmd:"alphaSynth.playerStateChanged",state:e.state,stopped:e.stopped})}onFinished(){this._main.postMessage({cmd:"alphaSynth.finished"})}onSoundFontLoaded(){this._main.postMessage({cmd:"alphaSynth.soundFontLoaded"})}onSoundFontLoadFailed(e){this._main.postMessage({cmd:"alphaSynth.soundFontLoadFailed",error:this.serializeException(dE.prepareForPostMessage(e))})}serializeException(e){let t=JSON.parse(JSON.stringify(e));return e.message&&(t.message=e.message),e.stack&&(t.stack=e.stack),e.constructor&&e.constructor.name&&(t.type=e.constructor.name),t}onMidiLoaded(e){this._main.postMessage({cmd:"alphaSynth.midiLoaded",currentTime:e.currentTime,endTime:e.endTime,currentTick:e.currentTick,endTick:e.endTick,isSeek:e.isSeek,originalTempo:e.originalTempo,modifiedTempo:e.modifiedTempo})}onMidiLoadFailed(e){this._main.postMessage({cmd:"alphaSynth.midiLoaded",error:this.serializeException(dE.prepareForPostMessage(e))})}onReadyForPlayback(){this._main.postMessage({cmd:"alphaSynth.readyForPlayback"})}onMidiEventsPlayed(e){this._main.postMessage({cmd:"alphaSynth.midiEventsPlayed",events:e.events.map(ne.midiEventToJsObject)})}onPlaybackRangeChanged(e){this._main.postMessage({cmd:"alphaSynth.playbackRangeChanged",playbackRange:e.playbackRange})}}(eF=t9||(t9={}))[eF.Browser=0]="Browser",eF[eF.NodeJs=1]="NodeJs",eF[eF.BrowserModule=2]="BrowserModule";class ns{constructor(e,t){this.characterWidths=e,this.fontSizeToHeight=t}}class na{static generateFontLookup(e){if(!na.FontSizeLookupTables.has(e))if(dE.isRunningInWorker||dE.webPlatform===t9.NodeJs){let t=new ns(new Uint8Array([8]),1.2);na.FontSizeLookupTables.set(e,t)}else{let t=document.createElement("canvas").getContext("2d");t.font=`11px ${e}`;let i=[],s="";for(let e=na.ControlChars;e<255;e++){let a=String.fromCharCode(e);s+=a;let r=t.measureText(a);i.push(r.width)}let a=t.measureText(`${s}\xc4\xd6\xdc\xc1\xc8`),r=0-Math.abs(a.fontBoundingBoxAscent),n=0+Math.abs(a.fontBoundingBoxDescent),o=new ns(new Uint8Array(i),(n-r)/11);na.FontSizeLookupTables.set(e,o)}}static measureString(e,t,i,s,a){let r,n=t[0];for(let e=0;e<t.length;e++)if(na.FontSizeLookupTables.has(t[e])){n=t[e];break}na.FontSizeLookupTables.has(n)||na.generateFontLookup(n),r=na.FontSizeLookupTables.get(n);let o=1;s===t5.Italic&&(o*=1.1),a===t3.Bold&&(o*=1.1);let l=0;for(let t=0;t<e.length;t++){let s=Math.min(r.characterWidths.length-1,e.charCodeAt(t)-na.ControlChars);s>=0&&(l+=r.characterWidths[s]*i/11)}return new iG(l*(o*=1.07),i*r.fontSizeToHeight)}}na.FontSizeLookupTables=new Map,na.ControlChars=32;class nr{constructor(){this.id=iW.newGuid(),this.x=0,this.y=0,this.width=0,this.height=0,this.totalWidth=0,this.totalHeight=0,this.firstMasterBarIndex=-1,this.lastMasterBarIndex=-1,this.renderResult=null}}class nn{constructor(){this.beats=[]}addBeat(e){e.barBounds=this,this.beats.push(e),this.masterBarBounds.addBeat(e)}findBeatAtPos(e){let t=null;for(let i of this.beats)if(!t||i.realBounds.x<e)t=i;else if(i.realBounds.x>e)break;return t}finish(e=1){for(let t of(this.realBounds.scaleWith(e),this.visualBounds.scaleWith(e),this.beats.sort((e,t)=>e.realBounds.x-t.realBounds.x),this.beats))t.finish(e)}}class no{constructor(){this.onNotesX=0,this.notes=null}addNote(e){this.notes||(this.notes=[]),e.beatBounds=this,this.notes.push(e)}findNoteAtPos(e,t){let i=this.notes;if(!i)return null;for(let s of i){let i=s.noteHeadBounds.y+s.noteHeadBounds.h,a=s.noteHeadBounds.x+s.noteHeadBounds.w;if(s.noteHeadBounds.x<=e&&s.noteHeadBounds.y<=t&&e<=a&&t<=i)return s.note}return null}finish(e=1){if(this.realBounds.scaleWith(e),this.visualBounds.scaleWith(e),this.onNotesX*=e,this.notes)for(let t of this.notes)t.finish(e)}}class nl{constructor(){this.index=0,this.isFirstOfLine=!1,this.bars=[],this.staffSystemBounds=null}get staveGroupBounds(){return this.staffSystemBounds}addBar(e){e.masterBarBounds=this,this.bars.push(e)}findBeatAtPos(e,t){let i=null;for(let t of this.bars){let s=t.findBeatAtPos(e);if(s&&(!i||i.realBounds.x<s.realBounds.x)){let t=Math.abs(s.realBounds.x-e);(!i||t<1e7)&&(i=s)}}return i?i.beat:null}finish(e=1){for(let t of(this.realBounds.scaleWith(e),this.visualBounds.scaleWith(e),this.lineAlignedBounds.scaleWith(e),this.bars.sort((e,t)=>e.realBounds.y<t.realBounds.y?-1:e.realBounds.y>t.realBounds.y?1:e.realBounds.x<t.realBounds.x?-1:+(e.realBounds.x>t.realBounds.x)),this.bars))t.finish(e)}addBeat(e){this.staffSystemBounds.boundsLookup.addBeat(e)}}class nh{finish(e=1){this.noteHeadBounds.scaleWith(e)}}class nd{constructor(){this.index=0,this.bars=[]}finish(e=1){for(let t of(this.realBounds.scaleWith(e),this.visualBounds.scaleWith(e),this.bars))t.finish(e)}addBar(e){this.boundsLookup.addMasterBar(e),e.staffSystemBounds=this,this.bars.push(e)}findBarAtPos(e){let t=null;for(let i of this.bars)if(!t||i.realBounds.x<e)t=i;else if(e>i.realBounds.x+i.realBounds.w)break;return t}}class nc{constructor(){this._beatLookup=new Map,this._masterBarLookup=new Map,this._currentStaffSystem=null,this.staffSystems=[],this.isFinished=!1}toJson(){let e={},t=[];for(let i of(e.staffSystems=t,this.staffSystems)){let e={};for(let t of(e.visualBounds=this.boundsToJson(i.visualBounds),e.realBounds=this.boundsToJson(i.realBounds),e.bars=[],i.bars)){let i={};for(let e of(i.lineAlignedBounds=this.boundsToJson(t.lineAlignedBounds),i.visualBounds=this.boundsToJson(t.visualBounds),i.realBounds=this.boundsToJson(t.realBounds),i.index=t.index,i.bars=[],t.bars)){let t={};for(let i of(t.visualBounds=this.boundsToJson(e.visualBounds),t.realBounds=this.boundsToJson(e.realBounds),t.beats=[],e.beats)){let e={};if(e.visualBounds=this.boundsToJson(i.visualBounds),e.realBounds=this.boundsToJson(i.realBounds),e.onNotesX=i.onNotesX,e.beatIndex=i.beat.index,e.voiceIndex=i.beat.voice.index,e.barIndex=i.beat.voice.bar.index,e.staffIndex=i.beat.voice.bar.staff.index,e.trackIndex=i.beat.voice.bar.staff.track.index,i.notes){let t=[];for(let s of(e.notes=t,i.notes)){let e={};e.index=s.note.index,e.noteHeadBounds=this.boundsToJson(s.noteHeadBounds),t.push(e)}}t.beats.push(e)}i.bars.push(t)}e.bars.push(i)}t.push(e)}return e}static fromJson(e,t){let i=new nc;for(let s of e.staffSystems){let e=new nd;for(let a of(e.visualBounds=nc.boundsFromJson(s.visualBounds),e.realBounds=nc.boundsFromJson(s.realBounds),i.addStaffSystem(e),s.bars)){let i=new nl;for(let s of(i.index=a.index,i.isFirstOfLine=a.isFirstOfLine,i.lineAlignedBounds=nc.boundsFromJson(a.lineAlignedBounds),i.visualBounds=nc.boundsFromJson(a.visualBounds),i.realBounds=nc.boundsFromJson(a.realBounds),e.addBar(i),a.bars)){let e=new nn;for(let a of(e.visualBounds=nc.boundsFromJson(s.visualBounds),e.realBounds=nc.boundsFromJson(s.realBounds),i.addBar(e),s.beats)){let i=new no;if(i.visualBounds=nc.boundsFromJson(a.visualBounds),i.realBounds=nc.boundsFromJson(a.realBounds),i.onNotesX=a.onNotesX,i.beat=t.tracks[a.trackIndex].staves[a.staffIndex].bars[a.barIndex].voices[a.voiceIndex].beats[a.beatIndex],a.notes)for(let e of(i.notes=[],a.notes)){let t=new nh;t.note=i.beat.notes[e.index],t.noteHeadBounds=nc.boundsFromJson(e.noteHeadBounds),i.addNote(t)}e.addBeat(i)}}}}return i}static boundsFromJson(e){let t=new sy;return t.x=e.x,t.y=e.y,t.w=e.w,t.h=e.h,t}boundsToJson(e){let t={};return t.x=e.x,t.y=e.y,t.w=e.w,t.h=e.h,t}finish(e=1){for(let t of this.staffSystems)t.finish(e);this.isFinished=!0}addStaffSystem(e){e.index=this.staffSystems.length,e.boundsLookup=this,this.staffSystems.push(e),this._currentStaffSystem=e}addMasterBar(e){e.staffSystemBounds?this._masterBarLookup.set(e.index,e):(e.staffSystemBounds=this._currentStaffSystem,this._masterBarLookup.set(e.index,e),this._currentStaffSystem.addBar(e))}addBeat(e){this._beatLookup.has(e.beat.id)||this._beatLookup.set(e.beat.id,[]),this._beatLookup.get(e.beat.id)?.push(e)}findMasterBarByIndex(e){return this._masterBarLookup.has(e)?this._masterBarLookup.get(e):null}findMasterBar(e){let t=e.index;return this._masterBarLookup.has(t)?this._masterBarLookup.get(t):null}findBeat(e){let t=this.findBeats(e);return t?t[0]:null}findBeats(e){let t=e.id;return this._beatLookup.has(t)?this._beatLookup.get(t):null}getBeatAtPos(e,t){let i=0,s=this.staffSystems.length-1,a=-1;for(;i<=s;){let e=(s+i)/2|0,r=this.staffSystems[e];if(t>=r.realBounds.y&&t<=r.realBounds.y+r.realBounds.h){a=e;break}t<r.realBounds.y?s=e-1:i=e+1}if(-1===a)return null;let r=this.staffSystems[a].findBarAtPos(e);return r?r.findBeatAtPos(e,t):null}getNoteAtPos(e,t,i){let s=this.findBeats(e);if(s)for(let e of s){let s=e.findNoteAtPos(t,i);if(s)return s}return null}}class nu{constructor(e){this._currentLayoutMode=eX.Page,this._currentRenderEngine=null,this._renderedTracks=null,this.canvas=null,this.score=null,this.tracks=null,this.layout=null,this.boundsLookup=null,this.width=0,this.preRender=new rh,this.renderFinished=new rh,this.partialRenderFinished=new rh,this.partialLayoutFinished=new rh,this.postRenderFinished=new rl,this.error=new rh,this.settings=e,this.recreateCanvas(),this.recreateLayout()}destroy(){this.score=null,this.canvas?.destroy(),this.canvas=null,this.layout=null,this.boundsLookup=null,this.tracks=null}recreateCanvas(){return this._currentRenderEngine!==this.settings.core.engine&&(this.canvas?.destroy(),this.canvas=dE.getRenderEngineFactory(this.settings.core.engine).createCanvas(),this._currentRenderEngine=this.settings.core.engine,!0)}recreateLayout(){return(!this.layout||this._currentLayoutMode!==this.settings.display.layoutMode)&&(this.layout=dE.getLayoutEngineFactory(this.settings.display.layoutMode).createLayout(this),this._currentLayoutMode=this.settings.display.layoutMode,!0)}renderScore(e,t){try{this.score=e;let i=null;if(null!=e&&null!=t){if(t)for(let s of(i=[],t))s>=0&&s<e.tracks.length&&i.push(e.tracks[s]);else i=e.tracks.slice(0);0===i.length&&e.tracks.length>0&&i.push(e.tracks[0])}this.tracks=i,this.render()}catch(e){this.error.trigger(e)}}renderTracks(e){0===e.length?this.score=null:this.score=e[0].score,this.tracks=e,this.render()}updateSettings(e){this.settings=e}renderResult(e){try{let t=this.layout;t?(iM.debug("Rendering",`Request render of lazy partial ${e}`),t.renderLazyPartial(e)):iM.warning("Rendering",`Request render of lazy partial ${e} ignored, no layout exists`)}catch(e){this.error.trigger(e)}}render(){if(0===this.width)return void iM.warning("Rendering","AlphaTab skipped rendering because of width=0 (element invisible)",null);if(this.boundsLookup=new nc,this.recreateCanvas(),this.canvas.lineWidth=1,this.canvas.settings=this.settings,this.tracks&&0!==this.tracks.length&&this.score){iM.debug("Rendering",`Rendering ${this.tracks.length} tracks`);for(let e=0;e<this.tracks.length;e++){let t=this.tracks[e];iM.debug("Rendering",`Track ${e}: ${t.name}`)}this.preRender.trigger(!1),this.recreateLayout(),this.layoutAndRender(),iM.debug("Rendering","Rendering finished")}else iM.debug("Rendering","Clearing rendered tracks because no score or tracks are set"),this.preRender.trigger(!1),this._renderedTracks=null,this.onRenderFinished(),this.postRenderFinished.trigger(),iM.debug("Rendering","Clearing finished")}resizeRender(){this.recreateLayout()||this.recreateCanvas()||this._renderedTracks!==this.tracks||!this.tracks?(iM.debug("Rendering","Starting full rerendering due to layout or canvas change",null),this.render()):this.layout.supportsResize?(iM.debug("Rendering","Starting optimized rerendering for resize"),this.boundsLookup=new nc,this.preRender.trigger(!0),this.canvas.settings=this.settings,this.layout.resize(),this.onRenderFinished(),this.postRenderFinished.trigger()):iM.debug("Rendering","Current layout does not support dynamic resizing, nothing was done",null),iM.debug("Rendering","Resize finished")}layoutAndRender(){iM.debug("Rendering",`Rendering at scale ${this.settings.display.scale} with layout ${this.layout.name}`,null),this.layout.layoutAndRender(),this._renderedTracks=this.tracks,this.onRenderFinished(),this.postRenderFinished.trigger()}onRenderFinished(){this.boundsLookup?.finish(this.settings.display.scale);let e=new nr;e.totalHeight=this.layout.height,e.totalWidth=this.layout.width,e.renderResult=this.canvas.onRenderFinished(),this.renderFinished.trigger(e)}}class np{constructor(e){this._main=e,this._main.addEventListener("message",this.handleMessage.bind(this),!1)}static init(){dE.globalThis.alphaTabWebWorker=new np(dE.globalThis)}handleMessage(e){let t=e.data;switch(t?t.cmd:""){case"alphaTab.initialize":let i=ne.jsObjectToSettings(t.settings);iM.logLevel=i.core.logLevel,this._renderer=new nu(i),this._renderer.partialRenderFinished.on(e=>{this._main.postMessage({cmd:"alphaTab.partialRenderFinished",result:e})}),this._renderer.partialLayoutFinished.on(e=>{this._main.postMessage({cmd:"alphaTab.partialLayoutFinished",result:e})}),this._renderer.renderFinished.on(e=>{this._main.postMessage({cmd:"alphaTab.renderFinished",result:e})}),this._renderer.postRenderFinished.on(()=>{this._main.postMessage({cmd:"alphaTab.postRenderFinished",boundsLookup:this._renderer.boundsLookup?.toJson()??null})}),this._renderer.preRender.on(e=>{this._main.postMessage({cmd:"alphaTab.preRender",resize:e})}),this._renderer.error.on(this.error.bind(this));break;case"alphaTab.invalidate":this._renderer.render();break;case"alphaTab.resizeRender":this._renderer.resizeRender();break;case"alphaTab.renderResult":this._renderer.renderResult(t.resultId);break;case"alphaTab.setWidth":this._renderer.width=t.width;break;case"alphaTab.renderScore":this.updateFontSizes(t.fontSizes);let s=null==t.score?null:ne.jsObjectToScore(t.score,this._renderer.settings);this.renderMultiple(s,t.trackIndexes);break;case"alphaTab.updateSettings":this.updateSettings(t.settings)}}updateFontSizes(e){if(!(e instanceof Map)){let t=e;for(let i in e=new Map,t)e.set(i,t[i])}if(e)for(let[t,i]of(na.FontSizeLookupTables||(na.FontSizeLookupTables=new Map),e))na.FontSizeLookupTables.set(t,i)}updateSettings(e){rI.fromJson(this._renderer.settings,e)}renderMultiple(e,t){try{this._renderer.renderScore(e,t)}catch(e){this.error(e)}}error(e){iM.error("Worker","An unexpected error occurred in worker",e),this._main.postMessage({cmd:"alphaTab.error",error:e})}}class nm{constructor(){this._canvas=null,this._color=new si(0,0,0,255),this._font=new r_("Arial",10,t5.Plain),this._lineWidth=0,this._measureCanvas=document.createElement("canvas"),this._measureCanvas.width=10,this._measureCanvas.height=10,this._measureCanvas.style.width="10px",this._measureCanvas.style.height="10px",this._measureContext=this._measureCanvas.getContext("2d"),this._measureContext.textBaseline="hanging"}destroy(){}onRenderFinished(){return null}beginRender(e,t){this._musicFont=this.settings.display.resources.smuflFont;let i=this.settings.display.scale;this._canvas=document.createElement("canvas"),this._canvas.width=e*dE.HighDpiFactor|0,this._canvas.height=t*dE.HighDpiFactor|0,this._canvas.style.width=`${e}px`,this._canvas.style.height=`${t}px`,this._context=this._canvas.getContext("2d"),this._context.textBaseline="hanging",this._context.scale(dE.HighDpiFactor*i,dE.HighDpiFactor*i),this._context.lineWidth=this._lineWidth}endRender(){let e=this._canvas;return this._canvas=null,e}get color(){return this._color}set color(e){this._color.rgba!==e.rgba&&(this._color=e,this._context.strokeStyle=e.rgba,this._context.fillStyle=e.rgba)}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this._context&&(this._context.lineWidth=e)}fillRect(e,t,i,s){i>0&&this._context.fillRect(0|e,0|t,i,s)}strokeRect(e,t,i,s){let a=.5*(this.lineWidth%2!=0);this._context.strokeRect((0|e)+a,(0|t)+a,i,s)}beginPath(){this._context.beginPath()}closePath(){this._context.closePath()}moveTo(e,t){this._context.moveTo(e,t)}lineTo(e,t){this._context.lineTo(e,t)}quadraticCurveTo(e,t,i,s){this._context.quadraticCurveTo(e,t,i,s)}bezierCurveTo(e,t,i,s,a,r){this._context.bezierCurveTo(e,t,i,s,a,r)}fillCircle(e,t,i){this._context.beginPath(),this._context.arc(e,t,i,0,2*Math.PI,!0),this.fill()}strokeCircle(e,t,i){this._context.beginPath(),this._context.arc(e,t,i,0,2*Math.PI,!0),this.stroke()}fill(){this._context.fill(),this._context.beginPath()}stroke(){this._context.stroke(),this._context.beginPath()}get font(){return this._font}set font(e){this._font=e,this._context&&(this._context.font=e.toCssString(1)),this._measureContext.font=e.toCssString(1)}get textAlign(){switch(this._context.textAlign){case"left":default:return tS.Left;case"center":return tS.Center;case"right":return tS.Right}}set textAlign(e){switch(e){case tS.Left:this._context.textAlign="left";break;case tS.Center:this._context.textAlign="center";break;case tS.Right:this._context.textAlign="right"}}get textBaseline(){switch(this._context.textBaseline){case"hanging":default:return t_.Top;case"middle":return t_.Middle;case"bottom":return t_.Bottom}}set textBaseline(e){switch(e){case t_.Top:this._context.textBaseline="hanging";break;case t_.Middle:this._context.textBaseline="middle";break;case t_.Bottom:this._context.textBaseline="bottom"}}beginGroup(e){}endGroup(){}fillText(e,t,i){this._context.fillText(e,t,i)}measureText(e){let t=this._measureContext.measureText(e);return new iG(t.width,t.actualBoundingBoxDescent+t.actualBoundingBoxAscent)}fillMusicFontSymbol(e,t,i,s,a=!1){s!==tb.None&&this.fillMusicFontSymbolText(e,t,i,String.fromCharCode(s),a)}fillMusicFontSymbols(e,t,i,s,a=!1){let r="";for(let e of s)e!==tb.None&&(r+=String.fromCharCode(e));this.fillMusicFontSymbolText(e,t,i,r,a)}fillMusicFontSymbolText(e,t,i,s,a){let r=this._context.textAlign,n=this._context.textBaseline,o=this._context.font;this._context.font=this._musicFont.toCssString(i),this._context.textBaseline="middle",a?this._context.textAlign="center":this._context.textAlign="left",this._context.fillText(s,e,t),this._context.textBaseline=n,this._context.font=o,this._context.textAlign=r}beginRotate(e,t,i){this._context.save(),this._context.translate(e,t),this._context.rotate(i*Math.PI/180)}endRotate(){this._context.restore()}}class ng{constructor(e,t=!1){this._midiFile=e,this._smf1Mode=t}addTimeSignature(e,t,i){let s=0,a=i;for(;;)if((a>>=1)>0)s++;else break;this._midiFile.addEvent(new s3(0,e,t,s,48,8))}addRest(e,t,i){this._smf1Mode||this._midiFile.addEvent(new s8(e,t,i))}addNote(e,t,i,s,a,r){this._midiFile.addEvent(new s9(e,t,r,ng.fixValue(s),ng.fixValue(a))),this._midiFile.addEvent(new ae(e,t+i,r,ng.fixValue(s),ng.fixValue(a)))}static fixValue(e){return e>127?127:e<0?0:e}addControlChange(e,t,i,s,a){this._midiFile.addEvent(new at(e,t,i,s,ng.fixValue(a)))}addProgramChange(e,t,i,s){this._midiFile.addEvent(new ai(e,t,i,s))}addTempo(e,t){let i=new as(e,0);i.beatsPerMinute=t,this._midiFile.addEvent(i)}addBend(e,t,i,s){s=s>=iI.MaxPitchWheel?iI.MaxPitchWheel:Math.floor(s),this._midiFile.addEvent(new aa(e,t,i,s))}addNoteBend(e,t,i,s,a){this._smf1Mode?this.addBend(e,t,i,a):(a=a*iI.MaxPitchWheel20/iI.MaxPitchWheel,this._midiFile.addEvent(new ar(e,t,i,s,a)))}finishTrack(e,t){(this._midiFile.format===tY.MultiTrack||0===e)&&this._midiFile.addEvent(new an(e,t))}}class nf{constructor(e,t){this.closingIndex=0,this.group=e,this.opening=t,e.closings=e.closings.sort((e,t)=>e.index-t.index),this.iterations=e.closings.map(e=>0)}}(eC=ie||(ie={}))[eC.PlayingNormally=0]="PlayingNormally",eC[eC.DirectionJumped=1]="DirectionJumped",eC[eC.DirectionJumpedAlCoda=2]="DirectionJumpedAlCoda",eC[eC.DirectionJumpedAlDoubleCoda=3]="DirectionJumpedAlDoubleCoda",eC[eC.DirectionJumpedAlFine=4]="DirectionJumpedAlFine";class ny{get finished(){return this.index>=this._score.masterBars.length}constructor(e){this._repeatStack=[],this._groupsOnStack=new Set,this._previousAlternateEndings=0,this._state=ie.PlayingNormally,this.shouldPlay=!0,this.index=0,this.currentTick=0,this._score=e}processCurrent(){let e=this._score.masterBars[this.index];if(this._state===ie.PlayingNormally){let t=e.alternateEndings;if(0===t&&(t=this._previousAlternateEndings),e===e.repeatGroup.opening&&e.repeatGroup.isClosed&&!this._groupsOnStack.has(e.repeatGroup)){let i=new nf(e.repeatGroup,e);this._repeatStack.push(i),this._groupsOnStack.add(e.repeatGroup),this._previousAlternateEndings=0,t=e.alternateEndings}if(0===this._repeatStack.length||0===t)this.shouldPlay=!0;else{let e=this._repeatStack[this._repeatStack.length-1],i=e.iterations[e.closingIndex];this._previousAlternateEndings=t,(t&1<<i)==0?this.shouldPlay=!1:this.shouldPlay=!0}}else this.shouldPlay=!0;this.shouldPlay&&(this.currentTick+=e.calculateDuration())}moveNext(){this.moveNextWithDirections()||this.moveNextWithNormalRepeats()}resetRepeats(){this._groupsOnStack.clear(),this._previousAlternateEndings=0,this._repeatStack=[]}handleDaCapo(e,t,i){return!!e.has(t)&&(this.index=0,this._state=i,this.resetRepeats(),!0)}handleDalSegno(e,t,i,s){if(e.has(t)){let e=this.findJumpTarget(s,this.index,!0);return -1!==e&&(this.index=e,this._state=i,this.resetRepeats(),!0)}return!1}handleDaCoda(e,t,i){if(e.has(t)){let e=this.findJumpTarget(i,this.index,!1);return -1===e?this.index++:(this.index=e,this._state=ie.PlayingNormally),!0}return!1}moveNextWithDirections(){let e=this._score.masterBars[this.index],t=null!==e.directions&&e.directions.size>0;if(this._state===ie.PlayingNormally&&!t)return!1;if(!t)return this.index++,!0;switch(this._state){case ie.PlayingNormally:if(this.handleDaCapo(e.directions,tI.JumpDaCapo,ie.DirectionJumped)||this.handleDaCapo(e.directions,tI.JumpDaCapoAlCoda,ie.DirectionJumpedAlCoda)||this.handleDaCapo(e.directions,tI.JumpDaCapoAlDoubleCoda,ie.DirectionJumpedAlDoubleCoda)||this.handleDaCapo(e.directions,tI.JumpDaCapoAlFine,ie.DirectionJumpedAlFine)||this.handleDalSegno(e.directions,tI.JumpDalSegno,ie.DirectionJumped,tI.TargetSegno)||this.handleDalSegno(e.directions,tI.JumpDalSegnoAlCoda,ie.DirectionJumpedAlCoda,tI.TargetSegno)||this.handleDalSegno(e.directions,tI.JumpDalSegnoAlDoubleCoda,ie.DirectionJumpedAlDoubleCoda,tI.TargetSegno)||this.handleDalSegno(e.directions,tI.JumpDalSegnoAlFine,ie.DirectionJumpedAlFine,tI.TargetSegno)||this.handleDalSegno(e.directions,tI.JumpDalSegnoSegno,ie.DirectionJumped,tI.TargetSegnoSegno)||this.handleDalSegno(e.directions,tI.JumpDalSegnoSegnoAlCoda,ie.DirectionJumpedAlCoda,tI.TargetSegnoSegno)||this.handleDalSegno(e.directions,tI.JumpDalSegnoSegnoAlDoubleCoda,ie.DirectionJumpedAlDoubleCoda,tI.TargetSegnoSegno)||this.handleDalSegno(e.directions,tI.JumpDalSegnoSegnoAlFine,ie.DirectionJumpedAlFine,tI.TargetSegnoSegno))break;return!1;case ie.DirectionJumped:this.index++;break;case ie.DirectionJumpedAlCoda:if(this.handleDaCoda(e.directions,tI.JumpDaCoda,tI.TargetCoda))break;this.index++;break;case ie.DirectionJumpedAlDoubleCoda:if(this.handleDaCoda(e.directions,tI.JumpDaDoubleCoda,tI.TargetDoubleCoda))break;this.index++;break;case ie.DirectionJumpedAlFine:if(e.directions.has(tI.TargetFine)){this.index=this._score.masterBars.length;break}this.index++}return!0}findJumpTarget(e,t,i){let s;return i?-1===(s=this.findJumpTargetBackwards(e,t))&&(s=this.findJumpTargetForwards(e,t)):-1===(s=this.findJumpTargetForwards(e,t))&&(s=this.findJumpTargetBackwards(e,t)),s}findJumpTargetForwards(e,t){let i=t;for(;i<this._score.masterBars.length;){let t=this._score.masterBars[i].directions;if(t&&t.has(e))return i;i++}return -1}findJumpTargetBackwards(e,t){let i=t;for(;i>=0;){let t=this._score.masterBars[i].directions;if(t&&t.has(e))return i;i--}return -1}moveNextWithNormalRepeats(){let e=this._score.masterBars[this.index].repeatCount-1;if(this._repeatStack.length>0&&e>0){let t=this._repeatStack[this._repeatStack.length-1];if(t.iterations[t.closingIndex]<e){this.index=t.opening.index,t.iterations[t.closingIndex]++;for(let e=0;e<t.closingIndex;e++)t.iterations[e]=0;t.closingIndex=0,this._previousAlternateEndings=0}else t.closingIndex<t.group.closings.length-1?t.closingIndex++:(this._repeatStack.pop(),this._groupsOnStack.delete(t.group)),this.index++}else this.index++}}class nb{constructor(e,t){this.beat=e,this.playbackStart=t}}class nS{get duration(){return this.end-this.start}constructor(e,t){this._highlightedBeats=new Map,this.highlightedBeats=[],this.nextBeat=null,this.previousBeat=null,this.start=e,this.end=t}highlightBeat(e,t){(!e.isEmpty||e.voice.isEmpty)&&(this._highlightedBeats.has(e.id)||(this._highlightedBeats.set(e.id,!0),this.highlightedBeats.push(new nb(e,t))))}getVisibleBeatAtStart(e){for(let t of this.highlightedBeats)if(t.playbackStart===this.start&&e.has(t.beat.voice.bar.staff.track.index))return t.beat;return null}}class n_{constructor(e,t){this.tick=e,this.tempo=t}}class nw{constructor(){this.start=0,this.end=0,this.tempoChanges=[],this.firstBeat=null,this.lastBeat=null,this.nextMasterBar=null,this.previousMasterBar=null}get tempo(){return this.tempoChanges[0].tempo}insertAfter(e,t){null==this.firstBeat||null==e||null==this.lastBeat?(this.firstBeat=t,this.lastBeat=t):(t.nextBeat=e.nextBeat,t.previousBeat=e,e.nextBeat&&(e.nextBeat.previousBeat=t),e.nextBeat=t,e===this.lastBeat&&(this.lastBeat=t))}insertBefore(e,t){null==this.firstBeat||null==e||null==this.lastBeat?(this.firstBeat=t,this.lastBeat=t):(t.previousBeat=e.previousBeat,t.nextBeat=e,e.previousBeat&&(e.previousBeat.nextBeat=t),e.previousBeat=t,e===this.firstBeat&&(this.firstBeat=t))}addBeat(e,t,i,s){let a=i+s;if(null==this.firstBeat){let s=new nS(i,a);s.highlightBeat(e,t),this.insertAfter(this.firstBeat,s)}else if(i>=this.lastBeat.end){let i=new nS(this.lastBeat.end,a);i.highlightBeat(e,t),this.insertAfter(this.lastBeat,i)}else{let s=null;if(i<this.firstBeat.start)s=this.firstBeat;else{let e=this.firstBeat;for(;null!=e;){if(i>=e.start&&i<e.end){s=e;break}e=e.nextBeat}if(null===s)throw new i6(tE.General,"Error on building lookup, unknown variant")}if(i<s.start)if(a===s.start){let a=new nS(i,s.start);a.highlightBeat(e,t),this.insertBefore(this.firstBeat,a)}else if(a<s.end){let r=new nS(i,s.start);r.highlightBeat(e,t),this.insertBefore(s,r);let n=new nS(s.start,a);for(let e of s.highlightedBeats)n.highlightBeat(e.beat,e.playbackStart);n.highlightBeat(e,t),this.insertBefore(s,n),s.start=a}else if(a===s.end){let a=new nS(i,s.start);a.highlightBeat(e,t),s.highlightBeat(e,t),this.insertBefore(s,a)}else{let r=new nS(i,s.start);r.highlightBeat(e,t),s.highlightBeat(e,t),this.insertBefore(s,r),this.addBeat(e,t,s.end,a-s.end)}else if(i>s.start)if(a===s.end){let a=new nS(s.start,i);for(let e of s.highlightedBeats)a.highlightBeat(e.beat,e.playbackStart);s.start=i,s.highlightBeat(e,t),this.insertBefore(s,a)}else if(a<s.end){let r=new nS(s.start,i);this.insertBefore(s,r);let n=new nS(i,a);for(let e of(this.insertBefore(s,n),s.highlightedBeats))r.highlightBeat(e.beat,e.playbackStart),n.highlightBeat(e.beat,e.playbackStart);n.highlightBeat(e,t),s.start=a}else{let r=new nS(s.start,i);for(let e of s.highlightedBeats)r.highlightBeat(e.beat,e.playbackStart);s.start=i,s.highlightBeat(e,t),this.insertBefore(s,r),this.addBeat(e,t,s.end,a-s.end)}else if(a===s.end)s.highlightBeat(e,t);else if(a<s.end){let i=new nS(s.start,a);for(let e of s.highlightedBeats)i.highlightBeat(e.beat,e.playbackStart);i.highlightBeat(e,t),s.start=a,this.insertBefore(s,i)}else s.highlightBeat(e,t),this.addBeat(e,t,s.end,a-s.end)}}}(eD=it||(it={}))[eD.Unknown=0]="Unknown",eD[eD.ToNextBext=1]="ToNextBext",eD[eD.ToEndOfBar=2]="ToEndOfBar";class nk{get start(){return this.masterBar.start+this.beatLookup.start}get end(){return this.start+this.tickDuration}constructor(e){this.nextBeat=null,this.tickDuration=0,this.duration=0,this.cursorMode=it.Unknown,this.masterBar=e}calculateDuration(){if(1===this.masterBar.tempoChanges.length)this.duration=ix.ticksToMillis(this.tickDuration,this.masterBar.tempoChanges[0].tempo);else{let e=0,t=this.start,i=this.masterBar.tempoChanges[0].tempo,s=this.end;for(let a of this.masterBar.tempoChanges)if(a.tick<t)i=a.tempo;else if(a.tick>s)break;else e+=ix.ticksToMillis(a.tick-t,i),i=a.tempo,t=a.tick;s>t&&(e+=ix.ticksToMillis(s-t,i)),this.duration=e}}}class nB{constructor(){this._currentMasterBar=null,this.masterBarLookup=new Map,this.masterBars=[],this.multiBarRestInfo=null}findBeat(e,t,i=null){let s=null;return i&&(s=this.findBeatFast(e,i,t)),s||(s=this.findBeatSlow(e,i,t,!1)),s}findBeatFast(e,t,i){if(i>=t.start&&i<t.end)return t;if(t.nextBeat&&i>=t.nextBeat.start&&i<t.nextBeat.end){let i=t.nextBeat;return this.fillNextBeat(i,e),i}return null}fillNextBeatMultiBarRest(e,t){let i=this.multiBarRestInfo.get(e.masterBar.masterBar.index),s=e.masterBar;for(let e=0;e<i.length&&s;e++)s=s.nextMasterBar;s?s.nextMasterBar?(e.nextBeat=this.firstBeatInMasterBar(t,s.nextMasterBar,s.nextMasterBar.start,!0),e.nextBeat?(e.tickDuration=e.nextBeat.start-e.start,e.cursorMode=it.ToNextBext,e.nextBeat.masterBar.masterBar.index!==s.masterBar.index+1&&(e.nextBeat.masterBar.masterBar.index!==s.masterBar.index||e.nextBeat.beat.playbackStart<=e.beat.playbackStart)&&(e.cursorMode=it.ToEndOfBar)):(e.tickDuration=s.nextMasterBar.end-e.start,e.cursorMode=it.ToEndOfBar)):(e.tickDuration=s.end-e.start,e.cursorMode=it.ToEndOfBar):(iM.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain fill-next)"),e.tickDuration=(e.masterBar.end-e.masterBar.start)*(i.length+1),e.cursorMode=it.ToEndOfBar),e.calculateDuration()}fillNextBeat(e,t){this.isMultiBarRestResult(e)?this.fillNextBeatMultiBarRest(e,t):this.fillNextBeatDefault(e,t)}fillNextBeatDefault(e,t){e.nextBeat=this.findBeatInMasterBar(e.masterBar,e.beatLookup.nextBeat,e.end,t,!0),null==e.nextBeat&&(e.nextBeat=this.findBeatSlow(t,e,e.end,!0)),e.nextBeat?(e.tickDuration=e.nextBeat.start-e.start,e.cursorMode=it.ToNextBext):(e.tickDuration=e.masterBar.end-e.start,e.cursorMode=it.ToEndOfBar),e.calculateDuration(),e.nextBeat&&e.nextBeat.masterBar.masterBar.index!==e.masterBar.masterBar.index+1&&(e.nextBeat.masterBar.masterBar.index!==e.masterBar.masterBar.index||e.nextBeat.beat.playbackStart<=e.beat.playbackStart)&&(e.cursorMode=it.ToEndOfBar)}isMultiBarRestResult(e){return this.internalIsMultiBarRestResult(e.masterBar.masterBar.index,e.beat)}internalIsMultiBarRestResult(e,t){return this.multiBarRestInfo&&this.multiBarRestInfo.has(e)&&t.isRest&&t.voice.bar.isRestOnly}findBeatSlow(e,t,i,s){let a=null;return(null!=t&&(t.masterBar.start<=i&&t.masterBar.end>i?a=t.masterBar:t.masterBar.nextMasterBar&&t.masterBar.nextMasterBar.start<=i&&t.masterBar.nextMasterBar.end>i&&(a=t.masterBar.nextMasterBar)),a||(a=this.findMasterBar(i)),a)?this.firstBeatInMasterBar(e,a,i,s):null}firstBeatInMasterBar(e,t,i,s){let a=t;for(;a;){if(a.firstBeat){let t=this.findBeatInMasterBar(a,a.firstBeat,i,e,s);if(t)return t}a=a.nextMasterBar}return null}findBeatInMasterBar(e,t,i,s,a){if(!t)return null;let r=null,n=null,o=i-e.start;for(;null!=t&&null==n;){if((t.start<=o||a&&o<0)&&o<t.end){if(r=t,!(n=t.getVisibleBeatAtStart(s)))if(a){let i=e;for(;null!=i&&null==n;){for(;null!=t;){if(n=t.getVisibleBeatAtStart(s)){r=t,e=i;break}t=t.nextBeat}n&&r||(i=i.nextMasterBar,t=i?.firstBeat??null)}}else{let i=e;for(;null!=i&&null==n;){for(;null!=t;){if(n=t.getVisibleBeatAtStart(s)){r=t,e=i;break}t=t.previousBeat}n&&r||(i=i.previousMasterBar,t=i?.firstBeat??null)}}}else if(t.end>o)break;t=t?.nextBeat??null}return null==n?null:this.createResult(e,r,n,a,s)}createResult(e,t,i,s,a){let r=new nk(e);if(r.beat=i,r.beatLookup=t,r.tickDuration=t.end-t.start,s){if(this.isMultiBarRestResult(r)){let i=this.multiBarRestInfo.get(e.masterBar.index),s=e;for(let e=0;e<i.length&&s;e++)s=s.nextMasterBar;s?s.nextMasterBar?r.tickDuration=s.nextMasterBar.start-t.start:r.tickDuration=s.end-t.start:iM.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain stretch-result)")}}else this.fillNextBeat(r,a);return r.calculateDuration(),r}findMasterBar(e){let t=this.masterBars,i=0,s=t.length-1;for(;i<=s;){let a=(s+i)/2|0,r=t[a];if(e>=r.start&&e<r.end)return r;e<r.start?s=a-1:i=a+1}return null}getMasterBar(e){if(!this.masterBarLookup.has(e.index)){let t=new nw;return t.masterBar=e,t}return this.masterBarLookup.get(e.index)}getMasterBarStart(e){return this.masterBarLookup.has(e.index)?this.masterBarLookup.get(e.index).start:0}getBeatStart(e){return this.masterBarLookup.has(e.voice.bar.index)?this.masterBarLookup.get(e.voice.bar.index).start+e.playbackStart:0}addMasterBar(e){this.masterBars.push(e),this._currentMasterBar&&(e.previousMasterBar=this._currentMasterBar,this._currentMasterBar.nextMasterBar=e),this._currentMasterBar=e,this.masterBarLookup.has(e.masterBar.index)||this.masterBarLookup.set(e.masterBar.index,e)}addBeat(e,t,i){let s=this._currentMasterBar;if(s)if(t<0&&s.previousMasterBar){let a=s.previousMasterBar.end-s.previousMasterBar.start,r=a+t,n=r+i;if(s.previousMasterBar.addBeat(e,r,r,i),n>a){let a=i+t;s.addBeat(e,t,0,a)}}else s.addBeat(e,t,t,i)}}class nT{constructor(){this.noteOnly=0,this.untilTieOrSlideEnd=0,this.letRingEnd=0}}class nN{constructor(){this.firstBeatDuration=0,this.secondBeatStartOffset=0,this.secondBeatDuration=0}}class nx{constructor(){this.durations=[],this.brushInfos=[]}}class nP{constructor(){this.synthTick=0,this.synthTime=0,this.currentTempo=0,this.automationToSyncPoint=new Map,this.createNewSyncPoints=!1}}class nv{constructor(e,t,i){this._programsPerChannel=new Map,this._currentTime=0,this._calculatedBeatTimers=new Set,this.tickLookup=new nB,this.applyTranspositionPitches=!0,this.syncPoints=[],this.transpositionPitches=new Map,this._currentTripletFeel=null,this.vibratoResolution=16,this._score=e,this._settings=t||new rA,this._handler=i}generate(){for(let e of(this.transpositionPitches.clear(),this._calculatedBeatTimers.clear(),this._currentTime=0,this._score.tracks))this.generateTrack(e);iM.debug("Midi","Begin midi generation"),this.syncPoints=[],nv.playThroughSong(this._score,this.syncPoints,!1,(e,t,i,s,a)=>{this.generateMasterBar(e,t,i,s,a)},(e,t,i)=>{for(let s of this._score.tracks)for(let a of s.staves)e<a.bars.length&&this.generateBar(a.bars[e],t,i)},e=>{for(let t of this._score.tracks)this._handler.finishTrack(t.index,e)}),iM.debug("Midi","Midi generation done")}generateTrack(e){this.generateChannel(e,e.playbackInfo.primaryChannel,e.playbackInfo),e.playbackInfo.primaryChannel!==e.playbackInfo.secondaryChannel&&this.generateChannel(e,e.playbackInfo.secondaryChannel,e.playbackInfo)}addProgramChange(e,t,i,s){this._programsPerChannel.has(i)&&this._programsPerChannel.get(i)===s||(this._handler.addProgramChange(e.index,t,i,s),this._programsPerChannel.set(i,s))}static buildTranspositionPitches(e,t){let i=new Map;for(let s of e.tracks){let e=s.index<t.notation.transpositionPitches.length?t.notation.transpositionPitches[s.index]:-s.staves[0].transpositionPitch;i.set(s.playbackInfo.primaryChannel,e),i.set(s.playbackInfo.secondaryChannel,e)}return i}generateChannel(e,t,i){let s=e.index<this._settings.notation.transpositionPitches.length?this._settings.notation.transpositionPitches[e.index]:-e.staves[0].transpositionPitch;this.transpositionPitches.set(t,s);let a=nv.toChannelShort(i.volume),r=nv.toChannelShort(i.balance);this._handler.addControlChange(e.index,0,t,t2.VolumeCoarse,a),this._handler.addControlChange(e.index,0,t,t2.PanCoarse,r),this._handler.addControlChange(e.index,0,t,t2.ExpressionControllerCoarse,127),this._handler.addControlChange(e.index,0,t,t2.RegisteredParameterFine,0),this._handler.addControlChange(e.index,0,t,t2.RegisteredParameterCourse,0),this._handler.addControlChange(e.index,0,t,t2.DataEntryFine,0),this._handler.addControlChange(e.index,0,t,t2.DataEntryCoarse,nv.PitchBendRangeInSemitones),this.addProgramChange(e,0,t,i.program)}static generateSyncPoints(e,t=!1){let i=[];return nv.playThroughSong(e,i,t,(e,t,i,s,a)=>{},(e,t,i)=>{},e=>{}),i}static buildModifiedTempoLookup(e){return nv.playThroughSong(e,[],!1,(e,t,i,s,a)=>{},(e,t,i)=>{},e=>{}).automationToSyncPoint}static playThroughSong(e,t,i,s,a,r){let n=new ny(e),o=new nP;o.currentTempo=e.tempo,o.syncPoints=t,o.createNewSyncPoints=i;let l=null,h=new Map;for(;!n.finished;){let t=n.index,i=e.masterBars[t],r=n.currentTick;if(n.processCurrent(),n.shouldPlay){let e=h.has(t)?h.get(t):-1;e++,h.set(t,e),s(i,l,r,o.currentTempo,e),a(t,r,i.tempoAutomations.length>0?i.tempoAutomations[0].value:o.currentTempo),o.synthTick=r,nv.processBarTime(i,e,o)}n.moveNext(),l=i}if(t.length>0){let e=t[t.length-1],i=n.currentTick-e.synthTick;if(i>0){let s=new al;s.masterBarIndex=l.index,s.masterBarOccurence=h.get(l.index)-1,s.synthTick=n.currentTick,s.synthBpm=o.currentTempo,o.createNewSyncPoints?(s.syncBpm=e.synthBpm,s.synthBpm=e.synthBpm):1===t.length?s.syncBpm=e.synthBpm:s.syncBpm=t[t.length-2].syncBpm,s.synthTime=e.synthTime+ix.ticksToMillis(i,e.synthBpm),s.syncTime=e.syncTime+ix.ticksToMillis(i,s.syncBpm),o.createNewSyncPoints||e.updateSyncBpm(s.synthTime,s.syncTime),t.push(s)}}return r(n.currentTick),o}static processBarTime(e,t,i){let s=e.calculateDuration(),a=e.syncPoints,r=i.synthTick;i.createNewSyncPoints?nv.processBarTimeWithNewSyncPoints(e,t,i):a?nv.processBarTimeWithSyncPoints(e,t,i):nv.processBarTimeNoSyncPoints(e,i);let n=r+s,o=n-i.synthTick;o>0&&(i.synthTime+=ix.ticksToMillis(o,i.currentTempo),i.synthTick=n)}static processBarTimeWithNewSyncPoints(e,t,i){let s=i.synthTick;if(0===e.index&&0===t){i.currentTempo=e.score.tempo;let a=new al;a.masterBarIndex=e.index,a.masterBarOccurence=t,a.synthTick=s,a.synthBpm=i.currentTempo,a.synthTime=i.synthTime,a.syncBpm=i.currentTempo,a.syncTime=i.synthTime,i.syncPoints.push(a)}let a=e.calculateDuration();for(let r of e.tempoAutomations){let n=s+r.ratioPosition*a,o=n-i.synthTick;if(o>0&&(i.synthTick=n,i.synthTime+=ix.ticksToMillis(o,i.currentTempo)),r.value!==i.currentTempo){i.currentTempo=r.value;let s=new al;s.masterBarIndex=e.index,s.masterBarOccurence=t,s.synthTick=n,s.synthBpm=i.currentTempo,s.synthTime=i.synthTime,s.syncBpm=i.currentTempo,s.syncTime=i.synthTime,i.syncPoints.push(s)}}}static processBarTimeWithSyncPoints(e,t,i){let s,a=i.synthTick,r=e.calculateDuration(),n=0;for(let o of e.syncPoints){if(o.syncPointValue.barOccurence!==t)continue;let l=a+o.ratioPosition*r;for(;n<e.tempoAutomations.length&&e.tempoAutomations[n].ratioPosition<=o.ratioPosition;){let t=e.tempoAutomations[n],o=a+t.ratioPosition*r;(s=o-i.synthTick)>0&&(i.synthTick=o,i.synthTime+=ix.ticksToMillis(s,i.currentTempo)),i.currentTempo=t.value,n++}(s=l-i.synthTick)>0&&(i.synthTick=l,i.synthTime+=ix.ticksToMillis(s,i.currentTempo)),i.syncPoints.length>0&&i.syncPoints[i.syncPoints.length-1].updateSyncBpm(i.synthTime,o.syncPointValue.millisecondOffset);let h=new al;h.masterBarIndex=e.index,h.masterBarOccurence=t,h.synthTick=l,h.synthBpm=i.currentTempo,h.synthTime=i.synthTime,h.syncTime=o.syncPointValue.millisecondOffset,h.syncBpm=0,i.syncPoints.push(h),i.automationToSyncPoint.set(o,h)}for(;n<e.tempoAutomations.length;){let t=e.tempoAutomations[n],o=a+t.ratioPosition*r;(s=o-i.synthTick)>0&&(i.synthTick=o,i.synthTime+=ix.ticksToMillis(s,i.currentTempo)),i.currentTempo=t.value,n++}}static processBarTimeNoSyncPoints(e,t){let i=t.synthTick,s=e.calculateDuration();for(let a of e.tempoAutomations){let e=i+a.ratioPosition*s,r=e-t.synthTick;r>0&&(t.synthTick=e,t.synthTime+=ix.ticksToMillis(r,t.currentTempo)),t.currentTempo=a.value}}static toChannelShort(e){return Math.max(Math.max(-32768,Math.min(32767,8*e-1)),-1)+1}generateMasterBar(e,t,i,s,a){t&&t.timeSignatureDenominator===e.timeSignatureDenominator&&t.timeSignatureNumerator===e.timeSignatureNumerator||this._handler.addTimeSignature(i,e.timeSignatureNumerator,e.timeSignatureDenominator);let r=e.calculateDuration(),n=new nw;if(e.tempoAutomations.length>0)for(let t of(e.tempoAutomations[0].ratioPosition>0&&n.tempoChanges.push(new n_(i,s)),e.tempoAutomations)){let e=i+r*t.ratioPosition;this._handler.addTempo(e,t.value),n.tempoChanges.push(new n_(e,t.value))}else t?n.tempoChanges.push(new n_(i,s)):(this._handler.addTempo(i,e.score.tempo),n.tempoChanges.push(new n_(i,e.score.tempo)));n.masterBar=e,n.start=i,n.end=n.start+r,this.tickLookup.addMasterBar(n)}generateBar(e,t,i){let s=this.getPlaybackBar(e),a=this._currentTime;for(let r of s.voices)this._currentTime=a,this.generateVoice(r,t,e,i);let r=s.masterBar,n=r.calculateDuration(),o=r.tempoAutomations.slice();if(0===o.length)this._currentTime=a+ix.ticksToMillis(n,i);else{this._currentTime=a;let e=t,s=i,r=t+n;for(let t of o){let i=n*t.ratioPosition-e;i>0&&(this._currentTime+=ix.ticksToMillis(i,s)),s=t.value,e+=i}let l=r-e;l>0&&(this._currentTime+=ix.ticksToMillis(l,s))}s.id!==e.id&&this.tickLookup.addBeat(e.voices[0].beats[0],0,n)}getPlaybackBar(e){switch(e.simileMark){case eZ.Simple:e.previousBar&&(e=this.getPlaybackBar(e.previousBar));break;case eZ.FirstOfDouble:case eZ.SecondOfDouble:e.previousBar&&e.previousBar.previousBar&&(e=this.getPlaybackBar(e.previousBar.previousBar))}return e}generateVoice(e,t,i,s){if(e.isEmpty&&(!e.bar.isEmpty||0!==e.index))return;let a=i.masterBar.tempoAutomations.slice(),r=s,n=i.masterBar.calculateDuration();for(let s of e.beats){let e=s.playbackStart/n;for(;a.length>0&&a[0].ratioPosition<=e;)r=a.shift().value;this.generateBeat(s,t,i,r)}}generateBeat(e,t,i,s){let a=e.playbackStart,r=e.playbackDuration,n=e.voice.bar.masterBar.calculateDuration();e.voice.bar.isEmpty?r=n:e.voice.bar.masterBar.tripletFeel!==tg.NoTripletFeel&&this._settings.player.playTripletFeel&&(this._currentTripletFeel?(a-=this._currentTripletFeel.secondBeatStartOffset,r=this._currentTripletFeel.secondBeatDuration,this._currentTripletFeel=null):(this._currentTripletFeel=nv.calculateTripletFeelInfo(a,r,e),this._currentTripletFeel&&(r=this._currentTripletFeel.firstBeatDuration))),e.showTimer&&!this._calculatedBeatTimers.has(e.id)&&(e.timer=this._currentTime,this._calculatedBeatTimers.add(e.id)),this._currentTime+=ix.ticksToMillis(r,s),i===e.voice.bar&&this.tickLookup.addBeat(e,a,r);let o=e.voice.bar.staff.track;for(let i of e.automations)this.generateNonTempoAutomation(e,i,t);if(e.isRest)this._handler.addRest(o.index,t+a,o.playbackInfo.primaryChannel);else if(e.deadSlapped)this.generateDeadSlap(e,t+a);else{let i=this.getBrushInfo(e),n=this.getRasgueadoInfo(e,r);for(let o of e.notes)this.generateNote(o,t+a,r,s,i,n)}if(e.fade!==tN.None&&this.generateFade(e,t+a,r),e.vibrato!==th.None){let i=240,s=3;switch(e.vibrato){case th.Slight:i=this._settings.player.vibrato.beatSlightLength,s=this._settings.player.vibrato.beatSlightAmplitude;break;case th.Wide:i=this._settings.player.vibrato.beatWideLength,s=this._settings.player.vibrato.beatWideAmplitude}this.generateVibratorWithParams(t+a,e.playbackDuration,i,0,s,(t,i)=>{this._handler.addBend(e.voice.bar.staff.track.index,t,o.playbackInfo.secondaryChannel,i)})}}static calculateTripletFeelInfo(e,t,i){let s;switch(i.voice.bar.masterBar.tripletFeel){case tg.Triplet8th:case tg.Dotted8th:case tg.Scottish8th:s=tt.Eighth;break;case tg.Triplet16th:case tg.Dotted16th:case tg.Scottish16th:s=tt.Sixteenth;break;default:return null}let a=ix.toTicks(s);if(t!==a||e%a!=0||!i.nextBeat||i.nextBeat.voice!==i.voice||i.playbackDuration!==a)return null;let r=new nN;switch(i.voice.bar.masterBar.tripletFeel){case tg.Triplet8th:r.firstBeatDuration=ix.applyTuplet(ix.toTicks(tt.Quarter),3,2),r.secondBeatDuration=ix.applyTuplet(ix.toTicks(tt.Eighth),3,2);break;case tg.Dotted8th:r.firstBeatDuration=ix.applyDot(ix.toTicks(tt.Eighth),!1),r.secondBeatDuration=ix.toTicks(tt.Sixteenth);break;case tg.Scottish8th:r.firstBeatDuration=ix.toTicks(tt.Sixteenth),r.secondBeatDuration=ix.applyDot(ix.toTicks(tt.Eighth),!1);break;case tg.Triplet16th:r.firstBeatDuration=ix.applyTuplet(ix.toTicks(tt.Eighth),3,2),r.secondBeatDuration=ix.applyTuplet(ix.toTicks(tt.Sixteenth),3,2);break;case tg.Dotted16th:r.firstBeatDuration=ix.applyDot(ix.toTicks(tt.Sixteenth),!1),r.secondBeatDuration=ix.toTicks(tt.ThirtySecond);break;case tg.Scottish16th:r.firstBeatDuration=ix.toTicks(tt.ThirtySecond),r.secondBeatDuration=ix.applyDot(ix.toTicks(tt.Sixteenth),!1)}return r.secondBeatStartOffset=t-r.firstBeatDuration,r}generateDeadSlap(e,t){let i=ix.toTicks(tt.SixtyFourth),s=e.voice.bar.staff;if(s.tuning.length>0)for(let e of s.tuning)this._handler.addNote(s.track.index,t,i,e,ix.dynamicToVelocity(e4.F),s.track.playbackInfo.primaryChannel)}needsSecondaryChannel(e){return e.hasBend||e.beat.hasWhammyBar||e.beat.vibrato!==th.None}determineChannel(e,t){if(this.needsSecondaryChannel(t))return e.playbackInfo.secondaryChannel;let i=t;for(;i.isTieDestination;)if(i=i.tieOrigin,this.needsSecondaryChannel(i))return e.playbackInfo.secondaryChannel;for(i=t;i.isTieOrigin;)if(i=i.tieDestination,this.needsSecondaryChannel(i))return e.playbackInfo.secondaryChannel;return e.playbackInfo.primaryChannel}generateNote(e,t,i,s,a,r){let n=e.beat.voice.bar.staff.track,o=e.beat.voice.bar.staff,l=e.calculateRealValue(this.applyTranspositionPitches,!0);if(e.isPercussion){let t=iU.getArticulation(e);t&&(l=t.outputMidiNumber)}let h=null==r&&e.isStringed&&e.string<=a.length?a[e.string-1]:0,d=t+h,c=this.getNoteDuration(e,i,s);c.untilTieOrSlideEnd-=h,c.noteOnly-=h,c.letRingEnd-=h;let u=nv.getNoteVelocity(e),p=this.determineChannel(n,e),m=0,g=Math.max(c.untilTieOrSlideEnd,c.letRingEnd);((m=e.hasBend?nv.getPitchWheel(e.bendPoints[0].value):e.beat.hasWhammyBar?nv.getPitchWheel(e.beat.whammyBarPoints[0].value):e.isTieDestination||e.slideOrigin&&e.slideOrigin.slideOutType===tl.Legato?-1:nv.getPitchWheel(0))>=0&&this._handler.addNoteBend(n.index,d,p,l,m),e.beat.hasRasgueado)?this.generateRasgueado(n,e,d,l,u,p,r):e.ornament!==tw.None?this.generateOrnament(n,e,d,g,l,u,p):e.isTrill&&!o.isPercussion?this.generateTrill(e,d,c,l,u,p):e.beat.isTremolo?this.generateTremoloPicking(e,d,c,l,u,p):(e.hasBend?this.generateBend(e,d,c,l,p,s):e.beat.hasWhammyBar&&0===e.index?this.generateWhammy(e.beat,d,c,p,s):e.slideInType!==to.None||e.slideOutType!==tl.None?this.generateSlide(e,d,c,l,p,s):(e.vibrato!==th.None||e.isTieDestination&&e.tieOrigin.vibrato!==th.None)&&this.generateVibrato(e,d,c,l,p),e.isTieDestination||e.slideOrigin&&e.slideOrigin.slideOutType===tl.Legato||this._handler.addNote(n.index,d,g,l,u,p))}generateOrnament(e,t,i,s,a,r,n){let o,l,h=a%12,d=1/3;switch(t.ornament){case tw.Turn:o=[a+nv.OrnamentKeysUp[h],a,a+nv.OrnamentKeysDown[h]],l=[ix.toTicks(tt.Sixteenth)*d,ix.toTicks(tt.Sixteenth)*d,ix.toTicks(tt.Sixteenth)*d];break;case tw.InvertedTurn:o=[a+nv.OrnamentKeysDown[h],a,a+nv.OrnamentKeysUp[h]],l=[ix.toTicks(tt.Sixteenth)*d,ix.toTicks(tt.Sixteenth)*d,ix.toTicks(tt.Sixteenth)*d];break;case tw.UpperMordent:o=[a,a+nv.OrnamentKeysUp[h]],l=[ix.toTicks(tt.ThirtySecond),ix.toTicks(tt.ThirtySecond)];break;case tw.LowerMordent:o=[a,a+nv.OrnamentKeysDown[h]],l=[ix.toTicks(tt.ThirtySecond),ix.toTicks(tt.ThirtySecond)];break;default:return}let c=1;s<ix.QuarterTime&&(c=s/ix.QuarterTime),r-=ix.VelocityIncrement;let u=0;for(let t=0;t<o.length;t++){let s=l[t]*c;this._handler.addNote(e.index,i,s,o[t],r,n),i+=s,u+=s}let p=s-u;this._handler.addNote(e.index,i,p,a,r,n)}getNoteDuration(e,t,i){let s=new nT;if(s.noteOnly=t,s.untilTieOrSlideEnd=t,s.letRingEnd=t,e.isDead)return s.noteOnly=this.applyStaticDuration(nv.DefaultDurationDead,t,i),s.untilTieOrSlideEnd=s.noteOnly,s.letRingEnd=s.noteOnly,s;if(e.isPalmMute)return s.noteOnly=this.applyStaticDuration(nv.DefaultDurationPalmMute,t,i),s.untilTieOrSlideEnd=s.noteOnly,s.letRingEnd=s.noteOnly,s;if(e.isStaccato)return s.noteOnly=t/2|0,s.untilTieOrSlideEnd=s.noteOnly,s.letRingEnd=s.noteOnly,s;if(e.isTieOrigin){let a=e.tieDestination;if(a)if(e.isTieDestination)s.untilTieOrSlideEnd=t+this.getNoteDuration(a,a.beat.playbackDuration,i).untilTieOrSlideEnd;else{let t=e.beat.absolutePlaybackStart,r=this.getNoteDuration(a,a.beat.playbackDuration,i);s.untilTieOrSlideEnd=a.beat.absolutePlaybackStart+r.untilTieOrSlideEnd-t}}else if(e.slideOutType===tl.Legato){let t=e.slideTarget;if(t){let a=e.beat.absolutePlaybackStart,r=this.getNoteDuration(t,t.beat.playbackDuration,i);s.untilTieOrSlideEnd=t.beat.absolutePlaybackStart+r.untilTieOrSlideEnd-a}}if(e.isLetRing&&this._settings.notation.notationMode===tu.GuitarPro){let i=e.beat,a=0,r=e.beat.voice.bar.masterBar.calculateDuration();for(;i.nextBeat;){let t=i.nextBeat;if(t.isRest||e.isStringed&&t.hasNoteOnString(e.string))break;if((a=(i=i.nextBeat).absolutePlaybackStart-e.beat.absolutePlaybackStart+i.playbackDuration)>r){a=r;break}}i===e.beat?s.letRingEnd=t:s.letRingEnd=a}else s.letRingEnd=s.untilTieOrSlideEnd;return s}applyStaticDuration(e,t,i){return Math.min(i*e/iF.MaxPosition|0,t)}static getNoteVelocity(e){let t=0;switch(!e.beat.voice.bar.staff.isPercussion&&e.hammerPullOrigin&&t--,e.isGhost&&t--,e.accentuated){case ts.Normal:t++;break;case ts.Heavy:t+=2}return ix.dynamicToVelocity(e.dynamics,t)}generateFade(e,t,i){let s=e.voice.bar.staff.track;switch(e.fade){case tN.FadeIn:this.generateFadeSteps(s,t,i,0,nv.toChannelShort(s.playbackInfo.volume));break;case tN.FadeOut:this.generateFadeSteps(s,t,i,nv.toChannelShort(s.playbackInfo.volume),0);break;case tN.VolumeSwell:let a=i/2|0;this.generateFadeSteps(s,t,a,0,nv.toChannelShort(s.playbackInfo.volume)),this.generateFadeSteps(s,t+a,a,nv.toChannelShort(s.playbackInfo.volume),0)}}generateFadeSteps(e,t,i,s,a){let r=(a-s)/(i=.8*i|0),n=i/120+1|0,o=t+i;for(let i=0;i<n;i++){let l=i===n-1,h=l?o:t+120*i,d=l?a:Math.round(s+(h-t)*r);this._handler.addControlChange(e.index,h,e.playbackInfo.primaryChannel,t2.VolumeCoarse,d),this._handler.addControlChange(e.index,h,e.playbackInfo.secondaryChannel,t2.VolumeCoarse,d)}}generateVibrato(e,t,i,s,a){let r=0,n=0;switch(e.vibrato!==th.None?e.vibrato:e.isTieDestination?e.tieOrigin.vibrato:th.Slight){case th.Slight:r=this._settings.player.vibrato.noteSlightLength,n=this._settings.player.vibrato.noteSlightAmplitude;break;case th.Wide:r=this._settings.player.vibrato.noteWideLength,n=this._settings.player.vibrato.noteWideAmplitude;break;default:return}let o=e.beat.voice.bar.staff.track,l=0;if(e.isTieDestination&&e.tieOrigin.hasBend){let t=e.tieOrigin.bendPoints;l=t[t.length-1].value}this.generateVibratorWithParams(t,i.noteOnly,r,l,n,(e,t)=>{this._handler.addNoteBend(o.index,e,a,s,t)})}generateVibratorWithParams(e,t,i,s,a,r){let n=this.vibratoResolution,o=i/2|0,l=e+t;for(;e<l;){let t=0,h=e+i<l?i:l-e;for(;t<h;){let i=s+a*Math.sin(t*Math.PI/o);r(e+t|0,nv.getPitchWheel(i)),t+=n}e+=i}r(0|l,nv.getPitchWheel(s))}static getPitchWheel(e){return iI.DefaultPitchWheel+e/2*nv.PitchValuePerSemitone}generateSlide(e,t,i,s,a,r){let n=e.slideOutType===tl.Legato?i.noteOnly:i.untilTieOrSlideEnd,o=[],l=e.beat.voice.bar.staff.track,h=this._settings.player.slide.simpleSlidePitchOffset,d=Math.floor(iF.MaxPosition*this._settings.player.slide.simpleSlideDurationRatio),c=Math.floor(iF.MaxPosition*this._settings.player.slide.shiftSlideDurationRatio);switch(e.slideInType){case to.IntoFromAbove:o.push(new iF(0,h)),o.push(new iF(d,0));break;case to.IntoFromBelow:o.push(new iF(0,-h)),o.push(new iF(d,0))}switch(e.slideOutType){case tl.Legato:case tl.Shift:o.push(new iF(c,0));let u=(e.slideTarget.calculateRealValue(this.applyTranspositionPitches,!0)-e.calculateRealValue(this.applyTranspositionPitches,!0))*2;o.push(new iF(iF.MaxPosition,u));break;case tl.OutDown:o.push(new iF(iF.MaxPosition-d,0)),o.push(new iF(iF.MaxPosition,-h));break;case tl.OutUp:o.push(new iF(iF.MaxPosition-d,0)),o.push(new iF(iF.MaxPosition,h))}this.generateWhammyOrBend(t,n,o,r,(e,t)=>{this._handler.addNoteBend(l.index,e,a,s,t)})}generateBend(e,t,i,s,a,r){let n,o=e.bendPoints,l=e.beat.voice.bar.staff.track,h=(e,t)=>{this._handler.addNoteBend(l.index,e,a,s,t)},d=null;if(e.isTieOrigin&&this._settings.notation.extendBendArrowsOnTiedNotes){let t=e;for(;t.isTieOrigin&&!t.tieDestination.hasBend&&t.tieDestination.vibrato===th.None;)t=t.tieDestination;n=t.beat.absolutePlaybackStart-e.beat.absolutePlaybackStart+this.getNoteDuration(t,t.beat.playbackDuration,r).noteOnly}else if(e.isTieOrigin&&e.beat.graceType!==ti.None){switch(e.tieDestination.bendType){case e7.Bend:case e7.BendRelease:case e7.PrebendBend:d=e.tieDestination.bendPoints[1].value;break;case e7.Prebend:case e7.PrebendRelease:d=e.tieDestination.bendPoints[0].value}n=Math.max(i.noteOnly,ix.millisToTicks(this._settings.player.songBookBendDuration,r))}else n=i.noteOnly;o[0].value>0&&!e.isContinuedBend&&t>0&&t--;let c=Math.min(n,ix.millisToTicks(this._settings.player.songBookBendDuration,r)),u=[];switch(e.bendType){case e7.Custom:u=o;break;case e7.Bend:case e7.Release:switch(e.bendStyle){case e8.Default:u=o;break;case e8.Gradual:u.push(new iF(0,e.bendPoints[0].value)),(!d||d<e.bendPoints[1].value)&&(d=e.bendPoints[1].value),u.push(new iF(iF.MaxPosition,d));break;case e8.Fast:(!d||d<e.bendPoints[1].value)&&(d=e.bendPoints[1].value),e.beat.graceType===ti.BendGrace?this.generateSongBookWhammyOrBend(t,n,!0,[e.bendPoints[0].value,d],c,r,h):this.generateSongBookWhammyOrBend(t,n,!1,[e.bendPoints[0].value,d],c,r,h);return}break;case e7.BendRelease:switch(e.bendStyle){case e8.Default:u=o;break;case e8.Gradual:u.push(new iF(0,e.bendPoints[0].value)),u.push(new iF(iF.MaxPosition/2|0,e.bendPoints[1].value)),u.push(new iF(iF.MaxPosition,e.bendPoints[2].value));break;case e8.Fast:this.generateSongBookWhammyOrBend(t,n,!1,[e.bendPoints[0].value,e.bendPoints[1].value,e.bendPoints[2].value],c,r,h);return}break;case e7.Hold:case e7.Prebend:u=o;break;case e7.PrebendBend:switch(e.bendStyle){case e8.Default:u=o;break;case e8.Gradual:u.push(new iF(0,e.bendPoints[0].value)),u.push(new iF(iF.MaxPosition,e.bendPoints[1].value));break;case e8.Fast:let p=nv.getPitchWheel(e.bendPoints[0].value);h(t,0|p),(!d||d<e.bendPoints[1].value)&&(d=e.bendPoints[1].value),this.generateSongBookWhammyOrBend(t,n,!1,[e.bendPoints[0].value,d],c,r,h);return}break;case e7.PrebendRelease:switch(e.bendStyle){case e8.Default:u=o;break;case e8.Gradual:u.push(new iF(0,e.bendPoints[0].value)),u.push(new iF(iF.MaxPosition,e.bendPoints[1].value));break;case e8.Fast:let m=nv.getPitchWheel(e.bendPoints[0].value);h(t,0|m),this.generateSongBookWhammyOrBend(t,n,!1,[e.bendPoints[0].value,e.bendPoints[1].value],c,r,h);return}}this.generateWhammyOrBend(t,n,u,r,h)}generateSongBookWhammyOrBend(e,t,i,s,a,r,n){let o=i?e:e+t-a,l=a/(s.length-1);for(let e=0;e<s.length-1;e++){let t=nv.getPitchWheel(s[e]),i=nv.getPitchWheel(s[e+1]),a=o+l*e;this.generateBendValues(a,l,t,i,r,n)}}generateWhammy(e,t,i,s,a){let r=e.whammyBarPoints,n=e.voice.bar.staff.track,o=i.noteOnly;r[0].value>0&&!e.isContinuedWhammy&&t--;let l=(e,t)=>{this._handler.addBend(n.index,e,s,t)},h=[];switch(e.whammyBarType){case tB.Custom:h=r;break;case tB.Dive:switch(e.whammyStyle){case e8.Default:h=r;break;case e8.Gradual:h.push(new iF(0,r[0].value)),h.push(new iF(iF.MaxPosition,r[1].value));break;case e8.Fast:let d=Math.min(o,ix.millisToTicks(this._settings.player.songBookBendDuration,a));this.generateSongBookWhammyOrBend(t,o,!1,[r[0].value,r[1].value],d,a,l);return}break;case tB.Dip:switch(e.whammyStyle){case e8.Default:h=r;break;case e8.Gradual:h.push(new iF(0,r[0].value)),h.push(new iF(iF.MaxPosition/2|0,r[1].value)),h.push(new iF(iF.MaxPosition,r[2].value));break;case e8.Fast:let c=Math.min(o,ix.millisToTicks(this._settings.player.songBookDipDuration,a));this.generateSongBookWhammyOrBend(t,o,!0,[r[0].value,r[1].value,r[2].value],c,a,l);return}break;case tB.Hold:case tB.Predive:h=r;break;case tB.PrediveDive:switch(e.whammyStyle){case e8.Default:h=r;break;case e8.Gradual:h.push(new iF(0,r[0].value)),h.push(new iF(iF.MaxPosition/2|0,r[0].value)),h.push(new iF(iF.MaxPosition,r[1].value));break;case e8.Fast:let u=nv.getPitchWheel(r[0].value);this._handler.addBend(n.index,t,s,0|u);let p=Math.min(o,ix.millisToTicks(this._settings.player.songBookBendDuration,a));this.generateSongBookWhammyOrBend(t,o,!1,[r[0].value,r[1].value],p,a,l);return}}this.generateWhammyOrBend(t,o,h,a,l)}generateWhammyOrBend(e,t,i,s,a){let r=t/iF.MaxPosition;for(let t=0;t<i.length-1;t++){let n=i[t],o=i[t+1],l=nv.getPitchWheel(n.value),h=nv.getPitchWheel(o.value),d=r*(o.offset-n.offset),c=e+r*n.offset;this.generateBendValues(c,d,l,h,s,a)}}generateBendValues(e,t,i,s,a,r){let n=ix.ticksToMillis(t,a),o=Math.abs(s-i)/nv.PitchValuePerSemitone,l=Math.max(nv.MinBreakpointsPerSemitone*o,n/nv.MillisecondsPerBreakpoint),h=t/l,d=(s-i)/l,c=e+t;for(let t=0;t<l;t++)r(0|e,Math.round(i)),i+=d,e+=h;r(0|c,s)}generateRasgueado(e,t,i,s,a,r,n){let o=i;for(let i=0;i<n.durations.length;i++){let l=n.brushInfos[i],h=t.isStringed&&t.string<=l.length?l[t.string-1]:0,d=n.durations[i];this._handler.addNote(e.index,o+h,d-h,s,a,r),o+=d}}generateTrill(e,t,i,s,a,r){let n=e.beat.voice.bar.staff.track,o=e.stringTuning+e.trillFret,l=ix.toTicks(e.trillSpeed),h=!0,d=t,c=t+i.untilTieOrSlideEnd;for(;d+10<c;)d+l>=c&&(l=c-d),this._handler.addNote(n.index,d,l,h?o:s,a,r),h=!h,d+=l}generateTremoloPicking(e,t,i,s,a,r){let n=e.beat.voice.bar.staff.track,o=ix.toTicks(e.beat.tremoloSpeed),l=t,h=t+i.untilTieOrSlideEnd;for(;l+10<h;)l+o>=h&&(o=h-l),this._handler.addNote(n.index,l,o,s,a,r),l+=o}getRasgueadoInfo(e,t){if(!e.hasRasgueado)return null;let i=new nx,s=nv.RasgueadoDurations.get(e.rasgueado).reduce((e,t)=>e+t,0);i.durations=nv.RasgueadoDurations.get(e.rasgueado).map(e=>t*e/s),i.brushInfos=Array(i.durations.length);let a=ix.toTicks(tt.Sixteenth),r=0,n=0;for(let t of e.notes)!t.isTieDestination&&(r|=1<<t.string-1,n++);let o=nv.RasgueadoDirections.get(e.rasgueado);for(let t=0;t<i.durations.length;t++){let s=i.durations[t]*a/ix.QuarterTime,l=new Int32Array(e.voice.bar.staff.tuning.length);i.brushInfos[t]=l;let h=o[t];h!==e9.None&&this.fillBrushInfo(e,l,h===e9.ArpeggioDown||h===e9.BrushDown,r,n,s)}return i}getBrushInfo(e){let t=new Int32Array(e.voice.bar.staff.tuning.length);if(e.brushType){let i=0,s=0;for(let t of e.notes)!t.isTieDestination&&(i|=1<<t.string-1,s++);this.fillBrushInfo(e,t,e.brushType===e9.ArpeggioDown||e.brushType===e9.BrushDown,i,s,e.brushDuration)}return t}fillBrushInfo(e,t,i,s,a,r){if(e.notes.length>0){let n=0,o=r/(a-1)|0;for(let a=0;a<e.voice.bar.staff.tuning.length;a++){let e=i?a:t.length-1-a;(s&1<<e)!=0&&(t[e]=n,n+=o)}}return t}generateNonTempoAutomation(e,t,i){switch(t.type){case e6.Instrument:this.addProgramChange(e.voice.bar.staff.track,e.playbackStart+i,e.voice.bar.staff.track.playbackInfo.primaryChannel,255&t.value),this.addProgramChange(e.voice.bar.staff.track,e.playbackStart+i,e.voice.bar.staff.track.playbackInfo.secondaryChannel,255&t.value);break;case e6.Balance:let s=nv.toChannelShort(t.value);this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+i,e.voice.bar.staff.track.playbackInfo.primaryChannel,t2.PanCoarse,s),this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+i,e.voice.bar.staff.track.playbackInfo.secondaryChannel,t2.PanCoarse,s);break;case e6.Volume:let a=nv.toChannelShort(t.value);this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+i,e.voice.bar.staff.track.playbackInfo.primaryChannel,t2.VolumeCoarse,a),this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+i,e.voice.bar.staff.track.playbackInfo.secondaryChannel,t2.VolumeCoarse,a)}}prepareSingleBeat(e){let t=-1,i=-1,s=e;for(;s&&(-1===t||-1===i);){for(let s of e.automations)switch(s.type){case e6.Instrument:i=s.value;break;case e6.Tempo:t=s.value}s=s.previousBeat}let a=e.voice.bar.staff.track,r=e.voice.bar.masterBar;-1===t&&(t=r.score.tempo);let n=e.playbackStart/r.calculateDuration();for(let e of r.tempoAutomations)if(e.ratioPosition<=n)t=e.value;else break;-1===i&&(i=a.playbackInfo.program);let o=a.playbackInfo.volume;this.generateTrack(a),this._handler.addTimeSignature(0,r.timeSignatureNumerator,r.timeSignatureDenominator),this._handler.addTempo(0,t);let l=nv.toChannelShort(o);return this._handler.addControlChange(0,0,a.playbackInfo.primaryChannel,t2.VolumeCoarse,l),this._handler.addControlChange(0,0,a.playbackInfo.secondaryChannel,t2.VolumeCoarse,l),t}generateSingleBeat(e){let t=this.prepareSingleBeat(e);this.generateBeat(e,-e.playbackStart,e.voice.bar,t)}generateSingleNote(e){let t=this.prepareSingleBeat(e.beat);this.generateNote(e,0,e.beat.playbackDuration,t,new Int32Array(e.beat.voice.bar.staff.tuning.length),null)}}nv.DefaultDurationDead=30,nv.DefaultDurationPalmMute=80,nv.OrnamentKeysUp=[2,2,2,1,1,2,2,2,2,2,1,1],nv.OrnamentKeysDown=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],nv.PitchBendRangeInSemitones=16,nv.PitchValuePerSemitone=iI.DefaultPitchWheel/nv.PitchBendRangeInSemitones,nv.MinBreakpointsPerSemitone=6,nv.MillisecondsPerBreakpoint=150,nv.RasgueadoDirections=new Map([[tv.Ii,[e9.BrushDown,e9.BrushUp]],[tv.Mi,[e9.BrushDown,e9.BrushDown]],[tv.MiiTriplet,[e9.BrushDown,e9.BrushDown,e9.BrushUp]],[tv.MiiAnapaest,[e9.BrushDown,e9.BrushDown,e9.BrushUp]],[tv.PmpTriplet,[e9.BrushUp,e9.BrushDown,e9.BrushDown]],[tv.PmpAnapaest,[e9.BrushUp,e9.BrushDown,e9.BrushDown]],[tv.PeiTriplet,[e9.BrushUp,e9.BrushDown,e9.BrushDown]],[tv.PeiAnapaest,[e9.BrushUp,e9.BrushDown,e9.BrushDown]],[tv.PaiTriplet,[e9.BrushUp,e9.BrushDown,e9.BrushDown]],[tv.PaiAnapaest,[e9.BrushUp,e9.BrushDown,e9.BrushDown]],[tv.AmiTriplet,[e9.BrushDown,e9.BrushDown,e9.BrushDown]],[tv.AmiAnapaest,[e9.BrushDown,e9.BrushDown,e9.BrushDown]],[tv.Ppp,[e9.None,e9.BrushDown,e9.BrushUp]],[tv.Amii,[e9.BrushDown,e9.BrushDown,e9.BrushDown,e9.BrushUp]],[tv.Amip,[e9.BrushDown,e9.BrushDown,e9.BrushDown,e9.BrushUp]],[tv.Eami,[e9.BrushDown,e9.BrushDown,e9.BrushDown,e9.BrushDown]],[tv.Eamii,[e9.BrushDown,e9.BrushDown,e9.BrushDown,e9.BrushDown,e9.BrushUp]],[tv.Peami,[e9.BrushDown,e9.BrushDown,e9.BrushDown,e9.BrushDown,e9.BrushUp]]]),nv.RasgueadoDurations=new Map([[tv.Ii,[ix.toTicks(tt.Eighth),ix.toTicks(tt.Eighth)]],[tv.Mi,[ix.toTicks(tt.Eighth),ix.toTicks(tt.Eighth)]],[tv.MiiTriplet,[ix.toTicks(tt.Eighth)/3,ix.toTicks(tt.Eighth)/3,ix.toTicks(tt.Eighth)/3]],[tv.MiiAnapaest,[ix.toTicks(tt.Sixteenth),ix.toTicks(tt.Sixteenth),ix.toTicks(tt.Eighth)]],[tv.PmpTriplet,[ix.toTicks(tt.Eighth)/3,ix.toTicks(tt.Eighth)/3,ix.toTicks(tt.Eighth)/3]],[tv.PmpAnapaest,[ix.toTicks(tt.Sixteenth)/3,ix.toTicks(tt.Sixteenth)/3,ix.toTicks(tt.Eighth)/3]],[tv.PeiTriplet,[ix.toTicks(tt.Eighth)/3,ix.toTicks(tt.Eighth)/3,ix.toTicks(tt.Eighth)/3]],[tv.PeiAnapaest,[ix.toTicks(tt.Sixteenth),ix.toTicks(tt.Sixteenth),ix.toTicks(tt.Eighth)]],[tv.PaiTriplet,[ix.toTicks(tt.Eighth)/3,ix.toTicks(tt.Eighth)/3,ix.toTicks(tt.Eighth)/3]],[tv.PaiAnapaest,[ix.toTicks(tt.Sixteenth),ix.toTicks(tt.Sixteenth),ix.toTicks(tt.Eighth)]],[tv.AmiTriplet,[ix.toTicks(tt.Eighth)/3,ix.toTicks(tt.Eighth)/3,ix.toTicks(tt.Eighth)/3]],[tv.AmiAnapaest,[ix.toTicks(tt.Sixteenth)/3,ix.toTicks(tt.Sixteenth)/3,ix.toTicks(tt.Eighth)/3]],[tv.Ppp,[ix.toTicks(tt.Sixteenth)/3,ix.toTicks(tt.Sixteenth)/3,ix.toTicks(tt.Eighth)/3]],[tv.Amii,[ix.toTicks(tt.Sixteenth)/3,ix.toTicks(tt.Sixteenth)/3,ix.toTicks(tt.Sixteenth)/3,ix.toTicks(tt.Eighth)]],[tv.Amip,[ix.toTicks(tt.Sixteenth)/3,ix.toTicks(tt.Sixteenth)/3,ix.toTicks(tt.Sixteenth)/3,ix.toTicks(tt.Eighth)]],[tv.Eami,[ix.toTicks(tt.Sixteenth),ix.toTicks(tt.Sixteenth),ix.toTicks(tt.Sixteenth),ix.toTicks(tt.Sixteenth)]],[tv.Eamii,[ix.toTicks(tt.Sixteenth)/5,ix.toTicks(tt.Sixteenth)/5,ix.toTicks(tt.Sixteenth)/5,ix.toTicks(tt.Sixteenth)/5,ix.toTicks(tt.Sixteenth)/5]],[tv.Peami,[ix.toTicks(tt.Sixteenth)/5,ix.toTicks(tt.Sixteenth)/5,ix.toTicks(tt.Sixteenth)/5,ix.toTicks(tt.Sixteenth)/5,ix.toTicks(tt.Sixteenth)/5]]]);class nF{constructor(){this.startTick=0,this.endTick=0}}class nC{constructor(e,t){this.width=0,this.height=0,this.x=e,this.y=t}doLayout(){}paint(e,t,i){}}class nD extends nC{constructor(e=0,t=0){super(e,t),this.beat=null,this.nextGlyph=null,this.previousGlyph=null}}class nE{}nE.Widths=new Map([[tb.Brace,3],[tb.BracketTop,0],[tb.BracketBottom,0],[tb.SystemDivider,0],[tb.GClef,28],[tb.CClef,28],[tb.FClef,28],[tb.UnpitchedPercussionClef1,15],[tb.SixStringTabClef,28],[tb.FourStringTabClef,28],[tb.TimeSig0,14],[tb.TimeSig1,10],[tb.TimeSig2,14],[tb.TimeSig3,14],[tb.TimeSig4,14],[tb.TimeSig5,14],[tb.TimeSig6,14],[tb.TimeSig7,14],[tb.TimeSig8,14],[tb.TimeSig9,14],[tb.TimeSigCommon,14],[tb.TimeSigCutCommon,14],[tb.NoteheadDoubleWholeSquare,14],[tb.NoteheadDoubleWhole,14],[tb.NoteheadWhole,14],[tb.NoteheadHalf,9],[tb.NoteheadBlack,9],[tb.NoteheadNull,9],[tb.NoteheadXOrnate,9],[tb.NoteheadPlusDoubleWhole,16],[tb.NoteheadPlusWhole,10],[tb.NoteheadPlusHalf,10],[tb.NoteheadPlusBlack,10],[tb.NoteheadSquareWhite,11],[tb.NoteheadSquareBlack,11],[tb.NoteheadTriangleUpDoubleWhole,16],[tb.NoteheadTriangleUpWhole,11],[tb.NoteheadTriangleUpHalf,11],[tb.NoteheadTriangleUpBlack,11],[tb.NoteheadTriangleRightWhite,11],[tb.NoteheadTriangleRightBlack,11],[tb.NoteheadTriangleDownDoubleWhole,16],[tb.NoteheadTriangleDownWhole,11],[tb.NoteheadTriangleDownHalf,11],[tb.NoteheadTriangleDownBlack,11],[tb.NoteheadDiamondDoubleWhole,16],[tb.NoteheadDiamondWhole,9],[tb.NoteheadDiamondHalf,9],[tb.NoteheadDiamondBlack,9],[tb.NoteheadDiamondBlackWide,10],[tb.NoteheadDiamondWhite,9],[tb.NoteheadDiamondWhiteWide,9],[tb.NoteheadCircleXDoubleWhole,16],[tb.NoteheadCircleXWhole,9],[tb.NoteheadCircleXHalf,9],[tb.NoteheadCircleX,9],[tb.NoteheadXDoubleWhole,16],[tb.NoteheadXWhole,9],[tb.NoteheadXHalf,9],[tb.NoteheadXBlack,9],[tb.NoteheadParenthesis,9],[tb.NoteheadSlashedBlack1,9],[tb.NoteheadSlashedBlack2,9],[tb.NoteheadSlashedHalf1,9],[tb.NoteheadSlashedHalf2,9],[tb.NoteheadSlashedWhole1,9],[tb.NoteheadSlashedWhole2,9],[tb.NoteheadSlashedDoubleWhole1,16],[tb.NoteheadSlashedDoubleWhole2,16],[tb.NoteheadCircledBlack,9],[tb.NoteheadCircledHalf,9],[tb.NoteheadCircledWhole,9],[tb.NoteheadCircledDoubleWhole,16],[tb.NoteheadCircleSlash,9],[tb.NoteheadHeavyX,13],[tb.NoteheadHeavyXHat,13],[tb.NoteheadSlashVerticalEnds,12],[tb.NoteheadSlashWhiteWhole,32],[tb.NoteheadSlashWhiteHalf,25],[tb.NoteheadRoundWhiteWithDot,9],[tb.NoteheadSquareBlackLarge,9],[tb.NoteheadSquareBlackWhite,9],[tb.NoteheadClusterDoubleWhole3rd,16],[tb.NoteheadClusterWhole3rd,12],[tb.NoteheadClusterHalf3rd,12],[tb.NoteheadClusterQuarter3rd,12],[tb.NoteShapeRoundWhite,9],[tb.NoteShapeRoundBlack,9],[tb.NoteShapeSquareWhite,12],[tb.NoteShapeSquareBlack,12],[tb.NoteShapeTriangleRightWhite,12],[tb.NoteShapeTriangleRightBlack,12],[tb.NoteShapeTriangleLeftWhite,12],[tb.NoteShapeTriangleLeftBlack,12],[tb.NoteShapeDiamondWhite,9],[tb.NoteShapeDiamondBlack,9],[tb.NoteShapeTriangleUpWhite,12],[tb.NoteShapeTriangleUpBlack,12],[tb.NoteShapeMoonWhite,12],[tb.NoteShapeMoonBlack,12],[tb.NoteShapeTriangleRoundWhite,12],[tb.NoteShapeTriangleRoundBlack,12],[tb.NoteQuarterUp,10],[tb.NoteEighthUp,10],[tb.TextBlackNoteLongStem,0],[tb.TextBlackNoteFrac8thLongStem,0],[tb.TextBlackNoteFrac16thLongStem,0],[tb.TextBlackNoteFrac32ndLongStem,0],[tb.TextCont8thBeamLongStem,0],[tb.TextCont16thBeamLongStem,0],[tb.TextCont32ndBeamLongStem,0],[tb.TextAugmentationDot,0],[tb.TextTupletBracketStartLongStem,0],[tb.TextTuplet3LongStem,0],[tb.TextTupletBracketEndLongStem,0],[tb.Tremolo3,12],[tb.Tremolo2,12],[tb.Tremolo1,12],[tb.FlagEighthUp,0],[tb.FlagEighthDown,0],[tb.FlagSixteenthUp,0],[tb.FlagSixteenthDown,0],[tb.FlagThirtySecondUp,0],[tb.FlagThirtySecondDown,0],[tb.FlagSixtyFourthUp,0],[tb.FlagSixtyFourthDown,0],[tb.FlagOneHundredTwentyEighthUp,0],[tb.FlagOneHundredTwentyEighthDown,0],[tb.FlagTwoHundredFiftySixthUp,0],[tb.FlagTwoHundredFiftySixthDown,0],[tb.AccidentalFlat,8],[tb.AccidentalNatural,8],[tb.AccidentalSharp,8],[tb.AccidentalDoubleSharp,8],[tb.AccidentalDoubleFlat,18],[tb.AccidentalQuarterToneFlatArrowUp,8],[tb.AccidentalQuarterToneSharpArrowUp,8],[tb.AccidentalQuarterToneNaturalArrowUp,8],[tb.Segno,0],[tb.Coda,0],[tb.ArticAccentAbove,9],[tb.ArticAccentBelow,9],[tb.ArticStaccatoAbove,9],[tb.ArticStaccatoBelow,9],[tb.ArticTenutoAbove,9],[tb.ArticTenutoBelow,9],[tb.ArticMarcatoAbove,9],[tb.ArticMarcatoBelow,9],[tb.FermataAbove,23],[tb.FermataShortAbove,23],[tb.FermataLongAbove,23],[tb.RestLonga,9],[tb.RestDoubleWhole,9],[tb.RestWhole,9],[tb.RestHalf,9],[tb.RestQuarter,9],[tb.RestEighth,9],[tb.RestSixteenth,9],[tb.RestThirtySecond,12],[tb.RestSixtyFourth,14],[tb.RestOneHundredTwentyEighth,14],[tb.RestTwoHundredFiftySixth,14],[tb.RestHBarLeft,0],[tb.RestHBarMiddle,0],[tb.RestHBarRight,0],[tb.Repeat1Bar,0],[tb.Repeat2Bars,0],[tb.Ottava,0],[tb.OttavaAlta,32],[tb.OttavaBassaVb,29],[tb.Quindicesima,23],[tb.QuindicesimaAlta,46],[tb.DynamicPPPPPP,0],[tb.DynamicPPPPP,0],[tb.DynamicPPPP,0],[tb.DynamicPPP,0],[tb.DynamicPP,0],[tb.DynamicPiano,0],[tb.DynamicMP,0],[tb.DynamicMF,0],[tb.DynamicPF,0],[tb.DynamicForte,0],[tb.DynamicFF,0],[tb.DynamicFFF,0],[tb.DynamicFFFF,0],[tb.DynamicFFFFF,0],[tb.DynamicFFFFFF,0],[tb.DynamicFortePiano,0],[tb.DynamicNiente,0],[tb.DynamicSforzando1,0],[tb.DynamicSforzandoPiano,0],[tb.DynamicSforzandoPianissimo,0],[tb.DynamicSforzato,0],[tb.DynamicSforzatoPiano,0],[tb.DynamicSforzatoFF,0],[tb.DynamicRinforzando1,0],[tb.DynamicRinforzando2,0],[tb.DynamicForzando,0],[tb.OrnamentTrill,20],[tb.OrnamentTurn,26],[tb.OrnamentTurnInverted,26],[tb.OrnamentShortTrill,0],[tb.OrnamentMordent,26],[tb.StringsDownBow,9],[tb.StringsUpBow,9],[tb.KeyboardPedalPed,35],[tb.KeyboardPedalUp,16],[tb.PictEdgeOfCymbal,44],[tb.GuitarString0,20],[tb.GuitarString1,20],[tb.GuitarString2,20],[tb.GuitarString3,20],[tb.GuitarString4,20],[tb.GuitarString5,20],[tb.GuitarString6,20],[tb.GuitarString7,20],[tb.GuitarString8,20],[tb.GuitarString9,20],[tb.GuitarOpenPedal,11],[tb.GuitarClosePedal,11],[tb.GuitarGolpe,13.4],[tb.GuitarFadeIn,13],[tb.GuitarFadeOut,13],[tb.GuitarVolumeSwell,26],[tb.FretboardX,0],[tb.FretboardO,0],[tb.WiggleTrill,9],[tb.WiggleVibratoMediumFast,10],[tb.OctaveBaselineM,13],[tb.OctaveBaselineB,9]]),nE.Heights=new Map([[tb.Brace,34],[tb.BracketTop,0],[tb.BracketBottom,0],[tb.SystemDivider,0],[tb.GClef,0],[tb.CClef,0],[tb.FClef,0],[tb.UnpitchedPercussionClef1,0],[tb.SixStringTabClef,0],[tb.FourStringTabClef,0],[tb.TimeSig0,0],[tb.TimeSig1,0],[tb.TimeSig2,0],[tb.TimeSig3,0],[tb.TimeSig4,0],[tb.TimeSig5,0],[tb.TimeSig6,0],[tb.TimeSig7,0],[tb.TimeSig8,0],[tb.TimeSig9,0],[tb.TimeSigCommon,0],[tb.TimeSigCutCommon,0],[tb.NoteheadDoubleWholeSquare,8],[tb.NoteheadDoubleWhole,8],[tb.NoteheadWhole,8],[tb.NoteheadHalf,8],[tb.NoteheadBlack,8],[tb.NoteheadNull,8],[tb.NoteheadXOrnate,8],[tb.NoteheadPlusDoubleWhole,8],[tb.NoteheadPlusWhole,8],[tb.NoteheadPlusHalf,8],[tb.NoteheadPlusBlack,8],[tb.NoteheadSquareWhite,8],[tb.NoteheadSquareBlack,8],[tb.NoteheadTriangleUpDoubleWhole,8],[tb.NoteheadTriangleUpWhole,8],[tb.NoteheadTriangleUpHalf,8],[tb.NoteheadTriangleUpBlack,8],[tb.NoteheadTriangleRightWhite,8],[tb.NoteheadTriangleRightBlack,8],[tb.NoteheadTriangleDownDoubleWhole,8],[tb.NoteheadTriangleDownWhole,8],[tb.NoteheadTriangleDownHalf,8],[tb.NoteheadTriangleDownBlack,8],[tb.NoteheadDiamondDoubleWhole,8],[tb.NoteheadDiamondWhole,8],[tb.NoteheadDiamondHalf,8],[tb.NoteheadDiamondBlack,8],[tb.NoteheadDiamondBlackWide,9],[tb.NoteheadDiamondWhite,9],[tb.NoteheadDiamondWhiteWide,9],[tb.NoteheadCircleXDoubleWhole,8],[tb.NoteheadCircleXWhole,8],[tb.NoteheadCircleXHalf,8],[tb.NoteheadCircleX,8],[tb.NoteheadXDoubleWhole,8],[tb.NoteheadXWhole,8],[tb.NoteheadXHalf,8],[tb.NoteheadXBlack,8],[tb.NoteheadParenthesis,8],[tb.NoteheadSlashedBlack1,8],[tb.NoteheadSlashedBlack2,8],[tb.NoteheadSlashedHalf1,8],[tb.NoteheadSlashedHalf2,8],[tb.NoteheadSlashedWhole1,8],[tb.NoteheadSlashedWhole2,8],[tb.NoteheadSlashedDoubleWhole1,8],[tb.NoteheadSlashedDoubleWhole2,8],[tb.NoteheadCircledBlack,8],[tb.NoteheadCircledHalf,8],[tb.NoteheadCircledWhole,8],[tb.NoteheadCircledDoubleWhole,8],[tb.NoteheadCircleSlash,8],[tb.NoteheadHeavyX,8],[tb.NoteheadHeavyXHat,8],[tb.NoteheadSlashVerticalEnds,17],[tb.NoteheadSlashWhiteWhole,17],[tb.NoteheadSlashWhiteHalf,17],[tb.NoteheadRoundWhiteWithDot,8],[tb.NoteheadSquareBlackLarge,8],[tb.NoteheadSquareBlackWhite,8],[tb.NoteheadClusterDoubleWhole3rd,8],[tb.NoteheadClusterWhole3rd,8],[tb.NoteheadClusterHalf3rd,8],[tb.NoteheadClusterQuarter3rd,8],[tb.NoteShapeRoundWhite,8],[tb.NoteShapeRoundBlack,8],[tb.NoteShapeSquareWhite,8],[tb.NoteShapeSquareBlack,8],[tb.NoteShapeTriangleRightWhite,8],[tb.NoteShapeTriangleRightBlack,8],[tb.NoteShapeTriangleLeftWhite,8],[tb.NoteShapeTriangleLeftBlack,8],[tb.NoteShapeDiamondWhite,8],[tb.NoteShapeDiamondBlack,8],[tb.NoteShapeTriangleUpWhite,8],[tb.NoteShapeTriangleUpBlack,8],[tb.NoteShapeMoonWhite,8],[tb.NoteShapeMoonBlack,8],[tb.NoteShapeTriangleRoundWhite,8],[tb.NoteShapeTriangleRoundBlack,8],[tb.NoteQuarterUp,8],[tb.NoteEighthUp,8],[tb.TextBlackNoteLongStem,0],[tb.TextBlackNoteFrac8thLongStem,0],[tb.TextBlackNoteFrac16thLongStem,0],[tb.TextBlackNoteFrac32ndLongStem,0],[tb.TextCont8thBeamLongStem,0],[tb.TextCont16thBeamLongStem,0],[tb.TextCont32ndBeamLongStem,0],[tb.TextAugmentationDot,0],[tb.TextTupletBracketStartLongStem,0],[tb.TextTuplet3LongStem,0],[tb.TextTupletBracketEndLongStem,0],[tb.Tremolo3,0],[tb.Tremolo2,0],[tb.Tremolo1,0],[tb.FlagEighthUp,0],[tb.FlagEighthDown,0],[tb.FlagSixteenthUp,0],[tb.FlagSixteenthDown,0],[tb.FlagThirtySecondUp,0],[tb.FlagThirtySecondDown,0],[tb.FlagSixtyFourthUp,0],[tb.FlagSixtyFourthDown,0],[tb.FlagOneHundredTwentyEighthUp,0],[tb.FlagOneHundredTwentyEighthDown,0],[tb.FlagTwoHundredFiftySixthUp,0],[tb.FlagTwoHundredFiftySixthDown,0],[tb.AccidentalFlat,0],[tb.AccidentalNatural,0],[tb.AccidentalSharp,0],[tb.AccidentalDoubleSharp,0],[tb.AccidentalDoubleFlat,0],[tb.AccidentalQuarterToneFlatArrowUp,0],[tb.AccidentalQuarterToneSharpArrowUp,0],[tb.AccidentalQuarterToneNaturalArrowUp,0],[tb.Segno,0],[tb.Coda,0],[tb.ArticAccentAbove,9],[tb.ArticAccentBelow,9],[tb.ArticStaccatoAbove,9],[tb.ArticStaccatoBelow,9],[tb.ArticTenutoAbove,9],[tb.ArticTenutoBelow,9],[tb.ArticMarcatoAbove,9],[tb.ArticMarcatoBelow,9],[tb.FermataAbove,12],[tb.FermataShortAbove,12],[tb.FermataLongAbove,12],[tb.RestLonga,0],[tb.RestDoubleWhole,0],[tb.RestWhole,0],[tb.RestHalf,0],[tb.RestQuarter,0],[tb.RestEighth,0],[tb.RestSixteenth,0],[tb.RestThirtySecond,0],[tb.RestSixtyFourth,0],[tb.RestOneHundredTwentyEighth,0],[tb.RestTwoHundredFiftySixth,0],[tb.RestHBarLeft,0],[tb.RestHBarMiddle,0],[tb.RestHBarRight,0],[tb.Repeat1Bar,0],[tb.Repeat2Bars,0],[tb.Ottava,13],[tb.OttavaAlta,13],[tb.OttavaBassaVb,13],[tb.Quindicesima,13],[tb.QuindicesimaAlta,13],[tb.DynamicPPPPPP,28.4],[tb.DynamicPPPPP,28.4],[tb.DynamicPPPP,28.4],[tb.DynamicPPP,28.4],[tb.DynamicPP,28.4],[tb.DynamicPiano,28.4],[tb.DynamicMP,28.4],[tb.DynamicMF,28.4],[tb.DynamicPF,28.4],[tb.DynamicForte,28.4],[tb.DynamicFF,28.4],[tb.DynamicFFF,28.4],[tb.DynamicFFFF,28.4],[tb.DynamicFFFFF,28.4],[tb.DynamicFFFFFF,28.4],[tb.DynamicFortePiano,28.4],[tb.DynamicNiente,28.4],[tb.DynamicSforzando1,28.4],[tb.DynamicSforzandoPiano,28.4],[tb.DynamicSforzandoPianissimo,28.4],[tb.DynamicSforzato,28.4],[tb.DynamicSforzatoPiano,28.4],[tb.DynamicSforzatoFF,28.4],[tb.DynamicRinforzando1,28.4],[tb.DynamicRinforzando2,28.4],[tb.DynamicForzando,28.4],[tb.OrnamentTrill,24],[tb.OrnamentTurn,18],[tb.OrnamentTurnInverted,18],[tb.OrnamentShortTrill,18],[tb.OrnamentMordent,18],[tb.StringsDownBow,13/.75],[tb.StringsUpBow,13/.75],[tb.KeyboardPedalPed,19],[tb.KeyboardPedalUp,16],[tb.PictEdgeOfCymbal,30],[tb.GuitarString0,20],[tb.GuitarString1,20],[tb.GuitarString2,20],[tb.GuitarString3,20],[tb.GuitarString4,20],[tb.GuitarString5,20],[tb.GuitarString6,20],[tb.GuitarString7,20],[tb.GuitarString8,20],[tb.GuitarString9,20],[tb.GuitarOpenPedal,11],[tb.GuitarClosePedal,11],[tb.GuitarGolpe,13.4],[tb.GuitarFadeIn,13],[tb.GuitarFadeOut,13],[tb.GuitarVolumeSwell,13],[tb.FretboardX,0],[tb.FretboardO,0],[tb.WiggleTrill,6],[tb.WiggleVibratoMediumFast,10],[tb.OctaveBaselineM,0],[tb.OctaveBaselineB,0]]);class nM extends nD{constructor(e,t,i,s){super(e,t),this.glyphScale=0,this.center=!1,this.glyphScale=i,this.symbol=s}doLayout(){this.width=nE.Widths.has(this.symbol)?nE.Widths.get(this.symbol)*this.glyphScale:0,this.height=nE.Heights.has(this.symbol)?nE.Heights.get(this.symbol)*this.glyphScale:0}paint(e,t,i){let s=i.color;this.colorOverride&&(i.color=this.colorOverride),i.fillMusicFontSymbol(e+this.x,t+this.y,this.glyphScale,this.symbol,this.center),i.color=s}}class nL extends nM{constructor(e,t,i,s){super(e,t,s?nL.GraceScale:1,nL.getSymbol(i)),this.centerOnStem=!1,this._isGrace=s}paint(e,t,i){let s=+!!this._isGrace;this.centerOnStem&&(this.center=!0),super.paint(e,t+s,i)}static getSymbol(e){switch(e){case tt.QuadrupleWhole:return tb.NoteheadDoubleWholeSquare;case tt.DoubleWhole:return tb.NoteheadDoubleWhole;case tt.Whole:return tb.NoteheadWhole;case tt.Half:return tb.NoteheadHalf;default:return tb.NoteheadBlack}}}nL.GraceScale=.75;class nI extends nM{constructor(e,t,i,s,a){super(e,t,a?nL.GraceScale:1,nI.getSymbol(i,s,a))}static getSymbol(e,t,i){if(i&&(e=tt.Eighth),t===tR.Up)switch(e){case tt.Eighth:return tb.FlagEighthUp;case tt.Sixteenth:return tb.FlagSixteenthUp;case tt.ThirtySecond:return tb.FlagThirtySecondUp;case tt.SixtyFourth:return tb.FlagSixtyFourthUp;case tt.OneHundredTwentyEighth:return tb.FlagOneHundredTwentyEighthUp;case tt.TwoHundredFiftySixth:return tb.FlagTwoHundredFiftySixthUp;default:return tb.FlagEighthUp}switch(e){case tt.Eighth:return tb.FlagEighthDown;case tt.Sixteenth:return tb.FlagSixteenthDown;case tt.ThirtySecond:return tb.FlagThirtySecondDown;case tt.SixtyFourth:return tb.FlagSixtyFourthDown;case tt.OneHundredTwentyEighth:case tt.TwoHundredFiftySixth:return tb.FlagOneHundredTwentyEighthDown;default:return tb.FlagEighthDown}}}nI.FlagWidth=11;class nA extends nC{get onTimeX(){return this.onNotes.x+this.onNotes.centerX}constructor(e,t){super(0,0),this.ties=[],this.minWidth=0,this.beat=e,this.ties=[],this.voiceContainer=t}addTie(e){e.renderer=this.renderer,this.ties.push(e)}drawBeamHelperAsFlags(e){return e.hasFlag(!1,void 0)}registerLayoutingInfo(e){let t=this.preNotes.computedWidth+this.onNotes.centerX,i=this.onNotes.computedWidth-this.onNotes.centerX,s=this.renderer.helpers.getBeamingHelperForBeat(this.beat);for(let e of(this.beat.graceType!==ti.None?1===this.beat.graceGroup.beats.length?i+=nI.FlagWidth*nL.GraceScale:this.beat.graceIndex<this.beat.graceGroup.beats.length-1?i+=7:i+=nA.GraceBeatPadding:s&&this.drawBeamHelperAsFlags(s)&&(i+=nI.FlagWidth),this.ties))i+=e.width;e.addBeatSpring(this.beat,t,i)}applyLayoutingInfo(e){this.onNotes.updateBeamingHelper(),this.updateWidth()}doLayout(){this.preNotes.x=0,this.preNotes.renderer=this.renderer,this.preNotes.container=this,this.preNotes.doLayout(),this.onNotes.x=this.preNotes.x+this.preNotes.width,this.onNotes.renderer=this.renderer,this.onNotes.container=this,this.onNotes.doLayout();let e=this.beat.notes.length-1;for(;e>=0;)this.createTies(this.beat.notes[e--]);this.renderer.registerTies(this.ties),this.updateWidth()}updateWidth(){if(this.minWidth=this.preNotes.width+this.onNotes.width,!this.beat.isRest)if(1===this.onNotes.beamingHelper.beats.length)this.beat.duration>=tt.Eighth&&(this.minWidth+=20);else switch(this.beat.duration){case tt.OneHundredTwentyEighth:case tt.TwoHundredFiftySixth:this.minWidth+=10}let e=0;for(let t of this.ties)t.width>e&&(e=t.width);this.minWidth+=e,this.width=this.minWidth}scaleToWidth(e){this.onNotes.updateBeamingHelper(),this.width=e}createTies(e){}static getGroupId(e){return`b${e.id}`}paint(e,t,i){if(this.preNotes.isEmpty&&this.onNotes.isEmpty&&0===this.ties.length)return;i.beginGroup(nA.getGroupId(this.beat)),this.preNotes.paint(e+this.x,t+this.y,i),this.onNotes.paint(e+this.x,t+this.y,i);let s=e-this.voiceContainer.x-this.renderer.x,a=t-this.voiceContainer.y-this.renderer.y;for(let e=0,t=this.ties.length;e<t;e++){let t=this.ties[e];t.renderer=this.renderer,t.paint(s,a,i)}i.endGroup()}buildBoundingsLookup(e,t,i,s){let a=new no;if(a.beat=this.beat,this.beat.isEmpty)a.visualBounds=new sy,a.visualBounds.x=t+this.x,a.visualBounds.y=e.visualBounds.y,a.visualBounds.w=this.width,a.visualBounds.h=e.visualBounds.h,a.realBounds=new sy,a.realBounds.x=t+this.x,a.realBounds.y=e.realBounds.y,a.realBounds.w=this.width,a.realBounds.h=e.realBounds.h,a.onNotesX=t+this.x+this.onNotes.centerX;else{a.visualBounds=new sy,a.visualBounds.x=t+this.x,this.preNotes.isEmpty?this.onNotes.isEmpty?a.visualBounds.x=t+this.x:a.visualBounds.x=t+this.x+this.onNotes.x:a.visualBounds.x=t+this.x+this.preNotes.x;let i=0;i=this.onNotes.isEmpty?this.preNotes.isEmpty?t+this.x+this.width:t+this.x+this.preNotes.x+this.preNotes.width:t+this.x+this.onNotes.x+this.onNotes.width,a.visualBounds.w=i-a.visualBounds.x;let s=this.renderer.helpers.getBeamingHelperForBeat(this.beat);(s&&this.drawBeamHelperAsFlags(s)||this.beat.graceType!==ti.None)&&(a.visualBounds.w+=nI.FlagWidth*(this.beat.graceType!==ti.None?nL.GraceScale:1)),a.visualBounds.y=e.visualBounds.y,a.visualBounds.h=e.visualBounds.h,a.realBounds=new sy,a.realBounds.x=t+this.x,a.realBounds.y=e.realBounds.y,a.realBounds.w=this.width,a.realBounds.h=e.realBounds.h,a.onNotesX=t+this.x+this.onNotes.x+this.onNotes.centerX}e.addBeat(a),this.renderer.settings.core.includeNoteBounds&&this.onNotes.buildBoundingsLookup(a,t+this.x,i+this.y)}}nA.GraceBeatPadding=3;class nR{constructor(){this.oldWidth=0,this.newWidth=0,this.settings=null}core(){return this.settings&&this.causeIssue()?this.settings.core:new dM}causeIssue(){return this.settings=null,!0}}class nO{constructor(e){this.activeBeats=e}}class nH{constructor(){this._midiEventQueue=new rn,this.masterVolume=1,this.metronomeVolume=0,this.outSampleRate=44100,this.currentTempo=120,this.timeSignatureNumerator=4,this.timeSignatureDenominator=4,this.activeVoiceCount=0}noteOffAll(e){}resetSoft(){}resetPresets(){}loadPresets(e,t,i,s){}setupMetronomeChannel(e){}synthesizeSilent(e){this.fakeSynthesize()}processMidiMessage(e){}dispatchEvent(e){this._midiEventQueue.enqueue(e)}synthesize(e,t,i){return this.fakeSynthesize()}fakeSynthesize(){let e=[];for(;!this._midiEventQueue.isEmpty;){let t=this._midiEventQueue.dequeue();t.isMetronome&&this.metronomeVolume>0||t.event&&this.processMidiMessage(t.event),e.push(t)}return e}applyTranspositionPitches(e){}setChannelTranspositionPitch(e,t){}channelSetMute(e,t){}channelSetSolo(e,t){}resetChannelStates(){}channelSetMixVolume(e,t){}hasSamplesForProgram(e){return!0}hasSamplesForPercussion(e){return!0}}class nV extends rm{constructor(e,t){super(e,new nH,t),this.synthesizer.output=e,this._backingTrackOutput=e,e.timeUpdate.on(t=>{let i=this.sequencer.mainTimePositionFromBackingTrack(t,e.backingTrackDuration);this.sequencer.fillMidiEventQueueToEndTime(i),this.synthesizer.fakeSynthesize(),this.updateTimePosition(i,!1),this.checkForFinish()})}updateMasterVolume(e){super.updateMasterVolume(e),this._backingTrackOutput.masterVolume=e}updatePlaybackSpeed(e){super.updatePlaybackSpeed(e),this._backingTrackOutput.playbackRate=e}onSampleRequest(){}loadMidiFile(e){this.isSoundFontLoaded||(this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger()),super.loadMidiFile(e)}updateTimePosition(e,t){super.updateTimePosition(e,t),t&&this._backingTrackOutput.seekTo(this.sequencer.mainTimePositionToBackingTrack(e,this._backingTrackOutput.backingTrackDuration))}loadBackingTrack(e){let t=e.backingTrack;t&&(this._backingTrackOutput.loadBackingTrack(t),this.timePosition=0)}updateSyncPoints(e){this.sequencer.mainUpdateSyncPoints(e),this.tickPosition=this.tickPosition}}class nW{constructor(){this.sampleRate=44100,this._seekPosition=0,this.ready=new rl,this.samplesPlayed=new rh,this.timeUpdate=new rh,this.sampleRequest=new rl}get handler(){return this._handler}set handler(e){e&&0!==this._seekPosition&&(e.seekTo(this._seekPosition),this._seekPosition=0),this._handler=e}get backingTrackDuration(){return this.handler?.backingTrackDuration??0}get playbackRate(){return this.handler?.playbackRate??1}set playbackRate(e){let t=this.handler;t&&(t.playbackRate=e)}get masterVolume(){return this.handler?.masterVolume??1}set masterVolume(e){let t=this.handler;t&&(t.masterVolume=e)}seekTo(e){let t=this.handler;t?t.seekTo(e):this._seekPosition=e}loadBackingTrack(e){}open(e){this.ready.trigger()}updatePosition(e){this.timeUpdate.trigger(e)}play(){this.handler?.play()}destroy(){}pause(){this.handler?.pause()}addSamples(e){}resetSamples(){}activate(){}async enumerateOutputDevices(){return[]}async setOutputDevice(e){}async getOutputDevice(){return null}}class nG extends nV{get handler(){return this.output.handler}set handler(e){this.output.handler=e}constructor(e){super(new nW,e)}}class nz{constructor(){this._masterVolume=1,this._metronomeVolume=0,this._countInVolume=0,this._playbackSpeed=1,this._isLooping=!1,this._midiEventsPlayedFilter=[],this.finished=new rl,this.soundFontLoaded=new rl,this.soundFontLoadFailed=new rh,this.midiLoadFailed=new rh,this.midiEventsPlayed=new rh,this.ready=new rl(()=>this.isReady),this.readyForPlayback=new rl(()=>this.isReadyForPlayback),this.midiLoaded=new rh(()=>this._instance?.loadedMidiInfo??null),this.stateChanged=new rh(()=>new au(this.state,!1)),this.positionChanged=new rh(()=>this.currentPosition),this.playbackRangeChanged=new rh(()=>{let e=this.playbackRange;return e?new rc(e):null})}get instance(){return this._instance}set instance(e){this._instance=e;let t=this._instanceEventUnregister;if(t)for(let e of t)e();if(e){let t=[];t.push(e.ready.on(()=>this.ready.trigger())),t.push(e.readyForPlayback.on(()=>this.readyForPlayback.trigger())),t.push(e.finished.on(()=>this.finished.trigger())),t.push(e.soundFontLoaded.on(()=>this.soundFontLoaded.trigger())),t.push(e.soundFontLoadFailed.on(e=>this.soundFontLoadFailed.trigger(e))),t.push(e.midiLoaded.on(e=>{this.midiLoaded.trigger(e)})),t.push(e.midiLoadFailed.on(e=>this.midiLoadFailed.trigger(e))),t.push(e.stateChanged.on(e=>this.stateChanged.trigger(e))),t.push(e.positionChanged.on(e=>{this.positionChanged.trigger(e)})),t.push(e.midiEventsPlayed.on(e=>this.midiEventsPlayed.trigger(e))),t.push(e.playbackRangeChanged.on(e=>this.playbackRangeChanged.trigger(e))),this._instanceEventUnregister=t,this.isReady?(e.masterVolume=this._masterVolume,e.metronomeVolume=this._metronomeVolume,e.countInVolume=this._countInVolume,e.playbackSpeed=this._playbackSpeed,e.isLooping=this._isLooping,e.midiEventsPlayedFilter=this._midiEventsPlayedFilter,this.ready.trigger()):t.push(e.ready.on(()=>{e.masterVolume=this._masterVolume,e.metronomeVolume=this._metronomeVolume,e.countInVolume=this._countInVolume,e.playbackSpeed=this._playbackSpeed,e.isLooping=this._isLooping,e.midiEventsPlayedFilter=this._midiEventsPlayedFilter}))}else this._instanceEventUnregister=void 0}get output(){return this._instance.output}get isReady(){return!!this._instance&&this._instance.isReady}get isReadyForPlayback(){return!!this._instance&&this._instance.isReadyForPlayback}get state(){return this._instance?this._instance.state:t$.Paused}get logLevel(){return iM.logLevel}set logLevel(e){iM.logLevel=e,this._instance&&(this._instance.logLevel=e)}get masterVolume(){return this._masterVolume}set masterVolume(e){e=Math.max(e,iI.MinVolume),this._masterVolume=e,this._instance&&(this._instance.masterVolume=e)}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Math.max(e,iI.MinVolume),this._metronomeVolume=e,this._instance&&(this._instance.metronomeVolume=e)}get playbackSpeed(){return this._playbackSpeed}set playbackSpeed(e){this._playbackSpeed=e,this._instance&&(this._instance.playbackSpeed=e)}get loadedMidiInfo(){return this._instance?this._instance.loadedMidiInfo:void 0}get currentPosition(){return this._instance?this._instance.currentPosition:new ap(0,0,0,0,!1,120,120)}get tickPosition(){return this._instance?this._instance.tickPosition:0}set tickPosition(e){this._instance&&(this._instance.tickPosition=e)}get timePosition(){return this._instance?this._instance.timePosition:0}set timePosition(e){this._instance&&(this._instance.timePosition=e)}get playbackRange(){return this._instance?this._instance.playbackRange:null}set playbackRange(e){this._instance&&(this._instance.playbackRange=e)}get isLooping(){return this._isLooping}set isLooping(e){this._isLooping=e,this._instance&&(this._instance.isLooping=e)}get countInVolume(){return this._countInVolume}set countInVolume(e){this._countInVolume=e,this._instance&&(this._instance.countInVolume=e)}get midiEventsPlayedFilter(){return this._midiEventsPlayedFilter}set midiEventsPlayedFilter(e){this._midiEventsPlayedFilter=e,this._instance&&(this._instance.midiEventsPlayedFilter=e)}destroy(){this._instance&&(this._instance.destroy(),this._instance=void 0)}play(){return!!this._instance&&this._instance.play()}pause(){this._instance&&this._instance.pause()}playPause(){this._instance&&this._instance.playPause()}stop(){this._instance&&this._instance.stop()}playOneTimeMidiFile(e){this._instance&&this._instance.playOneTimeMidiFile(e)}loadSoundFont(e,t){this._instance&&this._instance.loadSoundFont(e,t)}resetSoundFonts(){this._instance&&this._instance.resetSoundFonts()}loadMidiFile(e){this._instance&&this._instance.loadMidiFile(e)}loadBackingTrack(e){this._instance&&this._instance.loadBackingTrack(e)}updateSyncPoints(e){this._instance&&this._instance.updateSyncPoints(e)}applyTranspositionPitches(e){this._instance&&this._instance.applyTranspositionPitches(e)}setChannelTranspositionPitch(e,t){this._instance&&this._instance.setChannelTranspositionPitch(e,t)}setChannelMute(e,t){this._instance&&this._instance.setChannelMute(e,t)}resetChannelStates(){this._instance&&this._instance.resetChannelStates()}setChannelSolo(e,t){this._instance&&this._instance.setChannelSolo(e,t)}setChannelVolume(e,t){this._instance&&this._instance.setChannelVolume(e,t)}}class nU{constructor(){this._width=0,this._score=null,this._trackIndexes=null,this.preRender=new rh,this.renderFinished=new rh,this.partialRenderFinished=new rh,this.partialLayoutFinished=new rh,this.postRenderFinished=new rl,this.error=new rh}get instance(){return this._instance}set instance(e){this._instance=e;let t=this._instanceEventUnregister;if(t)for(let e of t)e();if(e){let t=[];t.push(e.preRender.on(e=>this.preRender.trigger(e))),t.push(e.renderFinished.on(e=>this.renderFinished.trigger(e))),t.push(e.partialRenderFinished.on(e=>this.partialRenderFinished.trigger(e))),t.push(e.partialLayoutFinished.on(e=>this.partialLayoutFinished.trigger(e))),t.push(e.postRenderFinished.on(()=>this.postRenderFinished.trigger())),t.push(e.error.on(e=>this.error.trigger(e))),this._instanceEventUnregister=t,this._settings&&e.updateSettings(this._settings),e.width=this._width,null!==this._score&&e.renderScore(this._score,this._trackIndexes)}else this._instanceEventUnregister=void 0}get boundsLookup(){return this._instance?this._instance.boundsLookup:null}get width(){return this._instance?this._instance.width:0}set width(e){this._width=e,this._instance&&(this._instance.width=e)}render(){this._instance?.render()}resizeRender(){this._instance?.resizeRender()}renderScore(e,t){this._score=e,this._trackIndexes=t,this._instance?.renderScore(e,t)}renderResult(e){this._instance?.renderResult(e)}updateSettings(e){this._settings=e,this._instance?.updateSettings(e)}destroy(){this._instance?.destroy(),this._instance=void 0}}class nX{constructor(e){this.bounds=null,this.beat=e}}class nJ{get actualPlayerMode(){return this._actualPlayerMode}get renderer(){return this._renderer}get score(){return this._score}get tracks(){return this._tracks}constructor(e,t){this._startTime=0,this._trackIndexes=null,this._trackIndexLookup=null,this._isDestroyed=!1,this._score=null,this._tracks=[],this._actualPlayerMode=t7.Disabled,this._tickCache=null,this._cursorWrapper=null,this._barCursor=null,this._beatCursor=null,this._selectionWrapper=null,this._previousTick=0,this._currentBeat=null,this._currentBeatBounds=null,this._isInitialBeatCursorUpdate=!0,this._previousStateForCursor=t$.Paused,this._previousCursorCache=null,this._lastScroll=0,this._beatMouseDown=!1,this._noteMouseDown=!1,this._selectionStart=null,this._selectionEnd=null,this.beatMouseDown=new rh,this.beatMouseMove=new rh,this.beatMouseUp=new rh,this.noteMouseDown=new rh,this.noteMouseMove=new rh,this.noteMouseUp=new rh,this.resize=new rh,this.renderStarted=new rh,this.renderFinished=new rh,this.postRenderFinished=new rl,this.error=new rh,this.midiLoad=new rh,this.settingsUpdated=new rl,this.uiFacade=e,this.container=e.rootContainer,this.activeBeatsChanged=new rh(()=>this._player.state===t$.Playing&&this._currentBeat?new nO(this._currentBeat.beatLookup.highlightedBeats.map(e=>e.beat)):null),this.playedBeatChanged=new rh(()=>this._player.state===t$.Playing&&this._currentBeat?this._currentBeat.beat:null),this.scoreLoaded=new rh(()=>this._score?this._score:null),this.midiLoaded=new rh(()=>this._player.loadedMidiInfo??null),e.initialize(this,t),iM.logLevel=this.settings.core.logLevel,this.settings.handleBackwardsCompatibility(),dE.printEnvironmentInfo(!1),this.canvasElement=e.createCanvasElement(),this.container.appendChild(this.canvasElement),this._renderer=new nU,this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&dE.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?this._renderer.instance=this.uiFacade.createWorkerRenderer():this._renderer.instance=new nu(this.settings),this.container.resize.on(dE.throttle(()=>{this._isDestroyed||this.container.width!==this._renderer.width&&this.triggerResize()},e.resizeThrottle));const i=new nR;i.oldWidth=this._renderer.width,i.newWidth=0|this.container.width,i.settings=this.settings,this.onResize(i),this._renderer.preRender.on(this.onRenderStarted.bind(this)),this._renderer.renderFinished.on(e=>{this.onRenderFinished(e)}),this._renderer.postRenderFinished.on(()=>{let e=Date.now()-this._startTime;iM.debug("rendering",`Rendering completed in ${e}ms`),this.onPostRenderFinished()}),this._renderer.preRender.on(e=>{this._startTime=Date.now()}),this._renderer.partialLayoutFinished.on(e=>this.appendRenderResult(e,!1)),this._renderer.partialRenderFinished.on(this.updateRenderResult.bind(this)),this._renderer.renderFinished.on(e=>{this.appendRenderResult(e,!0)}),this._renderer.error.on(this.onError.bind(this)),this.setupPlayerWrapper(),this.settings.player.playerMode!==t7.Disabled&&this.setupOrDestroyPlayer(),this.setupClickHandling(),this.uiFacade.beginInvoke(()=>{this.uiFacade.initialRender()})}setupPlayerWrapper(){let e=new nz;this._player=e,e.ready.on(()=>{this.loadMidiForScore()}),e.readyForPlayback.on(()=>{if(this.onPlayerReady(),this.tracks)for(let t of this.tracks){let i=t.playbackInfo.volume/16;e.setChannelVolume(t.playbackInfo.primaryChannel,i),e.setChannelVolume(t.playbackInfo.secondaryChannel,i)}}),e.soundFontLoaded.on(this.onSoundFontLoaded.bind(this)),e.soundFontLoadFailed.on(e=>{this.onError(e)}),e.midiLoaded.on(this.onMidiLoaded.bind(this)),e.midiLoadFailed.on(e=>{this.onError(e)}),e.stateChanged.on(this.onPlayerStateChanged.bind(this)),e.positionChanged.on(this.onPlayerPositionChanged.bind(this)),e.midiEventsPlayed.on(this.onMidiEventsPlayed.bind(this)),e.playbackRangeChanged.on(this.onPlaybackRangeChanged.bind(this)),e.finished.on(this.onPlayerFinished.bind(this))}destroy(){this._isDestroyed=!0,this._player.destroy(),this.uiFacade.destroy(),this._renderer.destroy()}updateSettings(){this.settings.handleBackwardsCompatibility();let e=this.score;e&&iW.applyPitchOffsets(this.settings,e),this.updateRenderer(),this._renderer.updateSettings(this.settings),this.setupOrDestroyPlayer(),this.onSettingsUpdated()}updateRenderer(){let e=this._renderer;this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&dE.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?e.instance instanceof nu&&(e.destroy(),e.instance=this.uiFacade.createWorkerRenderer()):e.instance instanceof nu||(e.destroy(),e.instance=new nu(this.settings))}load(e,t){try{return this.uiFacade.load(e,e=>{this.renderScore(e,t)},e=>{this.onError(e)})}catch(e){return this.onError(e),!1}}renderScore(e,t){let i=[];if(t)if(0===t.length)e.tracks.length>0&&i.push(e.tracks[0]);else if(1===t.length&&-1===t[0])for(let t of e.tracks)i.push(t);else for(let s of t)s>=0&&s<=e.tracks.length&&i.push(e.tracks[s]);else e.tracks.length>0&&i.push(e.tracks[0]);this.internalRenderTracks(e,i)}renderTracks(e){if(e.length>0){let t=e[0].score;for(let i of e)if(i.score!==t)return void this.onError(new i6(tE.General,"All rendered tracks must belong to the same score."));this.internalRenderTracks(t,e)}}internalRenderTracks(e,t){if(iW.applyPitchOffsets(this.settings,e),e!==this.score){for(let i of(this._score=e,this._tracks=t,this._tickCache=null,this._trackIndexes=[],t))this._trackIndexes.push(i.index);this._trackIndexLookup=new Set(this._trackIndexes),this.onScoreLoaded(e),this.loadMidiForScore(),this.render()}else{this._tracks=t;let i=iW.computeFirstDisplayedBarIndex(e,this.settings),s=iW.computeLastDisplayedBarIndex(e,this.settings,i);for(let e of(this._tickCache&&(this._tickCache.multiBarRestInfo=iW.buildMultiBarRestInfo(this.tracks,i,s)),this._trackIndexes=[],t))this._trackIndexes.push(e.index);this._trackIndexLookup=new Set(this._trackIndexes),this.render()}}triggerResize(){if(this.container.isVisible){let e=new nR;e.oldWidth=this._renderer.width,e.newWidth=this.container.width,e.settings=this.settings,this.onResize(e),this._renderer.updateSettings(this.settings),this._renderer.width=this.container.width,this._renderer.resizeRender()}else iM.warning("Rendering","AlphaTab container was invisible while autosizing, waiting for element to become visible",null),this.uiFacade.rootContainerBecameVisible.on(()=>{iM.debug("Rendering","AlphaTab container became visible, doing autosizing",null),this.triggerResize()})}appendRenderResult(e,t){t&&(this.canvasElement.width=e.totalWidth,this.canvasElement.height=e.totalHeight,this._cursorWrapper&&(this._cursorWrapper.width=e.totalWidth,this._cursorWrapper.height=e.totalHeight)),(e.width>0||e.height>0)&&this.uiFacade.beginAppendRenderResults(e),t&&this.uiFacade.beginAppendRenderResults(null)}updateRenderResult(e){e&&e.renderResult&&this.uiFacade.beginUpdateRenderResults(e)}tex(e,t){try{let i=new sp;i.logErrors=!0,i.initFromString(e,this.settings);let s=i.readScore();this.renderScore(s,t)}catch(e){this.onError(e)}}loadSoundFont(e,t=!1){return this.uiFacade.loadSoundFont(e,t)}resetSoundFonts(){this._player.resetSoundFonts()}render(){this.uiFacade.canRender?(this._renderer.width=this.container.width,this._renderer.renderScore(this.score,this._trackIndexes)):this.uiFacade.canRenderChanged.on(()=>this.render())}get tickCache(){return this._tickCache}get boundsLookup(){return this._renderer.boundsLookup}get player(){return this._player.instance?this._player:null}get isReadyForPlayback(){return this._player.isReadyForPlayback}get playerState(){return this._player.state}get masterVolume(){return this._player.masterVolume}set masterVolume(e){this._player.masterVolume=e}get metronomeVolume(){return this._player.metronomeVolume}set metronomeVolume(e){this._player.metronomeVolume=e}get countInVolume(){return this._player.countInVolume}set countInVolume(e){this._player.countInVolume=e}get midiEventsPlayedFilter(){return this._player.midiEventsPlayedFilter}set midiEventsPlayedFilter(e){this._player.midiEventsPlayedFilter=e}get tickPosition(){return this._player.tickPosition}set tickPosition(e){this._player.tickPosition=e}get timePosition(){return this._player.timePosition}set timePosition(e){this._player.timePosition=e}get endTick(){return this._player.currentPosition.endTick}get endTime(){return this._player.currentPosition.endTime}get playbackRange(){return this._player.playbackRange}set playbackRange(e){this._player.playbackRange=e,this.updateSelectionCursor(e)}get playbackSpeed(){return this._player.playbackSpeed}set playbackSpeed(e){this._player.playbackSpeed=e}get isLooping(){return this._player.isLooping}set isLooping(e){this._player.isLooping=e}destroyPlayer(){this._player.destroy(),this._previousTick=0,this.destroyCursors()}setupOrDestroyPlayer(){let e=this.settings.player.playerMode;if(e===t7.EnabledAutomatic){let t=this.score;if(!t)return!1;e=t?.backingTrack?.rawAudioFile?t7.EnabledBackingTrack:t7.EnabledSynthesizer}let t=null;if(e===this._actualPlayerMode)return this.updateCursors(),!1;switch(this.destroyPlayer(),this.updateCursors(),e){case t7.Disabled:t=null;break;case t7.EnabledSynthesizer:t=this.uiFacade.createWorkerPlayer();break;case t7.EnabledBackingTrack:t=this.uiFacade.createBackingTrackPlayer();break;case t7.EnabledExternalMedia:t=new nG(this.settings.player.bufferTimeInMilliseconds)}return this._actualPlayerMode=e,!!t&&(this._player.instance=t,!1)}loadMidiForScore(){if(!this.score)return;let e=this.score;iM.debug("AlphaTab","Generating Midi");let t=new s2,i=new ng(t),s=new nv(e,this.settings,i),a=iW.computeFirstDisplayedBarIndex(e,this.settings),r=iW.computeLastDisplayedBarIndex(e,this.settings,a);s.tickLookup.multiBarRestInfo=iW.buildMultiBarRestInfo(this.tracks,a,r),s.applyTranspositionPitches=!1,s.generate(),this._tickCache=s.tickLookup,this.onMidiLoad(t);let n=this._player;n.loadMidiFile(t),n.loadBackingTrack(e),n.updateSyncPoints(s.syncPoints),n.applyTranspositionPitches(s.transpositionPitches)}updateSyncPoints(){if(!this.score)return;let e=this.score;this._player.updateSyncPoints(nv.generateSyncPoints(e))}changeTrackVolume(e,t){for(let i of e)this._player.setChannelVolume(i.playbackInfo.primaryChannel,t),this._player.setChannelVolume(i.playbackInfo.secondaryChannel,t)}changeTrackSolo(e,t){for(let i of e)this._player.setChannelSolo(i.playbackInfo.primaryChannel,t),this._player.setChannelSolo(i.playbackInfo.secondaryChannel,t)}changeTrackMute(e,t){for(let i of e)this._player.setChannelMute(i.playbackInfo.primaryChannel,t),this._player.setChannelMute(i.playbackInfo.secondaryChannel,t)}changeTrackTranspositionPitch(e,t){for(let i of e)this._player.setChannelTranspositionPitch(i.playbackInfo.primaryChannel,t),this._player.setChannelTranspositionPitch(i.playbackInfo.secondaryChannel,t)}play(){return this._player.play()}pause(){this._player.pause()}playPause(){this._player.playPause()}stop(){this._player.stop()}playBeat(e){let t=new s2,i=new ng(t);new nv(e.voice.bar.staff.track.score,this.settings,i).generateSingleBeat(e),this._player.playOneTimeMidiFile(t)}playNote(e){let t=new s2,i=new ng(t);new nv(e.beat.voice.bar.staff.track.score,this.settings,i).generateSingleNote(e),this._player.playOneTimeMidiFile(t)}destroyCursors(){this._cursorWrapper&&(this.uiFacade.destroyCursors(),this._cursorWrapper=null,this._barCursor=null,this._beatCursor=null,this._selectionWrapper=null)}updateCursors(){let e=this.hasCursor;if(e&&!this._cursorWrapper){let e=this.uiFacade.createCursors();e&&(this._cursorWrapper=e.cursorWrapper,this._barCursor=e.barCursor,this._beatCursor=e.beatCursor,this._selectionWrapper=e.selectionWrapper,this._isInitialBeatCursorUpdate=!0),null!==this._currentBeat&&this.cursorUpdateBeat(this._currentBeat,!1,this._previousTick>10,1,!0)}else!e&&this._cursorWrapper&&this.destroyCursors()}cursorUpdateTick(e,t,i,s=!1,a=!1){this._previousTick=e;let r=this._tickCache;if(r){let n=this._trackIndexLookup;if(null!=n&&n.size>0){let o=r.findBeat(n,e,this._currentBeat);o&&this.cursorUpdateBeat(o,t,s,i,a||this.playerState===t$.Paused)}}}cursorUpdateBeat(e,t,i,s,a=!1){let r=e.beat,n=e.nextBeat?.beat??null,o=e.duration,l=e.beatLookup.highlightedBeats;if(!r)return;let h=this._renderer.boundsLookup;if(!h)return;let d=this._currentBeat,c=this._previousCursorCache,u=this._previousStateForCursor;if(!a&&r===d?.beat&&h===c&&u===this._player.state&&d?.start===e.start)return;let p=h.findBeat(r);p&&(this._currentBeat=e,this._previousCursorCache=h,this._previousStateForCursor=this._player.state,this.uiFacade.beginInvoke(()=>{this.internalCursorUpdateBeat(r,n,o,t,l,h,p,i,e.cursorMode,s)}))}scrollToCursor(){let e=this._currentBeatBounds;e&&this.internalScrollToCursor(e.barBounds.masterBarBounds)}internalScrollToCursor(e){let t=this.uiFacade.getScrollContainer(),i=dE.getLayoutEngineFactory(this.settings.display.layoutMode).vertical,s=this.settings.player.scrollMode;if(i){let i=e.realBounds.y+this.settings.player.scrollOffsetY;if(i!==this._lastScroll)switch(this._lastScroll=i,s){case t6.Continuous:let a=this.uiFacade.getOffset(t,this.container);this.uiFacade.scrollToY(t,a.y+i,this.settings.player.scrollSpeed);break;case t6.OffScreen:let r=t.scrollTop+this.uiFacade.getOffset(null,t).h;if(e.visualBounds.y+e.visualBounds.h>=r||e.visualBounds.y<t.scrollTop){let i=e.realBounds.y+this.settings.player.scrollOffsetY;this.uiFacade.scrollToY(t,i,this.settings.player.scrollSpeed)}}}else{let i=e.visualBounds.x;if(i!==this._lastScroll)switch(this._lastScroll=i,s){case t6.Continuous:let a=e.realBounds.x+this.settings.player.scrollOffsetX;this._lastScroll=e.visualBounds.x,this.uiFacade.scrollToX(t,a,this.settings.player.scrollSpeed);break;case t6.OffScreen:let r=t.scrollLeft+this.uiFacade.getOffset(null,t).w;if(e.visualBounds.x+e.visualBounds.w>=r||e.visualBounds.x<t.scrollLeft){let i=e.realBounds.x+this.settings.player.scrollOffsetX;this._lastScroll=e.visualBounds.x,this.uiFacade.scrollToX(t,i,this.settings.player.scrollSpeed)}}}}internalCursorUpdateBeat(e,t,i,s,a,r,n,o,l,h){let d=this._barCursor,c=this._beatCursor,u=n.barBounds.masterBarBounds,p=u.visualBounds,m=this._currentBeatBounds;this._currentBeatBounds=n,d&&d.setBounds(p.x,p.y,p.w,p.h);let g=this._player.state===t$.Playing&&!s,f=u.visualBounds.x+u.visualBounds.w;if(t&&l===it.ToNextBext){let e=r.findBeat(t);e&&e.barBounds.masterBarBounds.staffSystemBounds===u.staffSystemBounds&&(f=e.onNotesX)}let y=n.onNotesX;if(c){if(this.settings.player.enableAnimatedBeatCursor){let e=f-n.onNotesX,t=this._previousTick-this._currentBeat.start,s=this._currentBeat.tickDuration>0?t/this._currentBeat.tickDuration:0;y=n.onNotesX+e*s,i-=i*s,g?((!m||this._isInitialBeatCursorUpdate||p.y!==m.barBounds.masterBarBounds.visualBounds.y||y<m.onNotesX||u.index>m.barBounds.masterBarBounds.index+1)&&(c.transitionToX(0,y),c.setBounds(y,p.y,1,p.h)),this.uiFacade.beginInvoke(()=>{let e=l===it.ToNextBext?2:1,t=y+(f-y)*e;c.transitionToX(i/h*e,t)})):(c.transitionToX(0,y),c.setBounds(y,p.y,1,p.h))}else c.transitionToX(0,y),c.setBounds(y,p.y,1,p.h);this._isInitialBeatCursorUpdate=!1}else this._isInitialBeatCursorUpdate=!0;this.uiFacade.removeHighlights();let b=!1;if(g){if(this.settings.player.enableElementHighlighting)for(let t of a){let i=nA.getGroupId(t.beat);this.uiFacade.highlightElements(i,e.voice.bar.index)}o=!s,b=!0}o&&!this._beatMouseDown&&this.settings.player.scrollMode!==t6.Off&&this.internalScrollToCursor(u),b&&(this.onPlayedBeatChanged(e),this.onActiveBeatsChanged(new nO(a.map(e=>e.beat))))}onPlayedBeatChanged(e){this._isDestroyed||(this.playedBeatChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"playedBeatChanged",e))}onActiveBeatsChanged(e){this._isDestroyed||(this.activeBeatsChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"activeBeatsChanged",e))}get hasCursor(){return this.settings.player.playerMode!==t7.Disabled&&this.settings.player.enableCursor}onBeatMouseDown(e,t){this._isDestroyed||(this.hasCursor&&this.settings.player.enableUserInteraction&&(this._selectionStart=new nX(t),this._selectionEnd=null),this._beatMouseDown=!0,this.beatMouseDown.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseDown",t,e))}onNoteMouseDown(e,t){this._isDestroyed||(this._noteMouseDown=!0,this.noteMouseDown.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseDown",t,e))}onBeatMouseMove(e,t){this._isDestroyed||(this.settings.player.enableUserInteraction&&(!this._selectionEnd||this._selectionEnd.beat!==t)&&(this._selectionEnd=new nX(t),this.cursorSelectRange(this._selectionStart,this._selectionEnd)),this.beatMouseMove.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseMove",t,e))}onNoteMouseMove(e,t){this._isDestroyed||(this.noteMouseMove.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseMove",t,e))}onBeatMouseUp(e,t){if(!this._isDestroyed){if(this.hasCursor&&this.settings.player.enableUserInteraction){if(this._selectionEnd){let e=this._tickCache?.getBeatStart(this._selectionStart.beat)??this._selectionStart.beat.absolutePlaybackStart;if((this._tickCache?.getBeatStart(this._selectionEnd.beat)??this._selectionEnd.beat.absolutePlaybackStart)<e){let e=this._selectionStart;this._selectionStart=this._selectionEnd,this._selectionEnd=e}}if(this._selectionStart&&this._tickCache){let e=this._tickCache,t=e.getMasterBarStart(this._selectionStart.beat.voice.bar.masterBar);if(this._currentBeat=null,this._player.state===t$.Paused&&this.cursorUpdateTick(this._tickCache.getBeatStart(this._selectionStart.beat),!1,1),this.tickPosition=t+this._selectionStart.beat.playbackStart,this._selectionEnd&&this._selectionStart.beat!==this._selectionEnd.beat){let i=e.getMasterBarStart(this._selectionEnd.beat.voice.bar.masterBar),s=new nF;s.startTick=t+this._selectionStart.beat.playbackStart,s.endTick=i+this._selectionEnd.beat.playbackStart+this._selectionEnd.beat.playbackDuration-50,this.playbackRange=s}else this._selectionStart=null,this.playbackRange=null,this.cursorSelectRange(this._selectionStart,this._selectionEnd)}}this.beatMouseUp.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseUp",t,e),this._beatMouseDown=!1}}onNoteMouseUp(e,t){this._isDestroyed||(this.noteMouseUp.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseUp",t,e),this._noteMouseDown=!1)}updateSelectionCursor(e){if(this._tickCache)if(e){let t=this._tickCache.findBeat(this._trackIndexLookup,e.startTick),i=this._tickCache.findBeat(this._trackIndexLookup,e.endTick);if(t&&i){let e=new nX(t.beat),s=new nX(i.beat);this.cursorSelectRange(e,s)}}else this.cursorSelectRange(null,null)}setupClickHandling(){this.canvasElement.mouseDown.on(e=>{if(!e.isLeftMouseButton)return;this.settings.player.enableUserInteraction&&e.preventDefault();let t=e.getX(this.canvasElement),i=e.getY(this.canvasElement),s=this._renderer.boundsLookup?.getBeatAtPos(t,i)??null;if(s&&(this.onBeatMouseDown(e,s),this.settings.core.includeNoteBounds)){let a=this._renderer.boundsLookup?.getNoteAtPos(s,t,i);a&&this.onNoteMouseDown(e,a)}}),this.canvasElement.mouseMove.on(e=>{if(!this._beatMouseDown)return;let t=e.getX(this.canvasElement),i=e.getY(this.canvasElement),s=this._renderer.boundsLookup?.getBeatAtPos(t,i)??null;if(s&&(this.onBeatMouseMove(e,s),this._noteMouseDown)){let a=this._renderer.boundsLookup?.getNoteAtPos(s,t,i);a&&this.onNoteMouseMove(e,a)}}),this.canvasElement.mouseUp.on(e=>{if(!this._beatMouseDown)return;this.settings.player.enableUserInteraction&&e.preventDefault();let t=e.getX(this.canvasElement),i=e.getY(this.canvasElement),s=this._renderer.boundsLookup?.getBeatAtPos(t,i)??null;if(this.onBeatMouseUp(e,s),this._noteMouseDown)if(s){let a=this._renderer.boundsLookup?.getNoteAtPos(s,t,i)??null;this.onNoteMouseUp(e,a)}else this.onNoteMouseUp(e,null)}),this._renderer.postRenderFinished.on(()=>{this._selectionStart&&this.hasCursor&&this.settings.player.enableUserInteraction&&this.cursorSelectRange(this._selectionStart,this._selectionEnd)})}cursorSelectRange(e,t){let i=this._renderer.boundsLookup;if(!i)return;let s=this._selectionWrapper;if(!s||(s.clear(),!e||!t||e.beat===t.beat))return;e.bounds||(e.bounds=i.findBeat(e.beat)),t.bounds||(t.bounds=i.findBeat(t.beat));let a=this._tickCache?.getBeatStart(e.beat)??e.beat.absolutePlaybackStart;if((this._tickCache?.getBeatStart(t.beat)??t.beat.absolutePlaybackStart)<a){let i=e;e=t,t=i}let r=e.bounds.realBounds.x,n=t.bounds.realBounds.x+t.bounds.realBounds.w;if(t.beat.index===t.beat.voice.beats.length-1&&(n=t.bounds.barBounds.masterBarBounds.realBounds.x+t.bounds.barBounds.masterBarBounds.realBounds.w),e.bounds.barBounds.masterBarBounds.staffSystemBounds!==t.bounds.barBounds.masterBarBounds.staffSystemBounds){let a=e.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x,o=e.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x+e.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.w,l=this.uiFacade.createSelectionElement();l.setBounds(r,e.bounds.barBounds.masterBarBounds.visualBounds.y,o-r,e.bounds.barBounds.masterBarBounds.visualBounds.h),s.appendChild(l);let h=e.bounds.barBounds.masterBarBounds.staffSystemBounds.index+1,d=t.bounds.barBounds.masterBarBounds.staffSystemBounds.index;for(let e=h;e<d;e++){let t=i.staffSystems[e],r=this.uiFacade.createSelectionElement();r.setBounds(a,t.visualBounds.y,o-a,t.visualBounds.h),s.appendChild(r)}let c=this.uiFacade.createSelectionElement();c.setBounds(a,t.bounds.barBounds.masterBarBounds.visualBounds.y,n-a,t.bounds.barBounds.masterBarBounds.visualBounds.h),s.appendChild(c)}else{let t=this.uiFacade.createSelectionElement();t.setBounds(r,e.bounds.barBounds.masterBarBounds.visualBounds.y,n-r,e.bounds.barBounds.masterBarBounds.visualBounds.h),s.appendChild(t)}}onScoreLoaded(e){!this._isDestroyed&&(this.scoreLoaded.trigger(e),this.uiFacade.triggerEvent(this.container,"scoreLoaded",e),this.setupOrDestroyPlayer()||this.loadMidiForScore())}onResize(e){this._isDestroyed||(this.resize.trigger(e),this.uiFacade.triggerEvent(this.container,"resize",e))}onRenderStarted(e){this._isDestroyed||(this.renderStarted.trigger(e),this.uiFacade.triggerEvent(this.container,"renderStarted",e))}onRenderFinished(e){this._isDestroyed||(this.renderFinished.trigger(e),this.uiFacade.triggerEvent(this.container,"renderFinished",e))}onPostRenderFinished(){this._isDestroyed||(this._currentBeat=null,this.cursorUpdateTick(this._previousTick,!1,1,!0,!0),this.postRenderFinished.trigger(),this.uiFacade.triggerEvent(this.container,"postRenderFinished",null))}onError(e){this._isDestroyed||(iM.error("API","An unexpected error occurred",e),this.error.trigger(e),this.uiFacade.triggerEvent(this.container,"error",e))}get playerReady(){return this._player.readyForPlayback}onPlayerReady(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playerReady",null)}get playerFinished(){return this._player.finished}onPlayerFinished(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playerFinished",null)}get soundFontLoaded(){return this._player.soundFontLoaded}onSoundFontLoaded(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"soundFontLoaded",null)}onMidiLoad(e){this._isDestroyed||(this.midiLoad.trigger(e),this.uiFacade.triggerEvent(this.container,"midiLoad",e))}onMidiLoaded(e){this._isDestroyed||(this.midiLoaded.trigger(e),this.uiFacade.triggerEvent(this.container,"midiFileLoaded",e))}get playerStateChanged(){return this._player.stateChanged}onPlayerStateChanged(e){if(!this._isDestroyed){if(!e.stopped&&e.state===t$.Paused){let e=this._currentBeat,t=this._tickCache;e&&t&&(this._player.tickPosition=t.getBeatStart(e.beat))}this.uiFacade.triggerEvent(this.container,"playerStateChanged",e)}}get playerPositionChanged(){return this._player.positionChanged}onPlayerPositionChanged(e){this._isDestroyed||(this._previousTick=e.currentTick,this.uiFacade.beginInvoke(()=>{let t=e.modifiedTempo/e.originalTempo;this.cursorUpdateTick(e.currentTick,!1,t,!1,e.isSeek)}),this.uiFacade.triggerEvent(this.container,"playerPositionChanged",e))}get midiEventsPlayed(){return this._player.midiEventsPlayed}onMidiEventsPlayed(e){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"midiEventsPlayed",e)}get playbackRangeChanged(){return this._player.playbackRangeChanged}onPlaybackRangeChanged(e){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playbackRangeChanged",e)}onSettingsUpdated(){this._isDestroyed||(this.settingsUpdated.trigger(),this.uiFacade.triggerEvent(this.container,"settingsUpdated",null))}async enumerateOutputDevices(){return await this._player.output.enumerateOutputDevices()}async setOutputDevice(e){await this._player.output.setOutputDevice(e)}async getOutputDevice(){return await this._player.output.getOutputDevice()}async exportAudio(e){let t;if(!this.score)throw new i6(tE.General,"No song loaded");t=this._actualPlayerMode===t7.EnabledSynthesizer?this.uiFacade.createWorkerAudioExporter(this._player.instance):this.uiFacade.createWorkerAudioExporter(null);let i=this.score,s=new s2,a=new ng(s),r=new nv(i,this.settings,a);r.applyTranspositionPitches=!1,r.generate();let n=new ru;for(let[t,i]of(n.soundFonts=e.soundFonts,n.sampleRate=e.sampleRate,n.useSyncPoints=e.useSyncPoints,n.masterVolume=e.masterVolume,n.metronomeVolume=e.metronomeVolume,n.playbackRange=e.playbackRange,e.trackVolume))if(t<this.score.tracks.length){let e=this.score.tracks[t];n.trackVolume.set(e.playbackInfo.primaryChannel,i),n.trackVolume.set(e.playbackInfo.secondaryChannel,i)}for(let[t,i]of e.trackTranspositionPitches)if(t<this.score.tracks.length){let e=this.score.tracks[t];n.trackTranspositionPitches.set(e.playbackInfo.primaryChannel,i),n.trackTranspositionPitches.set(e.playbackInfo.secondaryChannel,i)}return await t.initialize(n,s,r.syncPoints,r.transpositionPitches),t}}class nY extends i6{constructor(e,t){super(tE.General,e),this.xhr=t,Object.setPrototypeOf(this,nY.prototype)}}class nq{static loadAlphaTex(e,t){let i=new sp;return i.logErrors=!0,i.initFromString(e,t??new rA),i.readScore()}static loadScoreAsync(e,t,i,s){let a=new XMLHttpRequest;a.open("GET",e,!0,null,null),a.responseType="arraybuffer",a.onreadystatechange=()=>{if(a.readyState===XMLHttpRequest.DONE){let e=a.response;if(200===a.status||0===a.status&&e)try{let e=a.response,i=new Uint8Array(e),r=nq.loadScoreFromBytes(i,s);t(r)}catch(e){i(e)}else 0===a.status?i(new nY("You are offline!!\n Please Check Your Network.",a)):404===a.status?i(new nY("Requested URL not found.",a)):500===a.status?i(new nY("Internel Server Error.",a)):"parsererror"===a.statusText?i(new nY("Error.\nParsing JSON Request failed.",a)):"timeout"===a.statusText?i(new nY("Request Time out.",a)):i(new nY(`Unknow Error: ${a.responseText}`,a))}},a.send()}static loadScoreFromBytes(e,t){t||(t=new rA);let i=dE.buildImporters();iM.debug("ScoreLoader",`Loading score from ${e.length} bytes using ${i.length} importers`);let s=null,a=sd.fromBuffer(e);for(let e of i){a.reset();try{iM.debug("ScoreLoader",`Importing using importer ${e.name}`),e.init(a,t),s=e.readScore(),iM.debug("ScoreLoader",`Score imported using ${e.name}`);break}catch(t){if(t instanceof i8)iM.debug("ScoreLoader",`${e.name} does not support the file`);else throw iM.error("ScoreLoader","Score import failed due to unexpected error: ",t),t}}if(s)return s;throw new i8("No compatible importer found for file")}}class n${get isLeftMouseButton(){return 0===this.mouseEvent.button}getX(e){let t=e.element,i=t.getBoundingClientRect().left+t.ownerDocument.defaultView.pageXOffset;return this.mouseEvent.pageX-i}getY(e){let t=e.element,i=t.getBoundingClientRect().top+t.ownerDocument.defaultView.pageYOffset;return this.mouseEvent.pageY-i}preventDefault(){this.mouseEvent.preventDefault()}constructor(e){this.mouseEvent=e}}class nj{get width(){return this.element.offsetWidth}set width(e){this.element.style.width=`${e}px`}get scrollLeft(){return this.element.scrollLeft}set scrollLeft(e){this.element.scrollLeft=e}get scrollTop(){return this.element.scrollTop}set scrollTop(e){this.element.scrollTop=e}get height(){return this.element.offsetHeight}set height(e){e>=0?this.element.style.height=`${e}px`:this.element.style.height="100%"}get isVisible(){return!!this.element.offsetWidth||!!this.element.offsetHeight||!!this.element.getClientRects().length}constructor(e){this._resizeListeners=0,this.lastBounds=new sy,this.element=e,this.mouseDown={on:e=>{let t=t=>{e(new n$(t))};return this.element.addEventListener("mousedown",t,!0),()=>{this.element.removeEventListener("mousedown",t,!0)}},off:e=>{}},this.mouseUp={on:e=>{let t=t=>{e(new n$(t))};return this.element.addEventListener("mouseup",t,!0),()=>{this.element.removeEventListener("mouseup",t,!0)}},off:e=>{}},this.mouseMove={on:e=>{let t=t=>{e(new n$(t))};return this.element.addEventListener("mousemove",t,!0),()=>{this.element.removeEventListener("mousemove",t,!0)}},off:e=>{}};const t=this;this.resize={on:function(e){return 0===t._resizeListeners&&nj.resizeObserver.value.observe(t.element),t.element.addEventListener("resize",e,!0),t._resizeListeners++,()=>this.off(e)},off:e=>{this.element.removeEventListener("resize",e,!0),this._resizeListeners--,this._resizeListeners<=0&&(this._resizeListeners=0,nj.resizeObserver.value.unobserve(this.element))}}}stopAnimation(){this.element.style.transition="none"}transitionToX(e,t){this.element.style.transition=`transform ${e}ms linear`,this.setBounds(t,NaN,NaN,NaN)}setBounds(e,t,i,s){Number.isNaN(e)&&(e=this.lastBounds.x),Number.isNaN(t)&&(t=this.lastBounds.y),Number.isNaN(i)&&(i=this.lastBounds.w),Number.isNaN(s)&&(s=this.lastBounds.h),this.element.style.transform=`translate(${e}px, ${t}px) scale(${i}, ${s})`,this.element.style.transformOrigin="top left",this.lastBounds.x=e,this.lastBounds.y=t,this.lastBounds.w=i,this.lastBounds.h=s}appendChild(e){this.element.appendChild(e.element)}clear(){this.element.innerHTML=""}}nj.resizeObserver=new iD(()=>new ResizeObserver(e=>{for(let t of e){let e=new CustomEvent("resize",{detail:t});t.target.dispatchEvent(e)}}));class nK{constructor(e){this._isStarted=!1,this.isFontLoaded=!1,this.fontLoaded=new rh,this._originalFamilies=e,this._families=e}checkForFontAvailability(){if(dE.isRunningInWorker){this.isFontLoaded=!1;return}if(this._isStarted)return;this._isStarted=!0;let e=0,t=window.setInterval(()=>{iM.warning("Rendering",`Could not load font '${this._families[0]}' within ${(e+1)*5} seconds`,null),this._families.length>1?(this._families.shift(),e=0):e++},5e3);iM.debug("Font",`Start checking for font availablility: ${this._families.join(", ")}`);let i=e=>{this._families.length>1?(iM.debug("Font",`[${this._families[0]}] Loading Failed, switching to ${this._families[1]}`,e),this._families.shift(),window.setTimeout(()=>{a()},0)):(iM.error("Font",`[${this._originalFamilies.join(",")}] Loading Failed, rendering cannot start`,e),window.clearInterval(t))},s=e=>{iM.debug("Font",`[${e}] Font API signaled available`),this.isFontLoaded=!0,window.clearInterval(t),this.fontLoaded.trigger(this._families[0])},a=async()=>{for(let e of this._families)if(await this.isFontAvailable(e,!1))return void s(e);try{await document.fonts.load(`1em ${this._families[0]}`)}catch(e){i(e)}return iM.debug("Font",`[${this._families[0]}] Font API signaled loaded`),await this.isFontAvailable(this._families[0],!0)?s(this._families[0]):i("Font not available"),!0};document.fonts.ready.then(()=>{a()})}isFontAvailable(e,t){return new Promise(i=>{let s=`1em ${e}`;if(document.fonts.check(s))i(!0);else if(t){iM.debug("Font",`Font ${e} not available, creating test element to trigger load`);let t=document.createElement("div");t.style.font=s,t.style.opacity="0",t.style.position="absolute",t.style.top="0",t.style.left="0",t.innerText=`Trigger ${e} load`,document.body.appendChild(t),setTimeout(()=>{document.body.removeChild(t),document.fonts.check(s)?i(!0):i(!1)},200)}else i(!1)})}}class nQ{constructor(e){this._writePosition=0,this._readPosition=0,this.count=0,this._buffer=new Float32Array(e)}clear(){this._readPosition=0,this._writePosition=0,this.count=0,this._buffer=new Float32Array(this._buffer.length)}write(e,t,i){let s=0;i>this._buffer.length-this.count&&(i=this._buffer.length-this.count);let a=Math.min(this._buffer.length-this._writePosition,i);return this._buffer.set(e.subarray(t,t+a),this._writePosition),this._writePosition+=a,this._writePosition%=this._buffer.length,(s+=a)<i&&(this._buffer.set(e.subarray(t+s,t+s+i-s),this._writePosition),this._writePosition+=i-s,s=i),this.count+=s,s}read(e,t,i){i>this.count&&(i=this.count);let s=0,a=Math.min(this._buffer.length-this._readPosition,i);return e.set(this._buffer.subarray(this._readPosition,this._readPosition+a),t),s+=a,this._readPosition+=a,this._readPosition%=this._buffer.length,s<i&&(e.set(this._buffer.subarray(this._readPosition,this._readPosition+i-s),t+s),this._readPosition+=i-s,s=i),this.count-=s,s}}class nZ{constructor(e){this.isDefault=!1,this.device=e}get deviceId(){return this.device.deviceId}get label(){return this.device.label}}class n0{static findKnownDevice(e){return n0._knownDevices.find(t=>t.deviceId===e)}static createAudioContext(){if("AudioContext"in dE.globalThis)return new AudioContext;if("webkitAudioContext"in dE.globalThis)return new webkitAudioContext;throw new i6(tE.General,"AudioContext not found")}static async checkSinkIdSupport(){return"setSinkId"in n0.createAudioContext()||(iM.warning("WebAudio","Browser does not support changing the output device"),!1)}static async enumerateOutputDevices(){try{if(!await n0.checkSinkIdSupport())return[];try{await navigator.mediaDevices.getUserMedia({audio:!0})}catch(e){iM.warning("WebAudio","Output device permission rejected",e)}let e=await navigator.mediaDevices.enumerateDevices(),t="",i="",s=new Map;for(let a of e)"audiooutput"===a.kind&&(s.set(a.groupId,new nZ(a)),("default"===a.deviceId||""===a.deviceId)&&(t=a.groupId,i=a.deviceId));let a=Array.from(s.values()),r=a.find(e=>e.deviceId===i);return r||(r=a.find(e=>e.device.groupId===t)),!r&&a.length>0&&(r=a[0]),r&&(r.isDefault=!0),n0._knownDevices=a,a}catch(e){return iM.error("WebAudio","Failed to enumerate output devices",e),[]}}}n0._knownDevices=[];class n1{constructor(){this._context=null,this._buffer=null,this._source=null,this.ready=new rl,this.samplesPlayed=new rh,this.sampleRequest=new rl}get sampleRate(){return this._context?this._context.sampleRate:n1.PreferredSampleRate}activate(e){this._context||(this._context=n0.createAudioContext()),("suspended"===this._context.state||"interrupted"===this._context.state)&&(iM.debug("WebAudio","Audio Context is suspended, trying resume"),this._context.resume().then(()=>{iM.debug("WebAudio",`Audio Context resume success: state=${this._context?.state}, sampleRate:${this._context?.sampleRate}`),e&&e()},e=>{iM.warning("WebAudio",`Audio Context resume failed: state=${this._context?.state}, sampleRate:${this._context?.sampleRate}, reason=${e}`)}))}patchIosSampleRate(){let e=navigator.userAgent;if(-1!==e.indexOf("iPhone")||-1!==e.indexOf("iPad")){let e=n0.createAudioContext(),t=e.createBuffer(1,1,n1.PreferredSampleRate),i=e.createBufferSource();i.buffer=t,i.connect(e.destination),i.start(0),i.disconnect(0),e.close()}}open(e){this.patchIosSampleRate(),this._context=n0.createAudioContext(),"suspended"===this._context.state&&this.registerResumeHandler()}registerResumeHandler(){this._resumeHandler=(()=>{this.activate(()=>{this.unregisterResumeHandler()})}).bind(this),document.body.addEventListener("touchend",this._resumeHandler,!1),document.body.addEventListener("click",this._resumeHandler,!1)}unregisterResumeHandler(){let e=this._resumeHandler;e&&(document.body.removeEventListener("touchend",e,!1),document.body.removeEventListener("click",e,!1))}play(){let e=this._context;this.activate(),this._buffer=e.createBuffer(2,n1.BufferSize,e.sampleRate),this._source=e.createBufferSource(),this._source.buffer=this._buffer,this._source.loop=!0}pause(){this._source&&(this._source.stop(0),this._source.disconnect()),this._source=null}destroy(){this.pause(),this._context?.close(),this._context=null,this.unregisterResumeHandler()}onSamplesPlayed(e){this.samplesPlayed.trigger(e)}onSampleRequest(){this.sampleRequest.trigger()}onReady(){this.ready.trigger()}enumerateOutputDevices(){return n0.enumerateOutputDevices()}async setOutputDevice(e){await n0.checkSinkIdSupport()&&(e?await this._context.setSinkId(e.deviceId):await this._context.setSinkId(""))}async getOutputDevice(){if(!await n0.checkSinkIdSupport())return null;let e=this._context.sinkId;if("string"!=typeof e||""===e||"default"===e)return null;let t=n0.findKnownDevice(e);if(t)return t;let i=await this.enumerateOutputDevices();return(t=i.find(t=>t.deviceId===e))?t:(iM.warning("WebAudio","Could not find output device in device list",e,i),null)}}n1.BufferSize=4096,n1.PreferredSampleRate=44100;class n2 extends n1{constructor(){super(...arguments),this._audioNode=null,this._bufferCount=0,this._requestedBufferCount=0,this._outputBuffer=new Float32Array(0)}open(e){super.open(e),this._bufferCount=Math.floor(e*this.sampleRate/1e3/n1.BufferSize),this._circularBuffer=new nQ(n1.BufferSize*this._bufferCount),this.onReady()}play(){super.play();let e=this._context;this._audioNode=e.createScriptProcessor(4096,0,2),this._audioNode.onaudioprocess=this.generateSound.bind(this),this._circularBuffer.clear(),this.requestBuffers(),this._source=e.createBufferSource(),this._source.buffer=this._buffer,this._source.loop=!0,this._source.connect(this._audioNode,0,0),this._source.start(0),this._audioNode.connect(e.destination,0,0)}pause(){super.pause(),this._audioNode&&this._audioNode.disconnect(0),this._audioNode=null}addSamples(e){this._circularBuffer.write(e,0,e.length),this._requestedBufferCount--}resetSamples(){this._circularBuffer.clear()}requestBuffers(){let e=this._bufferCount/2|0,t=e*n1.BufferSize;if(this._circularBuffer.count+this._requestedBufferCount*n1.BufferSize<t){for(let t=0;t<e;t++)this.onSampleRequest();this._requestedBufferCount+=e}}generateSound(e){let t=e.outputBuffer.getChannelData(0),i=e.outputBuffer.getChannelData(1),s=t.length+i.length,a=this._outputBuffer;a.length!==s&&(a=new Float32Array(s),this._outputBuffer=a);let r=this._circularBuffer.read(a,0,Math.min(a.length,this._circularBuffer.count)),n=0,o=Math.min(t.length,r);for(let e=0;e<o;e++)t[e]=a[n++],i[e]=a[n++];if(r<t.length)for(let e=r;e<t.length;e++)t[e]=0,i[e]=0;this.onSamplesPlayed(r/iI.AudioChannels),this.requestBuffers()}}class n5{get output(){return this._output}get isReady(){return this._workerIsReady&&this._outputIsReady}get isReadyForPlayback(){return this._workerIsReadyForPlayback}get state(){return this._state}get logLevel(){return iM.logLevel}get worker(){return this._synth}set logLevel(e){iM.logLevel=e,this._synth.postMessage({cmd:"alphaSynth.setLogLevel",value:e})}get masterVolume(){return this._masterVolume}set masterVolume(e){e=Math.max(e,iI.MinVolume),this._masterVolume=e,this._synth.postMessage({cmd:"alphaSynth.setMasterVolume",value:e})}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Math.max(e,iI.MinVolume),this._metronomeVolume=e,this._synth.postMessage({cmd:"alphaSynth.setMetronomeVolume",value:e})}get countInVolume(){return this._countInVolume}set countInVolume(e){e=Math.max(e,iI.MinVolume),this._countInVolume=e,this._synth.postMessage({cmd:"alphaSynth.setCountInVolume",value:e})}get midiEventsPlayedFilter(){return this._midiEventsPlayedFilter}set midiEventsPlayedFilter(e){this._midiEventsPlayedFilter=e,this._synth.postMessage({cmd:"alphaSynth.setMidiEventsPlayedFilter",value:dE.prepareForPostMessage(e)})}get playbackSpeed(){return this._playbackSpeed}set playbackSpeed(e){e=iW.clamp(e,iI.MinPlaybackSpeed,iI.MaxPlaybackSpeed),this._playbackSpeed=e,this._synth.postMessage({cmd:"alphaSynth.setPlaybackSpeed",value:e})}get loadedMidiInfo(){return this.loadedMidiInfo}get currentPosition(){return this._currentPosition}get tickPosition(){return this._currentPosition.currentTick}set tickPosition(e){e<0&&(e=0),this._currentPosition=new ap(this._currentPosition.currentTime,this._currentPosition.endTime,e,this._currentPosition.endTick,!0,this._currentPosition.originalTempo,this._currentPosition.modifiedTempo),this._synth.postMessage({cmd:"alphaSynth.setTickPosition",value:e})}get timePosition(){return this._currentPosition.currentTime}set timePosition(e){e<0&&(e=0),this._currentPosition=new ap(e,this._currentPosition.endTime,this._currentPosition.currentTick,this._currentPosition.endTick,!0,this._currentPosition.originalTempo,this._currentPosition.modifiedTempo),this._synth.postMessage({cmd:"alphaSynth.setTimePosition",value:e})}get isLooping(){return this._isLooping}set isLooping(e){this._isLooping=e,this._synth.postMessage({cmd:"alphaSynth.setIsLooping",value:e})}get playbackRange(){return this._playbackRange}set playbackRange(e){e&&(e.startTick<0&&(e.startTick=0),e.endTick<0&&(e.endTick=0)),this._playbackRange=e,this._synth.postMessage({cmd:"alphaSynth.setPlaybackRange",value:dE.prepareForPostMessage(e)})}constructor(e,t){this._workerIsReadyForPlayback=!1,this._workerIsReady=!1,this._outputIsReady=!1,this._state=t$.Paused,this._masterVolume=0,this._metronomeVolume=0,this._countInVolume=0,this._playbackSpeed=0,this._isLooping=!1,this._playbackRange=null,this._midiEventsPlayedFilter=[],this._currentPosition=new ap(0,0,0,0,!1,120,120),this.ready=new rl,this.readyForPlayback=new rl,this.finished=new rl,this.soundFontLoaded=new rl,this.soundFontLoadFailed=new rh,this.midiLoaded=new rh,this.midiLoadFailed=new rh,this.stateChanged=new rh,this.positionChanged=new rh,this.midiEventsPlayed=new rh,this.playbackRangeChanged=new rh,this._workerIsReadyForPlayback=!1,this._workerIsReady=!1,this._outputIsReady=!1,this._state=t$.Paused,this._masterVolume=0,this._metronomeVolume=0,this._playbackSpeed=0,this._isLooping=!1,this._playbackRange=null,this._output=e,this._output.ready.on(this.onOutputReady.bind(this)),this._output.samplesPlayed.on(this.onOutputSamplesPlayed.bind(this)),this._output.sampleRequest.on(this.onOutputSampleRequest.bind(this)),this._output.open(t.player.bufferTimeInMilliseconds);try{this._synth=dE.createWebWorker(t)}catch(e){iM.error("AlphaSynth",`Failed to create WebWorker: ${e}`)}this._synth.addEventListener("message",this.handleWorkerMessage.bind(this),!1),this._synth.postMessage({cmd:"alphaSynth.initialize",sampleRate:this._output.sampleRate,logLevel:t.core.logLevel,bufferTimeInMilliseconds:t.player.bufferTimeInMilliseconds}),this.masterVolume=1,this.playbackSpeed=1,this.metronomeVolume=0}destroy(){this._synth.postMessage({cmd:"alphaSynth.destroy"})}play(){return this._output.activate(),this._synth.postMessage({cmd:"alphaSynth.play"}),!0}pause(){this._synth.postMessage({cmd:"alphaSynth.pause"})}playPause(){this._output.activate(),this._synth.postMessage({cmd:"alphaSynth.playPause"})}stop(){this._synth.postMessage({cmd:"alphaSynth.stop"})}playOneTimeMidiFile(e){this._synth.postMessage({cmd:"alphaSynth.playOneTimeMidiFile",midi:ne.midiFileToJsObject(dE.prepareForPostMessage(e))})}loadSoundFont(e,t){this._synth.postMessage({cmd:"alphaSynth.loadSoundFontBytes",data:dE.prepareForPostMessage(e),append:t})}resetSoundFonts(){this._synth.postMessage({cmd:"alphaSynth.resetSoundFonts"})}loadMidiFile(e){this._synth.postMessage({cmd:"alphaSynth.loadMidi",midi:ne.midiFileToJsObject(dE.prepareForPostMessage(e))})}applyTranspositionPitches(e){this._synth.postMessage({cmd:"alphaSynth.applyTranspositionPitches",transpositionPitches:JSON.stringify(Array.from(dE.prepareForPostMessage(e).entries()))})}setChannelTranspositionPitch(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelTranspositionPitch",channel:e,semitones:t})}setChannelMute(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelMute",channel:e,mute:t})}resetChannelStates(){this._synth.postMessage({cmd:"alphaSynth.resetChannelStates"})}setChannelSolo(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelSolo",channel:e,solo:t})}setChannelVolume(e,t){t=Math.max(t,iI.MinVolume),this._synth.postMessage({cmd:"alphaSynth.setChannelVolume",channel:e,volume:t})}handleWorkerMessage(e){let t=e.data;switch(t.cmd){case"alphaSynth.ready":this._workerIsReady=!0,this.checkReady();break;case"alphaSynth.destroyed":this._synth.terminate();break;case"alphaSynth.readyForPlayback":this._workerIsReadyForPlayback=!0,this.checkReadyForPlayback();break;case"alphaSynth.positionChanged":this._currentPosition=new ap(t.currentTime,t.endTime,t.currentTick,t.endTick,t.isSeek,t.originalTempo,t.modifiedTempo),this.positionChanged.trigger(this._currentPosition);break;case"alphaSynth.midiEventsPlayed":this.midiEventsPlayed.trigger(new rd(t.events.map(ne.jsObjectToMidiEvent)));break;case"alphaSynth.playerStateChanged":this._state=t.state,this.stateChanged.trigger(new au(t.state,t.stopped));break;case"alphaSynth.playbackRangeChanged":this._playbackRange=t.playbackRange,this.playbackRangeChanged.trigger(new rc(this._playbackRange));break;case"alphaSynth.finished":this.finished.trigger();break;case"alphaSynth.soundFontLoaded":this.soundFontLoaded.trigger();break;case"alphaSynth.soundFontLoadFailed":this.soundFontLoadFailed.trigger(t.error);break;case"alphaSynth.midiLoaded":this.checkReadyForPlayback(),this._loadedMidiInfo=new ap(t.currentTime,t.endTime,t.currentTick,t.endTick,t.isSeek,t.originalTempo,t.modifiedTempo),this.midiLoaded.trigger(this._loadedMidiInfo);break;case"alphaSynth.midiLoadFailed":this.checkReadyForPlayback(),this.midiLoadFailed.trigger(t.error);break;case"alphaSynth.output.addSamples":this._output.addSamples(t.samples);break;case"alphaSynth.output.play":this._output.play();break;case"alphaSynth.output.pause":this._output.pause();break;case"alphaSynth.output.destroy":this._output.destroy();break;case"alphaSynth.output.resetSamples":this._output.resetSamples()}}checkReady(){this.isReady&&this.ready.trigger()}checkReadyForPlayback(){this.isReadyForPlayback&&this.readyForPlayback.trigger()}onOutputSampleRequest(){this._synth.postMessage({cmd:"alphaSynth.output.sampleRequest"})}onOutputSamplesPlayed(e){this._synth.postMessage({cmd:"alphaSynth.output.samplesPlayed",samples:e})}onOutputReady(){this._outputIsReady=!0,this.checkReady()}loadBackingTrack(e){}updateSyncPoints(e){}}class n3{constructor(e,t){this._width=0,this.boundsLookup=null,this.preRender=new rh,this.partialRenderFinished=new rh,this.partialLayoutFinished=new rh,this.renderFinished=new rh,this.postRenderFinished=new rl,this.error=new rh,this._api=e;try{this._worker=dE.createWebWorker(t)}catch(e){iM.error("Rendering",`Failed to create WebWorker: ${e}`);return}this._worker.postMessage({cmd:"alphaTab.initialize",settings:this.serializeSettingsForWorker(t)}),this._worker.addEventListener("message",this.handleWorkerMessage.bind(this))}destroy(){this._worker.terminate()}updateSettings(e){this._worker.postMessage({cmd:"alphaTab.updateSettings",settings:this.serializeSettingsForWorker(e)})}serializeSettingsForWorker(e){let t=ne.settingsToJsObject(dE.prepareForPostMessage(e));return t.delete("player"),t}render(){this._worker.postMessage({cmd:"alphaTab.render"})}resizeRender(){this._worker.postMessage({cmd:"alphaTab.resizeRender"})}renderResult(e){this._worker.postMessage({cmd:"alphaTab.renderResult",resultId:e})}get width(){return this._width}set width(e){this._width=e,this._worker.postMessage({cmd:"alphaTab.setWidth",width:e})}handleWorkerMessage(e){let t=e.data;switch(t.cmd){case"alphaTab.preRender":this.preRender.trigger(t.resize);break;case"alphaTab.partialRenderFinished":this.partialRenderFinished.trigger(t.result);break;case"alphaTab.partialLayoutFinished":this.partialLayoutFinished.trigger(t.result);break;case"alphaTab.renderFinished":this.renderFinished.trigger(t.result);break;case"alphaTab.postRenderFinished":this.boundsLookup=nc.fromJson(t.boundsLookup,this._api.score),this.boundsLookup.finish(),this.postRenderFinished.trigger();break;case"alphaTab.error":this.error.trigger(t.error)}}renderScore(e,t){let i=null==e?null:ne.scoreToJsObject(dE.prepareForPostMessage(e));this._worker.postMessage({cmd:"alphaTab.renderScore",score:i,trackIndexes:dE.prepareForPostMessage(t),fontSizes:na.FontSizeLookupTables})}}class n4{constructor(e,t,i,s){this.cursorWrapper=e,this.barCursor=t,this.beatCursor=i,this.selectionWrapper=s}}class n6{static init(){var e;n6._isRegistered||(n6._isRegistered=!0,registerProcessor("alphatab",((e=class extends AudioWorkletProcessor{constructor(t){super(t),this._outputBuffer=new Float32Array(0),this._bufferCount=0,this._requestedBufferCount=0,this._isStopped=!1,iM.debug("WebAudio","creating processor"),this._bufferCount=Math.floor(t.processorOptions.bufferTimeInMilliseconds*sampleRate/1e3/e.BufferSize),this._circularBuffer=new nQ(e.BufferSize*this._bufferCount),this.port.onmessage=this.handleMessage.bind(this)}handleMessage(e){let t=e.data;switch(t.cmd){case nt.CmdOutputAddSamples:let i=t.samples;this._circularBuffer.write(i,0,i.length),this._requestedBufferCount--;break;case nt.CmdOutputResetSamples:this._circularBuffer.clear();break;case nt.CmdOutputStop:this._isStopped=!0}}process(e,t,i){if(1!==t.length&&2!==t[0].length)return!1;let s=t[0][0],a=t[0][1];if(!s||!a)return!0;let r=s.length+a.length,n=this._outputBuffer;n.length!==r&&(n=new Float32Array(r),this._outputBuffer=n);let o=this._circularBuffer.read(n,0,Math.min(n.length,this._circularBuffer.count)),l=0,h=Math.min(s.length,o);for(let e=0;e<h;e++)s[e]=n[l++],a[e]=n[l++];if(o<s.length)for(let e=o;e<s.length;e++)s[e]=0,a[e]=0;return this.port.postMessage({cmd:nt.CmdOutputSamplesPlayed,samples:o/iI.AudioChannels}),this.requestBuffers(),this._circularBuffer.count>0||!this._isStopped}requestBuffers(){let t=this._bufferCount/2|0,i=t*e.BufferSize;if(this._circularBuffer.count+this._requestedBufferCount*e.BufferSize<i){for(let e=0;e<t;e++)this.port.postMessage({cmd:nt.CmdOutputSampleRequest});this._requestedBufferCount+=t}}}).BufferSize=4096,e)))}}n6._isRegistered=!1;class n8 extends n1{constructor(e){super(),this._worklet=null,this._bufferTimeInMilliseconds=0,this._settings=e}open(e){super.open(e),this._bufferTimeInMilliseconds=e,this.onReady()}play(){super.play();let e=this._context;dE.createAudioWorklet(e,this._settings).then(()=>{this._worklet=new AudioWorkletNode(e,"alphatab",{numberOfOutputs:1,outputChannelCount:[2],processorOptions:{bufferTimeInMilliseconds:this._bufferTimeInMilliseconds}}),this._worklet.port.onmessage=this.handleMessage.bind(this),this._source.connect(this._worklet),this._source.start(0),this._worklet.connect(e.destination)},e=>{iM.error("WebAudio",`Audio Worklet creation failed: reason=${e}`)})}handleMessage(e){let t=e.data;switch(t.cmd){case nt.CmdOutputSamplesPlayed:this.onSamplesPlayed(t.samples);break;case nt.CmdOutputSampleRequest:this.onSampleRequest()}}pause(){super.pause(),this._worklet&&(this._worklet.port.postMessage({cmd:nt.CmdOutputStop}),this._worklet.port.onmessage=null,this._worklet.disconnect()),this._worklet=null}addSamples(e){this._worklet?.port.postMessage({cmd:nt.CmdOutputAddSamples,samples:dE.prepareForPostMessage(e)})}resetSamples(){this._worklet?.port.postMessage({cmd:nt.CmdOutputResetSamples})}}class n7 extends nj{constructor(e,t,i){super(e),this._xscale=t,this._yscale=i}get width(){return this.element.offsetWidth/this._xscale}set width(e){this.element.style.width=`${e*this._xscale}px`}get height(){return this.element.offsetHeight/this._yscale}set height(e){e>=0?this.element.style.height=`${e*this._yscale}px`:this.element.style.height="100%"}setBounds(e,t,i,s){Number.isNaN(e)&&(e=this.lastBounds.x),Number.isNaN(t)&&(t=this.lastBounds.y),Number.isNaN(i)?i=this.lastBounds.w:i/=this._xscale,Number.isNaN(s)?s=this.lastBounds.h:s/=this._yscale,this.element.style.transform=`translate(${e}px, ${t}px) scale(${i}, ${s})`,this.element.style.transformOrigin="top left",this.lastBounds.x=e,this.lastBounds.y=t,this.lastBounds.w=i,this.lastBounds.h=s}}class n9{constructor(){this.sampleRate=44100,this._updateInterval=0,this.ready=new rl,this.samplesPlayed=new rh,this.timeUpdate=new rh,this.sampleRequest=new rl}get backingTrackDuration(){let e=this.audioElement.duration??0;return Number.isFinite(e)?1e3*e:0}get playbackRate(){return this.audioElement.playbackRate}set playbackRate(e){this.audioElement.playbackRate=e}get masterVolume(){return this.audioElement.volume}set masterVolume(e){this.audioElement.volume=e}seekTo(e){this.audioElement.currentTime=e/1e3}loadBackingTrack(e){this.audioElement?.src&&URL.revokeObjectURL(this.audioElement.src);let t=new Blob([e.rawAudioFile]),i=this.audioElement.playbackRate;this.audioElement.src=URL.createObjectURL(t),this.audioElement.playbackRate=i}open(e){let t=document.createElement("audio");t.style.display="none",document.body.appendChild(t),t.addEventListener("seeked",()=>{this.updatePosition()}),t.addEventListener("timeupdate",()=>{this.updatePosition()}),this.audioElement=t,this.ready.trigger()}updatePosition(){let e=1e3*this.audioElement.currentTime;this.timeUpdate.trigger(e)}play(){this.audioElement.play(),this._updateInterval=window.setInterval(()=>{this.updatePosition()},50)}destroy(){let e=this.audioElement;e&&document.body.removeChild(e)}pause(){this.audioElement.pause(),window.clearInterval(this._updateInterval)}addSamples(e){}resetSamples(){}activate(){}async enumerateOutputDevices(){return n0.enumerateOutputDevices()}async setOutputDevice(e){await n0.checkSinkIdSupport()&&(e?await this.audioElement.setSinkId(e.deviceId):await this.audioElement.setSinkId(""))}async getOutputDevice(){if(!await n0.checkSinkIdSupport())return null;let e=this.audioElement.sinkId;if("string"!=typeof e||""===e||"default"===e)return null;let t=n0.findKnownDevice(e);if(t)return t;let i=await this.enumerateOutputDevices();return(t=i.find(t=>t.deviceId===e))?t:(iM.warning("WebAudio","Could not find output device in device list",e,i),null)}}class oe{constructor(e,t){this._promise=null,this._exporterId=oe._nextExporterId++,this._worker=e,this._ownsWorker=t}async initialize(e,t,i,s){let a=this.handleWorkerMessage.bind(this);this._worker.worker.addEventListener("message",a,!1),this._unsubscribe=()=>{this._worker.worker.removeEventListener("message",a,!1)},this._promise=Promise.withResolvers(),this._worker.worker.postMessage({cmd:"alphaSynth.exporter.initialize",exporterId:this._exporterId,options:dE.prepareForPostMessage(e),midi:ne.midiFileToJsObject(dE.prepareForPostMessage(t)),syncPoints:dE.prepareForPostMessage(i),transpositionPitches:dE.prepareForPostMessage(s)}),await this._promise.promise}handleWorkerMessage(e){let t=e.data;if(t.exporterId===this._exporterId)switch(t.cmd){case"alphaSynth.exporter.initialized":this._promise?.resolve(null),this._promise=null;break;case"alphaSynth.exporter.error":this._promise?.reject(t.error),this._promise=null;break;case"alphaSynth.exporter.rendered":this._promise?.resolve(t.chunk),this._promise=null;break;case"alphaSynth.destroyed":this._promise?.reject(new i6(tE.General,"Worker was destroyed")),this._promise=null}}async render(e){if(this._promise)throw new i6(tE.General,"There is already an ongoing operation, wait for initialize to complete before requesting render");return this._promise=Promise.withResolvers(),this._worker.worker.postMessage({cmd:"alphaSynth.exporter.render",exporterId:this._exporterId,milliseconds:e}),await this._promise.promise}destroy(){this._worker.worker.postMessage({cmd:"alphaSynth.exporter.destroy",exporterId:this._exporterId}),this._unsubscribe(),this._ownsWorker&&this._worker.destroy()}[Symbol.dispose](){this.destroy()}}oe._nextExporterId=1,(eE=ii||(ii={}))[eE.LayoutDone=0]="LayoutDone",eE[eE.RenderRequested=1]="RenderRequested",eE[eE.RenderDone=2]="RenderDone",eE[eE.Detached=3]="Detached";class ot{get resizeThrottle(){return 10}get canRender(){return this.areAllFontsLoaded()}areAllFontsLoaded(){let e=!1;for(let t of this._fontCheckers.values())t.isFontLoaded||(e=!0);return!e&&(iM.debug("Font",`All fonts loaded: ${this._fontCheckers.size}`),!0)}onFontLoaded(e){na.generateFontLookup(e),this.areAllFontsLoaded()&&this.canRenderChanged.trigger()}constructor(e){if(this._fontCheckers=new Map,this._contents=null,this._file=null,this._totalResultCount=0,this._initialTrackIndexes=null,this._barToElementLookup=new Map,this._resultIdToElementLookup=new Map,this.rootContainerBecameVisible=new rl,this.canRenderChanged=new rl,this._highlightedElements=[],this._scrollContainer=null,dE.webPlatform!==t9.Browser&&dE.webPlatform!==t9.BrowserModule)throw new i6(tE.General,"Usage of AlphaTabApi is only possible in browser environments. For usage in node use the Low Level APIs");e.classList.add("alphaTab"),this.rootContainer=new nj(e),this.areWorkersSupported="Worker"in window,this._intersectionObserver=new IntersectionObserver(this.onElementVisibilityChanged.bind(this),{threshold:[0,.01,1]}),this._intersectionObserver.observe(e)}onElementVisibilityChanged(e){for(let t of e){let e=t.target;e===this.rootContainer.element?t.isIntersecting&&(this.rootContainerBecameVisible.trigger(),this._intersectionObserver.unobserve(this.rootContainer.element)):"layoutResultId"in e&&this._api.settings.core.enableLazyLoading&&(t.isIntersecting?e.renderedResultId!==e.layoutResultId?this._resultIdToElementLookup.has(e.layoutResultId)?e.resultState!==ii.RenderRequested&&(e.resultState=ii.RenderRequested,this._api.renderer.renderResult(e.layoutResultId)):e.replaceChildren():e.resultState===ii.Detached&&(e.replaceChildren(...e.renderedResult),e.resultState=ii.RenderDone):e.resultState===ii.RenderDone&&(e.resultState=ii.Detached,e.replaceChildren()))}}createWorkerRenderer(){return new n3(this._api,this._api.settings)}initialize(e,t){let i;this._api=e,i=t instanceof rA?t:ne.jsObjectToSettings(t);let s=this.getDataAttributes();rI.fromJson(i,s),i.notation.notationMode===tu.SongBook&&i.setSongBookModeSettings(),e.settings=i,this.setupFontCheckers(i),this._initialTrackIndexes=this.parseTracks(i.core.tracks),this._contents="";let a=e.container;i.core.tex&&(this._contents=a.element.innerHTML,a.element.innerHTML=""),this.createStyleElements(i),this._file=i.core.file}setupFontCheckers(e){this.registerFontChecker(e.display.resources.copyrightFont),this.registerFontChecker(e.display.resources.effectFont),this.registerFontChecker(e.display.resources.fingeringFont),this.registerFontChecker(e.display.resources.graceFont),this.registerFontChecker(e.display.resources.markerFont),this.registerFontChecker(e.display.resources.tablatureFont),this.registerFontChecker(e.display.resources.titleFont),this.registerFontChecker(e.display.resources.wordsFont),this.registerFontChecker(e.display.resources.barNumberFont),this.registerFontChecker(e.display.resources.fretboardNumberFont),this.registerFontChecker(e.display.resources.subTitleFont)}registerFontChecker(e){if(!this._fontCheckers.has(e.families.join(", "))){let t=new nK(e.families);this._fontCheckers.set(e.families.join(", "),t),t.fontLoaded.on(this.onFontLoaded.bind(this)),t.checkForFontAvailability()}}destroy(){this.rootContainer.element.innerHTML="";let e=this._webFont;e.usages--,e.usages<=0&&(e.element.remove(),ot._registeredWebFonts.delete(e.hash))}createCanvasElement(){let e=document.createElement("div");return e.classList.add("at-surface",`at${this._webFont.fontSuffix}`),e.style.fontSize="0",e.style.overflow="hidden",e.style.lineHeight="0",e.style.position="relative",new nj(e)}triggerEvent(e,t,i=null,s){let a=e.element;t=`alphaTab.${t}`;let r=document.createEvent("CustomEvent"),n=s?s.mouseEvent:null;if(r.initCustomEvent(t,!1,!1,i),n&&(r.originalEvent=n),a.dispatchEvent(r),window&&"jQuery"in window){let e=window.jQuery,s=[];s.push(i),n&&s.push(n),e(a).trigger(t,s)}}load(e,t,i){if(e instanceof i3)return t(e),!0;if(e instanceof ArrayBuffer){let i=new Uint8Array(e);return t(nq.loadScoreFromBytes(i,this._api.settings)),!0}return e instanceof Uint8Array?(t(nq.loadScoreFromBytes(e,this._api.settings)),!0):"string"==typeof e&&(nq.loadScoreAsync(e,t,i,this._api.settings),!0)}loadSoundFont(e,t){return!!this._api.player&&(e instanceof ArrayBuffer?(this._api.player.loadSoundFont(new Uint8Array(e),t),!0):e instanceof Uint8Array?(this._api.player.loadSoundFont(e,t),!0):"string"==typeof e&&(this._api.loadSoundFontFromUrl(e,t),!0))}initialRender(){this._api.renderer.preRender.on(e=>{this._totalResultCount=0,this._resultIdToElementLookup.clear(),this._barToElementLookup.clear()});let e=()=>{this._api.renderer.width=0|this.rootContainer.width,this._api.renderer.updateSettings(this._api.settings),this._contents?(this._api.tex(this._contents,this._initialTrackIndexes??void 0),this._initialTrackIndexes=null):this._file&&nq.loadScoreAsync(this._file,e=>{this._api.renderScore(e,this._initialTrackIndexes??void 0),this._initialTrackIndexes=null},e=>{this._api.onError(e)},this._api.settings)};this.rootContainer.isVisible?e():this.rootContainerBecameVisible.on(e)}createStyleElements(e){let t=this._api.container.element.ownerDocument;ot.createSharedStyleElement(t);let i=e.core.smuflFontSources??dM.buildDefaultSmuflFontSources(e.core.fontDirectory),s=ot.cyrb53(i.values()),a=ot._registeredWebFonts;if(a.has(s)){let e=a.get(s);e.usages++,e.checker.fontLoaded.on(this.onFontLoaded.bind(this)),this._webFont=e;return}let r=0===a.size?"":String(a.size),n=`alphaTab${r}`,o=Array.from(i.entries()).map(e=>`url(${JSON.stringify(e[1])}) format('${ot.cssFormat(e[0])}')`).join(","),l=`
            @font-face {
                font-display: block;
                font-family: '${n}';
                src: ${o};
                font-weight: normal;
                font-style: normal;
            }
            .at-surface.at${r} .at {
                font-family: '${n}';
                speak: none;
                font-style: normal;
                font-weight: normal;
                font-variant: normal;
                text-transform: none;
                line-height: 1;
                line-height: 1;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                font-size: ${dE.MusicFontSize}px;
                overflow: visible !important;
            }`,h=t.createElement("style");h.id=`alphaTabStyle${r}`,h.innerHTML=l,t.getElementsByTagName("head").item(0).appendChild(h);let d=new nK([n]);d.fontLoaded.on(this.onFontLoaded.bind(this)),this._fontCheckers.set(n,d),d.checkForFontAvailability(),e.display.resources.smuflFont=new r_(n,dE.MusicFontSize,t5.Plain,t3.Regular);let c={hash:s,element:h,fontSuffix:r,usages:1,checker:d};a.set(s,c),this._webFont=c}static cssFormat(e){switch(e){case ic.EmbeddedOpenType:return"embedded-opentype";case ic.Woff:return"woff";case ic.Woff2:return"woff2";case ic.OpenType:return"opentype";case ic.TrueType:return"truetype";case ic.Svg:return"svg"}}static cyrb53(e,t=0){let i=0xdeadbeef^t,s=0x41c6ce57^t;for(let t of e)for(let e=0;e<t.length;e++){let a=t.charCodeAt(e);i=Math.imul(i^a,0x9e3779b1),s=Math.imul(s^a,0x5f356495)}return i=Math.imul(i^i>>>16,0x85ebca6b)^Math.imul(s^s>>>13,0xc2b2ae35),0x100000000*(2097151&(s=Math.imul(s^s>>>16,0x85ebca6b)^Math.imul(i^i>>>13,0xc2b2ae35)))+(i>>>0)}static createSharedStyleElement(e){let t=e.getElementById("alphaTabStyle");if(!t){(t=document.createElement("style")).id="alphaTabStyleShared";let e=`
                .at-surface * {
                    cursor: default;
                    vertical-align: top;
                    overflow: visible;
                }
                .at-surface-svg text {
                    dominant-baseline: central;
                    white-space:pre;
                }`;t.innerHTML=e,document.getElementsByTagName("head").item(0).appendChild(t)}}parseTracks(e){if(!e)return[];let t=[];if("string"==typeof e)try{if("all"===e)return[-1];e=JSON.parse(e)}catch(t){e=[0]}if("number"==typeof e)t.push(e);else if("length"in e){let i=e.length,s=e;for(let e=0;e<i;e++){let i=s[e],a=0;((a="number"==typeof i?i:"index"in i?i.index:Number.parseInt(i.toString()))>=0||-1===a)&&t.push(a)}}else"index"in e&&t.push(e.index);return t}getDataAttributes(){let e=new Map,t=this._api.container.element;if(t.dataset)for(let i of Object.keys(t.dataset)){let s=t.dataset[i];try{let e=s;s=JSON.parse(e)}catch(e){""===s&&(s=null)}e.set(i,s)}else for(let i=0;i<t.attributes.length;i++){let s=t.attributes.item(i),a=s.nodeName;if(a.startsWith("data-")){let t=a.substr(5).split("-"),i=t[0];for(let e=1;e<t.length;e++)i+=t[e].substr(0,1).toUpperCase()+t[e].substr(1);let r=s.nodeValue;try{r=JSON.parse(r)}catch(e){""===r&&(r=null)}e.set(i,r)}}return e}beginUpdateRenderResults(e){if(!this._resultIdToElementLookup.has(e.id))return;let t=this._resultIdToElementLookup.get(e.id),i=e.renderResult;"string"==typeof i?t.innerHTML=i:"nodeType"in i&&t.replaceChildren(i),t.resultState=ii.RenderDone,t.renderedResultId=e.id,t.renderedResult=Array.from(t.children)}beginAppendRenderResults(e){let t=this._api.canvasElement.element;if(e){let i;this._totalResultCount<t.childElementCount?i=t.childNodes.item(this._totalResultCount):(i=document.createElement("div"),t.appendChild(i)),i.style.zIndex="1",i.style.position="absolute",i.style.left=`${e.x}px`,i.style.top=`${e.y}px`,i.style.width=`${e.width}px`,i.style.height=`${e.height}px`,i.style.display="inline-block",i.layoutResultId=e.id,i.resultState=ii.LayoutDone,i.renderedResultId=void 0,i.renderedResult=void 0,this._resultIdToElementLookup.set(e.id,i);for(let t=e.firstMasterBarIndex;t<=e.lastMasterBarIndex;t++)t>=0&&this._barToElementLookup.set(t,i);this._api.settings.core.enableLazyLoading&&(this._intersectionObserver.unobserve(i),this._intersectionObserver.observe(i)),this._totalResultCount++}else for(;t.childElementCount>this._totalResultCount;)this._api.settings.core.enableLazyLoading&&this._intersectionObserver.unobserve(t.lastChild),t.removeChild(t.lastElementChild)}createWorkerPlayer(){let e=null,t="ScriptProcessorNode"in window;return window.isSecureContext&&"AudioWorkletNode"in window&&this._api.settings.player.outputMode===t8.WebAudioAudioWorklets?(iM.debug("Player","Will use webworkers for synthesizing and web audio api with worklets for playback"),e=new n5(new n8(this._api.settings),this._api.settings)):t&&(iM.debug("Player","Will use webworkers for synthesizing and web audio api with ScriptProcessor for playback"),e=new n5(new n2,this._api.settings)),e?e.ready.on(()=>{this._api.settings.player.soundFont&&this._api.loadSoundFontFromUrl(this._api.settings.player.soundFont,!1)}):iM.error("Player","Player requires webworkers and web audio api, browser unsupported",null),e}createWorkerAudioExporter(e){let t=null===e||!(e instanceof n5);return t&&(e=this.createWorkerPlayer()),new oe(e,t)}beginInvoke(e){window.requestAnimationFrame(()=>{e()})}highlightElements(e,t){let i=this._barToElementLookup.get(t);if(i){let t=i.getElementsByClassName(e);for(let e=0;e<t.length;e++)t.item(e).classList.add("at-highlight"),this._highlightedElements.push(t.item(e))}}removeHighlights(){let e=this._highlightedElements;if(e){for(let t of e)t.classList.remove("at-highlight");this._highlightedElements=[]}}destroyCursors(){let e=this._api.container.element,t=e.querySelector(".at-cursors");e.removeChild(t)}createCursors(){let e=this._api.container.element,t=document.createElement("div");t.classList.add("at-cursors");let i=document.createElement("div");i.classList.add("at-selection");let s=this.createScalingElement(),a=this.createScalingElement(),r=s.element;r.classList.add("at-cursor-bar");let n=a.element;return n.classList.add("at-cursor-beat"),e.style.position="relative",e.style.textAlign="left",t.style.position="absolute",t.style.zIndex="1000",t.style.display="inline",t.style.pointerEvents="none",i.style.position="absolute",r.style.position="absolute",r.style.left="0",r.style.top="0",r.style.willChange="transform",s.width=1,s.height=1,s.setBounds(0,0,1,1),n.style.position="absolute",n.style.transition="all 0s linear",n.style.left="0",n.style.top="0",n.style.willChange="transform",a.width=3,a.height=1,a.setBounds(0,0,1,1),e.insertBefore(t,e.firstChild),t.appendChild(i),t.appendChild(r),t.appendChild(n),new n4(new nj(t),s,a,new nj(i))}getOffset(e,t){let i=t.element,s=i.getBoundingClientRect(),a=s.top+i.ownerDocument.defaultView.pageYOffset,r=s.left+i.ownerDocument.defaultView.pageXOffset;if(e){let t=e.element,i=t.nodeName.toLowerCase();if("html"!==i&&"body"!==i){let i=this.getOffset(null,e);a=a+t.scrollTop-i.y,r=r+t.scrollLeft-i.x}}let n=new sy;return n.x=r,n.y=a,n.w=s.width,n.h=s.height,n}getScrollContainer(){if(this._scrollContainer)return this._scrollContainer;let e="string"==typeof this._api.settings.player.scrollElement?document.querySelector(this._api.settings.player.scrollElement):this._api.settings.player.scrollElement,t=e.nodeName.toLowerCase();return("html"===t||"body"===t)&&(e="scrollingElement"in document?document.scrollingElement:-1!==navigator.userAgent.indexOf("WebKit")?document.body:document.documentElement),this._scrollContainer=new nj(e),this._scrollContainer}createSelectionElement(){return this.createScalingElement()}createScalingElement(){let e=document.createElement("div");e.style.position="absolute";let t=new n7(e,100,100);return t.width=1,t.height=1,t.setBounds(0,0,1,1),t}scrollToY(e,t,i){this.internalScrollToY(e.element,t,i)}scrollToX(e,t,i){this.internalScrollToX(e.element,t,i)}internalScrollToY(e,t,i){if(this._api.settings.player.nativeBrowserSmoothScroll)e.scrollTo({top:t,behavior:"smooth"});else{let s=e.scrollTop,a=t-s,r=0,n=t=>{0===r&&(r=t);let o=t-r;e.scrollTop=s+a*Math.min(o/i,1)|0,o<i&&window.requestAnimationFrame(n)};window.requestAnimationFrame(n)}}internalScrollToX(e,t,i){if(this._api.settings.player.nativeBrowserSmoothScroll)e.scrollTo({left:t,behavior:"smooth"});else{let s=e.scrollLeft,a=t-s,r=0,n=t=>{0===r&&(r=t);let o=t-r;e.scrollLeft=s+a*Math.min(o/i,1)|0,o<i&&window.requestAnimationFrame(n)};window.requestAnimationFrame(n)}}createBackingTrackPlayer(){return new nV(new n9,this._api.settings.player.bufferTimeInMilliseconds)}}ot._registeredWebFonts=new Map;class oi{constructor(e,t){this.loaded=e,this.total=t}}class os extends nJ{constructor(e,t){super(new ot(e),t),this.soundFontLoad=new rh}tex(e,t){let i=this.uiFacade;super.tex(e,i.parseTracks(t))}print(e,t=null){let i=window.open("","","width=0,height=0"),s=i.document.createElement("div");e?s.style.width=e:this.settings.display.layoutMode===eX.Horizontal?s.style.width="297mm":s.style.width="210mm",i.document.write(`
        <!DOCTYPE html>
        <html>
          <head>
            <style>
            .at-surface {
                width: auto !important;
                height: auto !important;
            }
            .at-surface > div {
                position: relative!important;
                left: auto !important;
                top: auto !important;
                break-inside: avoid;
            }
            </style>
          </head>
          <body></body>
        </html>
        `);let a=this.score;a&&(a.artist&&a.title?i.document.title=`${a.title} - ${a.artist}`:a.title&&(i.document.title=`${a.title}`)),i.document.body.appendChild(s);let r=void 0!==window.screenLeft?window.screenLeft:window.left,n=void 0!==window.screenTop?window.screenTop:window.top,o="innerWidth"in window?window.innerWidth:"clientWidth"in document.documentElement?document.documentElement.clientWidth:window.screen.width,l="innerHeight"in window?window.innerHeight:"clientHeight"in document.documentElement?document.documentElement.clientHeight:window.screen.height,h=s.offsetWidth+50,d=window.innerHeight;i.resizeTo(h,d),i.moveTo((o/2|0)-(h/2|0)+r,(l/2|0)-(d/2|0)+n),i.focus();let c=ne.jsObjectToSettings(ne.settingsToJsObject(this.settings));c.core.enableLazyLoading=!1,c.core.useWorkers=!0,c.core.file=null,c.core.tracks=null,c.player.enableCursor=!1,c.player.playerMode=t7.Disabled,c.player.enableElementHighlighting=!1,c.player.enableUserInteraction=!1,c.player.soundFont=null,c.display.scale=.8,c.display.stretchForce=.8,rI.fromJson(c,t);let u=new os(s,c);i.onunload=()=>{u.destroy()},u.renderer.postRenderFinished.on(()=>{i.print()}),u.renderTracks(this.tracks)}downloadMidi(e=tY.SingleTrackMultiChannel){if(!this.score)return;let t=new s2;t.format=e;let i=new ng(t,!0);new nv(this.score,this.settings,i).generate();let s=t.toBinary(),a=this.score.title?`${this.score.title}.mid`:"File.mid",r=document.createElement("a");r.download=a;let n=new Blob([s],{type:"audio/midi"});r.href=URL.createObjectURL(n),r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r)}changeTrackMute(e,t){let i=this.trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackMute(i,t)}changeTrackSolo(e,t){let i=this.trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackSolo(i,t)}changeTrackVolume(e,t){let i=this.trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackVolume(i,t)}trackIndexesToTracks(e){if(!this.score)return[];let t=[];if(1===e.length&&-1===e[0])for(let e of this.score.tracks)t.push(e);else for(let i of e)i>=0&&i<this.score.tracks.length&&t.push(this.score.tracks[i]);return t}loadSoundFontFromUrl(e,t){let i=this.player;if(!i)return;iM.debug("AlphaSynth",`Start loading Soundfont from url ${e}`);let s=new XMLHttpRequest;s.open("GET",e,!0,null,null),s.responseType="arraybuffer",s.onload=e=>{let i=new Uint8Array(s.response);this.loadSoundFont(i,t)},s.onerror=e=>{iM.error("AlphaSynth",`Loading failed: ${e.message}`),i.soundFontLoadFailed.trigger(new nY(e.message,s))},s.onprogress=e=>{iM.debug("AlphaSynth",`Soundfont downloading: ${e.loaded}/${e.total} bytes`);let t=new oi(e.loaded,e.total);this.soundFontLoad.trigger(t),this.uiFacade.triggerEvent(this.container,"soundFontLoad",t)},s.send()}}class oa{constructor(){this._initListeners=[]}exec(e,t,i){if("string"!=typeof t&&(i=[t],t="init"),95===t.charCodeAt(0)||"exec"===t)return null;let s=new jQuery(e),a=s.data("alphaTab");if("destroy"===t&&!a)return null;if("init"!==t&&!a)throw Error("alphaTab not initialized");let r=this[t];if(r){let e=[s,a].concat(i);return r.apply(this,e)}return iM.error("Api",`Method '${t}' does not exist on jQuery.alphaTab`),null}init(e,t,i){if(!t)for(let s of(t=new os(e[0],i),e.data("alphaTab",t),this._initListeners))s(e,t,i)}destroy(e,t){e.removeData("alphaTab"),t.destroy()}print(e,t,i,s){t.print(i,s)}load(e,t,i,s){return t.load(i,s)}render(e,t){t.render()}renderScore(e,t,i,s){t.renderScore(i,s)}renderTracks(e,t,i){t.renderTracks(i)}invalidate(e,t){t.render()}tex(e,t,i,s){t.tex(i,s)}muteTrack(e,t,i,s){t.changeTrackMute(i,s)}soloTrack(e,t,i,s){t.changeTrackSolo(i,s)}trackVolume(e,t,i,s){t.changeTrackVolume(i,s)}loadSoundFont(e,t,i,s){t.loadSoundFont(i,s)}resetSoundFonts(e,t){t.resetSoundFonts()}pause(e,t){t.pause()}play(e,t){return t.play()}playPause(e,t){t.playPause()}stop(e,t){t.stop()}api(e,t){return t}player(e,t){return t.player}isReadyForPlayback(e,t){return t.isReadyForPlayback}playerState(e,t){return t.playerState}masterVolume(e,t,i){return"number"==typeof i&&(t.masterVolume=i),t.masterVolume}metronomeVolume(e,t,i){return"number"==typeof i&&(t.metronomeVolume=i),t.metronomeVolume}countInVolume(e,t,i){return"number"==typeof i&&(t.countInVolume=i),t.countInVolume}midiEventsPlayedFilter(e,t,i){return Array.isArray(i)&&(t.midiEventsPlayedFilter=i),t.midiEventsPlayedFilter}playbackSpeed(e,t,i){return"number"==typeof i&&(t.playbackSpeed=i),t.playbackSpeed}tickPosition(e,t,i){return"number"==typeof i&&(t.tickPosition=i),t.tickPosition}timePosition(e,t,i){return"number"==typeof i&&(t.timePosition=i),t.timePosition}loop(e,t,i){return"boolean"==typeof i&&(t.isLooping=i),t.isLooping}renderer(e,t){return t.renderer}score(e,t){return t.score}settings(e,t){return t.settings}tracks(e,t){return t.tracks}_oninit(e){this._initListeners.push(e)}static restore(e){new jQuery(e).empty().removeData("alphaTab")}}class or{constructor(){this.buffer="",this._currentPath="",this._currentPathIsEmpty=!0,this.scale=1,this.color=new si(255,255,255,255),this.lineWidth=1,this.font=new r_("Arial",10,t5.Plain),this.textAlign=tS.Left,this.textBaseline=t_.Top}destroy(){}beginRender(e,t){this.scale=this.settings.display.scale,this.buffer=`<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${0|e}px" height="${0|t}px" class="at-surface-svg">
`,this._currentPath="",this._currentPathIsEmpty=!0,this.textBaseline=t_.Top}beginGroup(e){this.buffer+=`<g class="${e}">`}endGroup(){this.buffer+="</g>"}endRender(){return this.buffer+="</svg>",this.buffer}fillRect(e,t,i,s){i>0&&(this.buffer+=`<rect x="${e*this.scale|0}" y="${t*this.scale|0}" width="${i*this.scale}" height="${s*this.scale}" fill="${this.color.rgba}" />
`)}strokeRect(e,t,i,s){let a=.5*(this.lineWidth*this.scale%2!=0);this.buffer+=`<rect x="${(e*this.scale|0)+a}" y="${(t*this.scale|0)+a}" width="${i*this.scale}" height="${s*this.scale}" stroke="${this.color.rgba}"`,1!==this.lineWidth&&(this.buffer+=` stroke-width="${this.lineWidth*this.scale}"`),this.buffer+=' fill="transparent" />\n'}beginPath(){}closePath(){this._currentPath+=" z"}moveTo(e,t){this._currentPath+=` M${e*this.scale},${t*this.scale}`}lineTo(e,t){this._currentPathIsEmpty=!1,this._currentPath+=` L${e*this.scale},${t*this.scale}`}quadraticCurveTo(e,t,i,s){this._currentPathIsEmpty=!1,this._currentPath+=` Q${e*this.scale},${t*this.scale},${i*this.scale},${s*this.scale}`}bezierCurveTo(e,t,i,s,a,r){this._currentPathIsEmpty=!1,this._currentPath+=` C${e*this.scale},${t*this.scale},${i*this.scale},${s*this.scale},${a*this.scale},${r*this.scale}`}fillCircle(e,t,i){this._currentPathIsEmpty=!1,e*=this.scale,t*=this.scale,i*=this.scale,this._currentPath+=` M${e-i},${t} A1,1 0 0,0 ${e+i},${t} A1,1 0 0,0 ${e-i},${t} z`,this.fill()}strokeCircle(e,t,i){this._currentPathIsEmpty=!1,e*=this.scale,t*=this.scale,i*=this.scale,this._currentPath+=` M${e-i},${t} A1,1 0 0,0 ${e+i},${t} A1,1 0 0,0 ${e-i},${t} z`,this.stroke()}fill(){this._currentPathIsEmpty||(this.buffer+=`<path d="${this._currentPath}"`,"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),this.buffer+=' style="stroke: none"/>'),this._currentPath="",this._currentPathIsEmpty=!0}stroke(){if(!this._currentPathIsEmpty){let e=`<path d="${this._currentPath}" stroke="${this.color.rgba}"`;(1!==this.lineWidth||1!==this.scale)&&(e+=` stroke-width="${this.lineWidth*this.scale}"`),e+=' style="fill: none" />',this.buffer+=e}this._currentPath="",this._currentPathIsEmpty=!0}fillText(e,t,i){if(""===e)return;let s=`<text x="${t*this.scale|0}" y="${i*this.scale|0}" style='stroke: none; font:${this.font.toCssString(this.settings.display.scale)}; ${this.getSvgBaseLine()}'`;"#000000"!==this.color.rgba&&(s+=` fill="${this.color.rgba}"`),this.textAlign!==tS.Left&&(s+=` text-anchor="${this.getSvgTextAlignment(this.textAlign)}"`),s+=`>${or.escapeText(e)}</text>`,this.buffer+=s}static escapeText(e){return e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}getSvgTextAlignment(e){switch(e){case tS.Left:return"start";case tS.Center:return"middle";case tS.Right:return"end"}return""}getSvgBaseLine(){switch(this.textBaseline){case t_.Top:return"dominant-baseline: hanging";case t_.Bottom:return"dominant-baseline: ideographic";default:return""}}measureText(e){return e?na.measureString(e,this.font.families,this.font.size*this.scale,this.font.style,this.font.weight):new iG(0,0)}onRenderFinished(){return null}beginRotate(e,t,i){this.buffer+=`<g transform="translate(${e*this.scale} ,${t*this.scale}) rotate( ${i})">`}endRotate(){this.buffer+="</g>"}}class on extends or{fillMusicFontSymbol(e,t,i,s,a){s!==tb.None&&this.fillMusicFontSymbolText(e,t,i,`&#${s};`,a)}fillMusicFontSymbols(e,t,i,s,a){let r="";for(let e of s)e!==tb.None&&(r+=`&#${e};`);this.fillMusicFontSymbolText(e,t,i,r,a)}fillMusicFontSymbolText(e,t,i,s,a){e*=this.scale,t*=this.scale,this.buffer+=`<g transform="translate(${e} ${t})" class="at" ><text`;let r=this.scale*i;1!==r?this.buffer+=` style="font-size: ${100*r}%; stroke:none"`:this.buffer+=' style="stroke:none"',"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),a&&(this.buffer+=` text-anchor="${this.getSvgTextAlignment(tS.Center)}"`),this.buffer+=`>${s}</text></g>`}}class oo{constructor(){this.isInsideBracket=!0,this.isRelevantForBoundsLookup=!0,this.hideOnMultiTrack=!1,this.hideOnPercussionTrack=!1}canCreate(e,t){return!this.hideOnPercussionTrack||!t.isPercussion}}(eM=is||(is={}))[eM.PreNotes=0]="PreNotes",eM[eM.OnNotes=1]="OnNotes",eM[eM.MiddleNotes=2]="MiddleNotes",eM[eM.Stem=3]="Stem",eM[eM.PostNotes=4]="PostNotes",eM[eM.EndBeat=5]="EndBeat";class ol extends nC{constructor(){super(...arguments),this.glyphs=null}get isEmpty(){return!this.glyphs||0===this.glyphs.length}doLayout(){if(!this.glyphs||0===this.glyphs.length){this.width=0;return}let e=0;for(let t=0,i=this.glyphs.length;t<i;t++){let i=this.glyphs[t];i.renderer=this.renderer,i.doLayout(),e=Math.max(e,i.width)}this.width=e}addGlyph(e){this.glyphs||(this.glyphs=[]),this.renderer&&(e.renderer=this.renderer),this.glyphs.push(e)}paint(e,t,i){let s=this.glyphs;if(s&&0!==s.length)for(let a of s)a.paint(e+this.x,t+this.y,i)}}class oh extends ol{constructor(){super(0,0),this.glyphs=[]}doLayout(){}addGlyph(e){e.x=this.width,e.renderer=this.renderer,e.doLayout(),this.width=e.x+e.width,super.addGlyph(e)}}class od{static score(e,t,i,s=!1){if(!i.style&&!s)return;let a=od.scoreDefaultColor(e.settings.display.resources,t);return new oc(e,t,i.style,a)}static scoreColor(e,t,i){let s=od.scoreDefaultColor(e,t);if(i.style&&i.style.colors.has(t))return i.style.colors.get(t)??s}static scoreDefaultColor(e,t){return e.mainGlyphColor}static bar(e,t,i,s=!1){if(!i.style&&!s)return;let a=e.settings.display.resources.mainGlyphColor;switch(t){case e5.StandardNotationRepeats:case e5.GuitarTabsRepeats:case e5.SlashRepeats:case e5.NumberedRepeats:case e5.StandardNotationClef:case e5.GuitarTabsClef:case e5.StandardNotationKeySignature:case e5.NumberedKeySignature:case e5.StandardNotationTimeSignature:case e5.GuitarTabsTimeSignature:case e5.SlashTimeSignature:case e5.NumberedTimeSignature:break;case e5.StandardNotationBarLines:case e5.GuitarTabsBarLines:case e5.SlashBarLines:case e5.NumberedBarLines:a=e.settings.display.resources.barSeparatorColor;break;case e5.StandardNotationBarNumber:case e5.SlashBarNumber:case e5.NumberedBarNumber:case e5.GuitarTabsBarNumber:a=e.settings.display.resources.barNumberColor;break;case e5.StandardNotationStaffLine:case e5.GuitarTabsStaffLine:case e5.SlashStaffLine:case e5.NumberedStaffLine:a=e.settings.display.resources.staffLineColor}return new oc(e,t,i.style,a)}static voice(e,t,i,s=!1){if(!i.style&&!s)return;let a=0===i.index?e.settings.display.resources.mainGlyphColor:e.settings.display.resources.secondaryGlyphColor;return new oc(e,t,i.style,a)}static trackColor(e,t,i){let s=od.trackDefaultColor(e,t);if(i.style&&i.style.colors.has(t))return i.style.colors.get(t)??s}static trackDefaultColor(e,t){let i=e.mainGlyphColor;switch(t){case tL.TrackName:case tL.SystemSeparator:case tL.StringTuning:break;case tL.BracesAndBrackets:i=e.barSeparatorColor}return i}static track(e,t,i,s=!1){if(!i.style&&!s)return;let a=od.trackDefaultColor(e.settings.display.resources,t);return new oc(e,t,i.style,a)}static beatColor(e,t,i){let s=od.beatDefaultColor(e,t,i);if(i.style&&i.style.colors.has(t))return i.style.colors.get(t)??s}static beatDefaultColor(e,t,i){return 0===i.voice.index?e.mainGlyphColor:e.secondaryGlyphColor}static beat(e,t,i,s=!1){if(!i.style&&!s)return;let a=od.beatDefaultColor(e.settings.display.resources,t,i);return new oc(e,t,i.style,a)}static noteColor(e,t,i){let s=od.noteDefaultColor(e,t,i);if(i.style&&i.style.colors.has(t))return i.style.colors.get(t)??s}static noteDefaultColor(e,t,i){return 0===i.beat.voice.index?e.mainGlyphColor:e.secondaryGlyphColor}static note(e,t,i,s=!1){if(!i.style&&!s)return;let a=0===i.beat.voice.index?e.settings.display.resources.mainGlyphColor:e.settings.display.resources.secondaryGlyphColor;return new oc(e,t,i.style,a)}}class oc{constructor(e,t,i,s){this._canvas=e,i&&i.colors.has(t)?(this._previousColor=e.color,e.color=i.colors.get(t)??s):i||(this._previousColor=e.color,e.color=s)}[Symbol.dispose](){this._previousColor&&(this._canvas.color=this._previousColor)}}class ou extends ol{constructor(e,t,i){super(e,t),this.voice=i,this.beatGlyphs=[],this.tupletGroups=[]}scaleToWidth(e){let t=this.renderer.layoutingInfo.spaceToForce(e);this.scaleToForce(t)}scaleToForce(e){this.width=this.renderer.layoutingInfo.calculateVoiceWidth(e);let t=this.renderer.layoutingInfo.buildOnTimePositions(e),i=this.beatGlyphs;for(let e=0,s=i.length;e<s;e++){let a=i[e];if(a.beat.graceType===ti.None)a.x=t.get(a.beat.absoluteDisplayStart)-a.onTimeX;else{let s=a.beat.graceGroup.beats[0].absoluteDisplayStart,r=a.beat.graceGroup.id;if(a.beat.graceGroup.isComplete&&t.has(s)){a.x=t.get(s)-a.onTimeX;let e=this.renderer.layoutingInfo.allGraceRods.get(r),i=a.beat.graceGroup.beats[a.beat.graceGroup.beats.length-1].nextBeat,n=i?this.renderer.layoutingInfo.getPreBeatSize(i)+nA.GraceBeatPadding:0;a.x-=n,a.x-=e[a.beat.graceIndex].postSpringWidth,a.x+=e[a.beat.graceIndex].graceBeatWidth;let o=e[a.beat.graceGroup.beats.length-1];a.x-=o.graceBeatWidth}else{let t=this.renderer.layoutingInfo.incompleteGraceRods.get(r),s=t[a.beat.graceIndex].postSpringWidth-t[a.beat.graceIndex].preSpringWidth;e>0?0===a.beat.graceIndex?a.x=i[e-1].x+i[e-1].width:a.x=i[e-1].x+t[a.beat.graceIndex-1].postSpringWidth-t[a.beat.graceIndex-1].preSpringWidth-s:a.x=-s}}if(e>0){let t=a.x-i[e-1].x;i[e-1].scaleToWidth(t)}if(e===s-1){let e=this.width-i[i.length-1].x;a.scaleToWidth(e)}}}registerLayoutingInfo(e){for(let t of this.beatGlyphs)t.registerLayoutingInfo(e)}applyLayoutingInfo(e){for(let t of this.beatGlyphs)t.applyLayoutingInfo(e);this.scaleToForce(Math.max(this.renderer.settings.display.stretchForce,e.minStretchForce))}addGlyph(e){e.x=0===this.beatGlyphs.length?0:this.beatGlyphs[this.beatGlyphs.length-1].x+this.beatGlyphs[this.beatGlyphs.length-1].width,e.renderer=this.renderer,e.doLayout(),this.beatGlyphs.push(e),this.width=e.x+e.width,e.beat.hasTuplet&&e.beat.tupletGroup.beats[0].id===e.beat.id&&this.tupletGroups.push(e.beat.tupletGroup)}doLayout(){}paint(e,t,i){let s=od.voice(i,tf.Glyphs,this.voice,!0);try{for(let s=0,a=this.beatGlyphs.length;s<a;s++)this.beatGlyphs[s].paint(e+this.x,t+this.y,i)}finally{s?.[Symbol.dispose]?.()}}}ou.KeySizeBeat="Beat";class op{constructor(){this.staffId="",this.up=0,this.down=0}}class om{constructor(){this.startBeat=null,this.startX=0,this.startY=0,this.endBeat=null,this.endX=0,this.endY=0}calcY(e){return this.startX===this.endX?this.startY:(this.endY-this.startY)/(this.endX-this.startX)*(e-this.startX)+this.startY}}class og{get isRestBeamHelper(){return 1===this.beats.length&&this.beats[0].isRest}hasLine(e,t){return e&&this.beatHasLine(t)||!e&&1===this.beats.length&&this.beatHasLine(t)}beatHasLine(e){return e.duration>tt.Whole}hasFlag(e,t){return e&&this.beatHasFlag(t)||!e&&1===this.beats.length&&this.beatHasFlag(this.beats[0])}beatHasFlag(e){return!e.deadSlapped&&!e.isRest&&(e.duration>tt.Quarter||e.graceType!==ti.None)}constructor(e,t){this._beatLineXPositions=new Map,this._firstNonRestBeat=null,this._lastNonRestBeat=null,this.voice=null,this.beats=[],this.shortestDuration=tt.QuadrupleWhole,this.hasTuplet=!1,this.slashBeats=[],this._firstBeatLowestNoteCompareValue=-1,this._firstBeatHighestNoteCompareValue=-1,this._lastBeatLowestNoteCompareValue=-1,this._lastBeatHighestNoteCompareValue=-1,this.lowestNoteInHelper=null,this._lowestNoteCompareValueInHelper=-1,this.highestNoteInHelper=null,this._highestNoteCompareValueInHelper=-1,this.invertBeamDirection=!1,this.preferredBeamDirection=null,this.isGrace=!1,this.minRestLine=null,this.beatOfMinRestLine=null,this.maxRestLine=null,this.beatOfMaxRestLine=null,this.direction=tR.Up,this.drawingInfos=new Map,this._staff=e,this._renderer=t,this.beats=[]}getBeatLineX(e,t){return(t=t??this.direction,this.hasBeatLineX(e))?t===tR.Up?this._beatLineXPositions.get(e.index).up:this._beatLineXPositions.get(e.index).down:0}hasBeatLineX(e){return this._beatLineXPositions.has(e.index)}registerBeatLineX(e,t,i,s){let a=this.getOrCreateBeatPositions(t);for(let r of(a.staffId=e,a.up=i,a.down=s,this.drawingInfos.values()))r.startBeat===t?r.startX=this.getBeatLineX(t):r.endBeat===t&&(r.endX=this.getBeatLineX(t))}getOrCreateBeatPositions(e){return this._beatLineXPositions.has(e.index)||this._beatLineXPositions.set(e.index,new op),this._beatLineXPositions.get(e.index)}finish(){this.direction=this.calculateDirection()}calculateDirection(){let e=null;if(this.voice?null!==this.preferredBeamDirection?e=this.preferredBeamDirection:this.voice.index>0?e=this.invert(tR.Down):this.voice.bar.isMultiVoice?e=this.invert(tR.Up):this.beats[0].graceType!==ti.None&&(e=this.invert(tR.Up)):e=tR.Up,this.highestNoteInHelper&&this.lowestNoteInHelper){let t=this._renderer.getNoteY(this.highestNoteInHelper,ir.Center),i=this._renderer.getNoteY(this.lowestNoteInHelper,ir.Center);null===e&&(e=this.invert(this._renderer.middleYPosition<(t+i)/2?tR.Up:tR.Down)),this._renderer.completeBeamingHelper(this)}else e=this.invert(tR.Up),this._renderer.completeBeamingHelper(this);return e}static computeLineHeightsForRest(e){switch(e){case tt.QuadrupleWhole:case tt.DoubleWhole:return[2,2];case tt.Whole:return[0,1];case tt.Half:return[1,0];case tt.Quarter:return[3,3];case tt.Eighth:return[2,2];case tt.Sixteenth:return[2,4];case tt.ThirtySecond:return[4,4];case tt.SixtyFourth:return[4,6];case tt.OneHundredTwentyEighth:return[6,6];case tt.TwoHundredFiftySixth:return[6,8]}return[0,0]}applyRest(e,t){if(this._lastNonRestBeat&&e.index>=this._lastNonRestBeat.index||this._firstNonRestBeat&&e.index<=this._firstNonRestBeat.index)return;let i=t,s=t,a=og.computeLineHeightsForRest(e.duration);i-=a[0],s+=a[1];let r=this.minRestLine,n=this.maxRestLine;(null===r||r>i)&&(this.minRestLine=i,this.beatOfMinRestLine=e),(null===n||n<s)&&(this.maxRestLine=s,this.beatOfMaxRestLine=e)}invert(e){return this.invertBeamDirection?e===tR.Down?tR.Up:tR.Down:e}checkBeat(e){e.invertBeamDirection&&(this.invertBeamDirection=!0),this.voice||(this.voice=e.voice);let t=!1;if(0===this.beats.length)t=!0;else switch(this.beats[this.beats.length-1].beamingMode){case tF.Auto:case tF.ForceSplitOnSecondaryToNext:t=og.canJoin(this.beats[this.beats.length-1],e);break;case tF.ForceSplitToNext:t=!1;break;case tF.ForceMergeWithNext:t=!0}return t&&(null==this.preferredBeamDirection&&null!==e.preferredBeamDirection&&(this.preferredBeamDirection=e.preferredBeamDirection),e.hasTuplet&&(this.hasTuplet=!0),e.graceType!==ti.None&&(this.isGrace=!0),e.isRest?0===this.beats.length&&this.beats.push(e):(this.isRestBeamHelper&&(this.beats=[]),this.beats.push(e),this.checkNote(e.minNote),this.checkNote(e.maxNote),this.shortestDuration<e.duration&&(this.shortestDuration=e.duration),this._firstNonRestBeat||(this._firstNonRestBeat=e),this._lastNonRestBeat=e),e.slashed&&this.slashBeats.push(e)),t}checkNote(e){let t,i;e&&(this.voice&&e.isPercussion?i=t=-sj.getPercussionLine(this.voice.bar,sj.getNoteValue(e)):(i=t=sj.getNoteValue(e),e.harmonicType!==tr.None&&e.harmonicType!==tr.Natural&&(i=e.realValue-this._staff.displayTranspositionPitch)),1===this.beats.length&&this.beats[0]===e.beat&&((-1===this._firstBeatLowestNoteCompareValue||t<this._firstBeatLowestNoteCompareValue)&&(this._firstBeatLowestNoteCompareValue=t),(-1===this._firstBeatHighestNoteCompareValue||i>this._firstBeatHighestNoteCompareValue)&&(this._firstBeatHighestNoteCompareValue=i)),(-1===this._lastBeatLowestNoteCompareValue||t<this._lastBeatLowestNoteCompareValue)&&(this._lastBeatLowestNoteCompareValue=t),(-1===this._lastBeatHighestNoteCompareValue||i>this._lastBeatHighestNoteCompareValue)&&(this._lastBeatHighestNoteCompareValue=i),(!this.lowestNoteInHelper||t<this._lowestNoteCompareValueInHelper)&&(this.lowestNoteInHelper=e,this._lowestNoteCompareValueInHelper=t),(!this.highestNoteInHelper||i>this._highestNoteCompareValueInHelper)&&(this.highestNoteInHelper=e,this._highestNoteCompareValueInHelper=i))}static canJoin(e,t){if(!e||!t||e.graceType!==t.graceType||e.graceType===ti.BendGrace||t.graceType===ti.BendGrace||e.deadSlapped||t.deadSlapped)return!1;if(e.graceType!==ti.None&&t.graceType!==ti.None)return!0;let i=e.voice.bar;if(i!==t.voice.bar)return!1;let s=e.playbackStart,a=t.playbackStart;if(!og.canJoinDuration(e.duration)||!og.canJoinDuration(t.duration))return s===a;if(e.tupletGroup!==t.tupletGroup)return!1;if(e.hasTuplet&&t.hasTuplet&&e.tupletGroup===t.tupletGroup&&e.tupletGroup.isFull)return!0;let r=ix.QuarterTime;return 8===i.masterBar.timeSignatureDenominator&&i.masterBar.timeSignatureNumerator%3==0&&(r+=ix.QuarterTime/2|0),((r+s)/r|0)==((r+a)/r|0)}static canJoinDuration(e){switch(e){case tt.Whole:case tt.Half:case tt.Quarter:return!1;default:return!0}}static isFullBarJoin(e,t,i){return iW.getIndex(e.duration)-2-i>0&&iW.getIndex(t.duration)-2-i>0}get beatOfLowestNote(){return this.lowestNoteInHelper.beat}get beatOfHighestNote(){return this.highestNoteInHelper.beat}isPositionFrom(e,t){return!this._beatLineXPositions.has(t.index)||this._beatLineXPositions.get(t.index).staffId===e||!this._beatLineXPositions.get(t.index).staffId}}class of{constructor(e,t){this.topY=0,this.bottomY=0,this.topY=e,this.bottomY=t}}class oy{constructor(e){this.topY=-1e3,this.bottomY=-1e3,this.slots=[],this.beat=e}addSlot(e,t){if(this.slots.push(new of(e,t)),-1e3===this.topY)this.topY=e,this.bottomY=t;else{let i=Math.min(e,t),s=Math.max(e,t);i<this.topY&&(this.topY=i),s>this.bottomY&&(this.bottomY=s)}}}class ob{constructor(){this.reservedLayoutAreasByDisplayTime=new Map,this.restDurationsByDisplayTime=new Map}getBeatMinMaxY(){let e=-1e3,t=-1e3;for(let i of this.reservedLayoutAreasByDisplayTime.values())-1e3===e?(e=i.topY,t=i.bottomY):(e>i.topY&&(e=i.topY),t<i.bottomY&&(t=i.bottomY));return -1e3===e?[0,0]:[e,t]}reserveBeatSlot(e,t,i){t!==i&&(this.reservedLayoutAreasByDisplayTime.has(e.displayStart)||this.reservedLayoutAreasByDisplayTime.set(e.displayStart,new oy(e)),this.reservedLayoutAreasByDisplayTime.get(e.displayStart).addSlot(t,i),e.isRest&&this.registerRest(e))}registerRest(e){this.restDurationsByDisplayTime.has(e.displayStart)||this.restDurationsByDisplayTime.set(e.displayStart,new Map),this.restDurationsByDisplayTime.get(e.displayStart).has(e.playbackDuration)||this.restDurationsByDisplayTime.get(e.displayStart).set(e.playbackDuration,e.id)}applyRestCollisionOffset(e,t,i){if(e.voice.index>0&&this.reservedLayoutAreasByDisplayTime.has(e.playbackStart)){let s=og.computeLineHeightsForRest(e.duration).map(e=>e*i),a=t-s[0],r=t+s[1],n=a,o=this.reservedLayoutAreasByDisplayTime.get(e.playbackStart),l=!1;for(let e of o.slots)if(a>=e.topY&&a<=e.bottomY||r>=e.topY&&r<=e.bottomY){l=!0;break}if(l){let t=(n=1===e.voice.index?o.topY-s[1]-s[0]:o.bottomY)+s[0]+s[1],r=2*i,l=Math.ceil(Math.abs(n-a)/r);return(o.addSlot(n,t),n<a)?-(l*r):l*r}}return 0}}class oS{constructor(e){this.beamHelpers=[],this.beamHelperLookup=[],this.preferredBeamDirection=null,this._renderer=e,this.collisionHelper=new ob}initialize(){let e=this._renderer,t=this._renderer.bar,i=null,s=null;for(let a=0,r=t.voices.length;a<r;a++){let r=t.voices[a];this.beamHelpers.push([]),this.beamHelperLookup.push(new Map);for(let a=0,n=r.beats.length;a<n;a++){let n,o=r.beats[a];o.graceType!==ti.None?n=s:(n=i,s=null),n&&n.checkBeat(o)||(n&&n.finish(),(n=new og(t.staff,e)).preferredBeamDirection=this.preferredBeamDirection,n.checkBeat(o),o.graceType!==ti.None?s=n:i=n,this.beamHelpers[r.index].push(n)),this.beamHelperLookup[r.index].set(o.index,n)}i&&i.finish(),s&&s.finish(),i=null,s=null}}getBeamingHelperForBeat(e){return this.beamHelperLookup[e.voice.index].get(e.index)}}class o_ extends nD{constructor(e,t,i){super(e,t),this._textRow=0,this._fretRow=0,this._firstFretSpacing=0,this._chord=i}doLayout(){super.doLayout();let e=this.renderer.resources;this._textRow=1.5*e.effectFont.size,this._fretRow=1.5*e.effectFont.size,this._chord.firstFret>1?this._firstFretSpacing=o_.FretSpacing:this._firstFretSpacing=0,this.height=this._textRow+this._fretRow+o_.Frets*o_.FretSpacing+2*o_.Padding[1],this.width=this._firstFretSpacing+(this._chord.strings.length-1)*o_.StringSpacing+2*o_.Padding[0]}paint(e,t,i){e+=this.x+o_.Padding[0]+this._firstFretSpacing,t+=this.y;let s=o_.StringSpacing,a=o_.FretSpacing,r=this.renderer.resources,n=o_.CircleRadius,o=this.width-2*o_.Padding[0]-this._firstFretSpacing,l=i.textAlign,h=i.textBaseline;i.font=r.effectFont,i.textAlign=tS.Center,i.textBaseline=t_.Top,this._chord.showName&&i.fillText(this._chord.name,e+o/2,t+r.effectFont.size/2),t+=this._textRow,i.font=r.fretboardNumberFont,i.textBaseline=t_.Middle;for(let a=0;a<this._chord.strings.length;a++){let r=e+a*s,n=t+this._fretRow/2,o=this._chord.strings[this._chord.strings.length-a-1];o<0?i.fillMusicFontSymbol(r,n,1,tb.FretboardX,!0):0===o?i.fillMusicFontSymbol(r,n,1,tb.FretboardO,!0):(o-=this._chord.firstFret-1,i.fillText(o.toString(),r,n))}t+=this._fretRow;for(let r=0;r<this._chord.strings.length;r++){let n=e+r*s;i.fillRect(n,t,1,a*o_.Frets+1)}this._chord.firstFret>1&&(i.textAlign=tS.Left,i.fillText(this._chord.firstFret.toString(),e-this._firstFretSpacing,t+a/2)),i.fillRect(e,t-1,o,2);for(let s=0;s<=o_.Frets;s++){let r=t+s*a;i.fillRect(e,r,o,1)}let d=new Map;for(let e of this._chord.barreFrets){let t=[-1,-1];d.set(e-this._chord.firstFret,t)}for(let r=0;r<this._chord.strings.length;r++){let o=this._chord.strings[r];if(o>0){if(o-=this._chord.firstFret,d.has(o)){let e=d.get(o);(-1===e[0]||r<e[0])&&(e[0]=r),(-1===e[1]||r>e[1])&&(e[1]=r)}let l=t+o*a+a/2+.5,h=e+(this._chord.strings.length-r-1)*s;i.fillCircle(h,l,n)}}for(let[r,o]of d){let l=t+r*a+a/2+.5,h=e+(this._chord.strings.length-o[1]-1)*s,d=e+(this._chord.strings.length-o[0]-1)*s;i.fillRect(h,l-n,d-h,2*n)}i.textAlign=l,i.textBaseline=h}}o_.Padding=[5,2],o_.Frets=5,o_.CircleRadius=2.5,o_.StringSpacing=10,o_.FretSpacing=12;class ow extends ol{constructor(e,t,i=tS.Center){super(e,t),this._glyphWidth=0,this.glyphs=[],this._align=i}doLayout(){let e=0;switch(this._align){case tS.Left:e=0;break;case tS.Center:e=(this.width-this._glyphWidth)/2;break;case tS.Right:e=this.width-this._glyphWidth}for(let t of this.glyphs)t.x=e,e+=t.width}addGlyphToRow(e){this.glyphs.push(e),this._glyphWidth+=e.width,e.height>this.height&&(this.height=e.height)}}class ok extends ol{constructor(e,t,i=tS.Center){super(e,t),this._rows=[],this.height=0,this.glyphs=[],this._align=i}doLayout(){let e=0,t=0,i=ok.Padding;this._rows=[];let s=new ow(e,t,this._align);for(let a of(s.width=this.width,this.glyphs))e+a.width<this.width||(s.isEmpty||(s.doLayout(),this._rows.push(s),t+=s.height+i),(s=new ow(e=0,t,this._align)).width=this.width),s.addGlyphToRow(a),e+=a.width;s.isEmpty||(s.doLayout(),this._rows.push(s),t+=s.height+i),this.height=t}paint(e,t,i){for(let s of this._rows)s.paint(e+this.x,t+this.y,i)}}ok.Padding=3;class oB extends ok{addChord(e){if(e.strings.length>0){let t=new o_(0,0,e);t.renderer=this.renderer,t.doLayout(),this.glyphs.push(t)}}paint(e,t,i){if(this.glyphs.length>0){let s=od.score(i,tD.ChordDiagramList,this.renderer.scoreRenderer.score);try{super.paint(e,t,i)}finally{s?.[Symbol.dispose]?.()}}}}class oT extends nD{constructor(e,t,i,s,a=tS.Left,r=null,n){super(e,t),this._lineHeights=null,this._lines=i.split("\n"),this.font=s,this.textAlign=a,this.textBaseline=r,this.colorOverride=n}doLayout(){super.doLayout(),this._lineHeights=[];let e=this.renderer.scoreRenderer.canvas;for(let t of this._lines){e.font=this.font;let i=e.measureText(t),s=i.height;this._lineHeights.push(s),this.height+=s,this.width=Math.max(this.width,i.width)}}paint(e,t,i){let s=i.color;i.color=this.colorOverride??s,i.font=this.font;let a=i.textAlign,r=i.textBaseline;i.textAlign=this.textAlign,null!==this.textBaseline&&(i.textBaseline=this.textBaseline);let n=t+this.y;for(let t=0;t<this._lines.length;t++)i.fillText(this._lines[t],e+this.x,n),n+=this._lineHeights[t];i.textAlign=a,i.textBaseline=r,i.color=s}}class oN{get staffId(){return this._factory.staffId}get contentTop(){return this.y+this.staveTop+this.topSpacing+this.topOverflow}get contentBottom(){return this.y+this.topSpacing+this.topOverflow+this.staveBottom}constructor(e,t,i){this._sharedLayoutData=new Map,this.barRenderers=[],this.x=0,this.y=0,this.height=0,this.index=0,this.staffIndex=0,this.isFirstInSystem=!1,this.trackIndex=0,this.staveTop=0,this.topSpacing=0,this.bottomSpacing=0,this.staveBottom=0,this._factory=i,this.trackIndex=e,this.modelStaff=t}getSharedLayoutData(e,t){return this._sharedLayoutData.has(e)?this._sharedLayoutData.get(e):t}setSharedLayoutData(e,t){this._sharedLayoutData.set(e,t)}get isInsideBracket(){return this._factory.isInsideBracket}get isRelevantForBoundsLookup(){return this._factory.isRelevantForBoundsLookup}registerStaffTop(e){this.staveTop=e}registerStaffBottom(e){this.staveBottom=e}addBarRenderer(e){e.staff=this,e.index=this.barRenderers.length,e.reLayout(),this.barRenderers.push(e),this.system.layout.registerBarRenderer(this.staffId,e)}addBar(e,t,i){let s=this._factory.create(this.system.layout.renderer,e);s.additionalMultiRestBars=i,s.staff=this,s.index=this.barRenderers.length,s.layoutingInfo=t,s.doLayout(),s.registerLayoutingInfo();let a=s.barDisplayWidth;a>0&&this.system.layout.systemsLayoutMode===ia.FromModelWithWidths&&(s.width=a),this.barRenderers.push(s),e&&this.system.layout.registerBarRenderer(this.staffId,s)}revertLastBar(){let e=this.barRenderers[this.barRenderers.length-1];for(let t of(this.barRenderers.splice(this.barRenderers.length-1,1),this.system.layout.unregisterBarRenderer(this.staffId,e),this.barRenderers))t.applyLayoutingInfo();return e}scaleToWidth(e){this._sharedLayoutData=new Map;let t=this.topOverflow,i=0;switch(this.system.layout.systemsLayoutMode){case ia.Automatic:let s=(e-this.system.computedWidth)/this.barRenderers.length;for(let e of this.barRenderers){e.x=i,e.y=this.topSpacing+t;let a=e.computedWidth+s;e.scaleToWidth(a),i+=e.width}break;case ia.FromModelWithScale:e-=this.system.accoladeWidth;let a=this.system.totalBarDisplayScale;for(let s of this.barRenderers){s.x=i,s.y=this.topSpacing+t;let r=s.barDisplayScale*e/a;s.scaleToWidth(r),i+=s.width}break;case ia.FromModelWithWidths:for(let e of this.barRenderers){e.x=i,e.y=this.topSpacing+t;let s=e.barDisplayWidth;s>0?e.scaleToWidth(s):e.scaleToWidth(e.computedWidth),i+=e.width}}}get topOverflow(){let e=0;for(let t=0,i=this.barRenderers.length;t<i;t++){let i=this.barRenderers[t];i.topOverflow>e&&(e=i.topOverflow)}return e}get bottomOverflow(){let e=0;for(let t=0,i=this.barRenderers.length;t<i;t++){let i=this.barRenderers[t];i.bottomOverflow>e&&(e=i.bottomOverflow)}return e}calculateHeightForAccolade(){this.topSpacing=this._factory.getStaffPaddingTop(this),this.bottomSpacing=this._factory.getStaffPaddingBottom(this),this.height=this.barRenderers.length>0?this.barRenderers[0].height:0,this.height>0&&(this.height+=this.topSpacing+this.topOverflow+this.bottomOverflow+this.bottomSpacing)}finalizeStaff(){this.topSpacing=this._factory.getStaffPaddingTop(this),this.bottomSpacing=this._factory.getStaffPaddingBottom(this),this.height=0;let e=!1,t=this.topOverflow;for(let i=0;i<this.barRenderers.length;i++)this.barRenderers[i].y=this.topSpacing+t,this.height=Math.max(this.height,this.barRenderers[i].height),this.barRenderers[i].finalizeRenderer()&&(e=!0);if(e){t=this.topOverflow;for(let e=0;e<this.barRenderers.length;e++)this.barRenderers[e].y=this.topSpacing+t;for(let e=0;e<this.barRenderers.length;e++)this.barRenderers[e].finalizeRenderer()}this.height>0&&(this.height+=this.topSpacing+t+this.bottomOverflow+this.bottomSpacing)}paint(e,t,i,s,a){if(0!==this.height&&0!==a)for(let r=s,n=Math.min(s+a,this.barRenderers.length);r<n;r++)this.barRenderers[r].paint(e+this.x,t+this.y,i)}}class ox{constructor(){this.timePosition=0,this.longestDuration=0,this.smallestDuration=0,this.force=0,this.springConstant=0,this.preBeatWidth=0,this.graceBeatWidth=0,this.postSpringWidth=0,this.allDurations=new Set}get springWidth(){return this.preSpringWidth+this.postSpringWidth}get preSpringWidth(){return this.preBeatWidth+this.graceBeatWidth}}class oP{constructor(){this._timeSortedSprings=[],this._minTime=-1,this._onTimePositionsForce=0,this._onTimePositions=new Map,this._incompleteGraceRodsWidth=0,this._minDuration=oP.MinDuration,this.version=0,this.preBeatSize=0,this.postBeatSize=0,this.minStretchForce=0,this.totalSpringConstant=0,this.incompleteGraceRods=new Map,this.allGraceRods=new Map,this.springs=new Map,this.height=0}updateMinStretchForce(e){this.minStretchForce<e&&(this.minStretchForce=e)}getPreBeatSize(e){if(e.graceType!==ti.None){let t=e.graceGroup.id;return this.allGraceRods.get(t)[e.graceIndex].preBeatWidth}let t=e.absoluteDisplayStart;return this.springs.has(t)?this.springs.get(t).preBeatWidth:0}getPostBeatSize(e){if(e.graceType!==ti.None){let t=e.graceGroup.id;return this.allGraceRods.get(t)[e.graceIndex].postSpringWidth}let t=e.absoluteDisplayStart;return this.springs.has(t)?this.springs.get(t).postSpringWidth:0}addSpring(e,t,i,s,a){let r;if(this.version++,this.springs.has(e))(r=this.springs.get(e)).postSpringWidth<a&&(r.postSpringWidth=a),r.graceBeatWidth<i&&(r.graceBeatWidth=i),r.preBeatWidth<s&&(r.preBeatWidth=s),t<r.smallestDuration&&(r.smallestDuration=t),t>r.longestDuration&&(r.longestDuration=t),r.allDurations.add(t);else{if((r=new ox).timePosition=e,r.allDurations.add(t),this._timeSortedSprings.length>0){let e=this._timeSortedSprings[this._timeSortedSprings.length-1];for(let t of e.allDurations)e.timePosition;t<this._minDuration&&(this._minDuration=t)}r.longestDuration=t,r.postSpringWidth=a,r.graceBeatWidth=i,r.preBeatWidth=s,this.springs.set(e,r);let n=this._timeSortedSprings,o=n.length-1;for(;o>0&&n[o].timePosition>e;)o--;this._timeSortedSprings.splice(o+1,0,r)}return(-1===this._minTime||this._minTime>e)&&(this._minTime=e),r}addBeatSpring(e,t,i){let s=e.absoluteDisplayStart;if(e.graceType!==ti.None){let a=e.graceGroup.id;this.allGraceRods.has(a)||this.allGraceRods.set(a,Array(e.graceGroup.beats.length)),e.graceGroup.isComplete||this.incompleteGraceRods.has(a)||this.incompleteGraceRods.set(a,Array(e.graceGroup.beats.length));let r=this.allGraceRods.get(a)[e.graceIndex];if(r)r.postSpringWidth<i&&(r.postSpringWidth=i),r.preBeatWidth<t&&(r.preBeatWidth=t);else{let r=new ox;r.timePosition=s,r.postSpringWidth=i,r.preBeatWidth=t,e.graceGroup.isComplete||(this.incompleteGraceRods.get(a)[e.graceIndex]=r),this.allGraceRods.get(a)[e.graceIndex]=r}}else{let a=0;if(e.graceGroup&&this.allGraceRods.has(e.graceGroup.id))for(let t of this.allGraceRods.get(e.graceGroup.id))a+=t.springWidth;this.addSpring(s,e.displayDuration,a,t,i)}}finish(){for(let[e,t]of this.allGraceRods){let e=0;for(let i of t)e+=i.preBeatWidth,i.graceBeatWidth=e,e+=i.postSpringWidth}for(let e of(this._incompleteGraceRodsWidth=0,this.incompleteGraceRods.values()))for(let t of e)this._incompleteGraceRodsWidth+=t.preBeatWidth+t.postSpringWidth;this.calculateSpringConstants(),this.version++}calculateSpringConstants(){let e=0,t=this._timeSortedSprings;if(0===t.length){this.totalSpringConstant=-1,this.minStretchForce=-1;return}for(let i=0;i<t.length;i++){let s=t[i],a=0;a=i===t.length-1?s.longestDuration:Math.abs(t[i+1].timePosition-s.timePosition),s.springConstant=this.calculateSpringConstant(s,a),e+=1/s.springConstant}this.totalSpringConstant=1/e,this.minStretchForce=0;for(let e=0;e<t.length;e++){let i=t[e],s=0;if(e===t.length-1)s=i.postSpringWidth;else{let a=t[e+1];s=i.postSpringWidth+a.preSpringWidth}0===e&&(s+=i.preSpringWidth);let a=s*i.springConstant;this.updateMinStretchForce(a)}}paint(e,t,i){}calculateSpringConstant(e,t){t<=0&&(t=ix.toTicks(tt.TwoHundredFiftySixth)),0===e.smallestDuration&&(e.smallestDuration=t);let i=e.smallestDuration,s=this._minDuration,a=oP.MinDurationWidth,r=1+.85*Math.log2(t/s);return i/t*(1/(r*a))}spaceToForce(e){return -1!==this.totalSpringConstant?(this._timeSortedSprings.length>0&&(e-=this._timeSortedSprings[0].preSpringWidth),Math.max(e-=this._incompleteGraceRodsWidth,0)*this.totalSpringConstant):-1}calculateVoiceWidth(e){let t=0;return -1!==this.totalSpringConstant&&(t=this.calculateWidth(e,this.totalSpringConstant)),this._timeSortedSprings.length>0&&(t+=this._timeSortedSprings[0].preSpringWidth),t+=this._incompleteGraceRodsWidth}calculateWidth(e,t){return e/t}buildOnTimePositions(e){if(-1===this.totalSpringConstant)return new Map;if(iW.isAlmostEqualTo(this._onTimePositionsForce,e)&&this._onTimePositions)return this._onTimePositions;this._onTimePositionsForce=e;let t=new Map;this._onTimePositions=t;let i=this._timeSortedSprings;if(0===i.length)return t;let s=i[0].preSpringWidth;for(let a=0;a<i.length;a++)t.set(i[a].timePosition,s),s+=this.calculateWidth(e,i[a].springConstant);return t}}oP.MinDuration=30,oP.MinDurationWidth=7;class ov{constructor(){this.width=0,this.isLinkedToPrevious=!1,this.canWrap=!0,this.additionalMultiBarRestIndexes=null,this.renderers=[]}get lastMasterBarIndex(){return this.additionalMultiBarRestIndexes?this.additionalMultiBarRestIndexes[this.additionalMultiBarRestIndexes.length-1]:this.masterBar.index}}class oF{constructor(e,t){this.staves=[],this.stavesRelevantForBoundsLookup=[],this.firstStaffInBracket=null,this.lastStaffInBracket=null,this.bracket=null,this.staffSystem=e,this.track=t}addStaff(e){this.staves.push(e),e.isRelevantForBoundsLookup&&this.stavesRelevantForBoundsLookup.push(e)}}class oC{constructor(){this.firstStaffInBracket=null,this.lastStaffInBracket=null,this.drawAsBrace=!1,this.braceScale=1,this.width=0,this.index=0}finalizeBracket(){if(this.firstStaffInBracket===this.lastStaffInBracket){this.width=0;return}let e=nE.Heights.get(tb.Brace),t=nE.Widths.get(tb.Brace);if(this.width=t,!this.drawAsBrace||!this.firstStaffInBracket||!this.lastStaffInBracket)return;let i=this.firstStaffInBracket.contentTop,s=this.lastStaffInBracket.contentBottom;this.braceScale=(s-i)/e,this.width=t*this.braceScale}}class oD extends oC{constructor(e){super(),this.track=e,this.drawAsBrace=oD.isTrackDrawAsBrace(e)}includesStaff(e){return e.modelStaff.track===this.track}static isTrackDrawAsBrace(e){return e.staves.filter(e=>e.showStandardNotation).length>1}}class oE extends oD{includesStaff(e){return e.modelStaff.track===this.track||!this.drawAsBrace&&this.track.playbackInfo.program===e.modelStaff.track.playbackInfo.program}}class oM{constructor(e){this._allStaves=[],this._firstStaffInBrackets=null,this._lastStaffInBrackets=null,this._accoladeSpacingCalculated=!1,this._brackets=[],this._hasSystemSeparator=!1,this.x=0,this.y=0,this.index=0,this.accoladeWidth=0,this.isFull=!1,this.width=0,this.computedWidth=0,this.totalBarDisplayScale=0,this.isLast=!1,this.masterBarsRenderers=[],this.staves=[],this.layout=e,this.topPadding=e.renderer.settings.display.systemPaddingTop,this.bottomPadding=e.renderer.settings.display.systemPaddingBottom}get firstBarIndex(){return this.masterBarsRenderers[0].masterBar.index}get lastBarIndex(){return this.masterBarsRenderers[this.masterBarsRenderers.length-1].lastMasterBarIndex}addMasterBarRenderers(e,t){if(0===e.length)return null;this.masterBarsRenderers.push(t),t.layoutingInfo.preBeatSize=0;let i=0;for(let e=0,s=this.staves.length;e<s;e++){let s=this.staves[e];for(let e=0,a=s.staves.length;e<a;e++){let a=s.staves[e],r=t.renderers[i++];a.addBarRenderer(r)}}return this.calculateAccoladeSpacing(e),this.updateWidthFromLastBar(),t}addBars(e,t,i){let s=new ov;s.additionalMultiBarRestIndexes=i,s.layoutingInfo=new oP,s.masterBar=e[0].score.masterBars[t],this.masterBarsRenderers.push(s);let a=s.layoutingInfo;for(let e of this.staves)for(let r of e.staves){let n=e.track.staves[r.modelStaff.index].bars[t],o=null==i?null:i.map(t=>e.track.staves[r.modelStaff.index].bars[t]);r.addBar(n,a,o);let l=r.barRenderers[r.barRenderers.length-1];s.renderers.push(l),l.isLinkedToPrevious&&(s.isLinkedToPrevious=!0),l.canWrap||(s.canWrap=!1)}return this.calculateAccoladeSpacing(e),a.finish(),s.width=this.updateWidthFromLastBar(),s}revertLastBar(){if(this.masterBarsRenderers.length>1){let e=this.masterBarsRenderers[this.masterBarsRenderers.length-1];this.masterBarsRenderers.splice(this.masterBarsRenderers.length-1,1);let t=0,i=0;for(let e=0,s=this._allStaves.length;e<s;e++){let s=this._allStaves[e].revertLastBar(),a=s.computedWidth;a>t&&(t=a);let r=s.barDisplayScale;r>i&&(i=r)}return this.width-=t,this.computedWidth-=t,this.totalBarDisplayScale-=i,e}return null}updateWidthFromLastBar(){let e=0,t=0;for(let i=0,s=this._allStaves.length;i<s;i++){let s=this._allStaves[i],a=s.barRenderers[s.barRenderers.length-1];a.applyLayoutingInfo(),a.computedWidth>e&&(e=a.computedWidth);let r=a.barDisplayScale;r>t&&(t=r)}return this.width+=e,this.computedWidth+=e,this.totalBarDisplayScale+=t,e}calculateAccoladeSpacing(e){let t=this.layout.renderer.settings;if(!this._accoladeSpacingCalculated){this._accoladeSpacingCalculated=!0,this.accoladeWidth=0;let i=this.layout.renderer.score.stylesheet;if(this.layout.renderer.settings.notation.isNotationElementVisible(tp.TrackNames)){let s=1===this.layout.renderer.tracks.length?i.singleTrackTrackNamePolicy:i.multiTrackTrackNamePolicy,a=0===this.index?i.firstSystemTrackNameMode:i.otherSystemsTrackNameMode,r=0===this.index?i.firstSystemTrackNameOrientation:i.otherSystemsTrackNameOrientation,n=!1;switch(s){case eq.Hidden:break;case eq.FirstSystem:n=0===this.index;break;case eq.AllSystems:n=!0}let o=!1;if(n){let i=this.layout.renderer.canvas;for(let s of(i.font=t.display.resources.effectFont,e)){let e="";switch(a){case e$.FullName:e=s.name;break;case e$.ShortName:e=s.shortName}if(e.length>0){o=!0;let t=i.measureText(e);switch(r){case ej.Horizontal:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,t.width));break;case ej.Vertical:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,t.height))}}}o&&(this.accoladeWidth+=t.display.systemLabelPaddingLeft,this.accoladeWidth+=t.display.systemLabelPaddingRight)}}let s=0;for(let e of this._allStaves)e.y=s,e.calculateHeightForAccolade(),s+=e.height;let a=0;for(let e of this._brackets)e.finalizeBracket(),a=Math.max(a,e.width);this.accoladeWidth+=a,this.width+=this.accoladeWidth,this.computedWidth+=this.accoladeWidth}}getStaffTrackGroup(e){for(let t=0,i=this.staves.length;t<i;t++){let i=this.staves[t];if(i.track===e)return i}return null}addStaff(e,t){let i=this.getStaffTrackGroup(e);if(i||(i=new oF(this,e),this.staves.push(i)),t.staffTrackGroup=i,t.system=this,t.index=this._allStaves.length,this._allStaves.push(t),i.addStaff(t),t.isInsideBracket){this._firstStaffInBrackets||(this._firstStaffInBrackets=t,t.isFirstInSystem=!0),i.firstStaffInBracket||(i.firstStaffInBracket=t),this._lastStaffInBrackets=t,i.lastStaffInBracket=t;let s=this._brackets.find(e=>e.includesStaff(t));if(!s)switch(e.score.stylesheet.bracketExtendMode){case eY.NoBrackets:break;case eY.GroupStaves:(s=new oD(e)).index=this._brackets.length,this._brackets.push(s);break;case eY.GroupSimilarInstruments:(s=new oE(e)).index=this._brackets.length,this._brackets.push(s)}s&&(s.firstStaffInBracket||(s.firstStaffInBracket=t),s.lastStaffInBracket=t,i.bracket=s)}}get height(){return 0===this._allStaves.length?0:this._allStaves[this._allStaves.length-1].y+this._allStaves[this._allStaves.length-1].height+this.topPadding+this.bottomPadding}scaleToWidth(e){for(let t=0,i=this._allStaves.length;t<i;t++)this._allStaves[t].scaleToWidth(e);this.width=e}paint(e,t,i){if(t+=this.topPadding,this.paintPartial(e+this.x,t+this.y,i,0,this.masterBarsRenderers.length),this._hasSystemSeparator){let s=od.track(i,tL.SystemSeparator,this._allStaves[0].modelStaff.track);try{i.fillMusicFontSymbol(e+this.x,t+this.y+this.height-10,1,tb.SystemDivider,!1),i.fillMusicFontSymbol(e+this.x+this.width-oM.SystemSignSeparatorWidth,t+this.y+this.height-oM.SystemSignSeparatorPadding,1,tb.SystemDivider,!1)}finally{s?.[Symbol.dispose]?.()}}}paintPartial(e,t,i,s,a){for(let r=0,n=this._allStaves.length;r<n;r++)this._allStaves[r].paint(e,t,i,s,a);let r=this.layout.renderer.settings.display.resources;if(this.staves.length>0&&0===s){i.color=r.barSeparatorColor;let s=this.layout.renderer.settings,a=this.layout.renderer.settings.notation.isNotationElementVisible(tp.TrackNames);if(i.font=r.effectFont,a){let a=this.layout.renderer.score.stylesheet,r=1===this.layout.renderer.tracks.length?a.singleTrackTrackNamePolicy:a.multiTrackTrackNamePolicy,n=0===this.index?a.firstSystemTrackNameMode:a.otherSystemsTrackNameMode,o=0===this.index?a.firstSystemTrackNameOrientation:a.otherSystemsTrackNameOrientation,l=!1;switch(r){case eq.Hidden:break;case eq.FirstSystem:l=0===this.index;break;case eq.AllSystems:l=!0}if(l){let a=i.textBaseline,r=i.textAlign;for(let a of this.staves)if(a.firstStaffInBracket&&a.lastStaffInBracket){let r=t+a.firstStaffInBracket.contentTop,l=t+a.lastStaffInBracket.contentBottom,h="";switch(n){case e$.FullName:h=a.track.name;break;case e$.ShortName:h=a.track.shortName}let d=od.track(i,tL.TrackName,a.track);try{if(h.length>0){let t=e+a.firstStaffInBracket.x-s.display.accoladeBarPaddingRight-(a.bracket?.width??0)-s.display.systemLabelPaddingRight;switch(o){case ej.Horizontal:i.textBaseline=t_.Middle,i.textAlign=tS.Right,i.fillText(h,t,(r+l)/2);break;case ej.Vertical:i.textBaseline=t_.Bottom,i.textAlign=tS.Center,i.beginRotate(t,(r+l)/2,-90.1),i.fillText(h,0,0),i.endRotate()}}}finally{d?.[Symbol.dispose]?.()}}i.textBaseline=a,i.textAlign=r}}if(this._allStaves.length>0){let s=null;for(let a of this._allStaves)if(a.isInsideBracket){if(null!==s){let r=s.contentBottom,n=a.contentTop,o=e+s.x,l=s.barRenderers[0],h=od.bar(i,l.staffLineBarSubElement,l.bar);try{let e=Math.ceil(n-r);i.fillRect(o,t+r,1,e)}finally{h?.[Symbol.dispose]?.()}}s=a}}for(let a of this._brackets)if(a.firstStaffInBracket&&a.lastStaffInBracket){let r=e+a.firstStaffInBracket.x,n=a.width,o=s.display.accoladeBarPaddingRight,l=t+a.firstStaffInBracket.contentTop,h=t+a.lastStaffInBracket.contentBottom,d=l,c=h;if(a.drawAsBrace)i.fillMusicFontSymbol(r-o-n,c,a.braceScale,tb.Brace);else if(a.firstStaffInBracket!==a.lastStaffInBracket){let e=n/2;d-=e,c+=2*e,i.fillRect(r-o-n,d,n,Math.ceil(c-d));let t=r-o-n-.5;i.fillMusicFontSymbol(t,d,1,tb.BracketTop),i.fillMusicFontSymbol(t,Math.floor(c),1,tb.BracketBottom)}}}}finalizeSystem(){let e=this.layout.renderer.settings;0===this.index&&(this.topPadding=e.display.firstSystemPaddingTop),this.isLast?this.bottomPadding=e.display.lastSystemPaddingBottom:this.layout.renderer.score.stylesheet.useSystemSignSeparator&&this.layout.renderer.tracks.length>1&&(this.bottomPadding+=oM.SystemSignSeparatorHeight,this._hasSystemSeparator=!0);let t=0;for(let e of this._allStaves)e.x=this.accoladeWidth,e.y=t,e.finalizeStaff(),t+=e.height;for(let e of this._brackets)e.finalizeBracket()}buildBoundingsLookup(e,t){if(this.layout.renderer.boundsLookup.isFinished)return;let i=this._firstStaffInBrackets,s=this._lastStaffInBrackets;if(!i||!s)return;t+=this.topPadding;let a=this._allStaves[this._allStaves.length-1],r=t+this.y+i.y,n=t+this.y+s.y+s.height,o=t+this.y+this._allStaves[0].y,l=t+this.y+a.y+a.height,h=t+this.y+i.y+i.topSpacing+i.topOverflow+(i.barRenderers.length>0?i.barRenderers[0].topPadding:0),d=t+this.y+a.y+a.height-a.bottomSpacing-a.bottomOverflow-(a.barRenderers.length>0?a.barRenderers[0].bottomPadding:0),c=n-r,u=d-h,p=l-o,m=this.x+i.x,g=new nd;g.visualBounds=new sy,g.visualBounds.x=e+this.x,g.visualBounds.y=t+this.y,g.visualBounds.w=this.width,g.visualBounds.h=this.height-this.topPadding-this.bottomPadding,g.realBounds=new sy,g.realBounds.x=e+this.x,g.realBounds.y=t+this.y,g.realBounds.w=this.width,g.realBounds.h=this.height,this.layout.renderer.boundsLookup.addStaffSystem(g);let f=new Map;for(let e=0;e<this.staves.length;e++)for(let i of this.staves[e].stavesRelevantForBoundsLookup)for(let e of i.barRenderers){let s;f.has(e.bar.masterBar.index)?s=f.get(e.bar.masterBar.index):((s=new nl).index=e.bar.masterBar.index,s.isFirstOfLine=e.isFirstOfLine,s.realBounds=new sy,s.realBounds.x=m+e.x,s.realBounds.y=o,s.realBounds.w=e.width,s.realBounds.h=p,s.visualBounds=new sy,s.visualBounds.x=m+e.x,s.visualBounds.y=r,s.visualBounds.w=e.width,s.visualBounds.h=c,s.lineAlignedBounds=new sy,s.lineAlignedBounds.x=m+e.x,s.lineAlignedBounds.y=h,s.lineAlignedBounds.w=e.width,s.lineAlignedBounds.h=u,this.layout.renderer.boundsLookup.addMasterBar(s),f.set(s.index,s)),e.buildBoundingsLookup(s,m,t+this.y+i.y)}}getBarX(e){if(!this._firstStaffInBrackets||0===this.layout.renderer.tracks.length)return 0;let t=this.layout.renderer.tracks[0].staves[0].bars[e];return this.layout.getRendererForBar(this._firstStaffInBrackets.staffId,t).x}}oM.SystemSignSeparatorHeight=40,oM.SystemSignSeparatorPadding=10,oM.SystemSignSeparatorWidth=36;class oL extends ok{constructor(e,t){super(e,t,tS.Left)}}class oI extends ol{constructor(e,t,i,s){super(e,t),this._tuning=i,this._trackLabel=s,this.glyphs=[]}doLayout(){if(!(this.glyphs.length>0))for(let e of(this.createGlyphs(this._tuning),this.glyphs))e.renderer=this.renderer,e.doLayout()}paint(e,t,i){i.textBaseline=t_.Middle;let s=i.color;this.colorOverride&&(i.color=this.colorOverride),super.paint(e,t,i),i.color=s}createGlyphs(e){let t=this.renderer.resources;if(this.height=0,this._trackLabel.length>0){this.height+=1;let e=new oT(0,this.height,this._trackLabel,t.effectFont,tS.Left);e.renderer=this.renderer,e.doLayout(),this.height+=e.height+1,e.y+=e.height/2,this.addGlyph(e)}let i=new oT(0,this.height,e.name,t.effectFont,tS.Left);if(i.renderer=this.renderer,i.doLayout(),this.height+=i.height,i.y+=i.height/2,this.addGlyph(i),this.renderer.scoreRenderer.canvas.font=t.effectFont,this.width=Math.max(this.renderer.scoreRenderer.canvas.measureText(this._trackLabel).width,Math.max(this.renderer.scoreRenderer.canvas.measureText(e.name).width,128)),!e.isStandard){this.height+=15;let i=oI.CircleNumberScale,s=nE.Heights.get(tb.GuitarString0)*i,a=0|Math.ceil(e.tunings.length/2),r=0,n=this.height;for(let o=0,l=e.tunings.length;o<l;o++){let l=tb.GuitarString0+(o+1);this.addGlyph(new nM(r,n+s/2.5,i,l));let h=`= ${sa.getTextForTuning(e.tunings[o],!1)}`;this.addGlyph(new oT(r+s+1,n,h,t.effectFont,tS.Left)),n+=15,o===a-1&&(n=this.height,r+=64)}this.height+=15*a}this.width+=15}}oI.CircleNumberScale=.7;class oA{constructor(e,t){this.args=e,this.renderCallback=t}}(eL=ia||(ia={}))[eL.Automatic=0]="Automatic",eL[eL.FromModelWithScale=1]="FromModelWithScale",eL[eL.FromModelWithWidths=2]="FromModelWithWidths";class oR{get scaledWidth(){return Math.round(this.width/this.renderer.settings.display.scale)}constructor(e){this._barRendererLookup=new Map,this.pagePadding=null,this.width=0,this.height=0,this.multiBarRestInfo=null,this.headerGlyphs=new Map,this.footerGlyphs=new Map,this.chordDiagrams=null,this.tuningGlyph=null,this.systemsLayoutMode=ia.Automatic,this._lazyPartials=new Map,this.firstBarIndex=0,this.lastBarIndex=0,this.renderer=e}resize(){this._lazyPartials.clear(),this.doResize()}layoutAndRender(){this._lazyPartials.clear();let e=this.renderer.score;this.firstBarIndex=iW.computeFirstDisplayedBarIndex(e,this.renderer.settings),this.lastBarIndex=iW.computeLastDisplayedBarIndex(e,this.renderer.settings,this.firstBarIndex),this.multiBarRestInfo=iW.buildMultiBarRestInfo(this.renderer.tracks,this.firstBarIndex,this.lastBarIndex),this.pagePadding=this.renderer.settings.display.padding.map(e=>e/this.renderer.settings.display.scale),this.pagePadding||(this.pagePadding=[0,0,0,0]),1===this.pagePadding.length?this.pagePadding=[this.pagePadding[0],this.pagePadding[0],this.pagePadding[0],this.pagePadding[0]]:2===this.pagePadding.length&&(this.pagePadding=[this.pagePadding[0],this.pagePadding[1],this.pagePadding[0],this.pagePadding[1]]),this.createScoreInfoGlyphs(),this.doLayoutAndRender()}registerPartial(e,t){if(0===e.height)return;let i=this.renderer.settings.display.scale;e.x*=i,e.y*=i,e.width*=i,e.height*=i,e.totalWidth*=i,e.totalHeight*=i,this.renderer.settings.core.enableLazyLoading?(this._lazyPartials.set(e.id,new oA(e,t)),this.renderer.partialLayoutFinished.trigger(e)):(this.renderer.partialLayoutFinished.trigger(e),this.internalRenderLazyPartial(e,t))}internalRenderLazyPartial(e,t){let i=this.renderer.canvas;i.beginRender(e.width,e.height),t(i),e.renderResult=i.endRender(),this.renderer.partialRenderFinished.trigger(e)}renderLazyPartial(e){if(this._lazyPartials.has(e)){let t=this._lazyPartials.get(e);this.internalRenderLazyPartial(t.args,t.renderCallback)}}createHeaderFooterGlyph(e,t,i,s){switch(i){case tD.WordsAndMusic:if(t.words!==t.music)return;break;case tD.Words:case tD.Music:if(t.words===t.music)return;break;case tD.CopyrightSecondLine:if(!this.headerGlyphs.has(tD.Copyright))return}let a=e.display.resources,r=e.notation,n=t.style&&t.style.headerAndFooter.has(i)?t.style.headerAndFooter.get(i):i5.defaultHeaderAndFooter.get(i),o=void 0===n.isVisible||n.isVisible;if(void 0!==s&&(o=r.isNotationElementVisible(s)),!o)return;let l=n.buildText(t);if(l)return new oT(0,0,l,a.getFontForElement(i),n.textAlign,void 0,od.scoreColor(a,i,t))}createScoreInfoGlyphs(){iM.debug("ScoreLayout","Creating score info glyphs");let e=this.renderer.settings,t=this.renderer.score;this.headerGlyphs=new Map,this.footerGlyphs=new Map;let i=new oz(this.renderer,this.renderer.tracks[0].staves[0].bars[0]);for(let[s,a]of oR.HeaderElements.value){let r=this.createHeaderFooterGlyph(e,t,s,a);r&&(r.renderer=i,r.doLayout(),this.headerGlyphs.set(s,r))}for(let[s,a]of oR.FooterElements.value){let r=this.createHeaderFooterGlyph(e,t,s,a);r&&(r.renderer=i,r.doLayout(),this.footerGlyphs.set(s,r))}let s=e.notation,a=e.display.resources;if(s.isNotationElementVisible(tp.GuitarTuning)){let e=[];for(let i of this.renderer.tracks)for(let s of i.staves){let a=!s.isPercussion&&s.isStringed&&s.tuning.length>0&&s.showTablature;if(t.stylesheet.perTrackDisplayTuning&&t.stylesheet.perTrackDisplayTuning.has(i.index)&&!1===t.stylesheet.perTrackDisplayTuning.get(i.index)&&(a=!1),a){e.push(s);break}}if(e.length>0&&t.stylesheet.globalDisplayTuning){for(let t of(this.tuningGlyph=new oL(0,0),this.tuningGlyph.renderer=i,e))if(t.stringTuning.tunings.length>0){let s=e.length>1?t.track.name:"",r=new oI(0,0,t.stringTuning,s);r.colorOverride=od.trackColor(a,tL.StringTuning,t.track),r.renderer=i,r.doLayout(),this.tuningGlyph.addGlyph(r)}}else this.tuningGlyph=null}if(s.isNotationElementVisible(tp.ChordDiagrams)){this.chordDiagrams=new oB(0,0),this.chordDiagrams.renderer=i;let e=new Set;for(let i of this.renderer.tracks)if(t.stylesheet.globalDisplayChordDiagramsOnTop&&(null==t.stylesheet.perTrackChordDiagramsOnTop||!t.stylesheet.perTrackChordDiagramsOnTop.has(i.index)||t.stylesheet.perTrackChordDiagramsOnTop.get(i.index)))for(let t of i.staves){let i=t.chords;if(i)for(let[,t]of i)!e.has(t.uniqueId)&&t.showDiagram&&(e.add(t.uniqueId),this.chordDiagrams.addChord(t))}this.chordDiagrams.isEmpty&&(this.chordDiagrams=null)}else this.chordDiagrams=null}createEmptyStaffSystem(){let e=new oM(this);for(let t=0;t<this.renderer.tracks.length;t++){let i=this.renderer.tracks[t];for(let s=0;s<i.staves.length;s++){let a=i.staves[s];for(let s of dE.staveProfiles.get(this.renderer.settings.display.staveProfile))s.canCreate(i,a)&&e.addStaff(i,new oN(t,a,s))}}return e}registerBarRenderer(e,t){if(this._barRendererLookup.has(e)||this._barRendererLookup.set(e,new Map),this._barRendererLookup.get(e).set(t.bar.id,t),t.additionalMultiRestBars)for(let i of t.additionalMultiRestBars)this._barRendererLookup.get(e).set(i.id,t)}unregisterBarRenderer(e,t){if(this._barRendererLookup.has(e)){let i=this._barRendererLookup.get(e);if(i.delete(t.bar.id),t.additionalMultiRestBars)for(let e of t.additionalMultiRestBars)i.delete(e.id)}}getRendererForBar(e,t){let i=t.id;return this._barRendererLookup.has(e)&&this._barRendererLookup.get(e).has(i)?this._barRendererLookup.get(e).get(i):null}layoutAndRenderBottomScoreInfo(e){e=Math.round(e);let t=new nr;t.x=0,t.y=e;let i=0,s=this.renderer.settings.display.resources,a=[],r=0;for(let[e,t]of oR.FooterElements.value)if(this.footerGlyphs.has(e)){let t=this.footerGlyphs.get(e);t.y=i,this.alignScoreInfoGlyph(t),i+=1.2*t.font.size,a.push(t),r=Math.max(r,Math.round(t.x+t.width))}return i=Math.round(i),a.length>0&&(t.width=r,t.height=i,t.totalWidth=this.scaledWidth,t.totalHeight=e+t.height,this.registerPartial(t,e=>{for(let t of(e.color=s.scoreInfoColor,e.textAlign=tS.Left,e.textBaseline=t_.Top,a))t.paint(0,0,e)})),e+i}alignScoreInfoGlyph(e){if(dE.getLayoutEngineFactory(this.renderer.settings.display.layoutMode).vertical)switch(e.textAlign){case tS.Left:e.x=this.pagePadding[0];break;case tS.Center:e.x=this.scaledWidth/2;break;case tS.Right:e.x=this.scaledWidth-this.pagePadding[2]}else e.x=this.firstBarX,e.textAlign=tS.Left}layoutAndRenderAnnotation(e){let t=this.renderer.settings.display.resources,i=r_.withFamilyList(t.copyrightFont.families,12,t5.Plain,t3.Bold),s=new oz(this.renderer,this.renderer.tracks[0].staves[0].bars[0]),a=new oT(0,0,"rendered by alphaTab",i,tS.Center,void 0,t.mainGlyphColor);a.renderer=s,a.doLayout(),this.alignScoreInfoGlyph(a);let r=new nr;return r.width=a.x+a.width,r.x=0,r.height=12,r.y=e,r.totalWidth=this.scaledWidth,r.totalHeight=e+12,r.firstMasterBarIndex=-1,r.lastMasterBarIndex=-1,this.registerPartial(r,e=>{e.color=t.mainGlyphColor,e.font=i,e.textAlign=tS.Left,e.textBaseline=t_.Top,a.paint(0,0,e)}),e+12}}oR.HeaderElements=new iD(()=>new Map([[tD.Title,tp.ScoreTitle],[tD.SubTitle,tp.ScoreSubTitle],[tD.Artist,tp.ScoreArtist],[tD.Album,tp.ScoreAlbum],[tD.Words,tp.ScoreWords],[tD.Music,tp.ScoreMusic],[tD.WordsAndMusic,tp.ScoreWordsAndMusic],[tD.Transcriber,void 0]])),oR.FooterElements=new iD(()=>new Map([[tD.Copyright,tp.ScoreCopyright],[tD.CopyrightSecondLine,void 0]]));class oO extends ol{constructor(){super(0,0),this._effectGlyphs=[],this._normalGlyphs=[],this.computedWidth=0}doLayout(){let e=0;if(this.glyphs)for(let t=0,i=this.glyphs.length;t<i;t++){let i=this.glyphs[t];i.x=e,i.renderer=this.renderer,i.doLayout(),e+=i.width}this.width=e,this.computedWidth=e}noteLoop(e){for(let t=this.container.beat.notes.length-1;t>=0;t--)e(this.container.beat.notes[t])}addEffect(e){super.addGlyph(e),this._effectGlyphs.push(e)}addNormal(e){super.addGlyph(e),this._normalGlyphs.push(e)}get effectElement(){}paint(e,t,i){this.paintEffects(e,t,i),this.paintNormal(e,t,i)}paintNormal(e,t,i){for(let s of this._normalGlyphs)s.paint(e+this.x,t+this.y,i)}paintEffects(e,t,i){let s=this.effectElement?od.beat(i,this.effectElement,this.container.beat):void 0;try{for(let s of this._effectGlyphs)s.paint(e+this.x,t+this.y,i)}finally{s?.[Symbol.dispose]?.()}}}class oH extends oO{constructor(){super(...arguments),this.centerX=0}updateBeamingHelper(){}buildBoundingsLookup(e,t,i){}getNoteX(e,t){return 0}getNoteY(e,t){return 0}}class oV extends nC{constructor(e,t,i,s=1){super(e,t),this._scale=0,this._symbols=[],this._symbols=oV.getSymbols(i),this._scale=s}static getSymbols(e){let t=[];for(;e>0;){let i=e%10;t.unshift(oV.getSymbol(i)),e=e/10|0}return t}static getSymbol(e){switch(e){case 0:return tb.TimeSig0;case 1:return tb.TimeSig1;case 2:return tb.TimeSig2;case 3:return tb.TimeSig3;case 4:return tb.TimeSig4;case 5:return tb.TimeSig5;case 6:return tb.TimeSig6;case 7:return tb.TimeSig7;case 8:return tb.TimeSig8;case 9:return tb.TimeSig9;default:return tb.None}}doLayout(){let e=0;for(let t of this._symbols)e+=nE.Widths.get(t);this.width=e}paint(e,t,i){i.fillMusicFontSymbols(e+this.x,t+this.y,this._scale,this._symbols)}}oV.numberHeight=18;class oW extends nC{constructor(){super(0,0),this._numberGlyph=[]}doLayout(){this.width=70,this.renderer.registerOverflowTop(this.renderer.getLineHeight(1));let e=this.renderer.additionalMultiRestBars.length+1;this._numberGlyph=oV.getSymbols(e)}paint(e,t,i){i.fillMusicFontSymbols(e+this.x,t+this.y+this.renderer.height/2,1,[tb.RestHBarLeft,tb.RestHBarMiddle,tb.RestHBarMiddle,tb.RestHBarMiddle,tb.RestHBarRight]);let s=this.renderer.getLineY(-1.5);i.fillMusicFontSymbols(e+this.x+oW.BarWidth/2,t+this.y+s|0,1,this._numberGlyph,!0)}}oW.BarWidth=60;class oG extends nA{constructor(e){super(oG.getOrCreatePlaceholderBeat(e),e),this.preNotes=new oO,this.onNotes=new oH}doLayout(){this.renderer.showMultiBarRest&&this.onNotes.addNormal(new oW),super.doLayout()}static getOrCreatePlaceholderBeat(e){if(e.voice.beats.length>1)return e.voice.beats[0];let t=new i1;return t.voice=e.voice,t}}(eI=ir||(ir={}))[eI.TopWithStem=0]="TopWithStem",eI[eI.Top=1]="Top",eI[eI.Center=2]="Center",eI[eI.Bottom=3]="Bottom",eI[eI.BottomWithStem=4]="BottomWithStem",(eA=io||(io={}))[eA.Left=0]="Left",eA[eA.Center=1]="Center",eA[eA.Right=2]="Right";class oz{get nextRenderer(){return this.bar&&this.bar.nextBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.nextBar):null}get previousRenderer(){return this.bar&&this.bar.previousBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.previousBar):null}get lastBar(){return this.additionalMultiRestBars?this.additionalMultiRestBars[this.additionalMultiRestBars.length-1]:this.bar}get showMultiBarRest(){return!1}constructor(e,t){this._preBeatGlyphs=new oh,this._voiceContainers=new Map,this._postBeatGlyphs=new oh,this._ties=[],this.additionalMultiRestBars=null,this.x=0,this.y=0,this.width=0,this.computedWidth=0,this.height=0,this.index=0,this.topOverflow=0,this.bottomOverflow=0,this.isLinkedToPrevious=!1,this.canWrap=!0,this.wasFirstOfLine=!1,this._appliedLayoutingInfo=0,this.isFinalized=!1,this.topPadding=0,this.bottomPadding=0,this.scoreRenderer=e,this.bar=t,t&&(this.helpers=new oS(this))}registerTies(e){this._ties.push(...e)}get middleYPosition(){return 0}registerOverflowTop(e){return e>this.topOverflow&&(this.topOverflow=e,!0)}registerOverflowBottom(e){return e>this.bottomOverflow&&(this.bottomOverflow=e,!0)}scaleToWidth(e){let t=e-this._preBeatGlyphs.width-this._postBeatGlyphs.width;for(let e of this._voiceContainers.values())e.scaleToWidth(t);this._postBeatGlyphs.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width+t,this.width=e}get resources(){return this.settings.display.resources}get settings(){return this.scoreRenderer.settings}get barDisplayScale(){return this.staff.system.staves.length>1?this.bar.masterBar.displayScale:this.bar.displayScale}get barDisplayWidth(){return this.staff.system.staves.length>1?this.bar.masterBar.displayWidth:this.bar.displayWidth}get isFirstOfLine(){return 0===this.index}get isLast(){return!this.bar||this.bar.index===this.scoreRenderer.layout.lastBarIndex}registerLayoutingInfo(){let e=this.layoutingInfo,t=this._preBeatGlyphs.width;for(let i of(e.preBeatSize<t&&(e.preBeatSize=t),this._voiceContainers.values()))i.registerLayoutingInfo(e),i.x,i.width;let i=this._postBeatGlyphs.width;e.postBeatSize<i&&(e.postBeatSize=i)}applyLayoutingInfo(){if(this._appliedLayoutingInfo>=this.layoutingInfo.version)return!1;this._appliedLayoutingInfo=this.layoutingInfo.version,this._preBeatGlyphs.width=this.layoutingInfo.preBeatSize;let e=this._preBeatGlyphs.x+this._preBeatGlyphs.width;for(let t of this._voiceContainers.values()){t.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width,t.applyLayoutingInfo(this.layoutingInfo);let i=t.x+t.width;e<i&&(e=i)}this._postBeatGlyphs.x=Math.floor(e),this._postBeatGlyphs.width=this.layoutingInfo.postBeatSize,this.width=Math.ceil(this._postBeatGlyphs.x+this._postBeatGlyphs.width),this.computedWidth=this.width;let t=this.barDisplayWidth;return t>0&&this.scoreRenderer.layout.systemsLayoutMode===ia.FromModelWithWidths&&(this.width=t,this.computedWidth=t),!0}finalizeRenderer(){this.isFinalized=!0;let e=!1,t=this.y-this.staff.topSpacing,i=this.y+this.height+this.staff.bottomSpacing;for(let s of this._ties)if(s.doLayout(),s.height>0){let a=s.y+s.height-i;a>0&&this.registerOverflowBottom(a)&&(e=!0);let r=s.y-t;r<0&&this.registerOverflowTop(-1*r)&&(e=!0)}return e}doLayout(){if(this.bar){this.helpers.initialize(),this._ties=[],this._preBeatGlyphs=new oh,this._preBeatGlyphs.renderer=this,this._voiceContainers.clear(),this._postBeatGlyphs=new oh,this._postBeatGlyphs.renderer=this;for(let e=0;e<this.bar.voices.length;e++){let t=this.bar.voices[e];if(this.hasVoiceContainer(t)){let i=new ou(0,0,t);i.renderer=this,this._voiceContainers.set(this.bar.voices[e].index,i)}}if(this.bar.simileMark===eZ.SecondOfDouble&&(this.canWrap=!1),this.createPreBeatGlyphs(),this.additionalMultiRestBars){let e=new oG(this.getVoiceContainer(this.bar.voices[0]));this.addBeatGlyph(e)}else this.createBeatGlyphs();for(let e of(this.createPostBeatGlyphs(),this.updateSizes(),this.helpers.beamHelpers))for(let t of e)t.finish();this.computedWidth=this.width}}hasVoiceContainer(e){return!!this.additionalMultiRestBars||0===e.index||!e.isEmpty}updateSizes(){this.staff.registerStaffTop(this.topPadding),this.staff.registerStaffBottom(this.height-this.bottomPadding);let e=this._voiceContainers,t=this.beatGlyphsStart,i=t;for(let s of e.values()){s.x=t,s.doLayout();let e=s.x+s.width;i<e&&(i=e)}this._postBeatGlyphs.x=Math.floor(i),this.width=Math.ceil(this._postBeatGlyphs.x+this._postBeatGlyphs.width),this.height+=this.layoutingInfo.height}addPreBeatGlyph(e){e.renderer=this,this._preBeatGlyphs.addGlyph(e)}addBeatGlyph(e){e.renderer=this,e.preNotes.renderer=this,e.onNotes.renderer=this,e.onNotes.beamingHelper=this.helpers.beamHelperLookup[e.beat.voice.index].get(e.beat.index),this.getVoiceContainer(e.beat.voice).addGlyph(e)}getVoiceContainer(e){return this._voiceContainers.has(e.index)?this._voiceContainers.get(e.index):void 0}getBeatContainer(e){return this.getVoiceContainer(e.voice)?.beatGlyphs?.[e.index]}getPreNotesGlyphForBeat(e){return this.getBeatContainer(e)?.preNotes}getOnNotesGlyphForBeat(e){return this.getBeatContainer(e)?.onNotes}paint(e,t,i){for(let s of(this.paintBackground(e,t,i),i.color=this.resources.mainGlyphColor,this._preBeatGlyphs.paint(e+this.x,t+this.y,i),this._voiceContainers.values()))s.paint(e+this.x,t+this.y,i);i.color=this.resources.mainGlyphColor,this._postBeatGlyphs.paint(e+this.x,t+this.y,i)}paintBackground(e,t,i){this.layoutingInfo.paint(e+this.x+this._preBeatGlyphs.x+this._preBeatGlyphs.width,t+this.y+this.height,i)}buildBoundingsLookup(e,t,i){let s=new nn;for(let[a,r]of(s.bar=this.bar,s.visualBounds=new sy,s.visualBounds.x=t+this.x,s.visualBounds.y=i+this.y+this.topPadding,s.visualBounds.w=this.width,s.visualBounds.h=this.height-this.topPadding-this.bottomPadding,s.realBounds=new sy,s.realBounds.x=t+this.x,s.realBounds.y=i+this.y,s.realBounds.w=this.width,s.realBounds.h=this.height,e.addBar(s),this._voiceContainers)){let e=this.bar.isEmpty&&0===a;if(!r.voice.isEmpty||e)for(let a=0,n=r.beatGlyphs.length;a<n;a++)r.beatGlyphs[a].buildBoundingsLookup(s,t+this.x+r.x,i+this.y+r.y,e)}}addPostBeatGlyph(e){this._postBeatGlyphs.addGlyph(e)}createPreBeatGlyphs(){this.wasFirstOfLine=this.isFirstOfLine}createBeatGlyphs(){for(let e of this.bar.voices)this.hasVoiceContainer(e)&&this.createVoiceGlyphs(e)}createVoiceGlyphs(e){}createPostBeatGlyphs(){}get beatGlyphsStart(){return this._preBeatGlyphs.x+this._preBeatGlyphs.width}get postBeatGlyphsStart(){return this._postBeatGlyphs.x}getBeatX(e,t=is.PreNotes){let i=this.getBeatContainer(e);if(i)switch(t){case is.PreNotes:return i.voiceContainer.x+i.x;case is.OnNotes:return i.voiceContainer.x+i.x+i.onNotes.x;case is.MiddleNotes:return i.voiceContainer.x+i.x+i.onTimeX;case is.Stem:let s=i.onNotes.beamingHelper?i.onNotes.beamingHelper.getBeatLineX(e):i.onNotes.x+i.onNotes.width/2;return i.voiceContainer.x+s;case is.PostNotes:return i.voiceContainer.x+i.x+i.onNotes.x+i.onNotes.width;case is.EndBeat:return i.voiceContainer.x+i.x+i.width}return 0}getRatioPositionX(e){let t=this.bar.isEmpty?this.beatGlyphsStart:this.getBeatX(this.bar.voices[0].beats[0],is.OnNotes),i=this.postBeatGlyphsStart-t;return t+i*e}getNoteX(e,t){let i=this.getBeatContainer(e.beat);return i?i.voiceContainer.x+i.x+i.onNotes.x+i.onNotes.getNoteX(e,t):0}getNoteY(e,t){let i=this.getOnNotesGlyphForBeat(e.beat);return i?i.getNoteY(e,t):NaN}reLayout(){(this.wasFirstOfLine&&!this.isFirstOfLine||!this.wasFirstOfLine&&this.isFirstOfLine)&&this.recreatePreBeatGlyphs(),this.updateSizes(),this.registerLayoutingInfo()}recreatePreBeatGlyphs(){this._preBeatGlyphs=new oh,this._preBeatGlyphs.renderer=this,this.createPreBeatGlyphs()}paintSimileMark(e,t,i){let s=od.voice(i,tf.Glyphs,this.bar.voices[0],!0);try{switch(this.bar.simileMark){case eZ.Simple:i.beginGroup(nA.getGroupId(this.bar.voices[0].beats[0])),i.fillMusicFontSymbol(e+this.x+(this.width-20)/2,t+this.y+this.height/2,1,tb.Repeat1Bar,!1),i.endGroup();break;case eZ.SecondOfDouble:i.beginGroup(nA.getGroupId(this.bar.voices[0].beats[0])),i.beginGroup(nA.getGroupId(this.bar.previousBar.voices[0].beats[0])),i.fillMusicFontSymbol(e+this.x-14,t+this.y+this.height/2,1,tb.Repeat2Bars,!1),i.endGroup(),i.endGroup()}}finally{s?.[Symbol.dispose]?.()}}completeBeamingHelper(e){}getBeatDirection(e){return this.helpers.getBeamingHelperForBeat(e).direction}}oz.RawLineSpacing=8,oz.StemWidth=.12*oz.RawLineSpacing,oz.StaffLineThickness=.13*oz.RawLineSpacing,oz.BeamThickness=.5*oz.RawLineSpacing,oz.BeamSpacing=.25*oz.RawLineSpacing,(eR=il||(il={}))[eR.SinglePreBeat=0]="SinglePreBeat",eR[eR.SingleOnBeat=1]="SingleOnBeat",eR[eR.SingleOnBeatToEnd=2]="SingleOnBeatToEnd",eR[eR.GroupedOnBeat=3]="GroupedOnBeat",eR[eR.GroupedOnBeatToEnd=4]="GroupedOnBeatToEnd",eR[eR.FullBar=5]="FullBar";class oU extends nC{constructor(e,t){super(0,0),this._uniqueEffectGlyphs=[],this._effectGlyphs=[],this.isEmpty=!0,this.previousBand=null,this.isLinkedToPrevious=!1,this.firstBeat=null,this.lastBeat=null,this.height=0,this.originalHeight=0,this.slot=null,this.voice=e,this.info=t}doLayout(){super.doLayout();for(let e=0;e<this.renderer.bar.voices.length;e++)this._effectGlyphs.push(new Map),this._uniqueEffectGlyphs.push([])}createGlyph(e){if(e.voice===this.voice&&this.info.shouldCreateGlyph(this.renderer.settings,e)&&(!this.info.hideOnMultiTrack||0===this.renderer.staff.trackIndex)){if(this.isEmpty=!1,(!this.firstBeat||e.isBefore(this.firstBeat))&&(this.firstBeat=e),!this.lastBeat||e.isAfter(this.lastBeat))switch(this.lastBeat=e,this.info.sizingMode){case il.SingleOnBeatToEnd:case il.GroupedOnBeatToEnd:this.lastBeat.nextBeat&&(this.lastBeat=this.lastBeat.nextBeat)}let t=this.createOrResizeGlyph(this.info.sizingMode,e);t.height>this.height&&(this.height=t.height,this.originalHeight=t.height)}}resetHeight(){this.height=this.originalHeight}createOrResizeGlyph(e,t){let i;switch(e){case il.FullBar:case il.SinglePreBeat:case il.SingleOnBeat:case il.SingleOnBeatToEnd:return(i=this.info.createNewGlyph(this.renderer,t)).renderer=this.renderer,i.beat=t,i.doLayout(),this._effectGlyphs[t.voice.index].set(t.index,i),this._uniqueEffectGlyphs[t.voice.index].push(i),i;case il.GroupedOnBeat:case il.GroupedOnBeatToEnd:let s=e===il.GroupedOnBeat?il.SingleOnBeat:il.SingleOnBeatToEnd;if(t.index>0||this.renderer.index>0){let e=t.previousBeat;if(this.info.shouldCreateGlyph(this.renderer.settings,e)){let i=null;if(t.index>0&&this._effectGlyphs[t.voice.index].has(e.index))i=this._effectGlyphs[t.voice.index].get(e.index);else if(this.renderer.index>0){let t=this.renderer.previousRenderer.getBand(e.voice,this.info.effectId);if(t){let s=t._effectGlyphs[e.voice.index];s.has(e.index)&&(i=s.get(e.index))}}let a=this.createOrResizeGlyph(s,t);return i&&this.info.canExpand(e,t)&&(i.nextGlyph=a,a.previousGlyph=i,this.isLinkedToPrevious=!0),a}}return this.createOrResizeGlyph(s,t);default:return this.createOrResizeGlyph(il.SingleOnBeat,t)}}paint(e,t,i){super.paint(e,t,i);for(let s=0,a=this._uniqueEffectGlyphs.length;s<a;s++){let a=this._uniqueEffectGlyphs[s];for(let s=0,r=a.length;s<r;s++){let r=a[s],n=od.beat(i,tC.Effects,r.beat,!1);try{r.paint(e+this.x,t+this.y,i)}finally{n?.[Symbol.dispose]?.()}}}}alignGlyphs(){for(let e=0;e<this._effectGlyphs.length;e++)for(let t of this._effectGlyphs[e].keys())this.alignGlyph(this.info.sizingMode,this.renderer.bar.voices[e].beats[t])}alignGlyph(e,t){let i=this._effectGlyphs[t.voice.index].get(t.index),s=this.renderer.getBeatContainer(t);switch(e){case il.SinglePreBeat:let a=this.renderer.layoutingInfo.getPreBeatSize(t);i.x=this.renderer.beatGlyphsStart+s.x-a;break;case il.SingleOnBeat:case il.GroupedOnBeat:i.x=this.renderer.beatGlyphsStart+s.x;break;case il.SingleOnBeatToEnd:case il.GroupedOnBeatToEnd:i.x=this.renderer.beatGlyphsStart+s.x,s.beat.isLastOfVoice?i.width=this.renderer.width-i.x:i.width=this.renderer.layoutingInfo.getPostBeatSize(t);break;case il.FullBar:i.width=this.renderer.width}}}class oX{constructor(){this.uniqueEffectId=null,this.y=0,this.height=0,this.firstBeat=null,this.lastBeat=null}}class oJ{constructor(){this.bands=[],this.shared=new oX}update(e){e.info.canShareBand||(this.shared.uniqueEffectId=e.info.effectId),e.slot=this,this.bands.push(e),e.height>this.shared.height&&(this.shared.height=e.height),(!this.shared.firstBeat||e.firstBeat.isBefore(this.shared.firstBeat))&&(this.shared.firstBeat=e.firstBeat),(!this.shared.lastBeat||e.lastBeat.isAfter(this.shared.lastBeat))&&(this.shared.lastBeat=e.lastBeat)}canBeUsed(e){return(!this.shared.uniqueEffectId&&e.info.canShareBand||e.info.effectId===this.shared.uniqueEffectId)&&(!this.shared.firstBeat||this.shared.lastBeat.isBefore(e.firstBeat)||this.shared.lastBeat.isBefore(this.shared.firstBeat))}}class oY{constructor(){this.slots=[],this._effectSlot=new Map}getOrCreateSlot(e){if(this._effectSlot.has(e.info.effectId)){let t=this._effectSlot.get(e.info.effectId);if(t.canBeUsed(e))return t}for(let t of this.slots)if(t.canBeUsed(e))return t;let t=new oJ;return this.slots.push(t),t}register(e){let t=this.getOrCreateSlot(e);t.update(e),this._effectSlot.set(e.info.effectId,t)}}class oq extends oz{constructor(e,t,i){super(e,t),this._bands=[],this._bandLookup=new Map,this.sizingInfo=null,this._infos=i}updateSizes(){this.topOverflow=0,this.bottomOverflow=0,this.topPadding=0,this.bottomPadding=0,this.updateHeight(),super.updateSizes()}finalizeRenderer(){let e=super.finalizeRenderer();return this.updateHeight()&&(e=!0),e}updateHeight(){if(!this.sizingInfo)return!1;let e=0;for(let t of this.sizingInfo.slots){for(let i of(t.shared.y=e,t.bands))i.y=e,i.height=t.shared.height;e+=t.shared.height}return e!==this.height&&(this.height=e,!0)}applyLayoutingInfo(){let e=!super.applyLayoutingInfo();if(this.index>0){let e=this.previousRenderer;this.sizingInfo=e.sizingInfo}else this.sizingInfo=new oY;for(let e of this._bands)e.resetHeight(),e.alignGlyphs(),e.isEmpty||this.sizingInfo.register(e);return this.updateHeight(),e}scaleToWidth(e){for(let t of(super.scaleToWidth(e),this._bands))t.alignGlyphs()}createBeatGlyphs(){for(let e of(this._bands=[],this._bandLookup=new Map,this.bar.voices))if(this.hasVoiceContainer(e))for(let t of this._infos){let i=new oU(e,t);i.renderer=this,i.doLayout(),this._bands.push(i),this._bandLookup.set(`${e.index}.${t.effectId}`,i)}for(let e of(super.createBeatGlyphs(),this._bands))e.isLinkedToPrevious&&(this.isLinkedToPrevious=!0)}createVoiceGlyphs(e){for(let t of e.beats){let i=new nA(t,this.getVoiceContainer(e));for(let e of(i.preNotes=new oO,i.onNotes=new oH,this.addBeatGlyph(i),this._bands))e.createGlyph(t)}}paint(e,t,i){for(let s of(this.paintBackground(e,t,i),this._bands))i.color=0===s.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,s.isEmpty||s.paint(e+this.x,t+this.y,i)}getBand(e,t){let i=`${e.index}.${t}`;return this._bandLookup.has(i)?this._bandLookup.get(i):null}}class o$ extends oo{get staffId(){return this._staffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.effectStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.effectStaffPaddingBottom}constructor(e,t,i=null){super(),this.infos=t,this._staffId=e,this.isInsideBracket=!1,this.isRelevantForBoundsLookup=!1,this.shouldShow=i}canCreate(e,t){let i=this.shouldShow;return super.canCreate(e,t)&&(!i||i(e,t))}create(e,t){return new oq(e,t,this.infos.filter(t=>e.settings.notation.isNotationElementVisible(t.notationElement)))}}class oj extends nD{constructor(e,t,i,s,a){super(e,t),this._endingsString="",this._endings=iW.getAlternateEndingsList(i),this._openLine=s,this._closeLine=a}doLayout(){super.doLayout(),this.height=this.renderer.resources.wordsFont.size+(oj.Padding+2);let e="";for(let t=0,i=this._endings.length;t<i;t++)e+=this._endings[t]+1,e+=". ";this._endingsString=e}paint(e,t,i){let s=this._closeLine?this.width-4:this.width;if(e=(0|e)+.5,t=(0|t)+.5,this._openLine?(i.moveTo(e+this.x,t+this.y+this.height),i.lineTo(e+this.x,t+this.y)):i.moveTo(e+this.x,t+this.y),i.lineTo(e+this.x+s,t+this.y),this._closeLine&&i.lineTo(e+this.x+s,t+this.y+this.height),i.stroke(),this._openLine){let s=i.textBaseline;i.textBaseline=t_.Top,i.font=this.renderer.resources.wordsFont,i.fillText(this._endingsString,e+this.x+oj.Padding,t+this.y),i.textBaseline=s}}}oj.Padding=3;class oK{get effectId(){return this.notationElement.toString()}}class oQ extends oK{get notationElement(){return tp.EffectAlternateEndings}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return il.FullBar}shouldCreateGlyph(e,t){return 0===t.voice.index&&0===t.index&&0!==t.voice.bar.masterBar.alternateEndings}createNewGlyph(e,t){let i=t.voice.bar.masterBar,s=null===i.previousMasterBar||i.alternateEndings!==i.previousMasterBar.alternateEndings,a=i.isRepeatEnd||null===i.nextMasterBar||i.alternateEndings!==i.nextMasterBar.alternateEndings;return i.repeatGroup.closings.some(e=>e.index>=i.index)||(a=!1),new oj(0,0,i.alternateEndings,s,a)}canExpand(e,t){return!0}}class oZ extends oK{get notationElement(){return tp.EffectCapo}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return il.SingleOnBeat}shouldCreateGlyph(e,t){return 0===t.index&&0===t.voice.bar.index&&0!==t.voice.bar.staff.capo}createNewGlyph(e,t){return new oT(0,0,`Capo. fret ${t.voice.bar.staff.capo}`,e.resources.effectFont,tS.Left)}canExpand(e,t){return!1}}class o0 extends oK{get notationElement(){return tp.EffectChordNames}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return il.SingleOnBeat}shouldCreateGlyph(e,t){return t.hasChord}createNewGlyph(e,t){return new oT(0,0,t.chord.name,e.resources.effectFont,tS.Center)}canExpand(e,t){return!1}}class o1 extends nD{constructor(e){super(),this.forceGroupedRendering=!1,this.endOnBarLine=!1,this.endPosition=e}get isLinkedWithPrevious(){return!!this.previousGlyph&&this.previousGlyph.renderer.staff.system===this.renderer.staff.system}get isLinkedWithNext(){return!!this.nextGlyph&&this.nextGlyph.renderer.isFinalized&&this.nextGlyph.renderer.staff.system===this.renderer.staff.system}paint(e,t,i){let s;if(this.isLinkedWithPrevious)return;if(!this.isLinkedWithNext&&!this.forceGroupedRendering)return void this.paintNonGrouped(e,t,i);if(!this.isLinkedWithNext&&this.forceGroupedRendering)s=this;else for(s=this.nextGlyph;s.isLinkedWithNext;)s=s.nextGlyph;let a=s.renderer,r=s.beat,n=this.endPosition,o=e-this.renderer.x,l=this.calculateEndX(a,r,o,n);this.paintGrouped(e,t,l,i)}calculateEndX(e,t,i,s){return t?i+e.x+e.getBeatX(t,s):i+e.x+this.x+this.width}paintNonGrouped(e,t,i){let s=e-this.renderer.x,a=this.calculateEndX(this.renderer,this.beat,s,this.endPosition);this.paintGrouped(e,t,a,i)}}class o2 extends o1{constructor(e,t,i){super(is.EndBeat),this._crescendo=te.None,this._crescendo=i,this.x=e,this.y=t}doLayout(){super.doLayout(),this.height=17}paintGrouped(e,t,i,s){let a=e+this.x,r=this.height,n=nE.Widths.get(tb.NoteheadBlack)/2;s.beginPath(),this._crescendo===te.Crescendo?(i-=n,s.moveTo(i,t+this.y),s.lineTo(a,t+this.y+r/2),s.lineTo(i,t+this.y+r)):(i-=n,s.moveTo(a,t+this.y),s.lineTo(i,t+this.y+r/2),s.lineTo(a,t+this.y+r)),s.stroke()}}class o5 extends oK{get notationElement(){return tp.EffectCrescendo}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return il.GroupedOnBeatToEnd}shouldCreateGlyph(e,t){return t.crescendo!==te.None}createNewGlyph(e,t){return new o2(0,0,t.crescendo)}canExpand(e,t){return e.crescendo===t.crescendo}}class o3 extends nM{constructor(e,t,i){super(e,t,.6,o3.getSymbol(i)),this.center=!0}doLayout(){super.doLayout(),this.y+=this.height/2}static getSymbol(e){switch(e){case e4.PPP:return tb.DynamicPPP;case e4.PP:return tb.DynamicPP;case e4.P:return tb.DynamicPiano;case e4.MP:return tb.DynamicMP;case e4.MF:return tb.DynamicMF;case e4.F:return tb.DynamicForte;case e4.FF:return tb.DynamicFF;case e4.FFF:return tb.DynamicFFF;case e4.PPPP:return tb.DynamicPPPP;case e4.PPPPP:case e4.PPPPPP:return tb.DynamicPPPPP;case e4.FFFF:return tb.DynamicFFFF;case e4.FFFFF:return tb.DynamicFFFFF;case e4.FFFFFF:return tb.DynamicFFFFFF;case e4.SF:return tb.DynamicSforzando1;case e4.SFP:return tb.DynamicSforzandoPiano;case e4.SFPP:return tb.DynamicSforzandoPianissimo;case e4.FP:return tb.DynamicFortePiano;case e4.RF:return tb.DynamicRinforzando1;case e4.RFZ:return tb.DynamicRinforzando2;case e4.SFZ:return tb.DynamicSforzato;case e4.SFFZ:return tb.DynamicSforzatoFF;case e4.FZ:return tb.DynamicForzando;case e4.N:return tb.DynamicNiente;case e4.PF:return tb.DynamicPF;case e4.SFZP:return tb.DynamicSforzatoPiano;default:return tb.None}}}class o4 extends oK{get notationElement(){return tp.EffectDynamics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return il.SingleOnBeat}shouldCreateGlyph(e,t){return this.internalShouldCreateGlyph(t)}internalShouldCreateGlyph(e){if(e.voice.bar.staff.track.score.stylesheet.hideDynamics||e.isEmpty||e.voice.isEmpty||e.isRest)return!1;let t=this.getPreviousDynamicsBeat(e),i=0===e.voice.index&&!t||e.dynamics!==t?.dynamics;if(i&&e.voice.index>0){for(let t of e.voice.bar.voices)if(t.index<e.voice.index){let s=t.getBeatAtPlaybackStart(e.playbackStart);s&&e.dynamics===s.dynamics&&this.internalShouldCreateGlyph(s)&&(i=!1)}}return i}getPreviousDynamicsBeat(e){let t=e.previousBeat;for(;null!=t;){if(!t.isRest)return t;t=t.previousBeat}return null}createNewGlyph(e,t){return new o3(0,0,t.dynamics)}canExpand(e,t){return!0}}class o6 extends nM{constructor(e){super(0,0,1,o6.getSymbol(e)),this.center=!0}static getSymbol(e){switch(e){case tN.FadeIn:return tb.GuitarFadeIn;case tN.FadeOut:return tb.GuitarFadeOut;case tN.VolumeSwell:return tb.GuitarVolumeSwell}return tb.None}paint(e,t,i){super.paint(e,t+this.height,i)}}class o8 extends oK{get notationElement(){return tp.EffectFadeIn}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return il.SingleOnBeat}shouldCreateGlyph(e,t){return t.fade!==tN.None}createNewGlyph(e,t){return new o6(t.fade)}canExpand(e,t){return!0}}class o7 extends nM{constructor(e,t,i){super(e,t,1,o7.getSymbol(i))}static getSymbol(e){switch(e){case tA.Short:return tb.FermataShortAbove;case tA.Medium:return tb.FermataAbove;case tA.Long:return tb.FermataLongAbove;default:return tb.None}}paint(e,t,i){super.paint(e-this.width/2,t+this.height,i)}}class o9 extends oK{get notationElement(){return tp.EffectFermata}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return il.SingleOnBeat}shouldCreateGlyph(e,t){return 0===t.voice.index&&!!t.fermata}createNewGlyph(e,t){return new o7(0,0,t.fermata.type)}canExpand(e,t){return!0}}class le extends oK{get notationElement(){return tp.EffectFingering}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return il.SingleOnBeat}shouldCreateGlyph(e,t){return 0===t.voice.index&&!t.isRest&&(e.notation.fingeringMode===tc.SingleNoteEffectBand||e.notation.fingeringMode===tc.SingleNoteEffectBandForcePiano)&&1===t.notes.length&&t.notes[0].isFingering}createNewGlyph(e,t){let i=ta.Unknown,s=!1,a=t.notes[0];return a.leftHandFinger!==ta.Unknown?(i=a.leftHandFinger,s=!0):a.rightHandFinger!==ta.Unknown&&(i=a.rightHandFinger),new oT(0,0,iW.fingerToString(e.settings,t,i,s)??"",e.resources.fingeringFont,tS.Left)}canExpand(e,t){return!0}}class lt extends oK{constructor(){super(...arguments),this.lastCreateInfo=null}shouldCreateGlyph(e,t){this.lastCreateInfo=[];for(let e=0,i=t.notes.length;e<i;e++){let i=t.notes[e];this.shouldCreateGlyphForNote(i)&&this.lastCreateInfo.push(i)}return this.lastCreateInfo.length>0}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}canExpand(e,t){return!0}}class li extends o1{constructor(e,t=!0){super(is.OnNotes),this._label=e,this._dashed=t}doLayout(){this.renderer.settings.notation.extendLineEffectsToBeatEnd&&(this.endPosition=is.EndBeat,this.forceGroupedRendering=!0),super.doLayout(),this.height=this.renderer.resources.effectFont.size}paintNonGrouped(e,t,i){i.font=this.renderer.resources.effectFont;let s=i.textAlign;i.textAlign=tS.Center,i.fillText(this._label,e+this.x,t+this.y),i.textAlign=s}paintGrouped(e,t,i,s){this.paintNonGrouped(e,t,s);let a=s.measureText(this._label).width,r=e+this.x+a/2+3,n=t+this.y+4;if(this._dashed){if(i>r){let e=r;for(;e<i;)s.beginPath(),s.moveTo(e,0|n),s.lineTo(Math.min(e+8,i),0|n),e+=11,s.stroke();s.beginPath(),s.moveTo(i,n-5|0),s.lineTo(i,n+5|0),s.stroke()}}else s.beginPath(),s.moveTo(r,0|n),s.lineTo(i,0|n),s.lineTo(i,n+5|0),s.stroke()}}li.LineSpacing=3,li.LineTopPadding=4,li.LineTopOffset=5,li.LineSize=8;class ls extends lt{get effectId(){return this._effectId}get notationElement(){return tp.EffectHarmonics}constructor(e){switch(super(),this._beat=null,this._harmonicType=e,e){case tr.None:this._effectId="harmonics-none";break;case tr.Natural:this._effectId="harmonics-natural";break;case tr.Artificial:this._effectId="harmonics-artificial";break;case tr.Pinch:this._effectId="harmonics-pinch";break;case tr.Tap:this._effectId="harmonics-tap";break;case tr.Semi:this._effectId="harmonics-semi";break;case tr.Feedback:this._effectId="harmonics-feedback";break;default:this._effectId=""}}shouldCreateGlyphForNote(e){return!!e.isHarmonic&&e.harmonicType===this._harmonicType&&(e.beat!==this._beat&&(this._beat=e.beat),!0)}get sizingMode(){return il.GroupedOnBeat}createNewGlyph(e,t){return new li(ls.harmonicToString(this._harmonicType))}static harmonicToString(e){switch(e){case tr.Natural:return"N.H.";case tr.Artificial:return"A.H.";case tr.Pinch:return"P.H.";case tr.Tap:return"T.H.";case tr.Semi:return"S.H.";case tr.Feedback:return"Fdbk."}return""}}class la extends oK{get notationElement(){return tp.EffectLetRing}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(e,t){return t.isLetRing}get sizingMode(){return il.GroupedOnBeat}createNewGlyph(e,t){return new li("LetRing")}canExpand(e,t){return!0}}class lr extends nD{constructor(e,t,i,s,a=tS.Center){super(e,t),this._lines=i,this.font=s,this.textAlign=a}doLayout(){super.doLayout(),this.height=this.font.size*this._lines.length}paint(e,t,i){i.font=this.font;let s=i.textAlign;i.textAlign=this.textAlign;for(let s=0;s<this._lines.length;s++)this._lines[s]&&i.fillText(this._lines[s],e+this.x,t+this.y+s*this.font.size);i.textAlign=s}}class ln extends oK{get notationElement(){return tp.EffectLyrics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return il.SingleOnBeat}shouldCreateGlyph(e,t){return!!t.lyrics}createNewGlyph(e,t){return new lr(0,0,t.lyrics,e.resources.effectFont,tS.Center)}canExpand(e,t){return!0}}class lo extends oK{get notationElement(){return tp.EffectMarker}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return il.SinglePreBeat}shouldCreateGlyph(e,t){return 0===t.voice.bar.staff.index&&0===t.voice.index&&0===t.index&&t.voice.bar.masterBar.isSectionStart}createNewGlyph(e,t){return new oT(0,0,!t.voice.bar.masterBar.section.marker?t.voice.bar.masterBar.section.text:`[${t.voice.bar.masterBar.section.marker}] ${t.voice.bar.masterBar.section.text}`,e.resources.markerFont,tS.Left)}canExpand(e,t){return!0}}class ll extends o1{constructor(e,t){super(is.PostNotes),this._ottava=e,this._aboveStaff=t}doLayout(){super.doLayout(),this.height=nE.Heights.get(tb.QuindicesimaAlta)}paintNonGrouped(e,t,i){this.paintOttava(e,t,i)}paintOttava(e,t,i){let s=0;switch(this._ottava){case eQ._15ma:s=.8*nE.Widths.get(tb.QuindicesimaAlta),i.fillMusicFontSymbol(e+this.x-s/2,t+this.y+this.height,.8,tb.QuindicesimaAlta,!1);break;case eQ._8va:s=.8*nE.Widths.get(tb.OttavaAlta),i.fillMusicFontSymbol(e+this.x-s/2,t+this.y+this.height,.8,tb.OttavaAlta,!1);break;case eQ._8vb:s=.8*nE.Widths.get(tb.OttavaBassaVb),i.fillMusicFontSymbol(e+this.x-s/2,t+this.y+this.height,.8,tb.OttavaBassaVb,!1);break;case eQ._15mb:s=(nE.Widths.get(tb.Quindicesima)+nE.Widths.get(tb.OctaveBaselineM)+nE.Widths.get(tb.OctaveBaselineB))*.8,i.fillMusicFontSymbols(e+this.x-s/2,t+this.y+this.height,.8,[tb.Quindicesima,tb.OctaveBaselineM,tb.OctaveBaselineB],!1)}return s/2}paintGrouped(e,t,i,s){let a=this.paintOttava(e,t,s),r=e+this.x+a+3,n=t+this.y;if(n+=this._aboveStaff?2:this.height-2,i>r){let e=r;for(;e<i;)s.beginPath(),s.moveTo(e,0|n),s.lineTo(Math.min(e+8,i),0|n),e+=11,s.stroke();s.beginPath(),this._aboveStaff?(s.moveTo(i,n),s.lineTo(i,t+this.y+this.height)):(s.moveTo(i,n),s.lineTo(i,t+this.y)),s.stroke()}}}class lh extends oK{get effectId(){return`ottavia-${this._aboveStaff?"above":"below"}`}get notationElement(){return tp.EffectOttavia}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return il.GroupedOnBeat}constructor(e){super(),this._aboveStaff=e}shouldCreateGlyph(e,t){switch(t.ottava){case eQ._15ma:case eQ._8va:return this._aboveStaff;case eQ._8vb:case eQ._15mb:return!this._aboveStaff}return!1}createNewGlyph(e,t){return new ll(t.ottava,this._aboveStaff)}canExpand(e,t){return e.ottava===t.ottava}}class ld extends lt{get notationElement(){return tp.EffectPalmMute}shouldCreateGlyphForNote(e){return e.isPalmMute}get sizingMode(){return il.GroupedOnBeat}createNewGlyph(e,t){return new li("P.M.")}}class lc extends lt{get notationElement(){return tp.EffectPickSlide}shouldCreateGlyphForNote(e){return e.slideOutType===tl.PickSlideDown||e.slideOutType===tl.PickSlideUp}get sizingMode(){return il.GroupedOnBeat}createNewGlyph(e,t){return new li("P.S.")}}class lu extends nM{constructor(e,t,i){super(e,t,nL.GraceScale,lu.getSymbol(i))}paint(e,t,i){super.paint(e,t+this.height,i)}static getSymbol(e){switch(e){case ty.Up:return tb.StringsUpBow;case ty.Down:return tb.StringsDownBow;default:return tb.None}}}class lp extends oK{get notationElement(){return tp.EffectPickStroke}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return il.SingleOnBeat}shouldCreateGlyph(e,t){return t.pickStroke!==ty.None}createNewGlyph(e,t){return new lu(0,0,t.pickStroke)}canExpand(e,t){return!0}}class lm extends o1{constructor(e){super(is.EndBeat),this._stepSize=0,this._type=e}doLayout(){switch(super.doLayout(),this._type){case th.Slight:this._stepSize=12;break;case th.Wide:this._stepSize=23}this.height=18}paintGrouped(e,t,i,s){let a=e+this.x,r=Math.max(1,(i-a)/this._stepSize);s.beginPath(),s.moveTo(a,t+this.y);for(let e=0;e<r;e++)s.lineTo(a+this._stepSize/2,t+this.y+this.height),s.lineTo(a+this._stepSize,t+this.y),a+=this._stepSize;s.stroke()}}class lg extends oK{get notationElement(){return tp.EffectSlightBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return il.GroupedOnBeatToEnd}shouldCreateGlyph(e,t){return t.vibrato===th.Slight}createNewGlyph(e,t){return new lm(th.Slight)}canExpand(e,t){return!0}}class lf extends o1{constructor(e,t,i,s=1.2,a=!1){super(is.EndBeat),this._scale=0,this._symbol=tb.None,this._symbolSize=0,this._type=i,this._scale=s,this.x=e,this.y=t,this._partialWaves=a}doLayout(){switch(super.doLayout(),this._type){case th.Slight:this._symbol=tb.WiggleTrill;break;case th.Wide:this._symbol=tb.WiggleVibratoMediumFast}this._symbolSize=nE.Widths.get(this._symbol)*this._scale,this.height=nE.Heights.get(this._symbol)*this._scale}paintGrouped(e,t,i,s){let a=e+this.x,r=this._symbolSize,n=(i-a)/r;this._partialWaves||(n=Math.floor(n)),n<1&&(n=1);let o=0;for(let i=0;i<n;i++)s.fillMusicFontSymbol(e+this.x+o,t+this.y+2*this.height,this._scale,this._symbol,!1),o+=r}}class ly extends lt{get notationElement(){return tp.EffectSlightNoteVibrato}shouldCreateGlyphForNote(e){let t=e.vibrato===th.Slight||e.isTieDestination&&e.tieOrigin.vibrato===th.Slight;return this._hideOnTiedBend&&t&&e.isTieDestination&&e.tieOrigin.hasBend&&(t=!1),t}get sizingMode(){return il.GroupedOnBeatToEnd}createNewGlyph(e,t){return new lf(0,0,th.Slight,1.2)}constructor(e){super(),this._hideOnTiedBend=e}}class lb extends oK{get notationElement(){return tp.EffectTap}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return il.SingleOnBeat}shouldCreateGlyph(e,t){return t.slap||t.pop||t.tap}createNewGlyph(e,t){let i=e.resources;return t.slap?new oT(0,0,"S",i.effectFont,tS.Left):t.pop?new oT(0,0,"P",i.effectFont,tS.Left):new oT(0,0,"T",i.effectFont,tS.Left)}canExpand(e,t){return!0}}class lS extends nD{constructor(e){super(0,0),this.tempoAutomations=e}doLayout(){super.doLayout(),this.height=25}paint(e,t,i){for(let s of this.tempoAutomations){let a=e+this.renderer.getRatioPositionX(s.ratioPosition);if(i.font=this.renderer.resources.markerFont,i.textBaseline=t_.Top,s.text){let e=i.measureText(s.text);i.fillText(s.text,a,t+this.y+i.font.size/2),a+=e.width+.7*i.font.size}i.fillMusicFontSymbol(a,t+this.y+.8*this.height,.5,tb.NoteQuarterUp,!0),i.fillText(`= ${s.value.toString()}`,a+.5*nE.Widths.get(tb.NoteQuarterUp)+3,t+this.y+i.font.size/2)}}}class l_ extends oK{get notationElement(){return tp.EffectTempo}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return il.SinglePreBeat}shouldCreateGlyph(e,t){return 0===t.voice.bar.staff.index&&0===t.voice.index&&0===t.index&&t.voice.bar.masterBar.tempoAutomations.length>0}createNewGlyph(e,t){return new lS(t.voice.bar.masterBar.tempoAutomations)}canExpand(e,t){return!0}}class lw extends oK{get notationElement(){return tp.EffectText}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return il.SingleOnBeat}shouldCreateGlyph(e,t){return!!t.text}createNewGlyph(e,t){return new oT(0,0,t.text,e.resources.effectFont,tS.Left)}canExpand(e,t){return!0}}class lk extends o1{constructor(e,t){super(is.EndBeat),this.x=e,this.y=t}doLayout(){super.doLayout(),this.height=nE.Heights.get(tb.OrnamentTrill)/2}paintGrouped(e,t,i,s){let a=e+this.x;s.fillMusicFontSymbol(a,t+this.y+this.height,1,tb.OrnamentTrill,!0),a+=nE.Widths.get(tb.OrnamentTrill)/2;let r=1.2*nE.Widths.get(tb.WiggleTrill),n=Math.floor((i-a)/r),o=t+this.y+1.37*this.height,l=a;for(let e=0;e<n;e++)s.fillMusicFontSymbol(l,o,1.2,tb.WiggleTrill,!1),l+=r}}class lB extends lt{get notationElement(){return tp.EffectTrill}shouldCreateGlyphForNote(e){return e.isTrill}get sizingMode(){return il.GroupedOnBeatToEnd}createNewGlyph(e,t){return new lk(0,0)}}(eO=ih||(ih={}))[eO.Full=0]="Full",eO[eO.PartialLeft=1]="PartialLeft",eO[eO.PartialRight=2]="PartialRight";class lT extends nD{constructor(e){super(0,0),this._tripletFeel=e}doLayout(){super.doLayout(),this.height=25}paint(e,t,i){e+=this.x;let s=(t+=this.y)+this.height*nL.GraceScale,a=s+8;i.font=this.renderer.resources.effectFont,i.fillText("(",e,t+.3*this.height);let r=e+10,n=e+40,o=[],l=[],h=[],d=[];switch(this._tripletFeel){case tg.NoTripletFeel:o=[tb.TextBlackNoteLongStem,tb.TextCont8thBeamLongStem,tb.TextBlackNoteFrac8thLongStem],h=[tb.TextBlackNoteLongStem,tb.TextCont8thBeamLongStem,tb.TextBlackNoteFrac8thLongStem];break;case tg.Triplet8th:o=[tb.TextBlackNoteLongStem,tb.TextCont8thBeamLongStem,tb.TextBlackNoteFrac8thLongStem],h=[tb.TextBlackNoteLongStem,tb.Space,tb.NoteEighthUp],d=[tb.TextTupletBracketStartLongStem,tb.TextTuplet3LongStem,tb.TextTupletBracketEndLongStem];break;case tg.Triplet16th:o=[tb.TextBlackNoteLongStem,tb.TextCont8thBeamLongStem,tb.TextBlackNoteFrac8thLongStem],h=[tb.TextBlackNoteLongStem,tb.TextCont8thBeamLongStem,tb.TextBlackNoteFrac16thLongStem],d=[tb.TextTupletBracketStartLongStem,tb.TextTuplet3LongStem,tb.TextTupletBracketEndLongStem];break;case tg.Dotted8th:o=[tb.TextBlackNoteLongStem,tb.TextCont8thBeamLongStem,tb.TextBlackNoteFrac8thLongStem],l=[tb.TextAugmentationDot],h=[tb.TextBlackNoteLongStem,tb.TextCont8thBeamLongStem,tb.TextBlackNoteFrac16thLongStem];break;case tg.Dotted16th:o=[tb.TextBlackNoteLongStem,tb.TextCont16thBeamLongStem,tb.TextBlackNoteFrac16thLongStem],l=[tb.TextAugmentationDot],h=[tb.TextBlackNoteLongStem,tb.TextCont16thBeamLongStem,tb.TextBlackNoteFrac32ndLongStem],i.fillCircle(n+9,s,1);break;case tg.Scottish8th:o=[tb.TextBlackNoteLongStem,tb.TextCont8thBeamLongStem,tb.TextBlackNoteFrac8thLongStem],h=[tb.TextBlackNoteLongStem,tb.TextCont16thBeamLongStem,tb.TextBlackNoteFrac8thLongStem,tb.TextAugmentationDot];break;case tg.Scottish16th:o=[tb.TextBlackNoteLongStem,tb.TextCont16thBeamLongStem,tb.TextBlackNoteFrac16thLongStem],h=[tb.TextBlackNoteLongStem,tb.TextCont32ndBeamLongStem,tb.TextBlackNoteFrac16thLongStem,tb.TextAugmentationDot]}i.fillMusicFontSymbols(r,s,lT.NoteScale,o,!1),i.fillText("=",e+32,t+5),i.fillMusicFontSymbols(n,s,lT.NoteScale,h,!1),l.length>0&&i.fillMusicFontSymbols(n+7,s,lT.NoteScale,l,!1),d.length>0&&i.fillMusicFontSymbols(n,a,lT.TupletScale,d,!1),i.fillText(")",e+65,t+.3*this.height)}}lT.NoteScale=.5,lT.TupletScale=.7;class lN extends oK{get notationElement(){return tp.EffectTripletFeel}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return il.SinglePreBeat}shouldCreateGlyph(e,t){return 0===t.index&&(0===t.voice.bar.masterBar.index&&t.voice.bar.masterBar.tripletFeel!==tg.NoTripletFeel||t.voice.bar.masterBar.index>0&&t.voice.bar.masterBar.tripletFeel!==t.voice.bar.masterBar.previousMasterBar.tripletFeel)}createNewGlyph(e,t){return new lT(t.voice.bar.masterBar.tripletFeel)}canExpand(e,t){return!0}}class lx extends oK{get notationElement(){return tp.EffectWhammyBar}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return il.GroupedOnBeat}shouldCreateGlyph(e,t){return t.hasWhammyBar}createNewGlyph(e,t){return new li("w/bar")}canExpand(e,t){return!0}}class lP extends oK{get notationElement(){return tp.EffectWideBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return il.GroupedOnBeatToEnd}shouldCreateGlyph(e,t){return t.vibrato===th.Wide}createNewGlyph(e,t){return new lm(th.Wide)}canExpand(e,t){return!0}}class lv extends lt{get notationElement(){return tp.EffectWideNoteVibrato}shouldCreateGlyphForNote(e){return e.vibrato===th.Wide||e.isTieDestination&&e.tieOrigin.vibrato===th.Wide}get sizingMode(){return il.GroupedOnBeatToEnd}createNewGlyph(e,t){return new lf(0,0,th.Wide,1.2)}}class lF{constructor(){this.x=0,this.width=0,this.masterBars=[]}}class lC extends oR{constructor(){super(...arguments),this._system=null}get name(){return"HorizontalScreen"}get supportsResize(){return!1}get firstBarX(){let e=this.pagePadding[0];return this._system&&(e+=this._system.accoladeWidth),e}doResize(){}doLayoutAndRender(){switch(this.renderer.settings.display.systemsLayoutMode){case t4.Automatic:this.systemsLayoutMode=ia.Automatic;break;case t4.UseModelLayout:this.systemsLayoutMode=ia.FromModelWithWidths}let e=this.renderer.score,t=this.renderer.settings.display.startBar;t--;let i=t=Math.min(e.masterBars.length-1,Math.max(0,t)),s=this.renderer.settings.display.barCount;s<=0&&(s=e.masterBars.length),s=t+s-1,s=Math.min(e.masterBars.length-1,Math.max(0,s)),this._system=this.createEmptyStaffSystem(),this._system.isLast=!0,this._system.x=this.pagePadding[0],this._system.y=this.pagePadding[1];let a=this.renderer.settings.display.barCountPerPartial,r=[],n=new lF,o=0;for(;i<=s;){let t=this.multiBarRestInfo,s=null!==t&&t.has(i)?t.get(i):null,l=this._system.addBars(this.renderer.tracks,i,s);if(0===n.masterBars.length&&l.isLinkedToPrevious&&r.length>0){let t=r[r.length-1];t.masterBars.push(e.masterBars[i]),t.width+=l.width,o+=l.width,n.x+=o}else n.masterBars.push(e.masterBars[i]),n.width+=l.width,n.masterBars.length>=a&&(0===r.length&&(n.width+=this._system.accoladeWidth+this.pagePadding[0]),o+=n.width,r.push(n),iM.debug(this.name,`Finished partial from bar ${n.masterBars[0].index} to ${n.masterBars[n.masterBars.length-1].index}`,null),(n=new lF).x=o);i++}n.masterBars.length>0&&(0===r.length&&(n.width+=this._system.accoladeWidth+this.pagePadding[0]),r.push(n),iM.debug(this.name,`Finished partial from bar ${n.masterBars[0].index} to ${n.masterBars[n.masterBars.length-1].index}`,null)),this.finalizeStaffSystem();let l=this.renderer.settings.display.scale;this.height=Math.floor(this._system.y+this._system.height)*l,this.width=(this._system.x+this._system.width+this.pagePadding[2])*l,i=0;let h=0;for(let e=0;e<r.length;e++){let t=r[e],s=new nr;s.x=h,s.y=0,s.totalWidth=this.width/l,s.totalHeight=this.height/l,s.width=t.width,s.height=this.height/l,s.firstMasterBarIndex=t.masterBars[0].index,s.lastMasterBarIndex=t.masterBars[t.masterBars.length-1].index,h+=t.width;let a=i,n=e;this._system.buildBoundingsLookup(0,0),this.registerPartial(s,e=>{let i=this._system.getBarX(t.masterBars[0].index)+this._system.accoladeWidth;0===n&&(i-=this._system.x+this._system.accoladeWidth),e.color=this.renderer.settings.display.resources.mainGlyphColor,e.textAlign=tS.Left,iM.debug(this.name,`Rendering partial from bar ${t.masterBars[0].index} to ${t.masterBars[t.masterBars.length-1].index}`,null),this._system.paintPartial(-i,this._system.y,e,a,t.masterBars.length)}),i+=t.masterBars.length}this.height=this.layoutAndRenderBottomScoreInfo(this.height),this.height=this.layoutAndRenderAnnotation(this.height),this.height+=this.pagePadding[3]}finalizeStaffSystem(){this._system.scaleToWidth(this._system.width),this._system.finalizeSystem()}}class lD extends oR{constructor(){super(...arguments),this._systems=[],this._allMasterBarRenderers=[],this._barsFromPreviousSystem=[]}get name(){return"PageView"}doLayoutAndRender(){switch(this.renderer.settings.display.systemsLayoutMode){case t4.Automatic:this.systemsLayoutMode=ia.Automatic;break;case t4.UseModelLayout:this.systemsLayoutMode=ia.FromModelWithScale}let e=this.pagePadding[1];this.width=this.renderer.width,this._allMasterBarRenderers=[],e=this.layoutAndRenderScoreInfo(e,-1),e=this.layoutAndRenderTunings(e,-1),e=this.layoutAndRenderChordDiagrams(e,-1),e=this.layoutAndRenderScore(e),e=this.layoutAndRenderBottomScoreInfo(e),e=this.layoutAndRenderAnnotation(e),this.height=(e+this.pagePadding[3])*this.renderer.settings.display.scale}get supportsResize(){return!0}get firstBarX(){let e=this.pagePadding[0];return this._systems.length>0&&(e+=this._systems[0].accoladeWidth),e}doResize(){let e=this.pagePadding[1];this.width=this.renderer.width;let t=this.height;e=this.layoutAndRenderScoreInfo(e,t),e=this.layoutAndRenderTunings(e,t),e=this.layoutAndRenderChordDiagrams(e,t),e=this.resizeAndRenderScore(e,t),e=this.layoutAndRenderBottomScoreInfo(e),e=this.layoutAndRenderAnnotation(e),this.height=(e+this.pagePadding[3])*this.renderer.settings.display.scale}layoutAndRenderTunings(e,t=-1){if(!this.tuningGlyph)return e;let i=this.renderer.settings.display.resources;this.tuningGlyph.x=this.pagePadding[0],this.tuningGlyph.width=this.scaledWidth,this.tuningGlyph.doLayout();let s=Math.round(this.tuningGlyph.height),a=new nr;return a.x=0,a.y=e,a.width=this.scaledWidth,a.height=s,a.totalWidth=this.scaledWidth,a.totalHeight=t<0?e+a.height:t,this.registerPartial(a,e=>{e.color=i.scoreInfoColor,e.textAlign=tS.Center,this.tuningGlyph.paint(0,0,e)}),e+s}layoutAndRenderChordDiagrams(e,t=-1){if(!this.chordDiagrams)return e;let i=this.renderer.settings.display.resources;this.chordDiagrams.width=this.scaledWidth,this.chordDiagrams.doLayout();let s=Math.round(this.chordDiagrams.height),a=new nr;return a.x=0,a.y=e,a.width=this.scaledWidth,a.height=s,a.totalWidth=this.scaledWidth,a.totalHeight=t<0?e+s:t,this.registerPartial(a,e=>{e.color=i.scoreInfoColor,e.textAlign=tS.Center,this.chordDiagrams.paint(0,0,e)}),e+s}layoutAndRenderScoreInfo(e,t=-1){iM.debug(this.name,"Layouting score info");let i=new nr;i.x=0,i.y=e;let s=0,a=this.renderer.settings.display.resources,r=[];for(let[e,t]of oR.HeaderElements.value)if(this.headerGlyphs.has(e)){let t=this.headerGlyphs.get(e);t.y=s,this.alignScoreInfoGlyph(t);let i=t.font.size;e===tD.Words&&this.headerGlyphs.has(tD.Music)&&this.headerGlyphs.get(tD.Music).textAlign!==t.textAlign&&(i=0),s+=i,r.push(t)}return r.length>0&&(s=Math.floor(s+17),i.width=this.scaledWidth,i.height=s,i.totalWidth=this.scaledWidth,i.totalHeight=t<0?e+i.height:t,this.registerPartial(i,e=>{for(let t of(e.color=a.scoreInfoColor,e.textAlign=tS.Center,r))t.paint(0,0,e)})),e+s}resizeAndRenderScore(e,t){if(this.renderer.settings.display.barsPerRow>0||this.systemsLayoutMode===ia.FromModelWithScale)for(let i=0;i<this._systems.length;i++){let s=this._systems[i];this.fitSystem(s),e+=this.paintSystem(s,t)}else{this._systems=[];let i=0,s=this.maxWidth,a=this.createEmptyStaffSystem();for(a.index=this._systems.length,a.x=this.pagePadding[0],a.y=e;i<this._allMasterBarRenderers.length;){let r=this._allMasterBarRenderers[i];if(a.width+r.width<=s||0===a.masterBarsRenderers.length)a.addMasterBarRenderers(this.renderer.tracks,r),i++;else{for(;r&&!r.canWrap&&a.masterBarsRenderers.length>1;)r=a.revertLastBar(),i--;a.isFull=!0,a.isLast=this.lastBarIndex===a.lastBarIndex,this._systems.push(a),this.fitSystem(a),e+=this.paintSystem(a,t),(a=this.createEmptyStaffSystem()).index=this._systems.length,a.x=this.pagePadding[0],a.y=e}}a.isLast=this.lastBarIndex===a.lastBarIndex,this.fitSystem(a),e+=this.paintSystem(a,t)}return e}layoutAndRenderScore(e){let t=this.firstBarIndex,i=this.lastBarIndex;for(this._systems=[];t<=i;){let s=this.createStaffSystem(t,i);this._systems.push(s),s.x=this.pagePadding[0],s.y=e,t=s.lastBarIndex+1,this.fitSystem(s),iM.debug(this.name,`Rendering partial from bar ${s.firstBarIndex} to ${s.lastBarIndex}`,null),e+=this.paintSystem(s,e)}return e}paintSystem(e,t){let i=Math.floor(e.height),s=new nr;return s.x=0,s.y=e.y,s.totalWidth=this.scaledWidth,s.totalHeight=t,s.width=this.scaledWidth,s.height=i,s.firstMasterBarIndex=e.firstBarIndex,s.lastMasterBarIndex=e.lastBarIndex,e.buildBoundingsLookup(0,0),this.registerPartial(s,t=>{this.renderer.canvas.color=this.renderer.settings.display.resources.mainGlyphColor,this.renderer.canvas.textAlign=tS.Left,e.paint(0,-(s.y/this.renderer.settings.display.scale),t)}),i}fitSystem(e){e.isFull||e.width>this.maxWidth||this.renderer.settings.display.justifyLastSystem?e.scaleToWidth(this.maxWidth):e.scaleToWidth(e.width),e.finalizeSystem()}getBarsPerSystem(e){let t=this.renderer.settings.display.barsPerRow;if(this.systemsLayoutMode===ia.FromModelWithScale){let i,s;this.renderer.tracks.length>1?(i=this.renderer.score.defaultSystemsLayout,s=this.renderer.score.systemsLayout):(i=this.renderer.tracks[0].defaultSystemsLayout,s=this.renderer.tracks[0].systemsLayout),t=e<s.length?s[e]:i}return t}createStaffSystem(e,t){let i=this.createEmptyStaffSystem();i.index=this._systems.length;let s=this.getBarsPerSystem(i.index),a=this.maxWidth,r=t+1,n=e;for(;n<r;){if(this._barsFromPreviousSystem.length>0)for(let e of this._barsFromPreviousSystem)i.addMasterBarRenderers(this.renderer.tracks,e),n=e.lastMasterBarIndex;else{let e=this.multiBarRestInfo,t=null!==e&&e.has(n)?e.get(n):null,s=i.addBars(this.renderer.tracks,n,t);this._allMasterBarRenderers.push(s),n=s.lastMasterBarIndex}this._barsFromPreviousSystem=[];let e=!1;if(-1===s&&i.width>=a&&0!==i.masterBarsRenderers.length?e=!0:i.masterBarsRenderers.length===s+1&&(e=!0),e){let e=i.revertLastBar();if(e)for(this._barsFromPreviousSystem.push(e);e&&!e.canWrap&&i.masterBarsRenderers.length>1;)(e=i.revertLastBar())&&this._barsFromPreviousSystem.push(e);return i.isFull=!0,i.isLast=!1,this._barsFromPreviousSystem.reverse(),i}let t=!1,r=!0;for(let e of this.renderer.tracks)e.lineBreaks&&e.lineBreaks.has(n+1)?t=!0:r=!1;if(t&&r)return i.isFull=!0,i.isLast=!1,i;i.x=0,n++}return i.isLast=t===i.lastBarIndex,i}get maxWidth(){return this.scaledWidth-this.pagePadding[0]-this.pagePadding[2]}}class lE extends nM{constructor(e,t,i,s){super(e,t,s,lE.getMusicSymbol(i))}static getMusicSymbol(e){switch(e){case tJ.Natural:return tb.AccidentalNatural;case tJ.Sharp:return tb.AccidentalSharp;case tJ.Flat:return tb.AccidentalFlat;case tJ.NaturalQuarterNoteUp:return tb.AccidentalQuarterToneNaturalArrowUp;case tJ.SharpQuarterNoteUp:return tb.AccidentalQuarterToneSharpArrowUp;case tJ.FlatQuarterNoteUp:return tb.AccidentalQuarterToneFlatArrowUp;case tJ.DoubleSharp:return tb.AccidentalDoubleSharp;case tJ.DoubleFlat:return tb.AccidentalDoubleFlat}return tb.None}}class lM extends nM{constructor(e,t,i,s){super(e,t,1,lM.getSymbol(i)),this._clef=i,this._clefOttava=s}static getSymbol(e){switch(e){case eK.Neutral:return tb.UnpitchedPercussionClef1;case eK.C3:case eK.C4:return tb.CClef;case eK.F4:return tb.FClef;case eK.G2:return tb.GClef;default:return tb.None}}paint(e,t,i){let s=od.bar(i,e5.StandardNotationClef,this.renderer.bar);try{let s;super.paint(e,t,i);let a=!1;switch(this._clefOttava){case eQ._15ma:s=new nM(-4,0,.5,tb.Quindicesima),a=!0;break;case eQ._8va:s=new nM(-2,0,.5,tb.Ottava),a=!0;break;case eQ._8vb:s=new nM(-6,0,.5,tb.Ottava);break;case eQ._15mb:s=new nM(-8,0,.5,tb.Quindicesima);break;default:return}let r=0,n=0;switch(this._clef){case eK.Neutral:r=a?-12:15,n=0;break;case eK.C3:case eK.C4:r=a?-19:27,n=0;break;case eK.F4:r=a?-9:27,n=-4;break;case eK.G2:r=a?-37:30,n=0;break;default:return}s.renderer=this.renderer,s.doLayout();let o=this.width/2;s.paint(e+this.x+o+n,t+this.y+r,i)}finally{s?.[Symbol.dispose]?.()}}}class lL extends nD{constructor(e,t,i){super(e,t),this._note=i}static getSymbol(e,t){switch(e){case ts.None:return tb.None;case ts.Normal:return t?tb.ArticAccentAbove:tb.ArticAccentBelow;case ts.Heavy:return t?tb.ArticMarcatoAbove:tb.ArticMarcatoBelow;case ts.Tenuto:return t?tb.ArticTenutoAbove:tb.ArticTenutoBelow;default:return tb.None}}doLayout(){this.width=nE.Widths.get(tb.ArticAccentAbove),this.height=nE.Heights.get(tb.ArticAccentAbove)}paint(e,t,i){let s=this.renderer.getBeatDirection(this._note.beat),a=lL.getSymbol(this._note.accentuated,s===tR.Down),r=s===tR.Up?t+this.y:t+this.y+this.height-2;i.fillMusicFontSymbol(e+this.x-2,r,1,a,!1)}}class lI extends nC{constructor(e,t,i){super(e,t),this._size=0,this._size=i}doLayout(){this.width=this._size+3}paint(e,t,i){let s=i.color;this.colorOverride&&(i.color=this.colorOverride),i.fillCircle(e+this.x,t+this.y,this._size),i.color=s}}class lA extends nM{constructor(e,t,i){super(e,t,i?nL.GraceScale:1,tb.NoteheadXOrnate)}}class lR extends nM{constructor(e,t,i,s){super(e,t,s?nL.GraceScale:1,lR.getSymbol(i))}static getSymbol(e){switch(e){case tt.QuadrupleWhole:case tt.DoubleWhole:case tt.Whole:case tt.Half:return tb.NoteheadDiamondWhiteWide;default:return tb.NoteheadDiamondBlackWide}}}class lO extends nC{constructor(e,t,i){super(0,0),this.yOffset=0,this.startNoteRenderer=null,this.endNoteRenderer=null,this.tieDirection=tR.Up,this._startX=0,this._startY=0,this._endX=0,this._endY=0,this._tieHeight=0,this._shouldDraw=!1,this.startBeat=e,this.endBeat=t,this.forEnd=i}doLayout(){if(this.width=0,!this.endBeat){this._shouldDraw=!1;return}let e=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar);this.startNoteRenderer=e;let t=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.endBeat.voice.bar);if(this.endNoteRenderer=t,this._startX=0,this._endX=0,this._startY=0,this._endY=0,this.height=0,this._shouldDraw=!1,this.tieDirection=e?this.getBeamDirection(this.startBeat,e):this.getBeamDirection(this.endBeat,t),!this.forEnd&&e?(e!==t?(this._startX=e.x+this.getStartX(),this._startY=e.y+this.getStartY()+this.yOffset,t&&e.staff===t.staff?(this._endX=t.x+this.getEndX(),this._endY=t.y+this.getEndY()+this.yOffset):(this._endX=e.x+e.width,this._endY=this._startY)):(this._startX=e.x+this.getStartX(),this._endX=t.x+this.getEndX(),this._startY=e.y+this.getStartY()+this.yOffset,this._endY=t.y+this.getEndY()+this.yOffset),this._shouldDraw=!0):e&&e.staff===t.staff||(this._startX=t.x,this._endX=t.x+this.getEndX(),this._startY=t.y+this.getEndY()+this.yOffset,this._endY=this._startY,this._shouldDraw=!0),this._shouldDraw)if(this.y=Math.min(this._startY,this._endY),this.shouldDrawBendSlur())this._tieHeight=0;else{this._tieHeight=this.getTieHeight(this._startX,this._startY,this._endX,this._endY);let e=lO.calculateActualTieHeight(1,this._startX,this._startY,this._endX,this._endY,this.tieDirection===tR.Down,this._tieHeight,4);if(this.height=e.h,this.tieDirection===tR.Up){let t=this.y-e.y;t>0&&(this.y-=t)}}}paint(e,t,i){this._shouldDraw&&(this.shouldDrawBendSlur()?lO.drawBendSlur(i,e+this._startX,t+this._startY,e+this._endX,t+this._endY,this.tieDirection===tR.Down,1):lO.paintTie(i,1,e+this._startX,t+this._startY,e+this._endX,t+this._endY,this.tieDirection===tR.Down,this._tieHeight,4))}shouldDrawBendSlur(){return!1}getTieHeight(e,t,i,s){return 22}getBeamDirection(e,t){return tR.Down}getStartY(){return 0}getEndY(){return 0}getStartX(){return 0}getEndX(){return 0}static calculateActualTieHeight(e,t,i,s,a,r,n,o){let l=lO.computeBezierControlPoints(e,t,i,s,a,r,n,o);t=l[0],i=l[1];let h=l[2],d=l[3];s=l[6],a=l[7];let c=(t-h)/(t-2*h+s),u=lO.calculateExtrema(t,i,h,d,s,a,c),p=u.length>0?Math.min(t,s,u[0]):Math.min(t,s),m=u.length>0?Math.max(t,s,u[0]):Math.max(t,s),g=(i-d)/(i-2*d+a),f=lO.calculateExtrema(t,i,h,d,s,a,g),y=f.length>0?Math.min(i,a,f[1]):Math.min(i,a),b=f.length>0?Math.max(i,a,f[1]):Math.max(i,a),S=new sy;return S.x=p,S.y=y,S.w=m-p,S.h=b-y,S}static calculateExtrema(e,t,i,s,a,r,n){if(n<=0||1<=n)return[];let o=e+(i-e)*n,l=t+(s-t)*n;return[o+(i+(a-i)*n-o)*n,l+(s+(r-s)*n-l)*n]}static computeBezierControlPoints(e,t,i,s,a,r,n,o){if(t===s&&i===a)return[];if(s<t){let e=t;t=s,s=e,e=i,i=a,a=e}n*=e,o*=e;let l=a-i,h=s-t,d=Math.sqrt(l*l+h*h);r?l*=-1:h*=-1,l/=d,h/=d;let c=(s+t)/2,u=(a+i)/2;return[t,i,c+n*l,u+n*h,c+(n-o)*l,u+(n-o)*h,s,a]}static paintTie(e,t,i,s,a,r,n=!1,o=22,l=4){let h=lO.computeBezierControlPoints(t,i,s,a,r,n,o,l);e.beginPath(),e.moveTo(h[0],h[1]),e.quadraticCurveTo(h[2],h[3],h[6],h[7]),e.quadraticCurveTo(h[4],h[5],h[0],h[1]),e.closePath(),e.fill()}static drawBendSlur(e,t,i,s,a,r,n,o){let l=a-i,h=s-t,d=Math.sqrt(l*l+h*h);r?l*=-1:h*=-1,l/=d,h/=d;let c=(s+t)/2,u=(a+i)/2,p=lO.BendSlurHeight*n;s-t<20&&(p/=2);let m=c+p*l,g=u+p*h;if(e.beginPath(),e.moveTo(t,i),e.lineTo(m,g),e.lineTo(s,a),e.stroke(),o){let t=e.measureText(o).width,i=r?0:-e.font.size;e.fillText(o,m-t/2,g+i)}}}lO.BendSlurHeight=11;class lH extends nC{constructor(e){super(0,0),this._isOpen=e}doLayout(){super.doLayout(),this.width=lH.Size}paint(e,t,i){let s=i.color;this.colorOverride&&(i.color=this.colorOverride),this._isOpen?lO.paintTie(i,1,e+this.x+this.width,t+this.y+this.height,e+this.x+this.width,t+this.y,!1,6,3):lO.paintTie(i,1,e+this.x,t+this.y,e+this.x,t+this.y+this.height,!1,6,3),i.color=s}}lH.Size=6;class lV{constructor(e,t,i){this.line=0,this.line=e,this.isGhost=t,this.color=i}}class lW extends nC{constructor(e){super(0,0),this._infos=[],this._glyphs=[],this.isEmpty=!0,this._isOpen=e}addParenthesis(e){let t=this.renderer,i=t.getNoteLine(e),s=e.isGhost||this.isTiedBend(e)&&t.settings.notation.isNotationElementVisible(tp.ParenthesisOnTiedBends),a=od.noteColor(t.resources,tk.Effects,e);this.add(new lV(i,s,a))}addParenthesisOnLine(e,t){let i=new lV(e,t,void 0);this.add(i)}add(e){this._infos.push(e),e.isGhost&&(this.isEmpty=!1)}isTiedBend(e){return!!e.isTieDestination&&(!!e.tieOrigin.hasBend||this.isTiedBend(e.tieOrigin))}doLayout(){let e=this.renderer;this._infos.sort((e,t)=>e.line-t.line);let t=null,i=e.getScoreHeight(1);for(let s=0,a=this._infos.length;s<a;s++){let a;if(this._infos[s].isGhost)if(t){let a=e.getScoreY(this._infos[s].line)+i;t.height=a-t.y}else(a=new lH(this._isOpen)).colorOverride=this._infos[s].color,a.renderer=this.renderer,a.y=e.getScoreY(this._infos[s].line)-i,a.height=2*i,a.doLayout(),this._glyphs.push(a),t=a;else t=null}this.width=this._glyphs.length>0?this._glyphs[0].width:0}paint(e,t,i){for(let s of(super.paint(e,t,i),this._glyphs))s.paint(e+this.x,t+this.y,i)}}class lG{constructor(e,t){this.steps=0,this.glyph=e,this.steps=t}}class lz extends nC{constructor(){super(0,0),this._infos=[],this._noteHeadPadding=0,this.minNote=null,this.maxNote=null,this.spacingChanged=new rl,this.upLineX=0,this.downLineX=0,this.displacedX=0,this.noteStartX=0}add(e,t){let i=new lG(e,t);this._infos.push(i),(!this.minNote||this.minNote.steps>i.steps)&&(this.minNote=i),(!this.maxNote||this.maxNote.steps<i.steps)&&(this.maxNote=i)}doLayout(){this._infos.sort((e,t)=>t.steps-e.steps);let e=0,t=!1,i=0,s=!1,a=this.direction,r=0;for(let n=0,o=this._infos.length;n<o;n++){let o=this._infos[n].glyph;o.renderer=this.renderer,o.doLayout();let l=!1;0===n?e=o.width:1>=Math.abs(i-this._infos[n].steps)?t?t=!1:(l=!0,o.x=e,s=!0,t=!0):t=!1,a===tR.Down?o.x=l?0:e:o.x=l?e:0,o.x+=this.noteStartX,i=this._infos[n].steps,r=Math.max(r,o.x+o.width),o instanceof nL&&o.centerOnStem&&(o.x=e)}s?(this._noteHeadPadding=0,this.upLineX=e,this.downLineX=e):(this._noteHeadPadding=a===tR.Down?-e:0,r+=this._noteHeadPadding,this.upLineX=r,this.downLineX=0),this.displacedX=e,this.width=r}paint(e,t,i){e+=this.x,t+=this.y,this.paintLedgerLines(e,t,i);let s=this._infos,a=e+this._noteHeadPadding;for(let e of s)e.glyph.renderer=this.renderer,e.glyph.paint(a,t,i)}paintLedgerLines(e,t,i){if(!this.minNote)return;let s=this.renderer,a=od.bar(i,e5.StandardNotationStaffLine,s.bar,!0);try{let a=this.width-this.noteStartX+6,r=s.getLineHeight(1),n=s.getLineY(-1),o=s.getLineY(s.drawnLineCount),l=s.getLineY(this.minNote.steps/2),h=s.getLineY(this.maxNote.steps/2),d=n;for(;d>=l;)i.fillRect(e-3+this.noteStartX,t+d|0,a,oz.StaffLineThickness),d-=r;for(d=o;d<=h;)i.fillRect(e-3+this.noteStartX,t+d|0,a,oz.StaffLineThickness),d+=r}finally{a?.[Symbol.dispose]?.()}}}class lU extends nM{constructor(e,t,i){super(e,t,1,lU.getSymbol(i))}static getSymbol(e){switch(e){case tt.ThirtySecond:return tb.Tremolo3;case tt.Sixteenth:return tb.Tremolo2;case tt.Eighth:return tb.Tremolo1;default:return tb.None}}}class lX extends nC{constructor(){super(0,0)}doLayout(){this.width=26}paint(e,t,i){let s=this.renderer,a=s.getLineHeight(s.heightLineCount-1),r=s.getLineY(0)+s.getLineHeight(s.drawnLineCount-1)/2-a/2,n=i.lineWidth;i.lineWidth=2,i.moveTo(e+this.x,t+r),i.lineTo(e+this.x+this.width,t+r+a),i.moveTo(e+this.x,t+r+a),i.lineTo(e+this.x+this.width,t+r),i.stroke(),i.lineWidth=n}}class lJ extends lz{constructor(){super(...arguments),this._noteGlyphLookup=new Map,this._notes=[],this._deadSlapped=null,this._tremoloPicking=null,this.aboveBeatEffects=new Map,this.belowBeatEffects=new Map}get direction(){return this.beamingHelper.direction}getNoteX(e,t){if(this._noteGlyphLookup.has(e.id)){let i=this._noteGlyphLookup.get(e.id),s=this.x+i.x+this._noteHeadPadding;switch(t){case io.Left:break;case io.Center:s+=i.width/2;break;case io.Right:s+=i.width}return s}return 0}getNoteY(e,t){if(this._noteGlyphLookup.has(e.id)){let i=this._noteGlyphLookup.get(e.id),s=this.y+i.y;switch(t){case ir.TopWithStem:s-=this.renderer.getStemSize(this.beamingHelper);break;case ir.Top:s-=i.height/2;break;case ir.Center:break;case ir.Bottom:s+=i.height/2;break;case ir.BottomWithStem:s+=this.renderer.getStemSize(this.beamingHelper)}return s}return 0}addNoteGlyph(e,t,i){super.add(e,i),this._noteGlyphLookup.set(t.id,e),this._notes.push(t)}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,e+this.x+this.upLineX,e+this.x+this.downLineX)}doLayout(){super.doLayout();let e=this.renderer;this.beat.deadSlapped&&(this._deadSlapped=new lX,this._deadSlapped.renderer=this.renderer,this._deadSlapped.doLayout(),this.width=this._deadSlapped.width);let t=this.direction,i=0,s=0,a=1,r=-1,n=!1,o=!1;this.beat.deadSlapped?(s=e.getScoreY(0),i=e.getScoreY(e.heightLineCount)):this.direction===tR.Up?(n=!1,o=!0,s=e.getScoreY(this.maxNote.steps+2),i=e.getScoreY(this.minNote.steps)-e.getStemSize(this.beamingHelper,!0)):(n=!0,o=!1,s=e.getScoreY(this.minNote.steps-1),a*=-1,r*=-1,i=e.getScoreY(this.maxNote.steps)+e.getStemSize(this.beamingHelper,!0));let l=null,h=null;for(let e of this.aboveBeatEffects.values())e.renderer=this.renderer,e.doLayout(),o&&(i+=r*e.height),e.y=i,(null===l||l>i)&&(l=i),(null===h||h<i)&&(h=i),o||(i+=r*e.height);for(let e of this.belowBeatEffects.values())e.renderer=this.renderer,e.doLayout(),n&&(s+=a*e.height),e.y=s,(null===l||l>s)&&(l=s),(null===h||h<s)&&(h=s),n||(s+=a*e.height);if(null!==l&&e.registerBeatEffectOverflows(l,h??0),this.beat.isTremolo&&!this.beat.deadSlapped){let e=0,i=t===tR.Up?this.minNote:this.maxNote,s=t===tR.Up?this.upLineX:this.downLineX,a=this.beat.tremoloSpeed;switch(a){case tt.ThirtySecond:e=t===tR.Up?-15:15;break;case tt.Sixteenth:e=t===tR.Up?-12:15;break;case tt.Eighth:e=t===tR.Up?-10:10;break;default:e=t===tR.Up?-10:15}this.beat.duration<tt.Half&&(s=this.width/2),this._tremoloPicking=new lU(s,i.glyph.y+e,a),this._tremoloPicking.renderer=this.renderer,this._tremoloPicking.doLayout()}}buildBoundingsLookup(e,t,i){for(let s of this._notes)if(this._noteGlyphLookup.has(s.id)){let a=this._noteGlyphLookup.get(s.id),r=new nh;r.note=s,r.noteHeadBounds=new sy,r.noteHeadBounds.x=t+this.x+this._noteHeadPadding+a.x,r.noteHeadBounds.y=i+this.y+a.y-a.height/2,r.noteHeadBounds.w=a.width,r.noteHeadBounds.h=a.height,e.addNote(r)}}paint(e,t,i){this.paintEffects(e,t,i),super.paint(e,t,i)}paintEffects(e,t,i){let s=od.beat(i,tC.StandardNotationEffects,this.beat);try{for(let s of this.aboveBeatEffects.values())s.paint(e+this.x+2,t+this.y,i);for(let s of this.belowBeatEffects.values())s.paint(e+this.x+2,t+this.y,i);this._tremoloPicking&&this._tremoloPicking.paint(e,t,i),this._deadSlapped&&this._deadSlapped.paint(e,t,i)}finally{s?.[Symbol.dispose]?.()}}}class lY extends nM{constructor(e,t,i){super(e,t,1,lY.getSymbol(i))}static getSymbol(e){switch(e){case tt.QuadrupleWhole:return tb.RestLonga;case tt.DoubleWhole:return tb.RestDoubleWhole;case tt.Whole:return tb.RestWhole;case tt.Half:return tb.RestHalf;case tt.Quarter:return tb.RestQuarter;case tt.Eighth:return tb.RestEighth;case tt.Sixteenth:return tb.RestSixteenth;case tt.ThirtySecond:return tb.RestThirtySecond;case tt.SixtyFourth:return tb.RestSixtyFourth;case tt.OneHundredTwentyEighth:return tb.RestOneHundredTwentyEighth;case tt.TwoHundredFiftySixth:return tb.RestTwoHundredFiftySixth;default:return tb.None}}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}paint(e,t,i){this.internalPaint(e,t,i,tC.StandardNotationRests)}internalPaint(e,t,i,s){let a=od.beat(i,s,this.beat);try{super.paint(e,t,i)}finally{a?.[Symbol.dispose]?.()}}}class lq{constructor(){this.x=0,this.y=-3e3,this.width=0}}class l$ extends ol{constructor(){super(0,0)}doLayout(){if(!this.glyphs||0===this.glyphs.length){this.width=0;return}this.glyphs.sort((e,t)=>e.y<t.y?-1:+(e.y>t.y));let e=[];e.push(new lq);for(let t=0,i=this.glyphs.length;t<i;t++){let i=this.glyphs[t];i.renderer=this.renderer,i.doLayout();let s=0;for(;e[s].y>i.y;)++s===e.length&&e.push(new lq);i.x=s,e[s].y=i.y+21,e[s].width<i.width&&(e[s].width=i.width)}for(let t of(this.width=0,e))this.width+=t.width,t.x=this.width;for(let t=0,i=this.glyphs.length;t<i;t++){let i=this.glyphs[t],s=e[i.x];i.x=this.width-s.x}}}class lj extends lz{get direction(){return tR.Up}constructor(e,t=!1){super(),this._showParenthesis=!1,this._noteValueLookup=new Map,this._accidentals=new l$,this._preNoteParenthesis=null,this._postNoteParenthesis=null,this.isEmpty=!0,this.noteHeadOffset=0,this._beat=e,this._showParenthesis=t,t&&(this._preNoteParenthesis=new lW(!0),this._postNoteParenthesis=new lW(!1))}containsNoteValue(e){return this._noteValueLookup.has(e)}getNoteValueY(e){return this._noteValueLookup.has(e)?this.y+this._noteValueLookup.get(e).y:0}addGlyph(e,t,i){let s=this.renderer,a=new nL(0,0,tt.Quarter,!0),r=s.accidentalHelper.applyAccidentalForValue(this._beat,e,t,!0),n=s.accidentalHelper.getNoteLineForValue(e,!1);if(a.y=s.getScoreY(n),this._showParenthesis&&(this._preNoteParenthesis.renderer=this.renderer,this._postNoteParenthesis.renderer=this.renderer,this._preNoteParenthesis.addParenthesisOnLine(n,!0),this._postNoteParenthesis.addParenthesisOnLine(n,!0)),r!==tJ.None){let e=new lE(0,a.y,r,nL.GraceScale);e.renderer=this.renderer,this._accidentals.renderer=this.renderer,this._accidentals.addGlyph(e)}this._noteValueLookup.set(e,a),this.add(a,n),this.isEmpty=!1}doLayout(){let e=0;this._showParenthesis&&(this._preNoteParenthesis.x=e,this._preNoteParenthesis.renderer=this.renderer,this._preNoteParenthesis.doLayout(),e+=this._preNoteParenthesis.width+lj.ElementPadding),this._accidentals.isEmpty||(e+=this._accidentals.width+lj.ElementPadding,this._accidentals.x=e,this._accidentals.renderer=this.renderer,this._accidentals.doLayout(),e+=this._accidentals.width+lj.ElementPadding),this.noteStartX=e,super.doLayout(),this.noteHeadOffset=this.noteStartX+(this.width-this.noteStartX)/2,this._showParenthesis&&(this._postNoteParenthesis.x=this.width+lj.ElementPadding,this._postNoteParenthesis.renderer=this.renderer,this._postNoteParenthesis.doLayout(),this.width+=this._postNoteParenthesis.width+lj.ElementPadding)}paint(e,t,i){this._accidentals.isEmpty||this._accidentals.paint(e+this.x,t+this.y,i),this._showParenthesis&&(this._preNoteParenthesis.paint(e+this.x,t+this.y,i),this._postNoteParenthesis.paint(e+this.x,t+this.y,i)),super.paint(e,t,i)}}lj.ElementPadding=2;class lK extends nC{constructor(){super(...arguments),this.BendNoteHeads=[]}drawBendSlur(e,t,i,s,a,r,n,o){lO.drawBendSlur(e,t,i,s,a,r,n,o)}doLayout(){for(let e of(super.doLayout(),this.width=0,this.BendNoteHeads))e.doLayout(),this.width+=e.width+10}getTieDirection(e,t){return t.getBeatDirection(e)===tR.Up?tR.Down:tR.Up}}lK.EndPadding=8;class lQ extends iF{constructor(e=0,t=0){super(e,t),this.lineValue=0,this.lineValue=t}}class lZ extends nC{constructor(){super(0,0),this._notes=[],this._renderPoints=new Map,this._preBendMinValue=-1,this._bendMiddleMinValue=-1,this._bendEndMinValue=-1,this._bendEndContinuedMinValue=-1,this._releaseMinValue=-1,this._releaseContinuedMinValue=-1,this._maxBendValue=-1}addBends(e){this._notes.push(e);let t=this.createRenderingPoints(e);this._renderPoints.set(e.id,t),(-1===this._maxBendValue||this._maxBendValue<e.maxBendPoint.value)&&(this._maxBendValue=e.maxBendPoint.value);let i=0;switch(e.bendType){case e7.Bend:i=t[1].value,e.isTieOrigin?(-1===this._bendEndContinuedMinValue||i<this._bendEndContinuedMinValue)&&(this._bendEndContinuedMinValue=i):(-1===this._bendEndMinValue||i<this._bendEndMinValue)&&(this._bendEndMinValue=i);break;case e7.Release:i=t[1].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||i<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=i):i>0&&(-1===this._releaseMinValue||i<this._releaseMinValue)&&(this._releaseMinValue=i);break;case e7.BendRelease:i=t[1].value,(-1===this._bendMiddleMinValue||i<this._bendMiddleMinValue)&&(this._bendMiddleMinValue=i),i=t[2].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||i<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=i):i>0&&(-1===this._releaseMinValue||i<this._releaseMinValue)&&(this._releaseMinValue=i);break;case e7.Prebend:i=t[0].value,(-1===this._preBendMinValue||i<this._preBendMinValue)&&(this._preBendMinValue=i);break;case e7.PrebendBend:i=t[0].value,(-1===this._preBendMinValue||i<this._preBendMinValue)&&(this._preBendMinValue=i),i=t[1].value,e.isTieOrigin?(-1===this._bendEndContinuedMinValue||i<this._bendEndContinuedMinValue)&&(this._bendEndContinuedMinValue=i):(-1===this._bendEndMinValue||i<this._bendEndMinValue)&&(this._bendEndMinValue=i);break;case e7.PrebendRelease:i=t[0].value,(-1===this._preBendMinValue||i<this._preBendMinValue)&&(this._preBendMinValue=i),i=t[1].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||i<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=i):i>0&&(-1===this._releaseMinValue||i<this._releaseMinValue)&&(this._releaseMinValue=i)}}doLayout(){super.doLayout();let e=this._maxBendValue*lZ.BendValueHeight;this.renderer.registerOverflowTop(e);let t=0;for(let e of this._notes){let i=this._renderPoints.get(e.id);switch(e.bendType){case e7.Bend:i[1].lineValue=e.isTieOrigin?this._bendEndContinuedMinValue:this._bendEndMinValue;break;case e7.Release:(t=e.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue)>=0&&(i[1].lineValue=t);break;case e7.BendRelease:i[1].lineValue=this._bendMiddleMinValue,(t=e.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue)>=0&&(i[2].lineValue=t);break;case e7.Prebend:i[0].lineValue=this._preBendMinValue;break;case e7.PrebendBend:i[0].lineValue=this._preBendMinValue,i[1].lineValue=e.isTieOrigin?this._bendEndContinuedMinValue:this._bendEndMinValue;break;case e7.PrebendRelease:i[0].lineValue=this._preBendMinValue,(t=e.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue)>=0&&(i[1].lineValue=t)}}this.width=0,this._notes.sort((e,t)=>e.isStringed?e.string-t.string:e.realValue-t.realValue)}createRenderingPoints(e){let t=[];switch(e.bendType){case e7.Custom:for(let i of e.bendPoints)t.push(new lQ(i.offset,i.value));break;case e7.BendRelease:t.push(new lQ(0,e.bendPoints[0].value)),t.push(new lQ(iF.MaxPosition/2|0,e.bendPoints[1].value)),t.push(new lQ(iF.MaxPosition,e.bendPoints[3].value));break;case e7.Bend:case e7.Hold:case e7.Prebend:case e7.PrebendBend:case e7.PrebendRelease:case e7.Release:t.push(new lQ(0,e.bendPoints[0].value)),t.push(new lQ(iF.MaxPosition,e.bendPoints[1].value))}return t}paint(e,t,i){let s=i.color;for(let a of(this._notes.length>1&&(i.color=this.renderer.resources.secondaryGlyphColor),this._notes)){let r=this._renderPoints.get(a.id),n=this.renderer,o=a,l=!1,h=null,d=!1,c=a.bendStyle===e8.Gradual?"grad.":"",u=null;for(;o.isTieOrigin;){let e=o.tieDestination;if(!(h=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,e.beat.voice.bar))||n.staff!==h.staff)break;if(l=!0,(o=e).hasBend||!this.renderer.settings.notation.extendBendArrowsOnTiedNotes||o.vibrato!==th.None){d=!0;break}}u=o.beat,h=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,u.voice.bar),u.isLastOfVoice&&!o.hasBend&&this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&(u=null);let p=0,m=0,g=t+n.y;p=e+n.x,r[0].value>0||a.isContinuedBend?p+=n.getBeatX(a.beat,is.MiddleNotes):p+=n.getNoteX(a,io.Right),m=u&&(!u.isLastOfVoice||d)?d||!u.nextBeat?e+h.x+h.getBeatX(u,is.MiddleNotes):a.bendType===e7.Hold?e+h.x+h.getBeatX(u.nextBeat,is.OnNotes):e+h.x+h.getBeatX(u.nextBeat,is.PreNotes):e+h.x+h.postBeatGlyphsStart,l||(m-=lZ.ArrowSize);let f=(m-p)/iF.MaxPosition;i.beginPath();for(let e=0,t=r.length-1;e<t;e++){let t=r[e],s=r[e+1];0!==e||0===t.value||a.isTieDestination||this.paintBend(a,new lQ(0,0),t,p,g,f,c,i),a.bendType!==e7.Prebend?(0===e&&(p+=2),this.paintBend(a,t,s,p,g,f,c,i)):a.isTieOrigin&&a.tieDestination.hasBend&&((s=new lQ(iF.MaxPosition,t.value)).lineValue=t.lineValue,this.paintBend(a,t,s,p,g,f,c,i))}if(o.vibrato!==th.None){let s=new lf(m-e+lZ.ArrowSize-h.x,g-t-lZ.BendValueHeight*r[r.length-1].lineValue,o.vibrato,1.2);s.beat=o.beat,s.renderer=h,s.doLayout(),s.paint(e+h.x,t,i)}i.color=s}}paintBend(e,t,i,s,a,r,n,o){let l=this.renderer,h=this.renderer.resources,d=l.lineOffset/2,c=s+r*t.offset,u=lZ.BendValueHeight,p=a-u*t.lineValue;0===t.value?i.offset===t.offset?p+=l.getNoteY(e.beat.maxStringNote,ir.Top):p+=l.getNoteY(e,ir.Center):p+=d;let m=s+r*i.offset,g=a-u*i.lineValue;0===i.lineValue?g+=l.getNoteY(e,ir.Center):g+=d;let f=0,y=lZ.ArrowSize;if(i.value>t.value?(g+y>p&&(g=p-y),o.beginPath(),o.moveTo(m,g),o.lineTo(m-.5*y,g+y),o.lineTo(m+.5*y,g+y),o.closePath(),o.fill(),f=y):i.value!==t.value&&(g<p&&(g=p+y),o.beginPath(),o.moveTo(m,g),o.lineTo(m-.5*y,g-y),o.lineTo(m+.5*y,g-y),o.closePath(),o.fill(),f=-y),o.beginPath(),t.value===i.value){if(t.lineValue>0){let e=m,t=lZ.DashSize,i=c+t;if((e-c)/(2*t)<1)o.moveTo(e,p),o.lineTo(c,p);else for(;e>i;)o.moveTo(e,p),o.lineTo(e-t,p),e-=2*t;o.stroke()}}else m>c?(o.moveTo(c,p),o.bezierCurveTo((c+m)/2,p,m,p,m,g+f)):(o.moveTo(c,p),o.lineTo(m,g)),o.stroke();if(n&&t.offset<i.offset){o.font=h.graceFont;let e=o.measureText(n).width,t=0,i=0;if(p>g){let s=Math.abs(p-g);t=s>1.3*o.font.size?p-s/2:p,i=(c+m-e)/2}else t=p,i=m-e;o.fillText(n,i,t)}if(0!==i.value&&t.value!==i.value){let e=i.value,s=i.value>t.value,r="";if(4===(e=Math.abs(e)))r="full",e-=4;else if(e>=4||e<=-4){let t=e/4|0;r+=t,e-=4*t}if(e>0&&(r+=lZ.getFractionSign(e)),""!==r){let e=g=a-u*i.value;s||(e=p+Math.abs(g-p)/3),o.font=h.tablatureFont;let t=o.measureText(r).width,n=e-.5*h.tablatureFont.size-2,l=m-t/2;o.fillText(r,l,n)}}}static getFractionSign(e){switch(e){case 1:return"";case 2:return"";case 3:return"";default:return`${e}/ 4`}}}lZ.ArrowSize=6,lZ.DashSize=3,lZ.BendValueHeight=6;class l0 extends nC{constructor(e){super(0,0),this._isSimpleDip=!1,this._beat=e,this._renderPoints=this.createRenderingPoints(e)}createRenderingPoints(e){if(e.whammyBarType===tB.Custom)return e.whammyBarPoints;let t=[];switch(e.whammyBarType){case tB.Dive:case tB.Hold:case tB.PrediveDive:case tB.Predive:t.push(new iF(0,e.whammyBarPoints[0].value)),t.push(new iF(iF.MaxPosition,e.whammyBarPoints[1].value));break;case tB.Dip:t.push(new iF(0,e.whammyBarPoints[0].value)),t.push(new iF(iF.MaxPosition/2|0,e.whammyBarPoints[1].value)),t.push(new iF(iF.MaxPosition,e.whammyBarPoints[e.whammyBarPoints.length-1].value))}return t}doLayout(){super.doLayout(),this._isSimpleDip=this.renderer.settings.notation.notationMode===tu.SongBook&&this._beat.whammyBarType===tB.Dip;let e=null,t=null,i=this._beat;for(;i&&i.hasWhammyBar;)(!e||e.value>i.minWhammyPoint.value)&&(e=i.minWhammyPoint),(!t||t.value<i.maxWhammyPoint.value)&&(t=i.maxWhammyPoint),i=i.nextBeat;let s=t.value>0?Math.abs(this.getOffset(t.value)):0;(s>0||0!==this._beat.whammyBarPoints[0].value||this.renderer.settings.notation.isNotationElementVisible(tp.ZerosOnDiveWhammys))&&(s+=2*this.renderer.resources.tablatureFont.size);let a=e.value<0?Math.abs(this.getOffset(e.value)):0;this.renderer.registerOverflowTop(s+a),s>this.renderer.staff.getSharedLayoutData(l0.TopOffsetSharedDataKey,-1)&&this.renderer.staff.setSharedLayoutData(l0.TopOffsetSharedDataKey,s)}getOffset(e){if(0===e)return 0;let t=l0.PerHalfSize+Math.log2(Math.abs(e)/2)*l0.PerHalfSize;return e<0&&(t=-t),t}paint(e,t,i){let s=od.beat(i,tC.StandardNotationEffects,this._beat);try{let s=this.renderer,a=this._beat.nextBeat,r=null,n=is.PreNotes;a&&((r=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,a.voice.bar))&&r.staff===s.staff&&(r===s||a.hasWhammyBar)?n=a.hasWhammyBar&&(s.settings.notation.notationMode!==tu.SongBook||a.whammyBarType!==tB.Dip)?is.MiddleNotes:is.PreNotes:(a=null,r=null));let o=0,l=0;this._isSimpleDip?(o=e+s.x+s.getBeatX(this._beat,is.OnNotes)-2,l=e+s.x+s.getBeatX(this._beat,is.PostNotes)+2):(o=e+s.x+s.getBeatX(this._beat,is.MiddleNotes),l=r?e+r.x+r.getBeatX(a,n):e+s.x+s.width-2);let h=i.textAlign;if(i.textAlign=tS.Center,this._renderPoints.length>=2){let e=(l-o)/iF.MaxPosition;i.beginPath();let s=t+this.renderer.staff.getSharedLayoutData(l0.TopOffsetSharedDataKey,0),a=this._beat.whammyStyle===e8.Gradual?"grad.":"";for(let t=0,r=this._renderPoints.length-1;t<r;t++){let n=this._renderPoints[t],l=this._renderPoints[t+1],h=t<r-2?this._renderPoints[t+2]:null,d=0===t;0!==t||0===n.value||this._beat.isContinuedWhammy||(this.paintWhammy(!1,new iF(0,0),n,l,o,s,e,i),d=!1),this.paintWhammy(d,n,l,h,o,s,e,i,a),a=""}i.stroke()}i.textAlign=h}finally{s?.[Symbol.dispose]?.()}}paintWhammy(e,t,i,s,a,r,n,o,l){let h=a+n*t.offset,d=a+n*i.offset,c=r-this.getOffset(t.value),u=r-this.getOffset(i.value);if(t.offset===i.offset){let e=l0.DashSize;if(Math.abs(u-c)/(2*e)<1)o.moveTo(h,c),o.lineTo(d,u);else{let t=Math.max(c,u),i=Math.min(c,u);for(;t>i;)o.moveTo(h,i),o.lineTo(h,i+e),i+=2*e}o.stroke()}else if(t.value===i.value){let e=l0.DashSize;if(Math.abs(d-h)/(2*e)<1)o.moveTo(h,c),o.lineTo(d,u);else{let t=Math.max(h,d),i=Math.min(h,d);for(;t>i;)o.moveTo(t,c),o.lineTo(t-e,c),t-=2*e}o.stroke()}else o.moveTo(h,c),o.lineTo(d,u);let p=this.renderer.resources;if(e&&!this._beat.isContinuedWhammy&&!this._isSimpleDip){let e=c;e-=p.tablatureFont.size+2,this.renderer.settings.notation.isNotationElementVisible(tp.ZerosOnDiveWhammys)&&o.fillText("0",h,e),l&&(e-=p.tablatureFont.size+2,o.fillText(l,h,e))}let m=Math.abs(i.value);if((0!==m||this.renderer.settings.notation.isNotationElementVisible(tp.ZerosOnDiveWhammys)&&!this._isSimpleDip)&&t.value!==i.value){let e="";if(i.value<0&&(e+="-"),m>=4){let t=m/4|0;e+=t,m-=4*t}else 0===m&&(e+="0");m>0&&(e+=lZ.getFractionSign(m));let a=0;this._isSimpleDip?a=Math.min(c,u)-p.tablatureFont.size-2:(a=(t.offset===i.offset?Math.min(c,u):u)-(p.tablatureFont.size+2),s&&s.value>i.value&&(a-=2)),o.fillText(e,d,a)}}}l0.TopOffsetSharedDataKey="tab.whammy.topoffset",l0.PerHalfSize=6,l0.DashSize=3;class l1 extends lK{constructor(e){super(0,0),this._beat=e}doLayout(){let e=this.renderer.settings.notation.notationMode;switch(this._beat.whammyBarType){case tB.None:case tB.Custom:case tB.Hold:return;case tB.Dive:case tB.PrediveDive:{let e=new lj(this._beat,!1);e.renderer=this.renderer;let t=this._beat.whammyBarPoints[this._beat.whammyBarPoints.length-1];for(let i of this._beat.notes)i.isTieOrigin||e.addGlyph(this.getBendNoteValue(i,t),t.value%2!=0,void 0);e.doLayout(),this.BendNoteHeads.push(e)}break;case tB.Dip:if(e===tu.SongBook){let e=this.renderer.resources;this.renderer.simpleWhammyOverflow=1.5*e.tablatureFont.size+l1.SimpleDipHeight+l1.SimpleDipPadding}else{let e=new lj(this._beat,!1);if(e.renderer=this.renderer,this.renderer.settings.notation.notationMode===tu.GuitarPro){let t=this._beat.whammyBarPoints[1];for(let i of this._beat.notes)e.addGlyph(this.getBendNoteValue(i,this._beat.whammyBarPoints[1]),t.value%2!=0,void 0)}e.doLayout(),this.BendNoteHeads.push(e);let t=new lj(this._beat,!1);if(t.renderer=this.renderer,this.renderer.settings.notation.notationMode===tu.GuitarPro){let e=this._beat.whammyBarPoints[this._beat.whammyBarPoints.length-1];for(let i of this._beat.notes)t.addGlyph(this.getBendNoteValue(i,e),e.value%2!=0,void 0)}t.doLayout(),this.BendNoteHeads.push(t)}case tB.Predive:}super.doLayout()}paint(e,t,i){let s=this._beat;switch(s.whammyBarType){case tB.None:case tB.Custom:return}let a=this.renderer.settings.notation.notationMode,r=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,s.voice.bar),n=od.beat(i,tC.StandardNotationEffects,s);try{let n=e+r.x+r.getBeatX(s,is.MiddleNotes),o=this.getTieDirection(s,r),l=1===this._beat.notes.length?o:tR.Up,h=i.textAlign,d=nE.Heights.get(tb.NoteheadBlack);for(let h=0;h<s.notes.length;h++){let c=s.notes[h],u=od.note(i,tk.StandardNotationEffects,c);try{let u=t+r.y;h>0&&h>=(this._beat.notes.length/2|0)&&(l=tR.Down),l===tR.Down?u+=r.getNoteY(c,ir.Bottom):u+=r.getNoteY(c,ir.Top);let p=e+r.x;s.isLastOfVoice?p+=r.width:p+=r.getBeatX(s,is.EndBeat),p-=8;let m=s.whammyStyle===e8.Gradual&&0===h?"grad.":"",g=null;c.isTieOrigin&&((g=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,c.tieDestination.beat.voice.bar))&&g.staff===r.staff?p=e+g.x+g.getBeatX(c.tieDestination.beat,is.MiddleNotes):g=null);let f=d*nL.GraceScale*.5;l===tR.Up&&(f=-f);let y=s.whammyBarPoints.length>0?this.getBendNoteValue(c,s.whammyBarPoints[s.whammyBarPoints.length-1]):0,b=0,S=!1;switch(this.BendNoteHeads.length>0&&this.BendNoteHeads[0].containsNoteValue(y)?(b=this.BendNoteHeads[0].getNoteValueY(y)+f,S=!0):g&&(c.isTieOrigin&&c.tieDestination.beat.hasWhammyBar||c.beat.isContinuedWhammy)?(b=t+g.y+g.getNoteY(c.tieDestination,ir.Top),S=!0,l===tR.Down&&(b+=d)):c.isTieOrigin&&(b=g?t+g.y+g.getNoteY(c.tieDestination,ir.Top):u,l===tR.Down&&(b+=d)),s.whammyBarType){case tB.Hold:c.isTieOrigin&&lO.paintTie(i,1,n,u,p,b,o===tR.Down,22,4);break;case tB.Dive:if(0===h){this.BendNoteHeads[0].x=p-this.BendNoteHeads[0].noteHeadOffset;let e=this.BendNoteHeads[0].y;this.BendNoteHeads[0].y=t+r.y,this.BendNoteHeads[0].paint(0,0,i),this.BendNoteHeads[0].containsNoteValue(y)&&(b-=e,b+=this.BendNoteHeads[0].y)}S?this.drawBendSlur(i,n,u,p,b,l===tR.Down,1,m):c.isTieOrigin&&lO.paintTie(i,1,n,u,p,b,o===tR.Down,22,4);break;case tB.Dip:if(a===tu.SongBook){if(0===h){let s=e+r.x+r.getBeatX(this._beat,is.OnNotes)-2,a=e+r.x+r.getBeatX(this._beat,is.PostNotes)+2,n=(s+a)/2,o=((this._beat.whammyBarPoints[1].value-this._beat.whammyBarPoints[0].value)/4|0).toString();i.font=this.renderer.resources.tablatureFont,i.fillText(o,n,t+this.y);let l=t+this.y+i.font.size+2,h=l+l1.SimpleDipHeight;this._beat.whammyBarPoints[1].value>this._beat.whammyBarPoints[0].value?(i.moveTo(s,h),i.lineTo(n,l),i.lineTo(a,h)):(i.moveTo(s,l),i.lineTo(n,h),i.lineTo(a,l)),i.stroke()}c.isTieOrigin&&lO.paintTie(i,1,n,u,p,b,o===tR.Down,22,4)}else{let e=(n+p)/2;this.BendNoteHeads[0].x=e-this.BendNoteHeads[0].noteHeadOffset,this.BendNoteHeads[0].y=t+r.y,this.BendNoteHeads[0].paint(0,0,i);let a=this.getBendNoteValue(c,s.whammyBarPoints[1]),o=this.BendNoteHeads[0].getNoteValueY(a)+f;this.drawBendSlur(i,n,u,e,o,l===tR.Down,1,m),this.BendNoteHeads[1].x=p-this.BendNoteHeads[1].noteHeadOffset,this.BendNoteHeads[1].y=t+r.y,this.BendNoteHeads[1].paint(0,0,i),b=this.BendNoteHeads[1].getNoteValueY(y)+f,this.drawBendSlur(i,e,o,p,b,l===tR.Down,1,m)}break;case tB.PrediveDive:case tB.Predive:let _=e+r.x+r.getBeatX(c.beat,is.PreNotes);_+=r.getPreNotesGlyphForBeat(c.beat).prebendNoteHeadOffset;let w=t+r.y+r.getScoreY(r.accidentalHelper.getNoteLineForValue(c.displayValue-(c.beat.whammyBarPoints[0].value/2|0),!1))+f;this.drawBendSlur(i,_,w,n,u,l===tR.Down,1,m),this.BendNoteHeads.length>0&&(this.BendNoteHeads[0].x=p-this.BendNoteHeads[0].noteHeadOffset,this.BendNoteHeads[0].y=t+r.y,this.BendNoteHeads[0].paint(0,0,i),this.drawBendSlur(i,n,u,p,b,l===tR.Down,1,m))}}finally{u?.[Symbol.dispose]?.()}}i.textAlign=h}finally{n?.[Symbol.dispose]?.()}}getBendNoteValue(e,t){return e.displayValueWithoutBend+(t.value/2|0)}}l1.SimpleDipHeight=2*l0.PerHalfSize,l1.SimpleDipPadding=2;class l2 extends nC{constructor(e,t,i){super(e,t),this.width=i}}class l5 extends nM{constructor(e,t,i,s,a){super(e,t,a?nL.GraceScale:1,i.getSymbol(s)),this._isGrace=a,this._articulation=i}paint(e,t,i){let s=i.color;this.colorOverride&&(i.color=this.colorOverride);let a=+!!this._isGrace;i.fillMusicFontSymbol(e+this.x,t+this.y+a,this.glyphScale,this.symbol,!1),this._articulation.techniqueSymbol!==tb.None&&this._articulation.techniqueSymbolPlacement===t_.Middle&&i.fillMusicFontSymbol(e+this.x,t+this.y+a,this.glyphScale,this._articulation.techniqueSymbol,!1),i.color=s}doLayout(){super.doLayout(),0===this.width&&(this.height=nE.Widths.get(tb.NoteheadBlack)),0===this.height&&(this.height=nE.Heights.get(tb.NoteheadBlack))}}class l3 extends nM{constructor(e,t){super(e,t,nL.GraceScale,tb.ArticStaccatoAbove)}paint(e,t,i){super.paint(e+3,t+5,i)}}class l4 extends nM{constructor(e,t){super(e,t,.5,tb.PictEdgeOfCymbal)}paint(e,t,i){super.paint(e-3,t+this.height,i)}}class l6 extends nM{constructor(e,t,i=!1){super(e,t,nL.GraceScale,tb.GuitarGolpe),this.center=i}paint(e,t,i){super.paint(e,t+this.height,i)}}class l8 extends nD{constructor(){super(...arguments),this._strings=new Set}addString(e){this._strings.add(e)}doLayout(){let e=nE.Widths.get(tb.GuitarString0)*oI.CircleNumberScale;this.height=(e+3)*this._strings.size,this.width=e}paint(e,t,i){let s=this.renderer.bar.staff.tuning.length,a=0,r=nE.Widths.get(tb.GuitarString0)*oI.CircleNumberScale,n=nE.Heights.get(tb.NoteheadBlack);for(let o of this._strings){let l=s-o,h=tb.GuitarString1+l;i.fillMusicFontSymbol(e+this.x+n/2,t+this.y+r+a,oI.CircleNumberScale,h,!0),a+=r+3}}}class l7 extends nD{constructor(e,t,i,s,a){super(e,t),this.beatEffects=new Map,this.noteHeadElement=tk.SlashNoteHead,this.effectElement=tC.SlashEffects,this._isGrace=s,this._symbol=l7.getSymbol(i),this.beat=a}paint(e,t,i){let s=0===this.beat.notes.length?void 0:od.note(i,this.noteHeadElement,this.beat.notes[0]);try{let s=+!!this._isGrace,a=this._isGrace?nL.GraceScale:1;i.fillMusicFontSymbol(e+this.x,t+this.y+s,a,this._symbol,!1),this.paintEffects(e,t,i)}finally{s?.[Symbol.dispose]?.()}}paintEffects(e,t,i){let s=od.beat(i,this.effectElement,this.beat);try{for(let s of this.beatEffects.values())s.paint(e+this.x,t+this.y,i)}finally{s?.[Symbol.dispose]?.()}}doLayout(){let e=this._isGrace?nL.GraceScale:1;this.width=nE.Widths.get(this._symbol)*e,this.height=nE.Heights.get(this._symbol)*e;let t=nE.Heights.get(this._symbol);for(let e of this.beatEffects.values())e.y+=t,e.x+=this.width/2,e.renderer=this.renderer,t+=7,e.doLayout()}static getSymbol(e){switch(e){case tt.QuadrupleWhole:case tt.DoubleWhole:case tt.Whole:return tb.NoteheadSlashWhiteWhole;case tt.Half:return tb.NoteheadSlashWhiteHalf;default:return tb.NoteheadSlashVerticalEnds}}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("slash",this.beat,e+this.x+this.width,e+this.x)}}class l9 extends oH{constructor(){super(...arguments),this._collisionOffset=-1e3,this._skipPaint=!1,this.slash=null,this.noteHeads=null,this.restGlyph=null}get effectElement(){return tC.StandardNotationEffects}getNoteX(e,t){return this.noteHeads?this.noteHeads.getNoteX(e,t):0}buildBoundingsLookup(e,t,i){this.noteHeads&&this.noteHeads.buildBoundingsLookup(e,t+this.x,i+this.y)}getNoteY(e,t){return this.noteHeads?this.noteHeads.getNoteY(e,t):0}updateBeamingHelper(){if(this.noteHeads)this.noteHeads.updateBeamingHelper(this.container.x+this.x);else if(this.restGlyph){if(this.restGlyph.updateBeamingHelper(this.container.x+this.x),this.renderer.bar.isMultiVoice&&-1e3===this._collisionOffset){this._collisionOffset=this.renderer.helpers.collisionHelper.applyRestCollisionOffset(this.container.beat,this.restGlyph.y,this.renderer.getScoreHeight(1)),this.y+=this._collisionOffset;let e=this.renderer.helpers.collisionHelper.restDurationsByDisplayTime;e.has(this.container.beat.playbackStart)&&e.get(this.container.beat.playbackStart).has(this.container.beat.playbackDuration)&&e.get(this.container.beat.playbackStart).get(this.container.beat.playbackDuration)!==this.container.beat.id&&(this._skipPaint=!0)}}else this.slash&&this.slash.updateBeamingHelper(this.container.x+this.x)}paint(e,t,i){this._skipPaint||super.paint(e,t,i)}doLayout(){let e=this.renderer;if(!this.container.beat.isEmpty)if(this.container.beat.isRest){let t=2*Math.ceil((this.renderer.bar.staff.standardNotationLineCount-1)/2);this.container.beat.duration===tt.Whole&&1!==this.renderer.bar.staff.standardNotationLineCount&&3!==this.renderer.bar.staff.standardNotationLineCount&&(t-=2);let i=new lY(0,e.getScoreY(t),this.container.beat.duration);if(this.restGlyph=i,i.beat=this.container.beat,i.beamingHelper=this.beamingHelper,this.addNormal(i),this.renderer.bar.isMultiVoice)if(0===this.container.beat.voice.index){let t=og.computeLineHeightsForRest(this.container.beat.duration),s=i.y-e.getScoreHeight(t[0]),a=i.y+e.getScoreHeight(t[1]);this.renderer.helpers.collisionHelper.reserveBeatSlot(this.container.beat,s,a)}else this.renderer.helpers.collisionHelper.registerRest(this.container.beat);if(this.beamingHelper&&this.beamingHelper.applyRest(this.container.beat,t),this.container.beat.dots>0){this.addNormal(new l2(0,0,5));for(let e=0;e<this.container.beat.dots;e++){let e=new ol(0,0);e.renderer=this.renderer,this.createBeatDot(t,e),this.addEffect(e)}}}else{if(this.container.beat.slashed){let t=this.container.beat.graceType!==ti.None,i=(e.heightLineCount-1)/2,s=new l7(0,e.getLineY(i),this.container.beat.duration,t,this.container.beat);s.noteHeadElement=tk.StandardNotationNoteHead,s.effectElement=tC.StandardNotationEffects,this.slash=s,s.beat=this.container.beat,s.beamingHelper=this.beamingHelper,this.addNormal(s)}else{let e=new lJ;this.noteHeads=e,e.beat=this.container.beat,e.beamingHelper=this.beamingHelper;let t=new lW(!1);for(let e of(t.renderer=this.renderer,this.container.beat.notes))e.isVisible&&(this.createNoteGlyph(e),t.addParenthesis(e));this.addNormal(e),t.isEmpty||(this.addNormal(new l2(0,0,4*(this.container.beat.graceType!==ti.None?nL.GraceScale:1))),this.addEffect(t))}if(this.container.beat.hasWhammyBar){let e=new l1(this.container.beat);e.renderer=this.renderer,e.doLayout(),this.container.ties.push(e)}if(this.container.beat.dots>0){this.addNormal(new l2(0,0,5));for(let t=0;t<this.container.beat.dots;t++){let t=new ol(0,0);for(let i of(t.renderer=this.renderer,this.container.beat.notes))this.createBeatDot(e.getNoteLine(i),t).colorOverride=od.noteColor(e.resources,tk.StandardNotationEffects,i);this.addEffect(t)}}}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteHeads?this.centerX=this.noteHeads.x+this.noteHeads.width/2:this.slash&&(this.centerX=this.slash.x+this.slash.width/2)}createBeatDot(e,t){let i=new lI(0,this.renderer.getScoreY(e),1.5);return t.addGlyph(i),i}createNoteHeadGlyph(e){let t=this.container.beat.graceType!==ti.None,i=e.style;if(i?.noteHead!==void 0){let s=new nL(0,0,e.beat.duration,t);return s.symbol=i.noteHead,i.noteHeadCenterOnStem&&(s.centerOnStem=!0),s}if(e.beat.voice.bar.staff.isPercussion){let i=iU.getArticulation(e);if(i)return new l5(0,0,i,e.beat.duration,t);iM.warning("Rendering",`No articulation found for percussion instrument ${e.percussionArticulation}`)}return e.isDead?new lA(0,0,t):e.beat.graceType===ti.BendGrace?new nL(0,0,tt.Quarter,!0):e.harmonicType===tr.Natural?new lR(0,0,e.beat.duration,t):new nL(0,0,e.beat.duration,t)}createNoteGlyph(e){if(e.beat.graceType===ti.BendGrace&&!e.hasBend)return;let t=this.renderer,i=this.createNoteHeadGlyph(e);i.colorOverride=od.noteColor(t.resources,tk.StandardNotationNoteHead,e);let s=t.getNoteLine(e);if(i.y=t.getScoreY(s),this.noteHeads.addNoteGlyph(i,e,s),e.harmonicType!==tr.None&&e.harmonicType!==tr.Natural){let a=e.displayValue+e.harmonicPitch,r=new lR(0,0,e.beat.duration,this.container.beat.graceType!==ti.None);r.colorOverride=i.colorOverride,s=t.accidentalHelper.getNoteLineForValue(a,!1),r.y=t.getScoreY(s),this.noteHeads.addNoteGlyph(r,e,s)}let a=this.noteHeads.belowBeatEffects,r=this.noteHeads.aboveBeatEffects;if(e.isStaccato&&!a.has("Staccato")&&a.set("Staccato",new l3(0,0)),e.accentuated!==ts.Normal||a.has("Accent")||a.set("Accent",new lL(0,0,e)),e.accentuated!==ts.Heavy||a.has("HAccent")||a.set("HAccent",new lL(0,0,e)),e.accentuated!==ts.Tenuto||a.has("Tenuto")||a.set("Tenuto",new lL(0,0,e)),e.showStringNumber&&e.isStringed){let t;r.has("StringNumber")?t=r.get("StringNumber"):(t=new l8(0,0),r.set("StringNumber",t)),t.addString(e.string)}if(e.isPercussion){let t=iU.getArticulation(e);if(t&&t.techniqueSymbolPlacement!==t_.Middle){let e=t.techniqueSymbolPlacement===t_.Top?this.noteHeads.aboveBeatEffects:this.noteHeads.belowBeatEffects;switch(t.techniqueSymbol){case tb.PictEdgeOfCymbal:e.set("PictEdgeOfCymbal",new l4(0,0));break;case tb.ArticStaccatoAbove:e.set("ArticStaccatoAbove",new l3(0,0));break;case tb.StringsUpBow:e.set("StringsUpBow",new lu(0,0,ty.Up));break;case tb.StringsDownBow:e.set("StringsDownBow",new lu(0,0,ty.Down));break;case tb.GuitarGolpe:e.set("GuitarGolpe",new l6(0,0))}}}}}class he extends nC{constructor(e){super(0,0),this._beat=e}doLayout(){this.width=10*(this._beat.brushType===e9.ArpeggioUp||this._beat.brushType===e9.ArpeggioDown)}paint(e,t,i){if(this._beat.brushType===e9.ArpeggioUp||this._beat.brushType===e9.ArpeggioDown){let s=this.renderer,a=s.lineOffset,r=t+this.y+(s.getNoteY(this._beat.maxNote,ir.Bottom)-a),n=t+this.y+s.getNoteY(this._beat.minNote,ir.Top)+a,o=e+this.x+this.width/2,l=new lf(0,0,th.Slight,1.2,!0);l.renderer=this.renderer,l.doLayout();let h=-l.height/2;if(this._beat.brushType===e9.ArpeggioUp){let t=n-8;l.width=Math.abs(t-(r+8)),i.beginRotate(e+this.x+5,t,-90),l.paint(0,h,i),i.endRotate(),i.beginPath(),i.moveTo(o,n),i.lineTo(o+4,n-8),i.lineTo(o-4,n-8),i.closePath(),i.fill()}else if(this._beat.brushType===e9.ArpeggioDown){let t=r+8;l.width=Math.abs(n-t),i.beginRotate(e+this.x+5,t,90),l.paint(0,h,i),i.endRotate(),i.beginPath(),i.moveTo(o,r),i.lineTo(o+4,r+8),i.lineTo(o-4,r+8),i.closePath(),i.fill()}}}}class ht{constructor(e,t){this.line=0,this.line=e,this.text=t}}class hi extends ol{constructor(){super(0,0),this._infos=new Map}get isEmpty(){return 0===this._infos.size}addFingers(e){let t=this.renderer.settings;if(t.notation.fingeringMode!==tc.ScoreDefault&&t.notation.fingeringMode!==tc.ScoreForcePiano)return;let i=iW.fingerToString(this.renderer.settings,e.beat,e.leftHandFinger,!0);i&&this.addFinger(e,i);let s=iW.fingerToString(this.renderer.settings,e.beat,e.rightHandFinger,!1);s&&this.addFinger(e,s)}addFinger(e,t){let i=this.renderer,s=i.getNoteLine(e);if(this._infos.has(s)){let e=this._infos.get(s);e.text+=t}else{let a=new ht(s,t);a.color=od.noteColor(i.resources,tk.StandardNotationEffects,e),this._infos.set(s,a)}}doLayout(){let e=this.renderer;for(let[t,i]of this._infos){let t=new oT(0,0,i.text,e.resources.inlineFingeringFont,tS.Left,t_.Middle);t.colorOverride=i.color,t.renderer=e,t.y=e.getScoreY(i.line),t.doLayout(),this.addGlyph(t),this.width=Math.max(this.width,t.width)}}}class hs extends oO{constructor(){super(...arguments),this._prebends=null,this.accidentals=null}get prebendNoteHeadOffset(){return this._prebends?this._prebends.x+this._prebends.noteHeadOffset:0}get effectElement(){return tC.StandardNotationEffects}doLayout(){if(!this.container.beat.isRest){let e=new l$;e.renderer=this.renderer;let t=new hi;t.renderer=this.renderer;let i=new lW(!0);i.renderer=this.renderer;let s=new lj(this.container.beat,!0);for(let a of(this._prebends=s,s.renderer=this.renderer,this.container.beat.notes)){let r=od.noteColor(this.renderer.resources,tk.StandardNotationEffects,a);if(a.isVisible){if(a.hasBend)switch(a.bendType){case e7.PrebendBend:case e7.Prebend:case e7.PrebendRelease:s.addGlyph(a.displayValue-(a.bendPoints[0].value/2|0),!1,r)}else if(a.beat.hasWhammyBar)switch(a.beat.whammyBarType){case tB.PrediveDive:case tB.Predive:this._prebends.addGlyph(a.displayValue-(a.beat.whammyBarPoints[0].value/2|0),!1,r)}this.createAccidentalGlyph(a,e),i.addParenthesis(a),t.addFingers(a)}}s.isEmpty||(this.addEffect(s),this.addNormal(new l2(0,0,4*(this.container.beat.graceType!==ti.None?nL.GraceScale:1)))),this.container.beat.brushType!==e9.None&&(this.addEffect(new he(this.container.beat)),this.addNormal(new l2(0,0,4))),t.isEmpty||(this.isEmpty||this.addNormal(new l2(0,0,2*(this.container.beat.graceType!==ti.None?nL.GraceScale:1))),this.addEffect(t),this.addNormal(new l2(0,0,2*(this.container.beat.graceType!==ti.None?nL.GraceScale:1)))),i.isEmpty||(this.addEffect(i),this.addNormal(new l2(0,0,4*(this.container.beat.graceType!==ti.None?nL.GraceScale:1)))),e.isEmpty||(this.accidentals=e,this.isEmpty||this.addNormal(new l2(0,0,2*(this.container.beat.graceType!==ti.None?nL.GraceScale:1))),this.addNormal(e),this.addNormal(new l2(0,0,2*(this.container.beat.graceType!==ti.None?nL.GraceScale:1))))}super.doLayout()}createAccidentalGlyph(e,t){let i=this.renderer,s=i.accidentalHelper.applyAccidental(e),a=i.getNoteLine(e),r=this.container.beat.graceType!==ti.None,n=od.noteColor(i.resources,tk.StandardNotationAccidentals,e),o=r?nL.GraceScale:1;if(s!==tJ.None){let e=new lE(0,i.getScoreY(a),s,o);e.colorOverride=n,e.renderer=this.renderer,t.addGlyph(e)}if(e.harmonicType!==tr.None&&e.harmonicType!==tr.Natural){let l=e.displayValue+e.harmonicPitch;s=i.accidentalHelper.applyAccidentalForValue(e.beat,l,r,!1),a=i.accidentalHelper.getNoteLineForValue(l,!1);let h=new lE(0,i.getScoreY(a),s,o);h.colorOverride=n,h.renderer=this.renderer,t.addGlyph(h)}}}class ha extends ol{constructor(e,t,i,s,a,r){super(e,t),this._numerator=0,this._denominator=0,this.barSubElement=e5.StandardNotationTimeSignature,this._numerator=i,this._denominator=s,this._isCommon=a,this._isFreeTime=r}paint(e,t,i){let s=od.bar(i,this.barSubElement,this.renderer.bar);try{super.paint(e,t,i)}finally{s?.[Symbol.dispose]?.()}}doLayout(){let e=0,t=oV.numberHeight;if(this._isFreeTime){let i=new lH(!0);i.renderer=this.renderer,i.y=-t,i.height=2*t,i.doLayout(),this.addGlyph(i),e+=i.width+10}if(this._isCommon&&2===this._numerator&&2===this._denominator){let t=new nM(e,0,this.commonScale,tb.TimeSigCutCommon);this.addGlyph(t),super.doLayout()}else if(this._isCommon&&4===this._numerator&&4===this._denominator){let t=new nM(e,0,this.commonScale,tb.TimeSigCommon);this.addGlyph(t),super.doLayout()}else{let i=new oV(e,-t/2,this._numerator,this.numberScale),s=new oV(e,t/2,this._denominator,this.numberScale);this.addGlyph(i),this.addGlyph(s),super.doLayout();let a=this.width-e;i.x=e+(a-i.width)/2,s.x=e+(a-s.width)/2}if(this._isFreeTime){let e=new lH(!1);e.renderer=this.renderer,e.x=this.width+13,e.y=-t,e.height=2*t,e.doLayout(),this.addGlyph(e),this.width=e.x+e.width}}}class hr extends ha{get commonScale(){return 1}get numberScale(){return 1}}class hn extends lK{constructor(e){super(0,0),this._notes=[],this._endNoteGlyph=null,this._middleNoteGlyph=null,this._beat=e}addBends(e){if(this._notes.push(e),e.isTieOrigin)return;let t=od.noteColor(this.renderer.resources,tk.StandardNotationEffects,e);switch(e.bendType){case e7.Bend:case e7.PrebendRelease:case e7.PrebendBend:{let i=this._endNoteGlyph;i||((i=new lj(e.beat,!1)).renderer=this.renderer,this._endNoteGlyph=i,this.BendNoteHeads.push(i));let s=e.bendPoints[e.bendPoints.length-1];i.addGlyph(this.getBendNoteValue(e,s),s.value%2!=0,t)}break;case e7.Release:if(!e.isTieOrigin){let i=this._endNoteGlyph;i||((i=new lj(e.beat,!1)).renderer=this.renderer,this._endNoteGlyph=i,this.BendNoteHeads.push(i));let s=e.bendPoints[e.bendPoints.length-1];i.addGlyph(this.getBendNoteValue(e,s),s.value%2!=0,t)}break;case e7.BendRelease:{let i=this._middleNoteGlyph;i||(i=new lj(e.beat,!1),this._middleNoteGlyph=i,i.renderer=this.renderer,this.BendNoteHeads.push(i));let s=e.bendPoints[1];i.addGlyph(this.getBendNoteValue(e,e.bendPoints[1]),s.value%2!=0,t);let a=this._endNoteGlyph;a||((a=new lj(e.beat,!1)).renderer=this.renderer,this._endNoteGlyph=a,this.BendNoteHeads.push(a));let r=e.bendPoints[e.bendPoints.length-1];a.addGlyph(this.getBendNoteValue(e,r),r.value%2!=0,t)}}}paint(e,t,i){let s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._beat.voice.bar),a=e+s.x+s.getBeatX(this._beat,is.MiddleNotes),r=e+s.x;this._beat.isLastOfVoice?r+=s.postBeatGlyphsStart:r+=s.getBeatX(this._beat.nextBeat,is.PreNotes);let n=(a+(r-=8))/2;this._middleNoteGlyph&&(this._middleNoteGlyph.x=n-this._middleNoteGlyph.noteHeadOffset,this._middleNoteGlyph.y=t+s.y,this._middleNoteGlyph.paint(0,0,i)),this._endNoteGlyph&&(this._endNoteGlyph.x=r-this._endNoteGlyph.noteHeadOffset,this._endNoteGlyph.y=t+s.y,this._endNoteGlyph.paint(0,0,i)),this._notes.sort((e,t)=>t.displayValue-e.displayValue);let o=this._beat.graceType===ti.BendGrace?this._beat.nextBeat:this._beat,l=1===this._notes.length?this.getTieDirection(o,s):tR.Up,h=nE.Heights.get(tb.NoteheadBlack);for(let o=0;o<this._notes.length;o++){let d=this._notes[o],c=od.note(i,tk.StandardNotationEffects,d);try{o>0&&o>=(this._notes.length/2|0)&&(l=tR.Down);let c=t+s.y+s.getNoteY(d,ir.Top),u=h*nL.GraceScale*.5;l===tR.Down&&(c+=h);let p=d.bendStyle===e8.Gradual?"grad.":"";if(d.isTieOrigin){let r=d.tieDestination,n=r?this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,r.beat.voice.bar):null;if(n&&n.staff===s.staff){let s=e+n.x+n.getBeatX(r.beat,is.MiddleNotes),o=t+n.y+n.getNoteY(r,ir.Top);l===tR.Down&&(o+=h),d.bendType===e7.Hold||d.bendType===e7.Prebend?lO.paintTie(i,1,a,c,s,o,l===tR.Down,22,4):this.drawBendSlur(i,a,c,s,o,l===tR.Down,1,p)}else{let r=e+s.x+s.width,n=d.tieDestination.realValue;s.accidentalHelper.applyAccidentalForValue(d.beat,n,!1,!0);let o=t+s.y+s.getScoreY(s.accidentalHelper.getNoteLineForValue(n,!1));d.bendType===e7.Hold||d.bendType===e7.Prebend?lO.paintTie(i,1,a,c,r,o,l===tR.Down,22,4):this.drawBendSlur(i,a,c,r,o,l===tR.Down,1,p)}switch(d.bendType){case e7.Prebend:case e7.PrebendBend:case e7.PrebendRelease:let o=e+s.x+s.getBeatX(d.beat,is.PreNotes);o+=s.getPreNotesGlyphForBeat(d.beat).prebendNoteHeadOffset;let m=t+s.y+s.getScoreY(s.accidentalHelper.getNoteLineForValue(d.displayValue-(d.bendPoints[0].value/2|0),!1))+u;this.drawBendSlur(i,o,m,a,c,l===tR.Down,1)}}else{l===tR.Up&&(u=-u);let o=0,h=0;switch(d.bendType){case e7.Bend:o=this.getBendNoteValue(d,d.bendPoints[d.bendPoints.length-1]),h=this._endNoteGlyph.getNoteValueY(o)+u,this.drawBendSlur(i,a,c,r,h,l===tR.Down,1,p);break;case e7.BendRelease:let m=this.getBendNoteValue(d,d.bendPoints[1]),g=this._middleNoteGlyph.getNoteValueY(m)+u;this.drawBendSlur(i,a,c,n,g,l===tR.Down,1,p),o=this.getBendNoteValue(d,d.bendPoints[d.bendPoints.length-1]),h=this._endNoteGlyph.getNoteValueY(o)+u,this.drawBendSlur(i,n,g,r,h,l===tR.Down,1,p);break;case e7.Release:this.BendNoteHeads.length>0&&(o=this.getBendNoteValue(d,d.bendPoints[d.bendPoints.length-1]),h=this.BendNoteHeads[0].getNoteValueY(o)+u,this.drawBendSlur(i,a,c,r,h,l===tR.Down,1,p));break;case e7.Prebend:case e7.PrebendBend:case e7.PrebendRelease:let f=e+s.x+s.getBeatX(d.beat,is.PreNotes);f+=s.getPreNotesGlyphForBeat(d.beat).prebendNoteHeadOffset;let y=t+s.y+s.getScoreY(s.accidentalHelper.getNoteLineForValue(d.displayValue-(d.bendPoints[0].value/2|0),!1))+u;this.drawBendSlur(i,f,y,a,c,l===tR.Down,1),this.BendNoteHeads.length>0&&(o=this.getBendNoteValue(d,d.bendPoints[d.bendPoints.length-1]),h=this.BendNoteHeads[0].getNoteValueY(o)+u,this.drawBendSlur(i,a,c,r,h,l===tR.Down,1,p))}}}finally{c?.[Symbol.dispose]?.()}}}getBendNoteValue(e,t){return e.displayValueWithoutBend+(t.value/2|0)}}class ho extends lO{constructor(e,t,i=!1){super(e,t,i)}doLayout(){super.doLayout()}getBeamDirection(e,t){return e.isRest?tR.Up:t.getBeatDirection(e)===tR.Up?tR.Down:tR.Up}getStartY(){return this.startBeat.isRest?this.startNoteRenderer.getScoreY(9):this.tieDirection===tR.Up?this.startNoteRenderer.getNoteY(this.startBeat.maxNote,ir.Top):this.startNoteRenderer.getNoteY(this.startBeat.minNote,ir.Bottom)}getEndY(){let e=this.endNoteRenderer;if(this.endBeat.isRest)if(this.tieDirection===tR.Up)return e.getScoreY(9);else return e.getScoreY(0);let t=this.startNoteRenderer.getBeatDirection(this.startBeat),i=e.getBeatDirection(this.endBeat);if(t!==i&&this.startBeat.graceType===ti.None){if(i===this.tieDirection)if(this.tieDirection===tR.Up)return e.getNoteY(this.endBeat.maxNote,ir.TopWithStem);else return e.getNoteY(this.endBeat.minNote,ir.BottomWithStem);return this.tieDirection===tR.Up?e.getNoteY(this.endBeat.maxNote,ir.BottomWithStem):e.getNoteY(this.endBeat.minNote,ir.TopWithStem)}return this.tieDirection===tR.Up?e.getNoteY(this.endBeat.maxNote,ir.Top):e.getNoteY(this.endBeat.minNote,ir.Bottom)}getStartX(){return this.startNoteRenderer.getBeatX(this.startBeat,is.MiddleNotes)}getEndX(){let e=this.endNoteRenderer.getBeatDirection(this.endBeat);return this.endNoteRenderer.getBeatX(this.endBeat,this.endBeat.duration>tt.Whole&&e===this.tieDirection?is.Stem:is.MiddleNotes)}}class hl extends nC{constructor(e,t,i,s){super(0,0),this._outType=t,this._inType=e,this._startNote=i,this._parent=s}doLayout(){this.width=0}paint(e,t,i){this.paintSlideIn(e,t,i),this.drawSlideOut(e,t,i)}paintSlideIn(e,t,i){let s=this.renderer,a=e+s.x+s.getNoteX(this._startNote,io.Left)-2,r=t+s.y+s.getNoteY(this._startNote,ir.Center),n=a-12,o=t+s.y;switch(this._inType){case to.IntoFromBelow:o+=s.getNoteY(this._startNote,ir.Bottom);break;case to.IntoFromAbove:o+=s.getNoteY(this._startNote,ir.Top);break;default:return}let l=this.getAccidentalsWidth(s,this._startNote.beat);n-=l,a-=l,this.paintSlideLine(i,!1,n,a,o,r)}getAccidentalsWidth(e,t){let i=e.getPreNotesGlyphForBeat(t);return i&&i.accidentals?i.accidentals.width:0}drawSlideOut(e,t,i){let s=this.renderer,a=0,r=0,n=0,o=0,l=!1;switch(this._outType){case tl.Shift:case tl.Legato:if(a=e+s.x+s.getBeatX(this._startNote.beat,is.PostNotes)+2,r=t+s.y+s.getNoteY(this._startNote,ir.Center),this._startNote.slideTarget){let i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._startNote.slideTarget.beat.voice.bar);i&&i.staff===s.staff?(n=e+i.x+i.getBeatX(this._startNote.slideTarget.beat,is.PreNotes)-2,o=t+i.y+i.getNoteY(this._startNote.slideTarget,ir.Center)):(n=e+s.x+s.width,o=r),this._startNote.slideTarget.realValue>this._startNote.realValue?(r+=2,o-=2):(r-=2,o+=2)}else n=e+s.x+this._parent.x,o=r;break;case tl.OutUp:a=e+s.x+s.getNoteX(this._startNote,io.Right)+2,r=t+s.y+s.getNoteY(this._startNote,ir.Center),n=a+12,o=t+s.y+s.getNoteY(this._startNote,ir.Top);break;case tl.OutDown:a=e+s.x+s.getNoteX(this._startNote,io.Right)+2,r=t+s.y+s.getNoteY(this._startNote,ir.Center),n=a+12,o=t+s.y+s.getNoteY(this._startNote,ir.Bottom);break;case tl.PickSlideUp:a=e+s.x+s.getNoteX(this._startNote,io.Right)+4,r=t+s.y+s.getNoteY(this._startNote,ir.Center),o=t+s.y+s.getNoteY(this._startNote,ir.Top),n=e+s.x+s.width,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(n=e+s.x+s.getBeatX(this._startNote.beat.nextBeat,is.PreNotes)),l=!0;break;case tl.PickSlideDown:a=e+s.x+s.getNoteX(this._startNote,io.Right)+4,r=t+s.y+s.getNoteY(this._startNote,ir.Center),o=t+s.y+s.getNoteY(this._startNote,ir.Bottom),n=e+s.x+s.width,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(n=e+s.x+s.getBeatX(this._startNote.beat.nextBeat,is.PreNotes)),l=!0;break;default:return}this.paintSlideLine(i,l,a,n,r,o)}paintSlideLine(e,t,i,s,a,r){if(t){let t=new lf(0,0,th.Slight,1.2);t.renderer=this.renderer,t.doLayout(),a-=t.height/2;let n=s-i,o=(r-=t.height/2)-a,l=Math.sqrt(Math.pow(o,2)+Math.pow(n,2));t.width=n;let h=180/Math.PI*Math.asin(o/l);e.beginRotate(i,a,h),t.paint(0,0,e),e.endRotate()}else e.beginPath(),e.moveTo(i,a),e.lineTo(s,r),e.stroke()}}class hh extends ho{constructor(e,t,i=!1){super(e.beat,t.beat,i),this._startNote=e,this._endNote=t}getTieHeight(e,t,i,s){return Math.log2(i-e+1)*this.renderer.settings.notation.slurHeight}getStartY(){if(this.isStartCentered())if(this.tieDirection===tR.Up)return this.startNoteRenderer.getNoteY(this._startNote,ir.Top);else return this.startNoteRenderer.getNoteY(this._startNote,ir.Bottom);return this.startNoteRenderer.getNoteY(this._startNote,ir.Center)}getEndY(){if(this.isEndCentered()){if(this.isEndOnStem())if(this.tieDirection===tR.Up)return this.endNoteRenderer.getNoteY(this._endNote,ir.TopWithStem);else return this.endNoteRenderer.getNoteY(this._endNote,ir.BottomWithStem);return this.tieDirection===tR.Up?this.endNoteRenderer.getNoteY(this._endNote,ir.Top):this.endNoteRenderer.getNoteY(this._endNote,ir.Bottom)}return this.endNoteRenderer.getNoteY(this._endNote,ir.Center)}isStartCentered(){return this._startNote===this._startNote.beat.maxNote&&this.tieDirection===tR.Up||this._startNote===this._startNote.beat.minNote&&this.tieDirection===tR.Down}isEndCentered(){return this._startNote.beat.graceType===ti.None&&(this._endNote===this._endNote.beat.maxNote&&this.tieDirection===tR.Up||this._endNote===this._endNote.beat.minNote&&this.tieDirection===tR.Down)}isEndOnStem(){let e=this.endNoteRenderer;return this.startNoteRenderer.getBeatDirection(this.startBeat)!==e.getBeatDirection(this.endBeat)&&this.startBeat.graceType===ti.None}getStartX(){return this.isStartCentered()?this.startNoteRenderer.getBeatX(this._startNote.beat,is.MiddleNotes):this.startNoteRenderer.getNoteX(this._startNote,io.Right)}getEndX(){return this.isEndCentered()?this.isEndOnStem()?this.endNoteRenderer.getBeatX(this._endNote.beat,is.Stem):this.endNoteRenderer.getNoteX(this._endNote,io.Center):this.endNoteRenderer.getBeatX(this._endNote.beat,is.PreNotes)}}class hd extends lO{constructor(e,t,i=!1){super(e?e.beat:null,t?t.beat:null,i),this.startNote=e,this.endNote=t}shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}doLayout(){super.doLayout()}getBeamDirection(e,t){return t.getBeatDirection(e)===tR.Up?tR.Down:tR.Up}getStartY(){return this.startBeat.isRest?this.startNoteRenderer.getScoreY(9):this.tieDirection===tR.Up?this.startNoteRenderer.getNoteY(this.startNote,ir.Top):this.startNoteRenderer.getNoteY(this.startNote,ir.Bottom)}getEndY(){let e=this.endNoteRenderer;if(this.endBeat.isRest)if(this.tieDirection===tR.Up)return e.getScoreY(9);else return e.getScoreY(0);return this.tieDirection===tR.Up?e.getNoteY(this.endNote,ir.Top):e.getNoteY(this.endNote,ir.Bottom)}getStartX(){return this.startNoteRenderer.getBeatX(this.startNote.beat,is.PostNotes)}getEndX(){return this.endNoteRenderer.getBeatX(this.endNote.beat,is.PreNotes)}}class hc extends nA{constructor(){super(...arguments),this._bend=null,this._effectSlur=null,this._effectEndSlur=null}doLayout(){this._effectSlur=null,this._effectEndSlur=null,super.doLayout(),this._bend&&(this._bend.renderer=this.renderer,this._bend.doLayout(),this.updateWidth())}createTies(e){if(e.isVisible){if(e.isTieOrigin&&!e.hasBend&&!e.beat.hasWhammyBar&&e.beat.graceType!==ti.BendGrace&&e.tieDestination&&e.tieDestination.isVisible){let t=new hd(e,e.tieDestination,!1);this.addTie(t)}if(e.isTieDestination&&!e.tieOrigin.hasBend&&!e.beat.hasWhammyBar){let t=new hd(e.tieOrigin,e,!0);this.addTie(t)}if(e.slideInType!==to.None||e.slideOutType!==tl.None){let t=new hl(e.slideInType,e.slideOutType,e,this);this.addTie(t)}if(e.isSlurOrigin&&e.slurDestination&&e.slurDestination.isVisible){let t=new hh(e,e.slurDestination,!1);this.addTie(t)}if(e.isSlurDestination){let t=new hh(e.slurOrigin,e,!0);this.addTie(t)}if(!this._effectSlur&&e.isEffectSlurOrigin&&e.effectSlurDestination){let t=new hh(e,e.effectSlurDestination,!1);this._effectSlur=t,this.addTie(t)}if(!this._effectEndSlur&&e.beat.isEffectSlurDestination&&e.beat.effectSlurOrigin){let t=this.onNotes.beamingHelper.direction,i=new hh(t===tR.Up?e.beat.effectSlurOrigin.minNote:e.beat.effectSlurOrigin.maxNote,t===tR.Up?e.beat.minNote:e.beat.maxNote,!0);this._effectEndSlur=i,this.addTie(i)}if(e.hasBend){if(!this._bend){let t=new hn(e.beat);this._bend=t,t.renderer=this.renderer,this.addTie(t)}this._bend.addBends(e)}if(this.beat.isLegatoOrigin){if(!this.beat.previousBeat||!this.beat.previousBeat.isLegatoOrigin){let e=this.beat.nextBeat;for(;e.nextBeat&&e.nextBeat.isLegatoDestination;)e=e.nextBeat;this.addTie(new ho(this.beat,e,!1))}}else if(this.beat.isLegatoDestination&&!this.beat.isLegatoOrigin){let e=this.beat.previousBeat;for(;e.previousBeat&&e.previousBeat.isLegatoOrigin;)e=e.previousBeat;this.addTie(new ho(e,this.beat,!0))}}}}class hu extends nC{doLayout(){this.width=1}paint(e,t,i){let s=e+this.x,a=t+this.y+this.renderer.topPadding,r=t+this.y+this.renderer.height-this.renderer.bottomPadding;this.paintInternal(s,a,r-a,i)}}class hp extends hu{paintInternal(e,t,i,s){s.fillRect(e,t,1,i)}}class hm extends hu{paintInternal(e,t,i,s){let a=this.renderer.getLineHeight(1),r=t+.5*a+1,n=t+i;for(;r<n;)s.fillCircle(e,r,1),r+=a}}class hg extends hu{paintInternal(e,t,i,s){let a=hg.DashSize,r=e+.5,n=Math.ceil(i/2/a),o=t+i;if(s.beginPath(),n<1)s.moveTo(r,t),s.lineTo(r,o);else{let e=t,l=(i-n*a)/(n-1);for(;e<o;)s.moveTo(r,e),s.lineTo(r,e+a),e+=a+l}s.stroke()}}hg.DashSize=4;class hf extends hu{doLayout(){this.width=4}paintInternal(e,t,i,s){s.fillRect(e,t,this.width,i)}}class hy extends hu{paintInternal(e,t,i,s){let a=(t+(t+i))/2;s.fillCircle(e,a-4.5,1.5),s.fillCircle(e,a+4.5,1.5)}}class hb extends hu{paintInternal(e,t,i,s){let a=this.renderer,r=a.drawnLineCount-1;if(r<=2)return;let n=a.getLineHeight(1),o=2*n,l=r/2*n-o/2;s.fillRect(e,t+l,1,o)}}class hS extends hu{paintInternal(e,t,i,s){let a=this.renderer.getLineHeight(1),r=-(a/2)+1;s.fillRect(e,t+r,1,a)}}class h_ extends oh{constructor(e){super(),this._isRight=e}doLayout(){let e=this.renderer.bar,t=e.masterBar,i=this._isRight?e.getActualBarLineRight():e.getActualBarLineLeft(0===this.renderer.index),s=e3.Automatic;if(!this._isRight){let e=this.renderer.previousRenderer;if(e&&e.staff===this.renderer.staff&&i===(s=e.bar.getActualBarLineRight()))return}switch(this._isRight&&t.isRepeatEnd&&(this.addGlyph(new hy(0,0)),this.width+=3),i){case e3.Dashed:this.addGlyph(new hg(0,0));break;case e3.Dotted:this.addGlyph(new hm(0,0));break;case e3.Heavy:s!==e3.LightHeavy&&s!==e3.HeavyHeavy&&this.addGlyph(new hf(0,0));break;case e3.HeavyHeavy:s!==e3.LightHeavy&&s!==e3.Heavy&&this.addGlyph(new hf(0,0)),this.width+=3,this.addGlyph(new hf(0,0));break;case e3.HeavyLight:s!==e3.LightHeavy&&s!==e3.Heavy&&s!==e3.HeavyHeavy&&this.addGlyph(new hf(0,0)),this.width+=3,this.addGlyph(new hp(0,0));break;case e3.LightHeavy:s!==e3.HeavyLight&&s!==e3.Regular&&s!==e3.LightLight&&this.addGlyph(new hp(0,0)),this.width+=3,this.addGlyph(new hf(0,0));break;case e3.LightLight:s!==e3.HeavyLight&&s!==e3.Regular&&this.addGlyph(new hp(0,0)),this.width+=3,this.addGlyph(new hp(0,0));break;case e3.None:break;case e3.Regular:s!==e3.HeavyLight&&s!==e3.LightLight&&this.addGlyph(new hp(0,0));break;case e3.Short:this.addGlyph(new hb(0,0));break;case e3.Tick:this.addGlyph(new hS(0,0))}!this._isRight&&t.isRepeatStart&&(this.width+=3,this.addGlyph(new hy(0,0)))}paint(e,t,i){let s=this.renderer,a=od.bar(i,s.barLineBarSubElement,this.renderer.bar,!0);try{super.paint(e,t,i)}finally{a?.[Symbol.dispose]?.()}}}class hw extends nC{constructor(e,t,i){super(e,t),this._count=0,this._count=0,this._count=i}doLayout(){this.width=0}paint(e,t,i){let s=od.bar(i,this.renderer.repeatsBarSubElement,this.renderer.bar);try{let s=this.renderer.resources,a=i.textAlign;i.font=s.barNumberFont,i.textAlign=tS.Right;let r=`x${this._count}`,n=i.measureText(r).width/1.5;i.fillText(r,e+this.x-n,t+this.y),i.textAlign=a}finally{s?.[Symbol.dispose]?.()}}}class hk extends nC{constructor(e,t,i){super(e,t),this._number=0,this._number=i}doLayout(){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.barNumberFont,this.width=this.renderer.scoreRenderer.canvas.measureText(this._number.toString()).width+5}paint(e,t,i){if(!this.renderer.staff.isFirstInSystem)return;let s=od.bar(i,this.renderer.barNumberBarSubElement,this.renderer.bar,!0);try{let s=this.renderer.resources,a=i.textBaseline;i.textBaseline=t_.Top,i.font=s.barNumberFont,i.fillText(this._number.toString(),e+this.x,t+this.y),i.textBaseline=a}finally{s?.[Symbol.dispose]?.()}}}class hB extends oz{constructor(){super(...arguments),this.firstLineY=0,this._startSpacing=!1,this.tupletSize=0}get lineOffset(){return this.lineSpacing+1}get tupletOffset(){return 10}get topGlyphOverflow(){let e=this.resources;return e.tablatureFont.size/2+.2*e.tablatureFont.size}get bottomGlyphOverflow(){let e=this.resources;return e.tablatureFont.size/2+.2*e.tablatureFont.size}initLineBasedSizes(){this.topPadding=this.topGlyphOverflow,this.bottomPadding=this.bottomGlyphOverflow,this.height=this.lineOffset*(this.heightLineCount-1)+this.topPadding+this.bottomPadding}updateSizes(){this.initLineBasedSizes(),this.adjustSizes(),this.updateFirstLineY(),super.updateSizes()}adjustSizes(){}updateFirstLineY(){let e=this.lineOffset*(this.heightLineCount-1),t=(this.drawnLineCount-1)*this.lineOffset;this.firstLineY=this.topPadding+(e-t)/2}doLayout(){this.initLineBasedSizes(),this.updateFirstLineY(),this.tupletSize=15+.3*this.resources.effectFont.size,super.doLayout()}getLineY(e){return this.firstLineY+this.getLineHeight(e)}getLineHeight(e){return this.lineOffset*e}paintBackground(e,t,i){super.paintBackground(e,t,i),this.paintStaffLines(e,t,i),this.paintSimileMark(e,t,i)}paintStaffLines(e,t,i){let s=od.bar(i,this.staffLineBarSubElement,this.bar,!0);try{let s=[];for(let e=0,t=this.drawnLineCount;e<t;e++)s.push([]);for(let e of(this.additionalMultiRestBars||this.collectSpaces(s),s))e.sort((e,t)=>e[0]>t[0]?1:e[0]<t[0]?-1:0);let a=Math.ceil(this.width);for(let r=0;r<this.drawnLineCount;r++){let n=this.getLineY(r),o=0;for(let a of s[r])i.fillRect(e+this.x+o,t+this.y+n|0,a[0]-o,oz.StaffLineThickness),o=a[0]+a[1];i.fillRect(e+this.x+o,t+this.y+n|0,a-o,oz.StaffLineThickness)}}finally{s?.[Symbol.dispose]?.()}}collectSpaces(e){}createStartSpacing(){if(this._startSpacing)return;let e=0===this.index?this.settings.display.firstStaffPaddingLeft:this.settings.display.staffPaddingLeft;this.addPreBeatGlyph(new l2(0,0,e)),this._startSpacing=!0}paintTuplets(e,t,i,s,a=!1){for(let r of this.bar.voices)if(this.hasVoiceContainer(r))for(let n of this.getVoiceContainer(r).tupletGroups)this.paintTupletHelper(e+this.beatGlyphsStart,t,i,n,s,a)}getTupletBeamDirection(e){return this.getBeamDirection(e)}paintTupletHelper(e,t,i,s,a,r){let n,o=this.resources,l=i.textAlign,h=i.textBaseline;i.color=0===s.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,i.textAlign=tS.Center,i.textBaseline=t_.Middle;let d=s.beats[0].tupletNumerator,c=s.beats[0].tupletDenominator;n=2===d&&3===c?"2":3===d&&2===c?"3":4===d&&6===c?"4":5===d&&4===c?"5":6===d&&4===c?"6":7===d&&4===c?"7":9===d&&8===c?"9":10===d&&8===c?"10":11===d&&8===c?"11":12===d&&8===c?"12":13===d&&8===c?"13":`${d}:${c}`;let u=this.tupletOffset,p=5,m=od.beat(i,a,s.beats[0]);try{if(1!==s.beats.length&&s.isFull){let a=s.beats[0],l=s.beats[s.beats.length-1],h=null,d=null;for(let e=0;e<s.beats.length;e++)if(!s.beats[e].isRest){h=s.beats[e];break}for(let e=s.beats.length-1;e>=0;e--)if(!s.beats[e].isRest){d=s.beats[e];break}let c=!1;h||(h=a,c=!0),d||(d=l);let m=this.helpers.beamHelperLookup[s.voice.index].get(a.index),g=this.helpers.beamHelperLookup[s.voice.index].get(l.index),f=m.getBeatLineX(a),y=g.getBeatLineX(l),b=this.helpers.beamHelperLookup[s.voice.index].get(h.index),S=this.helpers.beamHelperLookup[s.voice.index].get(d.index),_=this.getTupletBeamDirection(m),w=this.calculateBeamYWithDirection(b,f,_),k=this.calculateBeamYWithDirection(S,y,_);c&&(k=w=Math.max(w,k)),i.font=o.effectFont;let B=i.measureText(n).width,T=(f+y)/2,N=T-B/2-3,x=T+B/2+3,P=(k-w)/(y-f),v=w-P*f,F=P*N+v,C=P*x+v;_===tR.Down&&(u*=-1,p*=-1),i.beginPath(),i.moveTo(e+this.x+f,t+this.y+w-u|0),r?i.quadraticCurveTo(e+this.x+(N+f)/2,t+this.y+F-u-p|0,e+this.x+N,t+this.y+F-u-p|0):(i.lineTo(e+this.x+f,t+this.y+w-u-p|0),i.lineTo(e+this.x+N,t+this.y+F-u-p|0)),i.stroke(),i.beginPath(),i.moveTo(e+this.x+x,t+this.y+C-u-p|0),r?i.quadraticCurveTo(e+this.x+(y+x)/2,t+this.y+C-u-p|0,e+this.x+y,t+this.y+k-u|0):(i.lineTo(e+this.x+y,t+this.y+k-u-p|0),i.lineTo(e+this.x+y,t+this.y+k-u|0)),i.stroke(),i.fillText(n,e+this.x+T,t+this.y+(P*T+v)-u-p)}else for(let a of s.beats){let r=this.helpers.beamHelperLookup[s.voice.index].get(a.index);if(!r)continue;let l=this.getTupletBeamDirection(r),h=r.getBeatLineX(a),d=this.calculateBeamYWithDirection(r,h,l);l===tR.Down?d+=u+p:d-=u+p,i.font=o.effectFont,i.fillText(n,e+this.x+h,t+this.y+d)}i.textAlign=l,i.textBaseline=h}finally{m?.[Symbol.dispose]?.()}}paintBeams(e,t,i,s,a){for(let r of this.helpers.beamHelpers)for(let n of r)this.paintBeamHelper(e+this.beatGlyphsStart,t,i,n,s,a)}drawBeamHelperAsFlags(e){return 1===e.beats.length}paintBeamHelper(e,t,i,s,a,r){i.color=0===s.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,s.isRestBeamHelper||(this.drawBeamHelperAsFlags(s)?this.paintFlag(e,t,i,s,a):this.paintBar(e,t,i,s,r))}shouldPaintFlag(e,t){return e.graceType!==ti.BendGrace&&!e.deadSlapped&&!!t.hasBeatLineX(e)&&(e.graceType===ti.None||this.settings.notation.notationMode!==tu.SongBook)&&e.duration!==tt.Whole&&e.duration!==tt.DoubleWhole&&e.duration!==tt.QuadrupleWhole}paintFlag(e,t,i,s,a){for(let r of s.beats){if(!this.shouldPaintFlag(r,s))continue;let n=r.graceType!==ti.None,o=n?nL.GraceScale:1,l=this.getFlagStemSize(s.shortestDuration),h=s.getBeatLineX(r),d=this.getBeamDirection(s),c=this.getFlagTopY(r,d),u=this.getFlagBottomY(r,d),p=0;if(d===tR.Down?(u+=l*o,p=u):(c-=l*o,p=c),!s.hasLine(!0,r))continue;this.paintBeamingStem(r,t+this.y,e+this.x+h,t+this.y+c,t+this.y+u,i);let m=od.beat(i,a,r);try{if(r.graceType===ti.BeforeBeat&&(i.beginPath(),d===tR.Down?(i.moveTo(e+this.x+h-6,t+this.y+u-15),i.lineTo(e+this.x+h+6,t+this.y+u)):(i.moveTo(e+this.x+h-6,t+this.y+c+15),i.lineTo(e+this.x+h+6,t+this.y+c)),i.stroke()),s.hasFlag(!0,r)){let s=new nI(h-.5,p,r.duration,d,n);s.renderer=this,s.doLayout(),s.paint(e+this.x,t+this.y,i)}}finally{m?.[Symbol.dispose]?.()}}}getFlagStemSize(e,t=!1){let i=0;switch(e){case tt.QuadrupleWhole:case tt.Half:case tt.Quarter:case tt.Eighth:case tt.Sixteenth:case tt.ThirtySecond:case tt.SixtyFourth:case tt.OneHundredTwentyEighth:case tt.TwoHundredFiftySixth:i=3;break;default:i=3*!!t}return this.getLineHeight(i)}recreatePreBeatGlyphs(){this._startSpacing=!1,super.recreatePreBeatGlyphs()}calculateBeamY(e,t){return this.calculateBeamYWithDirection(e,t,this.getBeamDirection(e))}createPreBeatGlyphs(){super.createPreBeatGlyphs(),this.addPreBeatGlyph(new h_(!1)),this.createLinePreBeatGlyphs(),this.addPreBeatGlyph(new hk(0,this.getLineHeight(-.25),this.bar.index+1))}createPostBeatGlyphs(){super.createPostBeatGlyphs();let e=this.lastBar;this.addPostBeatGlyph(new h_(!0)),e.masterBar.isRepeatEnd&&e.masterBar.repeatCount>2&&this.addPostBeatGlyph(new hw(0,this.getLineHeight(-.25),this.bar.masterBar.repeatCount))}paintBar(e,t,i,s,a){for(let r=0,n=s.beats.length;r<n;r++){let n=s.beats[r];if(!s.hasBeatLineX(n)||n.deadSlapped)continue;let o=n.graceType!==ti.None?nL.GraceScale:1,l=s.getBeatLineX(n),h=this.getBeamDirection(s),d=t+this.y+this.getBarLineStart(n,h),c=t+this.y+this.calculateBeamY(s,l);this.paintBeamingStem(n,t+this.y,e+this.x+l,d,c,i);let u=od.beat(i,a,n);try{let a=c;h===tR.Down?a+=2*i.font.size:0!==r&&(a-=1.5*i.font.size);let d=6*o,u=(oz.BeamSpacing+oz.BeamThickness)*o,p=oz.BeamThickness*o,m=iW.getIndex(n.duration)-2,g=t+this.y;h===tR.Down&&(u=-u,p=-p);for(let t=0;t<m;t++){let a=0,o=0,h=0,c=0,f=g+t*u;if(r<s.beats.length-1){let u=og.isFullBarJoin(n,s.beats[r+1],t);if(t===m-1&&u&&n.beamingMode===tF.ForceSplitOnSecondaryToNext)o=(a=l)+d,h=f+this.calculateBeamY(s,a),c=f+this.calculateBeamY(s,o),hB.paintSingleBar(i,e+this.x+a,h,e+this.x+o,c,p),a=(o=s.getBeatLineX(s.beats[r+1]))-d,h=f+this.calculateBeamY(s,a),c=f+this.calculateBeamY(s,o),hB.paintSingleBar(i,e+this.x+a,h,e+this.x+o,c,p);else{if(u)a=l,o=s.getBeatLineX(s.beats[r+1]);else{if(0!==r&&og.isFullBarJoin(s.beats[r-1],n,t))continue;o=(a=l)+d}h=f+this.calculateBeamY(s,a),c=f+this.calculateBeamY(s,o),hB.paintSingleBar(i,e+this.x+a,h,e+this.x+o,c,p)}}else r>0&&!og.isFullBarJoin(n,s.beats[r-1],t)&&(a=l-d,o=l,h=f+this.calculateBeamY(s,a),c=f+this.calculateBeamY(s,o),hB.paintSingleBar(i,e+this.x+a,h,e+this.x+o,c,p))}}finally{u?.[Symbol.dispose]?.()}}}static paintSingleBar(e,t,i,s,a,r){e.beginPath(),e.moveTo(t,i),e.lineTo(s,a),e.lineTo(s,a+r),e.lineTo(t,i+r),e.closePath(),e.fill()}}class hT extends oh{paint(e,t,i){let s=od.bar(i,e5.StandardNotationKeySignature,this.renderer.bar);try{super.paint(e,t,i)}finally{s?.[Symbol.dispose]?.()}}}class hN extends hB{constructor(e,t){super(e,t),this.simpleWhammyOverflow=0,this.beatEffectsMinY=null,this.beatEffectsMaxY=null,this.accidentalHelper=new sj(this)}get repeatsBarSubElement(){return e5.StandardNotationRepeats}get barNumberBarSubElement(){return e5.StandardNotationBarNumber}get barLineBarSubElement(){return e5.StandardNotationBarLines}get staffLineBarSubElement(){return e5.StandardNotationStaffLine}get showMultiBarRest(){return!0}get lineSpacing(){return oz.RawLineSpacing}get heightLineCount(){return 5}get drawnLineCount(){return this.bar.staff.standardNotationLineCount}registerBeatEffectOverflows(e,t){let i=this.beatEffectsMinY;(null==i||e<i)&&(this.beatEffectsMinY=e);let s=this.beatEffectsMaxY;(null==s||t>s)&&(this.beatEffectsMaxY=t)}getScoreY(e){return super.getLineY(e/2)}getScoreHeight(e){return super.getLineHeight(e/2)}doLayout(){if(super.doLayout(),!this.bar.isEmpty&&this.accidentalHelper.maxLineBeat){let e=this.getScoreY(-2),t=this.getScoreY(10),i=this.simpleWhammyOverflow,s=this.beatEffectsMinY;if(null!==s){let t=e-s;t>0&&this.registerOverflowTop(t)}let a=this.beatEffectsMaxY;if(null!==a){let e=a-t;e>0&&this.registerOverflowBottom(e)}this.registerOverflowTop(i);let r=this.getScoreY(this.accidentalHelper.maxLine),n=this.helpers.getBeamingHelperForBeat(this.accidentalHelper.maxLineBeat);n.direction===tR.Up&&(r-=this.getStemSize(n),n.hasTuplet&&(r-=this.tupletSize)),r<e&&this.registerOverflowTop(Math.abs(r)+i);let o=this.getScoreY(this.accidentalHelper.minLine),l=this.helpers.getBeamingHelperForBeat(this.accidentalHelper.minLineBeat);l.direction===tR.Down&&(o+=this.getStemSize(l),l.hasTuplet&&(o+=this.tupletSize)),o>t&&this.registerOverflowBottom(Math.abs(o)-t)}}paint(e,t,i){super.paint(e,t,i),this.paintBeams(e,t,i,tC.StandardNotationFlags,tC.StandardNotationBeams),this.paintTuplets(e,t,i,tC.StandardNotationTuplet)}getSlashFlagY(e,t){let i=(this.heightLineCount-1)/2,s=0;switch(e){case tt.QuadrupleWhole:case tt.DoubleWhole:case tt.Whole:s+=2;break;default:s+=1}return t===tR.Down?i+=s:i-=s,this.getLineY(i)}getFlagTopY(e,t){return e.slashed?this.getSlashFlagY(e.duration,t):this.getScoreY(this.accidentalHelper.getMinLine(e))}getFlagBottomY(e,t){return e.slashed?this.getSlashFlagY(e.duration,t):this.getScoreY(this.accidentalHelper.getMaxLine(e))}getBeamDirection(e){return e.direction}getStemSize(e,t=!1){let i=1===e.beats.length?this.getFlagStemSize(e.shortestDuration,t):this.getBarStemSize(e.shortestDuration);return e.isGrace&&(i*=nL.GraceScale),i}getBarStemSize(e){let t=0;switch(e){case tt.QuadrupleWhole:case tt.Half:case tt.Quarter:case tt.Eighth:case tt.Sixteenth:t=6;break;case tt.ThirtySecond:t=8;break;case tt.SixtyFourth:case tt.OneHundredTwentyEighth:t=9;break;case tt.TwoHundredFiftySixth:t=10;break;default:t=0}return this.getScoreHeight(t)}get middleYPosition(){return this.getScoreY(this.bar.staff.standardNotationLineCount-1)}getNoteY(e,t){if(e.beat.slashed){let e=(this.heightLineCount-1)/2;return this.getLineY(e)}let i=super.getNoteY(e,t);if(Number.isNaN(i)){let t=sj.computeLineWithoutAccidentals(this.bar,e);i=this.getScoreY(t)}return i}applyLayoutingInfo(){let e=super.applyLayoutingInfo();if(e&&this.bar.isMultiVoice){let e=this.getScoreY(-2),t=this.getScoreY(10),i=this.helpers.collisionHelper.getBeatMinMaxY();i[0]<e&&this.registerOverflowTop(Math.abs(i[0])),i[1]>t&&this.registerOverflowBottom(Math.abs(i[1])-t)}return e}calculateBeamYWithDirection(e,t,i){let s=this.getStemSize(e);if(!e.drawingInfos.has(i)){let t=new om;e.drawingInfos.set(i,t);let a=e.beats[0],r=e.beats[e.beats.length-1],n=e.isRestBeamHelper;if(t.startBeat=a,t.startX=e.getBeatLineX(a),n?t.startY=i===tR.Up?this.getScoreY(e.minRestLine):this.getScoreY(e.maxRestLine):t.startY=i===tR.Up?this.getFlagTopY(a,i)-s:this.getFlagBottomY(a,i)+s,t.endBeat=r,t.endX=e.getBeatLineX(r),n?t.endY=i===tR.Up?this.getScoreY(e.minRestLine):this.getScoreY(e.maxRestLine):t.endY=i===tR.Up?this.getFlagTopY(r,i)-s:this.getFlagBottomY(r,i)+s,i===tR.Down&&t.startY>t.endY&&t.startY-t.endY>10&&(t.endY=t.startY-10),i===tR.Down&&t.endY>t.startY&&t.endY-t.startY>10&&(t.startY=t.endY-10),i===tR.Up&&t.startY<t.endY&&t.endY-t.startY>10&&(t.endY=t.startY+10),i===tR.Up&&t.endY<t.startY&&t.startY-t.endY>10&&(t.startY=t.endY+10),e.beats.length>1){if(i===tR.Up){let i=this.getScoreY(this.accidentalHelper.getMinLine(e.beatOfHighestNote))-s,a=t.calcY(e.getBeatLineX(e.beatOfHighestNote))-i;a>0&&(t.startY-=a,t.endY-=a)}else{let i=this.getScoreY(this.accidentalHelper.getMaxLine(e.beatOfLowestNote))+s-t.calcY(e.getBeatLineX(e.beatOfLowestNote));i>0&&(t.startY+=i,t.endY+=i)}if(null!==e.minRestLine||null!==e.maxRestLine){let s=iW.getIndex(e.shortestDuration)-2,a=e.isGrace?nL.GraceScale:1,r=s*(oz.BeamSpacing+oz.BeamThickness)*a;if(r+=oz.BeamSpacing,i===tR.Up&&null!==e.minRestLine){let i=this.getScoreY(e.minRestLine)-r,s=t.calcY(e.getBeatLineX(e.beatOfMinRestLine))-i;s>0&&(t.startY-=s,t.endY-=s)}else if(i===tR.Down&&null!==e.maxRestLine){let i=this.getScoreY(e.maxRestLine)+r-t.calcY(e.getBeatLineX(e.beatOfMaxRestLine));i>0&&(t.startY+=i,t.endY+=i)}}if(e.slashBeats.length>0)for(let a of e.slashBeats){let r=t.calcY(e.getBeatLineX(a)),n=this.getSlashFlagY(a.duration,i);i===tR.Up?n-=s:i===tR.Down&&(n+=s);let o=n-r;o>0&&(t.startY+=o,t.endY+=o)}}}return e.drawingInfos.get(i).calcY(t)}getBarLineStart(e,t){return e.slashed?this.getSlashFlagY(e.duration,t):t===tR.Up?this.getScoreY(this.accidentalHelper.getMaxLine(e)):this.getScoreY(this.accidentalHelper.getMinLine(e))}createLinePreBeatGlyphs(){let e=!1;if(this.isFirstOfLine||this.bar.clef!==this.bar.previousBar.clef||this.bar.clefOttava!==this.bar.previousBar.clefOttava){let t=0;switch(this.bar.clef){case eK.Neutral:t=this.bar.staff.standardNotationLineCount-1;break;case eK.F4:t=2;break;case eK.C3:t=4;break;case eK.C4:t=2;break;case eK.G2:t=6}this.createStartSpacing(),this.addPreBeatGlyph(new lM(0,this.getScoreY(t)+.5*oz.StaffLineThickness,this.bar.clef,this.bar.clefOttava)),e=!0}(e||0===this.index&&this.bar.keySignature!==e0.C||this.bar.previousBar&&this.bar.keySignature!==this.bar.previousBar.keySignature)&&(this.createStartSpacing(),this.createKeySignatureGlyphs()),(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.createTimeSignatureGlyphs())}createKeySignatureGlyphs(){let e=0,t=this.bar.keySignature,i=this.bar.previousBar?this.bar.previousBar.keySignature:0;switch(this.bar.clef){case eK.Neutral:e=0;break;case eK.G2:e=1;break;case eK.F4:e=3;break;case eK.C3:e=2;break;case eK.C4:e=0}let s=new hT;s.renderer=this;let a=new Map,r=[];if(iW.keySignatureIsSharp(t))for(let i=0;i<Math.abs(t);i++){let t=hN.SharpKsSteps[i]+e;r.push(new lE(0,this.getScoreY(t),tJ.Sharp,1)),a.set(t,!0)}else for(let i=0;i<Math.abs(t);i++){let t=hN.FlatKsSteps[i]+e;r.push(new lE(0,this.getScoreY(t),tJ.Flat,1)),a.set(t,!0)}if(this.bar.keySignature===e0.C){let t=Math.abs(i),r=iW.keySignatureIsSharp(i)?hN.SharpKsSteps:hN.FlatKsSteps;for(let i=0;i<t;i++){let t=r[i]+e;a.has(t)||s.addGlyph(new lE(0,this.getScoreY(r[i]+e),tJ.Natural,1))}}for(let e of r)s.addGlyph(e);this.addPreBeatGlyph(s)}createTimeSignatureGlyphs(){this.addPreBeatGlyph(new l2(0,0,5));let e=this.bar.staff.standardNotationLineCount-1;this.addPreBeatGlyph(new hr(0,this.getScoreY(e),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime))}createVoiceGlyphs(e){for(let t of e.beats){let i=new hc(t,this.getVoiceContainer(e));i.preNotes=new hs,i.onNotes=new l9,this.addBeatGlyph(i)}}getNoteLine(e){return this.accidentalHelper.getNoteLine(e)}completeBeamingHelper(e){if(this.bar.isMultiVoice&&e.highestNoteInHelper&&e.lowestNoteInHelper){let t=this.getNoteY(e.highestNoteInHelper,ir.Center),i=this.getNoteY(e.lowestNoteInHelper,ir.Center),s=this.getStemSize(e);for(let a of(e.hasTuplet&&(s+=2*this.resources.effectFont.size),e.direction===tR.Up?t-=s:i+=s,e.beats))this.helpers.collisionHelper.reserveBeatSlot(a,t,i)}}paintBeamingStem(e,t,i,s,a,r){let n=od.beat(r,tC.StandardNotationStem,e);try{r.lineWidth=oz.StemWidth,r.beginPath(),r.moveTo(i,s),r.lineTo(i,a),r.stroke(),r.lineWidth=1}finally{n?.[Symbol.dispose]?.()}}}hN.StaffId="score",hN.SharpKsSteps=[-1,2,-2,1,4,0,3],hN.FlatKsSteps=[3,0,4,1,5,2,6];class hx extends oo{get staffId(){return hN.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(e,t){return new hN(e,t)}canCreate(e,t){return super.canCreate(e,t)&&t.showStandardNotation}}class hP extends nC{constructor(e,t,i,s){super(0,0),this._inType=e,this._outType=t,this._startNote=i,this._parent=s}doLayout(){this.width=0}paint(e,t,i){this.paintSlideIn(e,t,i),this.paintSlideOut(e,t,i)}paintSlideIn(e,t,i){let s=this.renderer,a=0,r=0,n=0,o=0;switch(this._inType){case to.IntoFromBelow:n=e+s.x+s.getNoteX(this._startNote,io.Left)-2,o=t+s.y+s.getNoteY(this._startNote,ir.Center),a=n-12,r=t+s.y+s.getNoteY(this._startNote,ir.Center)+3;break;case to.IntoFromAbove:n=e+s.x+s.getNoteX(this._startNote,io.Left)-2,o=t+s.y+s.getNoteY(this._startNote,ir.Center),a=n-12,r=t+s.y+s.getNoteY(this._startNote,ir.Center)-3;break;default:return}this.paintSlideLine(i,!1,a,n,r,o)}paintSlideOut(e,t,i){let s=this.renderer,a=0,r=0,n=0,o=0,l=!1;switch(this._outType){case tl.Shift:case tl.Legato:if(a=e+s.x+s.getBeatX(this._startNote.beat,is.PostNotes)+2,r=t+s.y+s.getNoteY(this._startNote,ir.Center),this._startNote.slideTarget){let i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._startNote.slideTarget.beat.voice.bar);i&&i.staff===s.staff?(n=e+i.x+i.getBeatX(this._startNote.slideTarget.beat,is.OnNotes)-2,o=t+i.y+i.getNoteY(this._startNote.slideTarget,ir.Center)):(n=e+s.x+s.width,o=r),this._startNote.slideTarget.fret>this._startNote.fret?(r+=3,o-=3):(r-=3,o+=3)}else n=e+s.x+this._parent.x,o=r;break;case tl.OutUp:a=e+s.x+s.getNoteX(this._startNote,io.Right)+2,r=t+s.y+s.getNoteY(this._startNote,ir.Center),n=a+12,o=t+s.y+s.getNoteY(this._startNote,ir.Center)-3;break;case tl.OutDown:a=e+s.x+s.getNoteX(this._startNote,io.Right)+2,r=t+s.y+s.getNoteY(this._startNote,ir.Center),n=a+12,o=t+s.y+s.getNoteY(this._startNote,ir.Center)+3;break;case tl.PickSlideDown:a=e+s.x+s.getNoteX(this._startNote,io.Right)+4,r=t+s.y+s.getNoteY(this._startNote,ir.Center),n=e+s.x+s.width,o=r+9,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(n=e+s.x+s.getBeatX(this._startNote.beat.nextBeat,is.PreNotes)),l=!0;break;case tl.PickSlideUp:a=e+s.x+s.getNoteX(this._startNote,io.Right)+4,r=t+s.y+s.getNoteY(this._startNote,ir.Center),n=e+s.x+s.width,o=r-9,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(n=e+s.x+s.getBeatX(this._startNote.beat.nextBeat,is.PreNotes)),l=!0;break;default:return}this.paintSlideLine(i,l,a,n,r,o)}paintSlideLine(e,t,i,s,a,r){if(t){let t=new lf(0,0,th.Slight,1.2);t.renderer=this.renderer,t.doLayout(),a-=t.height/2;let n=s-i,o=(r-=t.height/2)-a,l=Math.sqrt(Math.pow(o,2)+Math.pow(n,2));t.width=n;let h=180/Math.PI*Math.asin(o/l);e.beginRotate(i,a,h),t.paint(0,0,e),e.endRotate()}else e.beginPath(),e.moveTo(i,a),e.lineTo(s,r),e.stroke()}}class hv extends lO{constructor(e,t,i=!1){super(e.beat,t.beat,i),this.startNote=e,this.endNote=t}getTieHeight(e,t,i,s){return this.startNote===this.endNote?15:super.getTieHeight(e,t,i,s)}getBeamDirection(e,t){return this.startNote===this.endNote?tR.Up:hv.getBeamDirectionForNote(this.startNote)}static getBeamDirectionForNote(e){return e.string>3?tR.Up:tR.Down}getStartY(){return this.startNote===this.endNote?this.startNoteRenderer.getNoteY(this.startNote,ir.Center):this.tieDirection===tR.Up?this.startNoteRenderer.getNoteY(this.startNote,ir.Top):this.startNoteRenderer.getNoteY(this.startNote,ir.Bottom)}getEndY(){return this.getStartY()}getStartX(){return this.startNote===this.endNote?this.getEndX()-20:this.startNoteRenderer.getNoteX(this.startNote,io.Center)}getEndX(){return this.startNote===this.endNote?this.endNoteRenderer.getNoteX(this.endNote,io.Left):this.endNoteRenderer.getNoteX(this.endNote,io.Center)}}class hF extends hv{constructor(e,t,i,s=!1){super(e,t,s),this._direction=hv.getBeamDirectionForNote(e),this._forSlide=i}getTieHeight(e,t,i,s){return Math.log(i-e+1)*this.renderer.settings.notation.slurHeight}tryExpand(e,t,i,s){if(this._forSlide!==i||this.forEnd!==s||this.startNote.beat.id!==e.beat.id||this.endNote.beat.id!==t.beat.id||this._direction!==hv.getBeamDirectionForNote(e))return!1;switch(this._direction){case tR.Up:e.realValue>this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue>this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat);break;case tR.Down:e.realValue<this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue<this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat)}return!0}paint(e,t,i){let s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar),a=this.getBeamDirection(this.startBeat,s),r=`tab.slur.${this.startNote.beat.id}.${this.endNote.beat.id}.${a}`,n=this.renderer;n.staff.getSharedLayoutData(r,!1)||(n.staff.setSharedLayoutData(r,!0),super.paint(e,t,i))}}class hC extends nA{constructor(){super(...arguments),this._bend=null,this._effectSlurs=[]}drawBeamHelperAsFlags(e){return e.hasFlag(this.renderer.drawBeamHelperAsFlags(e),this.beat)}doLayout(){this._effectSlurs=[],super.doLayout(),this._bend&&(this._bend.renderer=this.renderer,this._bend.doLayout(),this.updateWidth())}createTies(e){if(!e.isVisible)return;let t=this.renderer;if(e.isTieOrigin&&t.showTiedNotes&&e.tieDestination.isVisible){let t=new hv(e,e.tieDestination,!1);this.addTie(t)}if(e.isTieDestination&&t.showTiedNotes){let t=new hv(e.tieOrigin,e,!0);this.addTie(t)}if(e.isLeftHandTapped&&!e.isHammerPullDestination){let t=new hv(e,e,!1);this.addTie(t)}if(e.isEffectSlurOrigin&&e.effectSlurDestination){let t=!1;for(let i of this._effectSlurs)if(i.tryExpand(e,e.effectSlurDestination,!1,!1)){t=!0;break}if(!t){let t=new hF(e,e.effectSlurDestination,!1,!1);this._effectSlurs.push(t),this.addTie(t)}}if(e.isEffectSlurDestination&&e.effectSlurOrigin){let t=!1;for(let i of this._effectSlurs)if(i.tryExpand(e.effectSlurOrigin,e,!1,!0)){t=!0;break}if(!t){let t=new hF(e.effectSlurOrigin,e,!1,!0);this._effectSlurs.push(t),this.addTie(t)}}if(e.slideInType!==to.None||e.slideOutType!==tl.None){let t=new hP(e.slideInType,e.slideOutType,e,this);this.addTie(t)}if(e.hasBend){if(!this._bend){let e=new lZ;this._bend=e,e.renderer=this.renderer,this.addTie(e)}this._bend.addBends(e)}}}class hD extends nC{constructor(e,t,i){super(e,t),this._noteString=null,this._trillNoteString=null,this._trillNoteStringWidth=0,this.isEmpty=!1,this.noteStringWidth=0,this._note=i}doLayout(){let e=this._note,t=e.fret-e.beat.voice.bar.staff.transpositionPitch;if(e.harmonicType===tr.Natural&&0!==e.harmonicValue&&(t=e.harmonicValue-e.beat.voice.bar.staff.transpositionPitch),e.isTieDestination)0===e.beat.index&&this.renderer.settings.notation.notationMode===tu.GuitarPro||(e.bendType===e7.Bend||e.bendType===e7.BendRelease)&&this.renderer.settings.notation.isNotationElementVisible(tp.TabNotesOnTiedBends)?this._noteString=`(${(e.tieOrigin.fret-e.beat.voice.bar.staff.transpositionPitch).toString()})`:this._noteString="";else if(this._noteString=e.isDead?"x":t.toString(),e.isGhost)this._noteString=`(${this._noteString})`;else if(e.harmonicType===tr.Natural){let e=this._noteString.indexOf(".");e>=0&&(this._noteString=this._noteString.substr(0,e+2)),this._noteString=`<${this._noteString}>`}if(e.isTrill)this._trillNoteString=`(${(e.trillFret-e.beat.voice.bar.staff.transpositionPitch).toString()})`;else if(iW.isAlmostEqualTo(e.harmonicValue,0))this._trillNoteString="";else switch(e.harmonicType){case tr.Artificial:case tr.Pinch:case tr.Tap:case tr.Semi:case tr.Feedback:let i=(t+e.harmonicValue).toString(),s=i.indexOf(".");s>=0&&(i=i.substr(0,s+2)),this._trillNoteString=`<${i}>`;break;default:this._trillNoteString=""}this.isEmpty=!this._noteString,!this.isEmpty&&(this.renderer.scoreRenderer.canvas.font=this.renderer.resources.tablatureFont,this.noteStringWidth=this.renderer.scoreRenderer.canvas.measureText(this._noteString).width,this.width=this.noteStringWidth,this.height=this.renderer.scoreRenderer.canvas.font.size,this._trillNoteString&&(this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,this._trillNoteStringWidth=3+this.renderer.scoreRenderer.canvas.measureText(this._trillNoteString).width,this.width+=this._trillNoteStringWidth))}paint(e,t,i){if(this.isEmpty)return;let s=this.noteStringWidth+this._trillNoteStringWidth,a=e+this.x+(this.width-s)/2;this.paintTrill(a,t,i);let r=od.note(i,tk.GuitarTabFretNumber,this._note);try{i.fillText(this._noteString,a,t+this.y)}finally{r?.[Symbol.dispose]?.()}}paintTrill(e,t,i){let s=od.note(i,tk.GuitarTabFretNumber,this._note);try{let s=this.renderer.scoreRenderer.canvas.font;this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,i.fillText(this._trillNoteString,e+this.noteStringWidth+3,t+this.y),this.renderer.scoreRenderer.canvas.font=s}finally{s?.[Symbol.dispose]?.()}}buildBoundingsLookup(e,t,i){let s=new nh;s.note=this._note,s.noteHeadBounds=new sy,s.noteHeadBounds.x=t+this.x,s.noteHeadBounds.y=i+this.y-this.height/2,s.noteHeadBounds.w=this.width,s.noteHeadBounds.h=this.height,e.addNote(s)}}class hE extends nC{constructor(e,t,i){super(e,t),this._notes=[],this._deadSlapped=null,this.minStringNote=null,this.beatEffects=new Map,this.notesPerString=new Map,this.noteStringWidth=0,this._isGrace=i}buildBoundingsLookup(e,t,i){for(let s of this._notes)s.buildBoundingsLookup(e,t+this.x,i+this.y)}getNoteX(e,t){if(this.notesPerString.has(e.string)){let i=this.notesPerString.get(e.string),s=this.x+i.x;switch(t){case io.Left:break;case io.Center:s+=i.noteStringWidth/2;break;case io.Right:s+=i.width}return s}return 0}getNoteY(e,t){if(this.notesPerString.has(e.string)){let i=this.notesPerString.get(e.string),s=this.y+i.y;switch(t){case ir.Top:case ir.TopWithStem:s-=i.height/2+2;break;case ir.Center:break;case ir.Bottom:case ir.BottomWithStem:s+=i.height/2}return s}return 0}doLayout(){let e=0;if(this.beat.deadSlapped)this._deadSlapped=new lX,this._deadSlapped.renderer=this.renderer,this._deadSlapped.doLayout(),e=this._deadSlapped.width,this.noteStringWidth=e;else{let t=0;for(let i=0,s=this._notes.length;i<s;i++){let s=this._notes[i];s.renderer=this.renderer,s.doLayout(),s.width>e&&(e=s.width),s.noteStringWidth>t&&(t=s.noteStringWidth)}this.noteStringWidth=t;let i=this.renderer.resources.tablatureFont.size,s=this.getNoteY(this.minStringNote,ir.Center)+i/2;for(let e of this.beatEffects.values())e.y+=s,e.x+=this.width/2,e.renderer=this.renderer,s+=7,e.doLayout()}this.width=e}addNoteGlyph(e,t){this._notes.push(e),this.notesPerString.set(t.string,e),(!this.minStringNote||t.string<this.minStringNote.string)&&(this.minStringNote=t)}paint(e,t,i){if(e+=this.x,t+=this.y,this.beat.deadSlapped)this._deadSlapped?.paint(e,t,i);else{let s=this.renderer.resources,a=i.textBaseline;i.textBaseline=t_.Middle,i.font=this._isGrace?s.graceFont:s.tablatureFont;let r=this._notes,n=this.width;for(let s of r)s.renderer=this.renderer,s.width=n,s.paint(e,t,i);i.textBaseline=a;let o=od.beat(i,tC.GuitarTabEffects,this.beat);try{for(let s of this.beatEffects.values())s.paint(e,t,i)}finally{o?.[Symbol.dispose]?.()}}}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}}class hM extends nM{constructor(e,t,i,s){super(e,t,1,lY.getSymbol(s)),this._isVisibleRest=i}doLayout(){super.doLayout(),this._isVisibleRest||(this.width=10)}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}paint(e,t,i){if(this._isVisibleRest){let s=od.beat(i,tC.GuitarTabRests,this.beat);try{super.paint(e,t,i)}finally{s?.[Symbol.dispose]?.()}}}}class hL extends oH{constructor(){super(...arguments),this.slash=null,this.noteNumbers=null,this.restGlyph=null}get effectElement(){return tC.GuitarTabEffects}getNoteX(e,t){return this.noteNumbers?this.noteNumbers.getNoteX(e,t):0}getNoteY(e,t){return this.noteNumbers?this.noteNumbers.getNoteY(e,t):0}buildBoundingsLookup(e,t,i){this.noteNumbers&&this.noteNumbers.buildBoundingsLookup(e,t+this.x,i+this.y)}doLayout(){let e=this.renderer;if(this.container.beat.isRest){let t=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),i=e.getTabY(t),s=new hM(0,i,e.showRests,this.container.beat.duration);if(this.restGlyph=s,s.beat=this.container.beat,s.beamingHelper=this.beamingHelper,this.addNormal(s),this.container.beat.dots>0&&e.showRests){this.addNormal(new l2(0,0,5));for(let e=0;e<this.container.beat.dots;e++)this.addEffect(new lI(0,i,1.5))}}else{let t,i=this.renderer.settings.notation.smallGraceTabNotes&&this.container.beat.graceType!==ti.None;if(this.container.beat.slashed&&!this.container.beat.notes.some(e=>e.isTieDestination)){let s=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),a=new l7(0,e.getLineY(s),this.container.beat.duration,i,this.container.beat);a.noteHeadElement=tk.GuitarTabFretNumber,a.effectElement=tC.GuitarTabEffects,this.slash=a,a.beat=this.container.beat,a.beamingHelper=this.beamingHelper,this.addNormal(a),t=a.beatEffects}else{let e=new hE(0,0,i);for(let t of(this.noteNumbers=e,e.beat=this.container.beat,e.beamingHelper=this.beamingHelper,this.container.beat.notes))t.isVisible&&this.createNoteGlyph(t);this.addNormal(e),t=e.beatEffects}if(this.container.beat.hasWhammyBar){let e=new l0(this.container.beat);e.renderer=this.renderer,e.doLayout(),this.container.ties.push(e)}if(this.container.beat.isTremolo&&!t.has("tremolo")){let e=0,i=this.container.beat.tremoloSpeed,s=5;switch(i){case tt.ThirtySecond:e=10;break;case tt.Sixteenth:e=5;break;case tt.Eighth:e=0}this.container.beat.duration<tt.Half&&(s=0),t.set("tremolo",new lU(s,e,i))}if(this.container.beat.dots>0&&e.rhythmMode!==td.Hidden){this.addNormal(new l2(0,0,5));for(let t=0;t<this.container.beat.dots;t++)this.addEffect(new lI(0,e.lineOffset*e.bar.staff.tuning.length+e.settings.notation.rhythmHeight,1.5))}}if(this.isEmpty)return;let t=0;for(let e=0,i=this.glyphs.length;e<i;e++){let i=this.glyphs[e];i.x=t,i.renderer=this.renderer,i.doLayout(),t+=i.width}this.width=t,this.computedWidth=t,this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteNumbers?this.centerX=this.noteNumbers.x+this.noteNumbers.noteStringWidth/2:this.slash&&(this.centerX=this.slash.x+this.slash.width/2)}updateBeamingHelper(){this.noteNumbers?this.noteNumbers.updateBeamingHelper(this.container.x+this.x):this.restGlyph?this.restGlyph.updateBeamingHelper(this.container.x+this.x):this.slash&&this.slash.updateBeamingHelper(this.container.x+this.x)}createNoteGlyph(e){let t=this.renderer,i=new hD(0,0,e),s=e.beat.voice.bar.staff.tuning.length-e.string;i.y=t.getTabY(s),i.renderer=this.renderer,i.doLayout(),this.noteNumbers.addNoteGlyph(i,e);let a=i.y-i.height/2,r=a+i.height;this.renderer.helpers.collisionHelper.reserveBeatSlot(this.container.beat,a,r)}}class hI extends nC{constructor(e){super(0,0),this._beat=e}doLayout(){this.width=10}paint(e,t,i){let s=this.renderer,a=t+this.x+s.getNoteY(this._beat.maxStringNote,ir.Top),r=t+this.y+s.getNoteY(this._beat.minStringNote,ir.Bottom),n=e+this.x+this.width/2|0;if(this._beat.brushType!==e9.None){if(this._beat.brushType===e9.BrushUp||this._beat.brushType===e9.BrushDown)i.beginPath(),i.moveTo(n,a),i.lineTo(n,r),i.stroke();else if(this._beat.brushType===e9.ArpeggioUp){let t=new lf(0,0,th.Slight,1.2,!0);t.renderer=this.renderer,t.doLayout();let s=r-8;t.width=Math.abs(s-a),i.beginRotate(e+this.x+4,s,-90),t.paint(0,-t.height/2,i),i.endRotate()}else if(this._beat.brushType===e9.ArpeggioDown){let t=new lf(0,0,th.Slight,1.2,!0);t.renderer=this.renderer,t.doLayout();let s=a+8;t.width=Math.abs(r-s),i.beginRotate(e+this.x+4,s,90),t.paint(0,-t.height/2,i),i.endRotate()}this._beat.brushType===e9.BrushUp||this._beat.brushType===e9.ArpeggioUp?(i.beginPath(),i.moveTo(n,r),i.lineTo(n+4,r-8),i.lineTo(n-4,r-8)):(i.beginPath(),i.moveTo(n,a),i.lineTo(n+4,a+8),i.lineTo(n-4,a+8)),i.closePath(),i.fill()}}}class hA extends oO{doLayout(){this.container.beat.brushType===e9.None||this.container.beat.isRest||(this.addEffect(new hI(this.container.beat)),this.addNormal(new l2(0,0,4))),super.doLayout()}get effectElement(){return tC.GuitarTabEffects}}class hR extends nC{doLayout(){this.width=nE.Widths.get(tb.SixStringTabClef)}paint(e,t,i){let s=od.bar(i,e5.GuitarTabsClef,this.renderer.bar);try{let s=this.renderer.bar.staff.tuning.length,a=s<=4?tb.FourStringTabClef:tb.SixStringTabClef;i.fillMusicFontSymbol(e+this.x+5,t+this.y,s<=4?s/4.5:s/6.5,a,!1)}finally{s?.[Symbol.dispose]?.()}}}class hO extends ha{doLayout(){this.barSubElement=e5.GuitarTabsTimeSignature,super.doLayout()}get commonScale(){return 1}get numberScale(){return this.renderer.bar.staff.tuning.length<=4?nL.GraceScale:1}}class hH extends hB{get showMultiBarRest(){return this._showMultiBarRest}get repeatsBarSubElement(){return e5.GuitarTabsRepeats}get barNumberBarSubElement(){return e5.GuitarTabsBarNumber}get barLineBarSubElement(){return e5.GuitarTabsBarLines}get staffLineBarSubElement(){return e5.GuitarTabsStaffLine}constructor(e,t){super(e,t),this._hasTuplets=!1,this.showTimeSignature=!1,this.showRests=!1,this.showTiedNotes=!1,this._showMultiBarRest=!1,t.staff.showStandardNotation||(this.showTimeSignature=!0,this.showRests=!0,this.showTiedNotes=!0,this._showMultiBarRest=!0)}get lineSpacing(){return hH.TabLineSpacing}get heightLineCount(){return this.bar.staff.tuning.length}get drawnLineCount(){return this.bar.staff.tuning.length}get rhythmMode(){let e=this.settings.notation.rhythmMode;return e===td.Automatic&&(e=this.bar.staff.showStandardNotation?td.Hidden:td.ShowWithBars),e}getTabY(e){return super.getLineY(e)}getTabHeight(e){return super.getLineHeight(e)}collectSpaces(e){for(let t of this.bar.voices)if(this.hasVoiceContainer(t)){let i=this.getVoiceContainer(t);for(let t of i.beatGlyphs){let s=t.onNotes,a=s.noteNumbers;if(a)for(let[r,n]of a.notesPerString)n.isEmpty||e[this.bar.staff.tuning.length-r].push(new Float32Array([i.x+t.x+s.x+a.x,a.width+1]))}}}adjustSizes(){this.rhythmMode!==td.Hidden&&(this.height+=this.settings.notation.rhythmHeight,this.bottomPadding+=this.settings.notation.rhythmHeight)}doLayout(){if(super.doLayout(),this.rhythmMode!==td.Hidden){for(let e of(this._hasTuplets=!1,this.bar.voices))if(this.hasVoiceContainer(e)&&this.getVoiceContainer(e).tupletGroups.length>0){this._hasTuplets=!0;break}this._hasTuplets&&this.registerOverflowBottom(this.tupletSize)}}createLinePreBeatGlyphs(){if(this.isFirstOfLine){let e=(this.bar.staff.tuning.length-1)/2;this.addPreBeatGlyph(new hR(5,this.getTabY(e)))}this.showTimeSignature&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.createTimeSignatureGlyphs())}createTimeSignatureGlyphs(){this.addPreBeatGlyph(new l2(0,0,5));let e=(this.bar.staff.tuning.length+1)/2-1;this.addPreBeatGlyph(new hO(0,this.getTabY(e),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime))}createVoiceGlyphs(e){if(this.additionalMultiRestBars){let t=new oG(this.getVoiceContainer(e));this.addBeatGlyph(t)}else for(let t of e.beats){let i=new hC(t,this.getVoiceContainer(e));i.preNotes=new hA,i.onNotes=new hL,this.addBeatGlyph(i)}}paint(e,t,i){super.paint(e,t,i),this.rhythmMode!==td.Hidden&&(this.paintBeams(e,t,i,tC.GuitarTabFlags,tC.GuitarTabBeams),this.paintTuplets(e,t,i,tC.GuitarTabTuplet))}drawBeamHelperAsFlags(e){return super.drawBeamHelperAsFlags(e)||this.rhythmMode===td.ShowWithBeams}getFlagTopY(e,t){let i=this.getOnNotesGlyphForBeat(e);return i.noteNumbers&&e.duration!==tt.Half?i.noteNumbers.getNoteY(i.noteNumbers.minStringNote,ir.Bottom):this.height-this.settings.notation.rhythmHeight-this.tupletSize}getFlagBottomY(e,t){return this.getFlagAndBarPos()}getFlagStemSize(e,t=!1){return 0}getBarLineStart(e,t){let i=this.getOnNotesGlyphForBeat(e);return i.noteNumbers&&e.duration!==tt.Half?i.noteNumbers.getNoteY(i.noteNumbers.minStringNote,ir.Bottom)+this.lineOffset/2:this.height-this.settings.notation.rhythmHeight-this.tupletSize}getBeamDirection(e){return tR.Down}getFlagAndBarPos(){return this.height-(this._hasTuplets?this.tupletSize/2:0)}calculateBeamYWithDirection(e,t,i){return this.getFlagAndBarPos()}shouldPaintFlag(e,t){return!!super.shouldPaintFlag(e,t)&&e.graceType===ti.None&&this.drawBeamHelperAsFlags(t)}paintBeamingStem(e,t,i,s,a,r){if(a<s){let e=a;a=s,s=e}let n=od.beat(r,tC.GuitarTabStem,e);try{r.lineWidth=oz.StemWidth,r.beginPath();let n=[];this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.has(e.displayStart)&&(n=this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.get(e.displayStart).slots.slice()).sort((e,t)=>e.topY-t.topY);let o=a;for(;o>s;){r.moveTo(i,o);let e=s;if(n.length>0&&n[n.length-1].bottomY>e){let s=n.pop();e=t+s.bottomY,r.lineTo(i,e),o=t+s.topY}else{r.lineTo(i,e);break}}r.stroke(),r.lineWidth=1}finally{n?.[Symbol.dispose]?.()}}}hH.StaffId="tab",hH.TabLineSpacing=10;class hV extends oo{get staffId(){return hH.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}constructor(){super(),this.showTimeSignature=null,this.showRests=null,this.showTiedNotes=null,this.hideOnPercussionTrack=!0}canCreate(e,t){return t.showTablature&&t.tuning.length>0&&super.canCreate(e,t)}create(e,t){let i=new hH(e,t);return null!==this.showRests&&(i.showRests=this.showRests),null!==this.showTimeSignature&&(i.showTimeSignature=this.showTimeSignature),null!==this.showTiedNotes&&(i.showTiedNotes=this.showTiedNotes),i}}class hW extends nD{constructor(){super(0,0)}doLayout(){super.doLayout();let e=this.renderer.resources.effectFont;this.height=e.size+hW.Padding}paint(e,t,i){i.font=this.renderer.resources.effectFont;let s=i.textAlign;i.textAlign=tS.Center,i.fillText("T",e+this.x,t+this.y+i.font.size/2),i.textAlign=s,i.strokeCircle(e+this.x,t+this.y+i.font.size/2+(hW.Padding-1),i.font.size/1.6)}}hW.Padding=4;class hG extends lt{get notationElement(){return tp.EffectTap}get sizingMode(){return il.SingleOnBeat}shouldCreateGlyphForNote(e){return e.isLeftHandTapped}createNewGlyph(e,t){return new hW}}class hz{constructor(){this.noteRange=1,this.x=0,this.y=0}}(eH=id||(id={}))[eH.None=0]="None",eH[eH.Rectangle=1]="Rectangle",eH[eH.Ellipse=2]="Ellipse",eH[eH.Circle=3]="Circle";class hU extends hz{constructor(){super(...arguments),this.align=tS.Left,this.frame=id.None,this.text="",this.fontFace="",this.weight=0,this.height=0}}class hX extends hz{constructor(){super(...arguments),this.chord=new i7}}class hJ extends hz{}class hY extends hz{}class hq extends hz{constructor(){super(...arguments),this.number=0}}class h$ extends hz{constructor(){super(...arguments),this.decrescendo=!1}}class hj extends hz{constructor(){super(...arguments),this.allNumbers=!1,this.firstNumber=0,this.lastNumber=0}}class hK extends hz{constructor(){super(...arguments),this.octave=1}}class hQ extends hz{}class hZ{constructor(){this.defaultClef=eK.G2,this.description="",this.percussion=!1,this.instrument=0,this.volume=0,this.transpose=0,this.index=0}}class h0{constructor(){this.from=0,this.to=0,this.curly=!1}}class h1{constructor(){this.currentBarIndex=-1,this.currentBarComplete=!0,this.currentBarDuration=0,this.currentPosition=0,this.voiceStemDir=null,this.repeatCount=0,this.repeatEnd=null}}class h2{constructor(){this._trackChannel=0,this._beamingMode=tF.Auto,this._isFirstSystem=!0,this._staffLookup=new Map,this._brackets=[],this._staffLayoutLookup=new Map,this._staffLayouts=[],this._timeSignature=new iL,this._voiceStates=new Map}parseXml(e,t){this._galleryObjects=new Map,this._tieStarts=[],this._tieStartIds=new Map,this._voiceCounts=new Map,this._slurs=new Map,this._crescendo=new Map,this._isFirstSystem=!0;let i=new sB;try{i.parse(e)}catch(e){throw new i8("Could not parse XML",e)}this.parseDom(i),this.consolidate(),this.score.finish(t)}consolidate(){iW.consolidate(this.score),h2.applyEffectRange(this._slurs,(e,t)=>{t.isLegatoOrigin=!0}),h2.applyEffectRange(this._crescendo,(e,t)=>{t.crescendo=e.decrescendo?te.Decrescendo:te.Crescendo})}static applyEffectRange(e,t){for(let[i,s]of e){let e=s.noteRange,a=i;for(let i=0;i<e;i++)if(t(s,a),a.index+1<a.voice.beats.length)a=a.voice.beats[a.index+1];else if(a.voice.bar.index+1<a.voice.bar.staff.bars.length)a=a.voice.bar.staff.bars[a.voice.bar.index+1].voices[a.voice.index].beats[0];else break}}parseDom(e){let t=e.firstElement;if(!t)throw new i8("No valid XML");if("score"===t.localName)for(let e of(this.score=new i3,this.score.tempo=120,t.childElements()))switch(e.localName){case"info":this.parseInfo(e);break;case"layout":this.parseLayout(e);break;case"gallery":this.parseGallery(e);break;case"pageObjects":this.parsePageObjects(e);break;case"systems":this.parseSystems(e)}else throw new i8('Root node of XML was not "score"')}parseLayout(e){for(let t of e.childElements())switch(t.localName){case"staves":this.parseLayoutStaves(t);break;case"brackets":this.parseBrackets(t)}let t=this._brackets.filter(e=>!!e.curly);t.sort((e,t)=>e.from-t.from);let i=0,s=null;for(let e=0;e<this._staffLayouts.length;e++){let a=this._staffLayouts[e];for(;i<t.length&&e>t[i].to;)i++;s&&i<t.length&&e>t[i].from&&e<=t[i].to?s.ensureStaveCount(s.staves.length+1):((s=new so).ensureStaveCount(1),s.name=a.description,s.playbackInfo.volume=Math.floor(a.volume/128*16),s.playbackInfo.program=a.instrument,a.percussion?(s.playbackInfo.primaryChannel=9,s.playbackInfo.secondaryChannel=9):(s.playbackInfo.primaryChannel=this._trackChannel++,s.playbackInfo.secondaryChannel=this._trackChannel++),this.score.addTrack(s));let r=s.staves[s.staves.length-1];r.isPercussion=a.percussion,r.transpositionPitch=a.transpose,r.displayTranspositionPitch=0,r.showTablature=!1,this._staffLookup.set(a.index,r)}}parseBrackets(e){for(let t of e.childElements())"bracket"===t.localName&&this.parseBracket(t)}parseBracket(e){let t=new h0;t.from=Number.parseInt(e.getAttribute("from")),t.to=Number.parseInt(e.getAttribute("to")),e.attributes.has("curly")&&(t.curly="true"===e.attributes.get("curly")),this._brackets.push(t)}parseLayoutStaves(e){for(let t of e.childElements())"staffLayout"===t.localName&&this.parseStaffLayout(t)}parseStaffLayout(e){let t=new hZ;for(let i of(t.description=e.getAttribute("description"),e.childElements()))switch(i.localName){case"notation":i.attributes.has("defaultClef")&&(t.defaultClef=this.parseClef(i.attributes.get("defaultClef")));break;case"sound":i.attributes.has("percussion")&&(t.percussion="true"===i.attributes.get("percussion")),i.attributes.has("instr")&&(t.instrument=Number.parseInt(i.attributes.get("instr"))),i.attributes.has("volume")&&(t.volume=Number.parseInt(i.attributes.get("volume"))),i.attributes.has("transpose")&&(t.transpose=Number.parseInt(i.attributes.get("transpose")))}this._staffLayoutLookup.set(t.description,t),t.index=this._staffLayouts.length,this._staffLayouts.push(t)}parseClef(e){switch(e){case"treble":break;case"bass":return eK.F4;case"alto":case"tenor":return eK.C4}return eK.G2}parseClefOttava(e){return e.endsWith("-")?eQ._8vb:e.endsWith("+")?eQ._8va:eQ.Regular}parseSystems(e){for(let t of e.childElements())"system"===t.localName&&this.parseSystem(t)}parseSystem(e){for(let t of(e.attributes.has("tempo")&&0===this.score.masterBars.length&&(this.score.tempo=Number.parseInt(e.attributes.get("tempo"))),"0"===e.getAttribute("beamGrouping")&&(this._beamingMode=tF.ForceSplitToNext),e.childElements()))"staves"===t.localName&&this.parseStaves(e,t);this._isFirstSystem=!1}parseStaves(e,t){let i=this.score.masterBars.length;for(let s of t.childElements())"staff"===s.localName&&this.parseStaff(e,i,s)}parseStaff(e,t,i){let s=i.getAttribute("layout");this._currentStaffLayout=this._staffLayoutLookup.get(s),this._timeSignature.timeSignatureNumerator=4,this._timeSignature.timeSignatureDenominator=4,this._timeSignature.timeSignatureCommon=!1,this.parseTime(i.getAttribute("defaultTime"));let a=this._staffLookup.get(this._currentStaffLayout.index);for(;a.bars.length<t;)this.addNewBar(a);for(let r of i.childElements())"voices"===r.localName&&this.parseVoices(s,a,e,t,r)}parseTime(e){switch(e){case"allaBreve":case"C":this._timeSignature.timeSignatureNumerator=2,this._timeSignature.timeSignatureDenominator=2,this._timeSignature.timeSignatureCommon=!0;break;case"longAllaBreve":this._timeSignature.timeSignatureNumerator=4,this._timeSignature.timeSignatureDenominator=4,this._timeSignature.timeSignatureCommon=!0;break;default:if(e.indexOf("/")>0){let t=e.split("/");this._timeSignature.timeSignatureNumerator=Number.parseInt(t[0]),this._timeSignature.timeSignatureDenominator=Number.parseInt(t[1]),this._timeSignature.timeSignatureCommon=!1}}}parseVoices(e,t,i,s,a){let r=0;for(let n of a.childElements())"voice"===n.localName&&(this.parseVoice(e,t,i,r,s,n),r++)}getOrCreateBar(e,t){return t<e.bars.length?e.bars[t]:this.addNewBar(e)}addNewBar(e){let t=new iN;if(e.bars.length>0?(t.clef=e.bars[e.bars.length-1].clef,t.clefOttava=e.bars[e.bars.length-1].clefOttava,t.keySignature=e.bars[e.bars.length-1].keySignature,t.keySignatureType=e.bars[e.bars.length-1].keySignatureType):t.clef=this._currentStaffLayout.defaultClef,e.addBar(t),e.bars.length>this.score.masterBars.length){let e=new iL;this.score.addMasterBar(e),e.index>0&&(e.tripletFeel=e.previousMasterBar.tripletFeel),e.timeSignatureDenominator=this._timeSignature.timeSignatureDenominator,e.timeSignatureNumerator=this._timeSignature.timeSignatureNumerator,e.timeSignatureCommon=this._timeSignature.timeSignatureCommon}return t}newBar(e,t){this._currentVoiceState.currentBarIndex++,this._currentBar=this.getOrCreateBar(e,this._currentVoiceState.currentBarIndex),this._currentVoiceState.currentBarDuration=this._currentBar.masterBar.calculateDuration(!1),this._currentVoiceState.currentBarComplete=!1,this._currentVoiceState.currentPosition=0,this.ensureVoice(e,t)}parseVoice(e,t,i,s,a,r){let n=`${e}_${s}`;if(this._currentVoiceState&&!this._currentVoiceState.currentBarComplete&&(this._currentBar.masterBar.isAnacrusis=!0),this._voiceStates.has(n)?(this._currentVoiceState=this._voiceStates.get(n),this._currentBar=this.getOrCreateBar(t,this._currentVoiceState.currentBarIndex),this.ensureVoice(t,s)):(this._currentVoiceState=new h1,this._currentVoiceState.currentBarIndex=a-1,this._voiceStates.set(n,this._currentVoiceState),this.newBar(t,s)),r.attributes.has("stemDir"))switch(r.attributes.get("stemDir")){case"up":this._currentVoiceState.voiceStemDir=tR.Up;break;case"down":this._currentVoiceState.voiceStemDir=tR.Down;break;default:this._currentVoiceState.voiceStemDir=null}else this._currentVoiceState.voiceStemDir=null;let o=r.findChildElement("noteObjects");if(i.attributes.has("tempo")){let e=new iv;e.isLinear=!0,e.type=e6.Tempo,e.value=Number.parseInt(i.attributes.get("tempo")),e.ratioPosition=this._currentVoiceState.currentPosition/this._currentVoiceState.currentBarDuration,this._currentBar.masterBar.tempoAutomations.push(e)}if(o)for(let e of o.childElements())switch(this._currentVoiceState.currentBarComplete&&"barline"!==e.localName&&this.newBar(t,s),e.localName){case"clefSign":this._currentBar.clef=this.parseClef(e.getAttribute("clef")),this._currentBar.clefOttava=this.parseClefOttava(e.getAttribute("clef"));break;case"keySign":this._currentBar.keySignature=Number.parseInt(e.getAttribute("fifths"));break;case"timeSign":this.parseTime(e.getAttribute("time")),this._currentBar.masterBar.timeSignatureDenominator=this._timeSignature.timeSignatureDenominator,this._currentBar.masterBar.timeSignatureNumerator=this._timeSignature.timeSignatureNumerator,this._currentBar.masterBar.timeSignatureCommon=this._timeSignature.timeSignatureCommon,this._currentVoiceState.currentPosition=0,this._currentVoiceState.currentBarDuration=this._currentBar.masterBar.calculateDuration(!1);break;case"barline":switch(e.getAttribute("type")){case"double":this._currentBar.barLineRight=e3.LightLight,this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;case"end":this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0);break;case"repEnd":this._currentVoiceState.repeatEnd=this._currentBar.masterBar,this._currentBar.masterBar.repeatCount<this._currentVoiceState.repeatCount&&(this._currentBar.masterBar.repeatCount=this._currentVoiceState.repeatCount),this.parseBarDrawObject(e),this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;case"repBegin":this.newBar(t,s),this._currentBar.masterBar.isRepeatStart=!0,this._currentVoiceState.repeatEnd=null,this._currentVoiceState.repeatCount=0;break;case"repEndBegin":this._currentVoiceState.repeatEnd=this._currentBar.masterBar,this._currentBar.masterBar.repeatCount<this._currentVoiceState.repeatCount&&(this._currentBar.masterBar.repeatCount=this._currentVoiceState.repeatCount),this.parseBarDrawObject(e),this.newBar(t,s),this._currentBar.masterBar.isRepeatStart=!0;break;default:this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0}break;case"chord":let i=new i1;this.initFromPreviousBeat(i,this._currentVoice),i.beamingMode=this._beamingMode,this._currentVoiceState.voiceStemDir&&(i.preferredBeamDirection=this._currentVoiceState.voiceStemDir),this.parseDuration(this._currentBar,i,e.findChildElement("duration")),i.updateDurations(),this._currentVoiceState.currentPosition+=i.playbackDuration,this._currentVoice.addBeat(i),this.parseChord(i,e),this._currentVoiceState.currentPosition>=this._currentVoiceState.currentBarDuration&&(this._currentVoiceState.currentBarComplete=!0);break;case"rest":let a=this.parseRestDurations(this._currentBar,e.findChildElement("duration"));a&&(this.initFromPreviousBeat(a,this._currentVoice),a.updateDurations(),this._currentVoiceState.currentPosition+=a.playbackDuration,this._currentVoice.addBeat(a),this._currentVoiceState.currentPosition>=this._currentVoiceState.currentBarDuration&&(this._currentVoiceState.currentBarComplete=!0))}}initFromPreviousBeat(e,t){let i=this.getLastBeat(t);i&&(e.dynamics=i.dynamics)}getLastBeat(e){if(e.beats.length>0)return e.beats[e.beats.length-1];if(e.bar.index>0){let t=e.bar.staff.bars[e.bar.index-1];if(e.index<t.voices.length){let i=t.voices[e.index];return this.getLastBeat(i)}}return null}ensureVoice(e,t){for(;this._currentBar.voices.length<t+1;)this._currentBar.addVoice(new iO);(!this._voiceCounts.has(e.track.index)||this._voiceCounts.get(e.track.index)<this._currentBar.voices.length)&&this._voiceCounts.set(e.track.index,this._currentBar.voices.length),this._currentVoice=this._currentBar.voices[t]}parseChord(e,t){let i=new iY;for(let s of t.childElements())switch(s.localName){case"stem":switch(s.getAttribute("dir")){case"up":e.preferredBeamDirection=tR.Up;break;case"down":e.preferredBeamDirection=tR.Down}break;case"articulation":switch(s.getAttribute("type")){case"staccato":i.isStaccato=!0;break;case"normalAccent":i.accentuated=ts.Normal;break;case"strongAccent":i.accentuated=ts.Heavy}break;case"lyric":this.parseLyric(e,s);break;case"drawObjects":this.parseBeatDrawObject(e,s);break;case"heads":this.parseHeads(e,i,s);break;case"beam":switch(s.getAttribute("group")){case"force":e.beamingMode=tF.ForceMergeWithNext;break;case"divide":e.beamingMode=tF.ForceSplitToNext}}}parseHeads(e,t,i){for(let s of i.childElements())"head"===s.localName&&this.parseHead(e,t,s)}parseHead(e,t,i){let s=new iY,a=iW.parseTuning(i.getAttribute("pitch"));for(let r of(s.octave=a.octave-1,s.tone=a.tone.noteValue,s.isStaccato=t.isStaccato,s.accentuated=t.accentuated,e.addNote(s),i.childElements()))switch(r.localName){case"alter":r.attributes.has("step")&&(s.tone+=Number.parseInt(r.attributes.get("step")));break;case"tie":r.attributes.has("begin")?this._tieStartIds.has(s.id)||(this._tieStartIds.set(s.id,!0),this._tieStarts.push(s)):r.attributes.has("end")&&this._tieStarts.length>0&&!s.isTieDestination&&(s.isTieDestination=!0,s.tieOrigin=this._tieStarts[0],this._tieStarts.splice(0,1),this._tieStartIds.delete(s.id))}}parseBeatDrawObject(e,t){for(let i of t.childElements())if("drawObj"===i.localName){let t=this.parseDrawObj(i);t&&(t instanceof hU?t.fontFace.startsWith("capella")?"u"===t.text?(e.fermata=new sc,e.fermata.type=tA.Medium):"f"===t.text?e.dynamics=e4.F:"j"===t.text&&(e.dynamics=e4.MF):this._isFirstSystem&&""===this.score.title&&t.align===tS.Center&&t.height>16&&t.weight>400?this.score.title=t.text:this._isFirstSystem&&""===this.score.artist&&t.align===tS.Center&&t.y<0?this.score.artist=t.text:this._isFirstSystem&&""===this.score.music&&t.align===tS.Right&&t.y<0?this.score.music=t.text:t.text.startsWith("by capella")||(e.text=t.text):t instanceof hX||(t instanceof hY?e.vibrato=th.Slight:t instanceof h$?(e.crescendo=t.decrescendo?te.Decrescendo:te.Crescendo,t.noteRange++,this._crescendo.set(e,t)):t instanceof hJ?this._slurs.set(e,t):t instanceof hj&&this.applyVolta(t)))}}parseBarDrawObject(e){for(let t of e.childElements())if("drawObj"===t.localName){let e=this.parseDrawObj(t);e&&e instanceof hj&&this.applyVolta(e)}}applyVolta(e){if(e.lastNumber>0?(this._currentVoiceState.repeatCount=e.lastNumber,this._currentVoiceState.repeatEnd&&this._currentVoiceState.repeatEnd.repeatCount<this._currentVoiceState.repeatCount&&(this._currentVoiceState.repeatEnd.repeatCount=this._currentVoiceState.repeatCount)):e.firstNumber>0&&(this._currentVoiceState.repeatCount=e.firstNumber,this._currentVoiceState.repeatEnd&&this._currentVoiceState.repeatEnd.repeatCount<this._currentVoiceState.repeatCount&&(this._currentVoiceState.repeatEnd.repeatCount=this._currentVoiceState.repeatCount)),e.lastNumber>0&&e.firstNumber>0){let t=0;for(let i=e.firstNumber;i<=e.lastNumber;i++)t|=1<<i-1;this._currentBar.masterBar.alternateEndings=t}else e.lastNumber>0?this._currentBar.masterBar.alternateEndings=1<<e.lastNumber-1:e.firstNumber>0&&(this._currentBar.masterBar.alternateEndings=1<<e.firstNumber-1)}parseLyric(e,t){for(let i of t.childElements())if("verse"===i.localName){e.lyrics||(e.lyrics=[]);let t=i.innerText;"true"===i.getAttribute("hyphen")&&(t+="-"),e.lyrics.push(t)}}parseRestDurations(e,t){let i=t.getAttribute("base");if(-1!==i.indexOf("/")){let i=new i1;return i.beamingMode=this._beamingMode,this.parseDuration(e,i,t),i}if(1===Number.parseInt(i)){let e=new i1;return e.beamingMode=this._beamingMode,e.duration=tt.Whole,e}return iM.warning("Importer","Multi-Bar rests are not supported"),null}parseDurationValue(e){switch(e){case"2/1":return tt.DoubleWhole;case"1/1":return tt.Whole;case"1/2":return tt.Half;case"1/4":return tt.Quarter;case"1/8":return tt.Eighth;case"1/16":return tt.Sixteenth;case"1/32":return tt.ThirtySecond;case"1/64":return tt.SixtyFourth;case"1/128":return tt.OneHundredTwentyEighth;default:return iM.warning("Importer","Unsupported duration"),tt.Quarter}}parseDuration(e,t,i){let s=i.getAttribute("base");t.duration=this.parseDurationValue(s),i.attributes.has("dots")&&(t.dots=Number.parseInt(i.attributes.get("dots")));let a=i.findChildElement("tuplet");if(a){t.tupletNumerator=Number.parseInt(a.getAttribute("count"));let e="true"===a.getAttribute("tripartite")?3:1,i=+("true"!==a.getAttribute("prolong")),s=0;for(;e*Math.pow(2,s+i)<t.tupletNumerator;)s++;t.tupletDenominator=e*Math.pow(2,s)}}parsePageObjects(e){for(let t of e.childElements())if("drawObj"===t.localName){let e=this.parseDrawObj(t);if(e&&e instanceof hU)switch(e.align){case tS.Center:this.score.title?this.score.subTitle||(this.score.subTitle=t.innerText):this.score.title=t.innerText;break;case tS.Right:this.score.artist||(this.score.artist=t.innerText)}}}parseGallery(e){for(let t of e.childElements())if("drawObj"===t.localName){let e=this.parseDrawObj(t);e&&this._galleryObjects.set(t.getAttribute("name"),e)}}parseDrawObj(e){let t=null,i=1;for(let s of e.childElements())switch(s.localName){case"text":t=this.parseText(s);break;case"guitar":t=this.parseGuitar(s);break;case"slur":t=this.parseSlur(s);break;case"wavyLine":t=this.parseWavyLine(s);break;case"bracket":t=this.parseTupletBracket(s);break;case"wedge":t=this.parseWedge(s);break;case"volta":t=this.parseVolta(s);break;case"octaveClef":t=this.parseOctaveClef(s);break;case"trill":t=this.parseTrill(s);break;case"basic":s.attributes.has("noteRange")&&(i=Number.parseInt(s.attributes.get("noteRange")))}return t&&(t.noteRange=i),t}parseTrill(e){return new hQ}parseOctaveClef(e){let t=new hK;return e.attributes.has("octave")&&(t.octave=Number.parseInt(e.attributes.get("octave"))),t}parseVolta(e){let t=new hj;return t.allNumbers="true"===e.attributes.get("allNumbers"),e.attributes.has("firstNumber")&&(t.firstNumber=Number.parseInt(e.attributes.get("firstNumber"))),e.attributes.has("lastNumber")&&(t.lastNumber=Number.parseInt(e.attributes.get("lastNumber"))),t}parseWedge(e){let t=new h$;return t.decrescendo="true"===e.attributes.get("decrescendo"),t}parseTupletBracket(e){let t=new hq;return e.attributes.has("number")&&(t.number=Number.parseInt(e.attributes.get("number"))),t}parseWavyLine(e){return new hY}parseSlur(e){return new hJ}parseGuitar(e){let t=new hX,i=e.innerText.trim();for(let e=0;e<i.length;e++)"/"===i.charAt(e)?t.chord.strings.push(0):t.chord.strings.push(Number.parseInt(i.charAt(e)));return t}parseText(e){let t=new hU;switch(e.attributes.has("x")&&(t.x=Number.parseFloat(e.attributes.get("x"))),e.attributes.has("x")&&(t.y=Number.parseFloat(e.attributes.get("y"))),e.getAttribute("align")){case"left":t.align=tS.Left;break;case"center":t.align=tS.Center;break;case"right":t.align=tS.Right}switch(e.getAttribute("frame")){case"rectangle":t.frame=id.Rectangle;break;case"ellipse":t.frame=id.Ellipse;break;case"circle":t.frame=id.Circle;break;case"none":t.frame=id.None}if(e.firstElement)for(let i of e.childElements())switch(i.localName){case"font":t.fontFace=i.getAttribute("face"),i.attributes.has("weight")&&(t.weight=Number.parseInt(i.attributes.get("weight"))),i.attributes.has("height")&&(t.height=Number.parseInt(i.attributes.get("height")));break;case"content":t.text=i.innerText}else t.text=e.innerText;return t}parseInfo(e){for(let t of e.childElements())switch(t.localName){case"author":this.score.tab=t.firstChild.innerText;break;case"comment":this.score.notices=t.firstChild.innerText}}}class h5 extends i4{get name(){return"Capella"}readScore(){let e;iM.debug(this.name,"Loading ZIP entries");let t=new sH(this.data),i=null;if(e=t.read(),iM.debug(this.name,"Zip entries loaded"),e.length>0)for(let t of e)"score.xml"===t.fileName&&(i=sh.toString(t.data,this.settings.importer.encoding));else this.data.reset(),i=sh.toString(this.data.readAll(),this.settings.importer.encoding);if(!i)throw new i8("No valid capella file");iM.debug(this.name,"Start Parsing score.xml");try{let e=new h2;return e.parseXml(i,this.settings),iM.debug(this.name,"score.xml parsed"),e.score}catch(e){throw new i8("Failed to parse CapXML",e)}}}var h3="function"==typeof SuppressedError?SuppressedError:function(e,t,i){var s=Error(i);return s.name="SuppressedError",s.error=e,s.suppressed=t,s};class h4{static enable(e,t){h4.alphaSkia=t,h4.initializeMusicFont(h4.alphaSkia.AlphaSkiaTypeface.register(e))}static initializeMusicFont(e){h4.musicTextStyle=new h4.alphaSkia.AlphaSkiaTextStyle([e.familyName],e.weight,e.isItalic)}static registerFont(e,t){let i=h4.alphaSkia.AlphaSkiaTypeface.register(e.buffer);return t||(t=r_.withFamilyList([i.familyName],12,i.isItalic?t5.Italic:t5.Plain,i.weight>400?t3.Bold:t3.Regular)),t}get font(){return this._font}set font(e){if(this._font===e)return;this._font=e;let t=this.textStyleKey(e);if(this._textStyles.has(t))this._textStyle=this._textStyles.get(t);else{let i=new h4.alphaSkia.AlphaSkiaTextStyle(e.families,e.weight===t3.Bold?700:400,e.isItalic);this._textStyles.set(t,i),this._textStyle=i}}textStyleKey(e){return[...e.families,e.weight.toString(),e.isItalic?"italic":"upright"].join("_")}constructor(){this._color=new si(0,0,0,0),this._lineWidth=0,this._textStyle=null,this._scale=1,this._textStyles=new Map,this._font=new r_("Arial",10,t5.Plain),this.textAlign=tS.Left,this.textBaseline=t_.Top,this._canvas=new h4.alphaSkia.AlphaSkiaCanvas,this.color=new si(0,0,0,255)}destroy(){for(let e of(this._canvas[Symbol.dispose](),this._textStyles.values()))e[Symbol.dispose]()}onRenderFinished(){return null}beginRender(e,t){this._scale=this.settings.display.scale,this._canvas.beginRender(e,t,dE.HighDpiFactor)}endRender(){return this._canvas.endRender()}get color(){return this._color}set color(e){this._color.rgba!==e.rgba&&(this._color=e,this._canvas.color=h4.alphaSkia.AlphaSkiaCanvas.rgbaToColor(e.r,e.g,e.b,e.a))}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this._canvas.lineWidth=e}fillRect(e,t,i,s){i>0&&this._canvas.fillRect(e*this._scale|0,t*this._scale|0,i*this._scale,s*this._scale)}strokeRect(e,t,i,s){let a=.5*(this.lineWidth%2!=0);this._canvas.strokeRect((e*this._scale|0)+a,(t*this._scale|0)+a,i*this._scale,s*this._scale)}beginPath(){this._canvas.beginPath()}closePath(){this._canvas.closePath()}moveTo(e,t){this._canvas.moveTo(e*this._scale,t*this._scale)}lineTo(e,t){this._canvas.lineTo(e*this._scale,t*this._scale)}quadraticCurveTo(e,t,i,s){this._canvas.quadraticCurveTo(e*this._scale,t*this._scale,i*this._scale,s*this._scale)}bezierCurveTo(e,t,i,s,a,r){this._canvas.bezierCurveTo(e*this._scale,t*this._scale,i*this._scale,s*this._scale,a*this._scale,r*this._scale)}fillCircle(e,t,i){this._canvas.fillCircle(e*this._scale,t*this._scale,i*this._scale)}strokeCircle(e,t,i){this._canvas.strokeCircle(e*this._scale,t*this._scale,i*this._scale)}fill(){this._canvas.fill()}stroke(){this._canvas.stroke()}beginGroup(e){}endGroup(){}fillText(e,t,i){if(0===e.length)return;let s=h4.alphaSkia.AlphaSkiaTextAlign.Left;switch(this.textAlign){case tS.Left:s=h4.alphaSkia.AlphaSkiaTextAlign.Left;break;case tS.Center:s=h4.alphaSkia.AlphaSkiaTextAlign.Center;break;case tS.Right:s=h4.alphaSkia.AlphaSkiaTextAlign.Right}let a=h4.alphaSkia.AlphaSkiaTextBaseline.Top;switch(this.textBaseline){case t_.Top:a=h4.alphaSkia.AlphaSkiaTextBaseline.Top;break;case t_.Middle:a=h4.alphaSkia.AlphaSkiaTextBaseline.Middle;break;case t_.Bottom:a=h4.alphaSkia.AlphaSkiaTextBaseline.Bottom}this._canvas.fillText(e,this._textStyle,this._font.size*this._scale,t*this._scale|0,i*this._scale|0,s,a)}measureText(e){let t={stack:[],error:void 0,hasError:!1};try{let i=function(e,t,i){if(null!=t){var s,a;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(i){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");s=t[Symbol.asyncDispose]}if(void 0===s){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");s=t[Symbol.dispose],i&&(a=s)}if("function"!=typeof s)throw TypeError("Object not disposable.");a&&(s=function(){try{a.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:s,async:i})}else i&&e.stack.push({async:!0});return t}(t,this._canvas.measureText(e,this._textStyle,this._font.size,h4.alphaSkia.AlphaSkiaTextAlign.Left,h4.alphaSkia.AlphaSkiaTextBaseline.Alphabetic),!1);return new iG(i.width,i.actualBoundingBoxAscent+i.actualBoundingBoxDescent)}catch(e){t.error=e,t.hasError=!0}finally{var i=t;function s(e){i.error=i.hasError?new h3(e,i.error,"An error was suppressed during disposal."):e,i.hasError=!0}var a,r=0;!function e(){for(;a=i.stack.pop();)try{if(!a.async&&1===r)return r=0,i.stack.push(a),Promise.resolve().then(e);if(a.dispose){var t=a.dispose.call(a.value);if(a.async)return r|=2,Promise.resolve(t).then(e,function(t){return s(t),e()})}else r|=1}catch(e){s(e)}if(1===r)return i.hasError?Promise.reject(i.error):Promise.resolve();if(i.hasError)throw i.error}()}}fillMusicFontSymbol(e,t,i,s,a){s!==tb.None&&this.fillMusicFontSymbolText(e,t,i,String.fromCharCode(s),a)}fillMusicFontSymbols(e,t,i,s,a){let r="";for(let e of s)e!==tb.None&&(r+=String.fromCharCode(e));this.fillMusicFontSymbolText(e,t,i,r,a)}fillMusicFontSymbolText(e,t,i,s,a){this._canvas.fillText(s,h4.musicTextStyle,dE.MusicFontSize*this._scale*i,e*this._scale,t*this._scale,a?h4.alphaSkia.AlphaSkiaTextAlign.Center:h4.alphaSkia.AlphaSkiaTextAlign.Left,h4.alphaSkia.AlphaSkiaTextBaseline.Alphabetic)}beginRotate(e,t,i){this._canvas.beginRotate(e*this._scale,t*this._scale,i)}endRotate(){this._canvas.endRotate()}}h4.musicTextStyle=null;class h6 extends lO{constructor(e,t,i=!1){super(e.beat,t.beat,i),this.startNote=e,this.endNote=t}getTieHeight(e,t,i,s){return this.startNote===this.endNote?15:super.getTieHeight(e,t,i,s)}getBeamDirection(e,t){return tR.Down}static getBeamDirectionForNote(e){return tR.Down}getStartY(){return this.startNoteRenderer.getNoteY(this.startNote,ir.Center)}getEndY(){return this.getStartY()}getStartX(){return this.startNote===this.endNote?this.getEndX()-20:this.startNoteRenderer.getNoteX(this.startNote,io.Right)}getEndX(){return this.endNoteRenderer.getNoteX(this.endNote,io.Left)}}class h8 extends nA{constructor(){super(...arguments),this._tiedNoteTie=null}createTies(e){if(e.isVisible){if(!this._tiedNoteTie&&e.isTieOrigin&&e.tieDestination.isVisible){let t=new h6(e,e.tieDestination,!1);this._tiedNoteTie=t,this.addTie(t)}if(!this._tiedNoteTie&&e.isTieDestination){let t=new h6(e.tieOrigin,e,!0);this._tiedNoteTie=t,this.addTie(t)}}}}class h7 extends lY{updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("slash",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}paint(e,t,i){super.internalPaint(e,t,i,tC.SlashRests)}}class h9 extends oH{constructor(){super(...arguments),this.noteHeads=null,this.deadSlapped=null,this.restGlyph=null}get effectElement(){return tC.SlashEffects}getNoteX(e,t){let i=null;if(this.noteHeads?i=this.noteHeads:this.deadSlapped&&(i=this.deadSlapped),i){let e=i.x;switch(t){case io.Left:break;case io.Center:e+=i.width/2;break;case io.Right:e+=i.width}return e}return 0}buildBoundingsLookup(e,t,i){if(this.noteHeads&&this.container.beat.notes.length>0){let s=new nh;s.note=this.container.beat.notes[0],s.noteHeadBounds=new sy,s.noteHeadBounds.x=t+this.x+this.noteHeads.x,s.noteHeadBounds.y=i+this.y+this.noteHeads.y-this.noteHeads.height/2,s.noteHeadBounds.w=this.width,s.noteHeadBounds.h=this.height,e.addNote(s)}}getNoteY(e,t){let i=null;if(this.noteHeads?i=this.noteHeads:this.deadSlapped&&(i=this.deadSlapped),i){let e=this.y+i.y;switch(t){case ir.Top:case ir.TopWithStem:e-=i.height/2+2;break;case ir.Center:break;case ir.Bottom:case ir.BottomWithStem:e+=i.height/2}return e}return 0}updateBeamingHelper(){this.noteHeads?this.noteHeads.updateBeamingHelper(this.container.x+this.x):this.deadSlapped?this.beamingHelper&&this.beamingHelper.registerBeatLineX("slash",this.container.beat,this.container.x+this.x+this.deadSlapped.x+this.width,this.container.x+this.x+this.deadSlapped.x):this.restGlyph&&this.restGlyph.updateBeamingHelper(this.container.x+this.x)}doLayout(){let e=this.renderer,t=e.getNoteLine(),i=e.getLineY(t);if(this.container.beat.deadSlapped){let e=new lX;e.renderer=this.renderer,e.doLayout(),this.deadSlapped=e,this.addEffect(e)}else if(!this.container.beat.isEmpty)if(this.container.beat.isRest){let e=new h7(0,i,this.container.beat.duration);this.restGlyph=e,e.beat=this.container.beat,e.beamingHelper=this.beamingHelper,this.addNormal(e),this.beamingHelper&&this.beamingHelper.applyRest(this.container.beat,0)}else{let e=this.container.beat.graceType!==ti.None,t=new l7(0,i,this.container.beat.duration,e,this.container.beat);this.noteHeads=t,t.beat=this.container.beat,t.beamingHelper=this.beamingHelper,this.addNormal(t)}if(this.container.beat.dots>0){this.addNormal(new l2(0,0,5));for(let t=0;t<this.container.beat.dots;t++)this.addEffect(new lI(0,e.getLineY(e.getNoteLine())-e.getLineHeight(.5),1.5))}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteHeads?this.centerX=this.noteHeads.x+this.noteHeads.width/2:this.deadSlapped&&(this.centerX=this.deadSlapped.x+this.deadSlapped.width/2)}}class de extends hB{constructor(e,t){super(e,t),this.simpleWhammyOverflow=0,this._isOnlySlash=!t.staff.showTablature&&!t.staff.showStandardNotation,this.helpers.preferredBeamDirection=tR.Up}get repeatsBarSubElement(){return e5.SlashRepeats}get barNumberBarSubElement(){return e5.SlashBarNumber}get barLineBarSubElement(){return e5.SlashBarLines}get staffLineBarSubElement(){return e5.SlashStaffLine}get lineSpacing(){return oz.RawLineSpacing}get heightLineCount(){return 5}get drawnLineCount(){return 1}get bottomGlyphOverflow(){return 0}paint(e,t,i){super.paint(e,t,i),this.paintBeams(e,t,i,tC.SlashFlags,tC.SlashBeams),this.paintTuplets(e,t,i,tC.SlashTuplet)}doLayout(){super.doLayout();let e=!1;for(let t of this.bar.voices)if(this.hasVoiceContainer(t)&&this.getVoiceContainer(t).tupletGroups.length>0){e=!0;break}e&&this.registerOverflowTop(this.tupletSize)}getNoteLine(){return 0}getFlagTopY(e,t){let i=nE.Heights.get(tb.NoteheadSlashWhiteHalf);return this.getLineY(0)-i/2}getFlagBottomY(e,t){let i=nE.Heights.get(tb.NoteheadSlashWhiteHalf);return this.getLineY(0)-i/2}getBeamDirection(e){return tR.Up}getNoteY(e,t){let i=super.getNoteY(e,t);return Number.isNaN(i)&&(i=this.getLineY(0)),i}calculateBeamYWithDirection(e,t,i){return this.getLineY(0)-this.getFlagStemSize(e.shortestDuration)}getBarLineStart(e,t){let i=nE.Heights.get(tb.NoteheadSlashWhiteHalf);return this.getLineY(0)-i/2}createLinePreBeatGlyphs(){this._isOnlySlash&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.createTimeSignatureGlyphs())}createTimeSignatureGlyphs(){this.addPreBeatGlyph(new l2(0,0,5));let e=this.bar.masterBar,t=new hr(0,this.getLineY(0),e.timeSignatureNumerator,e.timeSignatureDenominator,e.timeSignatureCommon,e.isFreeTime&&(null==e.previousMasterBar||e.isFreeTime!==e.previousMasterBar.isFreeTime));t.barSubElement=e5.SlashTimeSignature,this.addPreBeatGlyph(t)}createVoiceGlyphs(e){for(let t of e.beats){let i=new h8(t,this.getVoiceContainer(e));i.preNotes=new oO,i.onNotes=0===e.index?new h9:new oH,this.addBeatGlyph(i)}}paintBeamingStem(e,t,i,s,a,r){let n=od.beat(r,tC.SlashStem,e);try{r.lineWidth=oz.StemWidth,r.beginPath(),r.moveTo(i,s),r.lineTo(i,a),r.stroke(),r.lineWidth=1}finally{n?.[Symbol.dispose]?.()}}}de.StaffId="slash";class dt extends oo{get staffId(){return de.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(e,t){return new de(e,t)}canCreate(e,t){return super.canCreate(e,t)&&t.showSlash}}class di extends lO{constructor(e,t,i=!1){super(e?e.beat:null,t?t.beat:null,i),this.startNote=e,this.endNote=t}shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}doLayout(){super.doLayout()}getBeamDirection(e,t){return tR.Up}getStartY(){return this.startNoteRenderer.getNoteY(this.startNote,ir.Top)}getEndY(){return this.getStartY()}getStartX(){return this.startNote===this.endNote?this.getEndX()-20:this.startNoteRenderer.getNoteX(this.startNote,io.Center)}getEndX(){return this.startNote===this.endNote?this.endNoteRenderer.getNoteX(this.endNote,io.Left):this.endNoteRenderer.getNoteX(this.endNote,io.Center)}}class ds extends hv{constructor(e,t,i,s=!1){super(e,t,s),this._direction=tR.Up,this._forSlide=i}getTieHeight(e,t,i,s){return Math.log(i-e+1)*this.renderer.settings.notation.slurHeight}tryExpand(e,t,i,s){if(this._forSlide!==i||this.forEnd!==s||this.startNote.beat.id!==e.beat.id||this.endNote.beat.id!==t.beat.id)return!1;switch(this._direction){case tR.Up:e.realValue>this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue>this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat);break;case tR.Down:e.realValue<this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue<this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat)}return!0}paint(e,t,i){let s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar),a=this.getBeamDirection(this.startBeat,s),r=`numbered.slur.${this.startNote.beat.id}.${this.endNote.beat.id}.${a}`,n=this.renderer;n.staff.getSharedLayoutData(r,!1)||(n.staff.setSharedLayoutData(r,!0),super.paint(e,t,i))}}class da extends nA{constructor(){super(...arguments),this._effectSlurs=[]}createTies(e){if(e.isVisible){if(e.isTieOrigin&&e.tieDestination.isVisible){let t=new di(e,e.tieDestination,!1);this.addTie(t)}if(e.isTieDestination){let t=new di(e.tieOrigin,e,!0);this.addTie(t)}if(e.isLeftHandTapped&&!e.isHammerPullDestination){let t=new di(e,e,!1);this.addTie(t)}if(e.isEffectSlurOrigin&&e.effectSlurDestination){let t=!1;for(let i of this._effectSlurs)if(i.tryExpand(e,e.effectSlurDestination,!1,!1)){t=!0;break}if(!t){let t=new ds(e,e.effectSlurDestination,!1,!1);this._effectSlurs.push(t),this.addTie(t)}}if(e.isEffectSlurDestination&&e.effectSlurOrigin){let t=!1;for(let i of this._effectSlurs)if(i.tryExpand(e.effectSlurOrigin,e,!1,!0)){t=!0;break}if(!t){let t=new ds(e.effectSlurOrigin,e,!1,!0);this._effectSlurs.push(t),this.addTie(t)}}}}}class dr extends nC{constructor(e,t,i,s,a){super(e,t),this._isGrace=s,this._number=i,this._beat=a}paint(e,t,i){let s=this._beat.isRest?od.beat(i,tC.NumberedRests,this._beat):this._beat.notes.length>0?od.note(i,tk.NumberedNumber,this._beat.notes[0]):void 0;try{let s=this.renderer.resources;i.font=this._isGrace?s.numberedNotationGraceFont:s.numberedNotationFont,i.textBaseline=t_.Middle,i.textAlign=tS.Left,i.fillText(this._number.toString(),e+this.x,t+this.y)}finally{s?.[Symbol.dispose]?.()}}doLayout(){let e=this._isGrace?nL.GraceScale:1;this.width=dr.NoteHeadWidth*e,this.height=dr.NoteHeadHeight*e}}dr.NoteHeadHeight=17,dr.NoteHeadWidth=12;class dn extends nC{constructor(e,t,i){super(e,t),this._beat=i}doLayout(){this.width=14+dn.Padding,this.height=dc.BarSize}paint(e,t,i){let s=od.beat(i,tC.NumberedDuration,this._beat);try{let s=dn.Padding;i.fillRect(e+this.x,t+this.y,this.width-s,this.height)}finally{s?.[Symbol.dispose]?.()}}}dn.Padding=3;class dl extends oO{constructor(){super(...arguments),this.isNaturalizeAccidental=!1,this.accidental=tJ.None}get effectElement(){return tC.NumberedEffects}doLayout(){if(!this.container.beat.isRest&&!this.container.beat.isEmpty){let e=new l$;if(e.renderer=this.renderer,this.container.beat.notes.length>0){let t=this.container.beat.notes[0],i=t?t.accidentalMode:tn.Default,s=sj.getNoteValue(t),a=sj.computeAccidental(this.renderer.bar.keySignature,i,s,t.hasQuarterToneOffset);if(a===tJ.Natural&&(a=this.renderer.bar.keySignature+7<7?tJ.Sharp:tJ.Flat,this.isNaturalizeAccidental=!0),a!==tJ.None){this.accidental=a;let i=this.renderer,s=od.noteColor(i.resources,tk.NumberedAccidentals,t),r=new lE(0,i.getLineY(0),a,t.beat.graceType!==ti.None?nL.GraceScale*nL.GraceScale:nL.GraceScale);r.colorOverride=s,r.renderer=this.renderer,e.addGlyph(r),this.addNormal(e),this.addNormal(new l2(0,0,4))}}}super.doLayout()}}class dh extends oH{constructor(){super(...arguments),this.noteHeads=null,this.deadSlapped=null,this.octaveDots=0}get effectElement(){return tC.NumberedEffects}getNoteX(e,t){let i=null;if(this.noteHeads?i=this.noteHeads:this.deadSlapped&&(i=this.deadSlapped),i){let e=i.x;switch(t){case io.Left:break;case io.Center:e+=i.width/2;break;case io.Right:e+=i.width}return e}return 0}buildBoundingsLookup(e,t,i){if(this.noteHeads&&this.container.beat.notes.length>0){let s=new nh;s.note=this.container.beat.notes[0],s.noteHeadBounds=new sy,s.noteHeadBounds.x=t+this.x+this.noteHeads.x,s.noteHeadBounds.y=i+this.y+this.noteHeads.y-this.noteHeads.height/2,s.noteHeadBounds.w=this.width,s.noteHeadBounds.h=this.height,e.addNote(s)}}getNoteY(e,t){let i=null;if(this.noteHeads?i=this.noteHeads:this.deadSlapped&&(i=this.deadSlapped),i){let e=this.y+i.y;switch(t){case ir.Top:case ir.TopWithStem:e-=i.height/2+2;break;case ir.Center:break;case ir.Bottom:case ir.BottomWithStem:e+=i.height/2}return e}return 0}updateBeamingHelper(){if(this.beamingHelper){let e=null;this.noteHeads?e=this.noteHeads:this.deadSlapped&&(e=this.deadSlapped),e&&this.beamingHelper.registerBeatLineX("numbered",this.container.beat,this.container.x+this.x+e.x,this.container.x+this.x+e.x+e.width)}}doLayout(){let e=this.renderer;e.shortestDuration<this.container.beat.duration&&(e.shortestDuration=this.container.beat.duration);let t=e.getLineY(e.getNoteLine());if(!this.container.beat.isEmpty){let i="0";if(this.container.beat.notes.length>0){let t=this.renderer.bar.keySignatureType,s=this.renderer.bar.keySignature,a=s+7,r=(t===e1.Minor?dh.MinorKeySignatureOneValues:dh.MajorKeySignatureOneValues)[a],n=this.container.beat.notes[0];if(n.isDead)i="X";else{let t=n.displayValue-r,o=t<0?(t%12+12)%12:t%12,l=t<0?(Math.abs(t)+12)/12|0:t/12|0;t<0&&(l*=-1),this.octaveDots=l,e.registerOctave(l);let h=(iW.keySignatureIsSharp(s)||iW.keySignatureIsNatural(s)?sj.FlatNoteSteps:sj.SharpNoteSteps)[o]+1;sj.AccidentalNotes[o]&&!this.container.preNotes.isNaturalizeAccidental&&(a<7?h++:h--),i=h.toString()}}if(this.container.beat.deadSlapped){let e=new lX;e.renderer=this.renderer,e.doLayout(),this.deadSlapped=e,this.addEffect(e)}else{let e=new dr(0,t,i,this.container.beat.graceType!==ti.None,this.container.beat);this.noteHeads=e,this.addNormal(e)}if(this.container.beat.dots>0&&this.container.beat.duration>=tt.Quarter){this.addNormal(new l2(0,0,5));for(let t=0;t<this.container.beat.dots;t++){let t=new lI(0,e.getLineY(0),1.5);t.renderer=this.renderer,this.addEffect(t)}}let s=0;switch(this.container.beat.duration){case tt.QuadrupleWhole:s=16;break;case tt.DoubleWhole:s=8;break;case tt.Whole:s=4;break;case tt.Half:s=2}let a=s;for(let e=0;e<this.container.beat.dots;e++)s+=a=a/2|0;for(let t=0;t<s-1;t++){let t=new dn(0,e.getLineY(0),this.container.beat);t.renderer=this.renderer,this.addNormal(t)}}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.noteHeads?this.centerX=this.noteHeads.x+this.noteHeads.width/2:this.deadSlapped&&(this.centerX=this.deadSlapped.x+this.deadSlapped.width/2)}}dh.MajorKeySignatureOneValues=[59,66,61,68,63,58,65,60,67,62,69,64,71,66,61],dh.MinorKeySignatureOneValues=[71,66,73,68,63,70,65,72,67,74,69,64,71,66,73];class dd extends nC{constructor(e,t,i,s){super(e,t),this._text="",this._accidental=tJ.None,this._accidentalOffset=0,this._keySignature=i,this._keySignatureType=s}doLayout(){super.doLayout();let e="1 = ",t="",i=tJ.None;switch(this._keySignatureType){case e1.Major:switch(this._keySignature){case e0.Cb:t="  C",i=tJ.Flat;break;case e0.Gb:t="  G",i=tJ.Flat;break;case e0.Db:t="  D",i=tJ.Flat;break;case e0.Ab:t="  A",i=tJ.Flat;break;case e0.Eb:t="  E",i=tJ.Flat;break;case e0.Bb:t="  B",i=tJ.Flat;break;case e0.F:t="F";break;case e0.C:t="C",i=tJ.None;break;case e0.G:t="G",i=tJ.None;break;case e0.D:t="D",i=tJ.None;break;case e0.A:t="A",i=tJ.None;break;case e0.E:t="E",i=tJ.None;break;case e0.B:t="B",i=tJ.None;break;case e0.FSharp:t="  F",i=tJ.Sharp;break;case e0.CSharp:t="  C",i=tJ.Sharp}break;case e1.Minor:switch(this._keySignature){case e0.Cb:t="  a",i=tJ.Flat;break;case e0.Gb:t="  e",i=tJ.Flat;break;case e0.Db:t="  b",i=tJ.Flat;break;case e0.Ab:t="f",i=tJ.None;break;case e0.Eb:t="c",i=tJ.None;break;case e0.Bb:t="g",i=tJ.None;break;case e0.F:t="d";break;case e0.C:t="a",i=tJ.None;break;case e0.G:t="e",i=tJ.None;break;case e0.D:t="b",i=tJ.None;break;case e0.A:t="  f",i=tJ.Sharp;break;case e0.E:t="  c",i=tJ.Sharp;break;case e0.B:t="  g",i=tJ.Sharp;break;case e0.FSharp:t="  d",i=tJ.Sharp;break;case e0.CSharp:t="  a",i=tJ.Sharp}}this._text=e+t,this._accidental=i;let s=this.renderer.scoreRenderer.canvas;s.font=this.renderer.resources.numberedNotationFont,this._accidentalOffset=s.measureText(e).width,this.width=s.measureText(e+t).width}paint(e,t,i){let s=od.bar(i,e5.NumberedKeySignature,this.renderer.bar);try{i.font=this.renderer.resources.numberedNotationFont,i.textBaseline=t_.Middle,i.fillText(this._text,e+this.x,t+this.y),this._accidental!==tJ.None&&i.fillMusicFontSymbol(e+this.x+this._accidentalOffset,t+this.y,.7,lE.getMusicSymbol(this._accidental),!1)}finally{s?.[Symbol.dispose]?.()}}}class dc extends hB{registerOctave(e){null===this.lowestOctave?(this.lowestOctave=e,this.highestOctave=e):(e<this.lowestOctave&&(this.lowestOctave=e),e>this.highestOctave&&(this.highestOctave=e))}get repeatsBarSubElement(){return e5.NumberedRepeats}get barNumberBarSubElement(){return e5.NumberedBarNumber}get barLineBarSubElement(){return e5.NumberedBarLines}get staffLineBarSubElement(){return e5.NumberedStaffLine}constructor(e,t){super(e,t),this.simpleWhammyOverflow=0,this.shortestDuration=tt.QuadrupleWhole,this.lowestOctave=null,this.highestOctave=null,this._isOnlyNumbered=!t.staff.showSlash&&!t.staff.showTablature&&!t.staff.showStandardNotation}get lineSpacing(){return oz.RawLineSpacing}get heightLineCount(){return 5}get drawnLineCount(){return 0}get bottomGlyphOverflow(){return 0}paint(e,t,i){super.paint(e,t,i),this.paintBeams(e,t,i,tC.NumberedDuration,tC.NumberedDuration),this.paintTuplets(e,t,i,tC.NumberedTuplet,!0)}doLayout(){super.doLayout();let e=!1;for(let t of this.bar.voices)if(this.hasVoiceContainer(t)&&this.getVoiceContainer(t).tupletGroups.length>0){e=!0;break}if(e&&this.registerOverflowTop(this.tupletSize),!this.bar.isEmpty){let e=iW.getIndex(this.shortestDuration)-2;if(e>0){let t=dc.BarSpacing,i=dc.BarSize,s=0,a=this.lowestOctave;null!==a&&(s=Math.abs(a)*dc.DotSpacing+dc.DotSize),this.registerOverflowBottom((e-1)*t+i+s)}let t=this.highestOctave;if(null!==t){let e=Math.abs(t)*dc.DotSpacing+dc.DotSize;this.registerOverflowTop(e)}}}paintFlag(e,t,i,s,a){this.paintBar(e,t,i,s,a)}paintBar(e,t,i,s,a){if(0===s.beats.length)return;let r=this.resources;for(let n=0,o=s.beats.length;n<o;n++){let o=s.beats[n],l=od.beat(i,a,o);try{let a=dc.BarSpacing,l=dc.BarSize,h=iW.getIndex(o.duration)-2,d=t+this.y,c=this.getBeatX(o,is.PreNotes)-this.beatGlyphsStart,u=this.calculateBeamY(s,c);for(let t=0;t<h;t++){let r=0,h=0,p=0,m=d+t*a;n===s.beats.length-1?(r=c,h=this.getBeatX(o,is.PostNotes)-this.beatGlyphsStart):(r=c,h=this.getBeatX(s.beats[n+1],is.PreNotes)-this.beatGlyphsStart),p=m+u|0,hB.paintSingleBar(i,e+this.x+r,p,e+this.x+h,p,l)}let p=this.getBeatContainer(o).onNotes,m=p instanceof dh?p.octaveDots:0,g=0,f=0;m>0?(g=d+this.getLineY(0)-r.numberedNotationFont.size/1.5,f=-1*dc.DotSpacing):m<0&&(g=d+u+h*a,f=dc.DotSpacing);let y=this.getBeatX(o,is.OnNotes)+4-this.beatGlyphsStart;m=Math.abs(m);for(let t=0;t<m;t++)i.fillCircle(e+this.x+y,g,dc.DotSize),g+=f}finally{l?.[Symbol.dispose]?.()}}}getNoteLine(){return 0}get tupletOffset(){return super.tupletOffset+this.resources.numberedNotationFont.size}getFlagTopY(e,t){let i=nE.Heights.get(tb.NoteheadBlack);return this.getLineY(0)-i/2}getFlagBottomY(e,t){let i=nE.Heights.get(tb.NoteheadBlack);return this.getLineY(0)-i/2}getBeamDirection(e){return tR.Down}getTupletBeamDirection(e){return tR.Up}getNoteY(e,t){let i=super.getNoteY(e,t);return Number.isNaN(i)&&(i=this.getLineY(0)),i}calculateBeamYWithDirection(e,t,i){let s=this.resources.numberedNotationFont;return this.getLineY(0)+s.size}getBarLineStart(e,t){let i=nE.Heights.get(tb.NoteheadBlack);return this.getLineY(0)-i/2}createPreBeatGlyphs(){this.wasFirstOfLine=this.isFirstOfLine,(0===this.index||this.bar.masterBar.isRepeatStart&&this._isOnlyNumbered)&&this.addPreBeatGlyph(new h_(!1)),this.createLinePreBeatGlyphs(),this.addPreBeatGlyph(new hk(0,this.getLineHeight(-.25),this.bar.index+1))}createLinePreBeatGlyphs(){this.bar.previousBar&&this.bar.keySignature===this.bar.previousBar.keySignature||(this.createStartSpacing(),this.createKeySignatureGlyphs()),this._isOnlyNumbered&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.createTimeSignatureGlyphs())}createKeySignatureGlyphs(){this.addPreBeatGlyph(new dd(0,this.getLineY(0),this.bar.keySignature,this.bar.keySignatureType))}createTimeSignatureGlyphs(){this.addPreBeatGlyph(new l2(0,0,5));let e=this.bar.masterBar,t=new hr(0,this.getLineY(0),e.timeSignatureNumerator,e.timeSignatureDenominator,e.timeSignatureCommon,e.isFreeTime&&(null==e.previousMasterBar||e.isFreeTime!==e.previousMasterBar.isFreeTime));t.barSubElement=e5.NumberedTimeSignature,this.addPreBeatGlyph(t)}createPostBeatGlyphs(){this._isOnlyNumbered&&super.createPostBeatGlyphs()}createVoiceGlyphs(e){for(let t of e.beats){let i=new da(t,this.getVoiceContainer(e));i.preNotes=0===e.index?new dl:new oO,i.onNotes=0===e.index?new dh:new oH,this.addBeatGlyph(i)}}paintBeamingStem(e,t,i,s,a,r){}}dc.StaffId="numbered",dc.BarSpacing=oz.BeamSpacing+oz.BeamThickness,dc.BarSize=2,dc.DotSpacing=5,dc.DotSize=2;class du extends oo{get staffId(){return dc.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(e,t){return new dc(e,t)}canCreate(e,t){return super.canCreate(e,t)&&t.showNumbered}}class dp extends oK{get notationElement(){return tp.EffectText}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return il.SinglePreBeat}shouldCreateGlyph(e,t){let i=t.voice.bar.masterBar;return 0===t.voice.bar.staff.index&&0===t.voice.index&&0===t.index&&i.isFreeTime&&(0===i.index||i.isFreeTime!==i.previousMasterBar.isFreeTime)}createNewGlyph(e,t){return new oT(0,0,"Free time",e.resources.effectFont,tS.Left)}canExpand(e,t){return!0}}class dm extends nD{constructor(){super(0,0)}doLayout(){super.doLayout(),this.height=nE.Heights.get(tb.KeyboardPedalPed)}paint(e,t,i){let s=this.renderer,a=t+this.y,r=this.height,n=s.bar.sustainPedals,o=nE.Widths.get(tb.KeyboardPedalPed),l=nE.Widths.get(tb.KeyboardPedalUp),h=0;for(;h<n.length;){let t=n[h];for(;null!=t;){let s=e+this.renderer.getRatioPositionX(t.ratioPosition),d=0;if(t.pedalType===e2.Down?(i.fillMusicFontSymbol(s,a+r,1,tb.KeyboardPedalPed,!0),d=o/2+dm.TextLinePadding):t.pedalType===e2.Up&&(i.fillMusicFontSymbol(s,a+r,1,tb.KeyboardPedalUp,!0),d=l/2+dm.StarLinePadding),t.nextPedalMarker)if(t.nextPedalMarker.bar===t.bar){let n=e+this.renderer.getRatioPositionX(t.nextPedalMarker.ratioPosition);switch(t.nextPedalMarker.pedalType){case e2.Down:n-=o/2;break;case e2.Hold:break;case e2.Up:n-=l/2}let h=s+d;n>h&&i.fillRect(h,a+r-1,n-h,1)}else{let t=e+this.x+this.width,n=s+d;i.fillRect(n,a+r-1,t-n,1)}if(0===h&&t.previousPedalMarker){let t=e+this.x,n=s-d;i.fillRect(t,a+r-1,n-t,1)}h++,null!=t.nextPedalMarker&&t.nextPedalMarker.bar!==t.bar?(t=null,h=n.length):t=t.nextPedalMarker}}}}dm.TextLinePadding=3,dm.StarLinePadding=3;class dg extends oK{get notationElement(){return tp.EffectSustainPedal}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return il.FullBar}shouldCreateGlyph(e,t){return 0===t.voice.index&&0===t.index&&t.voice.bar.sustainPedals.length>0}createNewGlyph(e,t){return new dm}canExpand(e,t){return!0}}class df extends oK{constructor(e,t){super(),this._type=e,this._shouldCreate=t}get notationElement(){return tp.EffectGolpe}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return il.SingleOnBeat}shouldCreateGlyph(e,t){let i=this._shouldCreate;return t.golpe===this._type&&(!i||i(e,t))}createNewGlyph(e,t){return new l6(0,0,!0)}canExpand(e,t){return!1}}class dy extends nM{constructor(e){super(0,0,1,dy.getSymbol(e)),this.center=!0}static getSymbol(e){switch(e){case tx.Open:return tb.GuitarOpenPedal;case tx.Closed:return tb.GuitarClosePedal}return tb.None}paint(e,t,i){super.paint(e,t+this.height,i)}}class db extends oK{get notationElement(){return tp.EffectWahPedal}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return il.SingleOnBeat}shouldCreateGlyph(e,t){return t.wahPedal!==tx.None}createNewGlyph(e,t){return new dy(t.wahPedal)}canExpand(e,t){return!1}}class dS extends oK{get notationElement(){return tp.EffectLetRing}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(e,t){return t.isBarre}get sizingMode(){return il.GroupedOnBeat}createNewGlyph(e,t){let i="";switch(t.barreShape){case tP.None:case tP.Full:break;case tP.Half:i+="1/2"}return new li(i+=`B ${dS.toRoman(t.barreFret)}`,!1)}static toRoman(e){let t="";if(e>0)for(let[i,s]of dS.RomanLetters){let a=Math.floor(e/s);e-=a*s,t+=i.repeat(a)}return t}canExpand(e,t){return e.barreFret===t.barreFret&&e.barreShape===t.barreShape}}dS.RomanLetters=new Map([["L",50],["XL",40],["X",10],["IX",9],["V",5],["IV",4],["I",1]]);class d_ extends nM{constructor(e){super(0,0,1,d_.getSymbol(e)),this.center=!0}static getSymbol(e){switch(e){case tw.InvertedTurn:return tb.OrnamentTurnInverted;case tw.Turn:return tb.OrnamentTurn;case tw.UpperMordent:return tb.OrnamentShortTrill;case tw.LowerMordent:return tb.OrnamentMordent}return tb.None}paint(e,t,i){super.paint(e,t+this.height-4,i)}}class dw extends oK{get notationElement(){return tp.EffectNoteOrnament}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return il.SingleOnBeat}shouldCreateGlyph(e,t){return t.notes.some(e=>e.ornament!==tw.None)}createNewGlyph(e,t){return new d_(t.notes.find(e=>e.ornament!==tw.None).ornament)}canExpand(e,t){return!1}}class dk extends oK{get notationElement(){return tp.EffectRasgueado}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(e,t){return t.hasRasgueado}get sizingMode(){return il.GroupedOnBeat}createNewGlyph(e,t){return new li("rasg.")}canExpand(e,t){return!0}}class dB extends nC{constructor(e){super(0,0),this._symbols=e}doLayout(){this.height=27}paint(e,t,i){i.fillMusicFontSymbols(e+this.x,t+this.y+this.height,.8,this._symbols,!0)}}class dT extends nC{constructor(e){super(0,0),this._text=e}doLayout(){this.height=1.5*this.renderer.resources.directionsFont.size}paint(e,t,i){let s=i.font,a=i.textBaseline,r=i.textAlign;i.font=this.renderer.resources.directionsFont,i.textBaseline=t_.Middle,i.textAlign=tS.Right,i.fillText(this._text,e+this.x,t+this.y+this.height/2),i.font=s,i.textBaseline=a,i.textAlign=r}}class dN extends nD{constructor(e,t,i){super(e,t),this._barBeginGlyphs=[],this._barEndGlyphs=[],this._directions=i}doLayout(){let e=this._directions;e.has(tI.TargetSegnoSegno)&&this._barBeginGlyphs.push(new dB([tb.Segno,tb.Segno])),e.has(tI.TargetSegno)&&this._barBeginGlyphs.push(new dB([tb.Segno])),e.has(tI.TargetDoubleCoda)&&this._barBeginGlyphs.push(new dB([tb.Coda,tb.Coda])),e.has(tI.TargetCoda)&&this._barBeginGlyphs.push(new dB([tb.Coda])),e.has(tI.TargetFine)&&this._barEndGlyphs.push(new dT("Fine")),e.has(tI.JumpDaDoubleCoda)&&this._barEndGlyphs.push(new dT("To Double Coda")),e.has(tI.JumpDaCoda)&&this._barEndGlyphs.push(new dT("To Coda")),e.has(tI.JumpDalSegnoSegno)&&this._barEndGlyphs.push(new dT("D.S.S.")),e.has(tI.JumpDalSegnoSegnoAlCoda)&&this._barEndGlyphs.push(new dT("D.S.S. al Coda")),e.has(tI.JumpDalSegnoSegnoAlDoubleCoda)&&this._barEndGlyphs.push(new dT("D.S.S. al Double Coda")),e.has(tI.JumpDalSegnoSegnoAlFine)&&this._barEndGlyphs.push(new dT("D.S.S. al Fine")),e.has(tI.JumpDalSegno)&&this._barEndGlyphs.push(new dT("D.S.")),e.has(tI.JumpDalSegnoAlCoda)&&this._barEndGlyphs.push(new dT("D.S. al Coda")),e.has(tI.JumpDalSegnoAlDoubleCoda)&&this._barEndGlyphs.push(new dT("D.S. al Double Coda")),e.has(tI.JumpDalSegnoAlFine)&&this._barEndGlyphs.push(new dT("D.S. al Fine")),e.has(tI.JumpDaCapo)&&this._barEndGlyphs.push(new dT("D.C.")),e.has(tI.JumpDaCapoAlCoda)&&this._barEndGlyphs.push(new dT("D.C. al Coda")),e.has(tI.JumpDaCapoAlDoubleCoda)&&this._barEndGlyphs.push(new dT("D.C. al Double Coda")),e.has(tI.JumpDaCapoAlFine)&&this._barEndGlyphs.push(new dT("D.C. al Fine"));let t=this.doSideLayout(this._barBeginGlyphs),i=this.doSideLayout(this._barEndGlyphs);this.height=Math.max(t,i)}doSideLayout(e){let t=0;for(let i of e)i.y=t,i.renderer=this.renderer,i.doLayout(),t+=i.height+3;return t}paint(e,t,i){for(let s of this._barBeginGlyphs)s.paint(e+this.x,t+this.y,i);for(let s of this._barEndGlyphs)s.paint(e+this.x+this.width,t+this.y,i)}}class dx extends oK{get notationElement(){return tp.EffectDirections}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return il.FullBar}shouldCreateGlyph(e,t){return 0===t.voice.index&&0===t.index&&null!==t.voice.bar.masterBar.directions&&t.voice.bar.masterBar.directions.size>0}createNewGlyph(e,t){return new dN(0,0,t.voice.bar.masterBar.directions)}canExpand(e,t){return!0}}class dP extends nD{constructor(e){super(0,0),this._text="",this._textWidth=0,this._textHeight=0,this._timer=e}doLayout(){let e=this._timer/6e4|0,t=(this._timer-6e4*e)/1e3|0;this._text=`${e}:${t.toString().padStart(2,"0")}`;let i=this.renderer.scoreRenderer.canvas;i.font=this.renderer.resources.timerFont;let s=i.measureText(this._text);this._textHeight=i.font.size+2*dP.PaddingY,this._textWidth=s.width+2*dP.PaddingX,this.height=this._textHeight+2*dP.MarginY}paint(e,t,i){let s=this._textWidth/2|0;i.strokeRect(e+this.x-s,t+this.y+dP.MarginY,this._textWidth,this._textHeight);let a=i.font,r=i.textBaseline,n=i.textAlign;i.font=this.renderer.resources.timerFont,i.textBaseline=t_.Middle,i.textAlign=tS.Center,i.fillText(this._text,e+this.x,t+this.y+this.height/2),i.font=a,i.textBaseline=r,i.textAlign=n}}dP.PaddingX=2,dP.PaddingY=2,dP.MarginY=2;class dv extends oK{get notationElement(){return tp.EffectBeatTimer}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return il.SingleOnBeat}shouldCreateGlyph(e,t){return t.showTimer}createNewGlyph(e,t){return new dP(t.timer??0)}canExpand(e,t){return!0}}class dF{static print(e){e(`alphaTab ${dF.version}`),e(`commit: ${dF.commit}`),e(`build date: ${dF.date}`)}}dF.version="1.6.3",dF.date="2025-08-30T14:34:56.310Z",dF.commit="bf30fbbbf85e7c31fe99ed4c5a8f71814bb007e3";class dC{constructor(e,t){this.vertical=e,this.createLayout=t}}class dD{constructor(e,t){this.supportsWorkers=e,this.createCanvas=t}}class dE{static get globalThis(){if(void 0===dE._globalThis){try{dE._globalThis=globalThis}catch(e){}void 0===dE._globalThis&&(dE._globalThis=self),void 0===dE._globalThis&&(dE._globalThis=e.g),void 0===dE._globalThis&&(dE._globalThis=window),void 0===dE._globalThis&&(dE._globalThis=Function("return this")())}return dE._globalThis}static get isRunningInWorker(){return"WorkerGlobalScope"in dE.globalThis}static get isRunningInAudioWorklet(){return"AudioWorkletGlobalScope"in dE.globalThis}static throttle(e,t){let i=0;return()=>{dE.globalThis.clearTimeout(i),i=dE.globalThis.setTimeout(e,t)}}static detectScriptFile(){if(!dE.isRunningInWorker&&dE.globalThis.ALPHATAB_ROOT){let e=dE.globalThis.ALPHATAB_ROOT;return e=dE.ensureFullUrl(e),e=dE.appendScriptName(e)}try{let e=ib.url;if(e&&-1===e.indexOf("file://"))return e}catch(e){}return"document"in dE.globalThis&&document.currentScript&&document.currentScript instanceof HTMLScriptElement?document.currentScript.src:null}static ensureFullUrl(e){if(!e)return"";if(!e.startsWith("http")&&!e.startsWith("https")&&!e.startsWith("file")){let t="",i=dE.globalThis.location;if(t+=i.protocol?.toString(),t+="//".toString(),i.hostname&&(t+=i.hostname?.toString()),i.port&&(t+=":".toString(),t+=i.port?.toString()),!e.startsWith("/")){let e=i.pathname.split("/").slice(0,-1).join("/");e.length>0&&(e.startsWith("/")||(t+="/".toString()),t+=e?.toString())}return e.startsWith("/")||(t+="/".toString()),t+=e?.toString()}return e}static appendScriptName(e){return e&&!e.endsWith(".js")&&(e.endsWith("/")||(e+="/"),e+="alphaTab.js"),e}static detectFontDirectory(){if(!dE.isRunningInWorker&&dE.globalThis.ALPHATAB_FONT)return dE.ensureFullUrl(dE.globalThis.ALPHATAB_FONT);let e=dE.scriptFile;if(e){let t=e.lastIndexOf("/");if(t>=0)return`${e.substr(0,t)}/font/`}return null}static registerJQueryPlugin(){if(!dE.isRunningInWorker&&dE.globalThis&&"jQuery"in dE.globalThis){let e=dE.globalThis.jQuery,t=new oa;e.fn.alphaTab=function(e){let i=Array.prototype.slice.call(arguments,1);return 1===this.length?t.exec(this[0],e,i):this.each((s,a)=>{t.exec(a,e,i)})},e.alphaTab={restore:oa.restore},e.fn.alphaTab.fn=t}}static getRenderEngineFactory(e){return e&&dE.renderEngines.has(e)?dE.renderEngines.get(e):dE.renderEngines.get("default")}static getLayoutEngineFactory(e){return e&&dE.layoutEngines.has(e)?dE.layoutEngines.get(e):dE.layoutEngines.get(eX.Page)}static buildImporters(){return[new sm,new sq,new sz,new s0,new h5,new sp]}static createDefaultRenderEngines(){let e=new Map;return e.set("svg",new dD(!0,()=>new on)),e.set("default",e.get("svg")),e.set("skia",new dD(!1,()=>new h4)),dE.createPlatformSpecificRenderEngines(e),e}static enableAlphaSkia(e,t){h4.enable(e,t)}static registerAlphaSkiaCustomFont(e){return h4.registerFont(e)}static createPlatformSpecificRenderEngines(e){e.set("html5",new dD(!1,()=>new nm))}static createDefaultRenderers(){return[new o$(dE.StaffIdBeforeSlashAlways,[new l_,new lN,new lo,new dx,new oQ,new dp,new lw,new dv,new o0]),new dt,new o$(dE.StaffIdBeforeScoreAlways,[new o9,new dS,new dw,new dk,new db]),new o$(dE.StaffIdBeforeScoreHideable,[new lx,new lB,new lh(!0),new lP,new lg,new lv,new ly(!1),new hG,new df(tT.Finger)],(e,t)=>t.showStandardNotation),new hx,new o$(dE.StaffIdBeforeNumberedAlways,[new o5,new lh(!1),new o4,new df(tT.Thumb,(e,t)=>t.voice.bar.staff.showStandardNotation),new dg]),new du,new o$(dE.StaffIdBeforeTabAlways,[new ln]),new o$(dE.StaffIdBeforeTabHideable,[new lB,new lP,new lg,new lv,new ly(!0),new lb,new o8,new ls(tr.Natural),new ls(tr.Artificial),new ls(tr.Pinch),new ls(tr.Tap),new ls(tr.Semi),new ls(tr.Feedback),new la,new oZ,new le,new ld,new lp,new lc,new hG,new df(tT.Finger,(e,t)=>!t.voice.bar.staff.showStandardNotation)],(e,t)=>t.showTablature),new hV,new o$(dE.StaffIdBeforeEndAlways,[new df(tT.Thumb,(e,t)=>!t.voice.bar.staff.showStandardNotation)])]}static createDefaultStaveProfiles(){let e=new Map,t=dE.createDefaultRenderers();e.set(eJ.Default,t),e.set(eJ.ScoreTab,t);let i=new Set([dE.StaffIdBeforeSlashAlways,dE.StaffIdBeforeScoreAlways,dE.StaffIdBeforeNumberedAlways,dE.StaffIdBeforeTabAlways,hN.StaffId,dE.StaffIdBeforeEndAlways]);e.set(eJ.Score,t.filter(e=>i.has(e.staffId)));let s=new Set([dE.StaffIdBeforeSlashAlways,dE.StaffIdBeforeScoreAlways,dE.StaffIdBeforeNumberedAlways,dE.StaffIdBeforeTabAlways,hH.StaffId,dE.StaffIdBeforeEndAlways]);return e.set(eJ.Tab,dE.createDefaultRenderers().filter(e=>(e instanceof hV&&(e.showTimeSignature=!0,e.showRests=!0,e.showTiedNotes=!0),s.has(e.staffId)))),e.set(eJ.TabMixed,dE.createDefaultRenderers().filter(e=>(e instanceof hV&&(e.showTimeSignature=!1,e.showRests=!1,e.showTiedNotes=!1),s.has(e.staffId)))),e}static createDefaultLayoutEngines(){let e=new Map;return e.set(eX.Page,new dC(!0,e=>new lD(e))),e.set(eX.Horizontal,new dC(!1,e=>new lC(e))),e}static initializeMain(e,t){dE.isRunningInWorker||dE.isRunningInAudioWorklet||((dE.webPlatform===t9.Browser||dE.webPlatform===t9.BrowserModule)&&(dE.registerJQueryPlugin(),dE.HighDpiFactor=window.devicePixelRatio),dE.createWebWorker=e,dE.createAudioWorklet=t)}static get alphaTabWorker(){return dE.globalThis.Worker}static get alphaTabUrl(){return dE.globalThis.URL}static initializeWorker(){if(!dE.isRunningInWorker)throw new i6(tE.General,"Not running in worker, cannot run worker initialization");np.init(),ni.init(),dE.createWebWorker=e=>{throw new i6(tE.General,"Nested workers are not supported")}}static initializeAudioWorklet(){if(!dE.isRunningInAudioWorklet)throw new i6(tE.General,"Not running in audio worklet, cannot run worklet initialization");n6.init()}static detectWebPack(){try{if("function"==typeof __webpack_require__)return!0}catch(e){}return!1}static detectVite(){try{if("string"==typeof __BASE__)return!0}catch(e){}return!1}static detectWebPlatform(){if(!(void 0!==dE.globalThis.Window&&dE.globalThis instanceof dE.globalThis.Window))try{if("[object process]"===Object.prototype.toString.call(void 0!==iy.default?iy.default:0))return t9.NodeJs}catch(e){}try{let e=ib.url;if(e&&"string"==typeof e&&!e.startsWith("file://"))return t9.BrowserModule}catch(e){}return t9.Browser}static printEnvironmentInfo(e=!0){let t=e?e=>{iM.log.debug("VersionInfo",e)}:e=>{iM.debug("VersionInfo",e)};dF.print(t),t(`High DPI: ${dE.HighDpiFactor}`),dE.printPlatformInfo(t)}static printPlatformInfo(e){e(`Browser: ${navigator.userAgent}`),e(`Platform: ${t9[dE.webPlatform]}`),e(`WebPack: ${dE.isWebPackBundled}`),e(`Vite: ${dE.isViteBundled}`),dE.webPlatform!==t9.NodeJs&&(e(`Window Size: ${window.outerWidth}x${window.outerHeight}`),e(`Screen Size: ${window.screen.width}x${window.screen.height}`))}static prepareForPostMessage(e){if(!e)return e;if("object"==typeof e){let t=e.__v_raw;if(t)return dE.prepareForPostMessage(t)}return e}}dE.StaffIdBeforeSlashAlways="before-slash-always",dE.StaffIdBeforeScoreAlways="before-score-always",dE.StaffIdBeforeScoreHideable="before-score-hideable",dE.StaffIdBeforeNumberedAlways="before-numbered-always",dE.StaffIdBeforeTabAlways="before-tab-always",dE.StaffIdBeforeTabHideable="before-tab-hideable",dE.StaffIdBeforeEndAlways="before-end-always",dE.MusicFontSize=34,dE.HighDpiFactor=1,dE._globalThis=void 0,dE.webPlatform=dE.detectWebPlatform(),dE.isWebPackBundled=dE.detectWebPack(),dE.isViteBundled=dE.detectVite(),dE.scriptFile=dE.detectScriptFile(),dE.fontDirectory=dE.detectFontDirectory(),dE.renderEngines=dE.createDefaultRenderEngines(),dE.layoutEngines=dE.createDefaultLayoutEngines(),dE.staveProfiles=dE.createDefaultStaveProfiles(),(eV=ic||(ic={}))[eV.EmbeddedOpenType=0]="EmbeddedOpenType",eV[eV.Woff=1]="Woff",eV[eV.Woff2=2]="Woff2",eV[eV.OpenType=3]="OpenType",eV[eV.TrueType=4]="TrueType",eV[eV.Svg=5]="Svg";class dM{static buildDefaultSmuflFontSources(e){let t=new Map,i=e??"";return t.set(ic.Woff2,`${i}Bravura.woff2`),t.set(ic.Woff,`${i}Bravura.woff`),t.set(ic.OpenType,`${i}Bravura.otf`),t}constructor(){this.scriptFile=null,this.fontDirectory=null,this.smuflFontSources=null,this.file=null,this.tex=!1,this.tracks=null,this.enableLazyLoading=!0,this.engine="default",this.logLevel=tm.Info,this.useWorkers=!0,this.includeNoteBounds=!1,this.scriptFile=dE.scriptFile,this.fontDirectory=dE.fontDirectory}}(eW=iu||(iu={}))[eW.SteelGuitar=1]="SteelGuitar",eW[eW.AcousticGuitar=2]="AcousticGuitar",eW[eW.TwelveStringGuitar=3]="TwelveStringGuitar",eW[eW.ElectricGuitar=4]="ElectricGuitar",eW[eW.Bass=5]="Bass",eW[eW.ClassicalGuitar=23]="ClassicalGuitar",eW[eW.UprightBass=6]="UprightBass",eW[eW.Ukulele=7]="Ukulele",eW[eW.Banjo=8]="Banjo",eW[eW.Mandolin=9]="Mandolin",eW[eW.Piano=10]="Piano",eW[eW.Synth=12]="Synth",eW[eW.Strings=11]="Strings",eW[eW.Brass=13]="Brass",eW[eW.Reed=14]="Reed",eW[eW.Woodwind=15]="Woodwind",eW[eW.Vocal=16]="Vocal",eW[eW.PitchedIdiophone=17]="PitchedIdiophone",eW[eW.Fx=21]="Fx",eW[eW.PercussionKit=18]="PercussionKit",eW[eW.Idiophone=19]="Idiophone",eW[eW.Membraphone=20]="Membraphone";class dL{constructor(e,t,i=null){if(this.icon=iu.Piano,this.icon=e,this.instrumentSetName=t,i)this.instrumentSetType=i;else{const e=t.split(" ");e[0]=e[0].substr(0,1).toLowerCase()+e[0].substr(1),this.instrumentSetType=e.join("")}}}class dI{constructor(){this._rhythmIdLookup=new Map}writeXml(e){let t=new sB;return this._rhythmIdLookup=new Map,this.writeDom(t,e),t.toFormattedString("",!0)}writeDom(e,t){let i=e.addElement("GPIF");i.addElement("GPVersion").innerText="8.1.3";let s=i.addElement("GPRevision");s.attributes.set("required","12024"),s.attributes.set("recommended","13000"),s.innerText="13007";let a=i.addElement("Encoding");a.addElement("EncodingDescription").innerText="GP8";let r=new sS;r.nodeType=tG.Comment,r.value=`Written by alphaTab ${dF.version} (${dF.commit})`,a.addChild(r),this.writeScoreNode(i,t),this.writeMasterTrackNode(i,t),this.writeBackingTrackNode(i,t),this.writeAudioTracksNode(i,t),this.writeTracksNode(i,t),this.writeMasterBarsNode(i,t),this.writeAssets(i,t);let n=i.addElement("Bars"),o=i.addElement("Voices"),l=i.addElement("Beats"),h=i.addElement("Notes"),d=i.addElement("Rhythms");for(let e of t.tracks)for(let t of e.staves)for(let e of t.bars)for(let t of(this.writeBarNode(n,e),e.voices))for(let e of(this.writeVoiceNode(o,t),t.beats))for(let t of(this.writeBeatNode(l,e,d),e.notes))this.writeNoteNode(h,t)}writeAssets(e,t){if(!t.backingTrack?.rawAudioFile)return;let i=e.addElement("Assets").addElement("Asset");i.attributes.set("id",this.backingTrackAssetId),this.backingTrackAssetFileName="Content/Assets/backing-track",i.addElement("EmbeddedFilePath").setCData(this.backingTrackAssetFileName)}writeBackingTrackNode(e,t){if(!t.backingTrack?.rawAudioFile)return;let i=e.addElement("BackingTrack");this.backingTrackAssetId="0",i.addElement("IconId").innerText="21",i.addElement("Color").innerText="0 0 0",i.addElement("Name").setCData("Audio Track"),i.addElement("ShortName").setCData("a.track"),i.addElement("PlaybackState").innerText="Default",i.addElement("Enabled").innerText="true",i.addElement("Source").innerText="Local",i.addElement("AssetId").innerText="0";let s=i.addElement("ChannelStrip");s.addElement("Parameters").innerText="0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.000000 0.500000 0.500000 0.800000 0.500000 0.500000 0.500000",s.addElement("YouTubeVideoUrl").innerText="",s.addElement("Filter").innerText="6",s.addElement("FramesPerPixel").innerText="400";let a=void 0!==this.backingTrackFramePadding?this.backingTrackFramePadding:0;i.addElement("FramePadding").innerText=`${a}`,i.addElement("Semitones").innerText="0",i.addElement("Cents").innerText="0"}writeNoteNode(e,t){let i=e.addElement("Note");i.attributes.set("id",t.id.toString()),this.writeNoteProperties(i,t),t.isGhost&&(i.addElement("AntiAccent").innerText="normal"),t.isLetRing&&i.addElement("LetRing"),t.isTrill&&(i.addElement("Trill").innerText=t.trillValue.toString());let s=0;switch(t.isStaccato&&(s|=1),t.accentuated){case ts.Normal:s|=8;break;case ts.Heavy:s|=4;break;case ts.Tenuto:s|=16}if(s>0&&(i.addElement("Accent").innerText=s.toString()),t.isTieOrigin||t.isTieDestination){let e=i.addElement("Tie");e.attributes.set("origin",t.isTieOrigin?"true":"false"),e.attributes.set("destination",t.isTieDestination?"true":"false")}switch(t.vibrato){case th.Slight:i.addElement("Vibrato").innerText="Slight";break;case th.Wide:i.addElement("Vibrato").innerText="Wide"}if(t.isFingering){switch(t.leftHandFinger){case ta.Thumb:i.addElement("LeftFingering").innerText="P";break;case ta.IndexFinger:i.addElement("LeftFingering").innerText="I";break;case ta.MiddleFinger:i.addElement("LeftFingering").innerText="M";break;case ta.AnnularFinger:i.addElement("LeftFingering").innerText="A";break;case ta.LittleFinger:i.addElement("LeftFingering").innerText="C"}switch(t.rightHandFinger){case ta.Thumb:i.addElement("RightFingering").innerText="P";break;case ta.IndexFinger:i.addElement("RightFingering").innerText="I";break;case ta.MiddleFinger:i.addElement("RightFingering").innerText="M";break;case ta.AnnularFinger:i.addElement("RightFingering").innerText="A";break;case ta.LittleFinger:i.addElement("RightFingering").innerText="C"}}t.percussionArticulation>=0?i.addElement("InstrumentArticulation").innerText=t.percussionArticulation.toString():i.addElement("InstrumentArticulation").innerText="0",t.ornament!==tw.None&&(i.addElement("Ornament").innerText=tw[t.ornament])}writeNoteProperties(e,t){let i=e.addElement("Properties");if(this.writeConcertPitch(i,t),this.writeTransposedPitch(i,t),t.isStringed&&(this.writeSimplePropertyNode(i,"String","String",(t.string-1).toString()),this.writeSimplePropertyNode(i,"Fret","Fret",t.fret.toString()),this.writeSimplePropertyNode(i,"Midi","Number",t.realValue.toString()),t.showStringNumber&&this.writeSimplePropertyNode(i,"ShowStringNumber","Enable",null)),t.isPiano&&(this.writeSimplePropertyNode(i,"Octave","Number",t.octave.toString()),this.writeSimplePropertyNode(i,"Tone","Step",t.tone.toString()),this.writeSimplePropertyNode(i,"Midi","Number",t.realValue.toString())),t.beat.tap&&this.writeSimplePropertyNode(i,"Tapped","Enable",null),t.harmonicType!==tr.None){switch(t.harmonicType){case tr.Natural:this.writeSimplePropertyNode(i,"HarmonicType","HType","Natural");break;case tr.Artificial:this.writeSimplePropertyNode(i,"HarmonicType","HType","Artificial");break;case tr.Pinch:this.writeSimplePropertyNode(i,"HarmonicType","HType","Pinch");break;case tr.Tap:this.writeSimplePropertyNode(i,"HarmonicType","HType","Tap");break;case tr.Semi:this.writeSimplePropertyNode(i,"HarmonicType","HType","Semi");break;case tr.Feedback:this.writeSimplePropertyNode(i,"HarmonicType","HType","Feedback")}0!==t.harmonicValue&&this.writeSimplePropertyNode(i,"HarmonicFret","HFret",t.harmonicValue.toString())}t.isDead&&this.writeSimplePropertyNode(i,"Muted","Enable",null),t.isPalmMute&&this.writeSimplePropertyNode(i,"PalmMuted","Enable",null),t.hasBend&&this.writeBend(i,t),t.isHammerPullOrigin&&this.writeSimplePropertyNode(i,"HopoOrigin","Enable",null),t.isHammerPullDestination&&this.writeSimplePropertyNode(i,"HopoDestination","Enable",null),t.isLeftHandTapped&&this.writeSimplePropertyNode(i,"LeftHandTapped","Enable",null);let s=0;switch(t.slideInType){case to.IntoFromAbove:s|=32;break;case to.IntoFromBelow:s|=16}switch(t.slideOutType){case tl.Shift:s|=1;break;case tl.Legato:s|=2;break;case tl.OutDown:s|=4;break;case tl.OutUp:s|=8;break;case tl.PickSlideDown:s|=64;break;case tl.PickSlideUp:s|=128}s>0&&this.writeSimplePropertyNode(i,"Slide","Flags",s.toString())}writeTransposedPitch(e,t){t.isPercussion?this.writePitch(e,"ConcertPitch","C","-1",""):this.writePitchForValue(e,"TransposedPitch",t.displayValueWithoutBend,t.accidentalMode)}writeConcertPitch(e,t){t.isPercussion?this.writePitch(e,"ConcertPitch","C","-1",""):this.writePitchForValue(e,"ConcertPitch",t.realValueWithoutHarmonic,t.accidentalMode)}writePitchForValue(e,t,i,s){let a=0,r=0,n="",o="",l=()=>{a=i%12,r=i/12|0,n=sa.defaultSteps[a],o=sa.defaultAccidentals[a]};switch(l(),s){case tn.Default:break;case tn.ForceNone:case tn.ForceNatural:o="";break;case tn.ForceSharp:o="#";break;case tn.ForceDoubleSharp:"#"===o&&(i-=2,l()),o="x";break;case tn.ForceFlat:"#"===o&&(i+=1,l()),o="b";break;case tn.ForceDoubleFlat:"#"===o&&(i+=2,l()),o="bb"}this.writePitch(e,t,n,r.toString(),o)}writePitch(e,t,i,s,a){let r=e.addElement("Property");r.attributes.set("name",t);let n=r.addElement("Pitch");n.addElement("Step").innerText=i,n.addElement("Accidental").innerText=a,n.addElement("Octave").innerText=s}writeBend(e,t){t.hasBend&&t.bendPoints.length<=4&&this.writeStandardBend(e,t.bendPoints)}writeStandardBend(e,t){let i,s;this.writeSimplePropertyNode(e,"Bended","Enable",null);let a=t[0],r=t[t.length-1];switch(t.length){case 4:i=t[1],s=t[2];break;case 3:i=t[1],s=t[1];break;default:s=i=new iF((a.offset+r.offset)/2,(a.value+r.value)/2)}this.writeSimplePropertyNode(e,"BendDestinationOffset","Float",this.toBendOffset(r.offset).toString()),this.writeSimplePropertyNode(e,"BendDestinationValue","Float",this.toBendValue(r.value).toString()),this.writeSimplePropertyNode(e,"BendMiddleOffset1","Float",this.toBendOffset(i.offset).toString()),this.writeSimplePropertyNode(e,"BendMiddleOffset2","Float",this.toBendOffset(s.offset).toString()),this.writeSimplePropertyNode(e,"BendMiddleValue","Float",this.toBendValue(i.value).toString()),this.writeSimplePropertyNode(e,"BendOriginOffset","Float",this.toBendOffset(a.offset).toString()),this.writeSimplePropertyNode(e,"BendOriginValue","Float",this.toBendValue(a.value).toString())}toBendValue(e){return 25*e}toBendOffset(e){return e/iF.MaxPosition*100}writeBeatNode(e,t,i){let s=e.addElement("Beat");if(s.attributes.set("id",t.id.toString()),s.addElement("Dynamic").innerText=e4[t.dynamics],t.fade!==tN.None&&(s.addElement("Fadding").innerText=tN[t.fade]),t.isTremolo)switch(t.tremoloSpeed){case tt.Eighth:s.addElement("Tremolo").innerText="1/2";break;case tt.Sixteenth:s.addElement("Tremolo").innerText="1/4";break;case tt.ThirtySecond:s.addElement("Tremolo").innerText="1/8"}switch(t.hasChord&&s.addElement("Chord").setCData(t.chordId),t.crescendo!==te.None&&(s.addElement("Hairpin").innerText=te[t.crescendo]),t.brushType){case e9.ArpeggioUp:s.addElement("Arpeggio").innerText="Up";break;case e9.ArpeggioDown:s.addElement("Arpeggio").innerText="Down"}switch(t.text&&s.addElement("FreeText").setCData(t.text),t.graceType){case ti.OnBeat:case ti.BeforeBeat:s.addElement("GraceNotes").innerText=ti[t.graceType]}if(t.ottava!==eQ.Regular&&(s.addElement("Ottavia").innerText=eQ[t.ottava].substr(1)),t.hasWhammyBar&&this.writeWhammyNode(s,t),t.isLegatoOrigin||t.isLegatoDestination){let e=s.addElement("Legato");e.attributes.set("origin",t.isLegatoOrigin?"true":"false"),e.attributes.set("destination",t.isLegatoDestination?"true":"false")}if(this.writeRhythm(s,t,i),null!==t.preferredBeamDirection)switch(t.preferredBeamDirection){case tR.Up:s.addElement("TransposedPitchStemOrientation").innerText="Upward",s.addElement("UserTransposedPitchStemOrientation").innerText="Upward";break;case tR.Down:s.addElement("TransposedPitchStemOrientation").innerText="Downward",s.addElement("UserTransposedPitchStemOrientation").innerText="Downward"}s.addElement("ConcertPitchStemOrientation").innerText="Undefined",t.slashed&&s.addElement("Slashed"),t.deadSlapped&&s.addElement("DeadSlapped"),t.notes.length>0&&(s.addElement("Notes").innerText=t.notes.map(e=>e.id).join(" ")),t.golpe!==tT.None&&(s.addElement("Golpe").innerText=tT[t.golpe]),t.wahPedal!==tx.None&&(s.addElement("Wah").innerText=tx[t.wahPedal]),t.showTimer&&(s.addElement("Timer").innerText=(t.timer??0).toString()),this.writeBeatProperties(s,t),this.writeBeatXProperties(s,t),t.lyrics&&t.lyrics.length>0&&this.writeBeatLyrics(s,t.lyrics)}writeBeatLyrics(e,t){let i=e.addElement("Lyrics");for(let e of t)i.addElement("Line").setCData(e)}writeBeatXProperties(e,t){let i=e.addElement("XProperties");switch(t.brushDuration>0&&this.writeSimpleXPropertyNode(i,"687935489","Int",t.brushDuration.toString()),t.beamingMode){case tF.ForceSplitToNext:this.writeSimpleXPropertyNode(i,"1124204546","Int","2");break;case tF.ForceMergeWithNext:this.writeSimpleXPropertyNode(i,"1124204546","Int","1");break;case tF.ForceSplitOnSecondaryToNext:this.writeSimpleXPropertyNode(i,"1124204552","Int","1")}}writeBeatProperties(e,t){let i=e.addElement("Properties");switch(t.brushType){case e9.BrushUp:this.writeSimplePropertyNode(i,"Brush","Direction","Up");break;case e9.BrushDown:this.writeSimplePropertyNode(i,"Brush","Direction","Down")}switch(t.pickStroke){case ty.Up:this.writeSimplePropertyNode(i,"PickStroke","Direction","Up");break;case ty.Down:this.writeSimplePropertyNode(i,"PickStroke","Direction","Down")}switch(t.slap&&this.writeSimplePropertyNode(i,"Slapped","Enable",null),t.pop&&this.writeSimplePropertyNode(i,"Popped","Enable",null),t.vibrato){case th.Wide:this.writeSimplePropertyNode(i,"VibratoWTremBar","Strength","Wide");break;case th.Slight:this.writeSimplePropertyNode(i,"VibratoWTremBar","Strength","Slight")}if(t.isBarre)switch(this.writeSimplePropertyNode(i,"BarreFret","Fret",t.barreFret.toString()),t.barreShape){case tP.Full:this.writeSimplePropertyNode(i,"BarreString","String","0");break;case tP.Half:this.writeSimplePropertyNode(i,"BarreString","String","1")}if(t.rasgueado!==tv.None){let e="";switch(t.rasgueado){case tv.Ii:e="ii_1";break;case tv.Mi:e="mi_1";break;case tv.MiiTriplet:e="mii_1";break;case tv.MiiAnapaest:e="mii_2";break;case tv.PmpTriplet:e="pmp_1";break;case tv.PmpAnapaest:e="pmp_2";break;case tv.PeiTriplet:e="pei_1";break;case tv.PeiAnapaest:e="pei_2";break;case tv.PaiTriplet:e="pai_1";break;case tv.PaiAnapaest:e="pai_2";break;case tv.AmiTriplet:e="ami_1";break;case tv.AmiAnapaest:e="ami_2";break;case tv.Ppp:e="ppp_1";break;case tv.Amii:e="amii_1";break;case tv.Amip:e="amip_1";break;case tv.Eami:e="eami_1";break;case tv.Eamii:e="eamii_1";break;case tv.Peami:e="peami_1"}this.writeSimplePropertyNode(i,"Rasgueado","Rasgueado",e)}}writeRhythm(e,t,i){let s,a=`${t.duration}_${t.dots}_${t.tupletNumerator}_${t.tupletDenominator}';`;if(this._rhythmIdLookup.has(a))s=this._rhythmIdLookup.get(a);else{s=this._rhythmIdLookup.size.toString(),this._rhythmIdLookup.set(a,s);let e=i.addElement("Rhythm");if(e.attributes.set("id",s),t.hasTuplet){let i=e.addElement("PrimaryTuplet");i.attributes.set("num",t.tupletNumerator.toString()),i.attributes.set("den",t.tupletDenominator.toString())}t.dots>0&&e.addElement("AugmentationDot").attributes.set("count",t.dots.toString());let r="Quarter";switch(t.duration){case tt.QuadrupleWhole:r="Long";break;case tt.DoubleWhole:r="DoubleWhole";break;case tt.Whole:r="Whole";break;case tt.Half:r="Half";break;case tt.Quarter:r="Quarter";break;case tt.Eighth:r="Eighth";break;case tt.Sixteenth:r="16th";break;case tt.ThirtySecond:r="32nd";break;case tt.SixtyFourth:r="64th";break;case tt.OneHundredTwentyEighth:r="128th";break;case tt.TwoHundredFiftySixth:r="256th"}e.addElement("NoteValue").innerText=r}e.addElement("Rhythm").attributes.set("ref",s)}writeWhammyNode(e,t){t.hasWhammyBar&&t.whammyBarPoints.length<=4&&this.writeStandardWhammy(e,t.whammyBarPoints)}writeStandardWhammy(e,t){let i,s,a=e.addElement("Whammy"),r=t[0],n=t[t.length-1];switch(t.length){case 4:i=t[1],s=t[2];break;case 3:i=t[1],s=t[1];break;default:s=i=new iF((r.offset+n.offset)/2,(r.value+n.value)/2)}a.attributes.set("destinationOffset",this.toBendOffset(n.offset).toString()),a.attributes.set("destinationValue",this.toBendValue(n.value).toString()),a.attributes.set("middleOffset1",this.toBendOffset(i.offset).toString()),a.attributes.set("middleOffset2",this.toBendOffset(s.offset).toString()),a.attributes.set("middleValue",this.toBendValue(i.value).toString()),a.attributes.set("originOffset",this.toBendOffset(r.offset).toString()),a.attributes.set("originValue",this.toBendValue(r.value).toString())}writeScoreNode(e,t){let i=e.addElement("Score");i.addElement("Title").setCData(t.title),i.addElement("SubTitle").setCData(t.subTitle),i.addElement("Artist").setCData(t.artist),i.addElement("Album").setCData(t.album),i.addElement("Words").setCData(t.words),i.addElement("Music").setCData(t.music),i.addElement("WordsAndMusic").setCData(t.words===t.music?t.words:""),i.addElement("Copyright").setCData(t.copyright),i.addElement("Tabber").setCData(t.tab),i.addElement("Instructions").setCData(t.instructions),i.addElement("Notices").setCData(t.notices),i.addElement("FirstPageHeader").setCData(""),i.addElement("FirstPageFooter").setCData(""),i.addElement("PageHeader").setCData(""),i.addElement("PageFooter").setCData(""),i.addElement("ScoreSystemsDefaultLayout").setCData(t.defaultSystemsLayout.toString()),i.addElement("ScoreSystemsLayout").setCData(t.systemsLayout.join(" ")),i.addElement("ScoreZoomPolicy").innerText="Value",i.addElement("ScoreZoom").innerText="1",i.addElement("MultiVoice").innerText="1>"}writeMasterTrackNode(e,t){let i=e.addElement("MasterTrack");i.addElement("Tracks").innerText=t.tracks.map(e=>e.index).join(" ");let s=i.addElement("Automations");if(t.masterBars.length>0&&t.masterBars[0].isAnacrusis&&i.addElement("Anacrusis"),0===t.masterBars[0].tempoAutomations.length){let e=s.addElement("Automation");e.addElement("Type").innerText="Tempo",e.addElement("Linear").innerText="false",e.addElement("Bar").innerText="0",e.addElement("Position").innerText="0",e.addElement("Visible").innerText="true",e.addElement("Value").innerText=`${t.tempo} 2`,t.tempoLabel&&(e.addElement("Text").innerText=t.tempoLabel)}let a=t.masterBars[0].syncPoints?t.masterBars[0].syncPoints.find(e=>0===e.ratioPosition&&0===e.syncPointValue.barOccurence):void 0,r=a?a.syncPointValue.millisecondOffset:0;this.backingTrackFramePadding=-1*(r/1e3*dI.SampleRate)|0;let n=new iD(()=>nv.buildModifiedTempoLookup(t));for(let e of t.masterBars){for(let t of e.tempoAutomations){let i=s.addElement("Automation");i.addElement("Type").innerText="Tempo",i.addElement("Linear").innerText=t.isLinear?"true":"false",i.addElement("Bar").innerText=e.index.toString(),i.addElement("Position").innerText=t.ratioPosition.toString(),i.addElement("Visible").innerText="true",i.addElement("Value").innerText=`${t.value} 2`,t.text&&(i.addElement("Text").innerText=t.text)}if(e.syncPoints)for(let i of e.syncPoints){let a=s.addElement("Automation");a.addElement("Type").innerText="SyncPoint",a.addElement("Linear").innerText="false",a.addElement("Bar").innerText=e.index.toString(),a.addElement("Position").innerText=i.ratioPosition.toString(),a.addElement("Visible").innerText="true";let o=a.addElement("Value");o.addElement("BarIndex").innerText=e.index.toString(),o.addElement("BarOccurrence").innerText=i.syncPointValue.barOccurence.toString(),o.addElement("ModifiedTempo").innerText=n.value.get(i).syncBpm.toString(),o.addElement("OriginalTempo").innerText=t.tempo.toString();let l=(i.syncPointValue.millisecondOffset-r)/1e3*dI.SampleRate;l=Math.floor(l+.5),o.addElement("FrameOffset").innerText=l.toString()}}}writeAudioTracksNode(e,t){e.addElement("AudioTracks")}writeTracksNode(e,t){let i=e.addElement("Tracks");for(let e of t.tracks)this.writeTrackNode(i,e)}writeTrackNode(e,t){let i=e.addElement("Track");i.attributes.set("id",t.index.toString()),i.addElement("Name").setCData(t.name),i.addElement("ShortName").setCData(t.shortName),i.addElement("Color").innerText=`${t.color.r} ${t.color.g} ${t.color.b}`,i.addElement("SystemsDefautLayout").innerText=t.defaultSystemsLayout.toString(),i.addElement("SystemsLayout").innerText=t.systemsLayout.join(" "),i.addElement("AutoBrush"),i.addElement("PalmMute").innerText="0",i.addElement("PlayingStyle").innerText=iS.isGuitar(t.playbackInfo.program)?"StringedPick":"Default",i.addElement("UseOneChannelPerString"),i.addElement("IconId").innerText=dI.getIconId(t.playbackInfo).toString(),this.writeInstrumentSetNode(i,t),this.writeTransposeNode(i,t),this.writeRseNode(i,t),i.addElement("ForcedSound").innerText="-1",this.writeMidiConnectionNode(i,t),t.playbackInfo.isSolo?i.addElement("PlaybackState").innerText="Solo":t.playbackInfo.isMute?i.addElement("PlaybackState").innerText="Mute":i.addElement("PlaybackState").innerText="Default",i.addElement("AudioEngineState").innerText="MIDI",this.writeLyricsNode(i,t),this.writeStavesNode(i,t),this.writeSoundsAndAutomations(i,t)}static getIconId(e){return 9===e.primaryChannel?dI.DrumKitProgramInfo.icon:dI.MidiProgramInfoLookup.has(e.program)?dI.MidiProgramInfoLookup.get(e.program).icon:iu.SteelGuitar}writeSoundAndAutomation(e,t,i,s,a,r,n,o=0){let l=e.addElement("Sound");l.addElement("Name").setCData(i),l.addElement("Label").setCData(i),l.addElement("Path").setCData(s),l.addElement("Role").setCData(a);let h=l.addElement("MIDI");h.addElement("LSB").innerText="0",h.addElement("MSB").innerText="0",h.addElement("Program").innerText=n.toString();let d=t.addElement("Automation");d.addElement("Type").innerText="Sound",d.addElement("Linear").innerText="false",d.addElement("Bar").innerText=r.toString(),d.addElement("Position").innerText=o.toString(),d.addElement("Visible").innerText="true",d.addElement("Value").setCData(`${s};${i};${a}`)}writeSoundsAndAutomations(e,t){let i=e.addElement("Sounds"),s=e.addElement("Automations");if(t.staves.length>0&&t.staves[0].bars.length>0){let e=`Track_${t.index}_Initial`,a=`Midi/${t.playbackInfo.program}`,r="Factory",n=!1;for(let o of t.staves)for(let l of o.bars)for(let o of l.voices)for(let h of o.beats){let o=h.getAutomation(e6.Instrument),d=0===l.index&&0===h.index;if(o){let c=d?e:`ProgramChange_${h.id}`,u=d?a:`Midi/${o.value}`,p=d?r:"User";d||n||(this.writeSoundAndAutomation(i,s,e,a,r,t.staves[0].bars[0].index,t.playbackInfo.program),n=!0),this.writeSoundAndAutomation(i,s,c,u,p,l.index,o.value,o.ratioPosition),d&&(n=!0)}}}for(let e of t.staves)for(let t of e.bars)for(let e of t.sustainPedals)if(e.pedalType!==e2.Hold){let i=s.addElement("Automation");switch(i.addElement("Type").innerText="SustainPedal",i.addElement("Linear").innerText="false",i.addElement("Bar").innerText=t.index.toString(),i.addElement("Position").innerText=e.ratioPosition.toString(),i.addElement("Visible").innerText="true",e.pedalType){case e2.Down:i.addElement("Value").innerText="0 1";break;case e2.Up:i.addElement("Value").innerText="0 3"}}}writeMidiConnectionNode(e,t){let i=e.addElement("MidiConnection");i.addElement("Port").innerText=t.playbackInfo.port.toString(),i.addElement("PrimaryChannel").innerText=t.playbackInfo.primaryChannel.toString(),i.addElement("SecondaryChannel").innerText=t.playbackInfo.secondaryChannel.toString(),i.addElement("ForeOneChannelPerString").innerText="false"}writeRseNode(e,t){let i=e.addElement("RSE").addElement("ChannelStrip");i.attributes.set("version","E56"),i.addElement("Parameters").innerText=`0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 1 0.5 ${t.playbackInfo.balance/16} ${t.playbackInfo.volume/16} 0.5 0.5 0.5`}writeStavesNode(e,t){let i=e.addElement("Staves");for(let e of t.staves)this.writeStaffNode(i,e)}writeStaffNode(e,t){let i=e.addElement("Staff").addElement("Properties");if(this.writeSimplePropertyNode(i,"CapoFret","Fret",t.capo.toString()),this.writeSimplePropertyNode(i,"FretCount","Fret","24"),t.tuning.length>0){let e=i.addElement("Property");switch(e.attributes.set("name","Tuning"),e.addElement("Pitches").innerText=t.tuning.slice().reverse().join(" "),e.addElement("Label").setCData(t.tuningName),e.addElement("LabelVisible").innerText=t.tuningName?"true":"false",e.addElement("Flat"),t.tuning.length){case 3:e.addElement("Instrument").innerText="Shamisen";break;case 4:105===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Banjo":42===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Cello":43===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Contrabass":40===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Violin":41===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Viola":e.addElement("Instrument").innerText="Bass";break;case 5:105===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Banjo":e.addElement("Instrument").innerText="Bass";break;case 6:105===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Banjo":t.track.playbackInfo.program<=39?e.addElement("Instrument").innerText="Bass":e.addElement("Instrument").innerText="Guitar";break;case 7:t.track.playbackInfo.program<=39?e.addElement("Instrument").innerText="Bass":e.addElement("Instrument").innerText="Guitar";break;default:e.addElement("Instrument").innerText="Guitar"}}this.writeSimplePropertyNode(i,"PartialCapoFret","Fret","0"),this.writeSimplePropertyNode(i,"PartialCapoStringFlags","Bitset",t.tuning.map(e=>"0").join("")),this.writeSimplePropertyNode(i,"TuningFlat","Enable",null),this.writeDiagramCollection(i,t,"DiagramCollection"),this.writeDiagramCollection(i,t,"DiagramWorkingSet")}writeDiagramCollection(e,t,i){let s=e.addElement("Property");s.attributes.set("name",i);let a=s.addElement("Items"),r=t.chords;if(r)for(let[e,t]of r){let i=a.addElement("Item");i.attributes.set("id",e),i.attributes.set("name",t.name);let s=i.addElement("Diagram");s.attributes.set("stringCount",t.strings.length.toString()),s.attributes.set("fretCount","5"),s.attributes.set("baseFret",(t.firstFret-1).toString()),s.attributes.set("barStates",t.strings.map(e=>"1").join(" "));let r=[],n=new Map;for(let e=0;e<t.strings.length;e++){let i=t.strings[e];if(-1!==i){let a=s.addElement("Fret"),o=t.strings.length-1-e;a.attributes.set("string",o.toString()),a.attributes.set("fret",(i-t.firstFret+1).toString()),n.has(i)||(n.set(i,[]),r.push(i)),n.get(i).push(o)}}r.sort();let o=s.addElement("Fingering");if(t.barreFrets.length>0){let e=[ta.LittleFinger,ta.AnnularFinger,ta.MiddleFinger,ta.IndexFinger];for(let i of r){let s=n.get(i);if(s.length>1&&t.barreFrets.indexOf(i)>=0){let a=e.length>0?e.pop():ta.IndexFinger;for(let e of s){let s=o.addElement("Position");switch(a){case ta.LittleFinger:s.attributes.set("finger","Pinky");break;case ta.AnnularFinger:s.attributes.set("finger","Ring");break;case ta.MiddleFinger:s.attributes.set("finger","Middle");break;case ta.IndexFinger:s.attributes.set("finger","Index")}s.attributes.set("fret",(i-t.firstFret+1).toString()),s.attributes.set("string",e.toString())}}}}let l=s.addElement("Property");l.attributes.set("name","ShowName"),l.attributes.set("type","bool"),l.attributes.set("value",t.showName?"true":"false");let h=s.addElement("Property");h.attributes.set("name","ShowDiagram"),h.attributes.set("type","bool"),h.attributes.set("value",t.showDiagram?"true":"false");let d=s.addElement("Property");d.attributes.set("name","ShowFingering"),d.attributes.set("type","bool"),d.attributes.set("value",t.showFingering?"true":"false");let c=s.addElement("Chord"),u=c.addElement("KeyNote");u.attributes.set("step","C"),u.attributes.set("accidental","Natural");let p=c.addElement("BassNote");p.attributes.set("step","C"),p.attributes.set("accidental","Natural");let m=c.addElement("Degree");m.attributes.set("interval","Third"),m.attributes.set("alteration","Major"),m.attributes.set("omitted","false");let g=c.addElement("Degree");g.attributes.set("interval","Fifth"),g.attributes.set("alteration","Perfect"),g.attributes.set("omitted","false")}}writeSimplePropertyNode(e,t,i,s){let a=e.addElement("Property");a.attributes.set("name",t);let r=a.addElement(i);return null!==s&&(r.innerText=s),a}writeSimpleXPropertyNode(e,t,i,s){let a=e.addElement("XProperty");a.attributes.set("id",t);let r=a.addElement(i);return null!==s&&(r.innerText=s),a}writeLyricsNode(e,t){let i=e.addElement("Lyrics");i.attributes.set("dispatched","true");let s=[];for(let e of t.staves[0].bars)for(let t of e.voices)if(!t.isEmpty){for(let i of t.beats)if(i.lyrics)for(let t=0;t<i.lyrics.length;t++){for(;t>=s.length;){let t=new i9;t.startBar=e.index,t.text="[Empty]",s.push(t)}let a=s[t];a.text="[Empty]"===a.text?i.lyrics[t]:`${a.text} ${i.lyrics[t].split(" ").join("+")}`}}for(let e=0;e<s.length;e++){let t=i.addElement("Line");t.addElement("Text").setCData(s[e].text),t.addElement("Offset").innerText=s[e].startBar.toString()}}writeTransposeNode(e,t){let i=e.addElement("Transpose"),s=Math.floor(t.staves[0].displayTranspositionPitch/12),a=t.staves[0].displayTranspositionPitch-12*s;i.addElement("Chromatic").innerText=a.toString(),i.addElement("Octave").innerText=s.toString()}writeInstrumentSetNode(e,t){let i=e.addElement("InstrumentSet"),s=t.staves[0];if(i.addElement("LineCount").innerText=s.standardNotationLineCount.toString(),t.percussionArticulations.length>0||s.isPercussion){let e=t.percussionArticulations.length>0?t.percussionArticulations:Array.from(iU.instrumentArticulations.values());i.addElement("Name").innerText=dI.DrumKitProgramInfo.instrumentSetName,i.addElement("Type").innerText=dI.DrumKitProgramInfo.instrumentSetType;let s="",a=new sS,r=new Map,n=i.addElement("Elements");for(let t of e){{let e=n.addElement("Element"),i=t.elementType;if(r.has(i)){let e=r.get(i);i+=` ${e}`,r.set(i,e+1)}else r.set(i,1);s=i,e.addElement("Name").innerText=i,e.addElement("Type").innerText=t.elementType,a=e.addElement("Articulations")}let e=a.addElement("Articulation");switch(e.addElement("Name").innerText=`${s} ${a.childNodes.length}`,e.addElement("StaffLine").innerText=t.staffLine.toString(),e.addElement("Noteheads").innerText=[this.mapMusicSymbol(t.noteHeadDefault),this.mapMusicSymbol(t.noteHeadHalf),this.mapMusicSymbol(t.noteHeadWhole)].join(" "),t.techniqueSymbolPlacement){case t_.Top:e.addElement("TechniquePlacement").innerText="below";break;case t_.Middle:e.addElement("TechniquePlacement").innerText="inside";break;case t_.Bottom:e.addElement("TechniquePlacement").innerText="above"}e.addElement("TechniqueSymbol").innerText=this.mapMusicSymbol(t.techniqueSymbol),e.addElement("InputMidiNumbers").innerText="",e.addElement("OutputMidiNumber").innerText=t.outputMidiNumber.toString()}}else{let e=dI.MidiProgramInfoLookup.has(t.playbackInfo.program)?dI.MidiProgramInfoLookup.get(t.playbackInfo.program):dI.MidiProgramInfoLookup.get(0);i.addElement("Name").innerText=e.instrumentSetName,i.addElement("Type").innerText=e.instrumentSetType;let s=i.addElement("Elements").addElement("Element");s.addElement("Pitched").innerText="Pitched",s.addElement("Type").innerText="pitched",s.addElement("SoundbankName").innerText="";let a=s.addElement("Articulations").addElement("Articulation");a.addElement("Name").innerText="",a.addElement("StaffLine").innerText="0",a.addElement("Noteheads").innerText="noteheadBlack noteheadHalf noteheadWhole",a.addElement("TechniquePlacement").innerText="outside",a.addElement("TechniqueSymbol").innerText="",a.addElement("InputMidiNumbers").innerText="",a.addElement("OutputRSESound").innerText="",a.addElement("OutputMidiNumber").innerText="0"}}mapMusicSymbol(e){if(e===tb.None)return"";let t=tb[e];return t.substring(0,1).toLowerCase()+t.substring(1)}writeMasterBarsNode(e,t){let i=e.addElement("MasterBars");for(let e of t.masterBars)this.writeMasterBarNode(i,e)}writeMasterBarNode(e,t){let i=e.addElement("MasterBar"),s=i.addElement("Key");s.addElement("AccidentalCount").innerText=t.keySignature.toString(),s.addElement("Mode").innerText=e1[t.keySignatureType],s.addElement("Sharps").innerText="Sharps",i.addElement("Time").innerText=`${t.timeSignatureNumerator}/${t.timeSignatureDenominator}`,t.isFreeTime&&i.addElement("FreeTime");let a=[];for(let e of t.score.tracks)for(let i of e.staves)a.push(i.bars[t.index].id.toString());if(i.addElement("Bars").innerText=a.join(" "),t.isDoubleBar&&i.addElement("DoubleBar"),t.isSectionStart){let e=i.addElement("Section");e.addElement("Letter").setCData(t.section.marker),e.addElement("Text").setCData(t.section.text)}if(t.isRepeatStart||t.isRepeatEnd){let e=i.addElement("Repeat");e.attributes.set("start",t.isRepeatStart?"true":"false"),e.attributes.set("end",t.isRepeatEnd?"true":"false"),t.isRepeatEnd&&e.attributes.set("count",t.repeatCount.toString())}if(t.alternateEndings>0){let e=t.alternateEndings,s=[],a=0;for(;e>0;)(e>>a&1)==1&&(s.push(a+1),e&=~(1<<a)),a++;i.addElement("AlternateEndings").innerText=s.join(" ")}if(t.tripletFeel!==tg.NoTripletFeel&&(i.addElement("TripletFeel").innerText=tg[t.tripletFeel]),t.directions&&t.directions.size>0){let e=i.addElement("Directions");for(let i of t.directions)switch(i){case tI.TargetFine:e.addElement("Target").innerText="Fine";break;case tI.TargetSegno:e.addElement("Target").innerText="Segno";break;case tI.TargetSegnoSegno:e.addElement("Target").innerText="SegnoSegno";break;case tI.TargetCoda:e.addElement("Target").innerText="Coda";break;case tI.TargetDoubleCoda:e.addElement("Target").innerText="DoubleCoda";break;case tI.JumpDaCapo:e.addElement("Jump").innerText="DaCapo";break;case tI.JumpDaCapoAlCoda:e.addElement("Jump").innerText="DaCapoAlCoda";break;case tI.JumpDaCapoAlDoubleCoda:e.addElement("Jump").innerText="DaCapoAlDoubleCoda";break;case tI.JumpDaCapoAlFine:e.addElement("Jump").innerText="DaCapoAlFine";break;case tI.JumpDalSegno:e.addElement("Jump").innerText="DaSegno";break;case tI.JumpDalSegnoAlCoda:e.addElement("Jump").innerText="DaSegnoAlCoda";break;case tI.JumpDalSegnoAlDoubleCoda:e.addElement("Jump").innerText="DaSegnoAlDoubleCoda";break;case tI.JumpDalSegnoAlFine:e.addElement("Jump").innerText="DaSegnoAlFine";break;case tI.JumpDalSegnoSegno:e.addElement("Jump").innerText="DaSegnoSegno";break;case tI.JumpDalSegnoSegnoAlCoda:e.addElement("Jump").innerText="DaSegnoSegnoAlCoda";break;case tI.JumpDalSegnoSegnoAlDoubleCoda:e.addElement("Jump").innerText="DaSegnoSegnoAlDoubleCoda";break;case tI.JumpDalSegnoSegnoAlFine:e.addElement("Jump").innerText="DaSegnoSegnoAlFine";break;case tI.JumpDaCoda:e.addElement("Jump").innerText="DaCoda";break;case tI.JumpDaDoubleCoda:e.addElement("Jump").innerText="DaDoubleCoda"}}this.writeFermatas(i,t)}writeFermatas(e,t){let i=t.fermata?.size??0;if(0!==i&&i>0){let i=e.addElement("Fermatas");for(let[e,s]of t.fermata)this.writeFermata(i,e,s)}}writeFermata(e,t,i){let s=-1,a=1;if(t>0)for(;a<10&&(s=t/ix.QuarterTime*a)!==Math.floor(s);)s=-1,a++;else s=0,a=1;if(-1===s)return;let r=e.addElement("Fermata");r.addElement("Type").innerText=tA[i.type],r.addElement("Length").innerText=i.length.toString(),r.addElement("Offset").innerText=`${s}/${a}`}writeBarNode(e,t){let i=e.addElement("Bar");i.attributes.set("id",t.id.toString()),i.addElement("Voices").innerText=t.voices.map(e=>e.isEmpty?"-1":e.id.toString()).join(" "),i.addElement("Clef").innerText=eK[t.clef],t.clefOttava!==eQ.Regular&&(i.addElement("Ottavia").innerText=eQ[t.clefOttava].substr(1)),t.simileMark!==eZ.None&&(i.addElement("SimileMark").innerText=eZ[t.simileMark])}writeVoiceNode(e,t){if(t.isEmpty)return;let i=e.addElement("Voice");i.attributes.set("id",t.id.toString()),i.addElement("Beats").innerText=t.beats.map(e=>e.id).join(" ")}}dI.SampleRate=44100,dI.MidiProgramInfoLookup=new Map([[0,new dL(iu.Piano,"Acoustic Piano")],[1,new dL(iu.Piano,"Acoustic Piano")],[2,new dL(iu.Piano,"Electric Piano")],[3,new dL(iu.Piano,"Acoustic Piano")],[4,new dL(iu.Piano,"Electric Piano")],[5,new dL(iu.Piano,"Electric Piano")],[6,new dL(iu.Piano,"Harpsichord")],[7,new dL(iu.Piano,"Harpsichord")],[8,new dL(iu.PitchedIdiophone,"Celesta")],[9,new dL(iu.PitchedIdiophone,"Vibraphone")],[10,new dL(iu.PitchedIdiophone,"Vibraphone")],[11,new dL(iu.PitchedIdiophone,"Vibraphone")],[12,new dL(iu.PitchedIdiophone,"Xylophone")],[13,new dL(iu.PitchedIdiophone,"Xylophone")],[14,new dL(iu.PitchedIdiophone,"Vibraphone")],[15,new dL(iu.Banjo,"Banjo")],[16,new dL(iu.Piano,"Electric Organ")],[17,new dL(iu.Piano,"Electric Organ")],[18,new dL(iu.Piano,"Electric Organ")],[19,new dL(iu.Piano,"Electric Organ")],[20,new dL(iu.Piano,"Electric Organ")],[21,new dL(iu.Piano,"Electric Organ")],[22,new dL(iu.Woodwind,"Recorder")],[23,new dL(iu.Piano,"Electric Organ")],[24,new dL(iu.ClassicalGuitar,"Nylon Guitar")],[25,new dL(iu.SteelGuitar,"Steel Guitar")],[26,new dL(iu.SteelGuitar,"Electric Guitar")],[27,new dL(iu.ElectricGuitar,"Electric Guitar")],[28,new dL(iu.ElectricGuitar,"Electric Guitar")],[29,new dL(iu.ElectricGuitar,"Electric Guitar")],[30,new dL(iu.SteelGuitar,"Electric Guitar")],[31,new dL(iu.SteelGuitar,"Electric Guitar")],[32,new dL(iu.Bass,"Acoustic Bass")],[33,new dL(iu.Bass,"Electric Bass")],[34,new dL(iu.Bass,"Electric Bass")],[35,new dL(iu.Bass,"Acoustic Bass")],[36,new dL(iu.Bass,"Electric Bass")],[37,new dL(iu.Bass,"Electric Bass")],[38,new dL(iu.Synth,"Synth Bass")],[39,new dL(iu.Synth,"Synth Bass")],[40,new dL(iu.Strings,"Violin")],[41,new dL(iu.Strings,"Viola")],[42,new dL(iu.Strings,"Cello")],[43,new dL(iu.Strings,"Contrabass")],[44,new dL(iu.Strings,"Violin")],[45,new dL(iu.Strings,"Violin")],[46,new dL(iu.Piano,"Harp")],[47,new dL(iu.Membraphone,"Timpani")],[48,new dL(iu.Strings,"Violin")],[49,new dL(iu.Strings,"Violin")],[50,new dL(iu.Strings,"Violin")],[51,new dL(iu.Strings,"Violin")],[52,new dL(iu.Vocal,"Voice")],[53,new dL(iu.Vocal,"Voice")],[54,new dL(iu.Vocal,"Voice")],[55,new dL(iu.Synth,"Pad Synthesizer")],[56,new dL(iu.Brass,"Trumpet")],[57,new dL(iu.Brass,"Trombone")],[58,new dL(iu.Brass,"Tuba")],[59,new dL(iu.Brass,"Trumpet")],[60,new dL(iu.Brass,"French Horn")],[61,new dL(iu.Brass,"Trumpet")],[62,new dL(iu.Brass,"Trumpet")],[63,new dL(iu.Brass,"Trumpet")],[64,new dL(iu.Reed,"Saxophone")],[65,new dL(iu.Reed,"Saxophone")],[66,new dL(iu.Reed,"Saxophone")],[67,new dL(iu.Reed,"Saxophone")],[68,new dL(iu.Reed,"Oboe")],[69,new dL(iu.Reed,"English Horn")],[70,new dL(iu.Reed,"Bassoon")],[71,new dL(iu.Reed,"Clarinet")],[72,new dL(iu.Reed,"Piccolo")],[73,new dL(iu.Woodwind,"Flute")],[74,new dL(iu.Woodwind,"Recorder")],[75,new dL(iu.Woodwind,"Flute")],[76,new dL(iu.Woodwind,"Recorder")],[77,new dL(iu.Woodwind,"Flute")],[78,new dL(iu.Woodwind,"Recorder")],[79,new dL(iu.Woodwind,"Flute")],[80,new dL(iu.Synth,"Lead Synthesizer")],[81,new dL(iu.Synth,"Lead Synthesizer")],[82,new dL(iu.Synth,"Lead Synthesizer")],[83,new dL(iu.Synth,"Lead Synthesizer")],[84,new dL(iu.Synth,"Lead Synthesizer")],[85,new dL(iu.Synth,"Lead Synthesizer")],[86,new dL(iu.Synth,"Lead Synthesizer")],[87,new dL(iu.Synth,"Lead Synthesizer")],[88,new dL(iu.Synth,"Pad Synthesizer")],[89,new dL(iu.Synth,"Pad Synthesizer")],[90,new dL(iu.Synth,"Pad Synthesizer")],[91,new dL(iu.Synth,"Pad Synthesizer")],[92,new dL(iu.Synth,"Pad Synthesizer")],[93,new dL(iu.Synth,"Pad Synthesizer")],[94,new dL(iu.Synth,"Pad Synthesizer")],[95,new dL(iu.Synth,"Pad Synthesizer")],[96,new dL(iu.Fx,"Pad Synthesizer")],[97,new dL(iu.Fx,"Pad Synthesizer")],[98,new dL(iu.Fx,"Pad Synthesizer")],[99,new dL(iu.Fx,"Pad Synthesizer")],[100,new dL(iu.Fx,"Lead Synthesizer")],[101,new dL(iu.Fx,"Lead Synthesizer")],[102,new dL(iu.Fx,"Lead Synthesizer")],[103,new dL(iu.Fx,"Trumpet")],[104,new dL(iu.ElectricGuitar,"Banjo")],[105,new dL(iu.Banjo,"Banjo")],[106,new dL(iu.Ukulele,"Ukulele")],[107,new dL(iu.Banjo,"Banjo")],[108,new dL(iu.PitchedIdiophone,"Xylophone")],[109,new dL(iu.Reed,"Bassoon")],[110,new dL(iu.Strings,"Violin")],[111,new dL(iu.Woodwind,"Flute")],[112,new dL(iu.PitchedIdiophone,"Xylophone")],[113,new dL(iu.Idiophone,"Celesta")],[114,new dL(iu.PitchedIdiophone,"Vibraphone")],[115,new dL(iu.Idiophone,"Xylophone")],[116,new dL(iu.Membraphone,"Xylophone")],[117,new dL(iu.Membraphone,"Xylophone")],[118,new dL(iu.Membraphone,"Xylophone")],[119,new dL(iu.Idiophone,"Celesta")],[120,new dL(iu.Fx,"Steel Guitar")],[121,new dL(iu.Fx,"Recorder")],[122,new dL(iu.Fx,"Recorder")],[123,new dL(iu.Fx,"Recorder")],[124,new dL(iu.Fx,"Recorder")],[125,new dL(iu.Fx,"Recorder")],[126,new dL(iu.Fx,"Recorder")],[127,new dL(iu.Fx,"Timpani")]]),dI.DrumKitProgramInfo=new dL(iu.PercussionKit,"Drums","drumKit");class dA{static buildCrc32Lookup(){let e=new Uint32Array(256);for(let t=0;t<e.length;t++){let i=t;for(let e=0;e<8;e++)i=(1&i)==1?i>>>1^0xedb88320:i>>>1;e[t]=i}return e}get value(){return~this._checkValue}constructor(){this._checkValue=dA.CrcInit,this.reset()}update(e,t,i){for(let s=0;s<i;s++)this._checkValue=dA.Crc32Lookup[(this._checkValue^e[t+s])&255]^this._checkValue>>>8}reset(){this._checkValue=dA.CrcInit}}dA.Crc32Lookup=dA.buildCrc32Lookup(),dA.CrcInit=0xffffffff;class dR{}dR.MAX_WBITS=15,dR.WSIZE=1<<dR.MAX_WBITS,dR.WMASK=dR.WSIZE-1,dR.MIN_MATCH=3,dR.MAX_MATCH=258,dR.DEFAULT_MEM_LEVEL=8,dR.PENDING_BUF_SIZE=1<<dR.DEFAULT_MEM_LEVEL+8,dR.HASH_BITS=dR.DEFAULT_MEM_LEVEL+7,dR.HASH_SIZE=1<<dR.HASH_BITS,dR.HASH_SHIFT=(dR.HASH_BITS+dR.MIN_MATCH-1)/dR.MIN_MATCH,dR.HASH_MASK=dR.HASH_SIZE-1,dR.MIN_LOOKAHEAD=dR.MAX_MATCH+dR.MIN_MATCH+1,dR.MAX_DIST=dR.WSIZE-dR.MIN_LOOKAHEAD;class dO{constructor(e,t,i,s){this.length=null,this.numCodes=0,this.codes=null,this.huffman=e,this.minNumCodes=i,this.maxLength=s,this.freqs=new Int16Array(t),this.bitLengthCounts=new Int32Array(s)}reset(){for(let e=0;e<this.freqs.length;e++)this.freqs[e]=0;this.codes=null,this.length=null}buildTree(){let e=this.freqs.length,t=new Int32Array(e),i=0,s=0;for(let a=0;a<e;a++){let e=this.freqs[a];if(0!==e){let r=i++;for(;;)if(r>0){let i=Math.floor((r-1)/2);if(this.freqs[t[i]]>e)t[r]=t[i],r=i;else break}else break;t[r]=a,s=a}}for(;i<2;){let e=s<2?++s:0;t[i++]=e}this.numCodes=Math.max(s+1,this.minNumCodes);let a=i,r=new Int32Array(4*i-2),n=new Int32Array(2*i-1),o=a;for(let e=0;e<i;e++){let i=t[e];r[2*e]=i,r[2*e+1]=-1,n[e]=this.freqs[i]<<8,t[e]=e}do{let e=t[0],s=t[--i],a=0,l=1;for(;l<i;)l+1<i&&n[t[l]]>n[t[l+1]]&&l++,t[a]=t[l],a=l,l=2*l+1;let h=n[s];for(;;)if(l=a,a>0)if(n[t[a=Math.floor((l-1)/2)]]>h)t[l]=t[a];else break;else break;t[l]=s;let d=t[0];r[2*(s=o++)]=e,r[2*s+1]=d;let c=Math.min(255&n[e],255&n[d]);for(h=n[e]+n[d]-c+1,n[s]=h,a=0,l=1;l<i;)l+1<i&&n[t[l]]>n[t[l+1]]&&l++,t[a]=t[l],l=2*(a=l)+1;for(;;)if((l=a)>0)if(n[t[a=Math.floor((l-1)/2)]]>h)t[l]=t[a];else break;else break;t[l]=s}while(i>1)this.buildLength(r)}buildLength(e){this.length=new Uint8Array(this.freqs.length);let t=Math.floor(e.length/2),i=Math.floor((t+1)/2),s=0;for(let e=0;e<this.maxLength;e++)this.bitLengthCounts[e]=0;let a=new Int32Array(t);a[t-1]=0;for(let i=t-1;i>=0;i--)if(-1!==e[2*i+1]){let t=a[i]+1;t>this.maxLength&&(t=this.maxLength,s++),a[e[2*i]]=t,a[e[2*i+1]]=t}else{let t=a[i];this.bitLengthCounts[t-1]++,this.length[e[2*i]]=a[i]}if(0===s)return;let r=this.maxLength-1;do{for(;0===this.bitLengthCounts[--r];);do this.bitLengthCounts[r]--,this.bitLengthCounts[++r]++,s-=1<<this.maxLength-1-r;while(s>0&&r<this.maxLength-1)}while(s>0)this.bitLengthCounts[this.maxLength-1]+=s,this.bitLengthCounts[this.maxLength-2]-=s;let n=2*i;for(let t=this.maxLength;0!==t;t--){let i=this.bitLengthCounts[t-1];for(;i>0;){let s=2*e[n++];-1===e[s+1]&&(this.length[e[s]]=t,i--)}}}getEncodedLength(){let e=0;for(let t=0;t<this.freqs.length;t++)e+=this.freqs[t]*this.length[t];return e}calcBLFreq(e){let t,i,s,a=-1,r=0;for(;r<this.numCodes;){s=1;let n=this.length[r];for(0===n?(t=138,i=3):(t=6,i=3,a!==n&&(e.freqs[n]++,s=0)),a=n,r++;r<this.numCodes&&a===this.length[r]&&(r++,!(++s>=t)););s<i?e.freqs[a]+=s:0!==a?e.freqs[dO.Repeat3To6]++:s<=10?e.freqs[dO.Repeat3To10]++:e.freqs[dO.Repeat11To138]++}}setStaticCodes(e,t){this.codes=e,this.length=t}buildCodes(){let e=new Int32Array(this.maxLength),t=0;this.codes=new Int16Array(this.freqs.length);for(let i=0;i<this.maxLength;i++)e[i]=t,t+=this.bitLengthCounts[i]<<15-i;for(let t=0;t<this.numCodes;t++){let i=this.length[t];i>0&&(this.codes[t]=dH.bitReverse(e[i-1]),e[i-1]+=1<<16-i)}}writeTree(e){let t,i,s,a=-1,r=0;for(;r<this.numCodes;){s=1;let n=this.length[r];for(0===n?(t=138,i=3):(t=6,i=3,a!==n&&(e.writeSymbol(n),s=0)),a=n,r++;r<this.numCodes&&a===this.length[r]&&(r++,!(++s>=t)););if(s<i)for(;s-- >0;)e.writeSymbol(a);else 0!==a?(e.writeSymbol(dO.Repeat3To6),this.huffman.pending.writeBits(s-3,2)):s<=10?(e.writeSymbol(dO.Repeat3To10),this.huffman.pending.writeBits(s-3,3)):(e.writeSymbol(dO.Repeat11To138),this.huffman.pending.writeBits(s-11,7))}}writeSymbol(e){this.huffman.pending.writeBits(65535&this.codes[e],this.length[e])}}dO.Repeat3To6=16,dO.Repeat3To10=17,dO.Repeat11To138=18;class dH{static staticInit(){let e=0;for(;e<144;)dH.staticLCodes[e]=dH.bitReverse(48+e<<8),dH.staticLLength[e++]=8;for(;e<256;)dH.staticLCodes[e]=dH.bitReverse(256+e<<7),dH.staticLLength[e++]=9;for(;e<280;)dH.staticLCodes[e]=dH.bitReverse(-256+e<<9),dH.staticLLength[e++]=7;for(;e<dH.LITERAL_NUM;)dH.staticLCodes[e]=dH.bitReverse(-88+e<<8),dH.staticLLength[e++]=8;for(e=0;e<dH.DIST_NUM;e++)dH.staticDCodes[e]=dH.bitReverse(e<<11),dH.staticDLength[e]=5}static bitReverse(e){return dH.bit4Reverse[15&e]<<12|dH.bit4Reverse[e>>4&15]<<8|dH.bit4Reverse[e>>8&15]<<4|dH.bit4Reverse[e>>12]}constructor(e){this.last_lit=0,this.extra_bits=0,this.pending=e,this.literalTree=new dO(this,dH.LITERAL_NUM,257,15),this.distTree=new dO(this,dH.DIST_NUM,1,15),this.blTree=new dO(this,dH.BITLEN_NUM,4,7),this.d_buf=new Int16Array(dH.BUFSIZE),this.l_buf=new Uint8Array(dH.BUFSIZE)}isFull(){return this.last_lit>=dH.BUFSIZE}reset(){this.last_lit=0,this.extra_bits=0,this.literalTree.reset(),this.distTree.reset(),this.blTree.reset()}flushStoredBlock(e,t,i,s){this.pending.writeBits((dH.STORED_BLOCK<<1)+ +!!s,3),this.pending.alignToByte(),this.pending.writeShort(i),this.pending.writeShort(~i),this.pending.writeBlock(e,t,i),this.reset()}flushBlock(e,t,i,s){this.literalTree.freqs[dH.EOF_SYMBOL]++,this.literalTree.buildTree(),this.distTree.buildTree(),this.literalTree.calcBLFreq(this.blTree),this.distTree.calcBLFreq(this.blTree),this.blTree.buildTree();let a=4;for(let e=18;e>a;e--)this.blTree.length[dH.BL_ORDER[e]]>0&&(a=e+1);let r=14+3*a+this.blTree.getEncodedLength()+this.literalTree.getEncodedLength()+this.distTree.getEncodedLength()+this.extra_bits,n=this.extra_bits;for(let e=0;e<dH.LITERAL_NUM;e++)n+=this.literalTree.freqs[e]*dH.staticLLength[e];for(let e=0;e<dH.DIST_NUM;e++)n+=this.distTree.freqs[e]*dH.staticDLength[e];r>=n&&(r=n),t>=0&&i+4<r>>3?this.flushStoredBlock(e,t,i,s):(r===n?(this.pending.writeBits((dH.STATIC_TREES<<1)+ +!!s,3),this.literalTree.setStaticCodes(dH.staticLCodes,dH.staticLLength),this.distTree.setStaticCodes(dH.staticDCodes,dH.staticDLength)):(this.pending.writeBits((dH.DYN_TREES<<1)+ +!!s,3),this.sendAllTrees(a)),this.compressBlock(),this.reset())}sendAllTrees(e){this.blTree.buildCodes(),this.literalTree.buildCodes(),this.distTree.buildCodes(),this.pending.writeBits(this.literalTree.numCodes-257,5),this.pending.writeBits(this.distTree.numCodes-1,5),this.pending.writeBits(e-4,4);for(let t=0;t<e;t++)this.pending.writeBits(this.blTree.length[dH.BL_ORDER[t]],3);this.literalTree.writeTree(this.blTree),this.distTree.writeTree(this.blTree)}compressBlock(){for(let e=0;e<this.last_lit;e++){let t=255&this.l_buf[e],i=this.d_buf[e];if(0!=i--){let e=dH.Lcode(t);this.literalTree.writeSymbol(e);let s=Math.floor((e-261)/4);s>0&&s<=5&&this.pending.writeBits(t&(1<<s)-1,s);let a=dH.Dcode(i);this.distTree.writeSymbol(a),(s=Math.floor(a/2)-1)>0&&this.pending.writeBits(i&(1<<s)-1,s)}else this.literalTree.writeSymbol(t)}this.literalTree.writeSymbol(dH.EOF_SYMBOL)}tallyDist(e,t){this.d_buf[this.last_lit]=e,this.l_buf[this.last_lit++]=t-3;let i=dH.Lcode(t-3);this.literalTree.freqs[i]++,i>=265&&i<285&&(this.extra_bits+=Math.floor((i-261)/4));let s=dH.Dcode(e-1);return this.distTree.freqs[s]++,s>=4&&(this.extra_bits+=Math.floor(s/2)-1),this.isFull()}tallyLit(e){return this.d_buf[this.last_lit]=0,this.l_buf[this.last_lit++]=e,this.literalTree.freqs[e]++,this.isFull()}static Lcode(e){if(255===e)return 285;let t=257;for(;e>=8;)t+=4,e>>=1;return t+e}static Dcode(e){let t=0;for(;e>=4;)t+=2,e>>=1;return t+e}}dH.BUFSIZE=1<<dR.DEFAULT_MEM_LEVEL+6,dH.LITERAL_NUM=286,dH.STORED_BLOCK=0,dH.STATIC_TREES=1,dH.DYN_TREES=2,dH.DIST_NUM=30,dH.staticLCodes=new Int16Array(dH.LITERAL_NUM),dH.staticLLength=new Uint8Array(dH.LITERAL_NUM),dH.staticDCodes=new Int16Array(dH.DIST_NUM),dH.staticDLength=new Uint8Array(dH.DIST_NUM),dH.BL_ORDER=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],dH.bit4Reverse=new Uint8Array([0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15]),dH.BITLEN_NUM=19,dH.EOF_SYMBOL=256,dH.staticInit();class dV{constructor(e){this.maxChain=128,this.niceLength=128,this.goodLength=8,this.insertHashIndex=0,this.lookahead=0,this.inputBuf=null,this.inputOff=0,this.inputEnd=0,this.prevAvailable=!1,this.matchStart=0,this.matchLen=0,this.pending=e,this.huffman=new dH(e),this.inputCrc=new dA,this.window=new Uint8Array(2*dR.WSIZE),this.head=new Int16Array(dR.HASH_SIZE),this.prev=new Int16Array(dR.WSIZE),this.blockStart=1,this.strstart=1}reset(){this.huffman.reset(),this.inputCrc.reset(),this.blockStart=1,this.strstart=1,this.lookahead=0,this.prevAvailable=!1,this.matchLen=dR.MIN_MATCH-1;for(let e=0;e<dR.HASH_SIZE;e++)this.head[e]=0;for(let e=0;e<dR.WSIZE;e++)this.prev[e]=0}updateHash(){this.insertHashIndex=this.window[this.strstart]<<dR.HASH_SHIFT^this.window[this.strstart+1]}needsInput(){return this.inputEnd===this.inputOff}setInput(e,t,i){this.inputBuf=e,this.inputOff=t,this.inputEnd=t+i}deflate(e,t){let i;do{this.fillWindow();let s=e&&this.inputOff===this.inputEnd;i=this.deflateSlow(s,t)}while(this.pending.isFlushed&&i)return i}deflateSlow(e,t){if(this.lookahead<dR.MIN_LOOKAHEAD&&!e)return!1;for(;this.lookahead>=dR.MIN_LOOKAHEAD||e;){if(0===this.lookahead)return this.prevAvailable&&this.huffman.tallyLit(255&this.window[this.strstart-1]),this.prevAvailable=!1,this.huffman.flushBlock(this.window,this.blockStart,this.strstart-this.blockStart,t),this.blockStart=this.strstart,!1;this.strstart>=2*dR.WSIZE-dR.MIN_LOOKAHEAD&&this.slideWindow();let e=this.matchStart,i=this.matchLen;if(this.lookahead>=dR.MIN_MATCH){let e=this.insertString();0!==e&&this.strstart-e<=dR.MAX_DIST&&this.findLongestMatch(e)&&this.matchLen===dR.MIN_MATCH&&this.strstart-this.matchStart>dV.TooFar&&(this.matchLen=dR.MIN_MATCH-1)}if(i>=dR.MIN_MATCH&&this.matchLen<=i){this.huffman.tallyDist(this.strstart-1-e,i),i-=2;do this.strstart++,this.lookahead--,this.lookahead>=dR.MIN_MATCH&&this.insertString();while(--i>0)this.strstart++,this.lookahead--,this.prevAvailable=!1,this.matchLen=dR.MIN_MATCH-1}else this.prevAvailable&&this.huffman.tallyLit(255&this.window[this.strstart-1]),this.prevAvailable=!0,this.strstart++,this.lookahead--;if(this.huffman.isFull()){let e=this.strstart-this.blockStart;this.prevAvailable&&e--;let i=t&&0===this.lookahead&&!this.prevAvailable;return this.huffman.flushBlock(this.window,this.blockStart,e,i),this.blockStart+=e,!i}}return!0}findLongestMatch(e){let t,i=this.strstart,s=i+Math.min(dR.MAX_MATCH,this.lookahead)-1,a=Math.max(i-dR.MAX_DIST,0),r=this.window,n=this.prev,o=this.maxChain,l=Math.min(this.niceLength,this.lookahead);if(this.matchLen=Math.max(this.matchLen,dR.MIN_MATCH-1),i+this.matchLen>s)return!1;let h=r[i+this.matchLen-1],d=r[i+this.matchLen];this.matchLen>=this.goodLength&&(o>>=2);do{if(t=e,i=this.strstart,r[t+this.matchLen]!==d||r[t+this.matchLen-1]!==h||r[t]!==r[i]||r[++t]!==r[++i])continue;switch((s-i)%8){case 1:r[++i],r[++t];break;case 2:r[++i]===r[++t]&&(r[++i],r[++t]);break;case 3:r[++i]===r[++t]&&r[++i]===r[++t]&&(r[++i],r[++t]);break;case 4:r[++i]===r[++t]&&r[++i]===r[++t]&&r[++i]===r[++t]&&(r[++i],r[++t]);break;case 5:r[++i]===r[++t]&&r[++i]===r[++t]&&r[++i]===r[++t]&&r[++i]===r[++t]&&(r[++i],r[++t]);break;case 6:r[++i]===r[++t]&&r[++i]===r[++t]&&r[++i]===r[++t]&&r[++i]===r[++t]&&r[++i]===r[++t]&&(r[++i],r[++t]);break;case 7:r[++i]===r[++t]&&r[++i]===r[++t]&&r[++i]===r[++t]&&r[++i]===r[++t]&&r[++i]===r[++t]&&r[++i]===r[++t]&&(r[++i],r[++t])}if(r[i]===r[t])do if(i===s){++i,++t;break}while(r[++i]===r[++t]&&r[++i]===r[++t]&&r[++i]===r[++t]&&r[++i]===r[++t]&&r[++i]===r[++t]&&r[++i]===r[++t]&&r[++i]===r[++t]&&r[++i]===r[++t])if(i-this.strstart>this.matchLen){if(this.matchStart=e,this.matchLen=i-this.strstart,this.matchLen>=l)break;h=r[i-1],d=r[i]}e=65535&n[e&dR.WMASK]}while(e>a&&0!=--o)return this.matchLen>=dR.MIN_MATCH}insertString(){let e=(this.insertHashIndex<<dR.HASH_SHIFT^this.window[this.strstart+(dR.MIN_MATCH-1)])&dR.HASH_MASK,t=this.head[e];return this.prev[this.strstart&dR.WMASK]=t,this.head[e]=this.strstart,this.insertHashIndex=e,65535&t}fillWindow(){if(this.strstart>=dR.WSIZE+dR.MAX_DIST&&this.slideWindow(),this.lookahead<dR.MIN_LOOKAHEAD&&this.inputOff<this.inputEnd){let e=2*dR.WSIZE-this.lookahead-this.strstart;e>this.inputEnd-this.inputOff&&(e=this.inputEnd-this.inputOff),this.window.set(this.inputBuf.subarray(this.inputOff,this.inputOff+e),this.strstart+this.lookahead),this.inputCrc.update(this.inputBuf,this.inputOff,e),this.inputOff+=e,this.lookahead+=e}this.lookahead>=dR.MIN_MATCH&&this.updateHash()}slideWindow(){this.window.set(this.window.subarray(dR.WSIZE,dR.WSIZE+dR.WSIZE),0),this.matchStart-=dR.WSIZE,this.strstart-=dR.WSIZE,this.blockStart-=dR.WSIZE;for(let e=0;e<dR.HASH_SIZE;++e){let t=65535&this.head[e];this.head[e]=t>=dR.WSIZE?t-dR.WSIZE:0}for(let e=0;e<dR.WSIZE;e++){let t=65535&this.prev[e];this.prev[e]=t>=dR.WSIZE?t-dR.WSIZE:0}}}dV.TooFar=4096;class dW{get isFlushed(){return 0===this._end}constructor(e){this._start=0,this._end=0,this._bits=0,this.bitCount=0,this._buffer=new Uint8Array(e)}reset(){this._start=0,this._end=0,this.bitCount=0}writeShortMSB(e){this._buffer[this._end++]=e>>8&255,this._buffer[this._end++]=255&e}writeShort(e){this._buffer[this._end++]=e,this._buffer[this._end++]=e>>8}writeBlock(e,t,i){this._buffer.set(e.subarray(t,t+i),this._end),this._end+=i}flush(e,t,i){return this.bitCount>=8&&(this._buffer[this._end++]=255&this._bits,this._bits>>=8,this.bitCount-=8),i>this._end-this._start?(i=this._end-this._start,e.set(this._buffer.subarray(this._start,this._start+i),t),this._start=0,this._end=0):(e.set(this._buffer.subarray(this._start,this._start+i),t),this._start+=i),i}writeBits(e,t){this._bits|=e<<this.bitCount,this.bitCount+=t,this.bitCount>=16&&(this._buffer[this._end++]=255&this._bits,this._buffer[this._end++]=this._bits>>8&255,this._bits>>=16,this.bitCount-=16)}alignToByte(){this.bitCount>0&&(this._buffer[this._end++]=255&this._bits,this.bitCount>8&&(this._buffer[this._end++]=this._bits>>8&255)),this._bits=0,this.bitCount=0}}class dG{get inputCrc(){return this._engine.inputCrc.value}constructor(){this._state=0,this._pending=new dW(dR.PENDING_BUF_SIZE),this._engine=new dV(this._pending),this.reset()}get isNeedingInput(){return this._engine.needsInput()}get isFinished(){return this._state===dG.FinishedState&&this._pending.isFlushed}reset(){this._state=dG.BusyState,this._pending.reset(),this._engine.reset()}setInput(e,t,i){this._engine.setInput(e,t,i)}deflate(e,t,i){let s=i;for(;;){let a=this._pending.flush(e,t,i);if(t+=a,0==(i-=a)||this._state===dG.FinishedState)break;if(!this._engine.deflate((this._state&dG.IsFlushing)!=0,(this._state&dG.IsFinishing)!=0))switch(this._state){case dG.BusyState:return s-i;case dG.FlushingState:let r=8+(7&-this._pending.bitCount);for(;r>0;)this._pending.writeBits(2,10),r-=10;this._state=dG.BusyState;break;case dG.FinishingState:this._pending.alignToByte(),this._state=dG.FinishedState}}return s-i}finish(){this._state|=dG.IsFlushing|dG.IsFinishing}}dG.IsFlushing=4,dG.IsFinishing=8,dG.BusyState=16,dG.FlushingState=20,dG.FinishingState=28,dG.FinishedState=30;(eG=ip||(ip={}))[eG.SequenceNumber=0]="SequenceNumber",eG[eG.TextEvent=1]="TextEvent",eG[eG.CopyrightNotice=2]="CopyrightNotice",eG[eG.SequenceOrTrackName=3]="SequenceOrTrackName",eG[eG.InstrumentName=4]="InstrumentName",eG[eG.LyricText=5]="LyricText",eG[eG.MarkerText=6]="MarkerText",eG[eG.CuePoint=7]="CuePoint",eG[eG.PatchName=8]="PatchName",eG[eG.PortName=9]="PortName",eG[eG.MidiChannel=32]="MidiChannel",eG[eG.MidiPort=33]="MidiPort",eG[eG.EndOfTrack=47]="EndOfTrack",eG[eG.Tempo=81]="Tempo",eG[eG.SmpteOffset=84]="SmpteOffset",eG[eG.TimeSignature=88]="TimeSignature",eG[eG.KeySignature=89]="KeySignature",eG[eG.SequencerSpecific=127]="SequencerSpecific";(ez=im||(im={}))[ez.SystemExclusive=240]="SystemExclusive",ez[ez.MtcQuarterFrame=241]="MtcQuarterFrame",ez[ez.SongPosition=242]="SongPosition",ez[ez.SongSelect=243]="SongSelect",ez[ez.TuneRequest=246]="TuneRequest",ez[ez.SystemExclusive2=247]="SystemExclusive2";(eU=ig||(ig={}))[eU.MetronomeTick=0]="MetronomeTick",eU[eU.Rest=1]="Rest",e.s(["AlphaTabApi",()=>os,"AlphaTabError",()=>i6,"AlphaTabErrorType",()=>tE,"Environment",()=>dE,"Logger",()=>iM,"WebPlatform",()=>t9],25191);let dz={get url(){return`file://${e.P("node_modules/@coderline/alphatab/dist/alphaTab.mjs")}`}};dE.isRunningInWorker?dE.initializeWorker():dE.isRunningInAudioWorklet?dE.initializeAudioWorklet():dE.initializeMain(e=>{if(dE.webPlatform===t9.NodeJs)throw new i6(tE.General,"Workers not yet supported in Node.js");if(dE.webPlatform===t9.BrowserModule||dE.isWebPackBundled||dE.isViteBundled){iM.debug("AlphaTab","Creating webworker");try{return new dE.alphaTabWorker(new dE.alphaTabUrl("./alphaTab.worker.mjs",dz.url),{type:"module"})}catch(e){iM.debug("AlphaTab","ESM webworker construction with direct URL failed",e)}let t="";try{t=new dE.alphaTabUrl("./alphaTab.worker.mjs",dz.url);let e=`import ${JSON.stringify(t)}`,i=new Blob([e],{type:"application/javascript"});return new Worker(URL.createObjectURL(i),{type:"module"})}catch(e){iM.debug("AlphaTab","ESM webworker construction with blob import failed",t,e)}try{if(!e.core.scriptFile)throw Error("Could not detect alphaTab script file");t=e.core.scriptFile;let i=`import ${JSON.stringify(e.core.scriptFile)}`,s=new Blob([i],{type:"application/javascript"});return new Worker(URL.createObjectURL(s),{type:"module"})}catch(t){iM.debug("AlphaTab","ESM webworker construction with blob import failed",e.core.scriptFile,t)}}if(!e.core.scriptFile)throw new i6(tE.General,"Could not detect alphaTab script file, cannot initialize renderer");try{iM.debug("AlphaTab","Creating Blob worker");let t=`importScripts('${e.core.scriptFile}')`,i=new Blob([t],{type:"application/javascript"});return new Worker(URL.createObjectURL(i))}catch(t){return iM.warning("Rendering","Could not create inline worker, fallback to normal worker"),new Worker(e.core.scriptFile)}},(e,t)=>{if(dE.webPlatform===t9.NodeJs)throw new i6(tE.General,"Audio Worklets not yet supported in Node.js");return dE.webPlatform===t9.BrowserModule||dE.isWebPackBundled||dE.isViteBundled?(iM.debug("AlphaTab","Creating Module worklet"),e.audioWorklet.addModule(new dE.alphaTabUrl("./alphaTab.worklet.mjs",dz.url))):(iM.debug("AlphaTab","Creating Script worklet"),e.audioWorklet.addModule(t.core.scriptFile))}),e.s([],79626)}]);