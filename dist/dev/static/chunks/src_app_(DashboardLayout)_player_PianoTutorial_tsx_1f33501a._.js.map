{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///www/wwwroot/pianosync.com/src/app/%28DashboardLayout%29/player/PianoTutorial.tsx"],"sourcesContent":["import React, { useState, useEffect, useRef, useCallback } from 'react';\nimport { AlphaTabApi, Model } from '@coderline/alphatab';\nimport { Keyboard, MidiNumbers } from 'react-piano';\nimport 'react-piano/dist/styles.css';\n\ninterface Note {\n  midi: number;\n  startTick: number;\n  duration: number;\n}\n\ninterface FallingNoteProps {\n  note: Note;\n  currentTick: number;\n  ticksPerPixel: number;\n  pianoPosition: { top: number, left: number };\n  keyWidth: number;\n  isNextNote: boolean;\n}\n\nconst NOTE_SPEED_FACTOR = 0.2; // Điều chỉnh tốc độ rơi và chiều cao của nốt nhạc\n\nconst FallingNote: React.FC<FallingNoteProps> = ({ note, currentTick, pianoPosition, keyWidth, isNextNote }) => {\n  const noteHeight = note.duration * NOTE_SPEED_FACTOR;\n  const distanceInTicks = note.startTick - currentTick;\n  const top = pianoPosition.top - noteHeight - (distanceInTicks * NOTE_SPEED_FACTOR);\n\n  // Ánh xạ MIDI tới vị trí phím đàn (chính xác hơn)\n  const getNotePosition = (midi: number) => {\n    const noteIsAccidental = (note: number) => {\n      const pitch = note % 12;\n      return pitch === 1 || pitch === 3 || pitch === 6 || pitch === 8 || pitch === 10;\n    };\n\n    const getWhiteKeyNumber = (midi: number) => {\n        const C0 = MidiNumbers.fromNote('c0');\n        let whiteKeyNumber = 0;\n        for (let i = C0; i < midi; i++) {\n            if (!noteIsAccidental(i)) {\n                whiteKeyNumber++;\n            }\n        }\n        return whiteKeyNumber;\n    };\n\n    const isBlackKey = noteIsAccidental(midi);\n    const whiteKeyIndex = getWhiteKeyNumber(midi);\n\n    // Tính toán vị trí phím trắng\n    const keyPosition = whiteKeyIndex * keyWidth;\n    return { left: keyPosition, isBlack: isBlackKey };\n  };\n\n  const { left, isBlack } = getNotePosition(note.midi);\n\n  if (top > pianoPosition.top + 20 || top < -noteHeight) {\n    return null; // Không render nốt quá xa màn hình\n  }\n\n  const style: React.CSSProperties = {\n    position: 'absolute',\n    top: `${top}px`,\n    left: `${pianoPosition.left + left}px`,\n    width: `${isBlack ? keyWidth * 0.65 : keyWidth}px`,\n    height: `${noteHeight}px`,\n    backgroundColor: isNextNote ? 'yellow' : (isBlack ? 'black' : 'cyan'),\n    border: '1px solid grey',\n    borderRadius: '4px',\n    zIndex: isBlack ? 3 : 2,\n  };\n\n  return <div style={style} />;\n};\n\ninterface PianoTutorialProps {\n  file: string;\n  onMidiMessage: (callback: (data: Uint8Array) => void) => void;\n}\n\nexport const PianoTutorial: React.FC<PianoTutorialProps> = ({ file, onMidiMessage }) => {\n  const alphaTabRef = useRef<AlphaTabApi | null>(null);\n  const rendererRef = useRef<HTMLDivElement>(null);\n  const [notes, setNotes] = useState<Note[]>([]);\n  const [currentTick, setCurrentTick] = useState(0);\n  const [currentNoteIndex, setCurrentNoteIndex] = useState(0);\n  const [playbackState, setPlaybackState] = useState<'stopped' | 'playing' | 'waiting'>('stopped');\n  const [activeMidiNotes, setActiveMidiNotes] = useState<number[]>([]);\n\n  const pianoWidth = 1000;\n  const keyWidth = pianoWidth / 52; // 52 phím trắng trên đàn 88 phím\n  console.log(file);  \n  // Initialize AlphaTab\n  useEffect(() => {\n    if (rendererRef.current) {\n      const api = new AlphaTabApi(rendererRef.current, {\n        core: {\n          // Cần thiết khi dùng Turbopack/Webpack để AlphaTab tìm đúng tài nguyên\n          tex: true,\n          fontDirectory: '/alphatab/font/'\n        },\n        player: {\n          enablePlayer: true,\n          soundFont: '/alphatab/soundfont/sonivox.sf2',\n          scrollElement: rendererRef.current.parentElement,\n          enableCursor: false, // Tắt con trỏ mặc định\n        },\n      });\n      alphaTabRef.current = api;\n      // Lấy nốt nhạc từ score sau khi load xong\n      api.scoreLoaded.on((score: Model.Score) => {\n        \n        const extractedNotes: Note[] = [];\n        console.log(score)\n        score.tracks.forEach(track => {\n          // // Chỉ lấy nốt từ các track dành cho piano\n          // if (track.isPercussion || !track.staves.some(s => s.isPiano)) {\n          //   console.log('Skipping non-piano track');\n          //   return;\n          // }\n\n          track.staves.forEach(stave => {\n            stave.bars.forEach(bar => {\n              bar.voices.forEach(voice => {\n                voice.beats.forEach(beat => {\n                  beat.notes.forEach(note => {\n                    if (note.isRest) return;\n                    extractedNotes.push({\n                      midi: note.realValue,\n                      startTick: beat.start,\n                      duration: note.duration * (score.division / 4), // Quy đổi duration của nốt ra tick\n                    });\n                  });\n                });\n              });\n            });\n          });\n        });\n        extractedNotes.sort((a, b) => a.startTick - b.startTick);\n        setNotes(extractedNotes);\n        console.log(extractedNotes)\n      });\n\n      // Đồng bộ tick với animation\n      if (api.player) {\n        api.player.tickPositionChanged.on(({ tick }) => {\n          setCurrentTick(tick);\n        });\n      }\n\n      api.load(file);\n\n      return () => {\n        api.destroy();\n      };\n    }\n  }, [file]);\n\n  // Logic \"chờ nốt đúng\"\n  useEffect(() => {\n    if (playbackState === 'playing' && notes.length > currentNoteIndex) {\n      const nextNote = notes[currentNoteIndex];\n      if (currentTick >= nextNote.startTick) {\n        alphaTabRef.current?.player.pause();\n        setPlaybackState('waiting');\n      }\n    }\n  }, [currentTick, playbackState, notes, currentNoteIndex]);\n\n  // MIDI Message Handler\n  const handleMidi = useCallback((data: Uint8Array) => {\n    const command = data[0] >> 4;\n    const note = data[1];\n    const velocity = data.length > 2 ? data[2] : 0;\n\n    if (command === 9 && velocity > 0) { // Note On\n      setActiveMidiNotes(prev => [...prev, note]);\n      if (playbackState === 'waiting' && notes.length > currentNoteIndex) {\n        const expectedNote = notes[currentNoteIndex];\n        if (note === expectedNote.midi) {\n          setCurrentNoteIndex(prev => prev + 1);\n          alphaTabRef.current?.player.play();\n          setPlaybackState('playing'); // Tiếp tục chơi\n        }\n      }\n    } else if (command === 8 || (command === 9 && velocity === 0)) { // Note Off\n      setActiveMidiNotes(prev => prev.filter(n => n !== note));\n    }\n  }, [playbackState, notes, currentNoteIndex]);\n\n  useEffect(() => {\n    onMidiMessage(handleMidi);\n  }, [handleMidi, onMidiMessage]);\n\n  const handlePlay = () => {\n    if (alphaTabRef.current) {\n      alphaTabRef.current.player.play();\n      setPlaybackState('playing');\n    }\n  };\n\n  const pianoPosition = { top: 500, left: 0 };\n  \n  // Xác định các nốt nhạc cần chuẩn bị bấm\n  const PREPARE_WINDOW = 960 * 2; // Chuẩn bị trước 2 nhịp\n  const upcomingNotes = notes.filter(note => \n    note.startTick > currentTick && \n    note.startTick <= currentTick + PREPARE_WINDOW\n  );\n  const upcomingMidiNotes = Array.from(new Set(upcomingNotes.map(note => note.midi)));\n  const nextNoteToPlay = notes[currentNoteIndex];\n\n  return (\n    <div>\n      <div ref={rendererRef} style={{ height: '100px', width: `${pianoWidth}px`, overflow: 'hidden', visibility: 'hidden' }}></div>\n      <button onClick={handlePlay} disabled={playbackState !== 'stopped'}>Bắt đầu</button>\n      <p>Trạng thái: {playbackState}</p>\n      {nextNoteToPlay && <p>Nốt tiếp theo: {nextNoteToPlay.midi}</p>}\n\n      {/* Khu vực nốt rơi */}\n      <div style={{ position: 'relative', height: `${pianoPosition.top}px`, width: `${pianoWidth}px`, overflow: 'hidden', backgroundColor: '#f0f0f0', border: '1px solid #ccc' }}>\n        {notes.map((note, index) => (\n          <FallingNote\n            key={`${note.startTick}-${note.midi}-${index}`}\n            note={note}\n            currentTick={currentTick}\n            pianoPosition={pianoPosition}\n            keyWidth={keyWidth}\n            isNextNote={index === currentNoteIndex}\n          />\n        ))}\n      </div>\n\n      {/* Đàn piano ảo */}\n      <div style={{ position: 'relative', left: pianoPosition.left, zIndex: 1 }}>\n        <Keyboard\n          noteRange={{ first: MidiNumbers.fromNote('a0'), last: MidiNumbers.fromNote('c8') }}\n          onPlayNoteInput={() => {}}\n          onStopNoteInput={() => {}}\n          width={pianoWidth}\n          activeNotes={activeMidiNotes}\n          keyWidthToHeightRatio={0.2}\n          // Đánh dấu phím tiếp theo cần bấm\n          renderNoteLabel={({ midiNumber, isAccidental, isActive }) => {\n            const isNextNote = nextNoteToPlay && midiNumber === nextNoteToPlay.midi;\n            const isUpcomingNote = upcomingMidiNotes.includes(midiNumber);\n\n            if (isNextNote) {\n              // Nốt chính xác tiếp theo, màu vàng đậm\n              return (\n                <div style={{\n                  position: 'absolute',\n                  top: 0,\n                  left: 0,\n                  width: '100%',\n                  height: '100%',\n                  backgroundColor: 'rgba(0, 255, 234, 0.5)',\n                  zIndex: 4\n                }} />\n              );\n            }\n            if (isUpcomingNote) {\n              // Các nốt sắp tới, màu xanh nhạt\n              return (\n                <div style={{\n                  position: 'absolute',\n                  top: 0,\n                  left: 0,\n                  width: '100%',\n                  height: '100%',\n                  backgroundColor: 'rgba(173, 216, 230, 0.5)', // Light blue\n                  zIndex: 3\n                }} />\n              );\n            }\n            return null;\n          }}\n        />\n      </div>\n    </div>\n  );\n};\n\nexport default PianoTutorial;"],"names":[],"mappings":"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","debugId":null}}]
}