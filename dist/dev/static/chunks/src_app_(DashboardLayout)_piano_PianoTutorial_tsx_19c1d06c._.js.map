{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///www/wwwroot/pianosync.com/src/app/%28DashboardLayout%29/piano/PianoTutorial.tsx"],"sourcesContent":["import React, { useState, useEffect, useRef, useCallback } from 'react';\nimport { AlphaTabApi, PlayerState } from '@coderline/alphatab';\nimport { Keyboard, MidiNumbers } from 'react-piano';\nimport 'react-piano/dist/styles.css';\n\ninterface Note {\n  midi: number;\n  startTick: number;\n  duration: number;\n}\n\ninterface FallingNoteProps {\n  note: Note;\n  currentTick: number;\n  ticksPerPixel: number;\n  pianoPosition: { top: number, left: number };\n  keyWidth: number;\n  isNextNote: boolean;\n}\n\nconst FallingNote: React.FC<FallingNoteProps> = ({ note, currentTick, ticksPerPixel, pianoPosition, keyWidth, isNextNote }) => {\n  const noteHeight = note.duration / ticksPerPixel;\n  const distance = (note.startTick - currentTick) / ticksPerScreen;\n  const top = pianoPosition.top - noteHeight - distance;\n\n  // Simple mapping of MIDI to key position (this is a simplification)\n  const getNotePosition = (midi: number) => {\n    const octave = Math.floor(midi / 12) - 1;\n    const noteInOctave = midi % 12;\n    const whiteKeyMap = [0, 0.5, 1, 1.5, 2, 3, 3.5, 4, 4.5, 5, 5.5, 6];\n    const isBlack = [1, 3, 6, 8, 10].includes(noteInOctave);\n    \n    let keyIndex = octave * 7 + whiteKeyMap[noteInOctave];\n    // This is a rough approximation and needs a proper mapping function\n    // based on the exact layout of react-piano keys.\n    // For now, let's use a simpler multiplier.\n    const keyPosition = (midi - 21) * (keyWidth * 0.7); // A0 is 21\n    return { left: keyPosition, isBlack };\n  };\n\n  const { left, isBlack } = getNotePosition(note.midi);\n\n  if (top > pianoPosition.top || top < -noteHeight) {\n    return null; // Don't render notes far off-screen\n  }\n\n  const style: React.CSSProperties = {\n    position: 'absolute',\n    top: `${top}px`,\n    left: `${pianoPosition.left + left}px`,\n    width: `${isBlack ? keyWidth * 0.6 : keyWidth}px`,\n    height: `${noteHeight}px`,\n    backgroundColor: isNextNote ? 'yellow' : (isBlack ? 'black' : 'cyan'),\n    border: '1px solid grey',\n    borderRadius: '4px',\n    zIndex: isBlack ? 2 : 1,\n  };\n\n  return <div style={style} />;\n};\n\nconst ticksPerScreen = 4 * 960; // Show 4 quarter notes on screen\n\ninterface PianoTutorialProps {\n  file: string;\n  onMidiMessage: (callback: (data: Uint8Array) => void) => void;\n}\n\nexport const PianoTutorial: React.FC<PianoTutorialProps> = ({ file, onMidiMessage }) => {\n  const alphaTabRef = useRef<AlphaTabApi | null>(null);\n  const rendererRef = useRef<HTMLDivElement>(null);\n  const [notes, setNotes] = useState<Note[]>([]);\n  const [currentTick, setCurrentTick] = useState(0);\n  const [currentNoteIndex, setCurrentNoteIndex] = useState(0);\n  const [playbackState, setPlaybackState] = useState<'stopped' | 'playing' | 'waiting'>('stopped');\n  const [activeMidiNotes, setActiveMidiNotes] = useState<number[]>([]);\n\n  const pianoWidth = 1000;\n  const keyWidth = pianoWidth / 52; // Approx 52 white keys on 88-key piano\n\n  // Initialize AlphaTab\n  useEffect(() => {\n    if (rendererRef.current) {\n      const api = new AlphaTabApi(rendererRef.current, {\n        player: {\n          enablePlayer: true,\n          soundFont: 'https://cdn.jsdelivr.net/npm/@coderline/alphatab@latest/dist/soundfont/sonivox.sf2',\n          scrollElement: rendererRef.current.parentElement,\n        },\n      });\n      alphaTabRef.current = api;\n\n      api.midiLoaded.on(midi => {\n        const extractedNotes: Note[] = [];\n        midi.tracks.forEach(track => {\n          track.events.forEach(event => {\n            if (event.type === 144) { // NoteOn\n              const noteOffEvent = track.events.find(e => e.type === 128 && e.noteKey === event.noteKey && e.tick > event.tick);\n              if (noteOffEvent) {\n                extractedNotes.push({\n                  midi: event.noteKey,\n                  startTick: event.tick,\n                  duration: noteOffEvent.tick - event.tick,\n                });\n              }\n            }\n          });\n        });\n        extractedNotes.sort((a, b) => a.startTick - b.startTick);\n        setNotes(extractedNotes);\n      });\n\n      api.load(file);\n\n      return () => {\n        api.destroy();\n      };\n    }\n  }, [file]);\n\n  // Animation Loop\n  useEffect(() => {\n    let animationFrameId: number;\n    const animate = () => {\n      if (playbackState === 'playing') {\n        if (alphaTabRef.current?.player) {\n          alphaTabRef.current.player.tickPosition += 1;\n          setCurrentTick(alphaTabRef.current.player.tickPosition);\n        }\n\n        if (notes.length > currentNoteIndex) {\n          const nextNote = notes[currentNoteIndex];\n          if ((alphaTabRef.current?.player.tickPosition ?? 0) >= nextNote.startTick) {\n            setPlaybackState('waiting');\n          }\n        }\n      }\n      animationFrameId = requestAnimationFrame(animate);\n    };\n\n    if (playbackState === 'playing') {\n      animationFrameId = requestAnimationFrame(animate);\n    }\n\n    return () => {\n      cancelAnimationFrame(animationFrameId);\n    };\n  }, [playbackState, notes, currentNoteIndex]);\n\n  // MIDI Message Handler\n  const handleMidi = useCallback((data: Uint8Array) => {\n    const command = data[0] >> 4;\n    const note = data[1];\n    const velocity = data.length > 2 ? data[2] : 0;\n\n    if (command === 9 && velocity > 0) { // Note On\n      setActiveMidiNotes(prev => [...prev, note]);\n      if (playbackState === 'waiting' && notes.length > currentNoteIndex) {\n        const expectedNote = notes[currentNoteIndex];\n        if (note === expectedNote.midi) {\n          setCurrentNoteIndex(prev => prev + 1);\n          setPlaybackState('playing');\n        }\n      }\n    } else if (command === 8 || (command === 9 && velocity === 0)) { // Note Off\n      setActiveMidiNotes(prev => prev.filter(n => n !== note));\n    }\n  }, [playbackState, notes, currentNoteIndex]);\n\n  useEffect(() => {\n    onMidiMessage(handleMidi);\n  }, [handleMidi, onMidiMessage]);\n\n  const handlePlay = () => {\n    if (alphaTabRef.current) {\n      alphaTabRef.current.player?.play();\n      alphaTabRef.current.player?.pause();\n      setPlaybackState('playing');\n    }\n  };\n\n  const pianoPosition = { top: 500, left: 0 };\n  const nextNoteToPlay = notes.length > currentNoteIndex ? notes[currentNoteIndex] : null;\n\n  return (\n    <div>\n      <div ref={rendererRef} style={{ height: '1px', overflow: 'hidden' }}></div>\n      <button onClick={handlePlay} disabled={playbackState !== 'stopped'}>Bắt đầu</button>\n      <p>Trạng thái: {playbackState}</p>\n      {nextNoteToPlay && <p>Nốt tiếp theo: {nextNoteToPlay.midi}</p>}\n\n      {/* Note Fall Area */}\n      <div style={{ position: 'relative', height: `${pianoPosition.top}px`, width: `${pianoWidth}px`, overflow: 'hidden', backgroundColor: '#f0f0f0', border: '1px solid #ccc' }}>\n        {notes.map((note, index) => (\n          <FallingNote\n            key={`${note.startTick}-${note.midi}`}\n            note={note}\n            currentTick={currentTick}\n            ticksPerPixel={ticksPerScreen / pianoPosition.top}\n            pianoPosition={pianoPosition}\n            keyWidth={keyWidth}\n            isNextNote={index === currentNoteIndex}\n          />\n        ))}\n      </div>\n\n      {/* React Piano */}\n      <div style={{ position: 'relative', top: pianoPosition.top, left: pianoPosition.left }}>\n        <Keyboard\n          noteRange={{ first: MidiNumbers.fromNote('a0'), last: MidiNumbers.fromNote('c8') }}\n          playNote={() => {}}\n          stopNote={() => {}}\n          width={pianoWidth}\n          activeNotes={activeMidiNotes}\n          keyWidthToHeightRatio={0.2}\n          renderNoteLabel={({ midiNumber, isAccidental, isActive }) => {\n            if (nextNoteToPlay && midiNumber === nextNoteToPlay.midi) {\n              return (\n                <div style={{\n                  position: 'absolute',\n                  top: 0,\n                  left: 0,\n                  width: '100%',\n                  height: '100%',\n                  backgroundColor: 'rgba(255, 255, 0, 0.5)',\n                  zIndex: 3\n                }} />\n              );\n            }\n            return null;\n          }}\n        />\n      </div>\n    </div>\n  );\n};\n\nexport default PianoTutorial;"],"names":[],"mappings":"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","debugId":null}}]
}